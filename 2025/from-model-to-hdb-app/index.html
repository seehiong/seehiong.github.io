<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
    




    







<script defer language="javascript" type="text/javascript" src="/js/bundle.min.b989f0fdae3971a3effd81d6d0b27b3cb1023ff0b601ff43e2118b0d9d82ddb9.js"></script>





  
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-5PNPM4HWQ0"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-5PNPM4HWQ0');
        }
      </script>

    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    <link rel="icon" href=/favicon.png>

    
    





  





  
  
  


<!-- Open Graph image and Twitter Card metadata -->

<title itemprop="name">Tech Blog - From Model to HDB App</title>
<meta property="og:title" content=Tech&#32;Blog&#32;-&#32;From&#32;Model&#32;to&#32;HDB&#32;App />
<meta name="twitter:title" content=Tech&#32;Blog&#32;-&#32;From&#32;Model&#32;to&#32;HDB&#32;App />
<meta itemprop="name" content=Tech&#32;Blog&#32;-&#32;From&#32;Model&#32;to&#32;HDB&#32;App />
<meta name="application-name" content=Tech&#32;Blog&#32;-&#32;From&#32;Model&#32;to&#32;HDB&#32;App />
<meta property="og:site_name" content="See Hiong&#39;s Blog" />


<meta name="description" content="" />
<meta itemprop="description" content="" />
<meta property="og:description" content="" />
<meta name="twitter:description" content="" />


<base href="https://seehiong.github.io/2025/from-model-to-hdb-app/" />
<link rel="canonical" href="https://seehiong.github.io/2025/from-model-to-hdb-app/" itemprop="url" />
<meta name="url" content="https://seehiong.github.io/2025/from-model-to-hdb-app/" />
<meta name="twitter:url" content="https://seehiong.github.io/2025/from-model-to-hdb-app/" />
<meta property="og:url" content="https://seehiong.github.io/2025/from-model-to-hdb-app/" />


<meta property="og:updated_time" content="2025-04-21T20:00:00&#43;08:00" />


<link rel="sitemap" type="application/xml" title="Sitemap" href='https://seehiong.github.io/sitemap.xml' />

<meta name="robots" content="index,follow" />
<meta name="googlebot" content="index,follow" />



<meta property="fb:admins" content="" />


<meta name="apple-mobile-web-app-title" content="See Hiong&#39;s Blog" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />






<meta name="generator" content="Hugo 0.134.1">


    
    

<link type="text/css" rel="stylesheet" href="/css/bundle.min.95cc0677a25232434df79a1cf0ee059633a97da88b4235a87f2a69bea2c1e24d.css">


    
    <style>
    body {
        --sidebar-bg-color: #202020;
        --sidebar-img-border-color: #515151;
        --sidebar-p-color: #909090;
        --sidebar-h1-color: #FFF;
        --sidebar-a-color: #FFF;
        --sidebar-socials-color: #FFF;
        --text-color: #222;
        --bkg-color: #FAF9F6;
        --post-title-color: #303030;
        --list-color: #5a5a5a;
        --link-color: #268bd2;
        --date-color: #515151;
        --table-border-color: #E5E5E5;
        --table-stripe-color: #F9F9F9;
        --code-color: #000;
        --code-background-color: #E5E5E5;
        --code-block-color: #fff;
        --code-block-background-color: #272822;
        --moon-sun-color: #FFF;
        --moon-sun-background-color: #515151;
    }
    body.dark-theme {
        --text-color: #eee;
        --bkg-color: #121212;
        --post-title-color: #DBE2E9;
        --list-color: #9d9d9d;
        --link-color: #268bd2;
        --date-color: #9a9a9a;
        --table-border-color: #515151;
        --table-stripe-color: #202020;
        --code-color: #fff;
        --code-background-color: #515151;
        --code-block-color: #fff;
        --code-block-background-color: #272822;
    }
    body {
        background-color: var(--bkg-color);
    }
</style>

</head>

    <body class="dark-theme">
        <div class="wrapper">
            <aside class="sidebar">
    <div class="container sidebar-sticky">
        <div class="light-dark" align="right">
    <button class="btn-light-dark" title="Toggle light/dark mode">
        <svg class="moon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M6 .278a.768.768 0 0 1 .08.858a7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277c.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316a.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71C0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
        </svg>
        <svg class="sun" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M8 12a4 4 0 1 0 0-8a4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
        </svg>
    </button>
</div>

        <div class="sidebar-about">
    <h1 class="brand">
        
        
            <a href="https://seehiong.github.io/">
                <h1>Tech Blog</h1>
            </a>
        
    </h1>
    <p class="lead">
    Chronicling my personal expedition of technology exploration and experimentation, facilitated by a home-based self-configured laboratory
    </p>
</div>

        <link href="/pagefind/pagefind-ui.css" rel="stylesheet">
<style>
    :root {
        --pagefind-ui-primary: #eeeeee;
        --pagefind-ui-text: #eeeeee;
        --pagefind-ui-background: #152028;
        --pagefind-ui-border: #152028;
        --pagefind-ui-tag: #152028;
    }
</style>
<script src="/pagefind/pagefind-ui.js"></script>
<div style="max-width: 100%; margin: clamp(2px, 1vw, 10px) auto;">
    <div id="search"></div>
    <script>
        window.addEventListener('DOMContentLoaded', (event) => {
            new PagefindUI({ element: "#search", showSubResults: true, showImages: false });
        });
    </script>
</div>
        <nav>
    <ul class="sidebar-nav">

        
        
        
        
            

            
                
                
                    <li class="heading">
                        <a href="/2025/">2025</a>
                    </li>
                    
                        <li class="sub-heading">
                            Recent
                        </li>
                        
                            <li class="bullet">
                                <a href="https://seehiong.github.io/2025/deploy-kserve-on-oke/">Deploying KServe on OKE</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://seehiong.github.io/2025/building-a-recommender-system/">Building a Recommender System</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://seehiong.github.io/2025/from-model-to-hdb-app/">From Model to HDB App</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://seehiong.github.io/2025/feature-impact-on-hdb-predictions/">Feature Impact on HDB predictions</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://seehiong.github.io/2025/mnist-digit-classifier-in-tensorflow/">MNIST Digit Classifier in TensorFlow</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://seehiong.github.io/2025/chat-driven-insights-with-chartjs/">Chat-Driven Insights with Chart.js</a>
                            </li>
                        
                    
                
            
                
                
            
                
                
            
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        
        
            

            
                
                
            
                
                
            
                
                
                    <li class="heading">
                        <a href="/archives/">Archives</a>
                    </li>
                    
                
            
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        
        
            

            
                
                
            
                
                
                    <li class="heading">
                        <a href="/about/">About</a>
                    </li>
                    
                
            
                
                
            
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        

    </ul>
</nav>

        
    <a target="_blank" class="social" title="GitHub" href="https://github.com/seehiong">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="-2 -2 24 24">
            <path fill="currentColor" d="M18.88 1.099C18.147.366 17.265 0 16.233 0H3.746C2.714 0 1.832.366 1.099 1.099C.366 1.832 0 2.714 0 3.746v12.487c0 1.032.366 1.914 1.099 2.647c.733.733 1.615 1.099 2.647 1.099H6.66c.19 0 .333-.007.429-.02a.504.504 0 0 0 .286-.169c.095-.1.143-.245.143-.435l-.007-.885c-.004-.564-.006-1.01-.006-1.34l-.3.052c-.19.035-.43.05-.721.046a5.555 5.555 0 0 1-.904-.091a2.026 2.026 0 0 1-.872-.39a1.651 1.651 0 0 1-.572-.8l-.13-.3a3.25 3.25 0 0 0-.41-.663c-.186-.243-.375-.407-.566-.494l-.09-.065a.956.956 0 0 1-.17-.156a.723.723 0 0 1-.117-.182c-.026-.061-.004-.111.065-.15c.07-.04.195-.059.378-.059l.26.04c.173.034.388.138.643.311a2.1 2.1 0 0 1 .631.677c.2.355.44.626.722.813c.282.186.566.28.852.28c.286 0 .533-.022.742-.065a2.59 2.59 0 0 0 .585-.196c.078-.58.29-1.028.637-1.34a8.907 8.907 0 0 1-1.333-.234a5.314 5.314 0 0 1-1.223-.507a3.5 3.5 0 0 1-1.047-.872c-.277-.347-.505-.802-.683-1.365c-.177-.564-.266-1.215-.266-1.952c0-1.049.342-1.942 1.027-2.68c-.32-.788-.29-1.673.091-2.652c.252-.079.625-.02 1.119.175c.494.195.856.362 1.086.5c.23.14.414.257.553.352a9.233 9.233 0 0 1 2.497-.338c.859 0 1.691.113 2.498.338l.494-.312a6.997 6.997 0 0 1 1.197-.572c.46-.174.81-.221 1.054-.143c.39.98.424 1.864.103 2.653c.685.737 1.028 1.63 1.028 2.68c0 .737-.089 1.39-.267 1.957c-.177.568-.407 1.023-.689 1.366a3.65 3.65 0 0 1-1.053.865c-.42.234-.828.403-1.223.507a8.9 8.9 0 0 1-1.333.235c.45.39.676 1.005.676 1.846v3.11c0 .147.021.266.065.357a.36.36 0 0 0 .208.189c.096.034.18.056.254.064c.074.01.18.013.318.013h2.914c1.032 0 1.914-.366 2.647-1.099c.732-.732 1.099-1.615 1.099-2.647V3.746c0-1.032-.367-1.914-1.1-2.647z"/>
        </svg>
    </a>



    <a target="_blank" class="social" title="LinkedIn" href="https://www.linkedin.com/in/seehiong">
        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 448 512">
            <path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5c0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7c-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5c67.2 0 79.7 44.3 79.7 101.9V416z"/>
        </svg>
    </a>















    <a target="_blank" class="social" title="RSS Feed" href="/2025/index.xml">
        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 1280.000000 1280.000000">
            <g transform="translate(0.000000,1280.000000) scale(0.100000,-0.100000)" fill="currentColor">
                <path d="M2295 11929 c-284 -12 -642 -45 -707 -65 -17 -5 -18 -63 -18 -1039 0 -569 4 -1036 8 -1039 5 -3 74 6 153 19 510 86 1168 95 1789 25 1348 -153 2602 -677 3670 -1531 385 -308 820 -744 1126 -1129 842 -1060 1362 -2313 1514 -3650 70 -621 61 -1279 -25 -1789 -13 -79 -22 -148 -19 -153 3 -4 471 -8 1039 -8 l1035 0 5 23 c51 225 85 942 67 1419 -23 605 -77 1044 -198 1617 -294 1400 -927 2734 -1823 3846 -1043 1295 -2364 2259 -3909 2854 -1158 447 -2451 656 -3707 600z"/>
                <path d="M2255 7845 c-269 -25 -620 -81 -667 -106 -17 -9 -18 -55 -18 -899 0 -706 3 -890 13 -890 6 0 66 18 132 41 130 44 288 79 467 105 154 21 577 30 749 15 1207 -107 2267 -823 2814 -1902 166 -327 268 -637 330 -1001 38 -227 48 -384 42 -662 -8 -348 -44 -590 -126 -831 -23 -66 -41 -126 -41 -132 0 -10 184 -13 890 -13 844 0 890 1 899 18 27 50 88 452 110 725 14 162 14 624 1 782 -59 703 -233 1323 -545 1945 -481 956 -1313 1788 -2270 2268 -620 310 -1239 483 -1940 542 -165 14 -669 10 -840 -5z"/>
                <path d="M2519 3815 c-391 -66 -725 -336 -868 -703 -79 -201 -96 -462 -45 -677 83 -344 338 -641 666 -774 116 -47 205 -69 330 -80 412 -39 811 153 1040 500 193 292 240 648 128 981 -135 403 -492 699 -914 757 -100 14 -241 12 -337 -4z"/>
            </g>
        </svg>
    </a>





        <p class="footnote">
powered by <a target="_blank" href="https://gohugo.io">Hugo</a> | themed with <a target="_blank" href="https://github.com/lukeorth/poison">poison</a>
    <br>
    &copy; 2025 See Hiong. All rights reserved.
</p>

  </div>
</aside>

            <main class="content container">
                <div class="post" data-pagefind-body>
  <div class="info">
  <h1 class="post-title">
    <a href="https://seehiong.github.io/2025/from-model-to-hdb-app/">From Model to HDB App</a>
  </h1>

  <div class="headline" data-pagefind-ignore>
    <div>
      
      
      <time datetime=" 2025-04-21T20:00:00&#43;0800" class="post-date">
        April 21, 2025
      </time>
      
      <span> - </span>
      <span class="reading-time">
        
          
        

        <span>23 mins read</span>
      </span>
    </div>

    
    <ul class="tags">
      
      <li class="tag-Streamlit">
        <a href="https://seehiong.github.io/tags/streamlit">Streamlit</a>
      </li>
      
      <li class="tag-XGBoost">
        <a href="https://seehiong.github.io/tags/xgboost">XGBoost</a>
      </li>
      
      <li class="tag-MLflow">
        <a href="https://seehiong.github.io/tags/mlflow">MLflow</a>
      </li>
      
      <li class="tag-Kubeflow">
        <a href="https://seehiong.github.io/tags/kubeflow">Kubeflow</a>
      </li>
      
      <li class="tag-MinIO">
        <a href="https://seehiong.github.io/tags/minio">MinIO</a>
      </li>
      
      <li class="tag-KFP">
        <a href="https://seehiong.github.io/tags/kfp">KFP</a>
      </li>
      
      <li class="tag-KServe">
        <a href="https://seehiong.github.io/tags/kserve">KServe</a>
      </li>
      
    </ul>
    
  </div>

  
  
  <p class="author">
    Author: <i>See Hiong</i>
  </p>
  

  

  
</div>

  <p>Building on my <a href="https://seehiong.github.io/2025/feature-impact-on-hdb-predictions/" target="_blank">previous post</a>, this article outlines how to move the selected features into a Kubeflow Pipeline (KFP) for a full model training and deployment workflow. The pipeline fetches input data from S3-compatible MinIO, trains a model using XGBoost with optimized feature selection, and deploys it via KServe. At the end of this journey, a Streamlit app enables users to make resale price predictions by entering flat attributes.</p>
<h2 id="deploying-the-inferenceservice">Deploying the InferenceService</h2>
<p>Following the <a href="https://kserve.github.io/website/master/modelserving/storage/s3/s3/" target="_blank">official KServe documentation</a>, let’s begin by setting up the necessary components to enable model inference from an S3 backend.</p>
<h3 id="1-create-service-account">1. Create Service Account</h3>
<p>Define a service account that references the secret used to access MinIO.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f s3-secret.yaml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># s3-secret.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">sa</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kubeflow-user-example-com</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">secrets</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">minio-creds</span>
</span></span></code></pre></div><h3 id="2-create-s3-secret">2. Create S3 Secret</h3>
<p>Configure your secret to include the MinIO credentials and required annotations for KServe to read from the S3 bucket.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f secret-minio.yaml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># secret-minio.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Secret</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">minio-creds</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kubeflow-user-example-com</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">serving.kserve.io/s3-endpoint</span>: <span style="color:#e6db74">&#34;minio-service.kubeflow:9000&#34;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">serving.kserve.io/s3-usehttps</span>: <span style="color:#e6db74">&#34;0&#34;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">serving.kserve.io/s3-useanoncredential</span>: <span style="color:#e6db74">&#34;false&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">type</span>: <span style="color:#ae81ff">Opaque</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">stringData</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">AWS_ACCESS_KEY_ID</span>: <span style="color:#e6db74">&#34;minio&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">AWS_SECRET_ACCESS_KEY</span>: <span style="color:#e6db74">&#34;minio123&#34;</span>
</span></span></code></pre></div><h3 id="3-deploy-the-inferenceservice">3. Deploy the InferenceService</h3>
<p>Using the <a href="https://kserve.github.io/website/0.11/modelserving/v1beta1/xgboost" target="_blank">XGBoost serving guide</a>, deploy the model. This step will also be handled automatically within the pipeline’s Step 6.</p>
<p><strong>Note</strong>: Ensure the <code>storageUri</code> points to the correct S3 path that contains the XGBoost <code>.bst</code> model file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f kserve-inference.yaml --server-side<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Sample S3 minio url</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># storageUri: &#34;s3://mlpipeline/v2/artifacts/hdb-xgboost-retraining-pipeline-multi-step/053453f4-8e52-4e4a-b2b1-1f8658b92b54/train-model/15ee1507-42e0-4a05-b06f-bd0fa12a7a42/output_model&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># kserve-inference.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#e6db74">&#34;serving.kserve.io/v1beta1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#e6db74">&#34;InferenceService&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">hdb-resale-xgb</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kubeflow-user-example-com</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">autoscaling.knative.dev/maxScale</span>: <span style="color:#e6db74">&#39;1&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">autoscaling.knative.dev/minScale</span>: <span style="color:#e6db74">&#39;0&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">predictor</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">serviceAccountName</span>: <span style="color:#ae81ff">sa</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">model</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">modelFormat</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">xgboost</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">protocolVersion</span>: <span style="color:#ae81ff">v2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">runtime</span>: <span style="color:#ae81ff">kserve-xgbserver</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">storageUri</span>: <span style="color:#e6db74">&#34;s3://mlpipeline/hdb-resale-data/xgb-model-test/model.bst&#34;</span>
</span></span></code></pre></div><h3 id="4-grant-istio-access">4. Grant Istio Access</h3>
<p>To allow prediction requests, create an Istio AuthorizationPolicy that explicitly allows POST and GET operations on the deployed model endpoint.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f allow-hdb-xgb-policy.yaml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># allow-hdb-xgb-policy.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">security.istio.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">AuthorizationPolicy</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">allow-hdb-resale-xgb-access</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kubeflow-user-example-com</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">serving.kserve.io/inferenceservice</span>: <span style="color:#ae81ff">hdb-resale-xgb</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">action</span>: <span style="color:#ae81ff">ALLOW</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">to</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">operation</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">methods</span>: [<span style="color:#e6db74">&#34;POST&#34;</span>,<span style="color:#e6db74">&#34;GET&#34;</span>]
</span></span></code></pre></div><h3 id="5-run-a-prediction">5. Run a Prediction</h3>
<p>Once the pipeline completes successfully, prepare an inference input JSON file and use <code>curl</code> to invoke the model endpoint. The output will contain the predicted resale prices.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;inputs&#34;</span>: [{
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;input-0&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;shape&#34;</span>: [<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">1</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;datatype&#34;</span>: <span style="color:#e6db74">&#34;FP32&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;data&#34;</span>: [
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">0.4311926605504587</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">0.2844036697247706</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">0.27522935779816515</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">0.15137614678899083</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">0.4357798165137615</span>
</span></span><span style="display:flex;"><span>          ]
</span></span><span style="display:flex;"><span>    }]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;inference_input.json&#34;</span>, <span style="color:#e6db74">&#34;w&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>    json<span style="color:#f92672">.</span>dump(payload, f, indent<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>SERVICE_URL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://hdb-resale-xgb.kubeflow-user-example-com.svc.cluster.local&#34;</span>
</span></span><span style="display:flex;"><span>MODEL_NAME<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;hdb-resale-xgb&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Construct the V2 inference endpoint path</span>
</span></span><span style="display:flex;"><span>INFERENCE_ENDPOINT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>SERVICE_URL<span style="color:#e6db74">}</span><span style="color:#e6db74">/v2/models/</span><span style="color:#e6db74">${</span>MODEL_NAME<span style="color:#e6db74">}</span><span style="color:#e6db74">/infer&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Sending request to: </span><span style="color:#e6db74">${</span>INFERENCE_ENDPOINT<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>curl -v -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>INFERENCE_ENDPOINT<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> -d @inference_input.json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Sample Output</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># *   Trying 10.98.223.247:80...</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># * Connected to hdb-resale-xgb.kubeflow-user-example-com.svc.cluster.local (10.98.223.247) port 80 (#0)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &gt; POST /v2/models/hdb-resale-xgb/infer HTTP/1.1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &gt; Host: hdb-resale-xgb.kubeflow-user-example-com.svc.cluster.local</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ...</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &lt; </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># * Connection #0 to host hdb-resale-xgb.kubeflow-user-example-com.svc.cluster.local left intact</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># {&#34;model_name&#34;:&#34;hdb-resale-xgb&#34;,&#34;model_version&#34;:null,&#34;id&#34;:&#34;6d902b7b-a172-4d14-84dd-cc8a004f1200&#34;,&#34;parameters&#34;:null,&#34;outputs&#34;:[{ &#34;name&#34;:&#34;output-0&#34;,&#34;shape&#34;:[5],&#34;datatype&#34;:&#34;FP32&#34;,&#34;parameters&#34;:null,&#34;data&#34;:[600095.875,579441.5625,479052.34375,336679.75,586596</span>
</span></span></code></pre></div><p><img src="/images/hdb-app/hdb-kserve-hdb-resale-xgb.png" alt="hdb-kserve-hdb-resale-xgb"></p>
<h3 id="6-download-scaler-file">6. Download Scaler File</h3>
<p>For accurate predictions, use the same scaler from the training process. Port-forward your MinIO service and download the scaler from the designated path after the pipeline run.</p>
<p><img src="/images/hdb-app/hdb-download-scaler-path.png" alt="hdb-download-scaler-path"></p>
<hr>
<h2 id="multistep-pipeline">Multistep pipeline</h2>
<p>This section outlines the custom Kubeflow pipeline built using KFP DSL. The pipeline handles everything from data ingestion to model deployment. While <a href="https://www.kubeflow.org/docs/components/pipelines/user-guides/data-handling/artifacts/" target="_blank">Kubeflow’s artifact passing</a> is recommended, I encountered limitations and resorted to using <code>OutputPath()</code> and native types for smooth data transfer between steps.</p>
<h3 id="step-1---load--prepare">Step 1 - Load &amp; Prepare</h3>
<p>This component loads the dataset from MinIO, parses the JSON containing selected features, and splits the data into <code>X</code> (features) and <code>y</code> (target resale price).</p>



<details>
    <summary>Component 1 - python code</summary>
   <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> kfp
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> kfp <span style="color:#f92672">import</span> dsl
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> kfp.compiler <span style="color:#f92672">import</span> Compiler
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> kfp.dsl <span style="color:#f92672">import</span> Input, Output, InputPath, OutputPath, Dataset, Metrics, Model, Artifact
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> NamedTuple
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Component 1: Load and Prepare Data</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@dsl.component</span>(
</span></span><span style="display:flex;"><span>    base_image<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;python:3.10&#39;</span>,
</span></span><span style="display:flex;"><span>    packages_to_install<span style="color:#f92672">=</span>[
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;pandas==2.1.4&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;numpy==1.24.4&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;s3fs==2025.3.2&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;pyarrow==19.0.1&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;kfp==2.12.1&#39;</span>,
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load_and_prep_data</span>(
</span></span><span style="display:flex;"><span>    s3_data_uri: str,
</span></span><span style="display:flex;"><span>    target_column: str,
</span></span><span style="display:flex;"><span>    features_json: str,
</span></span><span style="display:flex;"><span>    x_data_path: OutputPath(<span style="color:#e6db74">&#39;Dataset&#39;</span>),
</span></span><span style="display:flex;"><span>    y_data_path: OutputPath(<span style="color:#e6db74">&#39;Dataset&#39;</span>),
</span></span><span style="display:flex;"><span>) <span style="color:#f92672">-&gt;</span> NamedTuple(<span style="color:#e6db74">&#39;LoadDataOutput&#39;</span>, [
</span></span><span style="display:flex;"><span>    (<span style="color:#e6db74">&#39;feature_names_json_out&#39;</span>, str) 
</span></span><span style="display:flex;"><span>]):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Define the NamedTuple</span>
</span></span><span style="display:flex;"><span>    LoadDataOutput <span style="color:#f92672">=</span> NamedTuple(<span style="color:#e6db74">&#39;LoadDataOutput&#39;</span>, [
</span></span><span style="display:flex;"><span>        (<span style="color:#e6db74">&#39;feature_names_json_out&#39;</span>, str)
</span></span><span style="display:flex;"><span>    ])
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> s3fs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;--- Step 1: Load and Prep Data ---&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Input S3 URI: </span><span style="color:#e6db74">{</span>s3_data_uri<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Target Column: </span><span style="color:#e6db74">{</span>target_column<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Load Data</span>
</span></span><span style="display:flex;"><span>    minio_endpoint_url <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;AWS_ENDPOINT_URL&#39;</span>, <span style="color:#e6db74">&#39;http://minio-service.kubeflow:9000&#39;</span>)
</span></span><span style="display:flex;"><span>    minio_access_key <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;AWS_ACCESS_KEY_ID&#39;</span>, <span style="color:#e6db74">&#39;minio&#39;</span>)
</span></span><span style="display:flex;"><span>    minio_secret_key <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;AWS_SECRET_ACCESS_KEY&#39;</span>, <span style="color:#e6db74">&#39;minio123&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    s3_storage_options <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;key&#39;</span>: minio_access_key,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;secret&#39;</span>: minio_secret_key,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;client_kwargs&#39;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;endpoint_url&#39;</span>: minio_endpoint_url
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Reading parquet from S3...&#34;</span>)
</span></span><span style="display:flex;"><span>    df_processed <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_parquet(s3_data_uri, storage_options<span style="color:#f92672">=</span>s3_storage_options)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Loaded data shape: </span><span style="color:#e6db74">{</span>df_processed<span style="color:#f92672">.</span>shape<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Parse Features &amp; Split X/y</span>
</span></span><span style="display:flex;"><span>    feature_names <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(features_json)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Using pre-defined fixed feature set (</span><span style="color:#e6db74">{</span>len(feature_names)<span style="color:#e6db74">}</span><span style="color:#e6db74"> features).&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    missing_features <span style="color:#f92672">=</span> [f <span style="color:#66d9ef">for</span> f <span style="color:#f92672">in</span> feature_names <span style="color:#66d9ef">if</span> f <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> df_processed<span style="color:#f92672">.</span>columns]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> missing_features:
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Fixed features not found in dataset: </span><span style="color:#e6db74">{</span>missing_features<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    X_data <span style="color:#f92672">=</span> df_processed[feature_names]
</span></span><span style="display:flex;"><span>    y_data <span style="color:#f92672">=</span> df_processed[[target_column]]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;X_data shape: </span><span style="color:#e6db74">{</span>X_data<span style="color:#f92672">.</span>shape<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;y_data shape: </span><span style="color:#e6db74">{</span>y_data<span style="color:#f92672">.</span>shape<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Save Outputs</span>
</span></span><span style="display:flex;"><span>    X_data<span style="color:#f92672">.</span>to_parquet(x_data_path)
</span></span><span style="display:flex;"><span>    y_data<span style="color:#f92672">.</span>to_parquet(y_data_path)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;--- Step 1 Complete ---&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> LoadDataOutput(feature_names_json_out<span style="color:#f92672">=</span>features_json)
</span></span></code></pre></div>
</details>

<h3 id="step-2---split--scale">Step 2 - Split &amp; Scale</h3>
<p>Performs train/test splitting and applies scaling. The fitted scaler is saved for later use in inference.</p>



<details>
    <summary>Component 2 - python code</summary>
   <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Component 2: Split and Scale Data</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@dsl.component</span>(
</span></span><span style="display:flex;"><span>    base_image<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;python:3.10&#39;</span>,
</span></span><span style="display:flex;"><span>    packages_to_install<span style="color:#f92672">=</span>[
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;pandas==2.1.4&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;numpy==1.24.4&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;scikit-learn==1.6.1&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;joblib==1.4.2&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;pyarrow==19.0.1&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;kfp==2.12.1&#39;</span>,
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">split_and_scale_data</span>(
</span></span><span style="display:flex;"><span>    x_data_path: InputPath(<span style="color:#e6db74">&#39;Dataset&#39;</span>),
</span></span><span style="display:flex;"><span>    y_data_path: InputPath(<span style="color:#e6db74">&#39;Dataset&#39;</span>),
</span></span><span style="display:flex;"><span>    feature_names_json: str,
</span></span><span style="display:flex;"><span>    use_scaling: bool,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Outputs</span>
</span></span><span style="display:flex;"><span>    x_train_path: OutputPath(<span style="color:#e6db74">&#39;Dataset&#39;</span>),
</span></span><span style="display:flex;"><span>    x_test_path: OutputPath(<span style="color:#e6db74">&#39;Dataset&#39;</span>),
</span></span><span style="display:flex;"><span>    y_train_path: OutputPath(<span style="color:#e6db74">&#39;Dataset&#39;</span>),
</span></span><span style="display:flex;"><span>    y_test_path: OutputPath(<span style="color:#e6db74">&#39;Dataset&#39;</span>),
</span></span><span style="display:flex;"><span>    scaler_path: OutputPath(<span style="color:#e6db74">&#39;Artifact&#39;</span>)
</span></span><span style="display:flex;"><span>):
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> joblib
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">from</span> sklearn.model_selection <span style="color:#f92672">import</span> train_test_split
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">from</span> sklearn.preprocessing <span style="color:#f92672">import</span> MinMaxScaler
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;--- Step 2: Split and Scale Data ---&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Use Scaling: </span><span style="color:#e6db74">{</span>use_scaling<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Load Inputs</span>
</span></span><span style="display:flex;"><span>    X_data <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_parquet(x_data_path)
</span></span><span style="display:flex;"><span>    y_data <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_parquet(y_data_path)
</span></span><span style="display:flex;"><span>    y_data <span style="color:#f92672">=</span> y_data<span style="color:#f92672">.</span>iloc[:, <span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Loaded X shape: </span><span style="color:#e6db74">{</span>X_data<span style="color:#f92672">.</span>shape<span style="color:#e6db74">}</span><span style="color:#e6db74">, y shape: </span><span style="color:#e6db74">{</span>y_data<span style="color:#f92672">.</span>shape<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    feature_names <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(feature_names_json)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Loaded feature names list (</span><span style="color:#e6db74">{</span>len(feature_names)<span style="color:#e6db74">}</span><span style="color:#e6db74"> features).&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Split</span>
</span></span><span style="display:flex;"><span>    X_train, X_test, y_train, y_test <span style="color:#f92672">=</span> train_test_split(X_data, y_data, test_size<span style="color:#f92672">=</span><span style="color:#ae81ff">0.2</span>, random_state<span style="color:#f92672">=</span><span style="color:#ae81ff">42</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;X_train: </span><span style="color:#e6db74">{</span>X_train<span style="color:#f92672">.</span>shape<span style="color:#e6db74">}</span><span style="color:#e6db74">, X_test: </span><span style="color:#e6db74">{</span>X_test<span style="color:#f92672">.</span>shape<span style="color:#e6db74">}</span><span style="color:#e6db74">, y_train: </span><span style="color:#e6db74">{</span>y_train<span style="color:#f92672">.</span>shape<span style="color:#e6db74">}</span><span style="color:#e6db74">, y_test: </span><span style="color:#e6db74">{</span>y_test<span style="color:#f92672">.</span>shape<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Scale</span>
</span></span><span style="display:flex;"><span>    X_scaler <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    scaler_saved <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> use_scaling:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Applying MinMaxScaler.&#34;</span>)
</span></span><span style="display:flex;"><span>        X_scaler <span style="color:#f92672">=</span> MinMaxScaler()
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Fit on Training, Transform Train and Test</span>
</span></span><span style="display:flex;"><span>        X_train_scaled_np <span style="color:#f92672">=</span> X_scaler<span style="color:#f92672">.</span>fit_transform(X_train)
</span></span><span style="display:flex;"><span>        X_test_scaled_np <span style="color:#f92672">=</span> X_scaler<span style="color:#f92672">.</span>transform(X_test)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Convert back to DataFrame with original index and columns</span>
</span></span><span style="display:flex;"><span>        X_train <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(X_train_scaled_np, columns<span style="color:#f92672">=</span>feature_names, index<span style="color:#f92672">=</span>X_train<span style="color:#f92672">.</span>index)
</span></span><span style="display:flex;"><span>        X_test <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(X_test_scaled_np, columns<span style="color:#f92672">=</span>feature_names, index<span style="color:#f92672">=</span>X_test<span style="color:#f92672">.</span>index)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;X_train range (scaled): </span><span style="color:#e6db74">{</span>X_train<span style="color:#f92672">.</span>values<span style="color:#f92672">.</span>min()<span style="color:#e6db74">:</span><span style="color:#e6db74">.4f</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> to </span><span style="color:#e6db74">{</span>X_train<span style="color:#f92672">.</span>values<span style="color:#f92672">.</span>max()<span style="color:#e6db74">:</span><span style="color:#e6db74">.4f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Save the scaler</span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Saving scaler to: </span><span style="color:#e6db74">{</span>scaler_path<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        joblib<span style="color:#f92672">.</span>dump(X_scaler, scaler_path)
</span></span><span style="display:flex;"><span>        scaler_saved <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Using Original Features (No Scaling).&#34;</span>)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;No scaler used, creating empty placeholder artifact at: </span><span style="color:#e6db74">{</span>scaler_path<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> open(scaler_path, <span style="color:#e6db74">&#39;w&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>            f<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Save Outputs</span>
</span></span><span style="display:flex;"><span>    X_train<span style="color:#f92672">.</span>to_parquet(x_train_path)
</span></span><span style="display:flex;"><span>    X_test<span style="color:#f92672">.</span>to_parquet(x_test_path)
</span></span><span style="display:flex;"><span>    pd<span style="color:#f92672">.</span>DataFrame(y_train)<span style="color:#f92672">.</span>to_parquet(y_train_path)
</span></span><span style="display:flex;"><span>    pd<span style="color:#f92672">.</span>DataFrame(y_test)<span style="color:#f92672">.</span>to_parquet(y_test_path)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;--- Step 2 Complete (Scaler Saved: </span><span style="color:#e6db74">{</span>scaler_saved<span style="color:#e6db74">}</span><span style="color:#e6db74">) ---&#34;</span>)
</span></span></code></pre></div>
</details>

<h3 id="step-3---train-model">Step 3 - Train Model</h3>
<p>An XGBoost model is trained using the core API, with the run tracked via MLflow. The model is saved in .bst format as required by KServe.</p>



<details>
    <summary>Component 3 - python code</summary>
   <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Component 3: Train Model</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@dsl.component</span>(
</span></span><span style="display:flex;"><span>    base_image<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;python:3.10&#39;</span>,
</span></span><span style="display:flex;"><span>    packages_to_install<span style="color:#f92672">=</span>[
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;pandas==2.1.4&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;numpy==1.24.4&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;xgboost==2.1.1&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;mlflow==2.21.3&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;pyarrow==19.0.1&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;joblib==1.4.2&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;kfp==2.12.1&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;scikit-learn==1.6.1&#39;</span>
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">train_model</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Data inputs</span>
</span></span><span style="display:flex;"><span>    x_train_path: InputPath(<span style="color:#e6db74">&#39;Dataset&#39;</span>),
</span></span><span style="display:flex;"><span>    x_test_path: InputPath(<span style="color:#e6db74">&#39;Dataset&#39;</span>),
</span></span><span style="display:flex;"><span>    y_train_path: InputPath(<span style="color:#e6db74">&#39;Dataset&#39;</span>),
</span></span><span style="display:flex;"><span>    y_test_path: InputPath(<span style="color:#e6db74">&#39;Dataset&#39;</span>),
</span></span><span style="display:flex;"><span>    scaler_path: InputPath(<span style="color:#e6db74">&#39;Artifact&#39;</span>),
</span></span><span style="display:flex;"><span>    use_scaling: bool, 
</span></span><span style="display:flex;"><span>    feature_names_json: str,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Hyperparameters</span>
</span></span><span style="display:flex;"><span>    n_estimators: int,
</span></span><span style="display:flex;"><span>    learning_rate: float,
</span></span><span style="display:flex;"><span>    max_depth: int,
</span></span><span style="display:flex;"><span>    early_stopping_rounds: int,
</span></span><span style="display:flex;"><span>    colsample_bytree: float,
</span></span><span style="display:flex;"><span>    min_child_weight: int,
</span></span><span style="display:flex;"><span>    subsample: float,
</span></span><span style="display:flex;"><span>    random_state: int,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># MLflow info</span>
</span></span><span style="display:flex;"><span>    run_name: str,
</span></span><span style="display:flex;"><span>    mlflow_tracking_uri: str,
</span></span><span style="display:flex;"><span>    mlflow_experiment_name: str,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Outputs</span>
</span></span><span style="display:flex;"><span>    output_model: Output[Model],
</span></span><span style="display:flex;"><span>) <span style="color:#f92672">-&gt;</span> NamedTuple(<span style="color:#e6db74">&#39;TrainOutput&#39;</span>, [
</span></span><span style="display:flex;"><span>    (<span style="color:#e6db74">&#39;mlflow_run_id_out&#39;</span>, str)
</span></span><span style="display:flex;"><span>]):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Define NamedTuple</span>
</span></span><span style="display:flex;"><span>    TrainOutput <span style="color:#f92672">=</span> NamedTuple(<span style="color:#e6db74">&#39;TrainOutput&#39;</span>, [(<span style="color:#e6db74">&#39;mlflow_run_id_out&#39;</span>, str)])
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> xgboost <span style="color:#66d9ef">as</span> xgb
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> mlflow
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> mlflow.xgboost
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> joblib
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">from</span> pathlib <span style="color:#f92672">import</span> Path
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> warnings
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Ignore the UBJSON format warning during saving</span>
</span></span><span style="display:flex;"><span>    warnings<span style="color:#f92672">.</span>filterwarnings(<span style="color:#e6db74">&#39;ignore&#39;</span>, category<span style="color:#f92672">=</span><span style="color:#a6e22e">UserWarning</span>, module<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;xgboost.core&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;--- Step 3: Train Model ---&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;MLflow Tracking URI: </span><span style="color:#e6db74">{</span>mlflow_tracking_uri<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;MLflow Experiment Name: </span><span style="color:#e6db74">{</span>mlflow_experiment_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Using XGBoost version: </span><span style="color:#e6db74">{</span>xgb<span style="color:#f92672">.</span>__version__<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Hyperparameters: n_est=</span><span style="color:#e6db74">{</span>n_estimators<span style="color:#e6db74">}</span><span style="color:#e6db74">, lr=</span><span style="color:#e6db74">{</span>learning_rate<span style="color:#e6db74">}</span><span style="color:#e6db74">, depth=</span><span style="color:#e6db74">{</span>max_depth<span style="color:#e6db74">}</span><span style="color:#e6db74">, early_stop=</span><span style="color:#e6db74">{</span>early_stopping_rounds<span style="color:#e6db74">}</span><span style="color:#e6db74">, colsample=</span><span style="color:#e6db74">{</span>colsample_bytree<span style="color:#e6db74">}</span><span style="color:#e6db74">, min_child=</span><span style="color:#e6db74">{</span>min_child_weight<span style="color:#e6db74">}</span><span style="color:#e6db74">, subsample=</span><span style="color:#e6db74">{</span>subsample<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Load Data</span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Loading training/testing data&#34;</span>)
</span></span><span style="display:flex;"><span>    X_train_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_parquet(x_train_path)
</span></span><span style="display:flex;"><span>    X_test_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_parquet(x_test_path)
</span></span><span style="display:flex;"><span>    y_train_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_parquet(y_train_path)
</span></span><span style="display:flex;"><span>    y_test_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_parquet(y_test_path)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Ensure y is a 1D array</span>
</span></span><span style="display:flex;"><span>    y_train <span style="color:#f92672">=</span> y_train_df<span style="color:#f92672">.</span>iloc[:, <span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>values
</span></span><span style="display:flex;"><span>    y_test <span style="color:#f92672">=</span> y_test_df<span style="color:#f92672">.</span>iloc[:, <span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>values
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Get feature names and enforce order in DataFrame</span>
</span></span><span style="display:flex;"><span>    feature_names <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(feature_names_json)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Loaded feature names list (</span><span style="color:#e6db74">{</span>len(feature_names)<span style="color:#e6db74">}</span><span style="color:#e6db74"> features).&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Ensure feature order matches the expected order</span>
</span></span><span style="display:flex;"><span>    X_train <span style="color:#f92672">=</span> X_train_df[feature_names]
</span></span><span style="display:flex;"><span>    X_test <span style="color:#f92672">=</span> X_test_df[feature_names]
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Verified feature order in datasets. X_train: </span><span style="color:#e6db74">{</span>X_train<span style="color:#f92672">.</span>shape<span style="color:#e6db74">}</span><span style="color:#e6db74">, X_test: </span><span style="color:#e6db74">{</span>X_test<span style="color:#f92672">.</span>shape<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Convert to NumPy FOR TRAINING - crucial step</span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Converting data to NumPy arrays for DMatrix creation...&#34;</span>)
</span></span><span style="display:flex;"><span>    X_train_np <span style="color:#f92672">=</span> X_train_df<span style="color:#f92672">.</span>values
</span></span><span style="display:flex;"><span>    X_test_np <span style="color:#f92672">=</span> X_test_df<span style="color:#f92672">.</span>values
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># MLflow Setup and Start Run</span>
</span></span><span style="display:flex;"><span>    mlflow<span style="color:#f92672">.</span>set_tracking_uri(mlflow_tracking_uri)
</span></span><span style="display:flex;"><span>    mlflow<span style="color:#f92672">.</span>set_experiment(mlflow_experiment_name)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Configure MLflow autologging - DISABLE model logging</span>
</span></span><span style="display:flex;"><span>    mlflow<span style="color:#f92672">.</span>xgboost<span style="color:#f92672">.</span>autolog(
</span></span><span style="display:flex;"><span>        log_input_examples<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>        log_model_signatures<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>        log_models<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>        log_datasets<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>        disable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>        registered_model_name<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Start MLflow Run</span>
</span></span><span style="display:flex;"><span>    kfp_run_id <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;KFP_RUN_ID&#39;</span>, <span style="color:#e6db74">&#39;local&#39;</span>)
</span></span><span style="display:flex;"><span>    final_run_name <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>run_name<span style="color:#e6db74">}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">{</span>kfp_run_id<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Starting MLflow run with name: </span><span style="color:#e6db74">{</span>final_run_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> mlflow<span style="color:#f92672">.</span>start_run(run_name<span style="color:#f92672">=</span>final_run_name) <span style="color:#66d9ef">as</span> run:
</span></span><span style="display:flex;"><span>        current_run_id <span style="color:#f92672">=</span> run<span style="color:#f92672">.</span>info<span style="color:#f92672">.</span>run_id
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Started MLflow Run ID: </span><span style="color:#e6db74">{</span>current_run_id<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Log parameters</span>
</span></span><span style="display:flex;"><span>        mlflow<span style="color:#f92672">.</span>log_params({
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;feature_set_name&#34;</span>: final_run_name,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;num_features&#34;</span>: len(feature_names),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;use_scaling&#34;</span>: use_scaling,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;n_estimators&#34;</span>: n_estimators,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;learning_rate&#34;</span>: learning_rate,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;max_depth&#34;</span>: max_depth,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;early_stopping_rounds&#34;</span>: early_stopping_rounds,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;colsample_bytree&#34;</span>: colsample_bytree,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;min_child_weight&#34;</span>: min_child_weight,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;subsample&#34;</span>: subsample,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;random_state&#34;</span>: random_state,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;model_type&#34;</span>: <span style="color:#e6db74">&#34;XGBoost&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;training_api&#34;</span>: <span style="color:#e6db74">&#34;xgb.train&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;framework&#34;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;xgboost==</span><span style="color:#e6db74">{</span>xgb<span style="color:#f92672">.</span>__version__<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Log feature names as artifact</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            temp_feat_path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;feature_names.json&#34;</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">with</span> open(temp_feat_path, <span style="color:#e6db74">&#34;w&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>                json<span style="color:#f92672">.</span>dump(feature_names, f)
</span></span><span style="display:flex;"><span>            mlflow<span style="color:#f92672">.</span>log_artifact(temp_feat_path, artifact_path<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;features&#34;</span>)
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;Feature names list logged as artifact.&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Warning: Could not log feature names artifact: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Log scaler artifact if used</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> use_scaling <span style="color:#f92672">and</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(scaler_path) <span style="color:#f92672">and</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>getsize(scaler_path) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                mlflow<span style="color:#f92672">.</span>log_artifact(scaler_path, artifact_path<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;scaler&#34;</span>)
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">&#34;Scaler logged as artifact to MLflow.&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Warning: Could not log scaler artifact: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Model Training using Core API</span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Creating DMatrix WITHOUT feature names...&#34;</span>)
</span></span><span style="display:flex;"><span>        dtrain <span style="color:#f92672">=</span> xgb<span style="color:#f92672">.</span>DMatrix(X_train_np, label<span style="color:#f92672">=</span>y_train)
</span></span><span style="display:flex;"><span>        dtest <span style="color:#f92672">=</span> xgb<span style="color:#f92672">.</span>DMatrix(X_test_np, label<span style="color:#f92672">=</span>y_test)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;DMatrix created.&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Training XGBoost model using xgb.train...&#34;</span>)
</span></span><span style="display:flex;"><span>        params <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;objective&#39;</span>: <span style="color:#e6db74">&#39;reg:squarederror&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;learning_rate&#39;</span>: learning_rate,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;max_depth&#39;</span>: max_depth,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;subsample&#39;</span>: subsample,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;colsample_bytree&#39;</span>: colsample_bytree,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;min_child_weight&#39;</span>: min_child_weight,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;random_state&#39;</span>: random_state,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;eval_metric&#39;</span>: <span style="color:#e6db74">&#39;rmse&#39;</span>,
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        evals <span style="color:#f92672">=</span> [(dtrain, <span style="color:#e6db74">&#39;train&#39;</span>), (dtest, <span style="color:#e6db74">&#39;eval&#39;</span>)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Train the model - returns the booster object</span>
</span></span><span style="display:flex;"><span>        bst_model <span style="color:#f92672">=</span> xgb<span style="color:#f92672">.</span>train(
</span></span><span style="display:flex;"><span>            params,
</span></span><span style="display:flex;"><span>            dtrain,
</span></span><span style="display:flex;"><span>            num_boost_round<span style="color:#f92672">=</span>n_estimators,
</span></span><span style="display:flex;"><span>            evals<span style="color:#f92672">=</span>evals,
</span></span><span style="display:flex;"><span>            early_stopping_rounds<span style="color:#f92672">=</span>early_stopping_rounds,
</span></span><span style="display:flex;"><span>            verbose_eval<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Training complete. Best iteration: </span><span style="color:#e6db74">{</span>bst_model<span style="color:#f92672">.</span>best_iteration<span style="color:#e6db74">}</span><span style="color:#e6db74">, Best score (RMSE): </span><span style="color:#e6db74">{</span>bst_model<span style="color:#f92672">.</span>best_score<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Save Model Manually (Binary Format)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            model_dir <span style="color:#f92672">=</span> Path(output_model<span style="color:#f92672">.</span>path)
</span></span><span style="display:flex;"><span>            model_dir<span style="color:#f92672">.</span>mkdir(parents<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, exist_ok<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>            model_file_path <span style="color:#f92672">=</span> model_dir <span style="color:#f92672">/</span> <span style="color:#e6db74">&#34;model.bst&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Saving model in binary format to: </span><span style="color:#e6db74">{</span>model_file_path<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>            bst_model<span style="color:#f92672">.</span>save_model(model_file_path)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Verify the model was saved</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> model_file_path<span style="color:#f92672">.</span>exists() <span style="color:#f92672">or</span> model_file_path<span style="color:#f92672">.</span>stat()<span style="color:#f92672">.</span>st_size <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">RuntimeError</span>(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Failed to save model or model file is empty at </span><span style="color:#e6db74">{</span>model_file_path<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Model successfully saved locally to </span><span style="color:#e6db74">{</span>model_file_path<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>                            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Log Model Manually to MLflow</span>
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;Logging model artifact to MLflow...&#34;</span>)
</span></span><span style="display:flex;"><span>            mlflow<span style="color:#f92672">.</span>log_artifact(model_file_path, artifact_path<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;model&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;temp_feat_path&#39;</span> <span style="color:#f92672">in</span> locals() <span style="color:#f92672">and</span> Path(temp_feat_path)<span style="color:#f92672">.</span>exists(): 
</span></span><span style="display:flex;"><span>                mlflow<span style="color:#f92672">.</span>log_artifact(temp_feat_path, artifact_path<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;model&#34;</span>)
</span></span><span style="display:flex;"><span>                os<span style="color:#f92672">.</span>remove(temp_feat_path)
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;Model artifacts logged to MLflow run.&#34;</span>)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Set KFP output model metadata </span>
</span></span><span style="display:flex;"><span>            output_model<span style="color:#f92672">.</span>metadata<span style="color:#f92672">.</span>update({
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;framework&#34;</span>: <span style="color:#e6db74">&#34;xgboost&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;format&#34;</span>: <span style="color:#e6db74">&#34;bst&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;feature_order&#34;</span>: json<span style="color:#f92672">.</span>dumps(feature_names),
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;feature_count&#34;</span>: str(len(feature_names)),
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;best_iteration&#34;</span>: str(bst_model<span style="color:#f92672">.</span>best_iteration),
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;best_score&#34;</span>: str(bst_model<span style="color:#f92672">.</span>best_score),
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;training_samples&#34;</span>: str(len(X_train_np)),
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;validation_samples&#34;</span>: str(len(X_test_np)),
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;mlflow_run_id&#34;</span>: current_run_id
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Error saving/logging model artifacts: </span><span style="color:#e6db74">{</span>str(e)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;--- Step 3 Complete (MLflow Run ID: </span><span style="color:#e6db74">{</span>current_run_id<span style="color:#e6db74">}</span><span style="color:#e6db74">) ---&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> TrainOutput(mlflow_run_id_out<span style="color:#f92672">=</span>current_run_id)
</span></span></code></pre></div>
</details>

<h3 id="step-4---predict--evaluate">Step 4 - Predict &amp; Evaluate</h3>
<p>The trained model is used to predict on test data, and performance metrics are logged to MLflow.</p>



<details>
    <summary>Component 4 - python code</summary>
   <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Component 4: Predict and Evaluate</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@dsl.component</span>(
</span></span><span style="display:flex;"><span>    base_image<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;python:3.10&#39;</span>,
</span></span><span style="display:flex;"><span>    packages_to_install<span style="color:#f92672">=</span>[
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;pandas==2.1.4&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;numpy==1.24.4&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;xgboost==2.1.1&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;scikit-learn==1.6.1&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;mlflow==2.21.3&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;pyarrow==19.0.1&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;joblib==1.4.2&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;kfp==2.12.1&#39;</span>,
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">predict_and_evaluate</span>(
</span></span><span style="display:flex;"><span>    input_model: Input[Model],
</span></span><span style="display:flex;"><span>    x_test_path: InputPath(<span style="color:#e6db74">&#39;Dataset&#39;</span>),
</span></span><span style="display:flex;"><span>    y_test_path: InputPath(<span style="color:#e6db74">&#39;Dataset&#39;</span>),
</span></span><span style="display:flex;"><span>    mlflow_run_id: str,
</span></span><span style="display:flex;"><span>    mlflow_tracking_uri: str,
</span></span><span style="display:flex;"><span>    feature_names_json: str,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Outputs</span>
</span></span><span style="display:flex;"><span>    y_pred_path: OutputPath(<span style="color:#e6db74">&#39;Dataset&#39;</span>),
</span></span><span style="display:flex;"><span>    test_rmse_output: OutputPath(float),
</span></span><span style="display:flex;"><span>    test_mae_output: OutputPath(float),
</span></span><span style="display:flex;"><span>    test_r2_output: OutputPath(float),
</span></span><span style="display:flex;"><span>):
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> xgboost <span style="color:#66d9ef">as</span> xgb
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> mlflow
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> joblib
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">from</span> sklearn.metrics <span style="color:#f92672">import</span> mean_squared_error, mean_absolute_error, r2_score
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">from</span> pathlib <span style="color:#f92672">import</span> Path
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;--- Step 4: Predict and Evaluate ---&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Using XGBoost version: </span><span style="color:#e6db74">{</span>xgb<span style="color:#f92672">.</span>__version__<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Load Inputs</span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Loading model...&#34;</span>)
</span></span><span style="display:flex;"><span>    model_dir <span style="color:#f92672">=</span> Path(input_model<span style="color:#f92672">.</span>path)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Look for model.bst</span>
</span></span><span style="display:flex;"><span>    model_file_bst <span style="color:#f92672">=</span> model_dir <span style="color:#f92672">/</span> <span style="color:#e6db74">&#34;model.bst&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> model_file_bst<span style="color:#f92672">.</span>exists():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">FileNotFoundError</span>(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Model file &#39;model.bst&#39; not found at </span><span style="color:#e6db74">{</span>model_dir<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Loading XGBoost model from </span><span style="color:#e6db74">{</span>model_file_bst<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Load model using Booster interface</span>
</span></span><span style="display:flex;"><span>    booster <span style="color:#f92672">=</span> xgb<span style="color:#f92672">.</span>Booster()
</span></span><span style="display:flex;"><span>    booster<span style="color:#f92672">.</span>load_model(model_file_bst)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Model loaded successfully.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Loading test data...&#34;</span>)
</span></span><span style="display:flex;"><span>    X_test_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_parquet(x_test_path)
</span></span><span style="display:flex;"><span>    y_test_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_parquet(y_test_path)
</span></span><span style="display:flex;"><span>    y_test <span style="color:#f92672">=</span> y_test_df<span style="color:#f92672">.</span>iloc[:, <span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>values
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Load feature names to ensure correct column order in X_test_df</span>
</span></span><span style="display:flex;"><span>    feature_names <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(feature_names_json)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Ensuring test data feature order using: </span><span style="color:#e6db74">{</span>feature_names<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        X_test_df <span style="color:#f92672">=</span> X_test_df[feature_names]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">KeyError</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Error: Feature mismatch when ordering X_test columns: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        missing <span style="color:#f92672">=</span> set(feature_names) <span style="color:#f92672">-</span> set(X_test_df<span style="color:#f92672">.</span>columns)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> missing:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Features expected but missing in X_test data: </span><span style="color:#e6db74">{</span>missing<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Configure MLflow Client</span>
</span></span><span style="display:flex;"><span>    mlflow<span style="color:#f92672">.</span>set_tracking_uri(mlflow_tracking_uri)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Using MLflow Run ID: </span><span style="color:#e6db74">{</span>mlflow_run_id<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Attempting to log metrics to existing MLflow run...&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> mlflow<span style="color:#f92672">.</span>start_run(run_id<span style="color:#f92672">=</span>mlflow_run_id):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Prediction</span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Generating predictions...&#34;</span>)
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Creating DMatrix from X_test data with shape: </span><span style="color:#e6db74">{</span>X_test_df<span style="color:#f92672">.</span>shape<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        dtest <span style="color:#f92672">=</span> xgb<span style="color:#f92672">.</span>DMatrix(X_test_df)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        y_pred <span style="color:#f92672">=</span> booster<span style="color:#f92672">.</span>predict(dtest)        
</span></span><span style="display:flex;"><span>        y_pred <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(y_pred)<span style="color:#f92672">.</span>ravel() <span style="color:#75715e"># Ensure y_pred is a flat NumPy array</span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Predictions generated with shape: </span><span style="color:#e6db74">{</span>y_pred<span style="color:#f92672">.</span>shape<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Evaluation</span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Calculating evaluation metrics...&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Handle potential NaN/inf</span>
</span></span><span style="display:flex;"><span>        valid_indices <span style="color:#f92672">=</span> <span style="color:#f92672">~</span>np<span style="color:#f92672">.</span>isnan(y_test) <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span>np<span style="color:#f92672">.</span>isinf(y_test) <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span>np<span style="color:#f92672">.</span>isnan(y_pred) <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span>np<span style="color:#f92672">.</span>isinf(y_pred)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> np<span style="color:#f92672">.</span>all(valid_indices):
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Warning: NaN or Inf detected... &#34;</span>)
</span></span><span style="display:flex;"><span>            y_test_valid <span style="color:#f92672">=</span> y_test[valid_indices]
</span></span><span style="display:flex;"><span>            y_pred_valid <span style="color:#f92672">=</span> y_pred[valid_indices]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            y_test_valid <span style="color:#f92672">=</span> y_test
</span></span><span style="display:flex;"><span>            y_pred_valid <span style="color:#f92672">=</span> y_pred
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check if any valid data remains after filtering</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(y_test_valid) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>             print(<span style="color:#e6db74">&#34;Error: No valid data points remain after filtering NaN/Inf. Cannot calculate metrics.&#34;</span>)
</span></span><span style="display:flex;"><span>             rmse, mae, r2 <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>nan, np<span style="color:#f92672">.</span>nan, np<span style="color:#f92672">.</span>nan
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            mse <span style="color:#f92672">=</span> mean_squared_error(y_test_valid, y_pred_valid)
</span></span><span style="display:flex;"><span>            rmse <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>sqrt(mse)
</span></span><span style="display:flex;"><span>            mae <span style="color:#f92672">=</span> mean_absolute_error(y_test_valid, y_pred_valid)
</span></span><span style="display:flex;"><span>            r2 <span style="color:#f92672">=</span> r2_score(y_test_valid, y_pred_valid)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Get best iteration from metadata if available</span>
</span></span><span style="display:flex;"><span>        best_iteration <span style="color:#f92672">=</span> int(input_model<span style="color:#f92672">.</span>metadata<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;best_iteration&#39;</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Log Metrics to MLflow</span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Logging metrics to MLflow...&#34;</span>)
</span></span><span style="display:flex;"><span>        mlflow<span style="color:#f92672">.</span>log_metrics({
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;eval_mse&#34;</span>: mse <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> np<span style="color:#f92672">.</span>isnan(mse) <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;eval_rmse&#34;</span>: rmse <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> np<span style="color:#f92672">.</span>isnan(rmse) <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;eval_mae&#34;</span>: mae <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> np<span style="color:#f92672">.</span>isnan(mae) <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;eval_r2&#34;</span>: r2 <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> np<span style="color:#f92672">.</span>isnan(r2) <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Log best_iteration if valid</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">**</span>({<span style="color:#e6db74">&#34;best_iteration_eval&#34;</span>: best_iteration} <span style="color:#66d9ef">if</span> best_iteration <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">else</span> {})
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">--- Evaluation Results ---&#34;</span>)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Test Set MSE: </span><span style="color:#e6db74">{</span>mse<span style="color:#e6db74">:</span><span style="color:#e6db74">,.4f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Test Set RMSE: </span><span style="color:#e6db74">{</span>rmse<span style="color:#e6db74">:</span><span style="color:#e6db74">,.4f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Test Set MAE: </span><span style="color:#e6db74">{</span>mae<span style="color:#e6db74">:</span><span style="color:#e6db74">,.4f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Test Set R²: </span><span style="color:#e6db74">{</span>r2<span style="color:#e6db74">:</span><span style="color:#e6db74">.4f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> best_iteration <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Best Iteration (from training): </span><span style="color:#e6db74">{</span>best_iteration<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Save predictions as DataFrame/Parquet</span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Saving predictions DataFrame (</span><span style="color:#e6db74">{</span>len(y_pred)<span style="color:#e6db74">}</span><span style="color:#e6db74"> rows) to: </span><span style="color:#e6db74">{</span>y_pred_path<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        pred_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame({<span style="color:#e6db74">&#39;predictions&#39;</span>: y_pred}, index<span style="color:#f92672">=</span>X_test_df<span style="color:#f92672">.</span>index)
</span></span><span style="display:flex;"><span>        pred_df<span style="color:#f92672">.</span>to_parquet(y_pred_path)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>         <span style="color:#75715e"># Save metrics to KFP output paths</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> open(test_rmse_output, <span style="color:#e6db74">&#39;w&#39;</span>) <span style="color:#66d9ef">as</span> f: f<span style="color:#f92672">.</span>write(str(rmse <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> np<span style="color:#f92672">.</span>isnan(rmse) <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0.0</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> open(test_mae_output, <span style="color:#e6db74">&#39;w&#39;</span>) <span style="color:#66d9ef">as</span> f: f<span style="color:#f92672">.</span>write(str(mae <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> np<span style="color:#f92672">.</span>isnan(mae) <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0.0</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> open(test_r2_output, <span style="color:#e6db74">&#39;w&#39;</span>) <span style="color:#66d9ef">as</span> f: f<span style="color:#f92672">.</span>write(str(r2 <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> np<span style="color:#f92672">.</span>isnan(r2) <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0.0</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;--- Step 4 Complete ---&#34;</span>)
</span></span></code></pre></div>
</details>

<h3 id="step-5---generate--log-plot">Step 5 - Generate &amp; Log Plot</h3>
<p>This component visualizes key performance metrics and logs the resulting plots to the MLflow run.</p>



<details>
    <summary>Component 5 - python code</summary>
   <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Component 5: Generate and Log Plots</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@dsl.component</span>(
</span></span><span style="display:flex;"><span>    base_image<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;python:3.10&#39;</span>,
</span></span><span style="display:flex;"><span>    packages_to_install<span style="color:#f92672">=</span>[
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;pandas==2.1.4&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;numpy==1.24.4&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;xgboost==2.1.1&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;matplotlib==3.10.0&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;mlflow==2.21.3&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;joblib==1.4.2&#39;</span>, 
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;pyarrow==19.0.1&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;kfp==2.12.1&#39;</span>,
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_and_log_plots</span>(
</span></span><span style="display:flex;"><span>    input_model: Input[Model],
</span></span><span style="display:flex;"><span>    y_test_path: InputPath(<span style="color:#e6db74">&#39;Dataset&#39;</span>),
</span></span><span style="display:flex;"><span>    y_pred_path: InputPath(<span style="color:#e6db74">&#39;Dataset&#39;</span>),
</span></span><span style="display:flex;"><span>    feature_names_json: str,
</span></span><span style="display:flex;"><span>    mlflow_run_id: str,
</span></span><span style="display:flex;"><span>    mlflow_tracking_uri: str,
</span></span><span style="display:flex;"><span>    run_name: str, 
</span></span><span style="display:flex;"><span>):
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> xgboost <span style="color:#66d9ef">as</span> xgb
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">from</span> xgboost <span style="color:#f92672">import</span> plot_importance
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> mlflow
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> traceback
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">from</span> pathlib <span style="color:#f92672">import</span> Path
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;--- Step 5: Generate and Log Plots ---&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Using XGBoost version: </span><span style="color:#e6db74">{</span>xgb<span style="color:#f92672">.</span>__version__<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Load Inputs</span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Loading model...&#34;</span>)
</span></span><span style="display:flex;"><span>    model_dir <span style="color:#f92672">=</span> Path(input_model<span style="color:#f92672">.</span>path)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Check for model file</span>
</span></span><span style="display:flex;"><span>    model_file_bst <span style="color:#f92672">=</span> model_dir <span style="color:#f92672">/</span> <span style="color:#e6db74">&#34;model.bst&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> model_file_bst<span style="color:#f92672">.</span>exists():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">FileNotFoundError</span>(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Model file &#39;model.bst&#39; not found at </span><span style="color:#e6db74">{</span>model_dir<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Loading XGBoost model from </span><span style="color:#e6db74">{</span>model_file_bst<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    booster <span style="color:#f92672">=</span> xgb<span style="color:#f92672">.</span>Booster()
</span></span><span style="display:flex;"><span>    booster<span style="color:#f92672">.</span>load_model(model_file_bst)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Model loaded successfully.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Loading y_test data...&#34;</span>)
</span></span><span style="display:flex;"><span>    y_test <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_parquet(y_test_path)<span style="color:#f92672">.</span>iloc[:, <span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>values <span style="color:#75715e"># Load as numpy array</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Loading feature names...&#34;</span>)
</span></span><span style="display:flex;"><span>    feature_names <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(feature_names_json)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Loaded </span><span style="color:#e6db74">{</span>len(feature_names)<span style="color:#e6db74">}</span><span style="color:#e6db74"> feature names.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> feature_names:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Setting feature names on loaded booster for plotting...&#34;</span>)
</span></span><span style="display:flex;"><span>        booster<span style="color:#f92672">.</span>feature_names <span style="color:#f92672">=</span> feature_names
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Warning: Empty feature names list received. Importance plots might use default &#39;fN&#39; names.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Using MLflow Run ID: </span><span style="color:#e6db74">{</span>mlflow_run_id<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Load predictions</span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Loading predictions from: </span><span style="color:#e6db74">{</span>y_pred_path<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        y_pred_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_parquet(y_pred_path)
</span></span><span style="display:flex;"><span>        y_pred <span style="color:#f92672">=</span> y_pred_df<span style="color:#f92672">.</span>iloc[:, <span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>values <span style="color:#75715e"># Load as numpy array</span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Loaded predictions, shape: </span><span style="color:#e6db74">{</span>y_pred<span style="color:#f92672">.</span>shape<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Error loading predictions: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Configure MLflow Client</span>
</span></span><span style="display:flex;"><span>    mlflow<span style="color:#f92672">.</span>set_tracking_uri(mlflow_tracking_uri)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Log plots to the existing MLflow run</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> mlflow<span style="color:#f92672">.</span>start_run(run_id<span style="color:#f92672">=</span>mlflow_run_id):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Helper Functions</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_dynamic_figsize</span>(feature_count, max_features<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>):
</span></span><span style="display:flex;"><span>            display_count <span style="color:#f92672">=</span> min(feature_count, max_features)
</span></span><span style="display:flex;"><span>            height <span style="color:#f92672">=</span> max(<span style="color:#ae81ff">6</span>, display_count <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.4</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>            width <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> (width, height)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Generate and Log Plots</span>
</span></span><span style="display:flex;"><span>        kfp_run_id <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;KFP_RUN_ID&#39;</span>, <span style="color:#e6db74">&#39;local&#39;</span>) 
</span></span><span style="display:flex;"><span>        final_run_name <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>run_name<span style="color:#e6db74">}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">{</span>kfp_run_id<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Generating and logging plots to MLflow...&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Actual vs Predicted Plot</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            fig_pred, ax_pred <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">6</span>))
</span></span><span style="display:flex;"><span>            valid_indices <span style="color:#f92672">=</span> <span style="color:#f92672">~</span>np<span style="color:#f92672">.</span>isnan(y_test_np) <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span>np<span style="color:#f92672">.</span>isinf(y_test_np) <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span>np<span style="color:#f92672">.</span>isnan(y_pred) <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span>np<span style="color:#f92672">.</span>isinf(y_pred)
</span></span><span style="display:flex;"><span>            y_test_plt <span style="color:#f92672">=</span> y_test_np[valid_indices]
</span></span><span style="display:flex;"><span>            y_pred_plt <span style="color:#f92672">=</span> y_pred[valid_indices]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            ax_pred<span style="color:#f92672">.</span>scatter(y_test_plt, y_pred_plt, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Predictions&#34;</span>)
</span></span><span style="display:flex;"><span>            min_val <span style="color:#f92672">=</span> min(y_test_plt<span style="color:#f92672">.</span>min(), y_pred_plt<span style="color:#f92672">.</span>min()) <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.98</span>
</span></span><span style="display:flex;"><span>            max_val <span style="color:#f92672">=</span> max(y_test_plt<span style="color:#f92672">.</span>max(), y_pred_plt<span style="color:#f92672">.</span>max()) <span style="color:#f92672">*</span> <span style="color:#ae81ff">1.02</span>
</span></span><span style="display:flex;"><span>            ax_pred<span style="color:#f92672">.</span>plot([min_val, max_val], [min_val, max_val], <span style="color:#e6db74">&#39;--&#39;</span>, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;red&#39;</span>, linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Ideal Fit&#34;</span>)
</span></span><span style="display:flex;"><span>            ax_pred<span style="color:#f92672">.</span>set_xlabel(<span style="color:#e6db74">&#39;Actual Target&#39;</span>)
</span></span><span style="display:flex;"><span>            ax_pred<span style="color:#f92672">.</span>set_ylabel(<span style="color:#e6db74">&#39;Predicted Target&#39;</span>)
</span></span><span style="display:flex;"><span>            ax_pred<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Actual vs. Predicted (</span><span style="color:#e6db74">{</span>final_run_name<span style="color:#e6db74">}</span><span style="color:#e6db74">)&#39;</span>)
</span></span><span style="display:flex;"><span>            ax_pred<span style="color:#f92672">.</span>legend()
</span></span><span style="display:flex;"><span>            ax_pred<span style="color:#f92672">.</span>grid(<span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>tight_layout()
</span></span><span style="display:flex;"><span>            mlflow<span style="color:#f92672">.</span>log_figure(fig_pred, <span style="color:#e6db74">&#34;plots/actual_vs_predicted.png&#34;</span>)
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>close(fig_pred)
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;Logged actual_vs_predicted.png&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Warning: Could not plot Actual vs Predicted: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">{</span>traceback<span style="color:#f92672">.</span>format_exc()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Feature Importance Plots</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            num_features <span style="color:#f92672">=</span> len(booster<span style="color:#f92672">.</span>feature_names) <span style="color:#66d9ef">if</span> booster<span style="color:#f92672">.</span>feature_names <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> num_features <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>                 print(<span style="color:#e6db74">&#34;Skipping importance plots: No feature names set on booster.&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                max_plot_features <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Weight</span>
</span></span><span style="display:flex;"><span>                fig_imp_w, ax_imp_w <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(figsize<span style="color:#f92672">=</span>get_dynamic_figsize(num_features, max_plot_features))
</span></span><span style="display:flex;"><span>                plot_importance(booster, ax<span style="color:#f92672">=</span>ax_imp_w, max_num_features<span style="color:#f92672">=</span>max_plot_features, importance_type<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;weight&#39;</span>, show_values<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, title<span style="color:#f92672">=</span><span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Importance (Weight) - </span><span style="color:#e6db74">{</span>final_run_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>                plt<span style="color:#f92672">.</span>tight_layout()
</span></span><span style="display:flex;"><span>                mlflow<span style="color:#f92672">.</span>log_figure(fig_imp_w, <span style="color:#e6db74">&#34;plots/feature_importance_weight.png&#34;</span>)
</span></span><span style="display:flex;"><span>                plt<span style="color:#f92672">.</span>close(fig_imp_w)
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">&#34;Logged feature_importance_weight.png&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Gain</span>
</span></span><span style="display:flex;"><span>                fig_imp_g, ax_imp_g <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(figsize<span style="color:#f92672">=</span>get_dynamic_figsize(num_features, max_plot_features))
</span></span><span style="display:flex;"><span>                plot_importance(booster, ax<span style="color:#f92672">=</span>ax_imp_g, max_num_features<span style="color:#f92672">=</span>max_plot_features, importance_type<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;gain&#39;</span>, show_values<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, title<span style="color:#f92672">=</span><span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Importance (Gain) - </span><span style="color:#e6db74">{</span>final_run_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>                plt<span style="color:#f92672">.</span>tight_layout()
</span></span><span style="display:flex;"><span>                mlflow<span style="color:#f92672">.</span>log_figure(fig_imp_g, <span style="color:#e6db74">&#34;plots/feature_importance_gain.png&#34;</span>)
</span></span><span style="display:flex;"><span>                plt<span style="color:#f92672">.</span>close(fig_imp_g)
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">&#34;Logged feature_importance_gain.png&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Cover</span>
</span></span><span style="display:flex;"><span>                fig_imp_c, ax_imp_c <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(figsize<span style="color:#f92672">=</span>get_dynamic_figsize(num_features, max_plot_features))
</span></span><span style="display:flex;"><span>                plot_importance(booster, ax<span style="color:#f92672">=</span>ax_imp_c, max_num_features<span style="color:#f92672">=</span>max_plot_features, importance_type<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;cover&#39;</span>, show_values<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, title<span style="color:#f92672">=</span><span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Importance (Cover) - </span><span style="color:#e6db74">{</span>final_run_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>                plt<span style="color:#f92672">.</span>tight_layout()
</span></span><span style="display:flex;"><span>                mlflow<span style="color:#f92672">.</span>log_figure(fig_imp_c, <span style="color:#e6db74">&#34;plots/feature_importance_cover.png&#34;</span>)
</span></span><span style="display:flex;"><span>                plt<span style="color:#f92672">.</span>close(fig_imp_c)
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">&#34;Logged feature_importance_cover.png&#34;</span>)
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> isinstance(e, xgb<span style="color:#f92672">.</span>core<span style="color:#f92672">.</span>XGBoostError) <span style="color:#f92672">and</span> <span style="color:#e6db74">&#39;feature_names&#39;</span> <span style="color:#f92672">in</span> str(e):
</span></span><span style="display:flex;"><span>                 print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Error plotting importance (likely missing feature names internally): </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                 print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Warning: Could not plot importance plots: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">{</span>traceback<span style="color:#f92672">.</span>format_exc()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;--- Step 5 Complete ---&#34;</span>)
</span></span></code></pre></div>
</details>

<h3 id="step-6---deploy-to-kserve">Step 6 - Deploy to KServe</h3>
<p>Deploys the final model using KServe with configuration compatible with XGBoost serving. Uses the same storage path and service account setup detailed earlier.</p>



<details>
    <summary>Component 6 - python code</summary>
   <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Component 6: Deploy to KServe</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@dsl.component</span>(
</span></span><span style="display:flex;"><span>    base_image<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;python:3.10&#39;</span>,
</span></span><span style="display:flex;"><span>    packages_to_install<span style="color:#f92672">=</span>[
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;kfp==2.12.1&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;kubernetes==29.0.0&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;PyYAML==6.0.1&#39;</span>
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">deploy_to_kserve</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Inputs</span>
</span></span><span style="display:flex;"><span>    model_name: str,
</span></span><span style="display:flex;"><span>    model_uri: Input[Model],
</span></span><span style="display:flex;"><span>    serving_namespace: str,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Outputs</span>
</span></span><span style="display:flex;"><span>    endpoint_url_output: OutputPath(str),
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Optional Args</span>
</span></span><span style="display:flex;"><span>    model_format: str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;xgboost&#39;</span>,
</span></span><span style="display:flex;"><span>    kserve_api_group: str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;serving.kserve.io&#39;</span>,
</span></span><span style="display:flex;"><span>    kserve_api_version: str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;v1beta1&#39;</span>,
</span></span><span style="display:flex;"><span>    service_account_name: str <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>    min_replicas: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    max_replicas: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    cpu_request: str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;100m&#34;</span>,
</span></span><span style="display:flex;"><span>    cpu_limit: str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;1&#34;</span>,
</span></span><span style="display:flex;"><span>    memory_request: str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;256Mi&#34;</span>,
</span></span><span style="display:flex;"><span>    memory_limit: str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;2Gi&#34;</span>,
</span></span><span style="display:flex;"><span>):
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">from</span> kubernetes <span style="color:#f92672">import</span> client, config
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">from</span> kubernetes.client.rest <span style="color:#f92672">import</span> ApiException
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> yaml
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">from</span> urllib.parse <span style="color:#f92672">import</span> urlparse, urlunparse
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;--- Step 6: Deploy Model to KServe ---&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;InferenceService Name: </span><span style="color:#e6db74">{</span>model_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Deployment Namespace: </span><span style="color:#e6db74">{</span>serving_namespace<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Input Model Artifact URI (directory): </span><span style="color:#e6db74">{</span>model_uri<span style="color:#f92672">.</span>uri<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Input Model metadata: </span><span style="color:#e6db74">{</span>json<span style="color:#f92672">.</span>dumps(model_uri<span style="color:#f92672">.</span>metadata, indent<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    expected_metadata_format <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bst&#34;</span>
</span></span><span style="display:flex;"><span>    actual_metadata_format <span style="color:#f92672">=</span> model_uri<span style="color:#f92672">.</span>metadata<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;format&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> actual_metadata_format:
</span></span><span style="display:flex;"><span>         print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Warning: Model metadata does not contain &#39;format&#39; key.&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> actual_metadata_format <span style="color:#f92672">!=</span> expected_metadata_format:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Warning: Model metadata format (&#39;</span><span style="color:#e6db74">{</span>actual_metadata_format<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;) does not match expected format (&#39;</span><span style="color:#e6db74">{</span>expected_metadata_format<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;).&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Model format verified from metadata: &#39;</span><span style="color:#e6db74">{</span>actual_metadata_format<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;&#34;</span>)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Adjust storageUri scheme AND append filename</span>
</span></span><span style="display:flex;"><span>    storage_uri <span style="color:#f92672">=</span> model_uri<span style="color:#f92672">.</span>uri
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Ensure the scheme is s3:// for MinIO/S3 compatibility</span>
</span></span><span style="display:flex;"><span>    parsed_uri <span style="color:#f92672">=</span> urlparse(storage_uri)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> parsed_uri<span style="color:#f92672">.</span>scheme <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;minio&#39;</span>:
</span></span><span style="display:flex;"><span>        storage_uri <span style="color:#f92672">=</span> urlunparse(parsed_uri<span style="color:#f92672">.</span>_replace(scheme<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;s3&#39;</span>))
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Converted storage URI scheme to s3://: </span><span style="color:#e6db74">{</span>storage_uri<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> parsed_uri<span style="color:#f92672">.</span>scheme <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;s3&#39;</span>:
</span></span><span style="display:flex;"><span>         print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Warning: Unexpected storage URI scheme &#39;</span><span style="color:#e6db74">{</span>parsed_uri<span style="color:#f92672">.</span>scheme<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;. KServe might require &#39;s3://&#39;.&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Using final storageUri (directory): </span><span style="color:#e6db74">{</span>storage_uri<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Construct InferenceService Object</span>
</span></span><span style="display:flex;"><span>    isvc_manifest <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;apiVersion&#34;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>kserve_api_group<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>kserve_api_version<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;kind&#34;</span>: <span style="color:#e6db74">&#34;InferenceService&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;metadata&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;name&#34;</span>: model_name,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;namespace&#34;</span>: serving_namespace,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;annotations&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;autoscaling.knative.dev/minScale&#34;</span>: str(min_replicas),
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;autoscaling.knative.dev/maxScale&#34;</span>: str(max_replicas)
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;spec&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;predictor&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;model&#34;</span>: {
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;modelFormat&#34;</span>: {
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;name&#34;</span>: model_format
</span></span><span style="display:flex;"><span>                    },
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;runtime&#34;</span>: <span style="color:#e6db74">&#34;kserve-xgbserver&#34;</span>, <span style="color:#75715e"># Use the standard XGBoost runtime</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;protocolVersion&#34;</span>: <span style="color:#e6db74">&#34;v2&#34;</span>,                    
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;storageUri&#34;</span>: storage_uri,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;resources&#34;</span>: {
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;requests&#34;</span>: {
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;cpu&#34;</span>: cpu_request,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;memory&#34;</span>: memory_request
</span></span><span style="display:flex;"><span>                        },
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;limits&#34;</span>: {
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;cpu&#34;</span>: cpu_limit,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;memory&#34;</span>: memory_limit
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Add service account if specified</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> service_account_name:
</span></span><span style="display:flex;"><span>        isvc_manifest[<span style="color:#e6db74">&#34;spec&#34;</span>][<span style="color:#e6db74">&#34;predictor&#34;</span>][<span style="color:#e6db74">&#34;serviceAccountName&#34;</span>] <span style="color:#f92672">=</span> service_account_name        
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Constructed InferenceService Manifest:&#34;</span>)
</span></span><span style="display:flex;"><span>    print(yaml<span style="color:#f92672">.</span>dump(isvc_manifest, indent<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Authenticate Kubernetes Client</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        config<span style="color:#f92672">.</span>load_incluster_config()
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Loaded in-cluster Kubernetes config.&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> config<span style="color:#f92672">.</span>ConfigException:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            config<span style="color:#f92672">.</span>load_kube_config()
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;Loaded local Kubernetes config.&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> config<span style="color:#f92672">.</span>ConfigException <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>             print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Error: Could not load any Kubernetes config: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>             <span style="color:#66d9ef">raise</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>    api_client <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span>ApiClient()
</span></span><span style="display:flex;"><span>    custom_api <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span>CustomObjectsApi(api_client)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Create or Update InferenceService</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Checking if InferenceService &#39;</span><span style="color:#e6db74">{</span>model_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39; exists in namespace &#39;</span><span style="color:#e6db74">{</span>serving_namespace<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;...&#34;</span>)
</span></span><span style="display:flex;"><span>        existing_isvc <span style="color:#f92672">=</span> custom_api<span style="color:#f92672">.</span>get_namespaced_custom_object(
</span></span><span style="display:flex;"><span>            group<span style="color:#f92672">=</span>kserve_api_group,
</span></span><span style="display:flex;"><span>            version<span style="color:#f92672">=</span>kserve_api_version,
</span></span><span style="display:flex;"><span>            namespace<span style="color:#f92672">=</span>serving_namespace,
</span></span><span style="display:flex;"><span>            plural<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;inferenceservices&#34;</span>,
</span></span><span style="display:flex;"><span>            name<span style="color:#f92672">=</span>model_name
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;InferenceService exists. Patching...&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Update only the relevant parts if needed, or replace the whole spec</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># For simplicity, patching the whole body ensures config drift is fixed</span>
</span></span><span style="display:flex;"><span>        resp <span style="color:#f92672">=</span> custom_api<span style="color:#f92672">.</span>patch_namespaced_custom_object(
</span></span><span style="display:flex;"><span>            group<span style="color:#f92672">=</span>kserve_api_group,
</span></span><span style="display:flex;"><span>            version<span style="color:#f92672">=</span>kserve_api_version,
</span></span><span style="display:flex;"><span>            namespace<span style="color:#f92672">=</span>serving_namespace,
</span></span><span style="display:flex;"><span>            plural<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;inferenceservices&#34;</span>,
</span></span><span style="display:flex;"><span>            name<span style="color:#f92672">=</span>model_name,
</span></span><span style="display:flex;"><span>            body<span style="color:#f92672">=</span>isvc_manifest <span style="color:#75715e"># Apply the desired state</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Patch successful.&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> ApiException <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> e<span style="color:#f92672">.</span>status <span style="color:#f92672">==</span> <span style="color:#ae81ff">404</span>:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;Creating new InferenceService...&#34;</span>)
</span></span><span style="display:flex;"><span>            resp <span style="color:#f92672">=</span> custom_api<span style="color:#f92672">.</span>create_namespaced_custom_object(
</span></span><span style="display:flex;"><span>                group<span style="color:#f92672">=</span>kserve_api_group,
</span></span><span style="display:flex;"><span>                version<span style="color:#f92672">=</span>kserve_api_version,
</span></span><span style="display:flex;"><span>                namespace<span style="color:#f92672">=</span>serving_namespace,
</span></span><span style="display:flex;"><span>                plural<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;inferenceservices&#34;</span>,
</span></span><span style="display:flex;"><span>                body<span style="color:#f92672">=</span>isvc_manifest
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;Create successful.&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Log the error details properly</span>
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Error interacting with Kubernetes API: Status=</span><span style="color:#e6db74">{</span>e<span style="color:#f92672">.</span>status<span style="color:#e6db74">}</span><span style="color:#e6db74">, Reason=</span><span style="color:#e6db74">{</span>e<span style="color:#f92672">.</span>reason<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Body: </span><span style="color:#e6db74">{</span>e<span style="color:#f92672">.</span>body<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Wait for InferenceService to be Ready</span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Waiting for InferenceService to become Ready...&#34;</span>)
</span></span><span style="display:flex;"><span>    timeout_seconds <span style="color:#f92672">=</span> <span style="color:#ae81ff">300</span>
</span></span><span style="display:flex;"><span>    start_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>    isvc_url <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    last_message <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start_time <span style="color:#f92672">&lt;</span> timeout_seconds:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            isvc <span style="color:#f92672">=</span> custom_api<span style="color:#f92672">.</span>get_namespaced_custom_object(
</span></span><span style="display:flex;"><span>                group<span style="color:#f92672">=</span>kserve_api_group,
</span></span><span style="display:flex;"><span>                version<span style="color:#f92672">=</span>kserve_api_version,
</span></span><span style="display:flex;"><span>                namespace<span style="color:#f92672">=</span>serving_namespace,
</span></span><span style="display:flex;"><span>                plural<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;inferenceservices&#34;</span>,
</span></span><span style="display:flex;"><span>                name<span style="color:#f92672">=</span>model_name
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            status <span style="color:#f92672">=</span> isvc<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;status&#34;</span>, {})
</span></span><span style="display:flex;"><span>            url <span style="color:#f92672">=</span> status<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;url&#34;</span>)
</span></span><span style="display:flex;"><span>            conditions <span style="color:#f92672">=</span> status<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;conditions&#34;</span>, [])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            ready_condition <span style="color:#f92672">=</span> next(
</span></span><span style="display:flex;"><span>                (c <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> conditions <span style="color:#66d9ef">if</span> c<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;type&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Ready&#34;</span>),
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            current_message <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;No Ready condition found&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ready_condition:
</span></span><span style="display:flex;"><span>                current_message <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Ready=</span><span style="color:#e6db74">{</span>ready_condition<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;status&#39;</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">, Reason=</span><span style="color:#e6db74">{</span>ready_condition<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;reason&#39;</span>, <span style="color:#e6db74">&#39;N/A&#39;</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">, Msg=</span><span style="color:#e6db74">{</span>ready_condition<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;message&#39;</span>, <span style="color:#e6db74">&#39;N/A&#39;</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> ready_condition<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;status&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;True&#34;</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> url:
</span></span><span style="display:flex;"><span>                        isvc_url <span style="color:#f92672">=</span> url
</span></span><span style="display:flex;"><span>                        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">InferenceService is Ready at: </span><span style="color:#e6db74">{</span>isvc_url<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                        current_message <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34; (URL not available yet)&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Only print status if it changes</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> current_message <span style="color:#f92672">!=</span> last_message:
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Current status: </span><span style="color:#e6db74">{</span>current_message<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>                last_message <span style="color:#f92672">=</span> current_message
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> ApiException <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            error_message <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Status check error: </span><span style="color:#e6db74">{</span>e<span style="color:#f92672">.</span>status<span style="color:#e6db74">}</span><span style="color:#e6db74"> - </span><span style="color:#e6db74">{</span>e<span style="color:#f92672">.</span>reason<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> error_message <span style="color:#f92672">!=</span> last_message:
</span></span><span style="display:flex;"><span>                print(error_message)
</span></span><span style="display:flex;"><span>                last_message <span style="color:#f92672">=</span> error_message
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Catch other potential errors during status check</span>
</span></span><span style="display:flex;"><span>            error_message <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Unexpected error during status check: </span><span style="color:#e6db74">{</span>str(e)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> error_message <span style="color:#f92672">!=</span> last_message:
</span></span><span style="display:flex;"><span>                 print(error_message)
</span></span><span style="display:flex;"><span>                 last_message <span style="color:#f92672">=</span> error_message
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">15</span>) <span style="color:#75715e"># Increase sleep interval slightly</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> isvc_url:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Warning: Timeout after </span><span style="color:#e6db74">{</span>timeout_seconds<span style="color:#e6db74">}</span><span style="color:#e6db74"> seconds waiting for InferenceService &#39;</span><span style="color:#e6db74">{</span>model_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39; to become ready.&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Try to get last known status for debugging</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>             isvc <span style="color:#f92672">=</span> custom_api<span style="color:#f92672">.</span>get_namespaced_custom_object(group<span style="color:#f92672">=</span>kserve_api_group, version<span style="color:#f92672">=</span>kserve_api_version, namespace<span style="color:#f92672">=</span>serving_namespace, plural<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;inferenceservices&#34;</span>, name<span style="color:#f92672">=</span>model_name)
</span></span><span style="display:flex;"><span>             print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Final status check: </span><span style="color:#e6db74">{</span>json<span style="color:#f92672">.</span>dumps(isvc<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;status&#39;</span>), indent<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> final_e:
</span></span><span style="display:flex;"><span>             print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Could not get final status: </span><span style="color:#e6db74">{</span>final_e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        isvc_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ERROR: Deployment timeout or failure&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Save Endpoint URL Output</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> open(endpoint_url_output, <span style="color:#e6db74">&#39;w&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>        f<span style="color:#f92672">.</span>write(isvc_url)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;--- Step 6 Complete ---&#34;</span>)
</span></span></code></pre></div>
</details>

<h3 id="step-7---pipeline-definition">Step 7 - Pipeline Definition</h3>
<p>Defines task ordering and parameter passing. <strong>Note:</strong> I noticed set_display_name() sometimes causes unexpected errors and have commented it out.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># load_task.set_display_name(&#34;Load &amp; Prep Data&#34;)</span>
</span></span></code></pre></div>


<details>
    <summary>Component 7 - python code</summary>
   <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Pipeline Definition</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@dsl.pipeline</span>(
</span></span><span style="display:flex;"><span>    name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;HDB XGBoost Retraining Pipeline (Multi-Step BST)&#39;</span>,
</span></span><span style="display:flex;"><span>    description<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Retrains XGBoost model (BST format) and deploys to KServe.&#39;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hdb_xgboost_multistep_pipeline</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Pipeline Parameters</span>
</span></span><span style="display:flex;"><span>    fixed_processed_data_s3_uri: str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;s3://mlpipeline/hdb-resale-data/resale-data-etl-final.parquet&#39;</span>,
</span></span><span style="display:flex;"><span>    target_column: str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;resale_price&#39;</span>,
</span></span><span style="display:flex;"><span>    mlflow_tracking_uri: str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;http://mlflow-tracking.mlflow&#39;</span>,
</span></span><span style="display:flex;"><span>    mlflow_experiment_name: str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;XGBoostMultistepBST&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Features/HPs</span>
</span></span><span style="display:flex;"><span>    best_features_json: str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;[]&#39;</span>,
</span></span><span style="display:flex;"><span>    best_use_scaling: bool <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>    best_n_estimators: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">500</span>,
</span></span><span style="display:flex;"><span>    best_learning_rate: float <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.04</span>,
</span></span><span style="display:flex;"><span>    best_max_depth: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>,
</span></span><span style="display:flex;"><span>    best_early_stopping_rounds: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>,
</span></span><span style="display:flex;"><span>    best_colsample_bytree: float <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.7</span>,
</span></span><span style="display:flex;"><span>    best_min_child_weight: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>,
</span></span><span style="display:flex;"><span>    best_subsample: float <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.8</span>,
</span></span><span style="display:flex;"><span>    best_random_state: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">42</span>,  
</span></span><span style="display:flex;"><span>    base_run_name: str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;XGBoostMultiStepBST&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># KServe Deployment Params</span>
</span></span><span style="display:flex;"><span>    kserve_model_name: str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;hdb-resale-xgb&#39;</span>,
</span></span><span style="display:flex;"><span>    kserve_namespace: str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;kubeflow-user-example-com&#39;</span>,
</span></span><span style="display:flex;"><span>    kserve_model_format: str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;xgboost&#39;</span>,
</span></span><span style="display:flex;"><span>    kserve_predictor_service_account: str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;sa&#39;</span>
</span></span><span style="display:flex;"><span>):   
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Define Helper Function for Adding Env Vars</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_env_vars</span>(task):
</span></span><span style="display:flex;"><span>        task<span style="color:#f92672">.</span>set_env_variable(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;MLFLOW_TRACKING_USERNAME&#34;</span>, value<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;user&#34;</span>)
</span></span><span style="display:flex;"><span>        task<span style="color:#f92672">.</span>set_env_variable(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;MLFLOW_TRACKING_PASSWORD&#34;</span>, value<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;qYlTnUDQMe&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Pipeline Steps</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Step 1: Load Data</span>
</span></span><span style="display:flex;"><span>    load_task <span style="color:#f92672">=</span> load_and_prep_data(
</span></span><span style="display:flex;"><span>        s3_data_uri<span style="color:#f92672">=</span>fixed_processed_data_s3_uri,
</span></span><span style="display:flex;"><span>        target_column<span style="color:#f92672">=</span>target_column,
</span></span><span style="display:flex;"><span>        features_json<span style="color:#f92672">=</span>best_features_json
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    load_task<span style="color:#f92672">.</span>set_caching_options(enable_caching<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Step 2: Split &amp; Scale</span>
</span></span><span style="display:flex;"><span>    scale_task <span style="color:#f92672">=</span> split_and_scale_data(
</span></span><span style="display:flex;"><span>        x_data_path<span style="color:#f92672">=</span>load_task<span style="color:#f92672">.</span>outputs[<span style="color:#e6db74">&#39;x_data_path&#39;</span>],
</span></span><span style="display:flex;"><span>        y_data_path<span style="color:#f92672">=</span>load_task<span style="color:#f92672">.</span>outputs[<span style="color:#e6db74">&#39;y_data_path&#39;</span>],
</span></span><span style="display:flex;"><span>        feature_names_json<span style="color:#f92672">=</span>load_task<span style="color:#f92672">.</span>outputs[<span style="color:#e6db74">&#39;feature_names_json_out&#39;</span>],
</span></span><span style="display:flex;"><span>        use_scaling<span style="color:#f92672">=</span>best_use_scaling
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    scale_task<span style="color:#f92672">.</span>set_caching_options(enable_caching<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Step 3: Train Model</span>
</span></span><span style="display:flex;"><span>    train_task <span style="color:#f92672">=</span> train_model(
</span></span><span style="display:flex;"><span>        x_train_path<span style="color:#f92672">=</span>scale_task<span style="color:#f92672">.</span>outputs[<span style="color:#e6db74">&#39;x_train_path&#39;</span>],
</span></span><span style="display:flex;"><span>        x_test_path<span style="color:#f92672">=</span>scale_task<span style="color:#f92672">.</span>outputs[<span style="color:#e6db74">&#39;x_test_path&#39;</span>],
</span></span><span style="display:flex;"><span>        y_train_path<span style="color:#f92672">=</span>scale_task<span style="color:#f92672">.</span>outputs[<span style="color:#e6db74">&#39;y_train_path&#39;</span>],
</span></span><span style="display:flex;"><span>        y_test_path<span style="color:#f92672">=</span>scale_task<span style="color:#f92672">.</span>outputs[<span style="color:#e6db74">&#39;y_test_path&#39;</span>],
</span></span><span style="display:flex;"><span>        scaler_path<span style="color:#f92672">=</span>scale_task<span style="color:#f92672">.</span>outputs[<span style="color:#e6db74">&#39;scaler_path&#39;</span>],
</span></span><span style="display:flex;"><span>        use_scaling<span style="color:#f92672">=</span>best_use_scaling,
</span></span><span style="display:flex;"><span>        feature_names_json<span style="color:#f92672">=</span>load_task<span style="color:#f92672">.</span>outputs[<span style="color:#e6db74">&#39;feature_names_json_out&#39;</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># HPs</span>
</span></span><span style="display:flex;"><span>        n_estimators<span style="color:#f92672">=</span>best_n_estimators,
</span></span><span style="display:flex;"><span>        learning_rate<span style="color:#f92672">=</span>best_learning_rate,
</span></span><span style="display:flex;"><span>        max_depth<span style="color:#f92672">=</span>best_max_depth,
</span></span><span style="display:flex;"><span>        early_stopping_rounds<span style="color:#f92672">=</span>best_early_stopping_rounds,
</span></span><span style="display:flex;"><span>        colsample_bytree<span style="color:#f92672">=</span>best_colsample_bytree,
</span></span><span style="display:flex;"><span>        min_child_weight<span style="color:#f92672">=</span>best_min_child_weight,
</span></span><span style="display:flex;"><span>        subsample<span style="color:#f92672">=</span>best_subsample,
</span></span><span style="display:flex;"><span>        random_state<span style="color:#f92672">=</span>best_random_state,    
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># MLflow</span>
</span></span><span style="display:flex;"><span>        run_name<span style="color:#f92672">=</span>base_run_name,
</span></span><span style="display:flex;"><span>        mlflow_tracking_uri<span style="color:#f92672">=</span>mlflow_tracking_uri,
</span></span><span style="display:flex;"><span>        mlflow_experiment_name<span style="color:#f92672">=</span>mlflow_experiment_name
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    train_task<span style="color:#f92672">.</span>set_caching_options(enable_caching<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    add_env_vars(train_task)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Step 4: Predict &amp; Evaluate</span>
</span></span><span style="display:flex;"><span>    eval_task <span style="color:#f92672">=</span> predict_and_evaluate(
</span></span><span style="display:flex;"><span>        input_model<span style="color:#f92672">=</span>train_task<span style="color:#f92672">.</span>outputs[<span style="color:#e6db74">&#39;output_model&#39;</span>],
</span></span><span style="display:flex;"><span>        x_test_path<span style="color:#f92672">=</span>scale_task<span style="color:#f92672">.</span>outputs[<span style="color:#e6db74">&#39;x_test_path&#39;</span>],
</span></span><span style="display:flex;"><span>        y_test_path<span style="color:#f92672">=</span>scale_task<span style="color:#f92672">.</span>outputs[<span style="color:#e6db74">&#39;y_test_path&#39;</span>],
</span></span><span style="display:flex;"><span>        mlflow_run_id<span style="color:#f92672">=</span>train_task<span style="color:#f92672">.</span>outputs[<span style="color:#e6db74">&#39;mlflow_run_id_out&#39;</span>],
</span></span><span style="display:flex;"><span>        mlflow_tracking_uri<span style="color:#f92672">=</span>mlflow_tracking_uri,
</span></span><span style="display:flex;"><span>        feature_names_json<span style="color:#f92672">=</span>load_task<span style="color:#f92672">.</span>outputs[<span style="color:#e6db74">&#39;feature_names_json_out&#39;</span>]
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    eval_task<span style="color:#f92672">.</span>set_caching_options(enable_caching<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    add_env_vars(eval_task)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Step 5: Generate &amp; Log Plots</span>
</span></span><span style="display:flex;"><span>    plot_task <span style="color:#f92672">=</span> generate_and_log_plots(
</span></span><span style="display:flex;"><span>        input_model<span style="color:#f92672">=</span>train_task<span style="color:#f92672">.</span>outputs[<span style="color:#e6db74">&#39;output_model&#39;</span>],
</span></span><span style="display:flex;"><span>        y_test_path<span style="color:#f92672">=</span>scale_task<span style="color:#f92672">.</span>outputs[<span style="color:#e6db74">&#39;y_test_path&#39;</span>],
</span></span><span style="display:flex;"><span>        y_pred_path<span style="color:#f92672">=</span>eval_task<span style="color:#f92672">.</span>outputs[<span style="color:#e6db74">&#39;y_pred_path&#39;</span>],
</span></span><span style="display:flex;"><span>        feature_names_json<span style="color:#f92672">=</span>load_task<span style="color:#f92672">.</span>outputs[<span style="color:#e6db74">&#39;feature_names_json_out&#39;</span>],
</span></span><span style="display:flex;"><span>        mlflow_run_id<span style="color:#f92672">=</span>train_task<span style="color:#f92672">.</span>outputs[<span style="color:#e6db74">&#39;mlflow_run_id_out&#39;</span>],
</span></span><span style="display:flex;"><span>        mlflow_tracking_uri<span style="color:#f92672">=</span>mlflow_tracking_uri,
</span></span><span style="display:flex;"><span>        run_name<span style="color:#f92672">=</span>base_run_name
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    plot_task<span style="color:#f92672">.</span>set_caching_options(enable_caching<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    add_env_vars(plot_task)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Step 6: Deploy Model</span>
</span></span><span style="display:flex;"><span>    deploy_task <span style="color:#f92672">=</span> deploy_to_kserve(
</span></span><span style="display:flex;"><span>        model_name<span style="color:#f92672">=</span>kserve_model_name,
</span></span><span style="display:flex;"><span>        model_uri<span style="color:#f92672">=</span>train_task<span style="color:#f92672">.</span>outputs[<span style="color:#e6db74">&#39;output_model&#39;</span>],
</span></span><span style="display:flex;"><span>        serving_namespace<span style="color:#f92672">=</span>kserve_namespace,
</span></span><span style="display:flex;"><span>        model_format<span style="color:#f92672">=</span>kserve_model_format,
</span></span><span style="display:flex;"><span>        service_account_name<span style="color:#f92672">=</span>kserve_predictor_service_account
</span></span><span style="display:flex;"><span>    )<span style="color:#f92672">.</span>after(train_task)
</span></span><span style="display:flex;"><span>    deploy_task<span style="color:#f92672">.</span>set_caching_options(enable_caching<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span></code></pre></div>
</details>

<h3 id="step-8---compilation">Step 8 - Compilation</h3>
<p>Compiles and uploads the pipeline as a <code>.yaml</code> file to Kubeflow Pipelines for execution.</p>



<details>
    <summary>Component 8 - python code</summary>
   <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Pipeline Compilation</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Define best feature set found during exploration</span>
</span></span><span style="display:flex;"><span>    BEST_FEATURE_SET <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;floor_area_sqm&#39;</span>, <span style="color:#e6db74">&#39;remaining_lease_years&#39;</span>, <span style="color:#e6db74">&#39;storey_avg&#39;</span>, <span style="color:#e6db74">&#39;sale_year&#39;</span>, <span style="color:#e6db74">&#39;sale_month&#39;</span>, 
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#39;flat_type_1 ROOM&#39;</span>, <span style="color:#e6db74">&#39;flat_type_2 ROOM&#39;</span>, <span style="color:#e6db74">&#39;flat_type_3 ROOM&#39;</span>, <span style="color:#e6db74">&#39;flat_type_4 ROOM&#39;</span>, <span style="color:#e6db74">&#39;flat_type_5 ROOM&#39;</span>, 
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#39;flat_type_EXECUTIVE&#39;</span>, <span style="color:#e6db74">&#39;flat_type_MULTI-GENERATION&#39;</span>, <span style="color:#e6db74">&#39;flat_model_2-room&#39;</span>, <span style="color:#e6db74">&#39;flat_model_3Gen&#39;</span>, <span style="color:#e6db74">&#39;flat_model_Adjoined flat&#39;</span>, 
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#39;flat_model_Apartment&#39;</span>, <span style="color:#e6db74">&#39;flat_model_DBSS&#39;</span>, <span style="color:#e6db74">&#39;flat_model_Improved&#39;</span>, <span style="color:#e6db74">&#39;flat_model_Improved-Maisonette&#39;</span>, <span style="color:#e6db74">&#39;flat_model_Maisonette&#39;</span>, 
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#39;flat_model_Model A&#39;</span>, <span style="color:#e6db74">&#39;flat_model_Model A-Maisonette&#39;</span>, <span style="color:#e6db74">&#39;flat_model_Model A2&#39;</span>, <span style="color:#e6db74">&#39;flat_model_Multi Generation&#39;</span>, <span style="color:#e6db74">&#39;flat_model_New Generation&#39;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#39;flat_model_Premium Apartment&#39;</span>, <span style="color:#e6db74">&#39;flat_model_Premium Apartment Loft&#39;</span>, <span style="color:#e6db74">&#39;flat_model_Premium Maisonette&#39;</span>, <span style="color:#e6db74">&#39;flat_model_Simplified&#39;</span>, <span style="color:#e6db74">&#39;flat_model_Standard&#39;</span>, 
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#39;flat_model_Terrace&#39;</span>, <span style="color:#e6db74">&#39;flat_model_Type S1&#39;</span>, <span style="color:#e6db74">&#39;flat_model_Type S2&#39;</span>, <span style="color:#e6db74">&#39;town_ANG MO KIO&#39;</span>, <span style="color:#e6db74">&#39;town_BEDOK&#39;</span>, 
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#39;town_BISHAN&#39;</span>, <span style="color:#e6db74">&#39;town_BUKIT BATOK&#39;</span>, <span style="color:#e6db74">&#39;town_BUKIT MERAH&#39;</span>, <span style="color:#e6db74">&#39;town_BUKIT PANJANG&#39;</span>, <span style="color:#e6db74">&#39;town_BUKIT TIMAH&#39;</span>, 
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#39;town_CENTRAL AREA&#39;</span>, <span style="color:#e6db74">&#39;town_CHOA CHU KANG&#39;</span>, <span style="color:#e6db74">&#39;town_CLEMENTI&#39;</span>, <span style="color:#e6db74">&#39;town_GEYLANG&#39;</span>, <span style="color:#e6db74">&#39;town_HOUGANG&#39;</span>, 
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#39;town_JURONG EAST&#39;</span>, <span style="color:#e6db74">&#39;town_JURONG WEST&#39;</span>, <span style="color:#e6db74">&#39;town_KALLANG/WHAMPOA&#39;</span>, <span style="color:#e6db74">&#39;town_MARINE PARADE&#39;</span>, <span style="color:#e6db74">&#39;town_PASIR RIS&#39;</span>, 
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#39;town_PUNGGOL&#39;</span>, <span style="color:#e6db74">&#39;town_QUEENSTOWN&#39;</span>, <span style="color:#e6db74">&#39;town_SEMBAWANG&#39;</span>, <span style="color:#e6db74">&#39;town_SENGKANG&#39;</span>, <span style="color:#e6db74">&#39;town_SERANGOON&#39;</span>, 
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#39;town_TAMPINES&#39;</span>, <span style="color:#e6db74">&#39;town_TOA PAYOH&#39;</span>, <span style="color:#e6db74">&#39;town_WOODLANDS&#39;</span>, <span style="color:#e6db74">&#39;town_YISHUN&#39;</span>]
</span></span><span style="display:flex;"><span>    BEST_FEATURE_SET_JSON <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>dumps(BEST_FEATURE_SET)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Define other best parameters if needed for compile-time defaults</span>
</span></span><span style="display:flex;"><span>    BEST_USE_SCALING <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    BEST_N_ESTIMATORS <span style="color:#f92672">=</span> <span style="color:#ae81ff">500</span>
</span></span><span style="display:flex;"><span>    BEST_LEARNING_RATE <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.04</span>
</span></span><span style="display:flex;"><span>    BEST_MAX_DEPTH <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>    BEST_EARLY_STOPPING_ROUNDS <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>    BEST_COLSAMPLE_BYTREE <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.7</span>
</span></span><span style="display:flex;"><span>    BEST_MIN_CHILD_WEIGHT <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Set pipeline parameters for compilation</span>
</span></span><span style="display:flex;"><span>    pipeline_parameters <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>         <span style="color:#e6db74">&#39;best_features_json&#39;</span>: BEST_FEATURE_SET_JSON,
</span></span><span style="display:flex;"><span>         <span style="color:#e6db74">&#39;best_use_scaling&#39;</span>: BEST_USE_SCALING,
</span></span><span style="display:flex;"><span>         <span style="color:#e6db74">&#39;best_n_estimators&#39;</span>: BEST_N_ESTIMATORS,
</span></span><span style="display:flex;"><span>         <span style="color:#e6db74">&#39;best_learning_rate&#39;</span>: BEST_LEARNING_RATE,
</span></span><span style="display:flex;"><span>         <span style="color:#e6db74">&#39;best_max_depth&#39;</span>: BEST_MAX_DEPTH,
</span></span><span style="display:flex;"><span>         <span style="color:#e6db74">&#39;best_early_stopping_rounds&#39;</span>: BEST_EARLY_STOPPING_ROUNDS,
</span></span><span style="display:flex;"><span>         <span style="color:#e6db74">&#39;best_colsample_bytree&#39;</span>: BEST_COLSAMPLE_BYTREE,
</span></span><span style="display:flex;"><span>         <span style="color:#e6db74">&#39;best_min_child_weight&#39;</span>: BEST_MIN_CHILD_WEIGHT,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Compiler()<span style="color:#f92672">.</span>compile(
</span></span><span style="display:flex;"><span>        pipeline_func<span style="color:#f92672">=</span>hdb_xgboost_multistep_pipeline,
</span></span><span style="display:flex;"><span>        package_path<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;hdb_xgboost_multistep_pipeline.yaml&#39;</span>,
</span></span><span style="display:flex;"><span>        pipeline_parameters<span style="color:#f92672">=</span>pipeline_parameters
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Pipeline compiled to hdb_xgboost_multistep_pipeline.yaml&#34;</span>)
</span></span></code></pre></div>
</details>

<p><img src="/images/hdb-app/hdb-xgboost-multistep-pipeline.png" alt="hdb-xgboost-multistep-pipeline"></p>
<hr>
<h2 id="hdb-predictor-app">HDB Predictor App</h2>
<p>Finally, a simple and intuitive Streamlit app lets users interact with the model by entering flat details (e.g., floor area, location, lease year). The app sends the inputs to the KServe endpoint and displays the predicted resale price.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>streamlit run app.py
</span></span></code></pre></div>


<details>
    <summary>app.py - python code</summary>
   <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># app.py</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> streamlit <span style="color:#66d9ef">as</span> st
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> joblib
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --- SET PAGE CONFIG FIRST ---</span>
</span></span><span style="display:flex;"><span>st<span style="color:#f92672">.</span>set_page_config(layout<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;centered&#34;</span>, page_title<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;HDB Price Predictor&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --- Configuration ---</span>
</span></span><span style="display:flex;"><span>KSERVE_URL <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;KSERVE_URL&#34;</span>, <span style="color:#e6db74">&#34;http://hdb-resale-xgb.kubeflow-user-example-com.svc.cluster.local/v2/models/hdb-resale-xgb/infer&#34;</span>)
</span></span><span style="display:flex;"><span>SCALER_PATH <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;scaler.joblib&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Feature names in the EXACT order the model expects</span>
</span></span><span style="display:flex;"><span>FEATURE_NAMES <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;floor_area_sqm&#39;</span>, <span style="color:#e6db74">&#39;remaining_lease_years&#39;</span>, <span style="color:#e6db74">&#39;storey_avg&#39;</span>, <span style="color:#e6db74">&#39;sale_year&#39;</span>, <span style="color:#e6db74">&#39;sale_month&#39;</span>,
</span></span><span style="display:flex;"><span>                 <span style="color:#e6db74">&#39;flat_type_1 ROOM&#39;</span>, <span style="color:#e6db74">&#39;flat_type_2 ROOM&#39;</span>, <span style="color:#e6db74">&#39;flat_type_3 ROOM&#39;</span>, <span style="color:#e6db74">&#39;flat_type_4 ROOM&#39;</span>, <span style="color:#e6db74">&#39;flat_type_5 ROOM&#39;</span>,
</span></span><span style="display:flex;"><span>                 <span style="color:#e6db74">&#39;flat_type_EXECUTIVE&#39;</span>, <span style="color:#e6db74">&#39;flat_type_MULTI-GENERATION&#39;</span>, <span style="color:#e6db74">&#39;flat_model_2-room&#39;</span>, <span style="color:#e6db74">&#39;flat_model_3Gen&#39;</span>, <span style="color:#e6db74">&#39;flat_model_Adjoined flat&#39;</span>,
</span></span><span style="display:flex;"><span>                 <span style="color:#e6db74">&#39;flat_model_Apartment&#39;</span>, <span style="color:#e6db74">&#39;flat_model_DBSS&#39;</span>, <span style="color:#e6db74">&#39;flat_model_Improved&#39;</span>, <span style="color:#e6db74">&#39;flat_model_Improved-Maisonette&#39;</span>, <span style="color:#e6db74">&#39;flat_model_Maisonette&#39;</span>,
</span></span><span style="display:flex;"><span>                 <span style="color:#e6db74">&#39;flat_model_Model A&#39;</span>, <span style="color:#e6db74">&#39;flat_model_Model A-Maisonette&#39;</span>, <span style="color:#e6db74">&#39;flat_model_Model A2&#39;</span>, <span style="color:#e6db74">&#39;flat_model_Multi Generation&#39;</span>, <span style="color:#e6db74">&#39;flat_model_New Generation&#39;</span>,
</span></span><span style="display:flex;"><span>                 <span style="color:#e6db74">&#39;flat_model_Premium Apartment&#39;</span>, <span style="color:#e6db74">&#39;flat_model_Premium Apartment Loft&#39;</span>, <span style="color:#e6db74">&#39;flat_model_Premium Maisonette&#39;</span>, <span style="color:#e6db74">&#39;flat_model_Simplified&#39;</span>, <span style="color:#e6db74">&#39;flat_model_Standard&#39;</span>,
</span></span><span style="display:flex;"><span>                 <span style="color:#e6db74">&#39;flat_model_Terrace&#39;</span>, <span style="color:#e6db74">&#39;flat_model_Type S1&#39;</span>, <span style="color:#e6db74">&#39;flat_model_Type S2&#39;</span>, <span style="color:#e6db74">&#39;town_ANG MO KIO&#39;</span>, <span style="color:#e6db74">&#39;town_BEDOK&#39;</span>,
</span></span><span style="display:flex;"><span>                 <span style="color:#e6db74">&#39;town_BISHAN&#39;</span>, <span style="color:#e6db74">&#39;town_BUKIT BATOK&#39;</span>, <span style="color:#e6db74">&#39;town_BUKIT MERAH&#39;</span>, <span style="color:#e6db74">&#39;town_BUKIT PANJANG&#39;</span>, <span style="color:#e6db74">&#39;town_BUKIT TIMAH&#39;</span>,
</span></span><span style="display:flex;"><span>                 <span style="color:#e6db74">&#39;town_CENTRAL AREA&#39;</span>, <span style="color:#e6db74">&#39;town_CHOA CHU KANG&#39;</span>, <span style="color:#e6db74">&#39;town_CLEMENTI&#39;</span>, <span style="color:#e6db74">&#39;town_GEYLANG&#39;</span>, <span style="color:#e6db74">&#39;town_HOUGANG&#39;</span>,
</span></span><span style="display:flex;"><span>                 <span style="color:#e6db74">&#39;town_JURONG EAST&#39;</span>, <span style="color:#e6db74">&#39;town_JURONG WEST&#39;</span>, <span style="color:#e6db74">&#39;town_KALLANG/WHAMPOA&#39;</span>, <span style="color:#e6db74">&#39;town_MARINE PARADE&#39;</span>, <span style="color:#e6db74">&#39;town_PASIR RIS&#39;</span>,
</span></span><span style="display:flex;"><span>                 <span style="color:#e6db74">&#39;town_PUNGGOL&#39;</span>, <span style="color:#e6db74">&#39;town_QUEENSTOWN&#39;</span>, <span style="color:#e6db74">&#39;town_SEMBAWANG&#39;</span>, <span style="color:#e6db74">&#39;town_SENGKANG&#39;</span>, <span style="color:#e6db74">&#39;town_SERANGOON&#39;</span>,
</span></span><span style="display:flex;"><span>                 <span style="color:#e6db74">&#39;town_TAMPINES&#39;</span>, <span style="color:#e6db74">&#39;town_TOA PAYOH&#39;</span>, <span style="color:#e6db74">&#39;town_WOODLANDS&#39;</span>, <span style="color:#e6db74">&#39;town_YISHUN&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NUM_FEATURES <span style="color:#f92672">=</span> len(FEATURE_NAMES)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --- Extract Categories for Dropdowns ---</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">extract_categories</span>(prefix, feature_list):
</span></span><span style="display:flex;"><span>    categories <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    prefix_len <span style="color:#f92672">=</span> len(prefix)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> feature <span style="color:#f92672">in</span> feature_list:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> feature<span style="color:#f92672">.</span>startswith(prefix):
</span></span><span style="display:flex;"><span>            categories<span style="color:#f92672">.</span>append(feature[prefix_len:])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> sorted(categories)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FLAT_TYPES <span style="color:#f92672">=</span> extract_categories(<span style="color:#e6db74">&#34;flat_type_&#34;</span>, FEATURE_NAMES)
</span></span><span style="display:flex;"><span>FLAT_MODELS <span style="color:#f92672">=</span> extract_categories(<span style="color:#e6db74">&#34;flat_model_&#34;</span>, FEATURE_NAMES)
</span></span><span style="display:flex;"><span>TOWNS <span style="color:#f92672">=</span> extract_categories(<span style="color:#e6db74">&#34;town_&#34;</span>, FEATURE_NAMES)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --- Load Scaler ---</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    scaler <span style="color:#f92672">=</span> joblib<span style="color:#f92672">.</span>load(SCALER_PATH)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Scaler loaded successfully.&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> <span style="color:#a6e22e">FileNotFoundError</span>:
</span></span><span style="display:flex;"><span>    st<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Error: Scaler file not found at </span><span style="color:#e6db74">{</span>SCALER_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">. Cannot proceed.&#34;</span>)
</span></span><span style="display:flex;"><span>    st<span style="color:#f92672">.</span>stop()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>    st<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Error loading scaler: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    st<span style="color:#f92672">.</span>stop()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --- Streamlit UI ---</span>
</span></span><span style="display:flex;"><span>st<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#34;HDB Resale Price Predictor&#34;</span>)
</span></span><span style="display:flex;"><span>st<span style="color:#f92672">.</span>markdown(<span style="color:#e6db74">&#34;Enter the details below to get a price prediction.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --- Input Fields ---</span>
</span></span><span style="display:flex;"><span>col1, col2 <span style="color:#f92672">=</span> st<span style="color:#f92672">.</span>columns(<span style="color:#ae81ff">2</span>) <span style="color:#75715e"># Arrange inputs in columns</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> col1:
</span></span><span style="display:flex;"><span>    st<span style="color:#f92672">.</span>header(<span style="color:#e6db74">&#34;Key Features&#34;</span>)
</span></span><span style="display:flex;"><span>    floor_area <span style="color:#f92672">=</span> st<span style="color:#f92672">.</span>number_input(<span style="color:#e6db74">&#34;Floor Area (sqm)&#34;</span>, min_value<span style="color:#f92672">=</span><span style="color:#ae81ff">20.0</span>, max_value<span style="color:#f92672">=</span><span style="color:#ae81ff">300.0</span>, value<span style="color:#f92672">=</span><span style="color:#ae81ff">90.0</span>, step<span style="color:#f92672">=</span><span style="color:#ae81ff">1.0</span>)
</span></span><span style="display:flex;"><span>    lease_years <span style="color:#f92672">=</span> st<span style="color:#f92672">.</span>number_input(<span style="color:#e6db74">&#34;Remaining Lease (Years)&#34;</span>, min_value<span style="color:#f92672">=</span><span style="color:#ae81ff">10.0</span>, max_value<span style="color:#f92672">=</span><span style="color:#ae81ff">99.0</span>, value<span style="color:#f92672">=</span><span style="color:#ae81ff">70.0</span>, step<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>    storey <span style="color:#f92672">=</span> st<span style="color:#f92672">.</span>number_input(<span style="color:#e6db74">&#34;Storey (Average)&#34;</span>, min_value<span style="color:#f92672">=</span><span style="color:#ae81ff">1.0</span>, max_value<span style="color:#f92672">=</span><span style="color:#ae81ff">50.0</span>, value<span style="color:#f92672">=</span><span style="color:#ae81ff">10.0</span>, step<span style="color:#f92672">=</span><span style="color:#ae81ff">1.0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> col2:
</span></span><span style="display:flex;"><span>    st<span style="color:#f92672">.</span>header(<span style="color:#e6db74">&#34;Location &amp; Type&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Set default indices based on common values or simple index 0</span>
</span></span><span style="display:flex;"><span>    default_town_index <span style="color:#f92672">=</span> TOWNS<span style="color:#f92672">.</span>index(<span style="color:#e6db74">&#34;TAMPINES&#34;</span>) <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;TAMPINES&#34;</span> <span style="color:#f92672">in</span> TOWNS <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    default_flat_type_index <span style="color:#f92672">=</span> FLAT_TYPES<span style="color:#f92672">.</span>index(<span style="color:#e6db74">&#34;4 ROOM&#34;</span>) <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;4 ROOM&#34;</span> <span style="color:#f92672">in</span> FLAT_TYPES <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    default_flat_model_index <span style="color:#f92672">=</span> FLAT_MODELS<span style="color:#f92672">.</span>index(<span style="color:#e6db74">&#34;Improved&#34;</span>) <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;Improved&#34;</span> <span style="color:#f92672">in</span> FLAT_MODELS <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    selected_town <span style="color:#f92672">=</span> st<span style="color:#f92672">.</span>selectbox(<span style="color:#e6db74">&#34;Town&#34;</span>, TOWNS, index<span style="color:#f92672">=</span>default_town_index)
</span></span><span style="display:flex;"><span>    selected_flat_type <span style="color:#f92672">=</span> st<span style="color:#f92672">.</span>selectbox(<span style="color:#e6db74">&#34;Flat Type&#34;</span>, FLAT_TYPES, index<span style="color:#f92672">=</span>default_flat_type_index)
</span></span><span style="display:flex;"><span>    selected_flat_model <span style="color:#f92672">=</span> st<span style="color:#f92672">.</span>selectbox(<span style="color:#e6db74">&#34;Flat Model&#34;</span>, FLAT_MODELS, index<span style="color:#f92672">=</span>default_flat_model_index)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --- Prediction Button ---</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> st<span style="color:#f92672">.</span>button(<span style="color:#e6db74">&#34;Predict Resale Price&#34;</span>, type<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;primary&#34;</span>):
</span></span><span style="display:flex;"><span>    st<span style="color:#f92672">.</span>markdown(<span style="color:#e6db74">&#34;---&#34;</span>)
</span></span><span style="display:flex;"><span>    st<span style="color:#f92672">.</span>subheader(<span style="color:#e6db74">&#34;Processing...&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># --- Prepare Input Data ---</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Start with all features as 0.0</span>
</span></span><span style="display:flex;"><span>    input_dict <span style="color:#f92672">=</span> {feat: <span style="color:#ae81ff">0.0</span> <span style="color:#66d9ef">for</span> feat <span style="color:#f92672">in</span> FEATURE_NAMES}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Update with numerical user inputs</span>
</span></span><span style="display:flex;"><span>    input_dict[<span style="color:#e6db74">&#39;floor_area_sqm&#39;</span>] <span style="color:#f92672">=</span> float(floor_area)
</span></span><span style="display:flex;"><span>    input_dict[<span style="color:#e6db74">&#39;remaining_lease_years&#39;</span>] <span style="color:#f92672">=</span> float(lease_years)
</span></span><span style="display:flex;"><span>    input_dict[<span style="color:#e6db74">&#39;storey_avg&#39;</span>] <span style="color:#f92672">=</span> float(storey)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Update with default sale year/month</span>
</span></span><span style="display:flex;"><span>    now <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>now()
</span></span><span style="display:flex;"><span>    input_dict[<span style="color:#e6db74">&#39;sale_year&#39;</span>] <span style="color:#f92672">=</span> float(now<span style="color:#f92672">.</span>year)
</span></span><span style="display:flex;"><span>    input_dict[<span style="color:#e6db74">&#39;sale_month&#39;</span>] <span style="color:#f92672">=</span> float(now<span style="color:#f92672">.</span>month)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># *** Update one-hot encoded features based on dropdown selections ***</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Town</span>
</span></span><span style="display:flex;"><span>    town_feature_name <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;town_</span><span style="color:#e6db74">{</span>selected_town<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> town_feature_name <span style="color:#f92672">in</span> input_dict:
</span></span><span style="display:flex;"><span>        input_dict[town_feature_name] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        st<span style="color:#f92672">.</span>warning(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Selected town feature &#39;</span><span style="color:#e6db74">{</span>town_feature_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39; not found in model features. Check FEATURE_NAMES.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Flat Type</span>
</span></span><span style="display:flex;"><span>    flat_type_feature_name <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;flat_type_</span><span style="color:#e6db74">{</span>selected_flat_type<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> flat_type_feature_name <span style="color:#f92672">in</span> input_dict:
</span></span><span style="display:flex;"><span>        input_dict[flat_type_feature_name] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        st<span style="color:#f92672">.</span>warning(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Selected flat type feature &#39;</span><span style="color:#e6db74">{</span>flat_type_feature_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39; not found in model features.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Flat Model</span>
</span></span><span style="display:flex;"><span>    flat_model_feature_name <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;flat_model_</span><span style="color:#e6db74">{</span>selected_flat_model<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> flat_model_feature_name <span style="color:#f92672">in</span> input_dict:
</span></span><span style="display:flex;"><span>        input_dict[flat_model_feature_name] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        st<span style="color:#f92672">.</span>warning(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Selected flat model feature &#39;</span><span style="color:#e6db74">{</span>flat_model_feature_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39; not found in model features.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Convert dictionary to ordered list</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        input_list <span style="color:#f92672">=</span> [input_dict[feature] <span style="color:#66d9ef">for</span> feature <span style="color:#f92672">in</span> FEATURE_NAMES]
</span></span><span style="display:flex;"><span>        input_array <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(input_list)<span style="color:#f92672">.</span>astype(np<span style="color:#f92672">.</span>float32)<span style="color:#f92672">.</span>reshape(<span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#75715e"># Reshape for scaler</span>
</span></span><span style="display:flex;"><span>        st<span style="color:#f92672">.</span>write(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Input shape before scaling: </span><span style="color:#e6db74">{</span>input_array<span style="color:#f92672">.</span>shape<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Optional: Display which one-hot features are set</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># set_features = {k:v for k,v in input_dict.items() if v==1.0 and (&#39;town_&#39; in k or &#39;flat_type_&#39; in k or &#39;flat_model_&#39; in k)}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># st.write(f&#34;One-hot features set: {set_features}&#34;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># --- Scale the Input Data ---</span>
</span></span><span style="display:flex;"><span>        input_scaled <span style="color:#f92672">=</span> scaler<span style="color:#f92672">.</span>transform(input_array)
</span></span><span style="display:flex;"><span>        st<span style="color:#f92672">.</span>write(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Input shape after scaling: </span><span style="color:#e6db74">{</span>input_scaled<span style="color:#f92672">.</span>shape<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        payload_data <span style="color:#f92672">=</span> input_scaled<span style="color:#f92672">.</span>flatten()<span style="color:#f92672">.</span>tolist()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># --- Construct KServe Payload ---</span>
</span></span><span style="display:flex;"><span>        payload <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;inputs&#34;</span>: [{
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;input-0&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;shape&#34;</span>: [<span style="color:#ae81ff">1</span>, NUM_FEATURES],
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;datatype&#34;</span>: <span style="color:#e6db74">&#34;FP32&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;data&#34;</span>: payload_data
</span></span><span style="display:flex;"><span>            }]
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        st<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#34;Sending request to KServe...&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># --- Send Request ---</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(KSERVE_URL, json<span style="color:#f92672">=</span>payload, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>)
</span></span><span style="display:flex;"><span>            response<span style="color:#f92672">.</span>raise_for_status()
</span></span><span style="display:flex;"><span>            result <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>            st<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#34;Response received:&#34;</span>)
</span></span><span style="display:flex;"><span>            prediction <span style="color:#f92672">=</span> result<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;outputs&#39;</span>, [{}])[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;data&#39;</span>, [<span style="color:#66d9ef">None</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> prediction <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>                st<span style="color:#f92672">.</span>success(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;**Predicted Resale Price:** S$ </span><span style="color:#e6db74">{</span>prediction<span style="color:#e6db74">:</span><span style="color:#e6db74">,.2f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                st<span style="color:#f92672">.</span>error(<span style="color:#e6db74">&#34;Prediction data not found in the response.&#34;</span>)
</span></span><span style="display:flex;"><span>                st<span style="color:#f92672">.</span>json(result)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ... (Error handling remains the same) ...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> requests<span style="color:#f92672">.</span>exceptions<span style="color:#f92672">.</span>Timeout:
</span></span><span style="display:flex;"><span>            st<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Error: Request timed out connecting to </span><span style="color:#e6db74">{</span>KSERVE_URL<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> requests<span style="color:#f92672">.</span>exceptions<span style="color:#f92672">.</span>ConnectionError:
</span></span><span style="display:flex;"><span>            st<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Error: Could not connect to the prediction service at </span><span style="color:#e6db74">{</span>KSERVE_URL<span style="color:#e6db74">}</span><span style="color:#e6db74">. Is it running and accessible?&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> requests<span style="color:#f92672">.</span>exceptions<span style="color:#f92672">.</span>HTTPError <span style="color:#66d9ef">as</span> err:
</span></span><span style="display:flex;"><span>            st<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Error: Prediction service returned status code </span><span style="color:#e6db74">{</span>err<span style="color:#f92672">.</span>response<span style="color:#f92672">.</span>status_code<span style="color:#e6db74">}</span><span style="color:#e6db74">.&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                error_detail <span style="color:#f92672">=</span> err<span style="color:#f92672">.</span>response<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>                st<span style="color:#f92672">.</span>json({<span style="color:#e6db74">&#34;error_details&#34;</span>: error_detail})
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> json<span style="color:#f92672">.</span>JSONDecodeError:
</span></span><span style="display:flex;"><span>                 st<span style="color:#f92672">.</span>text(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Response content:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">{</span>err<span style="color:#f92672">.</span>response<span style="color:#f92672">.</span>text<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            st<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;An unexpected error occurred: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        st<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Error preparing data for prediction: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div>
</details>

<p>Since this app is running from within a Jupyter Notebook environment, we need to port-forward the <code>jupyter-tff</code> service to Streamlit’s default port <code>8501</code>:</p>
<p><img src="/images/hdb-app/hdb-port-forward-jupyter-tff.png" alt="hdb-port-forward-jupyter-tff"></p>
<p>Once port-forwarding is active, open your browser and navigate to <em>http://localhost:8501</em> to access the app interface:</p>
<p><img src="/images/hdb-app/hdb-resale-price-predictor.png" alt="hdb-resale-price-predictor"></p>
<hr>
<h2 id="bonus-tracking-model-performance-with-mlflow">Bonus: Tracking Model Performance with MLflow</h2>
<p>To better monitor model performance and track different training experiments, I used MLflow for experiment tracking. Below is a snapshot of the interface showing various model runs and their corresponding metrics:</p>
<p><img src="/images/hdb-app/hdb-xgboost-multistep-bst-local-artifacts.png" alt="hdb-xgboost-multistep-bst-local-artifacts"></p>
<p>This setup helps keep experimentation organized and reproducible, especially when tuning hyperparameters or trying different data splits.</p>
<p><img src="/images/hdb-app/hdb-xgboost-multistep-bst-local.png" alt="hdb-xgboost-multistep-bst-local"></p>
<hr>
<h2 id="conclusion">Conclusion</h2>
<p>This walkthrough showcased how easy it is to get started with a full-featured Jupyter environment in Kubeflow using the <code>jupyter-tensorflow-full</code> image. By combining this with Streamlit, I was able to build and test an HDB resale price predictor app directly within my notebook server. With minimal setup and simple port forwarding, Kubeflow proves to be a solid platform not just for machine learning pipelines but also for interactive app development and experimentation.</p>

  
  <hr>
<div class="footer">
    
	    
            <a class="previous-post" href="https://seehiong.github.io/2025/feature-impact-on-hdb-predictions/?ref=footer"><span style="font-weight:bold;">« Previous</span><br>Feature Impact on HDB predictions</a>
        
	    
            <div class="next-post">
                <a href="https://seehiong.github.io/2025/building-a-recommender-system/?ref=footer"><span style="font-weight:bold;">Next »</span><br>Building a Recommender System</a>
            </div>
        
    
</div>

  
  <br>
<div class="comments">
    <script>
        const getStoredTheme = () => {
            const themeFromLS = localStorage.getItem("theme");
            const themeFromHugo = document.body.classList.contains("dark-theme") ? "dark" : "light";
            const currentTheme = themeFromLS ? themeFromLS : themeFromHugo;
            return currentTheme;
        };

        const setGiscusTheme = (theme) => {
            const sendMessage = (message) => {
                const iframe = document.querySelector('iframe.giscus-frame');
                if (iframe) {
                    iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
                }
            };
            sendMessage({ setConfig: { theme } });
        };

        document.addEventListener("DOMContentLoaded", () => {
            setGiscusTheme(getStoredTheme());

            const giscusAttributes = {
                "src": "https://giscus.app/client.js",
                "data-repo": "seehiong/seehiong.github.io",
                "data-repo-id": "R_kgDOJg7Puw",
                "data-category": "General",
                "data-category-id": "DIC_kwDOJg7Pu84Cbyhc",
                "data-mapping": "url",
                "data-strict": "0",
                "data-reactions-enabled": "1",
                "data-emit-metadata": "0",
                "data-input-position": "top",
                "data-theme": getStoredTheme(),
                "data-lang": "en",
                "data-loading": "lazy",
                "crossorigin": "anonymous",
                "async": "",
            };

            
            const giscusScript = document.createElement("script");
            Object.entries(giscusAttributes).forEach(
                ([key, value]) => giscusScript.setAttribute(key, value));
            document.querySelector(".comments").appendChild(giscusScript);

            
            const themeSwitcher = document.querySelector(".btn-light-dark");
            if (themeSwitcher) {
                themeSwitcher.addEventListener("click", () => {
                    const currentTheme = getStoredTheme();
                    document.documentElement.classList.toggle("dark", currentTheme);
                    setGiscusTheme(currentTheme);
                });
            }
        });
    </script>
</div>
</div>
            </main>
            
  
    <div class="article-toc ">
    <div class="toc-wrapper">
      <h4 id="contents"></h4>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#deploying-the-inferenceservice">Deploying the InferenceService</a>
      <ul>
        <li><a href="#1-create-service-account">1. Create Service Account</a></li>
        <li><a href="#2-create-s3-secret">2. Create S3 Secret</a></li>
        <li><a href="#3-deploy-the-inferenceservice">3. Deploy the InferenceService</a></li>
        <li><a href="#4-grant-istio-access">4. Grant Istio Access</a></li>
        <li><a href="#5-run-a-prediction">5. Run a Prediction</a></li>
        <li><a href="#6-download-scaler-file">6. Download Scaler File</a></li>
      </ul>
    </li>
    <li><a href="#multistep-pipeline">Multistep pipeline</a>
      <ul>
        <li><a href="#step-1---load--prepare">Step 1 - Load &amp; Prepare</a></li>
        <li><a href="#step-2---split--scale">Step 2 - Split &amp; Scale</a></li>
        <li><a href="#step-3---train-model">Step 3 - Train Model</a></li>
        <li><a href="#step-4---predict--evaluate">Step 4 - Predict &amp; Evaluate</a></li>
        <li><a href="#step-5---generate--log-plot">Step 5 - Generate &amp; Log Plot</a></li>
        <li><a href="#step-6---deploy-to-kserve">Step 6 - Deploy to KServe</a></li>
        <li><a href="#step-7---pipeline-definition">Step 7 - Pipeline Definition</a></li>
        <li><a href="#step-8---compilation">Step 8 - Compilation</a></li>
      </ul>
    </li>
    <li><a href="#hdb-predictor-app">HDB Predictor App</a></li>
    <li><a href="#bonus-tracking-model-performance-with-mlflow">Bonus: Tracking Model Performance with MLflow</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav>

      
    </div>
</div>
  

        </div>
    </body>
</html>


<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  
      inlineMath: [['\\(', '\\)']]                  
    }
  };
</script>
