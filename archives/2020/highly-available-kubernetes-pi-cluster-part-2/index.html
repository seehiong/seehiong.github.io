<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
    




    







<script defer language="javascript" type="text/javascript" src="/js/bundle.min.b989f0fdae3971a3effd81d6d0b27b3cb1023ff0b601ff43e2118b0d9d82ddb9.js"></script>





  
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-5PNPM4HWQ0"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-5PNPM4HWQ0');
        }
      </script>

    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    <link rel="icon" href=/favicon.png>

    
    





  





  
  
  


<!-- Open Graph image and Twitter Card metadata -->

<title itemprop="name">Tech Blog - HA K8s Pi Cluster (II)</title>
<meta property="og:title" content=Tech&#32;Blog&#32;-&#32;HA&#32;K8s&#32;Pi&#32;Cluster&#32;(II) />
<meta name="twitter:title" content=Tech&#32;Blog&#32;-&#32;HA&#32;K8s&#32;Pi&#32;Cluster&#32;(II) />
<meta itemprop="name" content=Tech&#32;Blog&#32;-&#32;HA&#32;K8s&#32;Pi&#32;Cluster&#32;(II) />
<meta name="application-name" content=Tech&#32;Blog&#32;-&#32;HA&#32;K8s&#32;Pi&#32;Cluster&#32;(II) />
<meta property="og:site_name" content="See Hiong&#39;s Blog" />


<meta name="description" content="In my journey to establish a Highly Available Kubernetes Pi Cluster, I&#39;ve successfully configured the cluster following an external etcd setup. The process involves installing Docker, setting up the Docker daemon, and installing kubeadm. Initializing Kubernetes Master Nodes, preparing certificates, and configuring Calico for networking are key steps. Troubleshooting tips include addressing refused connections and certificate expiration. To rejoin a faulty node, cordoning, draining, and generating new keys are essential. Now, I proudly own a fully operational Highly Available Kubernetes Pi Cluster." />
<meta itemprop="description" content="In my journey to establish a Highly Available Kubernetes Pi Cluster, I&#39;ve successfully configured the cluster following an external etcd setup. The process involves installing Docker, setting up the Docker daemon, and installing kubeadm. Initializing Kubernetes Master Nodes, preparing certificates, and configuring Calico for networking are key steps. Troubleshooting tips include addressing refused connections and certificate expiration. To rejoin a faulty node, cordoning, draining, and generating new keys are essential. Now, I proudly own a fully operational Highly Available Kubernetes Pi Cluster." />
<meta property="og:description" content="In my journey to establish a Highly Available Kubernetes Pi Cluster, I&#39;ve successfully configured the cluster following an external etcd setup. The process involves installing Docker, setting up the Docker daemon, and installing kubeadm. Initializing Kubernetes Master Nodes, preparing certificates, and configuring Calico for networking are key steps. Troubleshooting tips include addressing refused connections and certificate expiration. To rejoin a faulty node, cordoning, draining, and generating new keys are essential. Now, I proudly own a fully operational Highly Available Kubernetes Pi Cluster." />
<meta name="twitter:description" content="In my journey to establish a Highly Available Kubernetes Pi Cluster, I&#39;ve successfully configured the cluster following an external etcd setup. The process involves installing Docker, setting up the Docker daemon, and installing kubeadm. Initializing Kubernetes Master Nodes, preparing certificates, and configuring Calico for networking are key steps. Troubleshooting tips include addressing refused connections and certificate expiration. To rejoin a faulty node, cordoning, draining, and generating new keys are essential. Now, I proudly own a fully operational Highly Available Kubernetes Pi Cluster." />


<base href="https://seehiong.github.io/archives/2020/highly-available-kubernetes-pi-cluster-part-2/" />
<link rel="canonical" href="https://seehiong.github.io/archives/2020/highly-available-kubernetes-pi-cluster-part-2/" itemprop="url" />
<meta name="url" content="https://seehiong.github.io/archives/2020/highly-available-kubernetes-pi-cluster-part-2/" />
<meta name="twitter:url" content="https://seehiong.github.io/archives/2020/highly-available-kubernetes-pi-cluster-part-2/" />
<meta property="og:url" content="https://seehiong.github.io/archives/2020/highly-available-kubernetes-pi-cluster-part-2/" />


<meta property="og:updated_time" content="2020-08-17T20:00:00&#43;08:00" />


<link rel="sitemap" type="application/xml" title="Sitemap" href='https://seehiong.github.io/sitemap.xml' />

<meta name="robots" content="index,follow" />
<meta name="googlebot" content="index,follow" />



<meta property="fb:admins" content="" />


<meta name="apple-mobile-web-app-title" content="See Hiong&#39;s Blog" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />






<meta name="generator" content="Hugo 0.134.1">


    
    

<link type="text/css" rel="stylesheet" href="/css/bundle.min.03b57bbaf31d739f14c95df7f05d1cefcfa60bbafa36ba47313afdeb325aeada.css">


    
    <style>
    body {
        --sidebar-bg-color: #202020;
        --sidebar-img-border-color: #515151;
        --sidebar-p-color: #909090;
        --sidebar-h1-color: #FFF;
        --sidebar-a-color: #FFF;
        --sidebar-socials-color: #FFF;
        --text-color: #222;
        --bkg-color: #FAF9F6;
        --post-title-color: #303030;
        --list-color: #5a5a5a;
        --link-color: #268bd2;
        --date-color: #515151;
        --table-border-color: #E5E5E5;
        --table-stripe-color: #F9F9F9;
        --code-color: #000;
        --code-background-color: #E5E5E5;
        --code-block-color: #fff;
        --code-block-background-color: #272822;
        --moon-sun-color: #FFF;
        --moon-sun-background-color: #515151;
    }
    body.dark-theme {
        --text-color: #eee;
        --bkg-color: #121212;
        --post-title-color: #DBE2E9;
        --list-color: #9d9d9d;
        --link-color: #268bd2;
        --date-color: #9a9a9a;
        --table-border-color: #515151;
        --table-stripe-color: #202020;
        --code-color: #fff;
        --code-background-color: #515151;
        --code-block-color: #fff;
        --code-block-background-color: #272822;
    }
    body {
        background-color: var(--bkg-color);
    }
</style>

</head>

    <body class="dark-theme">
        <div class="wrapper">
            <aside class="sidebar">
    <div class="container sidebar-sticky">
        <div class="light-dark" align="right">
    <button class="btn-light-dark" title="Toggle light/dark mode">
        <svg class="moon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M6 .278a.768.768 0 0 1 .08.858a7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277c.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316a.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71C0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
        </svg>
        <svg class="sun" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M8 12a4 4 0 1 0 0-8a4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
        </svg>
    </button>
</div>

        <div class="sidebar-about">
    <h1 class="brand">
        
        
            <a href="https://seehiong.github.io/">
                <h1>Tech Blog</h1>
            </a>
        
    </h1>
    <p class="lead">
    Chronicling my personal expedition of technology exploration and experimentation, facilitated by a home-based self-configured laboratory
    </p>
</div>

        <link href="/pagefind/pagefind-ui.css" rel="stylesheet">
<style>
    :root {
        --pagefind-ui-primary: #eeeeee;
        --pagefind-ui-text: #eeeeee;
        --pagefind-ui-background: #152028;
        --pagefind-ui-border: #152028;
        --pagefind-ui-tag: #152028;
    }
</style>
<script src="/pagefind/pagefind-ui.js"></script>
<div style="max-width: 100%; margin: clamp(2px, 1vw, 10px) auto;">
    <div id="search"></div>
    <script>
        window.addEventListener('DOMContentLoaded', (event) => {
            new PagefindUI({ element: "#search", showSubResults: true, showImages: false });
        });
    </script>
</div>
        <nav>
    <ul class="sidebar-nav">

        
        
        
        
            

            
                
                
                    <li class="heading">
                        <a href="/2024/">2024</a>
                    </li>
                    
                        <li class="sub-heading">
                            Recent
                        </li>
                        
                            <li class="bullet">
                                <a href="https://seehiong.github.io/2024/integrating-mlflow-and-kubeflow-on-talos/">Integrating MLflow and Kubeflow on Talos</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://seehiong.github.io/2024/deploy-microservices-with-talos-locally/">Deploy Microservices with Talos Locally</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://seehiong.github.io/2024/controlling-roarm-m2-s-with-ros2/">Controlling RoArm-M2-S with ROS2</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://seehiong.github.io/2024/wave-rover-with-raspberry-pi-4/">Wave Rover with Raspberry Pi 4</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://seehiong.github.io/2024/wave-rover-setup-guide-and-troubleshooting-tips/">Wave Rover: Setup Guide and Troubleshooting Tips</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://seehiong.github.io/2024/talos-linux-setting-up-a-secure-immutable-kubernetes-cluster/">Talos Linux: Setting Up a Secure, Immutable Kubernetes Cluster</a>
                            </li>
                        
                    
                
            
                
                
            
                
                
            
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        
        
            

            
                
                
            
                
                
            
                
                
                    <li class="heading">
                        <a href="/archives/">Archives</a>
                    </li>
                    
                
            
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        
        
            

            
                
                
            
                
                
                    <li class="heading">
                        <a href="/about/">About</a>
                    </li>
                    
                
            
                
                
            
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        

    </ul>
</nav>

        
    <a target="_blank" class="social" title="GitHub" href="https://github.com/seehiong">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="-2 -2 24 24">
            <path fill="currentColor" d="M18.88 1.099C18.147.366 17.265 0 16.233 0H3.746C2.714 0 1.832.366 1.099 1.099C.366 1.832 0 2.714 0 3.746v12.487c0 1.032.366 1.914 1.099 2.647c.733.733 1.615 1.099 2.647 1.099H6.66c.19 0 .333-.007.429-.02a.504.504 0 0 0 .286-.169c.095-.1.143-.245.143-.435l-.007-.885c-.004-.564-.006-1.01-.006-1.34l-.3.052c-.19.035-.43.05-.721.046a5.555 5.555 0 0 1-.904-.091a2.026 2.026 0 0 1-.872-.39a1.651 1.651 0 0 1-.572-.8l-.13-.3a3.25 3.25 0 0 0-.41-.663c-.186-.243-.375-.407-.566-.494l-.09-.065a.956.956 0 0 1-.17-.156a.723.723 0 0 1-.117-.182c-.026-.061-.004-.111.065-.15c.07-.04.195-.059.378-.059l.26.04c.173.034.388.138.643.311a2.1 2.1 0 0 1 .631.677c.2.355.44.626.722.813c.282.186.566.28.852.28c.286 0 .533-.022.742-.065a2.59 2.59 0 0 0 .585-.196c.078-.58.29-1.028.637-1.34a8.907 8.907 0 0 1-1.333-.234a5.314 5.314 0 0 1-1.223-.507a3.5 3.5 0 0 1-1.047-.872c-.277-.347-.505-.802-.683-1.365c-.177-.564-.266-1.215-.266-1.952c0-1.049.342-1.942 1.027-2.68c-.32-.788-.29-1.673.091-2.652c.252-.079.625-.02 1.119.175c.494.195.856.362 1.086.5c.23.14.414.257.553.352a9.233 9.233 0 0 1 2.497-.338c.859 0 1.691.113 2.498.338l.494-.312a6.997 6.997 0 0 1 1.197-.572c.46-.174.81-.221 1.054-.143c.39.98.424 1.864.103 2.653c.685.737 1.028 1.63 1.028 2.68c0 .737-.089 1.39-.267 1.957c-.177.568-.407 1.023-.689 1.366a3.65 3.65 0 0 1-1.053.865c-.42.234-.828.403-1.223.507a8.9 8.9 0 0 1-1.333.235c.45.39.676 1.005.676 1.846v3.11c0 .147.021.266.065.357a.36.36 0 0 0 .208.189c.096.034.18.056.254.064c.074.01.18.013.318.013h2.914c1.032 0 1.914-.366 2.647-1.099c.732-.732 1.099-1.615 1.099-2.647V3.746c0-1.032-.367-1.914-1.1-2.647z"/>
        </svg>
    </a>

















    <a target="_blank" class="social" title="RSS Feed" href="/2024/index.xml">
        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 1280.000000 1280.000000">
            <g transform="translate(0.000000,1280.000000) scale(0.100000,-0.100000)" fill="currentColor">
                <path d="M2295 11929 c-284 -12 -642 -45 -707 -65 -17 -5 -18 -63 -18 -1039 0 -569 4 -1036 8 -1039 5 -3 74 6 153 19 510 86 1168 95 1789 25 1348 -153 2602 -677 3670 -1531 385 -308 820 -744 1126 -1129 842 -1060 1362 -2313 1514 -3650 70 -621 61 -1279 -25 -1789 -13 -79 -22 -148 -19 -153 3 -4 471 -8 1039 -8 l1035 0 5 23 c51 225 85 942 67 1419 -23 605 -77 1044 -198 1617 -294 1400 -927 2734 -1823 3846 -1043 1295 -2364 2259 -3909 2854 -1158 447 -2451 656 -3707 600z"/>
                <path d="M2255 7845 c-269 -25 -620 -81 -667 -106 -17 -9 -18 -55 -18 -899 0 -706 3 -890 13 -890 6 0 66 18 132 41 130 44 288 79 467 105 154 21 577 30 749 15 1207 -107 2267 -823 2814 -1902 166 -327 268 -637 330 -1001 38 -227 48 -384 42 -662 -8 -348 -44 -590 -126 -831 -23 -66 -41 -126 -41 -132 0 -10 184 -13 890 -13 844 0 890 1 899 18 27 50 88 452 110 725 14 162 14 624 1 782 -59 703 -233 1323 -545 1945 -481 956 -1313 1788 -2270 2268 -620 310 -1239 483 -1940 542 -165 14 -669 10 -840 -5z"/>
                <path d="M2519 3815 c-391 -66 -725 -336 -868 -703 -79 -201 -96 -462 -45 -677 83 -344 338 -641 666 -774 116 -47 205 -69 330 -80 412 -39 811 153 1040 500 193 292 240 648 128 981 -135 403 -492 699 -914 757 -100 14 -241 12 -337 -4z"/>
            </g>
        </svg>
    </a>





        <p class="footnote">
powered by <a target="_blank" href="https://gohugo.io">Hugo</a> | themed with <a target="_blank" href="https://github.com/lukeorth/poison">poison</a>
    <br>
    &copy; 2024 See Hiong&#39;s Blog. All rights reserved.
</p>

  </div>
</aside>

            <main class="content container">
                <div class="post" data-pagefind-body>
  <div class="info">
  <h1 class="post-title">
    <a href="https://seehiong.github.io/archives/2020/highly-available-kubernetes-pi-cluster-part-2/">HA K8s Pi Cluster (II)</a>
  </h1>

  <div class="headline" data-pagefind-ignore>
    <div>
      
      
      <time datetime=" 2020-08-17T20:00:00&#43;0800" class="post-date">
        August 17, 2020
      </time>
      
      <span> - </span>
      <span class="reading-time">
        
          
        

        <span>4 mins read</span>
      </span>
    </div>

    
    <ul class="tags">
      
      <li class="tag-Raspberry Pi">
        <a href="https://seehiong.github.io/tags/raspberry-pi">Raspberry Pi</a>
      </li>
      
      <li class="tag-K8s">
        <a href="https://seehiong.github.io/tags/k8s">K8s</a>
      </li>
      
      <li class="tag-Cluster">
        <a href="https://seehiong.github.io/tags/cluster">Cluster</a>
      </li>
      
      <li class="tag-HA">
        <a href="https://seehiong.github.io/tags/ha">HA</a>
      </li>
      
      <li class="tag-Docker">
        <a href="https://seehiong.github.io/tags/docker">Docker</a>
      </li>
      
      <li class="tag-Kubeadm">
        <a href="https://seehiong.github.io/tags/kubeadm">Kubeadm</a>
      </li>
      
      <li class="tag-Calio">
        <a href="https://seehiong.github.io/tags/calio">Calio</a>
      </li>
      
    </ul>
    
  </div>

  
  
  <p class="seriesname">
    Series: <a href="https://seehiong.github.io/series/ha-k8s-pi-cluster">HA K8s Pi Cluster</a>
  </p>
  

  
</div>

  <p><img src="/images/ha-k8s2/highly-available-kubernetes-pi-cluster.png" alt="highly-available-kubernetes-pi-cluster"></p>
<p>By having a Highly Available Kubernetes Pi Cluster, you will have full control over your production grade environment on-premise</p>
<hr>
<h1 id="ha-kubernetes-pi-cluster-part-ii">HA Kubernetes Pi Cluster (Part II)</h1>
<p><em>(Total Setup Time: 20 mins)</em></p>
<p>In this follow up guide, I will configure the HA Kubernetes Cluster onto the previous <a href="https://seehiong.github.io/archives/2020/highly-available-kubernetes-pi-cluster-part-1/" target="_blank">external etcd setup</a>.</p>
<h2 id="installing-docker">Installing Docker</h2>
<p><em>(5 mins)</em></p>
<p>Firstly, installs docker <a href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/" target="_blank">container runtimes</a> to all master nodes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo apt install docker.io
</span></span><span style="display:flex;"><span>sudo usermod -aG docker ubuntu
</span></span><span style="display:flex;"><span>su - ubuntu
</span></span><span style="display:flex;"><span>sudo systemctl enable docker.service
</span></span></code></pre></div><p>Secondly, sets up the docker daemon:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># Run su commnad as root</span>
</span></span><span style="display:flex;"><span>sudo su -
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Set up the Docker daemon</span>
</span></span><span style="display:flex;"><span>cat &gt; /etc/docker/daemon.json <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;exec-opts&#34;: [&#34;native.cgroupdriver=systemd&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;log-driver&#34;: &#34;json-file&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;log-opts&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;max-size&#34;: &#34;100m&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;storage-driver&#34;: &#34;overlay2&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>Thirdly, enables and restarts Docker:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable docker
</span></span><span style="display:flex;"><span>systemctl restart docker
</span></span></code></pre></div><h2 id="installing-kudeadm">Installing kudeadm</h2>
<p><em>(10 mins)</em></p>
<p>Starts by adding Kubernetes repository to all master nodes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo apt-get update <span style="color:#f92672">&amp;&amp;</span> sudo apt-get install -y apt-transport-https curl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">deb https://apt.kubernetes.io/ kubernetes-xenial main
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>Next, <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm" target="_blank">installs kubeadm</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo apt-get update
</span></span><span style="display:flex;"><span>sudo apt-get install -y kubelet kubeadm kubectl
</span></span><span style="display:flex;"><span>sudo apt-mark hold kubelet kubeadm kubectl
</span></span><span style="display:flex;"><span>sudo reboot
</span></span></code></pre></div><h2 id="initializing-kubernetes-master-nodes">Initializing Kubernetes Master Nodes</h2>
<p><em>(5 mins)</em></p>
<p>First, prepares the certs by following <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/" target="_blank">kubeadm HA setup</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo mkdir -p /etc/kubernetes/pki/etcd/
</span></span><span style="display:flex;"><span>sudo cp /srv/etcd-certs/cacert.pem /etc/kubernetes/pki/etcd/
</span></span><span style="display:flex;"><span>sudo cp /srv/etcd-certs/etcd.pem /etc/kubernetes/pki
</span></span><span style="display:flex;"><span>sudo cp /srv/etcd-certs/etcd-key.pem /etc/kubernetes/pki
</span></span></code></pre></div><p>Second, inserts the following into <em>kubeadm-config.yaml</em>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kubeadm.k8s.io/v1beta2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kubernetesVersion</span>: <span style="color:#ae81ff">stable</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">controlPlaneEndpoint</span>: <span style="color:#e6db74">&#34;cluster-endpoint:6443&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">etcd</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">external</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">endpoints</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">https://192.168.100.119:2379</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">https://192.168.100.173:2379</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">https://192.168.100.100:2379</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">caFile</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/etcd/cacert.pem</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">certFile</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/etcd.pem</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">keyFile</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/etcd-key.pem</span>
</span></span></code></pre></div><p>This is my <em>/etc/hosts</em> for all master nodes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-vim" data-lang="vim"><span style="display:flex;"><span># <span style="color:#a6e22e">cluster</span>-<span style="color:#a6e22e">endpoint</span> <span style="color:#a6e22e">points</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">first</span> <span style="color:#a6e22e">master</span> <span style="color:#a6e22e">node</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">127</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">1</span> <span style="color:#a6e22e">localhost</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">119</span> <span style="color:#a6e22e">master1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">173</span> <span style="color:#a6e22e">master2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">100</span> <span style="color:#a6e22e">master3</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">119</span> <span style="color:#a6e22e">cluster</span>-<span style="color:#a6e22e">endpoint</span>
</span></span></code></pre></div><p>Third, initializes the master node by:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo kubeadm init --config kubeadm-config.yaml --upload-certs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</span></span></code></pre></div><p>Fourth, installs <a href="https://docs.projectcalico.org/getting-started/kubernetes/self-managed-onprem/onpremises" target="_blank">Calio</a> from the list of <a href="https://kubernetes.io/docs/concepts/cluster-administration/addons/" target="_blank">networking addons</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>curl https://docs.projectcalico.org/manifests/calico-etcd.yaml -o calico-etcd.yaml
</span></span></code></pre></div><p>Fifth, prepares TLS for calico by following <a href="https://docs.projectcalico.org/getting-started/kubernetes/installation/config-options" target="_blank">config options</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat /srv/etcd-certs/cacert.pem | base64 -w <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>cat /srv/etcd-certs/etcd.pem | base64 -w <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>sudo cat /srv/etcd-certs/etcd-key.pem | base64 -w <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># Searches for the Secret section in calico.yaml and paste cat output from the cacert.pem, etcd.pem and etcd-key.pem</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Secret</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">type</span>: <span style="color:#ae81ff">Opaque</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">calico-etcd-secrets</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Populate the following files with etcd TLS configuration if desired, but leave blank if</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># not using TLS for etcd.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># This self-hosted install expects three files with the following names.  The values</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># should be base64 encoded strings of the entire contents of each file.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">etcd-key</span>: <span style="color:#ae81ff">LS0tLS1CRUdJTiB...VZBVEUgS0VZLS0tLS0=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">etcd-cert</span>: <span style="color:#ae81ff">LS0tLS1...ElGSUNBVEUtLS0tLQ==</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">etcd-ca</span>: <span style="color:#ae81ff">LS0tLS1CRUdJTiBD...JRklDQVRFLS0tLS0=</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Source: calico/templates/calico-config.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># This ConfigMap is used to configure a self-hosted Calico installation.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConfigMap</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">calico-config</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Configure this with the location of your etcd cluster.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">etcd_endpoints</span>: <span style="color:#e6db74">&#34;https://cluster-endpoint:2379&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># If you&#39;re using TLS enabled etcd uncomment the following.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># You must also populate the Secret below with these files.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">etcd_ca</span>: <span style="color:#e6db74">&#34;/calico-secrets/etcd-ca&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">etcd_cert</span>: <span style="color:#e6db74">&#34;/calico-secrets/etcd-cert&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">etcd_key</span>: <span style="color:#e6db74">&#34;/calico-secrets/etcd-key&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl apply -f calico.yaml
</span></span><span style="display:flex;"><span>watch kubectl get pods --all-namespaces
</span></span><span style="display:flex;"><span>kubectl get nodes -o wide
</span></span></code></pre></div><p>Lastly, runs this on the other 2 master nodes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo kubeadm join cluster-endpoint:6443 --token puuck4.kjgqjif1xyy2397f <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --discovery-token-ca-cert-hash sha256:50bb31b6f26ee6e98228f098fb9f50eaf7f1db67a011c90d6c764f7331cb90e1 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --control-plane --certificate-key 28ad20c49a7c6b8d06b2faa305fdf0c98d9763b932b929deb4704d57ec8ff959
</span></span></code></pre></div><p>This is my modified <em>/etc/hosts</em>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-vim" data-lang="vim"><span style="display:flex;"><span># <span style="color:#a6e22e">cluster</span>-<span style="color:#a6e22e">endpoint</span> <span style="color:#a6e22e">points</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">loadbalancer</span> <span style="color:#a6e22e">IP</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">127</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">1</span> <span style="color:#a6e22e">localhost</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">119</span> <span style="color:#a6e22e">master1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">173</span> <span style="color:#a6e22e">master2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">100</span> <span style="color:#a6e22e">master3</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">200</span> <span style="color:#a6e22e">cluster</span>-<span style="color:#a6e22e">endpoint</span>
</span></span></code></pre></div><p>And that&rsquo;s all to it! You now own a Highly Available Kubernetes Pi Cluster!</p>
<p><img src="/images/ha-k8s2/highly-available-kubernetes-pi-cluster-up-and-running.png" alt="highly-available-kubernetes-pi-cluster-up-and-running"></p>
<hr>
<h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="the-connection-to-the-server-localhost8080-was-refused---did-you-specify-the-right-host-or-port">The connection to the server localhost:8080 was refused - did you specify the right host or port?</h3>
<p>After <em>kubeadm init</em>, you need to run these commands:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</span></span></code></pre></div><h3 id="secret-kubeadm-certs-was-not-found-in-the-kube-system-namespace-this-secret-might-have-expired">Secret &ldquo;kubeadm-certs&rdquo; was not found in the &ldquo;kube-system&rdquo; Namespace. This Secret might have expired</h3>
<p>If the certificate-key expires, generates a new one as below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo kubeadm init phase upload-certs --upload-certs --config kubeadm-config.yaml
</span></span></code></pre></div><h3 id="network-stat-varlibcaliconodename-no-such-file-or-directory">network: stat /var/lib/calico/nodename: no such file or directory</h3>
<p>After resetting kubeadm, my kubernetes cluster runs successfully:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo kubeadm reset
</span></span><span style="display:flex;"><span>sudo rm -rf /etc/cni/net.d
</span></span><span style="display:flex;"><span>sudo iptables --flush
</span></span><span style="display:flex;"><span>sudo ipvsadm --clear
</span></span><span style="display:flex;"><span>rm $HOME/.kube/config
</span></span><span style="display:flex;"><span>sudo rm -rf /var/lib/cni
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># External etcd clean up</span>
</span></span><span style="display:flex;"><span>sudo etcdctl del <span style="color:#e6db74">&#34;&#34;</span> --prefix --cacert /srv/etcd-certs/cacert.pem --cert /srv/etcd-certs/etcd.pem  --key /srv/etcd-certs/etcd-key.pem
</span></span></code></pre></div><h3 id="re-joining-cluster">Re-joining cluster</h3>
<p>When your SD failed and you wish to re-configure the faulty PI, you need to perform:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># Cordon the faulty node</span>
</span></span><span style="display:flex;"><span>kubectl cordon master3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Drain the faulty one</span>
</span></span><span style="display:flex;"><span>kubectl drain master3 -delete-emptydir-data --ignore-daemonsets
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># if it hungs, you may have to open a separate terminal and to delete the relevant pod</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Delete the node</span>
</span></span><span style="display:flex;"><span>kubectl delete node master3 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Retrieve bootstrap token</span>
</span></span><span style="display:flex;"><span>kubeadm token list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Retrieve token cacert hash (sha256)</span>
</span></span><span style="display:flex;"><span>openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    | openssl rsa -pubin -outform der 2&gt;/dev/null <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    | openssl dgst -sha256 -hex <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    | sed <span style="color:#e6db74">&#39;s/^.* //&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate new key</span>
</span></span><span style="display:flex;"><span>kubeadm init phase upload-certs --upload-certs --config kubeadm-config.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Forms the join as master command based on above results</span>
</span></span><span style="display:flex;"><span>kubeadm join 192.168.100.180:6443 --token 0abut7.guksf3dfp1k67osq --discovery-token-ca-cert-hash sha256:a263dfc32ddd3d16cc72f2f91a0786e869f9310646614dbdf6a103be5d42b9c7 --v<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> --control-plane --certificate-key 97e86ed12f1e1b4f97d51d1a1ff92485d678d5fb8725c3c73e66b17a660c68af
</span></span></code></pre></div>
  
  <hr>
<div class="footer">
    
    
    
    <p>
    This is a post in the <b><a href="https://seehiong.github.io/series/ha-k8s-pi-cluster">HA K8s Pi Cluster</a></b> series.
        <br>Other posts in this series:
        <ul class="series">
            
            
            
            <li>
                August 17, 2020 -
                
                    HA K8s Pi Cluster (II)
                
            </li>
            
            <li>
                August 9, 2020 -
                
                    <a href="/archives/2020/highly-available-kubernetes-pi-cluster-part-1/">HA K8s Pi Cluster (I)</a>
                
            </li>
            
        </ul>
    </p>
    
</div>

  
  <br>
<div class="comments">
    <script>
        const getStoredTheme = () => {
            const themeFromLS = localStorage.getItem("theme");
            const themeFromHugo = document.body.classList.contains("dark-theme") ? "dark" : "light";
            const currentTheme = themeFromLS ? themeFromLS : themeFromHugo;
            return currentTheme;
        };

        const setGiscusTheme = (theme) => {
            const sendMessage = (message) => {
                const iframe = document.querySelector('iframe.giscus-frame');
                if (iframe) {
                    iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
                }
            };
            sendMessage({ setConfig: { theme } });
        };

        document.addEventListener("DOMContentLoaded", () => {
            setGiscusTheme(getStoredTheme());

            const giscusAttributes = {
                "src": "https://giscus.app/client.js",
                "data-repo": "seehiong/seehiong.github.io",
                "data-repo-id": "R_kgDOJg7Puw",
                "data-category": "General",
                "data-category-id": "DIC_kwDOJg7Pu84Cbyhc",
                "data-mapping": "url",
                "data-strict": "0",
                "data-reactions-enabled": "1",
                "data-emit-metadata": "0",
                "data-input-position": "top",
                "data-theme": getStoredTheme(),
                "data-lang": "en",
                "data-loading": "lazy",
                "crossorigin": "anonymous",
                "async": "",
            };

            
            const giscusScript = document.createElement("script");
            Object.entries(giscusAttributes).forEach(
                ([key, value]) => giscusScript.setAttribute(key, value));
            document.querySelector(".comments").appendChild(giscusScript);

            
            const themeSwitcher = document.querySelector(".btn-light-dark");
            if (themeSwitcher) {
                themeSwitcher.addEventListener("click", () => {
                    const currentTheme = getStoredTheme();
                    document.documentElement.classList.toggle("dark", currentTheme);
                    setGiscusTheme(currentTheme);
                });
            }
        });
    </script>
</div>
</div>
            </main>
            
  
    <div class="article-toc ">
    <div class="toc-wrapper">
      <h4 id="contents"></h4>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#installing-docker">Installing Docker</a></li>
    <li><a href="#installing-kudeadm">Installing kudeadm</a></li>
    <li><a href="#initializing-kubernetes-master-nodes">Initializing Kubernetes Master Nodes</a></li>
    <li><a href="#troubleshooting">Troubleshooting</a>
      <ul>
        <li><a href="#the-connection-to-the-server-localhost8080-was-refused---did-you-specify-the-right-host-or-port">The connection to the server localhost:8080 was refused - did you specify the right host or port?</a></li>
        <li><a href="#secret-kubeadm-certs-was-not-found-in-the-kube-system-namespace-this-secret-might-have-expired">Secret &ldquo;kubeadm-certs&rdquo; was not found in the &ldquo;kube-system&rdquo; Namespace. This Secret might have expired</a></li>
        <li><a href="#network-stat-varlibcaliconodename-no-such-file-or-directory">network: stat /var/lib/calico/nodename: no such file or directory</a></li>
        <li><a href="#re-joining-cluster">Re-joining cluster</a></li>
      </ul>
    </li>
  </ul>
</nav>

      
        <hr>
        
              <div class="previous-post">
                <a href="https://seehiong.github.io/archives/2020/highly-available-kubernetes-pi-cluster-part-1/?ref=footer"><span style="font-weight:bold;"> Previous</span><br>HA K8s Pi Cluster (I)</a>
              </div>
              <br><br>
          
        
              <div class="next-post">
                  <a href="https://seehiong.github.io/archives/2021/kubernetes-pi-cluster-with-ansible/?ref=footer"><span style="font-weight:bold;">Next </span><br>K8s Pi Cluster with Ansible</a>
              </div>
          
      
    </div>
</div>
  

        </div>
    </body>
</html>


<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  
      inlineMath: [['\\(', '\\)']]                  
    }
  };
</script>
