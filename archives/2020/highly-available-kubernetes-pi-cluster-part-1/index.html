<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
    




    







<script defer language="javascript" type="text/javascript" src="/js/bundle.min.b989f0fdae3971a3effd81d6d0b27b3cb1023ff0b601ff43e2118b0d9d82ddb9.js"></script>






    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    <link rel="icon" href=/favicon.png>

    
    





  





  
  
  


<!-- Open Graph image and Twitter Card metadata -->

<title itemprop="name">Tech Blog - HA K8s Pi Cluster (I)</title>
<meta property="og:title" content=Tech&#32;Blog&#32;-&#32;HA&#32;K8s&#32;Pi&#32;Cluster&#32;(I) />
<meta name="twitter:title" content=Tech&#32;Blog&#32;-&#32;HA&#32;K8s&#32;Pi&#32;Cluster&#32;(I) />
<meta itemprop="name" content=Tech&#32;Blog&#32;-&#32;HA&#32;K8s&#32;Pi&#32;Cluster&#32;(I) />
<meta name="application-name" content=Tech&#32;Blog&#32;-&#32;HA&#32;K8s&#32;Pi&#32;Cluster&#32;(I) />
<meta property="og:site_name" content="See Hiong&#39;s Blog" />


<meta name="description" content="In this special guide, I celebrate Singapore&#39;s 55th National Day by setting up a Highly Available Kubernetes Pi Cluster using 2x Raspberry Pi Model B 8GB. With a total setup time of 25 minutes, I configure an external etcd key-value store, laying the foundation for high availability. I detail OS preparation, creating a virtual IP with Keepalived, generating certificates for etcd, and setting up etcd on each master node. Troubleshooting tips are provided, including addressing cluster ID mismatches and replacing faulty members. Stay tuned for the next article covering the continuation of the HA configuration." />
<meta itemprop="description" content="In this special guide, I celebrate Singapore&#39;s 55th National Day by setting up a Highly Available Kubernetes Pi Cluster using 2x Raspberry Pi Model B 8GB. With a total setup time of 25 minutes, I configure an external etcd key-value store, laying the foundation for high availability. I detail OS preparation, creating a virtual IP with Keepalived, generating certificates for etcd, and setting up etcd on each master node. Troubleshooting tips are provided, including addressing cluster ID mismatches and replacing faulty members. Stay tuned for the next article covering the continuation of the HA configuration." />
<meta property="og:description" content="In this special guide, I celebrate Singapore&#39;s 55th National Day by setting up a Highly Available Kubernetes Pi Cluster using 2x Raspberry Pi Model B 8GB. With a total setup time of 25 minutes, I configure an external etcd key-value store, laying the foundation for high availability. I detail OS preparation, creating a virtual IP with Keepalived, generating certificates for etcd, and setting up etcd on each master node. Troubleshooting tips are provided, including addressing cluster ID mismatches and replacing faulty members. Stay tuned for the next article covering the continuation of the HA configuration." />
<meta name="twitter:description" content="In this special guide, I celebrate Singapore&#39;s 55th National Day by setting up a Highly Available Kubernetes Pi Cluster using 2x Raspberry Pi Model B 8GB. With a total setup time of 25 minutes, I configure an external etcd key-value store, laying the foundation for high availability. I detail OS preparation, creating a virtual IP with Keepalived, generating certificates for etcd, and setting up etcd on each master node. Troubleshooting tips are provided, including addressing cluster ID mismatches and replacing faulty members. Stay tuned for the next article covering the continuation of the HA configuration." />


<base href="https://seehiong.github.io/archives/2020/highly-available-kubernetes-pi-cluster-part-1/" />
<link rel="canonical" href="https://seehiong.github.io/archives/2020/highly-available-kubernetes-pi-cluster-part-1/" itemprop="url" />
<meta name="url" content="https://seehiong.github.io/archives/2020/highly-available-kubernetes-pi-cluster-part-1/" />
<meta name="twitter:url" content="https://seehiong.github.io/archives/2020/highly-available-kubernetes-pi-cluster-part-1/" />
<meta property="og:url" content="https://seehiong.github.io/archives/2020/highly-available-kubernetes-pi-cluster-part-1/" />


<meta property="og:updated_time" content="2020-08-09T20:00:00&#43;08:00" />


<link rel="sitemap" type="application/xml" title="Sitemap" href='https://seehiong.github.io/sitemap.xml' />

<meta name="robots" content="index,follow" />
<meta name="googlebot" content="index,follow" />



<meta property="fb:admins" content="" />


<meta name="apple-mobile-web-app-title" content="See Hiong&#39;s Blog" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />






<meta name="generator" content="Hugo 0.134.1">


    
    

<link type="text/css" rel="stylesheet" href="/css/bundle.min.03b57bbaf31d739f14c95df7f05d1cefcfa60bbafa36ba47313afdeb325aeada.css">


    
    <style>
    body {
        --sidebar-bg-color: #202020;
        --sidebar-img-border-color: #515151;
        --sidebar-p-color: #909090;
        --sidebar-h1-color: #FFF;
        --sidebar-a-color: #FFF;
        --sidebar-socials-color: #FFF;
        --text-color: #222;
        --bkg-color: #FAF9F6;
        --post-title-color: #303030;
        --list-color: #5a5a5a;
        --link-color: #268bd2;
        --date-color: #515151;
        --table-border-color: #E5E5E5;
        --table-stripe-color: #F9F9F9;
        --code-color: #000;
        --code-background-color: #E5E5E5;
        --code-block-color: #fff;
        --code-block-background-color: #272822;
        --moon-sun-color: #FFF;
        --moon-sun-background-color: #515151;
    }
    body.dark-theme {
        --text-color: #eee;
        --bkg-color: #121212;
        --post-title-color: #DBE2E9;
        --list-color: #9d9d9d;
        --link-color: #268bd2;
        --date-color: #9a9a9a;
        --table-border-color: #515151;
        --table-stripe-color: #202020;
        --code-color: #fff;
        --code-background-color: #515151;
        --code-block-color: #fff;
        --code-block-background-color: #272822;
    }
    body {
        background-color: var(--bkg-color);
    }
</style>

</head>

    <body class="dark-theme">
        <div class="wrapper">
            <aside class="sidebar">
    <div class="container sidebar-sticky">
        <div class="light-dark" align="right">
    <button class="btn-light-dark" title="Toggle light/dark mode">
        <svg class="moon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M6 .278a.768.768 0 0 1 .08.858a7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277c.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316a.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71C0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
        </svg>
        <svg class="sun" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M8 12a4 4 0 1 0 0-8a4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
        </svg>
    </button>
</div>

        <div class="sidebar-about">
    <h1 class="brand">
        
        
            <a href="https://seehiong.github.io/">
                <h1>Tech Blog</h1>
            </a>
        
    </h1>
    <p class="lead">
    Chronicling my personal expedition of technology exploration and experimentation, facilitated by a home-based self-configured laboratory
    </p>
</div>

        <link href="/pagefind/pagefind-ui.css" rel="stylesheet">
<style>
    :root {
        --pagefind-ui-primary: #eeeeee;
        --pagefind-ui-text: #eeeeee;
        --pagefind-ui-background: #152028;
        --pagefind-ui-border: #152028;
        --pagefind-ui-tag: #152028;
    }
</style>
<script src="/pagefind/pagefind-ui.js"></script>
<div style="max-width: 100%; margin: clamp(2px, 1vw, 10px) auto;">
    <div id="search"></div>
    <script>
        window.addEventListener('DOMContentLoaded', (event) => {
            new PagefindUI({ element: "#search", showSubResults: true, showImages: false });
        });
    </script>
</div>
        <nav>
    <ul class="sidebar-nav">

        
        
        
        
            

            
                
                
                    <li class="heading">
                        <a href="/2024/">2024</a>
                    </li>
                    
                        <li class="sub-heading">
                            Recent
                        </li>
                        
                            <li class="bullet">
                                <a href="https://seehiong.github.io/2024/talos-linux-setting-up-a-secure-immutable-kubernetes-cluster/">Talos Linux: Setting Up a Secure, Immutable Kubernetes Cluster</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://seehiong.github.io/2024/audio-generation-with-nvidia-jetson-orin-nx/">Audio Generation with NVIDIA Jetson Orin NX</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://seehiong.github.io/2024/unleashing-text-generation-with-nvidia-jetson-orin-nx/">Unleashing Text Generation with NVIDIA Jetson Orin NX</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://seehiong.github.io/2024/scaling-kafka-workloads-with-keda-in-kubernetes/">Scaling Kafka Workloads with KEDA in Kubernetes</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://seehiong.github.io/2024/exploring-nvidia-jetson-orin-nx-flashing-and-setup-guide/">Exploring NVIDIA Jetson Orin NX: Flashing and Setup Guide</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://seehiong.github.io/2024/setting-up-kafka-with-microk8s-and-multipass/">Setting Up Kafka with MicroK8s and Multipass</a>
                            </li>
                        
                    
                
            
                
                
            
                
                
            
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        
        
            

            
                
                
            
                
                
            
                
                
                    <li class="heading">
                        <a href="/archives/">Archives</a>
                    </li>
                    
                
            
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        
        
            

            
                
                
            
                
                
                    <li class="heading">
                        <a href="/about/">About</a>
                    </li>
                    
                
            
                
                
            
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        

    </ul>
</nav>

        
    <a target="_blank" class="social" title="GitHub" href="https://github.com/seehiong">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="-2 -2 24 24">
            <path fill="currentColor" d="M18.88 1.099C18.147.366 17.265 0 16.233 0H3.746C2.714 0 1.832.366 1.099 1.099C.366 1.832 0 2.714 0 3.746v12.487c0 1.032.366 1.914 1.099 2.647c.733.733 1.615 1.099 2.647 1.099H6.66c.19 0 .333-.007.429-.02a.504.504 0 0 0 .286-.169c.095-.1.143-.245.143-.435l-.007-.885c-.004-.564-.006-1.01-.006-1.34l-.3.052c-.19.035-.43.05-.721.046a5.555 5.555 0 0 1-.904-.091a2.026 2.026 0 0 1-.872-.39a1.651 1.651 0 0 1-.572-.8l-.13-.3a3.25 3.25 0 0 0-.41-.663c-.186-.243-.375-.407-.566-.494l-.09-.065a.956.956 0 0 1-.17-.156a.723.723 0 0 1-.117-.182c-.026-.061-.004-.111.065-.15c.07-.04.195-.059.378-.059l.26.04c.173.034.388.138.643.311a2.1 2.1 0 0 1 .631.677c.2.355.44.626.722.813c.282.186.566.28.852.28c.286 0 .533-.022.742-.065a2.59 2.59 0 0 0 .585-.196c.078-.58.29-1.028.637-1.34a8.907 8.907 0 0 1-1.333-.234a5.314 5.314 0 0 1-1.223-.507a3.5 3.5 0 0 1-1.047-.872c-.277-.347-.505-.802-.683-1.365c-.177-.564-.266-1.215-.266-1.952c0-1.049.342-1.942 1.027-2.68c-.32-.788-.29-1.673.091-2.652c.252-.079.625-.02 1.119.175c.494.195.856.362 1.086.5c.23.14.414.257.553.352a9.233 9.233 0 0 1 2.497-.338c.859 0 1.691.113 2.498.338l.494-.312a6.997 6.997 0 0 1 1.197-.572c.46-.174.81-.221 1.054-.143c.39.98.424 1.864.103 2.653c.685.737 1.028 1.63 1.028 2.68c0 .737-.089 1.39-.267 1.957c-.177.568-.407 1.023-.689 1.366a3.65 3.65 0 0 1-1.053.865c-.42.234-.828.403-1.223.507a8.9 8.9 0 0 1-1.333.235c.45.39.676 1.005.676 1.846v3.11c0 .147.021.266.065.357a.36.36 0 0 0 .208.189c.096.034.18.056.254.064c.074.01.18.013.318.013h2.914c1.032 0 1.914-.366 2.647-1.099c.732-.732 1.099-1.615 1.099-2.647V3.746c0-1.032-.367-1.914-1.1-2.647z"/>
        </svg>
    </a>

















    <a target="_blank" class="social" title="RSS Feed" href="/2024/index.xml">
        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 1280.000000 1280.000000">
            <g transform="translate(0.000000,1280.000000) scale(0.100000,-0.100000)" fill="currentColor">
                <path d="M2295 11929 c-284 -12 -642 -45 -707 -65 -17 -5 -18 -63 -18 -1039 0 -569 4 -1036 8 -1039 5 -3 74 6 153 19 510 86 1168 95 1789 25 1348 -153 2602 -677 3670 -1531 385 -308 820 -744 1126 -1129 842 -1060 1362 -2313 1514 -3650 70 -621 61 -1279 -25 -1789 -13 -79 -22 -148 -19 -153 3 -4 471 -8 1039 -8 l1035 0 5 23 c51 225 85 942 67 1419 -23 605 -77 1044 -198 1617 -294 1400 -927 2734 -1823 3846 -1043 1295 -2364 2259 -3909 2854 -1158 447 -2451 656 -3707 600z"/>
                <path d="M2255 7845 c-269 -25 -620 -81 -667 -106 -17 -9 -18 -55 -18 -899 0 -706 3 -890 13 -890 6 0 66 18 132 41 130 44 288 79 467 105 154 21 577 30 749 15 1207 -107 2267 -823 2814 -1902 166 -327 268 -637 330 -1001 38 -227 48 -384 42 -662 -8 -348 -44 -590 -126 -831 -23 -66 -41 -126 -41 -132 0 -10 184 -13 890 -13 844 0 890 1 899 18 27 50 88 452 110 725 14 162 14 624 1 782 -59 703 -233 1323 -545 1945 -481 956 -1313 1788 -2270 2268 -620 310 -1239 483 -1940 542 -165 14 -669 10 -840 -5z"/>
                <path d="M2519 3815 c-391 -66 -725 -336 -868 -703 -79 -201 -96 -462 -45 -677 83 -344 338 -641 666 -774 116 -47 205 -69 330 -80 412 -39 811 153 1040 500 193 292 240 648 128 981 -135 403 -492 699 -914 757 -100 14 -241 12 -337 -4z"/>
            </g>
        </svg>
    </a>





        <p class="footnote">
powered by <a target="_blank" href="https://gohugo.io">Hugo</a> | themed with <a target="_blank" href="https://github.com/lukeorth/poison">poison</a>
    <br>
    &copy; 2024 See Hiong&#39;s Blog. All rights reserved.
</p>

  </div>
</aside>

            <main class="content container">
                <div class="post" data-pagefind-body>
  <div class="info">
  <h1 class="post-title">
    <a href="https://seehiong.github.io/archives/2020/highly-available-kubernetes-pi-cluster-part-1/">HA K8s Pi Cluster (I)</a>
  </h1>

  <div class="headline" data-pagefind-ignore>
    <div>
      
      
      <time datetime=" 2020-08-09T20:00:00&#43;0800" class="post-date">
        August 9, 2020
      </time>
      
      <span> - </span>
      <span class="reading-time">
        
          
        

        <span>7 mins read</span>
      </span>
    </div>

    
    <ul class="tags">
      
      <li class="tag-Raspberry Pi">
        <a href="https://seehiong.github.io/tags/raspberry-pi">Raspberry Pi</a>
      </li>
      
      <li class="tag-K8s">
        <a href="https://seehiong.github.io/tags/k8s">K8s</a>
      </li>
      
      <li class="tag-Cluster">
        <a href="https://seehiong.github.io/tags/cluster">Cluster</a>
      </li>
      
      <li class="tag-HA">
        <a href="https://seehiong.github.io/tags/ha">HA</a>
      </li>
      
      <li class="tag-KeepedAlive">
        <a href="https://seehiong.github.io/tags/keepedalive">KeepedAlive</a>
      </li>
      
      <li class="tag-Etcd">
        <a href="https://seehiong.github.io/tags/etcd">Etcd</a>
      </li>
      
    </ul>
    
  </div>

  
  
  <p class="seriesname">
    Series: <a href="https://seehiong.github.io/series/ha-k8s-pi-cluster">HA K8s Pi Cluster</a>
  </p>
  

  
</div>

  <p><img src="/images/ha-k8s1/highly-available-kubernetes-pi-cluster.png" alt="highly-available-kubernetes-pi-cluster"></p>
<p>By having a Highly Available Kubernetes Pi Cluster, you will have full control over your production grade environment on-premise</p>
<hr>
<h1 id="ha-kubernetes-pi-cluster-part-i">HA Kubernetes Pi Cluster (Part I)</h1>
<p><em>(Total Setup Time: 25 mins)</em></p>
<p>On this special day, I will like to wish all Singaporeans and Singapore a Happy 55th <a href="https://www.ndp.gov.sg/" target="_blank">National Day</a>!</p>
<p>With the newly purchase 2x Raspberry Pi Model B 8GB and 64GB SD card to my collection, I will setup a Highly Available Kubernetes Pi Cluster. In this guide, I will setup an <a href="https://etcd.io/" target="_blank">external etcd</a> key-value store. In the <a href="https://seehiong.github.io/archives/2020/highly-available-kubernetes-pi-cluster-part-2/" target="_blank">next article</a>, I will continue with the HA configuration.</p>
<h2 id="preparing-os">Preparing OS</h2>
<p><em>(10 mins)</em></p>
<p>First, I am using <a href="https://ubuntu.com/download/raspberry-pi" target="_blank">Ubuntu Server (64-bit)</a> as my OS. After burning the image onto my 64GB SD card, create an empty file <strong>ssh</strong> in d:/boot. This section is required for each master nodes.</p>
<p>Second, change the default password <em>ubuntu</em> for the default ubuntu user. Upgrade the OS:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo apt update
</span></span><span style="display:flex;"><span>sudo apt upgrade
</span></span></code></pre></div><p>Third, change the hostname by running:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo vi /etc/hostname
</span></span><span style="display:flex;"><span>sudo vi /etc/hosts
</span></span></code></pre></div><p>Fourth, letting iptables to see <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/" target="_blank">bridged traffic</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># Checks if br_netfilter is loaded</span>
</span></span><span style="display:flex;"><span>lsmod | grep br_netfilter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Loads its explicitly</span>
</span></span><span style="display:flex;"><span>sudo modprobe br_netfilter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Sees bridged traffic</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo sysctl --system
</span></span></code></pre></div><p>Fifth, enable memory cgroup, by adding the following to <em>/boot/firmware/cmdline.txt</em>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-vim" data-lang="vim"><span style="display:flex;"><span><span style="color:#a6e22e">cgroup</span>=<span style="color:#a6e22e">cpuset</span> <span style="color:#a6e22e">cgroup_enable</span>=<span style="color:#a6e22e">memory</span> <span style="color:#a6e22e">cgroup_memory</span>=<span style="color:#ae81ff">1</span> <span style="color:#a6e22e">swapaccount</span>=<span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>Finally, add the following to <em>/boot/firmware/usercfg.txt</em> for <a href="https://github.com/raspberrypi/firmware/blob/master/boot/overlays/README" target="_blank">disabling WiFi and Bluetooth</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-vim" data-lang="vim"><span style="display:flex;"><span><span style="color:#a6e22e">dtoverlay</span>=<span style="color:#a6e22e">disable</span>-<span style="color:#a6e22e">wifi</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">dtoverlay</span>=<span style="color:#a6e22e">disable</span>-<span style="color:#a6e22e">bt</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># <span style="color:#a6e22e">Memory</span> <span style="color:#a6e22e">group</span> <span style="color:#a6e22e">should</span> <span style="color:#a6e22e">be</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">after</span> <span style="color:#a6e22e">reboot</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sudo</span> <span style="color:#a6e22e">reboot</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">grep</span> <span style="color:#a6e22e">mem</span> <span style="color:#e6db74">/proc/</span><span style="color:#a6e22e">cgroups</span> | <span style="color:#a6e22e">awk</span> <span style="color:#e6db74">&#39;{ print $4 }&#39;</span>
</span></span></code></pre></div><h2 id="creating-virtual-ip">Creating Virtual IP</h2>
<p><em>(5 mins)</em></p>
<p>First, install <a href="https://www.keepalived.org/manpage.html" target="_blank">keepalived</a> referencing from <a href="https://keepalived.org/LVS-NAT-Keepalived-HOWTO.html" target="_blank">LVS-NAT-Keepalived</a> for all master nodes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#Installs keepalived</span>
</span></span><span style="display:flex;"><span>sudo apt install keepalived
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Configures keepalived</span>
</span></span><span style="display:flex;"><span>sudo vi /etc/keepalived/keepalived.conf
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-vim" data-lang="vim"><span style="display:flex;"><span>#<span style="color:#a6e22e">VRRP</span> <span style="color:#a6e22e">Instances</span> <span style="color:#a6e22e">definitions</span>
</span></span><span style="display:flex;"><span>#<span style="color:#a6e22e">state</span> <span style="color:#a6e22e">MASTER</span> <span style="color:#a6e22e">for</span> <span style="color:#a6e22e">first</span> <span style="color:#a6e22e">master</span>, <span style="color:#a6e22e">BACKUP</span> <span style="color:#a6e22e">for</span> <span style="color:#a6e22e">other</span> <span style="color:#a6e22e">master</span> <span style="color:#a6e22e">nodes</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">vrrp_instance</span> <span style="color:#a6e22e">VI_1</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">state</span> <span style="color:#a6e22e">MASTER</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">interface</span> <span style="color:#a6e22e">eth0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">virtual_router_id</span> <span style="color:#ae81ff">51</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">priority</span> <span style="color:#ae81ff">150</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">authentication</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">auth_type</span> <span style="color:#a6e22e">PASS</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">auth_pass</span> <span style="color:#a6e22e">seehiong</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">virtual_ipaddress</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># <span style="color:#a6e22e">Virtual</span> <span style="color:#a6e22e">Servers</span> <span style="color:#a6e22e">definitions</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">virtual_server</span> <span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">200</span> <span style="color:#ae81ff">6443</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">delay_loop</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lb_algo</span> <span style="color:#a6e22e">rr</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lb_kind</span> <span style="color:#a6e22e">NAT</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">protocol</span> <span style="color:#a6e22e">TCP</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">real_server</span> <span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">119</span> <span style="color:#ae81ff">6443</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">weight</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">TCP_CHECK</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">connect_timeout</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">connect_port</span> <span style="color:#ae81ff">6443</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">real_server</span> <span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">173</span> <span style="color:#ae81ff">6443</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">weight</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">TCP_CHECK</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">connect_timeout</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">connect_port</span> <span style="color:#ae81ff">6443</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">real_server</span> <span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">100</span> <span style="color:#ae81ff">6443</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">weight</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">TCP_CHECK</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">connect_timeout</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">connect_port</span> <span style="color:#ae81ff">6443</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># Restarts keepalived</span>
</span></span><span style="display:flex;"><span>sudo systemctl restart keepalived
</span></span></code></pre></div><p>Second, test the connection, which will fail at this point in time:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>nc -v 192.168.100.200 <span style="color:#ae81ff">6443</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Expected result</span>
</span></span><span style="display:flex;"><span>nc: connect to 192.168.100.200 port <span style="color:#ae81ff">6443</span> <span style="color:#f92672">(</span>tcp<span style="color:#f92672">)</span> failed: Connection refused
</span></span></code></pre></div><h2 id="preparing-certs-for-etcd">Preparing certs for etcd</h2>
<p><em>(5 mins)</em></p>
<p>First, by following <a href="https://networklessons.com/uncategorized/openssl-certification-authority-ca-ubuntu-server" target="_blank">openssl CA</a>, configure openssl and create root cert:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo su
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Openssl configuration</span>
</span></span><span style="display:flex;"><span>vi /usr/lib/ssl/openssl.cnf
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-vim" data-lang="vim"><span style="display:flex;"><span>[ <span style="color:#a6e22e">CA_default</span> ]                                                                                                                                                                                
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">dir</span>             = <span style="color:#e6db74">/root/</span><span style="color:#a6e22e">ca</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mkdir</span> <span style="color:#e6db74">/root/</span><span style="color:#a6e22e">ca</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">cd</span> <span style="color:#e6db74">/root/</span><span style="color:#a6e22e">ca</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mkdir</span> <span style="color:#a6e22e">newcerts</span> <span style="color:#a6e22e">certs</span> <span style="color:#a6e22e">crl</span> <span style="color:#a6e22e">private</span> <span style="color:#a6e22e">requests</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">touch</span> <span style="color:#a6e22e">index</span>.<span style="color:#a6e22e">txt</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">echo</span> <span style="color:#e6db74">&#39;1234&#39;</span> &gt; <span style="color:#a6e22e">serial</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># <span style="color:#a6e22e">Root</span> <span style="color:#a6e22e">certificate</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">openssl</span> <span style="color:#a6e22e">genrsa</span> -<span style="color:#a6e22e">aes256</span> -<span style="color:#a6e22e">out</span> <span style="color:#a6e22e">private</span>/<span style="color:#a6e22e">cakey</span>.<span style="color:#a6e22e">pem</span> <span style="color:#ae81ff">4096</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">openssl</span> <span style="color:#a6e22e">req</span> -<span style="color:#a6e22e">new</span> -<span style="color:#a6e22e">x509</span> -<span style="color:#a6e22e">key</span> <span style="color:#a6e22e">private</span><span style="color:#e6db74">/cakey.pem -out cacert.pem -days 3650 -set_serial 0 -subj &#39;/</span><span style="color:#a6e22e">C</span>=<span style="color:#a6e22e">SG</span><span style="color:#e6db74">/ST=SG/</span><span style="color:#a6e22e">O</span>=<span style="color:#a6e22e">seehiong</span>/<span style="color:#a6e22e">CN</span>=<span style="color:#a6e22e">master1</span>&#39;
</span></span></code></pre></div><p>Second, create certs for all master nodes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># Create master nodes&#39; certificate</span>
</span></span><span style="display:flex;"><span>cd /root/ca/requests/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>openssl genrsa -out etcd-key.pem
</span></span><span style="display:flex;"><span>openssl req -new -key etcd-key.pem -out etcd.csr -subj <span style="color:#e6db74">&#39;/C=SG/ST=SG/O=seehiong/CN=master1,master2,master3,localhost,cluster-endpoint&#39;</span>
</span></span><span style="display:flex;"><span>openssl ca -in etcd.csr -out etcd.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -extfile &lt;<span style="color:#f92672">(</span>printf <span style="color:#e6db74">&#34;subjectAltName=IP:192.168.100.119,IP:192.168.100.173,IP:192.168.100.100,IP:192.168.100.200,IP:127.0.0.1,\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  DNS:master1,DNS:master2,DNS:master3,DNS:localhost,DNS:cluster-endpoint&#34;</span><span style="color:#f92672">)</span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>openssl genrsa -out peer-etcd-key.pem
</span></span><span style="display:flex;"><span>openssl req -new -key peer-etcd-key.pem -out peer-etcd.csr -subj <span style="color:#e6db74">&#39;/C=SG/ST=SG/O=seehiong/CN=192.168.100.119,192.168.100.173,192.168.100.100,192.168.100.200&#39;</span>
</span></span><span style="display:flex;"><span>openssl ca -in peer-etcd.csr -out peer-etcd.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -extfile &lt;<span style="color:#f92672">(</span>printf <span style="color:#e6db74">&#34;subjectAltName=IP:192.168.100.119,IP:192.168.100.173,IP:192.168.100.100,IP:192.168.100.200,IP:127.0.0.1,\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  DNS:master1,DNS:master2,DNS:master3,DNS:localhost,DNS:cluster-endpoint&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>rm etcd.csr peer-etcd.csr
</span></span><span style="display:flex;"><span>mv etcd-key.pem peer-etcd-key.pem /root/ca/private/
</span></span><span style="display:flex;"><span>mv etcd.pem peer-etcd.pem /root/ca/certs/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Protects /root/ca folder</span>
</span></span><span style="display:flex;"><span>chmod -R <span style="color:#ae81ff">600</span> /root/ca
</span></span></code></pre></div><p>Third, copies all certs to <em>/srv/etcd-certs/</em> for all master nodes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># Copies certs to master1  </span>
</span></span><span style="display:flex;"><span>cp /root/ca/cacert.pem /root/ca/private/etcd-key.pem /root/ca/private/peer-etcd-key.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  /root/ca/certs/etcd.pem /root/ca/certs/peer-etcd.pem /srv/etcd-certs/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Copies certs to other master nodes</span>
</span></span><span style="display:flex;"><span>scp /root/ca/cacert.pem /root/ca/private/etcd-key.pem /root/ca/private/peer-etcd-key.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  /root/ca/certs/etcd.pem /root/ca/certs/peer-etcd.pem ubuntu@master2:/tmp
</span></span><span style="display:flex;"><span>scp /root/ca/cacert.pem /root/ca/private/etcd-key.pem /root/ca/private/peer-etcd-key.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  /root/ca/certs/etcd.pem /root/ca/certs/peer-etcd.pem ubuntu@master3:/tmp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ssh into other master nodes, perform these</span>
</span></span><span style="display:flex;"><span>sudo mv /tmp/*.pem  /srv/etcd-certs/
</span></span><span style="display:flex;"><span>sudo chown -R etcd:etcd /srv/etcd-certs/
</span></span></code></pre></div><p>Lastly, update ca-certificate on all nodes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo cp /srv/etcd-certs/cacert.pem /usr/local/share/ca-certificates
</span></span><span style="display:flex;"><span>sudo update-ca-certificates --fresh
</span></span></code></pre></div><h2 id="setting-up-etcd">Setting up etcd</h2>
<p><em>(5 mins)</em></p>
<p>First, by following <a href="https://github.com/etcd-io/etcd/releases" target="_blank">v3.4.10 release</a>, setup etcd on each master as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ETCD_VER<span style="color:#f92672">=</span>v3.4.10
</span></span><span style="display:flex;"><span>GITHUB_URL<span style="color:#f92672">=</span>https://github.com/etcd-io/etcd/releases/download
</span></span><span style="display:flex;"><span>DOWNLOAD_URL<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>GITHUB_URL<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Downloads the arm64 architecture for Raspberry Pi</span>
</span></span><span style="display:flex;"><span>rm -f /tmp/etcd-<span style="color:#e6db74">${</span>ETCD_VER<span style="color:#e6db74">}</span>-linux-arm64.tar.gz
</span></span><span style="display:flex;"><span>rm -rf /tmp/etcd-download-test <span style="color:#f92672">&amp;&amp;</span> mkdir -p /tmp/etcd-download-test
</span></span><span style="display:flex;"><span>curl -L <span style="color:#e6db74">${</span>DOWNLOAD_URL<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>ETCD_VER<span style="color:#e6db74">}</span>/etcd-<span style="color:#e6db74">${</span>ETCD_VER<span style="color:#e6db74">}</span>-linux-arm64.tar.gz -o /tmp/etcd-<span style="color:#e6db74">${</span>ETCD_VER<span style="color:#e6db74">}</span>-linux-arm64.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Extracts etcd</span>
</span></span><span style="display:flex;"><span>tar xzvf /tmp/etcd-<span style="color:#e6db74">${</span>ETCD_VER<span style="color:#e6db74">}</span>-linux-arm64.tar.gz -C /tmp/etcd-download-test --strip-components<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>rm -f /tmp/etcd-<span style="color:#e6db74">${</span>ETCD_VER<span style="color:#e6db74">}</span>-linux-arm64.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Checks version</span>
</span></span><span style="display:flex;"><span>/tmp/etcd-download-test/etcd --version <span style="color:#f92672">(</span>Error: etcd on unsupported platform without ETCD_UNSUPPORTED_ARCH<span style="color:#f92672">=</span>arm64 set<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>/tmp/etcd-download-test/etcdctl version <span style="color:#f92672">(</span>Success: etcdctl version: 3.4.10, API version: 3.4<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Moves to /usr/local/bin</span>
</span></span><span style="display:flex;"><span>sudo cp /tmp/etcd-download-test/etcd /usr/local/bin/
</span></span><span style="display:flex;"><span>sudo cp /tmp/etcd-download-test/etcdctl /usr/local/bin/
</span></span><span style="display:flex;"><span>export ETCD_UNSUPPORTED_ARCH<span style="color:#f92672">=</span>arm64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Checks version again</span>
</span></span><span style="display:flex;"><span>etcd --version <span style="color:#f92672">(</span>Sccuess: running etcd on unsupported architecture <span style="color:#e6db74">&#34;arm64&#34;</span> since ETCD_UNSUPPORTED_ARCH is set<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Second, prepares etcd as a service on <strong>master1</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo vi /lib/systemd/system/etcd.service
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-vim" data-lang="vim"><span style="display:flex;"><span># <span style="color:#a6e22e">Inserts</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">following</span> <span style="color:#a6e22e">into</span> <span style="color:#a6e22e">etcd</span>.<span style="color:#a6e22e">service</span> <span style="color:#a6e22e">for</span> <span style="color:#a6e22e">master1</span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">Unit</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Description</span>=<span style="color:#a6e22e">etcd</span> <span style="color:#a6e22e">key</span>-<span style="color:#a6e22e">value</span> <span style="color:#a6e22e">store</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Documentation</span>=<span style="color:#a6e22e">https</span>:<span style="color:#e6db74">//</span><span style="color:#a6e22e">etcd</span>.<span style="color:#a6e22e">io</span><span style="color:#e6db74">/docs/</span><span style="color:#a6e22e">v3</span>.<span style="color:#ae81ff">4</span>.<span style="color:#ae81ff">0</span>/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">Service</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">User</span>=<span style="color:#a6e22e">etcd</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Type</span>=<span style="color:#a6e22e">notify</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_UNSUPPORTED_ARCH</span>=<span style="color:#a6e22e">arm64</span>
</span></span><span style="display:flex;"><span>#<span style="color:#a6e22e">Loggingg</span> <span style="color:#a6e22e">flags</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_LOGGER</span>=<span style="color:#a6e22e">zap</span>
</span></span><span style="display:flex;"><span># <span style="color:#a6e22e">Member</span> <span style="color:#a6e22e">flags</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_NAME</span>=<span style="color:#a6e22e">infra1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_DATA_DIR</span>=<span style="color:#e6db74">/var/</span><span style="color:#a6e22e">lib</span>/<span style="color:#a6e22e">etcd</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_LISTEN_PEER_URLS</span>=<span style="color:#a6e22e">https</span>:<span style="color:#e6db74">//</span><span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">119</span>:<span style="color:#ae81ff">2380</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_LISTEN_CLIENT_URLS</span>=<span style="color:#a6e22e">https</span>:<span style="color:#e6db74">//</span><span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">119</span>:<span style="color:#ae81ff">2379</span>,<span style="color:#a6e22e">https</span>:<span style="color:#e6db74">//</span><span style="color:#ae81ff">127</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">2379</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_HEARTBEAT_INTERVAL</span>=<span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_ELECTION_TIMEOUT</span>=<span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span># <span style="color:#a6e22e">Clustering</span> <span style="color:#a6e22e">flags</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_INITIAL_ADVERTISE_PEER_URLS</span>=<span style="color:#a6e22e">https</span>:<span style="color:#e6db74">//</span><span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">119</span>:<span style="color:#ae81ff">2380</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_INITIAL_CLUSTER_TOKEN</span>=<span style="color:#a6e22e">etcd</span>-<span style="color:#a6e22e">cluster</span><span style="color:#ae81ff">-1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_INITIAL_CLUSTER</span>=<span style="color:#a6e22e">infra1</span>=<span style="color:#a6e22e">https</span>:<span style="color:#e6db74">//</span><span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">119</span>:<span style="color:#ae81ff">2380</span>,<span style="color:#a6e22e">infra2</span>=<span style="color:#a6e22e">https</span>:<span style="color:#e6db74">//</span><span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">173</span>:<span style="color:#ae81ff">2380</span>,<span style="color:#a6e22e">infra3</span>=<span style="color:#a6e22e">https</span>:<span style="color:#e6db74">//</span><span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">100</span>:<span style="color:#ae81ff">2380</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_INITIAL_CLUSTER_STATE</span>=<span style="color:#a6e22e">new</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_ADVERTISE_CLIENT_URLS</span>=<span style="color:#a6e22e">https</span>:<span style="color:#e6db74">//</span><span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">119</span>:<span style="color:#ae81ff">2379</span>
</span></span><span style="display:flex;"><span># <span style="color:#a6e22e">Security</span> <span style="color:#a6e22e">flags</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_CLIENT_CERT_AUTH</span>=<span style="color:#a6e22e">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_TRUSTED_CA_FILE</span>=<span style="color:#e6db74">/srv/</span><span style="color:#a6e22e">etcd</span>-<span style="color:#a6e22e">certs</span>/<span style="color:#a6e22e">cacert</span>.<span style="color:#a6e22e">pem</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_CERT_FILE</span>=<span style="color:#e6db74">/srv/</span><span style="color:#a6e22e">etcd</span>-<span style="color:#a6e22e">certs</span>/<span style="color:#a6e22e">etcd</span>.<span style="color:#a6e22e">pem</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_KEY_FILE</span>=<span style="color:#e6db74">/srv/</span><span style="color:#a6e22e">etcd</span>-<span style="color:#a6e22e">certs</span>/<span style="color:#a6e22e">etcd</span>-<span style="color:#a6e22e">key</span>.<span style="color:#a6e22e">pem</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_PEER_CLIENT_CERT_AUTH</span>=<span style="color:#a6e22e">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_PEER_TRUSTED_CA_FILE</span>=<span style="color:#e6db74">/srv/</span><span style="color:#a6e22e">etcd</span>-<span style="color:#a6e22e">certs</span>/<span style="color:#a6e22e">cacert</span>.<span style="color:#a6e22e">pem</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_PEER_CERT_FILE</span>=<span style="color:#e6db74">/srv/</span><span style="color:#a6e22e">etcd</span>-<span style="color:#a6e22e">certs</span>/<span style="color:#a6e22e">peer</span>-<span style="color:#a6e22e">etcd</span>.<span style="color:#a6e22e">pem</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_PEER_KEY_FILE</span>=<span style="color:#e6db74">/srv/</span><span style="color:#a6e22e">etcd</span>-<span style="color:#a6e22e">certs</span>/<span style="color:#a6e22e">peer</span>-<span style="color:#a6e22e">etcd</span>-<span style="color:#a6e22e">key</span>.<span style="color:#a6e22e">pem</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ExecStart</span>=<span style="color:#e6db74">/usr/</span><span style="color:#a6e22e">local</span><span style="color:#e6db74">/bin/</span><span style="color:#a6e22e">etcd</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Restart</span>=<span style="color:#a6e22e">always</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RestartSec</span>=<span style="color:#ae81ff">10</span>s
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">LimitNOFILE</span>=<span style="color:#ae81ff">40000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">Install</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">WantedBy</span>=<span style="color:#a6e22e">multi</span>-<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">target</span>
</span></span></code></pre></div><p>Third, creates etcd data folder and system account on master1:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo mkdir -p /var/lib/etcd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># etcd fails if file permissions are not set correctly</span>
</span></span><span style="display:flex;"><span>sudo chmod -R <span style="color:#ae81ff">700</span> /var/lib/etcd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Creates system user</span>
</span></span><span style="display:flex;"><span>sudo adduser --system etcd
</span></span><span style="display:flex;"><span>sudo addgroup etcd
</span></span><span style="display:flex;"><span>sudo usermod -aG etcd etcd
</span></span></code></pre></div><p>Fourth, install etcd as a service:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo systemctl daemon-reload
</span></span><span style="display:flex;"><span>sudo systemctl enable etcd
</span></span><span style="display:flex;"><span>sudo systemctl stop etcd
</span></span><span style="display:flex;"><span>sudo systemctl start etcd.service
</span></span><span style="display:flex;"><span>systemctl status etcd.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Check for logs</span>
</span></span><span style="display:flex;"><span>journalctl -xeu etcd
</span></span></code></pre></div><p>Fifth, ssh into other master nodes (verify that step 1 is done by <em>etcd &ndash;version</em>) and perform the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ssh ubuntu@master2
</span></span><span style="display:flex;"><span>sudo vi /lib/systemd/system/etcd.service
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-vim" data-lang="vim"><span style="display:flex;"><span># <span style="color:#a6e22e">Variations</span> <span style="color:#a6e22e">for</span> <span style="color:#a6e22e">step</span> <span style="color:#ae81ff">2</span> <span style="color:#a6e22e">for</span> <span style="color:#a6e22e">master2</span>
</span></span><span style="display:flex;"><span># <span style="color:#a6e22e">Inserts</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">following</span> <span style="color:#a6e22e">into</span> <span style="color:#a6e22e">etcd</span>.<span style="color:#a6e22e">service</span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">Unit</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Description</span>=<span style="color:#a6e22e">etcd</span> <span style="color:#a6e22e">key</span>-<span style="color:#a6e22e">value</span> <span style="color:#a6e22e">store</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Documentation</span>=<span style="color:#a6e22e">https</span>:<span style="color:#e6db74">//</span><span style="color:#a6e22e">etcd</span>.<span style="color:#a6e22e">io</span><span style="color:#e6db74">/docs/</span><span style="color:#a6e22e">v3</span>.<span style="color:#ae81ff">4</span>.<span style="color:#ae81ff">0</span>/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">Service</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">User</span>=<span style="color:#a6e22e">etcd</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Type</span>=<span style="color:#a6e22e">notify</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_UNSUPPORTED_ARCH</span>=<span style="color:#a6e22e">arm64</span>
</span></span><span style="display:flex;"><span>#<span style="color:#a6e22e">Loggingg</span> <span style="color:#a6e22e">flags</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_LOGGER</span>=<span style="color:#a6e22e">zap</span>
</span></span><span style="display:flex;"><span># <span style="color:#a6e22e">Member</span> <span style="color:#a6e22e">flags</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_NAME</span>=<span style="color:#a6e22e">infra2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_DATA_DIR</span>=<span style="color:#e6db74">/var/</span><span style="color:#a6e22e">lib</span>/<span style="color:#a6e22e">etcd</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_LISTEN_PEER_URLS</span>=<span style="color:#a6e22e">https</span>:<span style="color:#e6db74">//</span><span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">173</span>:<span style="color:#ae81ff">2380</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_LISTEN_CLIENT_URLS</span>=<span style="color:#a6e22e">https</span>:<span style="color:#e6db74">//</span><span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">173</span>:<span style="color:#ae81ff">2379</span>,<span style="color:#a6e22e">https</span>:<span style="color:#e6db74">//</span><span style="color:#ae81ff">127</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">2379</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_HEARTBEAT_INTERVAL</span>=<span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_ELECTION_TIMEOUT</span>=<span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span># <span style="color:#a6e22e">Clustering</span> <span style="color:#a6e22e">flags</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_INITIAL_ADVERTISE_PEER_URLS</span>=<span style="color:#a6e22e">https</span>:<span style="color:#e6db74">//</span><span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">173</span>:<span style="color:#ae81ff">2380</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_INITIAL_CLUSTER_TOKEN</span>=<span style="color:#a6e22e">etcd</span>-<span style="color:#a6e22e">cluster</span><span style="color:#ae81ff">-1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_INITIAL_CLUSTER</span>=<span style="color:#a6e22e">infra1</span>=<span style="color:#a6e22e">https</span>:<span style="color:#e6db74">//</span><span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">119</span>:<span style="color:#ae81ff">2380</span>,<span style="color:#a6e22e">infra2</span>=<span style="color:#a6e22e">https</span>:<span style="color:#e6db74">//</span><span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">173</span>:<span style="color:#ae81ff">2380</span>,<span style="color:#a6e22e">infra3</span>=<span style="color:#a6e22e">https</span>:<span style="color:#e6db74">//</span><span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">100</span>:<span style="color:#ae81ff">2380</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_INITIAL_CLUSTER_STATE</span>=<span style="color:#a6e22e">new</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_ADVERTISE_CLIENT_URLS</span>=<span style="color:#a6e22e">https</span>:<span style="color:#e6db74">//</span><span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">173</span>:<span style="color:#ae81ff">2379</span>
</span></span><span style="display:flex;"><span># <span style="color:#a6e22e">Security</span> <span style="color:#a6e22e">flags</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_CLIENT_CERT_AUTH</span>=<span style="color:#a6e22e">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_TRUSTED_CA_FILE</span>=<span style="color:#e6db74">/srv/</span><span style="color:#a6e22e">etcd</span>-<span style="color:#a6e22e">certs</span>/<span style="color:#a6e22e">cacert</span>.<span style="color:#a6e22e">pem</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_CERT_FILE</span>=<span style="color:#e6db74">/srv/</span><span style="color:#a6e22e">etcd</span>-<span style="color:#a6e22e">certs</span>/<span style="color:#a6e22e">etcd</span>.<span style="color:#a6e22e">pem</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_KEY_FILE</span>=<span style="color:#e6db74">/srv/</span><span style="color:#a6e22e">etcd</span>-<span style="color:#a6e22e">certs</span>/<span style="color:#a6e22e">etcd</span>-<span style="color:#a6e22e">key</span>.<span style="color:#a6e22e">pem</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_PEER_CLIENT_CERT_AUTH</span>=<span style="color:#a6e22e">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_PEER_TRUSTED_CA_FILE</span>=<span style="color:#e6db74">/srv/</span><span style="color:#a6e22e">etcd</span>-<span style="color:#a6e22e">certs</span>/<span style="color:#a6e22e">cacert</span>.<span style="color:#a6e22e">pem</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_PEER_CERT_FILE</span>=<span style="color:#e6db74">/srv/</span><span style="color:#a6e22e">etcd</span>-<span style="color:#a6e22e">certs</span>/<span style="color:#a6e22e">peer</span>-<span style="color:#a6e22e">etcd</span>.<span style="color:#a6e22e">pem</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_PEER_KEY_FILE</span>=<span style="color:#e6db74">/srv/</span><span style="color:#a6e22e">etcd</span>-<span style="color:#a6e22e">certs</span>/<span style="color:#a6e22e">peer</span>-<span style="color:#a6e22e">etcd</span>-<span style="color:#a6e22e">key</span>.<span style="color:#a6e22e">pem</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ExecStart</span>=<span style="color:#e6db74">/usr/</span><span style="color:#a6e22e">local</span><span style="color:#e6db74">/bin/</span><span style="color:#a6e22e">etcd</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Restart</span>=<span style="color:#a6e22e">always</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RestartSec</span>=<span style="color:#ae81ff">10</span>s
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">LimitNOFILE</span>=<span style="color:#ae81ff">40000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">Install</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">WantedBy</span>=<span style="color:#a6e22e">multi</span>-<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">target</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ssh ubuntu@master3
</span></span><span style="display:flex;"><span>sudo vi /lib/systemd/system/etcd.service
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-vim" data-lang="vim"><span style="display:flex;"><span># <span style="color:#a6e22e">Variations</span> <span style="color:#a6e22e">for</span> <span style="color:#a6e22e">step</span> <span style="color:#ae81ff">2</span> <span style="color:#a6e22e">for</span> <span style="color:#a6e22e">master3</span>
</span></span><span style="display:flex;"><span># <span style="color:#a6e22e">Inserts</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">following</span> <span style="color:#a6e22e">into</span> <span style="color:#a6e22e">etcd</span>.<span style="color:#a6e22e">service</span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">Unit</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Description</span>=<span style="color:#a6e22e">etcd</span> <span style="color:#a6e22e">key</span>-<span style="color:#a6e22e">value</span> <span style="color:#a6e22e">store</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Documentation</span>=<span style="color:#a6e22e">https</span>:<span style="color:#e6db74">//</span><span style="color:#a6e22e">etcd</span>.<span style="color:#a6e22e">io</span><span style="color:#e6db74">/docs/</span><span style="color:#a6e22e">v3</span>.<span style="color:#ae81ff">4</span>.<span style="color:#ae81ff">0</span>/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">Service</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">User</span>=<span style="color:#a6e22e">etcd</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Type</span>=<span style="color:#a6e22e">notify</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_UNSUPPORTED_ARCH</span>=<span style="color:#a6e22e">arm64</span>
</span></span><span style="display:flex;"><span>#<span style="color:#a6e22e">Loggingg</span> <span style="color:#a6e22e">flags</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_LOGGER</span>=<span style="color:#a6e22e">zap</span>
</span></span><span style="display:flex;"><span># <span style="color:#a6e22e">Member</span> <span style="color:#a6e22e">flags</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_NAME</span>=<span style="color:#a6e22e">infra3</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_DATA_DIR</span>=<span style="color:#e6db74">/var/</span><span style="color:#a6e22e">lib</span>/<span style="color:#a6e22e">etcd</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_LISTEN_PEER_URLS</span>=<span style="color:#a6e22e">https</span>:<span style="color:#e6db74">//</span><span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">100</span>:<span style="color:#ae81ff">2380</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_LISTEN_CLIENT_URLS</span>=<span style="color:#a6e22e">https</span>:<span style="color:#e6db74">//</span><span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">100</span>:<span style="color:#ae81ff">2379</span>,<span style="color:#a6e22e">https</span>:<span style="color:#e6db74">//</span><span style="color:#ae81ff">127</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">2379</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_HEARTBEAT_INTERVAL</span>=<span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_ELECTION_TIMEOUT</span>=<span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span># <span style="color:#a6e22e">Clustering</span> <span style="color:#a6e22e">flags</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_INITIAL_ADVERTISE_PEER_URLS</span>=<span style="color:#a6e22e">https</span>:<span style="color:#e6db74">//</span><span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">100</span>:<span style="color:#ae81ff">2380</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_INITIAL_CLUSTER_TOKEN</span>=<span style="color:#a6e22e">etcd</span>-<span style="color:#a6e22e">cluster</span><span style="color:#ae81ff">-1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_INITIAL_CLUSTER</span>=<span style="color:#a6e22e">infra1</span>=<span style="color:#a6e22e">https</span>:<span style="color:#e6db74">//</span><span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">119</span>:<span style="color:#ae81ff">2380</span>,<span style="color:#a6e22e">infra2</span>=<span style="color:#a6e22e">https</span>:<span style="color:#e6db74">//</span><span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">173</span>:<span style="color:#ae81ff">2380</span>,<span style="color:#a6e22e">infra3</span>=<span style="color:#a6e22e">https</span>:<span style="color:#e6db74">//</span><span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">100</span>:<span style="color:#ae81ff">2380</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_INITIAL_CLUSTER_STATE</span>=<span style="color:#a6e22e">new</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_ADVERTISE_CLIENT_URLS</span>=<span style="color:#a6e22e">https</span>:<span style="color:#e6db74">//</span><span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">100</span>:<span style="color:#ae81ff">2379</span>
</span></span><span style="display:flex;"><span># <span style="color:#a6e22e">Security</span> <span style="color:#a6e22e">flags</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_CLIENT_CERT_AUTH</span>=<span style="color:#a6e22e">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_TRUSTED_CA_FILE</span>=<span style="color:#e6db74">/srv/</span><span style="color:#a6e22e">etcd</span>-<span style="color:#a6e22e">certs</span>/<span style="color:#a6e22e">cacert</span>.<span style="color:#a6e22e">pem</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_CERT_FILE</span>=<span style="color:#e6db74">/srv/</span><span style="color:#a6e22e">etcd</span>-<span style="color:#a6e22e">certs</span>/<span style="color:#a6e22e">etcd</span>.<span style="color:#a6e22e">pem</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_KEY_FILE</span>=<span style="color:#e6db74">/srv/</span><span style="color:#a6e22e">etcd</span>-<span style="color:#a6e22e">certs</span>/<span style="color:#a6e22e">etcd</span>-<span style="color:#a6e22e">key</span>.<span style="color:#a6e22e">pem</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_PEER_CLIENT_CERT_AUTH</span>=<span style="color:#a6e22e">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_PEER_TRUSTED_CA_FILE</span>=<span style="color:#e6db74">/srv/</span><span style="color:#a6e22e">etcd</span>-<span style="color:#a6e22e">certs</span>/<span style="color:#a6e22e">cacert</span>.<span style="color:#a6e22e">pem</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_PEER_CERT_FILE</span>=<span style="color:#e6db74">/srv/</span><span style="color:#a6e22e">etcd</span>-<span style="color:#a6e22e">certs</span>/<span style="color:#a6e22e">peer</span>-<span style="color:#a6e22e">etcd</span>.<span style="color:#a6e22e">pem</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_PEER_KEY_FILE</span>=<span style="color:#e6db74">/srv/</span><span style="color:#a6e22e">etcd</span>-<span style="color:#a6e22e">certs</span>/<span style="color:#a6e22e">peer</span>-<span style="color:#a6e22e">etcd</span>-<span style="color:#a6e22e">key</span>.<span style="color:#a6e22e">pem</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ExecStart</span>=<span style="color:#e6db74">/usr/</span><span style="color:#a6e22e">local</span><span style="color:#e6db74">/bin/</span><span style="color:#a6e22e">etcd</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Restart</span>=<span style="color:#a6e22e">always</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RestartSec</span>=<span style="color:#ae81ff">10</span>s
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">LimitNOFILE</span>=<span style="color:#ae81ff">40000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">Install</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">WantedBy</span>=<span style="color:#a6e22e">multi</span>-<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">target</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># Follows step 3</span>
</span></span><span style="display:flex;"><span>sudo mkdir -p /var/lib/etcd
</span></span><span style="display:flex;"><span>sudo chmod -R <span style="color:#ae81ff">700</span> /var/lib/etcd
</span></span><span style="display:flex;"><span>sudo adduser --system etcd
</span></span><span style="display:flex;"><span>sudo addgroup etcd
</span></span><span style="display:flex;"><span>sudo usermod -aG etcd etcd
</span></span><span style="display:flex;"><span>sudo mkdir -p /srv/etcd-certs/
</span></span><span style="display:flex;"><span>sudo mv ~/*.csr ~/*.pem /srv/etcd-certs/
</span></span><span style="display:flex;"><span>sudo chown -R etcd:etcd /srv/etcd-certs/ /var/lib/etcd /usr/local/bin/etcd /usr/local/bin/etcdctl
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># Follows step 4</span>
</span></span><span style="display:flex;"><span>sudo systemctl daemon-reload
</span></span><span style="display:flex;"><span>sudo systemctl enable etcd
</span></span><span style="display:flex;"><span>sudo systemctl start etcd
</span></span><span style="display:flex;"><span>sudo systemctl stop etcd
</span></span><span style="display:flex;"><span>systemctl status etcd
</span></span></code></pre></div><p>Finally, by following etcd [security]https://etcd.io/docs/v3.4.0/op-guide/security/) guide, I test my etcd setup using:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo curl -k -L https://localhost:2379/metrics --cacert /srv/etcd-certs/cacert.pem --cert /srv/etcd-certs/etcd.pem  --key /srv/etcd-certs/etcd-key.pem | grep -v debugging
</span></span><span style="display:flex;"><span>sudo etcdctl --cacert /srv/etcd-certs/cacert.pem --cert /srv/etcd-certs/etcd.pem  --key /srv/etcd-certs/etcd-key.pem member list
</span></span></code></pre></div><h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="request-sent-was-ignored-by-remote-peer-due-to-cluster-id-mismatch">Request sent was ignored by remote peer due to cluster ID mismatch</h3>
<p>I solved mine by changing ETCD_INITIAL_CLUSTER_TOKEN=[something else]. You can check the end point health.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo etcdctl --endpoints<span style="color:#f92672">=</span>https://cluster-endpoint:2379 --cacert<span style="color:#f92672">=</span>/srv/etcd-certs/cacert.pem --cert<span style="color:#f92672">=</span>/srv/etcd-certs/etcd.pem --key<span style="color:#f92672">=</span>/srv/etcd-certs/etcd-key.pem endpoint health
</span></span></code></pre></div><p>If it still fails, you may try to re-create the folder by:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo rm -rf /var/lib/etcd <span style="color:#f92672">&amp;&amp;</span> sudo mkdir -p /var/lib/etcd
</span></span><span style="display:flex;"><span>sudo chown -R etcd:etcd /var/lib/etcd <span style="color:#f92672">&amp;&amp;</span> sudo chmod -R <span style="color:#ae81ff">700</span> /var/lib/etcd
</span></span></code></pre></div><h3 id="errorthere-is-already-a-certificate-for-csgstsgoseehiongcn192168100119">ERROR:There is already a certificate for /C=SG/ST=SG/O=seehiong/CN=192.168.100.119</h3>
<p>You may try to revoke the old certificate and sign the CSR again:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>openssl ca -revoke /root/ca/newcerts/1240.pem
</span></span></code></pre></div><h3 id="replacing-a-faulty-member">Replacing a faulty member</h3>
<p>You may have to re-configure your etcd cluster when your SD card failed</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># Get member list</span>
</span></span><span style="display:flex;"><span>sudo etcdctl --cacert /srv/etcd-certs/cacert.pem --cert /srv/etcd-certs/etcd.pem  --key /srv/etcd-certs/etcd-key.pem member list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Delete the member based on the ID</span>
</span></span><span style="display:flex;"><span>sudo etcdctl --cacert /srv/etcd-certs/cacert.pem --cert /srv/etcd-certs/etcd.pem  --key /srv/etcd-certs/etcd-key.pem member remove 34ef554257cff34e
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Add the previous member (previous settings remain the same, e.g. IP address)</span>
</span></span><span style="display:flex;"><span>sudo etcdctl --cacert /srv/etcd-certs/cacert.pem --cert /srv/etcd-certs/etcd.pem  --key /srv/etcd-certs/etcd-key.pem member add infra3 --peer-urls<span style="color:#f92672">=</span>https://192.168.100.182:2380
</span></span></code></pre></div><p>Similar message as this will appear:</p>
<p><img src="/images/ha-k8s1/add-new-etcd-member.png" alt="add-new-etcd-member"></p>
<hr>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo vi /lib/systemd/system/etcd.service
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-vim" data-lang="vim"><span style="display:flex;"><span># <span style="color:#a6e22e">Make</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">following</span> <span style="color:#a6e22e">changes</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_INITIAL_CLUSTER_STATE</span>=<span style="color:#a6e22e">existing</span>
</span></span><span style="display:flex;"><span># <span style="color:#a6e22e">Add</span> <span style="color:#a6e22e">new</span> <span style="color:#a6e22e">configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Environment</span>=<span style="color:#a6e22e">ETCD_INITIAL_CLUSTER</span>=<span style="color:#e6db74">&#34;infra2=https://192.168.100.181:2380,infra3=https://192.168.100.182:2380,infra1=https://192.168.100.180:2380&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># Restart etcd</span>
</span></span><span style="display:flex;"><span>sudo systemctl daemon-reload
</span></span><span style="display:flex;"><span>sudo systemctl start etcd
</span></span></code></pre></div>
  
  <hr>
<div class="footer">
    
    
    
    <p>
    This is a post in the <b><a href="https://seehiong.github.io/series/ha-k8s-pi-cluster">HA K8s Pi Cluster</a></b> series.
        <br>Other posts in this series:
        <ul class="series">
            
            
            
            <li>
                August 17, 2020 -
                
                    <a href="/archives/2020/highly-available-kubernetes-pi-cluster-part-2/">HA K8s Pi Cluster (II)</a>
                
            </li>
            
            <li>
                August 9, 2020 -
                
                    HA K8s Pi Cluster (I)
                
            </li>
            
        </ul>
    </p>
    
</div>

  
    <div class="comments">
    
        <div style="clear: both;">
            <br>
            <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "seehiong" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>
    
</div>

  
</div>
            </main>
            
  
    <div class="article-toc ">
    <div class="toc-wrapper">
      <h4 id="contents"></h4>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#preparing-os">Preparing OS</a></li>
    <li><a href="#creating-virtual-ip">Creating Virtual IP</a></li>
    <li><a href="#preparing-certs-for-etcd">Preparing certs for etcd</a></li>
    <li><a href="#setting-up-etcd">Setting up etcd</a></li>
    <li><a href="#troubleshooting">Troubleshooting</a>
      <ul>
        <li><a href="#request-sent-was-ignored-by-remote-peer-due-to-cluster-id-mismatch">Request sent was ignored by remote peer due to cluster ID mismatch</a></li>
        <li><a href="#errorthere-is-already-a-certificate-for-csgstsgoseehiongcn192168100119">ERROR:There is already a certificate for /C=SG/ST=SG/O=seehiong/CN=192.168.100.119</a></li>
        <li><a href="#replacing-a-faulty-member">Replacing a faulty member</a></li>
      </ul>
    </li>
  </ul>
</nav>

      
        <hr>
        
              <div class="previous-post">
                <a href="https://seehiong.github.io/archives/2020/private-registry-for-kubernetes-cluster/?ref=footer"><span style="font-weight:bold;"> Previous</span><br>Private Registry for K8s Cluster</a>
              </div>
              <br><br>
          
        
              <div class="next-post">
                  <a href="https://seehiong.github.io/archives/2020/highly-available-kubernetes-pi-cluster-part-2/?ref=footer"><span style="font-weight:bold;">Next </span><br>HA K8s Pi Cluster (II)</a>
              </div>
          
      
    </div>
</div>
  

        </div>
    </body>
</html>


<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  
      inlineMath: [['\\(', '\\)']]                  
    }
  };
</script>
