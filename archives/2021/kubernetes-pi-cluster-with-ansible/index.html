<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
    




    







<script defer language="javascript" type="text/javascript" src="/js/bundle.min.b989f0fdae3971a3effd81d6d0b27b3cb1023ff0b601ff43e2118b0d9d82ddb9.js"></script>





  
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-5PNPM4HWQ0"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-5PNPM4HWQ0');
        }
      </script>

    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    <link rel="icon" href=/favicon.png>

    
    





  





  
  
  


<!-- Open Graph image and Twitter Card metadata -->

<title itemprop="name">Tech Blog - K8s Pi Cluster with Ansible</title>
<meta property="og:title" content=Tech&#32;Blog&#32;-&#32;K8s&#32;Pi&#32;Cluster&#32;with&#32;Ansible />
<meta name="twitter:title" content=Tech&#32;Blog&#32;-&#32;K8s&#32;Pi&#32;Cluster&#32;with&#32;Ansible />
<meta itemprop="name" content=Tech&#32;Blog&#32;-&#32;K8s&#32;Pi&#32;Cluster&#32;with&#32;Ansible />
<meta name="application-name" content=Tech&#32;Blog&#32;-&#32;K8s&#32;Pi&#32;Cluster&#32;with&#32;Ansible />
<meta property="og:site_name" content="See Hiong&#39;s Blog" />


<meta name="description" content="I documented my journey configuring a Kubernetes Cluster on a Raspberry Pi using Ansible, totaling 50 minutes. I deployed three Raspberry Pi 4 Model B 8GB as master nodes and one Raspberry Pi 3 Model B as a worker. After installing Ansible, Flash, and kubectl, I prepared the SD cards with customized cloud-config.yml files. Ansible inventory was configured accordingly. Additional SSH and system adjustments were made on each node. Customizations were applied, and the Kubernetes cluster setup was initiated using the Ansible playbook. Troubleshooting tips were provided for potential issues. Finally, the Kubernetes Pi Cluster with Ansible was ready for use." />
<meta itemprop="description" content="I documented my journey configuring a Kubernetes Cluster on a Raspberry Pi using Ansible, totaling 50 minutes. I deployed three Raspberry Pi 4 Model B 8GB as master nodes and one Raspberry Pi 3 Model B as a worker. After installing Ansible, Flash, and kubectl, I prepared the SD cards with customized cloud-config.yml files. Ansible inventory was configured accordingly. Additional SSH and system adjustments were made on each node. Customizations were applied, and the Kubernetes cluster setup was initiated using the Ansible playbook. Troubleshooting tips were provided for potential issues. Finally, the Kubernetes Pi Cluster with Ansible was ready for use." />
<meta property="og:description" content="I documented my journey configuring a Kubernetes Cluster on a Raspberry Pi using Ansible, totaling 50 minutes. I deployed three Raspberry Pi 4 Model B 8GB as master nodes and one Raspberry Pi 3 Model B as a worker. After installing Ansible, Flash, and kubectl, I prepared the SD cards with customized cloud-config.yml files. Ansible inventory was configured accordingly. Additional SSH and system adjustments were made on each node. Customizations were applied, and the Kubernetes cluster setup was initiated using the Ansible playbook. Troubleshooting tips were provided for potential issues. Finally, the Kubernetes Pi Cluster with Ansible was ready for use." />
<meta name="twitter:description" content="I documented my journey configuring a Kubernetes Cluster on a Raspberry Pi using Ansible, totaling 50 minutes. I deployed three Raspberry Pi 4 Model B 8GB as master nodes and one Raspberry Pi 3 Model B as a worker. After installing Ansible, Flash, and kubectl, I prepared the SD cards with customized cloud-config.yml files. Ansible inventory was configured accordingly. Additional SSH and system adjustments were made on each node. Customizations were applied, and the Kubernetes cluster setup was initiated using the Ansible playbook. Troubleshooting tips were provided for potential issues. Finally, the Kubernetes Pi Cluster with Ansible was ready for use." />


<base href="https://seehiong.github.io/archives/2021/kubernetes-pi-cluster-with-ansible/" />
<link rel="canonical" href="https://seehiong.github.io/archives/2021/kubernetes-pi-cluster-with-ansible/" itemprop="url" />
<meta name="url" content="https://seehiong.github.io/archives/2021/kubernetes-pi-cluster-with-ansible/" />
<meta name="twitter:url" content="https://seehiong.github.io/archives/2021/kubernetes-pi-cluster-with-ansible/" />
<meta property="og:url" content="https://seehiong.github.io/archives/2021/kubernetes-pi-cluster-with-ansible/" />


<meta property="og:updated_time" content="2021-05-29T20:00:00&#43;08:00" />


<link rel="sitemap" type="application/xml" title="Sitemap" href='https://seehiong.github.io/sitemap.xml' />

<meta name="robots" content="index,follow" />
<meta name="googlebot" content="index,follow" />



<meta property="fb:admins" content="" />


<meta name="apple-mobile-web-app-title" content="See Hiong&#39;s Blog" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />






<meta name="generator" content="Hugo 0.134.1">


    
    

<link type="text/css" rel="stylesheet" href="/css/bundle.min.03b57bbaf31d739f14c95df7f05d1cefcfa60bbafa36ba47313afdeb325aeada.css">


    
    <style>
    body {
        --sidebar-bg-color: #202020;
        --sidebar-img-border-color: #515151;
        --sidebar-p-color: #909090;
        --sidebar-h1-color: #FFF;
        --sidebar-a-color: #FFF;
        --sidebar-socials-color: #FFF;
        --text-color: #222;
        --bkg-color: #FAF9F6;
        --post-title-color: #303030;
        --list-color: #5a5a5a;
        --link-color: #268bd2;
        --date-color: #515151;
        --table-border-color: #E5E5E5;
        --table-stripe-color: #F9F9F9;
        --code-color: #000;
        --code-background-color: #E5E5E5;
        --code-block-color: #fff;
        --code-block-background-color: #272822;
        --moon-sun-color: #FFF;
        --moon-sun-background-color: #515151;
    }
    body.dark-theme {
        --text-color: #eee;
        --bkg-color: #121212;
        --post-title-color: #DBE2E9;
        --list-color: #9d9d9d;
        --link-color: #268bd2;
        --date-color: #9a9a9a;
        --table-border-color: #515151;
        --table-stripe-color: #202020;
        --code-color: #fff;
        --code-background-color: #515151;
        --code-block-color: #fff;
        --code-block-background-color: #272822;
    }
    body {
        background-color: var(--bkg-color);
    }
</style>

</head>

    <body class="dark-theme">
        <div class="wrapper">
            <aside class="sidebar">
    <div class="container sidebar-sticky">
        <div class="light-dark" align="right">
    <button class="btn-light-dark" title="Toggle light/dark mode">
        <svg class="moon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M6 .278a.768.768 0 0 1 .08.858a7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277c.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316a.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71C0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
        </svg>
        <svg class="sun" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M8 12a4 4 0 1 0 0-8a4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
        </svg>
    </button>
</div>

        <div class="sidebar-about">
    <h1 class="brand">
        
        
            <a href="https://seehiong.github.io/">
                <h1>Tech Blog</h1>
            </a>
        
    </h1>
    <p class="lead">
    Chronicling my personal expedition of technology exploration and experimentation, facilitated by a home-based self-configured laboratory
    </p>
</div>

        <link href="/pagefind/pagefind-ui.css" rel="stylesheet">
<style>
    :root {
        --pagefind-ui-primary: #eeeeee;
        --pagefind-ui-text: #eeeeee;
        --pagefind-ui-background: #152028;
        --pagefind-ui-border: #152028;
        --pagefind-ui-tag: #152028;
    }
</style>
<script src="/pagefind/pagefind-ui.js"></script>
<div style="max-width: 100%; margin: clamp(2px, 1vw, 10px) auto;">
    <div id="search"></div>
    <script>
        window.addEventListener('DOMContentLoaded', (event) => {
            new PagefindUI({ element: "#search", showSubResults: true, showImages: false });
        });
    </script>
</div>
        <nav>
    <ul class="sidebar-nav">

        
        
        
        
            

            
                
                
                    <li class="heading">
                        <a href="/2024/">2024</a>
                    </li>
                    
                        <li class="sub-heading">
                            Recent
                        </li>
                        
                            <li class="bullet">
                                <a href="https://seehiong.github.io/2024/integrating-mlflow-and-kubeflow-on-talos/">Integrating MLflow and Kubeflow on Talos</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://seehiong.github.io/2024/deploy-microservices-with-talos-locally/">Deploy Microservices with Talos Locally</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://seehiong.github.io/2024/controlling-roarm-m2-s-with-ros2/">Controlling RoArm-M2-S with ROS2</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://seehiong.github.io/2024/wave-rover-with-raspberry-pi-4/">Wave Rover with Raspberry Pi 4</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://seehiong.github.io/2024/wave-rover-setup-guide-and-troubleshooting-tips/">Wave Rover: Setup Guide and Troubleshooting Tips</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://seehiong.github.io/2024/talos-linux-setting-up-a-secure-immutable-kubernetes-cluster/">Talos Linux: Setting Up a Secure, Immutable Kubernetes Cluster</a>
                            </li>
                        
                    
                
            
                
                
            
                
                
            
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        
        
            

            
                
                
            
                
                
            
                
                
                    <li class="heading">
                        <a href="/archives/">Archives</a>
                    </li>
                    
                
            
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        
        
            

            
                
                
            
                
                
                    <li class="heading">
                        <a href="/about/">About</a>
                    </li>
                    
                
            
                
                
            
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        

    </ul>
</nav>

        
    <a target="_blank" class="social" title="GitHub" href="https://github.com/seehiong">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="-2 -2 24 24">
            <path fill="currentColor" d="M18.88 1.099C18.147.366 17.265 0 16.233 0H3.746C2.714 0 1.832.366 1.099 1.099C.366 1.832 0 2.714 0 3.746v12.487c0 1.032.366 1.914 1.099 2.647c.733.733 1.615 1.099 2.647 1.099H6.66c.19 0 .333-.007.429-.02a.504.504 0 0 0 .286-.169c.095-.1.143-.245.143-.435l-.007-.885c-.004-.564-.006-1.01-.006-1.34l-.3.052c-.19.035-.43.05-.721.046a5.555 5.555 0 0 1-.904-.091a2.026 2.026 0 0 1-.872-.39a1.651 1.651 0 0 1-.572-.8l-.13-.3a3.25 3.25 0 0 0-.41-.663c-.186-.243-.375-.407-.566-.494l-.09-.065a.956.956 0 0 1-.17-.156a.723.723 0 0 1-.117-.182c-.026-.061-.004-.111.065-.15c.07-.04.195-.059.378-.059l.26.04c.173.034.388.138.643.311a2.1 2.1 0 0 1 .631.677c.2.355.44.626.722.813c.282.186.566.28.852.28c.286 0 .533-.022.742-.065a2.59 2.59 0 0 0 .585-.196c.078-.58.29-1.028.637-1.34a8.907 8.907 0 0 1-1.333-.234a5.314 5.314 0 0 1-1.223-.507a3.5 3.5 0 0 1-1.047-.872c-.277-.347-.505-.802-.683-1.365c-.177-.564-.266-1.215-.266-1.952c0-1.049.342-1.942 1.027-2.68c-.32-.788-.29-1.673.091-2.652c.252-.079.625-.02 1.119.175c.494.195.856.362 1.086.5c.23.14.414.257.553.352a9.233 9.233 0 0 1 2.497-.338c.859 0 1.691.113 2.498.338l.494-.312a6.997 6.997 0 0 1 1.197-.572c.46-.174.81-.221 1.054-.143c.39.98.424 1.864.103 2.653c.685.737 1.028 1.63 1.028 2.68c0 .737-.089 1.39-.267 1.957c-.177.568-.407 1.023-.689 1.366a3.65 3.65 0 0 1-1.053.865c-.42.234-.828.403-1.223.507a8.9 8.9 0 0 1-1.333.235c.45.39.676 1.005.676 1.846v3.11c0 .147.021.266.065.357a.36.36 0 0 0 .208.189c.096.034.18.056.254.064c.074.01.18.013.318.013h2.914c1.032 0 1.914-.366 2.647-1.099c.732-.732 1.099-1.615 1.099-2.647V3.746c0-1.032-.367-1.914-1.1-2.647z"/>
        </svg>
    </a>

















    <a target="_blank" class="social" title="RSS Feed" href="/2024/index.xml">
        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 1280.000000 1280.000000">
            <g transform="translate(0.000000,1280.000000) scale(0.100000,-0.100000)" fill="currentColor">
                <path d="M2295 11929 c-284 -12 -642 -45 -707 -65 -17 -5 -18 -63 -18 -1039 0 -569 4 -1036 8 -1039 5 -3 74 6 153 19 510 86 1168 95 1789 25 1348 -153 2602 -677 3670 -1531 385 -308 820 -744 1126 -1129 842 -1060 1362 -2313 1514 -3650 70 -621 61 -1279 -25 -1789 -13 -79 -22 -148 -19 -153 3 -4 471 -8 1039 -8 l1035 0 5 23 c51 225 85 942 67 1419 -23 605 -77 1044 -198 1617 -294 1400 -927 2734 -1823 3846 -1043 1295 -2364 2259 -3909 2854 -1158 447 -2451 656 -3707 600z"/>
                <path d="M2255 7845 c-269 -25 -620 -81 -667 -106 -17 -9 -18 -55 -18 -899 0 -706 3 -890 13 -890 6 0 66 18 132 41 130 44 288 79 467 105 154 21 577 30 749 15 1207 -107 2267 -823 2814 -1902 166 -327 268 -637 330 -1001 38 -227 48 -384 42 -662 -8 -348 -44 -590 -126 -831 -23 -66 -41 -126 -41 -132 0 -10 184 -13 890 -13 844 0 890 1 899 18 27 50 88 452 110 725 14 162 14 624 1 782 -59 703 -233 1323 -545 1945 -481 956 -1313 1788 -2270 2268 -620 310 -1239 483 -1940 542 -165 14 -669 10 -840 -5z"/>
                <path d="M2519 3815 c-391 -66 -725 -336 -868 -703 -79 -201 -96 -462 -45 -677 83 -344 338 -641 666 -774 116 -47 205 -69 330 -80 412 -39 811 153 1040 500 193 292 240 648 128 981 -135 403 -492 699 -914 757 -100 14 -241 12 -337 -4z"/>
            </g>
        </svg>
    </a>





        <p class="footnote">
powered by <a target="_blank" href="https://gohugo.io">Hugo</a> | themed with <a target="_blank" href="https://github.com/lukeorth/poison">poison</a>
    <br>
    &copy; 2024 See Hiong&#39;s Blog. All rights reserved.
</p>

  </div>
</aside>

            <main class="content container">
                <div class="post" data-pagefind-body>
  <div class="info">
  <h1 class="post-title">
    <a href="https://seehiong.github.io/archives/2021/kubernetes-pi-cluster-with-ansible/">K8s Pi Cluster with Ansible</a>
  </h1>

  <div class="headline" data-pagefind-ignore>
    <div>
      
      
      <time datetime=" 2021-05-29T20:00:00&#43;0800" class="post-date">
        May 29, 2021
      </time>
      
      <span> - </span>
      <span class="reading-time">
        
          
        

        <span>3 mins read</span>
      </span>
    </div>

    
    <ul class="tags">
      
      <li class="tag-Raspberry Pi">
        <a href="https://seehiong.github.io/tags/raspberry-pi">Raspberry Pi</a>
      </li>
      
      <li class="tag-K8s">
        <a href="https://seehiong.github.io/tags/k8s">K8s</a>
      </li>
      
      <li class="tag-Cluster">
        <a href="https://seehiong.github.io/tags/cluster">Cluster</a>
      </li>
      
      <li class="tag-Ansible">
        <a href="https://seehiong.github.io/tags/ansible">Ansible</a>
      </li>
      
      <li class="tag-Raspbernetes">
        <a href="https://seehiong.github.io/tags/raspbernetes">Raspbernetes</a>
      </li>
      
    </ul>
    
  </div>

  
  

  
</div>

  <p><img src="/images/ansible/highly-available-kubernetes-pi-cluster.png" alt="highly-available-kubernetes-pi-cluster"></p>
<p>By provisioning a Kubernetes PI Cluster with Ansible, you can easily spin off a Raspberry PI cluster</p>
<hr>
<h1 id="kubernetes-cluster-with-ansible">Kubernetes Cluster with Ansible</h1>
<p><em>(Total Setup Time: 50 mins)</em></p>
<p>In this guide, I will configure a Kubernetes Cluster using <a href="https://www.ansible.com/" target="_blank">Ansible</a>. This guide follows closely to the <a href="https://github.com/raspbernetes/k8s-cluster-installation" target="_blank">Raspbernetes Cluster Installation</a>. I will be using 3x Raspberry Pi 4 Model B 8GB as the master nodes and 1x Raspberry Pi 3 Model B as the only worker node.</p>
<p>You need to install <a href="https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html#installing-ansible-on-ubuntu" target="_blank">ansible</a>, <a href="https://github.com/hypriot/flash" target="_blank">flash</a> and <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/" target="_blank">kubectl</a>. I installed both Ansible and Flash onto my <a href="https://elementary.io/" target="_blank">elementary OS</a> host by:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#Installing Ansible</span>
</span></span><span style="display:flex;"><span>sudo apt update
</span></span><span style="display:flex;"><span>sudo apt install software-properties-common
</span></span><span style="display:flex;"><span>sudo add-apt-repository --yes --update ppa:ansible/ansible
</span></span><span style="display:flex;"><span>sudo apt install ansible
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Installing Flash</span>
</span></span><span style="display:flex;"><span>curl -LO https://github.com/hypriot/flash/releases/download/2.7.0/flash
</span></span><span style="display:flex;"><span>cdmod +x flash
</span></span><span style="display:flex;"><span>sudo mv flash /usr/local/bin/flash
</span></span><span style="display:flex;"><span>sudo apt-get install -y pv curl python-pip unzip hdparm
</span></span><span style="display:flex;"><span>sudo pip install awscli
</span></span></code></pre></div><h2 id="preparation">Preparation</h2>
<p><em>(20 mins)</em></p>
<p>Firstly, downloads the Ubuntu 20.04 image and unzips it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>curl -L <span style="color:#e6db74">&#34;http://cdimage.ubuntu.com/releases/20.04.2/release/ubuntu-20.04.2-preinstalled-server-arm64+raspi.img.xz&#34;</span> -o ~/Downloads/ubuntu-20.04.2-preinstalled-server-arm64+raspi.img.xz
</span></span><span style="display:flex;"><span>unxz -T <span style="color:#ae81ff">0</span> ~/Downloads/ubuntu-20.04.2-preinstalled-server-arm64+raspi.img.xz
</span></span></code></pre></div><p>Secondly, clones the <a href="https://github.com/raspbernetes/k8s-cluster-installation" target="_blank">Raspbernetes repository</a> and makes the necessary changes (hostname, users.name, ssh_authorized_keys, etho0.addresses and gateway4) to the cloud-init file. I have created 4x cloud-config.yml for each of the 64GB SD card:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>git clone https://github.com/raspbernetes/k8s-cluster-installation.git
</span></span><span style="display:flex;"><span>cd k8s-cluster-installation
</span></span><span style="display:flex;"><span>vi setup/cloud-config.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Create the 4x SD cards ubuntu image using Flash</span>
</span></span><span style="display:flex;"><span>sudo flash --userdata cloud-config.yml ~/Downloads/ubuntu-20.04.2-preinstalled-server-arm64+raspi.img
</span></span></code></pre></div><p>Thirdly, ensures that Ansible inventory is changed according to hostname, username and IP addresses for each SD card.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vi ansible/inventory
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-vim" data-lang="vim"><span style="display:flex;"><span>#<span style="color:#a6e22e">My</span> <span style="color:#a6e22e">setup</span> <span style="color:#a6e22e">as</span> <span style="color:#a6e22e">reference</span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">masters</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">master1</span> <span style="color:#a6e22e">hostname</span>=<span style="color:#a6e22e">master1</span> <span style="color:#a6e22e">ansible_host</span>=<span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">180</span> <span style="color:#a6e22e">ansible_user</span>=<span style="color:#a6e22e">ubuntu</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">master2</span> <span style="color:#a6e22e">hostname</span>=<span style="color:#a6e22e">master2</span> <span style="color:#a6e22e">ansible_host</span>=<span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">181</span> <span style="color:#a6e22e">ansible_user</span>=<span style="color:#a6e22e">ubuntu</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">master3</span> <span style="color:#a6e22e">hostname</span>=<span style="color:#a6e22e">master3</span> <span style="color:#a6e22e">ansible_host</span>=<span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">182</span> <span style="color:#a6e22e">ansible_user</span>=<span style="color:#a6e22e">ubuntu</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">workers</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">worker1</span> <span style="color:#a6e22e">hostname</span>=<span style="color:#a6e22e">worker1</span> <span style="color:#a6e22e">ansible_host</span>=<span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">188</span> <span style="color:#a6e22e">ansible_user</span>=<span style="color:#a6e22e">ubuntu</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#<span style="color:#a6e22e">Ensures</span> <span style="color:#a6e22e">that</span> <span style="color:#a6e22e">you</span> <span style="color:#a6e22e">are</span> <span style="color:#a6e22e">able</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">ping</span> <span style="color:#a6e22e">all</span> <span style="color:#a6e22e">nodes</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">env</span> <span style="color:#a6e22e">ANSIBLE_CONFIG</span>=<span style="color:#a6e22e">ansible</span>/<span style="color:#a6e22e">ansible</span>.<span style="color:#a6e22e">cfg</span> <span style="color:#a6e22e">ansible</span> <span style="color:#a6e22e">all</span> -<span style="color:#a6e22e">m</span> <span style="color:#a6e22e">ping</span>
</span></span></code></pre></div><p>Fourthly, prior to the cluster setup, I ssh into each of the nodes and run the following.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ssh ubuntu@master1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo -i
</span></span><span style="display:flex;"><span>systemctl stop apt-daily.timer
</span></span><span style="display:flex;"><span>systemctl disable apt-daily.timer
</span></span><span style="display:flex;"><span>systemctl mask apt-daily.service
</span></span><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>reboot
</span></span></code></pre></div><p>These are some of my customizations:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-vim" data-lang="vim"><span style="display:flex;"><span># <span style="color:#a6e22e">group_vars</span>/<span style="color:#a6e22e">all</span>.<span style="color:#a6e22e">yml</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">26</span>: <span style="color:#a6e22e">keepalived_vip</span>: <span style="color:#e6db74">&#39;192.168.100.200&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">32</span>: <span style="color:#a6e22e">cri_plugin</span>: <span style="color:#a6e22e">docker</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">38</span>: <span style="color:#a6e22e">cni_plugin</span>: <span style="color:#e6db74">&#39;calico&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># <span style="color:#a6e22e">group_var</span>/<span style="color:#a6e22e">masters</span>.<span style="color:#a6e22e">yml</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">16</span>: <span style="color:#a6e22e">cluster_kube_proxy_enabled</span>:<span style="color:#a6e22e">true</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">23</span>: <span style="color:#a6e22e">cni_plugin</span>: <span style="color:#e6db74">&#39;calico&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># <span style="color:#a6e22e">roles</span><span style="color:#e6db74">/cluster/</span><span style="color:#a6e22e">defaults</span><span style="color:#e6db74">/main/</span><span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">yml</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">101</span>: <span style="color:#a6e22e">docker</span>: <span style="color:#e6db74">&#39;unix:///run/containerd/containerd.sock&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># <span style="color:#a6e22e">roles</span><span style="color:#e6db74">/clusters/</span><span style="color:#a6e22e">templates</span>/<span style="color:#a6e22e">kubeadm</span>-<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">yaml</span>.<span style="color:#a6e22e">j2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">25</span>: <span style="color:#a6e22e">criSocket</span>: <span style="color:#a6e22e">unix</span>:<span style="color:#e6db74">///run/</span><span style="color:#a6e22e">containerd</span>/<span style="color:#a6e22e">containerd</span>.<span style="color:#a6e22e">sock</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># <span style="color:#a6e22e">roles</span><span style="color:#e6db74">/clusters/</span><span style="color:#a6e22e">templates</span>/<span style="color:#a6e22e">kubeadm</span>-<span style="color:#a6e22e">join</span>.<span style="color:#a6e22e">yaml</span>.<span style="color:#a6e22e">j2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">26</span>: <span style="color:#a6e22e">criSocket</span>: <span style="color:#a6e22e">unix</span>:<span style="color:#e6db74">///run/</span><span style="color:#a6e22e">containerd</span>/<span style="color:#a6e22e">containerd</span>.<span style="color:#a6e22e">sock</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># <span style="color:#a6e22e">roles</span><span style="color:#e6db74">/cni/</span><span style="color:#a6e22e">defaults</span>/<span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">yml</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span>: <span style="color:#a6e22e">cni_bgp_peer_address</span>: <span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># <span style="color:#a6e22e">roles</span><span style="color:#e6db74">/common/</span><span style="color:#a6e22e">tasks</span>/<span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">yml</span> (<span style="color:#a6e22e">added</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">line</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>- <span style="color:#a6e22e">name</span>: <span style="color:#a6e22e">Bugfix</span> <span style="color:#a6e22e">for</span> <span style="color:#a6e22e">Ubuntu</span> <span style="color:#ae81ff">20</span>.<span style="color:#ae81ff">04</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">set_fact</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ansible_os_family</span>: <span style="color:#e6db74">&#34;debian&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># <span style="color:#a6e22e">roles</span><span style="color:#e6db74">/container-runtime/</span><span style="color:#a6e22e">containerd</span><span style="color:#e6db74">/defaults/</span><span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">yml</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">9</span>: <span style="color:#a6e22e">containerd_use_docker_repo</span>: <span style="color:#a6e22e">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># <span style="color:#a6e22e">roles</span><span style="color:#e6db74">/container-runtime/</span><span style="color:#a6e22e">containerd</span><span style="color:#e6db74">/defaults/</span><span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">yml</span> (<span style="color:#a6e22e">added</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">line</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span># <span style="color:#a6e22e">Instructions</span>: <span style="color:#a6e22e">https</span>:<span style="color:#e6db74">//</span><span style="color:#a6e22e">docs</span>.<span style="color:#a6e22e">docker</span>.<span style="color:#a6e22e">com</span><span style="color:#e6db74">/engine/</span><span style="color:#a6e22e">install</span><span style="color:#e6db74">/ubuntu/</span>#<span style="color:#a6e22e">install</span>-<span style="color:#a6e22e">using</span>-<span style="color:#a6e22e">the</span>-<span style="color:#a6e22e">repository</span>
</span></span><span style="display:flex;"><span>- <span style="color:#a6e22e">name</span>: <span style="color:#a6e22e">Add</span> <span style="color:#a6e22e">Docker</span>’<span style="color:#a6e22e">s</span> <span style="color:#a6e22e">official</span> <span style="color:#a6e22e">GPG</span> <span style="color:#a6e22e">key</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">apt_key</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">url</span>: <span style="color:#a6e22e">https</span>:<span style="color:#e6db74">//</span><span style="color:#a6e22e">download</span>.<span style="color:#a6e22e">docker</span>.<span style="color:#a6e22e">com</span><span style="color:#e6db74">/linux/</span><span style="color:#a6e22e">ubuntu</span>/<span style="color:#a6e22e">gpg</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">state</span>: <span style="color:#a6e22e">present</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>- <span style="color:#a6e22e">name</span>: <span style="color:#a6e22e">Add</span> <span style="color:#a6e22e">apt</span> <span style="color:#a6e22e">repository</span> <span style="color:#a6e22e">for</span> <span style="color:#a6e22e">Docker</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">apt_repository</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">repo</span>: <span style="color:#a6e22e">deb</span> [<span style="color:#a6e22e">arch</span>=<span style="color:#a6e22e">amd64</span> <span style="color:#a6e22e">signed</span>-<span style="color:#a6e22e">by</span>=<span style="color:#e6db74">/usr/</span><span style="color:#a6e22e">share</span><span style="color:#e6db74">/keyrings/</span><span style="color:#a6e22e">docker</span>-<span style="color:#a6e22e">archive</span>-<span style="color:#a6e22e">keyring</span>.<span style="color:#a6e22e">gpg</span>] <span style="color:#a6e22e">https</span>:<span style="color:#e6db74">//</span><span style="color:#a6e22e">download</span>.<span style="color:#a6e22e">docker</span>.<span style="color:#a6e22e">com</span><span style="color:#e6db74">/linux/</span><span style="color:#a6e22e">ubuntu</span> <span style="color:#a6e22e">focal</span> <span style="color:#a6e22e">stable</span>  
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">state</span>: <span style="color:#a6e22e">present</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">regiser</span>: <span style="color:#a6e22e">docker_repository</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">until</span>: <span style="color:#a6e22e">docker_repository</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">success</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span># <span style="color:#a6e22e">roles</span><span style="color:#e6db74">/container-runtime/</span><span style="color:#a6e22e">defaults</span>/<span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">yml</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>: <span style="color:#a6e22e">cri_plugin</span>: <span style="color:#e6db74">&#39;docker&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># <span style="color:#a6e22e">roles</span><span style="color:#e6db74">/container-runtime/</span><span style="color:#a6e22e">docker</span><span style="color:#e6db74">/defaults/</span><span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">yml</span> 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">12</span>: #- <span style="color:#a6e22e">docker</span>-<span style="color:#a6e22e">ce</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">13</span>: #- <span style="color:#a6e22e">docker</span>-<span style="color:#a6e22e">ce</span>-<span style="color:#a6e22e">cli</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">14</span>: #- <span style="color:#a6e22e">containerd</span>.<span style="color:#a6e22e">io</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">15</span>: - <span style="color:#a6e22e">docker</span>.<span style="color:#a6e22e">io</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># <span style="color:#a6e22e">roles</span><span style="color:#e6db74">/container-runtime/</span><span style="color:#a6e22e">vars</span>/<span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">yml</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">23</span>: <span style="color:#a6e22e">docker</span>: <span style="color:#e6db74">&#39;unix:///run/containerd/containerd.sock&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># <span style="color:#a6e22e">roles</span><span style="color:#e6db74">/haproxy/</span><span style="color:#a6e22e">templates</span>/<span style="color:#a6e22e">haproxy</span>.<span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">j2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">22</span>: <span style="color:#a6e22e">server</span> {{<span style="color:#a6e22e">hostvars</span>[<span style="color:#a6e22e">host</span>][<span style="color:#e6db74">&#39;hostname&#39;</span>] }} {{<span style="color:#a6e22e">hostvars</span>[<span style="color:#a6e22e">host</span>][<span style="color:#e6db74">&#39;ansible_host&#39;</span>] }}:<span style="color:#ae81ff">6433</span> <span style="color:#a6e22e">check</span>
</span></span></code></pre></div><h2 id="installation">Installation</h2>
<p><em>(30 mins)</em></p>
<p>First, you may start the Kubernetes cluster setup by running <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks.html" target="_blank">Ansible playbook</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>env ANSIBLE_CONFIG<span style="color:#f92672">=</span>ansible/ansible.cfg ansible-playbook ansible/playbooks/all.yml
</span></span></code></pre></div><p>Second, when installation completes, you may copy contents of <em>ansible/playbooks/output/k8s-config.yaml</em> to your local machine:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># Create a kube folder in host machine</span>
</span></span><span style="display:flex;"><span>mkdir ~/.kube
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Paste copied content into config file</span>
</span></span><span style="display:flex;"><span>vi ~/.kube/config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get nodes
</span></span></code></pre></div><p><img src="/images/ansible/kubectl-get-nodes.png" alt="kubectl-get-nodes"></p>
<hr>
<p>Finally, the Kubernetes PI Cluster with Ansible is ready for play! If you are interested in creating a HA cluster, you may refer to <a href="https://seehiong.github.io/archives/2020/highly-available-kubernetes-pi-cluster-part-1/" target="_blank">my previous post</a></p>
<h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="if-blkrrpart-failed-device-or-resource-busy">if BLKRRPART failed: Device or resource busy</h3>
<p>If you face similar error as above, you may comment out line 410 in flash script:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vi /usr/local/bin/flash
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-vim" data-lang="vim"><span style="display:flex;"><span>#<span style="color:#a6e22e">sudo</span> <span style="color:#a6e22e">hdparm</span> -<span style="color:#a6e22e">z</span> <span style="color:#e6db74">&#34;$1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sleep</span> <span style="color:#ae81ff">1</span>m
</span></span></code></pre></div><h3 id="msg-only-python3-is-supported-youre-running-2717-locally">msg: Only python3 is supported, you&rsquo;re running 2.7.17 locally</h3>
<p>If you encouter this issue, you may install <a href="https://docs.python-guide.org/starting/install3/linux/" target="_blank">Python 3</a> and try re-running the playbook with the interpreter setting:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>env ANSIBLE_CONFIG<span style="color:#f92672">=</span>ansible/ansible.cfg ansible-playbook ansible/playbooks/all.yml -e ansible_python_interpreter<span style="color:#f92672">=</span>/usr/bin/python3
</span></span></code></pre></div><h3 id="please-ensure-that-the-cluster-has-a-stable-controlplaneendpoint-address-the-certificates-that-must-be-shared-among-control-plane-instances-are-provided">Please ensure that: <em>The cluster has a stable controlPlaneEndpoint address.</em> The certificates that must be shared among control plane instances are provided.</h3>
<p>If you face this issue during ansible setup, you may need to ssh ubuntu@master1:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo -i
</span></span><span style="display:flex;"><span>vi /etc/kubernetes/kubeadm-join.yaml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-vim" data-lang="vim"><span style="display:flex;"><span>#<span style="color:#a6e22e">modify</span> <span style="color:#a6e22e">apiServerEndpoint</span> <span style="color:#a6e22e">to</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">192</span>.<span style="color:#ae81ff">168</span>.<span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">180</span>:<span style="color:#ae81ff">6443</span>
</span></span></code></pre></div>
  
  <hr>
<div class="footer">
    
	    
            <a class="previous-post" href="https://seehiong.github.io/archives/2020/highly-available-kubernetes-pi-cluster-part-2/?ref=footer"><span style="font-weight:bold;">« Previous</span><br>HA K8s Pi Cluster (II)</a>
        
	    
            <div class="next-post">
                <a href="https://seehiong.github.io/archives/2021/raspberry-pi-cluster-with-longhorn/?ref=footer"><span style="font-weight:bold;">Next »</span><br>Pi Cluster with Longhorn</a>
            </div>
        
    
</div>

  
  <br>
<div class="comments">
    <script>
        const getStoredTheme = () => {
            const themeFromLS = localStorage.getItem("theme");
            const themeFromHugo = document.body.classList.contains("dark-theme") ? "dark" : "light";
            const currentTheme = themeFromLS ? themeFromLS : themeFromHugo;
            return currentTheme;
        };

        const setGiscusTheme = (theme) => {
            const sendMessage = (message) => {
                const iframe = document.querySelector('iframe.giscus-frame');
                if (iframe) {
                    iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
                }
            };
            sendMessage({ setConfig: { theme } });
        };

        document.addEventListener("DOMContentLoaded", () => {
            setGiscusTheme(getStoredTheme());

            const giscusAttributes = {
                "src": "https://giscus.app/client.js",
                "data-repo": "seehiong/seehiong.github.io",
                "data-repo-id": "R_kgDOJg7Puw",
                "data-category": "General",
                "data-category-id": "DIC_kwDOJg7Pu84Cbyhc",
                "data-mapping": "url",
                "data-strict": "0",
                "data-reactions-enabled": "1",
                "data-emit-metadata": "0",
                "data-input-position": "top",
                "data-theme": getStoredTheme(),
                "data-lang": "en",
                "data-loading": "lazy",
                "crossorigin": "anonymous",
                "async": "",
            };

            
            const giscusScript = document.createElement("script");
            Object.entries(giscusAttributes).forEach(
                ([key, value]) => giscusScript.setAttribute(key, value));
            document.querySelector(".comments").appendChild(giscusScript);

            
            const themeSwitcher = document.querySelector(".btn-light-dark");
            if (themeSwitcher) {
                themeSwitcher.addEventListener("click", () => {
                    const currentTheme = getStoredTheme();
                    document.documentElement.classList.toggle("dark", currentTheme);
                    setGiscusTheme(currentTheme);
                });
            }
        });
    </script>
</div>
</div>
            </main>
            
  
    <div class="article-toc ">
    <div class="toc-wrapper">
      <h4 id="contents"></h4>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#preparation">Preparation</a></li>
    <li><a href="#installation">Installation</a></li>
    <li><a href="#troubleshooting">Troubleshooting</a>
      <ul>
        <li><a href="#if-blkrrpart-failed-device-or-resource-busy">if BLKRRPART failed: Device or resource busy</a></li>
        <li><a href="#msg-only-python3-is-supported-youre-running-2717-locally">msg: Only python3 is supported, you&rsquo;re running 2.7.17 locally</a></li>
        <li><a href="#please-ensure-that-the-cluster-has-a-stable-controlplaneendpoint-address-the-certificates-that-must-be-shared-among-control-plane-instances-are-provided">Please ensure that: <em>The cluster has a stable controlPlaneEndpoint address.</em> The certificates that must be shared among control plane instances are provided.</a></li>
      </ul>
    </li>
  </ul>
</nav>

      
    </div>
</div>
  

        </div>
    </body>
</html>


<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  
      inlineMath: [['\\(', '\\)']]                  
    }
  };
</script>
