<!DOCTYPE html>
<html lang="en">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <link rel="icon" href="/images/favicon.ico">
    

    <meta property="og:url" content="http://localhost:1313/posts/2026/02/engineering-a-narrative-multivers/">
  <meta property="og:site_name" content="See Hiong&#39;s Blog">
  <meta property="og:title" content="Engineering a Narrative Multivers">
  <meta property="og:description" content="Living Storybook explores what happens when storytelling is treated as a system rather than a stream of text. This post walks through the architecture behind a multiverse-aware writing tool that supports branching narratives, causal persistence, and human–AI co-authoring. From timeline reconstruction and chapter blueprints to validation guards and stateful characters, it shows how narrative, planning, and control flow come together to make stories that can truly diverge — without losing coherence.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2026-02-07T10:00:00+08:00">
    <meta property="article:modified_time" content="2026-02-07T10:00:00+08:00">
    <meta property="article:tag" content="Gemini 3">
    <meta property="article:tag" content="Firestore">
    <meta property="article:tag" content="Google Cloud">
    <meta property="article:tag" content="Hackathon">
    <meta property="article:tag" content="LangGraph">
    <meta property="article:tag" content="Angular 18">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Engineering a Narrative Multivers">
  <meta name="twitter:description" content="Living Storybook explores what happens when storytelling is treated as a system rather than a stream of text. This post walks through the architecture behind a multiverse-aware writing tool that supports branching narratives, causal persistence, and human–AI co-authoring. From timeline reconstruction and chapter blueprints to validation guards and stateful characters, it shows how narrative, planning, and control flow come together to make stories that can truly diverge — without losing coherence.">

  <meta itemprop="name" content="Engineering a Narrative Multivers">
  <meta itemprop="description" content="Living Storybook explores what happens when storytelling is treated as a system rather than a stream of text. This post walks through the architecture behind a multiverse-aware writing tool that supports branching narratives, causal persistence, and human–AI co-authoring. From timeline reconstruction and chapter blueprints to validation guards and stateful characters, it shows how narrative, planning, and control flow come together to make stories that can truly diverge — without losing coherence.">
  <meta itemprop="datePublished" content="2026-02-07T10:00:00+08:00">
  <meta itemprop="dateModified" content="2026-02-07T10:00:00+08:00">
  <meta itemprop="wordCount" content="2039">
  <meta itemprop="keywords" content="Gemini 3,Firestore,Google Cloud,Hackathon,LangGraph,Angular 18,NgRx,Multi-Agent,Python,TypeScript,MMORPS"><title>Engineering a Narrative Multivers | See Hiong&#39;s Blog</title>

    <link rel="canonical" href="http://localhost:1313/posts/2026/02/engineering-a-narrative-multivers/">

    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    
    
    <link rel="stylesheet" href="/css/variables.css">
    
    <link rel="stylesheet" href="/css/base.css">
    
    <link rel="stylesheet" href="/css/layout.css">
    
    <link rel="stylesheet" href="/css/header.css">
    
    <link rel="stylesheet" href="/css/header.css">
    
    <link rel="stylesheet" href="/css/cards.css">
    
    <link rel="stylesheet" href="/css/content_elements.css">
    
    <link rel="stylesheet" href="/css/codeblocks.css">
    
    <link rel="stylesheet" href="/css/page_specific.css">
    
    <link rel="stylesheet" href="/css/shortcodes.css">
    
    <link rel="stylesheet" href="/css/components.css">
    
    <link rel="stylesheet" href="/css/animations.css">
    
    <link rel="stylesheet" href="/css/media_queries.css">
    
    <link rel="stylesheet" href="/css/quantum-theme.css">
    

    
    <script>
      (function() {
        var theme = localStorage.getItem('theme');
        var H = document.documentElement;
        if (theme === 'dark-mode') {
          H.classList.add('dark-mode');
        } else if (theme === 'light-mode') {
          H.classList.remove('dark-mode');
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
          H.classList.add('dark-mode');
        }
      })();
    </script>
</head></head>
  <body class="page-article"><nav class="nav">
  <div class="nav-wrapper">
    <div class="nav-content-wrapper">
      <div class="nav-content">
        <a href="/" class="nav-logo-link" title="See Hiong&#39;s Blog - Home">
          <span class="nav-site-title">
            <span class="nav-site-title__main">SEE HIONG’S</span>
            <span class="nav-site-title__sub">BLOG</span>
          </span>
        </a>
        <div class="nav-menu">
          <div class="nav-item-wrapper">
            
            
            <a href="/posts/" class="nav-item-content active">Archives</a>
            
          </div>
          
          
          <div class="nav-item-wrapper">
            <a href="/tags/" class="nav-item-content ">Tags</a>
          </div>
          <div class="nav-item-wrapper">
            <a href="/about/" class="nav-item-content ">About</a>
          </div>
          <div class="nav-item-wrapper nav-search-toggle-wrapper">
            <button id="nav-search-toggle" class="nav-item-button" aria-label="Toggle search" title="Search">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor" class="nav-item-icon">
                <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5A6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
              </svg>
            </button>
          </div>
          
          
          <button id="theme-toggle" class="nav-item-button" aria-label="Toggle theme"></button> 
        </div>
      </div>
    </div>
  </div>
</nav>


<script>
  document.addEventListener('DOMContentLoaded', function () {
    const themeToggle = document.getElementById('theme-toggle');
    const H = document.documentElement; 

    if (H.classList.contains('dark-mode')) {
      themeToggle.textContent = 'Light Mode';
    } else {
      themeToggle.textContent = 'Dark Mode';
    }

    themeToggle.addEventListener('click', function() {
      H.classList.toggle('dark-mode');
      if (H.classList.contains('dark-mode')) {
        localStorage.setItem('theme', 'dark-mode');
        themeToggle.textContent = 'Light Mode';
      } else {
        localStorage.setItem('theme', 'light-mode');
        themeToggle.textContent = 'Dark Mode';
      }
    });
  });
</script><div id="content-wrapper">
        <main class="container" id="main-content">
<div class="main-content-area">
  <article class="post-layout container">

    <header class="post-header">
      <h1 class="post-title">Engineering a Narrative Multivers</h1>

      <div class="post-meta">
        <span class="post-meta__date">
          <time datetime="2026-02-07T10:00:00&#43;08:00">February 7, 2026</time>
        </span>

        
          <span class="post-meta__author">Written by See Hiong</span>
        

        
          <span class="post-meta__tags">
            In:
            
              <a href="/tags/gemini-3">Gemini 3</a>
            
              , <a href="/tags/firestore">Firestore</a>
            
              , <a href="/tags/google-cloud">Google Cloud</a>
            
              , <a href="/tags/hackathon">Hackathon</a>
            
              , <a href="/tags/langgraph">LangGraph</a>
            
              , <a href="/tags/angular-18">Angular 18</a>
            
              , <a href="/tags/ngrx">NgRx</a>
            
              , <a href="/tags/multi-agent">Multi-Agent</a>
            
              , <a href="/tags/python">Python</a>
            
              , <a href="/tags/typescript">TypeScript</a>
            
              , <a href="/tags/mmorps">MMORPS</a>
            
          </span>
        

        
      </div>
    </header>

    
      
      
      <div class="post-cover-container post-cover--artistic-blur-wrapper">
        
          <div class="post-cover-blur-background" style="--bg-image: url('/images/lsb/engineering-a-narrative-multiverse.png');"></div>
          <img src="/images/lsb/engineering-a-narrative-multiverse.png" alt="Engineering a Narrative Multivers cover image" class="post-cover-image post-cover-image--artistic-blur">
        
      </div>
    

    <section class="post-content">
      <p>For the 






  <a href="https://gemini3.devpost.com/" target="_blank" rel="noopener noreferrer" >Gemini 3 Hackathon</a>
, I’ve built a <strong>Massively Multiplayer Online Role-Playing Storyteller (MMORPS)</strong>. It’s a platform where humans and AI co-create persistent, branching narratives with history, memory, and consequence.</p>

<div class="admonition note">
  <div class="admonition-heading">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="currentColor" class="admonition-icon">
      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 15c-.55 0-1-.45-1-1v-4c0-.55.45-1 1-1s1 .45 1 1v4c0 .55-.45 1-1 1zm1-8h-2V7h2v2z"/>
    </svg>
    <span class="admonition-title">Note</span>
  </div>
  <div class="admonition-content">
    Living Storybook treats narrative like versioned source code. Every choice creates a fork in the multiverse, protected by an AI &ldquo;Canon Guardian&rdquo; that ensures consistency across parallel timelines.
  </div>
</div>
<h2 id="problem-statement">Problem Statement</h2>
<p>Traditional AI story generators produce &ldquo;stateless&rdquo; prose. If you edit a character&rsquo;s fate in Chapter 1, the system often forgets that change by Chapter 10, or worse, it overwrites the original story entirely.</p>
<p><strong>Living Storybook</strong> solves this by treating every story as a <strong>branching multiverse</strong>. It provides:</p>
<ul>
<li><strong>Long-term Narrative Memory</strong>: Causal links that persist across chapters.</li>
<li><strong>Manifested Souls</strong>: AI characters that evolve based on their historical experiences.</li>
<li><strong>Canonical Integrity</strong>: A stateful validation layer that ensures consistency across parallel timelines.</li>
</ul>
<h3 id="system-overview-narrative-control-flow">System Overview: Narrative Control Flow</h3>
<p>Before diving into the code, here is the high-level control flow that governs planning, prose generation, validation, and state mutation for each narrative turn:</p>


































 
  
  





  <img src="/images/lsb/lsb-narrative-control-flow.png"   alt="lsb-narrative-control-flow" class="sc-image sc-image-default"
       >


<p>The diagram highlights the system’s single-retry guardrail and the separation between <em>creative generation</em> (Chronicler) and <em>canonical authority</em> (Guardian).</p>
<hr>
<h2 id="setup">Setup</h2>
<p>The project is structured as a <strong>decoupled full-stack application</strong>:</p>
<ul>
<li><strong>Frontend</strong>: Angular 18 (with NgRx for state management).</li>
<li><strong>Backend</strong>: FastAPI + LangGraph (Python orchestrator).</li>
<li><strong>Cloud</strong>: Google Cloud (Cloud Run, Firestore, Firebase Auth/Storage).</li>
</ul>
<h3 id="firestore">Firestore</h3>
<p>I use a hierarchical Firestore schema designed for high-frequency narrative updates:</p>
<ul>
<li><code>stories/{storyId}</code>: Main metadata and sequential counters.</li>
<li><code>stories/{storyId}/segments/{segId}</code>: Discrete narrative nodes (prose, choices).</li>
<li><code>stories/{storyId}/chapters/{chapId}</code>: Structural blueprints for the AI.</li>
<li><code>stories/{storyId}/characters/{charId}</code>: Persistent &ldquo;soul&rdquo; data (personality, evolution).</li>
</ul>
<h4 id="architectural-intent-why-firestore-over-a-graph-db">Architectural Intent: Why Firestore over a Graph DB?</h4>
<p>While Living Storybook models a Directed Acyclic Graph (DAG), I chose Firestore over specialized Graph DBs (like Neo4j) or SQL recursive CTEs for several key reasons:</p>
<ol>
<li><strong>O(Depth) Pathing</strong>: Because the story is &ldquo;Backward-Linked,&rdquo; reconstructing a timeline never requires recursive queries. It’s a simple iterative retrieval of parents, which Firestore handles with extremely low latency.</li>
<li><strong>Real-time Synchronization</strong>: Firebase’s listener patterns allow the LHP (Multiverse Map) to update instantly as agents commit new branches.</li>
<li><strong>Write Efficiency</strong>: Atomic batch writes allow for O(1) commits regardless of graph complexity.</li>
</ol>
<h3 id="access-controls">Access Controls</h3>
<p>Security is handled via Firebase Authentication (Google &amp; Anonymous) and fine-grained Firestore rules.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#1f2328">rules_version</span> <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#39;2&#39;</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">service</span> <span style="color:#1f2328">cloud</span><span style="color:#1f2328">.</span><span style="color:#1f2328">firestore</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#1f2328">match</span> <span style="color:#0550ae">/</span><span style="color:#1f2328">databases</span><span style="color:#0550ae">/</span><span style="color:#1f2328">{</span><span style="color:#1f2328">database</span><span style="color:#1f2328">}</span><span style="color:#0550ae">/</span><span style="color:#1f2328">documents</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">match</span> <span style="color:#0550ae">/</span><span style="color:#1f2328">{</span><span style="color:#6639ba">document</span><span style="color:#0550ae">=**</span><span style="color:#1f2328">}</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#57606a">// For development, we allow open access; production uses per-user claims
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>      <span style="color:#1f2328">allow</span> <span style="color:#1f2328">read</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">write</span><span style="color:#0550ae">:</span> <span style="color:#cf222e">if</span> <span style="color:#1f2328">request</span><span style="color:#1f2328">.</span><span style="color:#1f2328">auth</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">null</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><hr>
<h2 id="key-components">Key Components</h2>
<h3 id="langgraph-backend-the-narrative-brain">LangGraph Backend (The &ldquo;Narrative Brain&rdquo;)</h3>
<p>The core innovation is the <strong>Narrative Brain</strong> — a LangGraph-powered multi-agent system. Instead of one giant prompt, I orchestrate specialized Gemini 3 agents:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#57606a"># From backend/app/brain.py</span>
</span></span><span style="display:flex;"><span>workflow <span style="color:#0550ae">=</span> StateGraph<span style="color:#1f2328">(</span>UpdatedNarrativeState<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Specialized Nodes</span>
</span></span><span style="display:flex;"><span>workflow<span style="color:#0550ae">.</span>add_node<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;planner&#34;</span><span style="color:#1f2328">,</span> chapter_planner_node<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>workflow<span style="color:#0550ae">.</span>add_node<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;chronicler&#34;</span><span style="color:#1f2328">,</span> chronicler_node<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>workflow<span style="color:#0550ae">.</span>add_node<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;guardian&#34;</span><span style="color:#1f2328">,</span> canon_guardian_node<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>workflow<span style="color:#0550ae">.</span>add_node<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;feedback&#34;</span><span style="color:#1f2328">,</span> guardian_feedback_node<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>workflow<span style="color:#0550ae">.</span>add_node<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;intelligence&#34;</span><span style="color:#1f2328">,</span> narrative_intelligence_node<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Defining the Causal Loop</span>
</span></span><span style="display:flex;"><span>workflow<span style="color:#0550ae">.</span>set_entry_point<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;planner&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>workflow<span style="color:#0550ae">.</span>add_edge<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;planner&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;chronicler&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>workflow<span style="color:#0550ae">.</span>add_edge<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;chronicler&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;guardian&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Intelligent Routing</span>
</span></span><span style="display:flex;"><span>workflow<span style="color:#0550ae">.</span>add_conditional_edges<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;guardian&#34;</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>    route_post_validation<span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;intelligence&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;narrative_intelligence&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;retry&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;feedback&#34;</span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Back-edges &amp; Termination</span>
</span></span><span style="display:flex;"><span>workflow<span style="color:#0550ae">.</span>add_edge<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;feedback&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;chronicler&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>workflow<span style="color:#0550ae">.</span>add_edge<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;narrative_intelligence&#34;</span><span style="color:#1f2328">,</span> END<span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><ul>
<li><strong>Chronicler</strong>: Focuses exclusively on high-quality literary prose.</li>
<li><strong>Guardian</strong>: Validates the prose against the established &ldquo;Canon&rdquo; and &ldquo;Style Guide&rdquo;.</li>
<li><strong>Intelligence</strong>: Updates the narrative state and generates logical &ldquo;Choice Specs&rdquo;.</li>
<li><strong>Feedback</strong>: Provides the Chronicler with specific revision blueprints if validation fails.</li>
</ul>
<h3 id="angular-frontend-architecture">Angular Frontend Architecture</h3>
<p>The frontend is built with <strong>Angular 18</strong> and <strong>NgRx</strong>, designed to handle the high complexity of branching timelines. Key features include:</p>
<ul>
<li><strong>Time-Weave Navigation (LHP)</strong>: A dynamic sidebar that uses a combination of <em>Backward</em> and <em>Forward Pathing</em> to project the active narrative branch.</li>
<li><strong>Narrative DNA Tracker</strong>: Reactive state management that preserves world-rules even as the story forks.</li>
<li><strong>Optimistic Narrative Persistence</strong>: The UI remains responsive by leveraging local state while backend pipelines run in the background.</li>
</ul>
<p>Key components include:</p>
<ul>
<li><code>StoryEditorMainComponent</code>: The primary writing interface.</li>
<li><code>TimeWeaveNavComponent</code>: The &ldquo;multiverse map&rdquo; for jumping between timelines.</li>
<li><code>ChapterDraftingTableComponent</code>: Where I guide the AI&rsquo;s long-term planning.</li>
</ul>
<h4 id="ngrx-for-multiverse-traversal">NgRx for Multiverse Traversal</h4>
<p>To reconstruct the &ldquo;Unified Projection&rdquo; of the narrative branches, I use specialized NgRx selectors that walk the Directed Acyclic Graph (DAG) in real-time.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#57606a">// From src/app/store/selectors/story.selectors.ts
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#cf222e">export</span> <span style="color:#cf222e">const</span> <span style="color:#1f2328">selectNavigationNodes</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">createSelector</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">selectActivePathNodes</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">selectAllNodes</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">(</span><span style="color:#1f2328">activePath</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">allNodes</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">=&gt;</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">const</span> <span style="color:#1f2328">nodesMap</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">new</span> <span style="color:#1f2328">Map</span><span style="color:#1f2328">&lt;</span><span style="color:#0550ae">string</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">any</span><span style="color:#1f2328">&gt;();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// 1. Add the active linear path (Backtraced from current leaf)
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>        <span style="color:#1f2328">activePath</span><span style="color:#1f2328">.</span><span style="color:#1f2328">forEach</span><span style="color:#1f2328">(</span><span style="color:#1f2328">n</span> <span style="color:#0550ae">=&gt;</span> <span style="color:#1f2328">nodesMap</span><span style="color:#1f2328">.</span><span style="color:#cf222e">set</span><span style="color:#1f2328">(</span><span style="color:#1f2328">n</span><span style="color:#1f2328">.</span><span style="color:#1f2328">id</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">n</span><span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// 2. Add &#34;Anchors&#34; (Root nodes of all possible chapters/branches)
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>        <span style="color:#6639ba">Object</span><span style="color:#1f2328">.</span><span style="color:#1f2328">values</span><span style="color:#1f2328">(</span><span style="color:#1f2328">allNodes</span><span style="color:#1f2328">).</span><span style="color:#1f2328">forEach</span><span style="color:#1f2328">(</span><span style="color:#1f2328">n</span> <span style="color:#0550ae">=&gt;</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">n</span><span style="color:#1f2328">.</span><span style="color:#1f2328">depth</span> <span style="color:#0550ae">===</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">nodesMap</span><span style="color:#1f2328">.</span><span style="color:#cf222e">set</span><span style="color:#1f2328">(</span><span style="color:#1f2328">n</span><span style="color:#1f2328">.</span><span style="color:#1f2328">id</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">n</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">// 3. Sort by Chapter Number then Linear Depth
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>        <span style="color:#cf222e">return</span> <span style="color:#6639ba">Array</span><span style="color:#1f2328">.</span><span style="color:#cf222e">from</span><span style="color:#1f2328">(</span><span style="color:#1f2328">nodesMap</span><span style="color:#1f2328">.</span><span style="color:#1f2328">values</span><span style="color:#1f2328">()).</span><span style="color:#1f2328">sort</span><span style="color:#1f2328">((</span><span style="color:#1f2328">a</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">b</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">=&gt;</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">a</span><span style="color:#1f2328">.</span><span style="color:#1f2328">depth</span> <span style="color:#0550ae">||</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">b</span><span style="color:#1f2328">.</span><span style="color:#1f2328">depth</span> <span style="color:#0550ae">||</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">});</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">);</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="shared-pathing-utilities">Shared Pathing Utilities</h4>
<p>The &ldquo;structural truth&rdquo; of the story is maintained through a simple but robust backward-linkage pattern:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#57606a">// From src/app/utils/story.utils.ts
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#cf222e">static</span> <span style="color:#1f2328">reconstructGenericPath</span><span style="color:#1f2328">(</span><span style="color:#1f2328">currentNode</span>: <span style="color:#cf222e">StoryNode</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">allNodesMap</span><span style="color:#0550ae">:</span> <span style="color:#1f2328">{</span> <span style="color:#1f2328">[</span><span style="color:#1f2328">id</span>: <span style="color:#cf222e">string</span><span style="color:#1f2328">]</span><span style="color:#0550ae">:</span> <span style="color:#1f2328">StoryNode</span> <span style="color:#1f2328">})</span><span style="color:#0550ae">:</span> <span style="color:#1f2328">StoryNode</span><span style="color:#1f2328">[]</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">const</span> <span style="color:#1f2328">path</span>: <span style="color:#cf222e">StoryNode</span><span style="color:#1f2328">[]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">[];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">let</span> <span style="color:#1f2328">visitor</span>: <span style="color:#cf222e">StoryNode</span> <span style="color:#0550ae">|</span> <span style="color:#cf222e">undefined</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">currentNode</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">while</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">visitor</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">path</span><span style="color:#1f2328">.</span><span style="color:#1f2328">unshift</span><span style="color:#1f2328">(</span><span style="color:#1f2328">visitor</span><span style="color:#1f2328">);</span> <span style="color:#57606a">// Add to start of array
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">!</span><span style="color:#1f2328">visitor</span><span style="color:#1f2328">.</span><span style="color:#1f2328">prevSegId</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">break</span><span style="color:#1f2328">;</span> <span style="color:#57606a">// Found root
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>        <span style="color:#1f2328">visitor</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">allNodesMap</span><span style="color:#1f2328">[</span><span style="color:#1f2328">visitor</span><span style="color:#1f2328">.</span><span style="color:#1f2328">prevSegId</span><span style="color:#1f2328">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">path</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><hr>
<h3 id="performance--cost-envelope">Performance &amp; Cost Envelope</h3>
<p>Maintaining a sub-60s latency for a multi-agent pipeline and managing token costs are critical for production viability.</p>
<h4 id="efficiency-targets">Efficiency Targets</h4>
<ul>
<li><strong>Latency</strong>: The average &ldquo;Narrate&rdquo; operation takes <strong>40-60s</strong>, reduced from &gt;120s by consolidating 10+ sequential agents into a 3-stage LangGraph loop.</li>
<li><strong>Tokens</strong>: A typical segment generation consumes ~1,500 – 3,000 tokens (including history context). Summarization logic prevents context bloating as the story deepens.</li>
<li><strong>Cold Starts</strong>: Running on <strong>Cloud Run</strong> with a <code>min-instances: 1</code> setting for the API keeps response times snappy.</li>
<li><strong>Writes</strong>: Story initialization involves a <strong>Single Firestore Batch</strong> (creating 6+ documents), ensuring atomic success or failure.</li>
</ul>
<h4 id="optimization-key-pillars">Optimization Key Pillars</h4>
<ol>
<li><strong>Single-Pass Intelligence</strong>: Instead of multiple LLM calls for metadata, choices, and world-updates, everything is synthesized in one structured Gemini 3 pass.</li>
<li><strong>Consolidated Guardian</strong>: Lore-checks, style-validation, and character-presence are validated in one pass with a strict 1-retry ceiling.</li>
<li><strong>Batch Persistence</strong>: All narrative updates are saved to Firestore in atomic batches, eliminating the O(N) write penalty.</li>
</ol>
<h4 id="adaptive-latency-calibration">Adaptive Latency Calibration</h4>
<p>The frontend <code>MetricsService</code> maintains a capped moving average of E2E latency. This allows the UI to &ldquo;learn&rdquo; the current network and model performance, adjusting predictive countdown timers for the user.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#57606a">// src/app/services/metrics.service.ts
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#57606a">/**
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"> * Calculates a capped moving average to ensure the system &#34;learns&#34; quickly (max 10 samples)
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">private</span> <span style="color:#1f2328">calculateCappedAverage</span><span style="color:#1f2328">(</span><span style="color:#1f2328">currentAvg</span>: <span style="color:#cf222e">number</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">currentCalls</span>: <span style="color:#cf222e">number</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">newValue</span>: <span style="color:#cf222e">number</span><span style="color:#1f2328">)</span><span style="color:#0550ae">:</span> <span style="color:#cf222e">number</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">const</span> <span style="color:#1f2328">weight</span> <span style="color:#0550ae">=</span> <span style="color:#6639ba">Math</span><span style="color:#1f2328">.</span><span style="color:#1f2328">min</span><span style="color:#1f2328">(</span><span style="color:#1f2328">currentCalls</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">10</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">((</span><span style="color:#1f2328">currentAvg</span> <span style="color:#0550ae">*</span> <span style="color:#1f2328">weight</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">+</span> <span style="color:#1f2328">newValue</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">/</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">weight</span> <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="e2e-latency-measurement">E2E Latency Measurement</h4>
<p>Latency is measured end-to-end at the service level, capturing the entire round-trip from the client through the Narrative Brain.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#57606a">// src/app/services/gemini.service.ts
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#cf222e">async</span> <span style="color:#1f2328">narrate</span><span style="color:#1f2328">(</span><span style="color:#1f2328">params</span><span style="color:#0550ae">:</span> <span style="color:#1f2328">{</span> <span style="color:#1f2328">...</span> <span style="color:#1f2328">})</span><span style="color:#0550ae">:</span> <span style="color:#1f2328">Promise</span><span style="color:#1f2328">&lt;</span><span style="color:#0550ae">GeminiResult</span><span style="color:#1f2328">&lt;</span><span style="color:#0550ae">any</span><span style="color:#1f2328">&gt;&gt;</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">const</span> <span style="color:#1f2328">startTime</span> <span style="color:#0550ae">=</span> <span style="color:#6639ba">Date</span><span style="color:#1f2328">.</span><span style="color:#1f2328">now</span><span style="color:#1f2328">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">const</span> <span style="color:#1f2328">response</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> <span style="color:#1f2328">firstValueFrom</span><span style="color:#1f2328">(</span><span style="color:#cf222e">this</span><span style="color:#1f2328">.</span><span style="color:#1f2328">http</span><span style="color:#1f2328">.</span><span style="color:#1f2328">post</span><span style="color:#1f2328">&lt;</span><span style="color:#0550ae">any</span><span style="color:#1f2328">&gt;(</span><span style="color:#1f2328">url</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">payload</span><span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">const</span> <span style="color:#1f2328">e2eLatencyMs</span> <span style="color:#0550ae">=</span> <span style="color:#6639ba">Date</span><span style="color:#1f2328">.</span><span style="color:#1f2328">now</span><span style="color:#1f2328">()</span> <span style="color:#0550ae">-</span> <span style="color:#1f2328">startTime</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">const</span> <span style="color:#1f2328">usage</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">...</span><span style="color:#1f2328">response</span><span style="color:#1f2328">.</span><span style="color:#1f2328">data</span><span style="color:#1f2328">.</span><span style="color:#1f2328">usage</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">latencyMs</span>: <span style="color:#cf222e">e2eLatencyMs</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">isStoryContinue</span><span style="color:#0550ae">:</span> <span style="color:#0550ae">!</span><span style="color:#1f2328">params</span><span style="color:#1f2328">.</span><span style="color:#1f2328">blueprint</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">await</span> <span style="color:#cf222e">this</span><span style="color:#1f2328">.</span><span style="color:#1f2328">metrics</span><span style="color:#1f2328">.</span><span style="color:#1f2328">recordUsage</span><span style="color:#1f2328">(</span><span style="color:#1f2328">usage</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">{</span> <span style="color:#1f2328">data</span>: <span style="color:#cf222e">response.data</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">usage</span> <span style="color:#1f2328">};</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="cost-tracking--user-usage">Cost Tracking &amp; User Usage</h4>
<p>Aggregated metrics are stored in the user&rsquo;s profile, allowing for granular visibility into token consumption and API efficiency.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#57606a">// src/app/models/user.model.ts
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#cf222e">export</span> <span style="color:#cf222e">interface</span> <span style="color:#1f2328">UserUsage</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">totalTokensInput</span>: <span style="color:#cf222e">number</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">totalTokensOutput</span>: <span style="color:#cf222e">number</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">totalApiCalls</span>: <span style="color:#cf222e">number</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">averageLatencyMsPerNarrate</span>: <span style="color:#cf222e">number</span><span style="color:#1f2328">;</span>      <span style="color:#57606a">// Narrative Brain (/api/story/narrate)
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    <span style="color:#1f2328">averageLatencyMsPerStoryStart</span>: <span style="color:#cf222e">number</span><span style="color:#1f2328">;</span>   <span style="color:#57606a">// Story Creation (/api/story/start)
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    <span style="color:#1f2328">averageLatencyMsPerOracle</span>: <span style="color:#cf222e">number</span><span style="color:#1f2328">;</span>       <span style="color:#57606a">// Oracle Planning (/api/story/suggest_blueprint)
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#1f2328">}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="architectural-guardrails-data-model-invariants">Architectural Guardrails: Data Model Invariants</h3>
<p>To prevent state corruption across the multiverse, the following invariants are enforced at the type level and in the persistence layer:</p>
<ol>
<li><strong>Singleton Parentage</strong>: Every <code>StoryNode</code> (segment) has exactly one <code>prevSegId</code>. This prevents narrative loops and ensures a clean DAG structure.</li>
<li><strong>Immutability of the Past</strong>: Once a node is part of a published edition, it is <strong>Temporally Locked</strong>. Mutations are rejected; users must <strong>Fork</strong> to change history.</li>
<li><strong>Causal Continuity</strong>: Forked stories must increment <code>depth</code> and copy current sequential counters (<code>currentSegId</code>) to ensure new segments don&rsquo;t collide with original numbering.</li>
<li><strong>Attribution Inheritance</strong>: Every forked segment retains a <code>forkedFrom</code> reference, maintaining a clear lineage across the multiverse.</li>
</ol>
<h4 id="code-representation-the-story-node">Code Representation: The Story Node</h4>
<p>The <code>StoryNode</code> is the atomic unit of the multiverse. Its structure enforces parentage and depth invariants:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#57606a">// From src/app/models/story.model.ts
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#cf222e">export</span> <span style="color:#cf222e">interface</span> <span style="color:#1f2328">StoryNode</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">id</span>: <span style="color:#cf222e">string</span><span style="color:#1f2328">;</span>          <span style="color:#57606a">// e.g., &#34;seg_1&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    <span style="color:#1f2328">storyId</span>: <span style="color:#cf222e">string</span><span style="color:#1f2328">;</span>     <span style="color:#57606a">// e.g., &#34;story_abc123&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    <span style="color:#1f2328">prevSegId?</span>: <span style="color:#cf222e">string</span><span style="color:#1f2328">;</span>  <span style="color:#57606a">// The SINGLE parent link
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    <span style="color:#1f2328">depth</span>: <span style="color:#cf222e">number</span><span style="color:#1f2328">;</span>       <span style="color:#57606a">// Linear position in branch (relative to chapter)
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    <span style="color:#1f2328">text</span>: <span style="color:#cf222e">string</span><span style="color:#1f2328">;</span>        <span style="color:#57606a">// The generated prose
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    <span style="color:#1f2328">choices</span>: <span style="color:#cf222e">Choice</span><span style="color:#1f2328">[];</span>   <span style="color:#57606a">// Branching entry points
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    <span style="color:#1f2328">publishedInEditions?</span>: <span style="color:#cf222e">string</span><span style="color:#1f2328">[];</span> <span style="color:#57606a">// Locking signal
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#1f2328">}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="the-story-metadata">The Story Metadata</h4>
<p>The root <code>Story</code> document tracks the global state and sequential counters:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#cf222e">export</span> <span style="color:#cf222e">interface</span> <span style="color:#1f2328">Story</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">id</span>: <span style="color:#cf222e">string</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">startSegId</span>: <span style="color:#cf222e">string</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">currentSegId?</span>: <span style="color:#cf222e">number</span><span style="color:#1f2328">;</span> <span style="color:#57606a">// Global counter for segment IDs
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    <span style="color:#1f2328">totalChapters?</span>: <span style="color:#cf222e">number</span><span style="color:#1f2328">;</span> <span style="color:#57606a">// Counter for chapter IDs
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    <span style="color:#1f2328">forkedFrom?</span>: <span style="color:#cf222e">string</span><span style="color:#1f2328">;</span>    <span style="color:#57606a">// Multiverse lineage
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    <span style="color:#1f2328">narrativeDNA?</span>: <span style="color:#cf222e">NarrativeDNA</span><span style="color:#1f2328">;</span> <span style="color:#57606a">// World rules
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#1f2328">}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><hr>
<h2 id="failure-modes--safeguards">Failure Modes &amp; Safeguards</h2>
<p>Building for a hackathon means planning for when things go wrong:</p>
<ul>
<li><strong>Probabilistic Validation</strong>: The <code>Guardian</code> node occasionally provides &ldquo;soft failures.&rdquo; We handle this with a <strong>Hard Retry Ceiling</strong> (1 retry per node transition) guided by a <code>Feedback</code> node.</li>
<li><strong>Narrative Stalling</strong>: If the AI detects a narrative loop (e.g., repeating the same scene), the <code>Intelligence</code> node injects &ldquo;Dynamic Disruptors&rdquo; to force plot progression.</li>
<li><strong>State Corruption</strong>: Because Firestore is the source of truth, if an agent fails mid-process, the LangGraph <code>StateGraph</code> ensures the story doesn&rsquo;t advance, preventing &ldquo;broken&rdquo; segments from appearing in the user&rsquo;s timeline.</li>
</ul>
<hr>
<h2 id="dynamic-pathing-the-multiverse-engine">Dynamic Pathing (The Multiverse Engine)</h2>
<p>The &ldquo;In Action&rdquo; experience is powered by a sophisticated pathing system that maintains a &ldquo;Unified Projection&rdquo; of the story.</p>
<h3 id="the-structural-truth">The Structural Truth</h3>
<p>In Living Storybook, truth is <strong>Backward-Linked</strong>. Each segment points to its parent (<code>prevSegId</code>), allowing us to reconstruct any specific timeline by walking back from a leaf node to the root.</p>
<h3 id="celestial-archive-locking">Celestial Archive (Locking)</h3>
<p>To prevent &ldquo;causal paradoxes,&rdquo; any node that has been published as part of a Chronicle is marked as <code>Temporally Locked</code>. This preserves the historical record while forcing new ideas to <strong>Fork</strong> into parallel timelines.</p>
<h3 id="temporal-anchors">Temporal Anchors</h3>
<p>The system uses &ldquo;Anchors&rdquo; (typically the first segment of each chapter) to ensure the navigation panel feels consistent, even when the reader is exploring a deep, unconventional branch.</p>
<hr>
<h2 id="getting-started">Getting Started</h2>
<h3 id="running-locally">Running Locally</h3>
<ol>
<li><strong>Backend</strong>:






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#6639ba">cd</span> backend
</span></span><span style="display:flex;"><span>python -m app.main</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div></li>
<li><strong>Frontend</strong>:






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ng serve</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div></li>
</ol>
<h3 id="deploying-to-google-cloud">Deploying to Google Cloud</h3>
<p>The backend is containerized for <strong>Google Cloud Run</strong>, ensuring it can scale to zero during idle periods.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud run deploy backend-service <span style="color:#0a3069">\
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069"></span>    --image us-central1-docker.pkg.dev/YOUR-PROJECT-ID/living-storybook-repo/backend <span style="color:#0a3069">\
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069"></span>    --platform managed <span style="color:#0a3069">\
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069"></span>    --region us-central1 <span style="color:#0a3069">\
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069"></span>    --allow-unauthenticated <span style="color:#0a3069">\
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069"></span>    --set-env-vars<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;GOOGLE_API_KEY=your-gemini-key,PROJECT_ID=living-storybook&#34;</span>    </span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="deploy-to-firebase">Deploy to Firebase</h3>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>firebase deploy --only hosting</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><hr>
<h2 id="in-action-navigating-the-multiverse">In Action: Navigating the Multiverse</h2>
<p>Living Storybook is more than a writing app; it&rsquo;s a window into a branching reality. Here is how the system handles the complexities of co-authoring and causal persistence.</p>
<h3 id="1-the-multiverse-navigator">1. The Multiverse Navigator</h3>
<p>The <strong>Time-Weave Navigation</strong> panel (LHP) is the heart of the experience. Unlike linear sidebars, it reconstructs the active timeline in real-time. When you select a segment, the system walks the backward-links to project exactly which nodes belong to your current &ldquo;truth.&rdquo;</p>
<p>

































 
  
  





  <img src="/images/lsb/lsb-multiverse-navigator.png"   alt="Multiverse Navigator" class="sc-image sc-image-default"
       >


<em>Caption: The Time-Weave Navigation panel projecting the active narrative path.</em></p>
<h3 id="2-co-authoring-with-the-oracle">2. Co-Authoring with the Oracle</h3>
<p>Before a single word is written, you collaborate with the <strong>Gemini 3 Oracle</strong>. By providing a high-level prompt, the Oracle suggests a structured <strong>Chapter Blueprint</strong>, including emotional beats and narrative goals that will guide the subsequent generation.</p>
<p>

































 
  
  





  <img src="/images/lsb/lsb-oracle-collaboration.png"   alt="Oracle Collaboration" class="sc-image sc-image-default"
       >


<em>Caption: Collaborating with the Gemini 3 Oracle to draft a Chapter Blueprint.</em></p>
<h3 id="3-the-chroniclers-loom">3. The Chronicler&rsquo;s Loom</h3>
<p>In the main editor, the <strong>Chronicler</strong> generates prose that adheres to your established style guide, while the <strong>Intelligence</strong> agent updates character vitals and emotional arcs in the background.</p>
<p>

































 
  
  





  <img src="/images/lsb/lsb-chronicler-loom.png"   alt="Chronicler&#39;s Loom" class="sc-image sc-image-default"
       >


<em>Caption: The main writing interface where prose, choices, and character vitals converge.</em></p>
<hr>
<h2 id="limitations--future-work">Limitations &amp; Future Work</h2>
<p>While functional, Living Storybook is an evolving system with known boundaries:</p>
<ul>
<li><strong>Multi-User Conflicts</strong>: Currently follows a &ldquo;Last-Writer-Wins&rdquo; model; future iterations will include real-time collaboration markers.</li>
<li><strong>Context Limits</strong>: Long-term memory is currently bounded by a sliding-window summarization; I’m exploring <strong>Vector Embeddings</strong> for more permanent thematic memory.</li>
<li><strong>Deterministic vs. Creative</strong>: The <code>Guardian</code> sometimes over-regulates prose. Finding the perfect balance between &ldquo;Canon Safety&rdquo; and &ldquo;Creative Flair&rdquo; remains a primary tuning focus.</li>
</ul>
<hr>
<h2 id="terminology-glossary">Terminology Glossary</h2>
<p>To help navigate the multiverse, here are the key concepts used throughout this deep dive:</p>
<ul>
<li><strong>Edition</strong>: A published, immutable snapshot of a specific timeline.</li>
<li><strong>Chronicle</strong>: A user-facing reading experience derived from a canonical path.</li>
<li><strong>Temporally Locked</strong>: A node that cannot be edited because it is part of a published edition (preserving the past).</li>
<li><strong>Narrative DNA</strong>: The set of world-rules, style guides, and character profiles that define a story&rsquo;s &ldquo;Soul.&rdquo;</li>
<li><strong>Backward-Linked</strong>: The $O(depth)$ pathing model where segments reference their parent, not their children.</li>
</ul>
<hr>
<h2 id="conclusion">Conclusion</h2>
<p>Living Storybook isn&rsquo;t just a writing tool; it’s an experiment in <strong>persistent digital existence</strong>. By combining Gemini’s reasoning with LangGraph’s stateful orchestration, I&rsquo;ve moved from &ldquo;AI Text Generators&rdquo; to &ldquo;AI Narrative Universes.&rdquo;</p>

    </section>

    <nav class="post-navigation">
      <div class="nav-links">
        
        
      </div>
    </nav>

    
<div class="giscus-comments-container">
</div>

<script>
  (function() {
    'use strict';

    const getGiscusTheme = () => {
      const storedTheme = localStorage.getItem('theme'); 
      if (storedTheme) {
        return storedTheme === 'dark-mode' ? 'dark' : 'light';
      }
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };

    const setGiscusFrameTheme = (theme) => {
      const iframe = document.querySelector('iframe.giscus-frame');
      if (iframe && iframe.contentWindow) {
        iframe.contentWindow.postMessage({ giscus: { setConfig: { theme: theme } } }, 'https://giscus.app');
      }
    };

    const loadGiscus = () => {
      const giscusContainer = document.querySelector('.giscus-comments-container');
      if (!giscusContainer) {
        console.warn('Giscus container not found.');
        return;
      }

      while (giscusContainer.firstChild) {
        giscusContainer.removeChild(giscusContainer.firstChild);
      }

      const giscusScript = document.createElement('script');
      const giscusAttributes = {
        "src": "https://giscus.app/client.js",
        "data-repo":             "seehiong\/seehiong.github.io",
        "data-repo-id":          "R_kgDOJg7Puw",
        "data-category":         "General",
        "data-category-id":      "DIC_kwDOJg7Pu84Cbyhc",
        "data-mapping":          "url", 
        "data-strict":           "0",
        "data-reactions-enabled":"1",
        "data-emit-metadata":    "0",
        "data-input-position":   "top", 
        "data-theme":            getGiscusTheme(), 
        "data-lang":             "en",
        "data-loading":          "lazy",
        "crossorigin":           "anonymous",
        "async":                 "true", 
      };

      if (!giscusAttributes["data-repo"] || !giscusAttributes["data-repo-id"] || !giscusAttributes["data-category-id"]) {
          console.error("Giscus parameters (giscusRepo, giscusRepoId, giscusCategoryId) are not configured in hugo.toml.");
          giscusContainer.innerHTML = "<p style='color: var(--text-secondary);'>Giscus comments are not configured correctly. Please check site parameters.</p>";
          return;
      }

      Object.entries(giscusAttributes).forEach(
        ([key, value]) => giscusScript.setAttribute(key, value)
      );
      giscusContainer.appendChild(giscusScript);
    };

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadGiscus);
    } else {
        loadGiscus();
    }

    const htmlElement = document.documentElement;
    const observer = new MutationObserver((mutationsList) => {
      for (const mutation of mutationsList) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          setGiscusFrameTheme(getGiscusTheme());
        }
      }
    });
    observer.observe(htmlElement, { attributes: true });

  })();
</script>


  </article>
</div>
</main>
    </div>

    
    <div id="search-modal-overlay" class="search-modal-overlay" style="display: none;">
      <div id="search-modal-content" class="search-modal-content">
        <button id="search-modal-close" class="search-modal-close" aria-label="Close search" title="Close search">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </button>
        <input type="search" id="modal-search-input" class="modal-search-input" placeholder="Search content..." aria-label="Search input">
        <div id="modal-search-results" class="modal-search-results">
        </div>
      </div>
    </div>
    

  <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js" defer></script>
  <script>
    (function() {
      'use strict';

      window.addEventListener('DOMContentLoaded', () => {
        const searchModalOverlay = document.getElementById('search-modal-overlay');
        const searchModalContent = document.getElementById('search-modal-content');
        const searchModalCloseButton = document.getElementById('search-modal-close');
        const searchToggleButton = document.getElementById('nav-search-toggle');
        const searchInputTarget = document.getElementById('modal-search-input');
        const searchResultsTarget = document.getElementById('modal-search-results');

        let fuseInstance = null;
        let searchData = [];

        const loadSearchData = async () => {
          if (searchData.length === 0 && !fuseInstance) {
            try {
              const response = await fetch('\/index.json');
              if (!response.ok) {
                throw new Error(`HTTP error loading index.json! status: ${response.status}`);
              }
              searchData = await response.json();
              initializeFuse();
            } catch (e) {
              console.error("[SearchSetup] Error loading search data:", e);
              if (searchResultsTarget) searchResultsTarget.innerHTML = "<p>Error loading search index.</p>";
            }
          } else if (searchData.length > 0 && !fuseInstance){
            initializeFuse();
          }
        };

        const initializeFuse = () => {
          if (searchData.length > 0 && !fuseInstance) {
            const options = {
              keys: [
                { name: 'title', weight: 0.7 }, { name: 'summary', weight: 0.5 },
                { name: 'content', weight: 0.3 }, { name: 'tags', weight: 0.4 }
              ],
              includeScore: true, threshold: 0.4, minMatchCharLength: 2,
            };
            fuseInstance = new Fuse(searchData, options);
          }
        };

        const performSearch = () => {
          if (!fuseInstance || !searchInputTarget || !searchResultsTarget) return;
          const query = searchInputTarget.value.trim();
          searchResultsTarget.innerHTML = '';
          if (query.length < 2) return;

          const results = fuseInstance.search(query);
          if (results.length > 0) {
            const ul = document.createElement('ul');
            ul.className = 'search-results-list';
            results.slice(0, 10).forEach(result => {
              const item = result.item;
              const li = document.createElement('li');
              li.className = 'search-result-item';
              const a = document.createElement('a');
              a.href = item.permalink;
              a.textContent = item.title;
              li.appendChild(a);
              ul.appendChild(li);
            });
            searchResultsTarget.appendChild(ul);
          } else {
            searchResultsTarget.innerHTML = '<p>No results found.</p>';
          }
        };

        const openSearchModal = async () => {
          await loadSearchData();
          if (searchInputTarget) searchInputTarget.value = '';
          if (searchResultsTarget) searchResultsTarget.innerHTML = '';

          if (searchModalOverlay) {
            searchModalOverlay.style.display = 'flex';
            setTimeout(() => searchModalOverlay.classList.add('active'), 10);
          } else { return; }

          if (searchInputTarget) setTimeout(() => searchInputTarget.focus(), 50);
          if (searchToggleButton) searchToggleButton.classList.add('active');
        };

        const closeSearchModal = () => {
          if (searchModalOverlay) {
            searchModalOverlay.classList.remove('active');
            setTimeout(() => searchModalOverlay.style.display = 'none', 300);
          }
          if (searchToggleButton) searchToggleButton.classList.remove('active');
        };

        if (searchToggleButton) {
          searchToggleButton.addEventListener('click', (e) => {
            e.stopPropagation();
            if (searchModalOverlay && searchModalOverlay.classList.contains('active')) {
              closeSearchModal();
            } else {
              openSearchModal();
            }
          });
        } else { console.error("[SearchSetup] #nav-search-toggle button not found."); }

        if (searchModalCloseButton) { searchModalCloseButton.addEventListener('click', closeSearchModal); }
        if (searchModalOverlay && searchModalContent) {
          searchModalOverlay.addEventListener('click', (event) => {
            if (event.target === searchModalOverlay) closeSearchModal();
          });
        }
        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && searchModalOverlay && searchModalOverlay.classList.contains('active')) {
            closeSearchModal();
          }
        });
        if (searchInputTarget) {
          let debounceTimer;
          searchInputTarget.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(performSearch, 300);
          });
        }
      });
    })();
  </script>

    

    

  <script>
    MathJax = {
      tex: {
        displayMath: [['\\[', '\\]'], ['$$', '$$']], 
        inlineMath: [['\\(', '\\)']], 
        processEscapes: true,
        processEnvironments: true,
        tags: 'ams' 
      },
      svg: {
        fontCache: 'global' 
      },
      chtml: {
        fontURL: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2'
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'], 
        ignoreHtmlClass: 'tex2jax_ignore', 
        processHtmlClass: 'tex2jax_process'
      }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<footer class="footer-main simplified-footer">
  <div class="content-body footer-wraper">
    <div class="footer-box">
      <div class="footer-content">
        <div class="copyright-line">
          Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> © 2026 See Hiong. All rights reserved.
        </div>
        <div class="social-links">
          
            <a href="https://github.com/seehiong" target="_blank" title="GitHub" class="social-link" aria-label="GitHub">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
            </a>
          
          
            <a href="https://www.linkedin.com/in/seehiong/" target="_blank" title="LinkedIn" class="social-link" aria-label="LinkedIn">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
            </a>
          
          
            <a href="/index.xml" target="_blank" title="RSS" class="social-link" aria-label="RSS Feed">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg>
            </a>
          
        </div>
      </div>
    </div>
  </div>
</footer>
        <script src="/js/animation.js" defer></script>
    
        <script src="/js/code-copy.js" defer></script>
    
        <script src="/js/scroll-header.js" defer></script>
       
  </body>
</html>