<!DOCTYPE html>
<html lang="en">
  <head><head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <link rel="icon" href="/images/favicon.ico">
    

    <meta property="og:url" content="https://seehiong.github.io/posts/2025/12/autonomous-deepagents-for-hdb-insights/">
  <meta property="og:site_name" content="See Hiong&#39;s Blog">
  <meta property="og:title" content="Autonomous DeepAgents for HDB Insights">
  <meta property="og:description" content="This post demonstrates how to build an autonomous DeepAgents-powered pipeline that performs intent extraction, SQL retrieval, and geospatial reasoning to answer real-world HDB property queries. Using LangGraph, MCP Toolbox, PostGIS, and a Dockerized backend, the system provides end-to-end MRT proximity analysis and natural-language search for HDB resale insights.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-12-07T20:00:00+08:00">
    <meta property="article:modified_time" content="2025-12-07T20:00:00+08:00">
    <meta property="article:tag" content="DeepAgents">
    <meta property="article:tag" content="LangGraph">
    <meta property="article:tag" content="LangChain">
    <meta property="article:tag" content="MCP Toolbox">
    <meta property="article:tag" content="Postgres">
    <meta property="article:tag" content="PostGIS">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Autonomous DeepAgents for HDB Insights">
  <meta name="twitter:description" content="This post demonstrates how to build an autonomous DeepAgents-powered pipeline that performs intent extraction, SQL retrieval, and geospatial reasoning to answer real-world HDB property queries. Using LangGraph, MCP Toolbox, PostGIS, and a Dockerized backend, the system provides end-to-end MRT proximity analysis and natural-language search for HDB resale insights.">

  <meta itemprop="name" content="Autonomous DeepAgents for HDB Insights">
  <meta itemprop="description" content="This post demonstrates how to build an autonomous DeepAgents-powered pipeline that performs intent extraction, SQL retrieval, and geospatial reasoning to answer real-world HDB property queries. Using LangGraph, MCP Toolbox, PostGIS, and a Dockerized backend, the system provides end-to-end MRT proximity analysis and natural-language search for HDB resale insights.">
  <meta itemprop="datePublished" content="2025-12-07T20:00:00+08:00">
  <meta itemprop="dateModified" content="2025-12-07T20:00:00+08:00">
  <meta itemprop="wordCount" content="4319">
  <meta itemprop="keywords" content="DeepAgents,LangGraph,LangChain,MCP Toolbox,Postgres,PostGIS,Geospatial,OpenRouter,Multi-Agent System,HDB Insights,Natural Language Querying,Real Estate Data,Docker,AI Engineering,Singapore Open Data"><title>Autonomous DeepAgents for HDB Insights | See Hiong&#39;s Blog</title>

    <link rel="canonical" href="https://seehiong.github.io/posts/2025/12/autonomous-deepagents-for-hdb-insights/">

    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    
      
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-5PNPM4HWQ0"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-5PNPM4HWQ0');
        }
      </script>
    
    <link rel="stylesheet" href="/css/variables.css">
    
    <link rel="stylesheet" href="/css/base.css">
    
    <link rel="stylesheet" href="/css/layout.css">
    
    <link rel="stylesheet" href="/css/header.css">
    
    <link rel="stylesheet" href="/css/header.css">
    
    <link rel="stylesheet" href="/css/cards.css">
    
    <link rel="stylesheet" href="/css/content_elements.css">
    
    <link rel="stylesheet" href="/css/codeblocks.css">
    
    <link rel="stylesheet" href="/css/page_specific.css">
    
    <link rel="stylesheet" href="/css/shortcodes.css">
    
    <link rel="stylesheet" href="/css/components.css">
    
    <link rel="stylesheet" href="/css/animations.css">
    
    <link rel="stylesheet" href="/css/media_queries.css">
    
    <link rel="stylesheet" href="/css/quantum-theme.css">
    

    
    <script>
      (function() {
        var theme = localStorage.getItem('theme');
        var H = document.documentElement;
        if (theme === 'dark-mode') {
          H.classList.add('dark-mode');
        } else if (theme === 'light-mode') {
          H.classList.remove('dark-mode');
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
          H.classList.add('dark-mode');
        }
      })();
    </script>
</head></head>
  <body class="page-article"><nav class="nav">
  <div class="nav-wrapper">
    <div class="nav-content-wrapper">
      <div class="nav-content">
        <a href="/" class="nav-logo-link" title="See Hiong&#39;s Blog - Home">
          <span class="nav-site-title">
            <span class="nav-site-title__main">SEE HIONG’S</span>
            <span class="nav-site-title__sub">BLOG</span>
          </span>
        </a>
        <div class="nav-menu">
          <div class="nav-item-wrapper">
            
            
            <a href="/posts/" class="nav-item-content active">Archives</a>
            
          </div>
          
          
          <div class="nav-item-wrapper">
            <a href="/tags/" class="nav-item-content ">Tags</a>
          </div>
          <div class="nav-item-wrapper">
            <a href="/about/" class="nav-item-content ">About</a>
          </div>
          <div class="nav-item-wrapper nav-search-toggle-wrapper">
            <button id="nav-search-toggle" class="nav-item-button" aria-label="Toggle search" title="Search">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor" class="nav-item-icon">
                <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5A6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
              </svg>
            </button>
          </div>
          
          
          <button id="theme-toggle" class="nav-item-button" aria-label="Toggle theme"></button> 
        </div>
      </div>
    </div>
  </div>
</nav>


<script>
  document.addEventListener('DOMContentLoaded', function () {
    const themeToggle = document.getElementById('theme-toggle');
    const H = document.documentElement; 

    if (H.classList.contains('dark-mode')) {
      themeToggle.textContent = 'Light Mode';
    } else {
      themeToggle.textContent = 'Dark Mode';
    }

    themeToggle.addEventListener('click', function() {
      H.classList.toggle('dark-mode');
      if (H.classList.contains('dark-mode')) {
        localStorage.setItem('theme', 'dark-mode');
        themeToggle.textContent = 'Light Mode';
      } else {
        localStorage.setItem('theme', 'light-mode');
        themeToggle.textContent = 'Dark Mode';
      }
    });
  });
</script><div id="content-wrapper">
        <main class="container" id="main-content">
<div class="main-content-area">
  <article class="post-layout container">

    <header class="post-header">
      <h1 class="post-title">Autonomous DeepAgents for HDB Insights</h1>

      <div class="post-meta">
        <span class="post-meta__date">
          <time datetime="2025-12-07T20:00:00&#43;08:00">December 7, 2025</time>
        </span>

        
          <span class="post-meta__author">Written by See Hiong</span>
        

        
          <span class="post-meta__tags">
            In:
            
              <a href="/tags/deepagents">DeepAgents</a>
            
              , <a href="/tags/langgraph">LangGraph</a>
            
              , <a href="/tags/langchain">LangChain</a>
            
              , <a href="/tags/mcp-toolbox">MCP Toolbox</a>
            
              , <a href="/tags/postgres">Postgres</a>
            
              , <a href="/tags/postgis">PostGIS</a>
            
              , <a href="/tags/geospatial">Geospatial</a>
            
              , <a href="/tags/openrouter">OpenRouter</a>
            
              , <a href="/tags/multi-agent-system">Multi-Agent System</a>
            
              , <a href="/tags/hdb-insights">HDB Insights</a>
            
              , <a href="/tags/natural-language-querying">Natural Language Querying</a>
            
              , <a href="/tags/real-estate-data">Real Estate Data</a>
            
              , <a href="/tags/docker">Docker</a>
            
              , <a href="/tags/ai-engineering">AI Engineering</a>
            
              , <a href="/tags/singapore-open-data">Singapore Open Data</a>
            
          </span>
        

        
      </div>
    </header>

    
      
      
      <div class="post-cover-container post-cover--artistic-blur-wrapper">
        
          <div class="post-cover-blur-background" style="--bg-image: url('/images/deepagent/autonomous-deepagents-for-hdb-insights.png');"></div>
          <img src="/images/deepagent/autonomous-deepagents-for-hdb-insights.png" alt="Autonomous DeepAgents for HDB Insights cover image" class="post-cover-image post-cover-image--artistic-blur">
        
      </div>
    

    <section class="post-content">
      <p>Following up on my previous post, 






  <a href="/posts/2025/11/building-a-langgraph-multi-agent-system/" >Building a LangGraph Multi-Agent System</a>
, this article extends that foundation into a fully autonomous, DeepAgents-powered multi-agent pipeline for HDB insights.</p>
<p>This iteration brings together:</p>
<ul>
<li>Geospatial reasoning across MRT exits, HDB building polygons, and a foundation that can be extended to schools, parks, and amenities in the future</li>
<li>A LangGraph state machine orchestrating intent → SQL → geospatial queries → MRT enrichment → summarization</li>
<li>A streamlined CLI (and optional Gradio UI) for natural-language property search</li>
</ul>
<p>The result is an <strong>autonomous HDB insights assistant</strong> that can answer complex, real-world questions such as:</p>
<ul>
<li>“Find 4-room units in Toa Payoh under 600k near MRT exits.”</li>
<li>“Show me flats within 500m of Bukit Batok MRT with good value.”</li>
<li>“Which Bishan blocks have resale units closest to public transport?”</li>
</ul>
<h2 id="setup">Setup</h2>
<h3 id="postgresql-extensions">PostgreSQL Extensions</h3>
<p>We begin by enabling PostGIS, which powers all geospatial queries in this pipeline:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span>EXTENSION<span style="color:#fff"> </span><span style="color:#cf222e">IF</span><span style="color:#fff"> </span><span style="color:#cf222e">NOT</span><span style="color:#fff"> </span><span style="color:#cf222e">EXISTS</span><span style="color:#fff"> </span>postgis<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">SELECT</span><span style="color:#fff"> </span>extname<span style="color:#1f2328">,</span><span style="color:#fff"> </span>extversion<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">FROM</span><span style="color:#fff"> </span>pg_extension<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">WHERE</span><span style="color:#fff"> </span>extname<span style="color:#fff"> </span><span style="color:#cf222e">IN</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;postgis&#39;</span><span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#57606a">-- Expected resulta:
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">-- extversion	extname
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">-- 3.6.1	postgis</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="init-project">Init Project</h3>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>git clone https<span style="color:#f6f8fa;background-color:#82071e">:</span><span style="color:#1f2328">//</span>github<span style="color:#1f2328">.</span>com<span style="color:#1f2328">/</span>seehiong<span style="color:#1f2328">/</span><span style="color:#6639ba">autonomous-hdb</span>-deepagents<span style="color:#1f2328">.</span>git
</span></span><span style="display:flex;"><span><span style="color:#6639ba">cd autonomous-hdb</span>-deepagents
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>uv sync
</span></span><span style="display:flex;"><span><span style="color:#1f2328">.</span>venv<span style="color:#1f2328">\</span>Scripts<span style="color:#1f2328">\</span>activate</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h2 id="data-ingestion">Data Ingestion</h2>
<p>This project relies on <strong>three primary data pillars</strong>:</p>
<ul>
<li>HDB building geometries</li>
<li>MRT station exits</li>
<li>Geocoded points of interest (via OneMap)</li>
</ul>
<p>These form the critical spatial substrate that allows the deep agent to “reason” about distance, proximity, and locality.</p>
<h3 id="hdb---existing-building-dataset">HDB - Existing Building Dataset</h3>
<p>Dataset:</p>
<blockquote>
<p>Housing &amp; Development Board. (2023). HDB Existing Building (2025) [Dataset]. data.gov.sg. Retrieved December 3, 2025 from 






  <a href="https://data.gov.sg/datasets/d_16b157c52ed637edd6ba1232e026258d/view" target="_blank" rel="noopener noreferrer" >https://data.gov.sg/datasets/d_16b157c52ed637edd6ba1232e026258d/view</a>
</p></blockquote>
<p>This dataset is used to build the infrastructure table for HDB block shapes and centroids. Create a Jupyter notebook named <code>hdb-existing-building.ipynb</code>.</p>
<h4 id="1-sql-table-creation">1. SQL Table Creation</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span><span style="color:#cf222e">TABLE</span><span style="color:#fff"> </span><span style="color:#cf222e">IF</span><span style="color:#fff"> </span><span style="color:#cf222e">NOT</span><span style="color:#fff"> </span><span style="color:#cf222e">EXISTS</span><span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>hdb_blocks<span style="color:#fff"> </span><span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>objectid<span style="color:#fff"> </span><span style="color:#6639ba">BIGINT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>blk_no<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>street_code<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>entity_id<span style="color:#fff"> </span><span style="color:#6639ba">BIGINT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>postal_code<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>inc_crc<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>updated_at<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>shape_area<span style="color:#fff"> </span>DOUBLE<span style="color:#fff"> </span><span style="color:#cf222e">PRECISION</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>shape_len<span style="color:#fff"> </span>DOUBLE<span style="color:#fff"> </span><span style="color:#cf222e">PRECISION</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>geom_4326<span style="color:#fff"> </span>geometry<span style="color:#1f2328">(</span>MultiPolygon<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">4326</span><span style="color:#1f2328">),</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>geom_3414<span style="color:#fff"> </span>geometry<span style="color:#1f2328">(</span>MultiPolygon<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">3414</span><span style="color:#1f2328">),</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>centroid_4326<span style="color:#fff"> </span>geometry<span style="color:#1f2328">(</span>Point<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">4326</span><span style="color:#1f2328">),</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>centroid_3414<span style="color:#fff"> </span>geometry<span style="color:#1f2328">(</span>Point<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">3414</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">);</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="2-load-geojson">2. Load GeoJSON</h4>
<p>This step extracts polygons and centroids, preparing them for spatial indexing.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">json</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">pandas</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">pd</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">shapely.geometry</span> <span style="color:#cf222e">import</span> shape
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">shapely.wkt</span> <span style="color:#cf222e">import</span> dumps <span style="color:#cf222e">as</span> wkt_dumps
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>geo_path <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;data/HDBExistingBuilding.geojson&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">with</span> <span style="color:#6639ba">open</span><span style="color:#1f2328">(</span>geo_path<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;r&#34;</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">as</span> f<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    gj <span style="color:#0550ae">=</span> json<span style="color:#0550ae">.</span>load<span style="color:#1f2328">(</span>f<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rows <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">for</span> feature <span style="color:#0550ae">in</span> gj<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;features&#34;</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>    geom <span style="color:#0550ae">=</span> shape<span style="color:#1f2328">(</span>feature<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;geometry&#34;</span><span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>    props <span style="color:#0550ae">=</span> feature<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;properties&#34;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    rows<span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;objectid&#34;</span><span style="color:#1f2328">:</span> props<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;OBJECTID&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;blk_no&#34;</span><span style="color:#1f2328">:</span> props<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;BLK_NO&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;street_code&#34;</span><span style="color:#1f2328">:</span> props<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;ST_COD&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;entity_id&#34;</span><span style="color:#1f2328">:</span> props<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;ENTITYID&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;postal_code&#34;</span><span style="color:#1f2328">:</span> props<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;POSTAL_COD&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;inc_crc&#34;</span><span style="color:#1f2328">:</span> props<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;INC_CRC&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;updated_at&#34;</span><span style="color:#1f2328">:</span> props<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;FMEL_UPD_D&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;shape_area&#34;</span><span style="color:#1f2328">:</span> props<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;SHAPE.AREA&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;shape_len&#34;</span><span style="color:#1f2328">:</span> props<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;SHAPE.LEN&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;geom_wkt&#34;</span><span style="color:#1f2328">:</span> wkt_dumps<span style="color:#1f2328">(</span>geom<span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;centroid_wkt&#34;</span><span style="color:#1f2328">:</span> wkt_dumps<span style="color:#1f2328">(</span>geom<span style="color:#0550ae">.</span>centroid<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>df <span style="color:#0550ae">=</span> pd<span style="color:#0550ae">.</span>DataFrame<span style="color:#1f2328">(</span>rows<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>df<span style="color:#0550ae">.</span>head<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Sample Outputs</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># objectid	blk_no	street_code	entity_id	postal_code	inc_crc	            updated_at	    shape_area	shape_len	geom_wkt	                                        centroid_wkt</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># 0	898584	514	    BUS14E	    8235	    650514	    74585E59F18D2E73	20130426120328	1033.685604	253.971941	POLYGON ((103.7529821808343655 1.3544208894918...	POINT (103.7525891826131073 1.3544681945247203)</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># 1	898585	21	    TEG02M	    6192	    600021	    1550C06FF96161F6	20130426120305	1046.092028	397.417077	POLYGON ((103.7392355494047109 1.3236971900920...	POINT (103.7392896961472388 1.3236959487788726)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="3-insert-into-postgres">3. Insert into Postgres</h4>
<p>This batch insertion ensures efficient ingestion of ~13k block geometries.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">sqlalchemy</span> <span style="color:#cf222e">import</span> create_engine<span style="color:#1f2328">,</span> text
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">time</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">requests</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">pandas</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">pd</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">time</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">sqlalchemy</span> <span style="color:#cf222e">import</span> create_engine<span style="color:#1f2328">,</span> text
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">tqdm.auto</span> <span style="color:#cf222e">import</span> tqdm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># DB connection</span>
</span></span><span style="display:flex;"><span>engine <span style="color:#0550ae">=</span> create_engine<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;postgresql://postgres:postgres@postgres-postgresql.postgres:5432/postgres&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BATCH_SIZE <span style="color:#0550ae">=</span> <span style="color:#0550ae">50</span>
</span></span><span style="display:flex;"><span>MAX_RETRIES <span style="color:#0550ae">=</span> <span style="color:#0550ae">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">insert_batch</span><span style="color:#1f2328">(</span>batch_df<span style="color:#1f2328">,</span> retry_count<span style="color:#0550ae">=</span><span style="color:#0550ae">0</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">with</span> engine<span style="color:#0550ae">.</span>begin<span style="color:#1f2328">()</span> <span style="color:#cf222e">as</span> conn<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">for</span> _<span style="color:#1f2328">,</span> row <span style="color:#0550ae">in</span> batch_df<span style="color:#0550ae">.</span>iterrows<span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>                conn<span style="color:#0550ae">.</span>execute<span style="color:#1f2328">(</span>text<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                    INSERT INTO public.hdb_blocks (
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                        objectid, blk_no, street_code, entity_id, postal_code,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                        inc_crc, updated_at, shape_area, shape_len,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                        geom_4326, geom_3414,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                        centroid_4326, centroid_3414
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                    )
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                    VALUES (
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                        :objectid, :blk_no, :street_code, :entity_id, :postal_code,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                        :inc_crc, :updated_at, :shape_area, :shape_len,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                        ST_SetSRID(ST_GeomFromText(:geom_4326), 4326),
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                        ST_Transform(ST_SetSRID(ST_GeomFromText(:geom_4326), 4326), 3414),
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                        ST_SetSRID(ST_GeomFromText(:centroid_4326), 4326),
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                        ST_Transform(ST_SetSRID(ST_GeomFromText(:centroid_4326), 4326), 3414)
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                    );
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                &#34;&#34;&#34;</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;objectid&#34;</span><span style="color:#1f2328">:</span> row<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;objectid&#34;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;blk_no&#34;</span><span style="color:#1f2328">:</span> row<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;blk_no&#34;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;street_code&#34;</span><span style="color:#1f2328">:</span> row<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;street_code&#34;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;entity_id&#34;</span><span style="color:#1f2328">:</span> row<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;entity_id&#34;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;postal_code&#34;</span><span style="color:#1f2328">:</span> row<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;postal_code&#34;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;inc_crc&#34;</span><span style="color:#1f2328">:</span> row<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;inc_crc&#34;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;updated_at&#34;</span><span style="color:#1f2328">:</span> row<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;updated_at&#34;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;shape_area&#34;</span><span style="color:#1f2328">:</span> row<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;shape_area&#34;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;shape_len&#34;</span><span style="color:#1f2328">:</span> row<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;shape_len&#34;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;geom_4326&#34;</span><span style="color:#1f2328">:</span> row<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;geom_wkt&#34;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;centroid_4326&#34;</span><span style="color:#1f2328">:</span> row<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;centroid_wkt&#34;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">True</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> retry_count <span style="color:#0550ae">&lt;</span> MAX_RETRIES<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;⚠ Batch failed: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>e<span style="color:#1f2328">)[:</span><span style="color:#0550ae">100</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">... Retrying (</span><span style="color:#0a3069">{</span>retry_count <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span><span style="color:#0a3069">}</span><span style="color:#0a3069">/</span><span style="color:#0a3069">{</span>MAX_RETRIES<span style="color:#0a3069">}</span><span style="color:#0a3069">)...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            time<span style="color:#0550ae">.</span>sleep<span style="color:#1f2328">(</span><span style="color:#0550ae">2</span> <span style="color:#0550ae">**</span> retry_count<span style="color:#1f2328">)</span>  <span style="color:#57606a"># Exponential backoff</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> insert_batch<span style="color:#1f2328">(</span>batch_df<span style="color:#1f2328">,</span> retry_count <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;✗ Batch failed after </span><span style="color:#0a3069">{</span>MAX_RETRIES<span style="color:#0a3069">}</span><span style="color:#0a3069"> retries&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Process in batches</span>
</span></span><span style="display:flex;"><span>total_batches <span style="color:#0550ae">=</span> <span style="color:#1f2328">(</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>df<span style="color:#1f2328">)</span> <span style="color:#0550ae">+</span> BATCH_SIZE <span style="color:#0550ae">-</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">//</span> BATCH_SIZE
</span></span><span style="display:flex;"><span>successful <span style="color:#0550ae">=</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">for</span> i <span style="color:#0550ae">in</span> <span style="color:#6639ba">range</span><span style="color:#1f2328">(</span><span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>df<span style="color:#1f2328">),</span> BATCH_SIZE<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    batch <span style="color:#0550ae">=</span> df<span style="color:#0550ae">.</span>iloc<span style="color:#1f2328">[</span>i<span style="color:#1f2328">:</span>i<span style="color:#0550ae">+</span>BATCH_SIZE<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    batch_num <span style="color:#0550ae">=</span> i <span style="color:#0550ae">//</span> BATCH_SIZE <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Processing batch </span><span style="color:#0a3069">{</span>batch_num<span style="color:#0a3069">}</span><span style="color:#0a3069">/</span><span style="color:#0a3069">{</span>total_batches<span style="color:#0a3069">}</span><span style="color:#0a3069">...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> insert_batch<span style="color:#1f2328">(</span>batch<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        successful <span style="color:#0550ae">+=</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>batch<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;  ✔ Batch </span><span style="color:#0a3069">{</span>batch_num<span style="color:#0a3069">}</span><span style="color:#0a3069"> complete (</span><span style="color:#0a3069">{</span>successful<span style="color:#0a3069">}</span><span style="color:#0a3069">/</span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>df<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> total)&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;  ✗ Batch </span><span style="color:#0a3069">{</span>batch_num<span style="color:#0a3069">}</span><span style="color:#0a3069"> failed&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">✔ Completed: </span><span style="color:#0a3069">{</span>successful<span style="color:#0a3069">}</span><span style="color:#0a3069">/</span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>df<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> records inserted&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Sample Outputs</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Processing batch 1/268...</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">#   ✔ Batch 1 complete (50/13352 total)</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Processing batch 2/268...</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">#   ✔ Batch 2 complete (100/13352 total)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="lta---mrt-station-exit">LTA - MRT Station Exit</h3>
<p>Dataset:</p>
<blockquote>
<p>Land Transport Authority. (2019). LTA MRT Station Exit (GEOJSON) (2025) [Dataset]. data.gov.sg. Retrieved December 3, 2025 from 






  <a href="https://data.gov.sg/datasets/d_b39d3a0871985372d7e1637193335da5/view" target="_blank" rel="noopener noreferrer" >https://data.gov.sg/datasets/d_b39d3a0871985372d7e1637193335da5/view</a>
</p></blockquote>
<p>Create the notebook <code>lta-mrt-exits.ipynb</code>.</p>
<h4 id="1-sql-table-for-mrt-exits">1. SQL Table for MRT Exits</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span><span style="color:#cf222e">TABLE</span><span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>mrt_exits<span style="color:#fff"> </span><span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>objectid<span style="color:#fff"> </span><span style="color:#6639ba">INTEGER</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>station_name<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>exit_code<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>inc_crc<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>updated_at<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>lon<span style="color:#fff"> </span>DOUBLE<span style="color:#fff"> </span><span style="color:#cf222e">PRECISION</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>lat<span style="color:#fff"> </span>DOUBLE<span style="color:#fff"> </span><span style="color:#cf222e">PRECISION</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>geom_4326<span style="color:#fff"> </span>geometry<span style="color:#1f2328">(</span>Point<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">4326</span><span style="color:#1f2328">),</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>geom_3414<span style="color:#fff"> </span>geometry<span style="color:#1f2328">(</span>Point<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">3414</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="2-load-geojson-into-dataframe">2. Load GeoJSON into DataFrame</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">json</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">pandas</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">pd</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">sqlalchemy</span> <span style="color:#cf222e">import</span> create_engine<span style="color:#1f2328">,</span> text
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Load GeoJSON file</span>
</span></span><span style="display:flex;"><span>geojson_path <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;data/LTAMRTStationExitGEOJSON.geojson&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">with</span> <span style="color:#6639ba">open</span><span style="color:#1f2328">(</span>geojson_path<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;r&#34;</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">as</span> f<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    gj <span style="color:#0550ae">=</span> json<span style="color:#0550ae">.</span>load<span style="color:#1f2328">(</span>f<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Convert GeoJSON features to DataFrame rows</span>
</span></span><span style="display:flex;"><span>rows <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">for</span> feature <span style="color:#0550ae">in</span> gj<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;features&#34;</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>    props <span style="color:#0550ae">=</span> feature<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;properties&#34;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    lon<span style="color:#1f2328">,</span> lat <span style="color:#0550ae">=</span> feature<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;geometry&#34;</span><span style="color:#1f2328">][</span><span style="color:#0a3069">&#34;coordinates&#34;</span><span style="color:#1f2328">]</span>  <span style="color:#57606a"># GeoJSON = lon, lat</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    rows<span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;objectid&#34;</span><span style="color:#1f2328">:</span> props<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;OBJECTID&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;station_name&#34;</span><span style="color:#1f2328">:</span> props<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;STATION_NA&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;exit_code&#34;</span><span style="color:#1f2328">:</span> props<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;EXIT_CODE&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;inc_crc&#34;</span><span style="color:#1f2328">:</span> props<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;INC_CRC&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;updated_at&#34;</span><span style="color:#1f2328">:</span> props<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;FMEL_UPD_D&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;lon&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">float</span><span style="color:#1f2328">(</span>lon<span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;lat&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">float</span><span style="color:#1f2328">(</span>lat<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>df <span style="color:#0550ae">=</span> pd<span style="color:#0550ae">.</span>DataFrame<span style="color:#1f2328">(</span>rows<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>df<span style="color:#0550ae">.</span>head<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Sample outputs</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">#   objectid	station_name	        exit_code	inc_crc	            updated_at	    lon	        lat</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># 0	14641   	JELAPANG LRT STATION	Exit A	    45CDB0D9BDC73079	20231019120510	103.764677	1.386833</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># 1	14642	    SEGAR LRT STATION	    Exit A	    54BFE6EB924CBA6F	20231019120510	103.769410	1.387812</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="3-insert-into-postgres-1">3. Insert into Postgres</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">sqlalchemy</span> <span style="color:#cf222e">import</span> create_engine
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># DB connection</span>
</span></span><span style="display:flex;"><span>engine <span style="color:#0550ae">=</span> create_engine<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;postgresql://postgres:postgres@postgres-postgresql.postgres:5432/postgres&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">with</span> engine<span style="color:#0550ae">.</span>begin<span style="color:#1f2328">()</span> <span style="color:#cf222e">as</span> conn<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> _<span style="color:#1f2328">,</span> row <span style="color:#0550ae">in</span> df<span style="color:#0550ae">.</span>iterrows<span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>        conn<span style="color:#0550ae">.</span>execute<span style="color:#1f2328">(</span>text<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            INSERT INTO public.mrt_exits (
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                objectid, station_name, exit_code, inc_crc, updated_at,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                lon, lat,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                geom_4326,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                geom_3414
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            )
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            VALUES (
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                :objectid, :station_name, :exit_code, :inc_crc, :updated_at,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                :lon, :lat,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                ST_SetSRID(ST_Point(:lon, :lat), 4326),
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                ST_Transform(ST_SetSRID(ST_Point(:lon, :lat), 4326), 3414)
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            );
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span><span style="color:#1f2328">),</span> row<span style="color:#0550ae">.</span>to_dict<span style="color:#1f2328">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;✅ MRT exits ingested with geom_4326 and geom_3414!&#34;</span><span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><p>This gives us a reliable, spatially precise mapping between MRT exits and their locations.</p>
<h3 id="centralized-geocoding-cache">Centralized Geocoding Cache</h3>
<p>To avoid repeated calls to OneMap (and avoid rate limits), we build a <strong>centralized geocode cache</strong> with upsert logic and canonicalized street names.</p>
<p>This component becomes invaluable when merging HDB datasets, which often use different street naming conventions.</p>
<h4 id="1-retrieve-onemap-access-token">1. Retrieve OneMap Access Token</h4>
<p>Ensure that the <code>.env</code> file contains <strong>ONEMAP_EMAIL</strong> and <strong>ONEMAP_EMAIL_PASSWORD</strong>.<br>
Let&rsquo;s do this in <code>onemap-geocoding-cache.ipynb</code>.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">dotenv</span> <span style="color:#cf222e">import</span> load_dotenv
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">requests</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">os</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>load_dotenv<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>url <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;https://www.onemap.gov.sg/api/auth/post/getToken&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;email&#34;</span><span style="color:#1f2328">:</span> os<span style="color:#0550ae">.</span>environ<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;ONEMAP_EMAIL&#39;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;password&#34;</span><span style="color:#1f2328">:</span> os<span style="color:#0550ae">.</span>environ<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;ONEMAP_EMAIL_PASSWORD&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>response <span style="color:#0550ae">=</span> requests<span style="color:#0550ae">.</span>request<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;POST&#34;</span><span style="color:#1f2328">,</span> url<span style="color:#1f2328">,</span> json<span style="color:#0550ae">=</span>payload<span style="color:#1f2328">)</span>   
</span></span><span style="display:flex;"><span>response_data <span style="color:#0550ae">=</span> response<span style="color:#0550ae">.</span>json<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>access_token <span style="color:#0550ae">=</span> response_data<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;access_token&#39;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>os<span style="color:#0550ae">.</span>environ<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;ONEMAP_ACCESS_TOKEN&#39;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> access_token</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="2-create-cache-table">2. Create Cache Table</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span><span style="color:#cf222e">TABLE</span><span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>geocode_cache<span style="color:#fff"> </span><span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>search_text<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#fff"> </span><span style="color:#cf222e">PRIMARY</span><span style="color:#fff"> </span><span style="color:#cf222e">KEY</span><span style="color:#1f2328">,</span><span style="color:#fff">   </span><span style="color:#57606a">-- search key (postal or address)
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#fff">    </span>blk_no<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>road_name<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>building<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>address<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>postal<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>lat<span style="color:#fff"> </span>DOUBLE<span style="color:#fff"> </span><span style="color:#cf222e">PRECISION</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>lon<span style="color:#fff"> </span>DOUBLE<span style="color:#fff"> </span><span style="color:#cf222e">PRECISION</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>x<span style="color:#fff"> </span>DOUBLE<span style="color:#fff"> </span><span style="color:#cf222e">PRECISION</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>y<span style="color:#fff"> </span>DOUBLE<span style="color:#fff"> </span><span style="color:#cf222e">PRECISION</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>geom_4326<span style="color:#fff"> </span>geometry<span style="color:#1f2328">(</span>Point<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">4326</span><span style="color:#1f2328">),</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>geom_3414<span style="color:#fff"> </span>geometry<span style="color:#1f2328">(</span>Point<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">3414</span><span style="color:#1f2328">),</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>updated_at<span style="color:#fff"> </span>TIMESTAMPTZ<span style="color:#fff"> </span><span style="color:#cf222e">DEFAULT</span><span style="color:#fff"> </span>NOW<span style="color:#1f2328">()</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span><span style="color:#cf222e">INDEX</span><span style="color:#fff"> </span>geocode_cache_postal_idx<span style="color:#fff"> </span><span style="color:#cf222e">ON</span><span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>geocode_cache<span style="color:#1f2328">(</span>postal<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span><span style="color:#cf222e">INDEX</span><span style="color:#fff"> </span>geocode_cache_geom_idx<span style="color:#fff"> </span><span style="color:#cf222e">ON</span><span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>geocode_cache<span style="color:#fff"> </span><span style="color:#cf222e">USING</span><span style="color:#fff"> </span>GIST<span style="color:#fff"> </span><span style="color:#1f2328">(</span>geom_3414<span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="3-upsert-function">3. Upsert Function</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span><span style="color:#cf222e">OR</span><span style="color:#fff"> </span><span style="color:#cf222e">REPLACE</span><span style="color:#fff"> </span><span style="color:#cf222e">FUNCTION</span><span style="color:#fff"> </span>upsert_geocode_cached<span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>p_search<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>p_blk_no<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>p_road_name<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>p_building<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>p_address<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>p_postal<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>p_lat<span style="color:#fff"> </span>DOUBLE<span style="color:#fff"> </span><span style="color:#cf222e">PRECISION</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>p_lon<span style="color:#fff"> </span>DOUBLE<span style="color:#fff"> </span><span style="color:#cf222e">PRECISION</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>p_x<span style="color:#fff"> </span>DOUBLE<span style="color:#fff"> </span><span style="color:#cf222e">PRECISION</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>p_y<span style="color:#fff"> </span>DOUBLE<span style="color:#fff"> </span><span style="color:#cf222e">PRECISION</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">RETURNS</span><span style="color:#fff"> </span>VOID<span style="color:#fff"> </span><span style="color:#cf222e">AS</span><span style="color:#fff"> </span><span style="color:#f6f8fa;background-color:#82071e">$$</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">BEGIN</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">INSERT</span><span style="color:#fff"> </span><span style="color:#cf222e">INTO</span><span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>geocode_cache<span style="color:#fff"> </span><span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>search_text<span style="color:#1f2328">,</span><span style="color:#fff"> </span>blk_no<span style="color:#1f2328">,</span><span style="color:#fff"> </span>road_name<span style="color:#1f2328">,</span><span style="color:#fff"> </span>building<span style="color:#1f2328">,</span><span style="color:#fff"> </span>address<span style="color:#1f2328">,</span><span style="color:#fff"> </span>postal<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>lat<span style="color:#1f2328">,</span><span style="color:#fff"> </span>lon<span style="color:#1f2328">,</span><span style="color:#fff"> </span>x<span style="color:#1f2328">,</span><span style="color:#fff"> </span>y<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>geom_4326<span style="color:#1f2328">,</span><span style="color:#fff"> </span>geom_3414<span style="color:#1f2328">,</span><span style="color:#fff"> </span>updated_at<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">VALUES</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>p_search<span style="color:#1f2328">,</span><span style="color:#fff"> </span>p_blk_no<span style="color:#1f2328">,</span><span style="color:#fff"> </span>p_road_name<span style="color:#1f2328">,</span><span style="color:#fff"> </span>p_building<span style="color:#1f2328">,</span><span style="color:#fff"> </span>p_address<span style="color:#1f2328">,</span><span style="color:#fff"> </span>p_postal<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>p_lat<span style="color:#1f2328">,</span><span style="color:#fff"> </span>p_lon<span style="color:#1f2328">,</span><span style="color:#fff"> </span>p_x<span style="color:#1f2328">,</span><span style="color:#fff"> </span>p_y<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>ST_SetSRID<span style="color:#1f2328">(</span>ST_Point<span style="color:#1f2328">(</span>p_lon<span style="color:#1f2328">,</span><span style="color:#fff"> </span>p_lat<span style="color:#1f2328">),</span><span style="color:#fff"> </span><span style="color:#0550ae">4326</span><span style="color:#1f2328">),</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>ST_Transform<span style="color:#1f2328">(</span>ST_SetSRID<span style="color:#1f2328">(</span>ST_Point<span style="color:#1f2328">(</span>p_lon<span style="color:#1f2328">,</span><span style="color:#fff"> </span>p_lat<span style="color:#1f2328">),</span><span style="color:#fff"> </span><span style="color:#0550ae">4326</span><span style="color:#1f2328">),</span><span style="color:#fff"> </span><span style="color:#0550ae">3414</span><span style="color:#1f2328">),</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>NOW<span style="color:#1f2328">()</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">ON</span><span style="color:#fff"> </span>CONFLICT<span style="color:#fff"> </span><span style="color:#1f2328">(</span>search_text<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">DO</span><span style="color:#fff"> </span><span style="color:#cf222e">UPDATE</span><span style="color:#fff"> </span><span style="color:#cf222e">SET</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>blk_no<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>EXCLUDED<span style="color:#1f2328">.</span>blk_no<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>road_name<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>EXCLUDED<span style="color:#1f2328">.</span>road_name<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>building<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>EXCLUDED<span style="color:#1f2328">.</span>building<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>address<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>EXCLUDED<span style="color:#1f2328">.</span>address<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>postal<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>EXCLUDED<span style="color:#1f2328">.</span>postal<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>lat<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>EXCLUDED<span style="color:#1f2328">.</span>lat<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>lon<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>EXCLUDED<span style="color:#1f2328">.</span>lon<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>x<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>EXCLUDED<span style="color:#1f2328">.</span>x<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>y<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>EXCLUDED<span style="color:#1f2328">.</span>y<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>geom_4326<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>EXCLUDED<span style="color:#1f2328">.</span>geom_4326<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>geom_3414<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>EXCLUDED<span style="color:#1f2328">.</span>geom_3414<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>updated_at<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>NOW<span style="color:#1f2328">();</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">END</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#f6f8fa;background-color:#82071e">$$</span><span style="color:#fff"> </span><span style="color:#cf222e">LANGUAGE</span><span style="color:#fff"> </span>plpgsql<span style="color:#1f2328">;</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="4-imports--db-setup">4. Imports &amp; DB Setup</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">requests</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">pandas</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">pd</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">time</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">sqlalchemy</span> <span style="color:#cf222e">import</span> create_engine<span style="color:#1f2328">,</span> text
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">tqdm.auto</span> <span style="color:#cf222e">import</span> tqdm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># DB connection</span>
</span></span><span style="display:flex;"><span>engine <span style="color:#0550ae">=</span> create_engine<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;postgresql://postgres:postgres@postgres-postgresql.postgres:5432/postgres&#34;</span><span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="5-load-all-unique-postal-codes">5. Load All Unique Postal Codes</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>query <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">SELECT DISTINCT postal FROM (
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    SELECT postal_code AS postal FROM sg_schools WHERE postal_code IS NOT NULL
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    UNION
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    SELECT postal_code AS postal FROM hdb_blocks WHERE postal_code IS NOT NULL
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">) AS all_postals
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">WHERE postal ~ &#39;^[0-9]</span><span style="color:#0a3069">{6}</span><span style="color:#0a3069">$&#39;;     -- only valid SG postal codes
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>postal_df <span style="color:#0550ae">=</span> pd<span style="color:#0550ae">.</span>read_sql<span style="color:#1f2328">(</span>query<span style="color:#1f2328">,</span> engine<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>postal_list <span style="color:#0550ae">=</span> <span style="color:#6639ba">sorted</span><span style="color:#1f2328">(</span>postal_df<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;postal&#39;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>unique<span style="color:#1f2328">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;📌 Total unique postal codes found: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>postal_list<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>postal_list<span style="color:#1f2328">[:</span><span style="color:#0550ae">10</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Sample Outputs</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># 📌 Total unique postal codes found: 13683</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># [&#39;050004&#39;,</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">#  &#39;050005&#39;,</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="6-onemap-geocoder">6. OneMap Geocoder</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">geocode_postal</span><span style="color:#1f2328">(</span>postal<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;Reliable OneMap geocoder for SG postal codes with full metadata.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    url <span style="color:#0550ae">=</span> <span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;https://www.onemap.gov.sg/api/common/elastic/search&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;?searchVal=</span><span style="color:#0a3069">{</span>postal<span style="color:#0a3069">}</span><span style="color:#0a3069">&amp;returnGeom=Y&amp;getAddrDetails=Y&amp;pageNum=1&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    headers <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;User-Agent&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;Mozilla/5.0&#34;</span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        r <span style="color:#0550ae">=</span> requests<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span>url<span style="color:#1f2328">,</span> headers<span style="color:#0550ae">=</span>headers<span style="color:#1f2328">,</span> timeout<span style="color:#0550ae">=</span><span style="color:#0550ae">8</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> r<span style="color:#0550ae">.</span>status_code <span style="color:#0550ae">!=</span> <span style="color:#0550ae">200</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        data <span style="color:#0550ae">=</span> r<span style="color:#0550ae">.</span>json<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        results <span style="color:#0550ae">=</span> data<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;results&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> results<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        r0 <span style="color:#0550ae">=</span> results<span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># identifiers</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;blk_no&#34;</span><span style="color:#1f2328">:</span> r0<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;BLK_NO&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;road_name&#34;</span><span style="color:#1f2328">:</span> r0<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;ROAD_NAME&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;building&#34;</span><span style="color:#1f2328">:</span> r0<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;BUILDING&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;address&#34;</span><span style="color:#1f2328">:</span> r0<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;ADDRESS&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;postal&#34;</span><span style="color:#1f2328">:</span> r0<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;POSTAL&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># coordinates: WGS84 (lat/lon)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;lat&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">float</span><span style="color:#1f2328">(</span>r0<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;LATITUDE&#34;</span><span style="color:#1f2328">)),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;lon&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">float</span><span style="color:#1f2328">(</span>r0<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;LONGITUDE&#34;</span><span style="color:#1f2328">)),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># coordinates: SVY21 (x/y)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;x&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">float</span><span style="color:#1f2328">(</span>r0<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;X&#34;</span><span style="color:#1f2328">)),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;y&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">float</span><span style="color:#1f2328">(</span>r0<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Y&#34;</span><span style="color:#1f2328">)),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;⚠ Geocoder error for </span><span style="color:#0a3069">{</span>postal<span style="color:#0a3069">}</span><span style="color:#0a3069">: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="7-retry-wrapper">7. Retry Wrapper</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">safe_geocode</span><span style="color:#1f2328">(</span>postal<span style="color:#1f2328">,</span> retries<span style="color:#0550ae">=</span><span style="color:#0550ae">3</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> attempt <span style="color:#0550ae">in</span> <span style="color:#6639ba">range</span><span style="color:#1f2328">(</span>retries<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        result <span style="color:#0550ae">=</span> geocode_postal<span style="color:#1f2328">(</span>postal<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> result<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> result
</span></span><span style="display:flex;"><span>        time<span style="color:#0550ae">.</span>sleep<span style="color:#1f2328">(</span><span style="color:#0550ae">1</span> <span style="color:#0550ae">*</span> <span style="color:#1f2328">(</span>attempt <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="8-batch-geocode">8. Batch Geocode</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>cached_sql <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;SELECT search_text FROM geocode_cache;&#34;</span>
</span></span><span style="display:flex;"><span>cached_df <span style="color:#0550ae">=</span> pd<span style="color:#0550ae">.</span>read_sql<span style="color:#1f2328">(</span>cached_sql<span style="color:#1f2328">,</span> engine<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cached_set <span style="color:#0550ae">=</span> <span style="color:#6639ba">set</span><span style="color:#1f2328">(</span>cached_df<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;search_text&#34;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>str<span style="color:#0550ae">.</span>upper<span style="color:#1f2328">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;📦 Cached entries already in DB: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>cached_set<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Filter out postal codes already processed</span>
</span></span><span style="display:flex;"><span>todo <span style="color:#0550ae">=</span> <span style="color:#1f2328">[</span>p <span style="color:#cf222e">for</span> p <span style="color:#0550ae">in</span> postal_list <span style="color:#cf222e">if</span> p<span style="color:#0550ae">.</span>upper<span style="color:#1f2328">()</span> <span style="color:#0550ae">not</span> <span style="color:#0550ae">in</span> cached_set<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;🚀 Postal codes left to process: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>todo<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="9-upsert">9. Upsert</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>UPSERT_SQL <span style="color:#0550ae">=</span> text<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">SELECT upsert_geocode_cached(
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    :search_text,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    :blk_no,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    :road_name,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    :building,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    :address,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    :postal,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    :lat,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    :lon,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    :x,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    :y
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">);
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">&#34;&#34;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>progress <span style="color:#0550ae">=</span> tqdm<span style="color:#1f2328">(</span>todo<span style="color:#1f2328">,</span> desc<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;Geocoding postal codes&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">for</span> postal <span style="color:#0550ae">in</span> progress<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Call geocode API</span>
</span></span><span style="display:flex;"><span>    info <span style="color:#0550ae">=</span> safe_geocode<span style="color:#1f2328">(</span>postal<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> info<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;⚠ Failed to geocode </span><span style="color:#0a3069">{</span>postal<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Upsert into DB</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">with</span> engine<span style="color:#0550ae">.</span>begin<span style="color:#1f2328">()</span> <span style="color:#cf222e">as</span> conn<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        conn<span style="color:#0550ae">.</span>execute<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>            UPSERT_SQL<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;search_text&#34;</span><span style="color:#1f2328">:</span> postal<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;blk_no&#34;</span><span style="color:#1f2328">:</span> info<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;blk_no&#34;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;road_name&#34;</span><span style="color:#1f2328">:</span> info<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;road_name&#34;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;building&#34;</span><span style="color:#1f2328">:</span> info<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;building&#34;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;address&#34;</span><span style="color:#1f2328">:</span> info<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;address&#34;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;postal&#34;</span><span style="color:#1f2328">:</span> info<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;postal&#34;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;lat&#34;</span><span style="color:#1f2328">:</span> info<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;lat&#34;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;lon&#34;</span><span style="color:#1f2328">:</span> info<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;lon&#34;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;x&#34;</span><span style="color:#1f2328">:</span> info<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;x&#34;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;y&#34;</span><span style="color:#1f2328">:</span> info<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;y&#34;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    time<span style="color:#0550ae">.</span>sleep<span style="color:#1f2328">(</span><span style="color:#0550ae">0.12</span><span style="color:#1f2328">)</span>  <span style="color:#57606a"># protect against rate limiting</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Sample Outputs</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Geocoding postal codes: 100% [---] 13683/13683 [55:36&lt;00:00,  4.81it/s]</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="10-canonical-road-name-function">10. Canonical Road Name Function</h4>
<p>This function converts verbose street names into a standardized, compact form (e.g., AVENUE → AVE, GARDENS → GDNS).</p>
<p>It enables reliable joins between HDB property data, OneMap geocode results, and geospatial datasets.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span><span style="color:#cf222e">OR</span><span style="color:#fff"> </span><span style="color:#cf222e">REPLACE</span><span style="color:#fff"> </span><span style="color:#cf222e">FUNCTION</span><span style="color:#fff"> </span>canonicalize_road_name<span style="color:#1f2328">(</span>full_name<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">RETURNS</span><span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#fff"> </span><span style="color:#cf222e">AS</span><span style="color:#fff"> </span><span style="color:#f6f8fa;background-color:#82071e">$$</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">DECLARE</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>tokens<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">[];</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>t<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#fff"> </span><span style="color:#1f2328">:</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;&#39;</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">BEGIN</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">IF</span><span style="color:#fff"> </span>full_name<span style="color:#fff"> </span><span style="color:#cf222e">IS</span><span style="color:#fff"> </span><span style="color:#cf222e">NULL</span><span style="color:#fff"> </span><span style="color:#cf222e">THEN</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">RETURN</span><span style="color:#fff"> </span><span style="color:#cf222e">NULL</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">END</span><span style="color:#fff"> </span><span style="color:#cf222e">IF</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#57606a">-- Normalize spaces &amp; uppercase
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#fff">    </span>full_name<span style="color:#fff"> </span><span style="color:#1f2328">:</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">upper</span><span style="color:#1f2328">(</span>regexp_replace<span style="color:#1f2328">(</span>full_name<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;\s+&#39;</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39; &#39;</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;g&#39;</span><span style="color:#1f2328">));</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#57606a">-- Split into array of tokens
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#fff">    </span>tokens<span style="color:#fff"> </span><span style="color:#1f2328">:</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>string_to_array<span style="color:#1f2328">(</span>full_name<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39; &#39;</span><span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>FOREACH<span style="color:#fff"> </span>t<span style="color:#fff"> </span><span style="color:#cf222e">IN</span><span style="color:#fff"> </span><span style="color:#6639ba">ARRAY</span><span style="color:#fff"> </span>tokens<span style="color:#fff"> </span>LOOP<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">CASE</span><span style="color:#fff"> </span>t<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">WHEN</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;AVENUE&#39;</span><span style="color:#fff">     </span><span style="color:#cf222e">THEN</span><span style="color:#fff"> </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#1f2328">:</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#0550ae">||</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;AVE &#39;</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">WHEN</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;STREET&#39;</span><span style="color:#fff">     </span><span style="color:#cf222e">THEN</span><span style="color:#fff"> </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#1f2328">:</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#0550ae">||</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;ST &#39;</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">WHEN</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;ROAD&#39;</span><span style="color:#fff">       </span><span style="color:#cf222e">THEN</span><span style="color:#fff"> </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#1f2328">:</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#0550ae">||</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;RD &#39;</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">WHEN</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;DRIVE&#39;</span><span style="color:#fff">      </span><span style="color:#cf222e">THEN</span><span style="color:#fff"> </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#1f2328">:</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#0550ae">||</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;DR &#39;</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">WHEN</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;CRESCENT&#39;</span><span style="color:#fff">   </span><span style="color:#cf222e">THEN</span><span style="color:#fff"> </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#1f2328">:</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#0550ae">||</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;CRES &#39;</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">WHEN</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;GARDENS&#39;</span><span style="color:#fff">    </span><span style="color:#cf222e">THEN</span><span style="color:#fff"> </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#1f2328">:</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#0550ae">||</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;GDNS &#39;</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">WHEN</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;GARDEN&#39;</span><span style="color:#fff">     </span><span style="color:#cf222e">THEN</span><span style="color:#fff"> </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#1f2328">:</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#0550ae">||</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;GDN &#39;</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">WHEN</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;TERRACE&#39;</span><span style="color:#fff">    </span><span style="color:#cf222e">THEN</span><span style="color:#fff"> </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#1f2328">:</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#0550ae">||</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;TER &#39;</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">WHEN</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;HEIGHTS&#39;</span><span style="color:#fff">    </span><span style="color:#cf222e">THEN</span><span style="color:#fff"> </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#1f2328">:</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#0550ae">||</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;HTS &#39;</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">WHEN</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;PLACE&#39;</span><span style="color:#fff">      </span><span style="color:#cf222e">THEN</span><span style="color:#fff"> </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#1f2328">:</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#0550ae">||</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;PL &#39;</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">WHEN</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;BOULEVARD&#39;</span><span style="color:#fff">  </span><span style="color:#cf222e">THEN</span><span style="color:#fff"> </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#1f2328">:</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#0550ae">||</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;BLVD &#39;</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">WHEN</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;PARK&#39;</span><span style="color:#fff">       </span><span style="color:#cf222e">THEN</span><span style="color:#fff"> </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#1f2328">:</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#0550ae">||</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;PK &#39;</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">WHEN</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;CIRCLE&#39;</span><span style="color:#fff">     </span><span style="color:#cf222e">THEN</span><span style="color:#fff"> </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#1f2328">:</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#0550ae">||</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;CIR &#39;</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">WHEN</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;SQUARE&#39;</span><span style="color:#fff">     </span><span style="color:#cf222e">THEN</span><span style="color:#fff"> </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#1f2328">:</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#0550ae">||</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;SQ &#39;</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">ELSE</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#1f2328">:</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">out</span><span style="color:#fff"> </span><span style="color:#0550ae">||</span><span style="color:#fff"> </span>t<span style="color:#fff"> </span><span style="color:#0550ae">||</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39; &#39;</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">END</span><span style="color:#fff"> </span><span style="color:#cf222e">CASE</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">END</span><span style="color:#fff"> </span>LOOP<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">RETURN</span><span style="color:#fff"> </span><span style="color:#cf222e">trim</span><span style="color:#1f2328">(</span><span style="color:#cf222e">out</span><span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">END</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#f6f8fa;background-color:#82071e">$$</span><span style="color:#fff"> </span><span style="color:#cf222e">LANGUAGE</span><span style="color:#fff"> </span>plpgsql<span style="color:#fff"> </span><span style="color:#cf222e">IMMUTABLE</span><span style="color:#1f2328">;</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="11-add-new-column-to-geocode_cache">11. Add new column to geocode_cache</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#cf222e">ALTER</span><span style="color:#fff"> </span><span style="color:#cf222e">TABLE</span><span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>geocode_cache<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">ADD</span><span style="color:#fff"> </span><span style="color:#cf222e">COLUMN</span><span style="color:#fff"> </span>canonical_street<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">UPDATE</span><span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>geocode_cache<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">SET</span><span style="color:#fff"> </span>canonical_street<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>canonicalize_road_name<span style="color:#1f2328">(</span>road_name<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span><span style="color:#cf222e">INDEX</span><span style="color:#fff"> </span><span style="color:#cf222e">IF</span><span style="color:#fff"> </span><span style="color:#cf222e">NOT</span><span style="color:#fff"> </span><span style="color:#cf222e">EXISTS</span><span style="color:#fff"> </span>idx_geo_canonical_street<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">ON</span><span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>geocode_cache<span style="color:#1f2328">(</span>canonical_street<span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="hdb---property-information">HDB - Property Information</h3>
<p>Dataset:</p>
<blockquote>
<p>Housing &amp; Development Board. (2018). HDB Property Information (2025) [Dataset]. data.gov.sg. Retrieved December 3, 2025 from 






  <a href="https://data.gov.sg/datasets/d_17f5382f26140b1fdae0ba2ef6239d2f/view" target="_blank" rel="noopener noreferrer" >https://data.gov.sg/datasets/d_17f5382f26140b1fdae0ba2ef6239d2f/view</a>
</p></blockquote>
<p>This dataset is crucial for linking the logical representation of an HDB block (e.g., “BLK 100 Toa Payoh Lor 1”) with:</p>
<ul>
<li>A precise geospatial location</li>
<li>Block-level attributes (age, height, number of units)</li>
<li>Canonical identifiers such as postal code</li>
</ul>
<p>Create the notebook <code>hdb-property-info.ipynb</code>.</p>
<h4 id="1-creates-the-sql-script">1. Creates the SQL script</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span><span style="color:#cf222e">TABLE</span><span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>hdb_property_info<span style="color:#fff"> </span><span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>blk_no<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>street<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>max_floor_lvl<span style="color:#fff"> </span><span style="color:#6639ba">INT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>year_completed<span style="color:#fff"> </span><span style="color:#6639ba">INT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>residential<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>commercial<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>market_hawker<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>miscellaneous<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>multistorey_carpark<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>precinct_pavilion<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>bldg_contract_town<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>total_dwelling_units<span style="color:#fff"> </span><span style="color:#6639ba">INT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>room1_sold<span style="color:#fff"> </span><span style="color:#6639ba">INT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>room2_sold<span style="color:#fff"> </span><span style="color:#6639ba">INT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>room3_sold<span style="color:#fff"> </span><span style="color:#6639ba">INT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>room4_sold<span style="color:#fff"> </span><span style="color:#6639ba">INT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>room5_sold<span style="color:#fff"> </span><span style="color:#6639ba">INT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>exec_sold<span style="color:#fff"> </span><span style="color:#6639ba">INT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>multigen_sold<span style="color:#fff"> </span><span style="color:#6639ba">INT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>studio_apartment_sold<span style="color:#fff"> </span><span style="color:#6639ba">INT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>room1_rental<span style="color:#fff"> </span><span style="color:#6639ba">INT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>room2_rental<span style="color:#fff"> </span><span style="color:#6639ba">INT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>room3_rental<span style="color:#fff"> </span><span style="color:#6639ba">INT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>other_room_rental<span style="color:#fff"> </span><span style="color:#6639ba">INT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#57606a">-- Enrichment from OneMap
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#fff">    </span>postal<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>full_address<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>lon<span style="color:#fff"> </span>DOUBLE<span style="color:#fff"> </span><span style="color:#cf222e">PRECISION</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>lat<span style="color:#fff"> </span>DOUBLE<span style="color:#fff"> </span><span style="color:#cf222e">PRECISION</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>x<span style="color:#fff"> </span>DOUBLE<span style="color:#fff"> </span><span style="color:#cf222e">PRECISION</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>y<span style="color:#fff"> </span>DOUBLE<span style="color:#fff"> </span><span style="color:#cf222e">PRECISION</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>geom_4326<span style="color:#fff"> </span>geometry<span style="color:#1f2328">(</span>Point<span style="color:#1f2328">,</span><span style="color:#0550ae">4326</span><span style="color:#1f2328">),</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>geom_3414<span style="color:#fff"> </span>geometry<span style="color:#1f2328">(</span>Point<span style="color:#1f2328">,</span><span style="color:#0550ae">3414</span><span style="color:#1f2328">),</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>updated_at<span style="color:#fff"> </span>TIMESTAMPTZ<span style="color:#fff"> </span><span style="color:#cf222e">DEFAULT</span><span style="color:#fff"> </span>NOW<span style="color:#1f2328">()</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span><span style="color:#cf222e">INDEX</span><span style="color:#fff"> </span>hdb_property_info_block_idx<span style="color:#fff"> </span><span style="color:#cf222e">ON</span><span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>hdb_property_info<span style="color:#1f2328">(</span>blk_no<span style="color:#1f2328">,</span><span style="color:#fff"> </span>street<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span><span style="color:#cf222e">INDEX</span><span style="color:#fff"> </span>hdb_property_postal_idx<span style="color:#fff"> </span><span style="color:#cf222e">ON</span><span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>hdb_property_info<span style="color:#1f2328">(</span>postal<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span><span style="color:#cf222e">INDEX</span><span style="color:#fff"> </span>hdb_property_geom_idx<span style="color:#fff"> </span><span style="color:#cf222e">ON</span><span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>hdb_property_info<span style="color:#fff"> </span><span style="color:#cf222e">USING</span><span style="color:#fff"> </span>GIST<span style="color:#fff"> </span><span style="color:#1f2328">(</span>geom_3414<span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="2-load-the-csv">2. Load the CSV</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">pandas</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">pd</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>df <span style="color:#0550ae">=</span> pd<span style="color:#0550ae">.</span>read_csv<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;data/HDBPropertyInformation.csv&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>df<span style="color:#0550ae">.</span>columns <span style="color:#0550ae">=</span> <span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    df<span style="color:#0550ae">.</span>columns<span style="color:#0550ae">.</span>str<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>      <span style="color:#0550ae">.</span>str<span style="color:#0550ae">.</span>lower<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>      <span style="color:#0550ae">.</span>str<span style="color:#0550ae">.</span>replace<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34; &#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;_&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#0550ae">.</span>str<span style="color:#0550ae">.</span>replace<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;1room&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;room1&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#0550ae">.</span>str<span style="color:#0550ae">.</span>replace<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;2room&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;room2&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#0550ae">.</span>str<span style="color:#0550ae">.</span>replace<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;3room&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;room3&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#0550ae">.</span>str<span style="color:#0550ae">.</span>replace<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;4room&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;room4&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#0550ae">.</span>str<span style="color:#0550ae">.</span>replace<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;5room&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;room5&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>df<span style="color:#0550ae">.</span>head<span style="color:#1f2328">()</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="3-insert-into-postgres-2">3. Insert into Postgres</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">sqlalchemy</span> <span style="color:#cf222e">import</span> create_engine<span style="color:#1f2328">,</span> text
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># DB connection</span>
</span></span><span style="display:flex;"><span>engine <span style="color:#0550ae">=</span> create_engine<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;postgresql://postgres:postgres@postgres-postgresql.postgres:5432/postgres&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>insert_sql <span style="color:#0550ae">=</span> text<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">INSERT INTO public.hdb_property_info (
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    blk_no, street, max_floor_lvl, year_completed,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    residential, commercial, market_hawker, miscellaneous,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    multistorey_carpark, precinct_pavilion, bldg_contract_town,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    total_dwelling_units, room1_sold, room2_sold, room3_sold,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    room4_sold, room5_sold, exec_sold, multigen_sold,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    studio_apartment_sold, room1_rental, room2_rental, room3_rental,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    other_room_rental
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">)
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">VALUES (
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    :blk_no, :street, :max_floor_lvl, :year_completed,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    :residential, :commercial, :market_hawker, :miscellaneous,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    :multistorey_carpark, :precinct_pavilion, :bldg_contract_town,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    :total_dwelling_units, :room1_sold, :room2_sold, :room3_sold,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    :room4_sold, :room5_sold, :exec_sold, :multigen_sold,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    :studio_apartment_sold, :room1_rental, :room2_rental, :room3_rental,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    :other_room_rental
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">);
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">&#34;&#34;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">with</span> engine<span style="color:#0550ae">.</span>begin<span style="color:#1f2328">()</span> <span style="color:#cf222e">as</span> conn<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> _<span style="color:#1f2328">,</span> row <span style="color:#0550ae">in</span> df<span style="color:#0550ae">.</span>iterrows<span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>        conn<span style="color:#0550ae">.</span>execute<span style="color:#1f2328">(</span>insert_sql<span style="color:#1f2328">,</span> row<span style="color:#0550ae">.</span>to_dict<span style="color:#1f2328">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;✔ Raw property info inserted.&#34;</span><span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="4-geocode-enrichment">4. Geocode Enrichment</h4>
<h5 id="41-add-canonical-road-name-column">4.1 Add canonical road name column</h5>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#cf222e">ALTER</span><span style="color:#fff"> </span><span style="color:#cf222e">TABLE</span><span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>hdb_property_info<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">ADD</span><span style="color:#fff"> </span><span style="color:#cf222e">COLUMN</span><span style="color:#fff"> </span>canonical_street<span style="color:#fff"> </span><span style="color:#6639ba">TEXT</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">UPDATE</span><span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>hdb_property_info<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">SET</span><span style="color:#fff"> </span>canonical_street<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>canonicalize_road_name<span style="color:#1f2328">(</span>street<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span><span style="color:#cf222e">INDEX</span><span style="color:#fff"> </span><span style="color:#cf222e">IF</span><span style="color:#fff"> </span><span style="color:#cf222e">NOT</span><span style="color:#fff"> </span><span style="color:#cf222e">EXISTS</span><span style="color:#fff"> </span>idx_hdb_canonical_street<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">ON</span><span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>hdb_property_info<span style="color:#1f2328">(</span>canonical_street<span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h5 id="42-join-using-canonical--block-number">4.2 Join using canonical + block number</h5>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#cf222e">UPDATE</span><span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>hdb_property_info<span style="color:#fff"> </span>p<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">SET</span><span style="color:#fff"> 
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>postal<span style="color:#fff">      </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">g</span><span style="color:#1f2328">.</span>postal<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>full_address<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">g</span><span style="color:#1f2328">.</span>address<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>lat<span style="color:#fff">        </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">g</span><span style="color:#1f2328">.</span>lat<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>lon<span style="color:#fff">        </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">g</span><span style="color:#1f2328">.</span>lon<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>x<span style="color:#fff">          </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">g</span><span style="color:#1f2328">.</span>x<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>y<span style="color:#fff">          </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">g</span><span style="color:#1f2328">.</span>y<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>geom_4326<span style="color:#fff">  </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">g</span><span style="color:#1f2328">.</span>geom_4326<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>geom_3414<span style="color:#fff">  </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">g</span><span style="color:#1f2328">.</span>geom_3414<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>updated_at<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>NOW<span style="color:#1f2328">()</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">FROM</span><span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>geocode_cache<span style="color:#fff"> </span><span style="color:#cf222e">g</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">WHERE</span><span style="color:#fff"> 
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>p<span style="color:#1f2328">.</span>blk_no<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">g</span><span style="color:#1f2328">.</span>blk_no<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">AND</span><span style="color:#fff"> </span>p<span style="color:#1f2328">.</span>canonical_street<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">g</span><span style="color:#1f2328">.</span>canonical_street<span style="color:#1f2328">;</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="mrt-to-hdb-town">MRT to HDB Town</h3>
<p>With geospatial indexes in place, we can compute the nearest HDB town for each MRT station.</p>
<p>This mapping allows natural-language queries like <em>“flats near Bishan MRT”</em> to route correctly into <strong>town-level resale transactions</strong>, which is how HDB organizes its datasets.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#57606a">-- Create indexes FIRST
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span><span style="color:#cf222e">INDEX</span><span style="color:#fff"> </span><span style="color:#cf222e">IF</span><span style="color:#fff"> </span><span style="color:#cf222e">NOT</span><span style="color:#fff"> </span><span style="color:#cf222e">EXISTS</span><span style="color:#fff"> </span>idx_mrt_geom_3414<span style="color:#fff"> </span><span style="color:#cf222e">ON</span><span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>mrt_exits<span style="color:#fff"> </span><span style="color:#cf222e">USING</span><span style="color:#fff"> </span>gist<span style="color:#fff"> </span><span style="color:#1f2328">(</span>geom_3414<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span><span style="color:#cf222e">INDEX</span><span style="color:#fff"> </span><span style="color:#cf222e">IF</span><span style="color:#fff"> </span><span style="color:#cf222e">NOT</span><span style="color:#fff"> </span><span style="color:#cf222e">EXISTS</span><span style="color:#fff"> </span>idx_hdb_geom_3414<span style="color:#fff"> </span><span style="color:#cf222e">ON</span><span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>hdb_property_info<span style="color:#fff"> </span><span style="color:#cf222e">USING</span><span style="color:#fff"> </span>gist<span style="color:#fff"> </span><span style="color:#1f2328">(</span>geom_3414<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span><span style="color:#cf222e">INDEX</span><span style="color:#fff"> </span>idx_mrt_station_name<span style="color:#fff"> </span><span style="color:#cf222e">ON</span><span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>mrt_exits<span style="color:#fff"> </span><span style="color:#1f2328">(</span>station_name<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span><span style="color:#cf222e">INDEX</span><span style="color:#fff"> </span>idx_hdb_town<span style="color:#fff"> </span><span style="color:#cf222e">ON</span><span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>hdb_property_info<span style="color:#fff"> </span><span style="color:#1f2328">(</span>bldg_contract_town<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#57606a">-- Update statistics for query planner
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#cf222e">ANALYZE</span><span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>mrt_exits<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">ANALYZE</span><span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>hdb_property_info<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#57606a">-- Test with one station
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#cf222e">EXPLAIN</span><span style="color:#fff"> </span><span style="color:#cf222e">ANALYZE</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">SELECT</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>m<span style="color:#1f2328">.</span>station_name<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>h<span style="color:#1f2328">.</span>bldg_contract_town<span style="color:#fff"> </span><span style="color:#cf222e">AS</span><span style="color:#fff"> </span>town<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">COUNT</span><span style="color:#1f2328">(</span><span style="color:#cf222e">DISTINCT</span><span style="color:#fff"> </span>h<span style="color:#1f2328">.</span>blk_no<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">AS</span><span style="color:#fff"> </span>num_blocks<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>ROUND<span style="color:#1f2328">(</span><span style="color:#cf222e">MIN</span><span style="color:#1f2328">(</span>ST_Distance<span style="color:#1f2328">(</span>m<span style="color:#1f2328">.</span>geom_3414<span style="color:#1f2328">,</span><span style="color:#fff"> </span>h<span style="color:#1f2328">.</span>geom_3414<span style="color:#1f2328">))::</span><span style="color:#6639ba">numeric</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">2</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">AS</span><span style="color:#fff"> </span>min_dist_m<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">FROM</span><span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>mrt_exits<span style="color:#fff"> </span>m<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">INNER</span><span style="color:#fff"> </span><span style="color:#cf222e">JOIN</span><span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>hdb_property_info<span style="color:#fff"> </span>h<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#cf222e">ON</span><span style="color:#fff"> </span>ST_DWithin<span style="color:#1f2328">(</span>m<span style="color:#1f2328">.</span>geom_3414<span style="color:#1f2328">,</span><span style="color:#fff"> </span>h<span style="color:#1f2328">.</span>geom_3414<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">1200</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">WHERE</span><span style="color:#fff"> </span>m<span style="color:#1f2328">.</span>station_name<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;RAFFLES PLACE&#39;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#cf222e">AND</span><span style="color:#fff"> </span>h<span style="color:#1f2328">.</span>bldg_contract_town<span style="color:#fff"> </span><span style="color:#cf222e">IS</span><span style="color:#fff"> </span><span style="color:#cf222e">NOT</span><span style="color:#fff"> </span><span style="color:#cf222e">NULL</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">GROUP</span><span style="color:#fff"> </span><span style="color:#cf222e">BY</span><span style="color:#fff"> </span>m<span style="color:#1f2328">.</span>station_name<span style="color:#1f2328">,</span><span style="color:#fff"> </span>h<span style="color:#1f2328">.</span>bldg_contract_town<span style="color:#1f2328">;</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>

































 
  
  





  <img src="/images/deepagent/deepagent-explain-analyze-query.png"   alt="deepagent-explain-analyze-query" class="sc-image sc-image-default"
       >


<p>Creates the table:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span><span style="color:#cf222e">TABLE</span><span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>mrt_to_hdb_town<span style="color:#fff"> </span><span style="color:#cf222e">AS</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">SELECT</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>m<span style="color:#1f2328">.</span>station_name<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>h<span style="color:#1f2328">.</span>bldg_contract_town<span style="color:#fff"> </span><span style="color:#cf222e">AS</span><span style="color:#fff"> </span>town<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">COUNT</span><span style="color:#1f2328">(</span><span style="color:#cf222e">DISTINCT</span><span style="color:#fff"> </span>h<span style="color:#1f2328">.</span>blk_no<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">AS</span><span style="color:#fff"> </span>num_blocks<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>ROUND<span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">MIN</span><span style="color:#1f2328">(</span>ST_Distance<span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>m<span style="color:#1f2328">.</span>geom_3414<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>h<span style="color:#1f2328">.</span>geom_3414<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">))::</span><span style="color:#6639ba">numeric</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">2</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">AS</span><span style="color:#fff"> </span>min_dist_m<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">FROM</span><span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>mrt_exits<span style="color:#fff"> </span>m<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">INNER</span><span style="color:#fff"> </span><span style="color:#cf222e">JOIN</span><span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>hdb_property_info<span style="color:#fff"> </span>h<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#cf222e">ON</span><span style="color:#fff"> </span>ST_DWithin<span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span>m<span style="color:#1f2328">.</span>geom_3414<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span>h<span style="color:#1f2328">.</span>geom_3414<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">1200</span><span style="color:#fff">  </span><span style="color:#57606a">-- 1.2km in meters
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#fff">  </span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">WHERE</span><span style="color:#fff"> </span>h<span style="color:#1f2328">.</span>bldg_contract_town<span style="color:#fff"> </span><span style="color:#cf222e">IS</span><span style="color:#fff"> </span><span style="color:#cf222e">NOT</span><span style="color:#fff"> </span><span style="color:#cf222e">NULL</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#cf222e">AND</span><span style="color:#fff"> </span>m<span style="color:#1f2328">.</span>station_name<span style="color:#fff"> </span><span style="color:#cf222e">IS</span><span style="color:#fff"> </span><span style="color:#cf222e">NOT</span><span style="color:#fff"> </span><span style="color:#cf222e">NULL</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">GROUP</span><span style="color:#fff"> </span><span style="color:#cf222e">BY</span><span style="color:#fff"> </span>m<span style="color:#1f2328">.</span>station_name<span style="color:#1f2328">,</span><span style="color:#fff"> </span>h<span style="color:#1f2328">.</span>bldg_contract_town<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">ORDER</span><span style="color:#fff"> </span><span style="color:#cf222e">BY</span><span style="color:#fff"> </span>m<span style="color:#1f2328">.</span>station_name<span style="color:#1f2328">,</span><span style="color:#fff"> </span>min_dist_m<span style="color:#1f2328">;</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h2 id="deep-agent">Deep Agent</h2>
<h3 id="high-level-architecture">High-Level Architecture</h3>
<p>The DeepAgent pipeline transforms a user query into a multi-stage reasoning workflow:</p>
<ol>
<li>Intent extraction</li>
<li>Town/MRT inference</li>
<li>Resale transaction retrieval</li>
<li>Geospatial enrichment</li>
<li>LLM summarization</li>
</ol>
<p>Each transformation is handled by a LangGraph node, while DeepAgents provides the routing and orchestration needed to connect the user query with the underlying multi-step pipeline.</p>
<h3 id="code-walkthrough">Code Walkthrough</h3>
<h4 id="1-imports-and-llm">1. Imports and LLM</h4>
<p>We use Amazon Nova via OpenRouter for consistent, deterministic intent parsing and summarization.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">os</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">json</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">asyncio</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">typing</span> <span style="color:#cf222e">import</span> List<span style="color:#1f2328">,</span> Dict<span style="color:#1f2328">,</span> Optional
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">pydantic</span> <span style="color:#cf222e">import</span> BaseModel<span style="color:#1f2328">,</span> ConfigDict
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">deepagents</span> <span style="color:#cf222e">import</span> CompiledSubAgent<span style="color:#1f2328">,</span> create_deep_agent
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">langchain_openai</span> <span style="color:#cf222e">import</span> ChatOpenAI
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">langchain_core.messages</span> <span style="color:#cf222e">import</span> BaseMessage<span style="color:#1f2328">,</span> AIMessage<span style="color:#1f2328">,</span> HumanMessage
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">langgraph.graph</span> <span style="color:#cf222e">import</span> StateGraph<span style="color:#1f2328">,</span> END
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">toolbox_langchain</span> <span style="color:#cf222e">import</span> ToolboxClient
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>llm <span style="color:#0550ae">=</span> ChatOpenAI<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    api_key<span style="color:#0550ae">=</span>os<span style="color:#0550ae">.</span>getenv<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;OPENROUTER_API_KEY&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    base_url<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;https://openrouter.ai/api/v1&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    model<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;amazon/nova-2-lite-v1:free&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    temperature<span style="color:#0550ae">=</span><span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="2-tool-loading">2. Tool Loading</h4>
<p>Tools are lazily loaded via the MCP Toolbox server, ensuring startup efficiency.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>_toolbox_client<span style="color:#1f2328">:</span> Optional<span style="color:#1f2328">[</span>ToolboxClient<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">get_toolbox_client</span><span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">global</span> _toolbox_client
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> _toolbox_client <span style="color:#0550ae">is</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        _toolbox_client <span style="color:#0550ae">=</span> ToolboxClient<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;http://127.0.0.1:5000&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> _toolbox_client
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">load_tools</span><span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>    client <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> get_toolbox_client<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    tools <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> client<span style="color:#0550ae">.</span>aload_toolset<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">{</span>t<span style="color:#0550ae">.</span>name<span style="color:#1f2328">:</span> t <span style="color:#cf222e">for</span> t <span style="color:#0550ae">in</span> tools<span style="color:#1f2328">}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="3-pipeline-state">3. Pipeline State</h4>
<p>The state object tracks messages, intents, flats, enriched metadata, and search constraints.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">class</span> <span style="color:#1f2328">PipelineState</span><span style="color:#1f2328">(</span>BaseModel<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    model_config <span style="color:#0550ae">=</span> ConfigDict<span style="color:#1f2328">(</span>arbitrary_types_allowed<span style="color:#0550ae">=</span><span style="color:#cf222e">True</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    messages<span style="color:#1f2328">:</span> List<span style="color:#1f2328">[</span>BaseMessage<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>    flats<span style="color:#1f2328">:</span> List<span style="color:#1f2328">[</span>Dict<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>    enriched_flats<span style="color:#1f2328">:</span> List<span style="color:#1f2328">[</span>Dict<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Intent</span>
</span></span><span style="display:flex;"><span>    town<span style="color:#1f2328">:</span> Optional<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>    flat_type<span style="color:#1f2328">:</span> Optional<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>    max_price<span style="color:#1f2328">:</span> Optional<span style="color:#1f2328">[</span><span style="color:#6639ba">int</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>    mrt_radius<span style="color:#1f2328">:</span> Optional<span style="color:#1f2328">[</span><span style="color:#6639ba">int</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>    mrt_station<span style="color:#1f2328">:</span> Optional<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="4-intent-extraction-node">4. Intent Extraction Node</h4>
<p>Uses structured prompting and robust JSON parsing to extract actionable parameters.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">intent_node</span><span style="color:#1f2328">(</span>state<span style="color:#1f2328">:</span> PipelineState<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    user_msg <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> m <span style="color:#0550ae">in</span> state<span style="color:#0550ae">.</span>messages<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#6639ba">isinstance</span><span style="color:#1f2328">(</span>m<span style="color:#1f2328">,</span> HumanMessage<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            user_msg <span style="color:#0550ae">=</span> m<span style="color:#0550ae">.</span>content
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> user_msg<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> state
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    prompt <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Extract user intent. Return JSON with these fields (include even if null):
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">{
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">  &#34;town&#34;: &#34;string or null&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">  &#34;mrt_station&#34;: &#34;string or null&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">  &#34;flat_type&#34;: &#34;string or null&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">  &#34;max_price&#34;: &#34;number or null&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">  &#34;mrt_radius&#34;: &#34;number or null&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">}
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">RULES:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">1. MRT mentions: &#34;near &lt;name&gt; MRT&#34;, &#34;&lt;name&gt; station&#34;, &#34;around &lt;name&gt;&#34; → extract &#34;mrt_station&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">   Examples: &#34;Bukit Panjang MRT&#34; → &#34;BUKIT PANJANG&#34;, &#34;Toa Payoh station&#34; → &#34;TOA PAYOH&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">2. Town mentions (explicit): &#34;in &lt;town&gt;&#34;, &#34;&lt;town&gt; area&#34; → extract &#34;town&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">   Examples: &#34;in Bedok&#34;, &#34;Tampines area&#34; → &#34;BEDOK&#34;, &#34;TAMPINES&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">3. Flat types: &#34;4-room&#34;, &#34;4 room&#34;, &#34;4rm&#34; → &#34;4 ROOM&#34;; &#34;5-room&#34; → &#34;5 ROOM&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">4. Prices: &#34;$500k&#34;, &#34;500k&#34;, &#34;500,000&#34;, &#34;under 600k&#34; → numeric
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">5. Radius: &#34;within 500m&#34;, &#34;800m&#34; → numeric (in meters)
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">6. Use UPPERCASE for town/station names.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">7. Return null if not mentioned. Return ALL five fields.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">User query: &#34;</span><span style="color:#0a3069">%s</span><span style="color:#0a3069">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">RETURN JSON ONLY. NO EXPLANATION.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">&#34;&#34;&#34;</span> <span style="color:#0550ae">%</span> user_msg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    resp <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> llm<span style="color:#0550ae">.</span>ainvoke<span style="color:#1f2328">(</span>prompt<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    content <span style="color:#0550ae">=</span> resp<span style="color:#0550ae">.</span>content<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Try to extract JSON from response</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Handle case where LLM wraps response in markdown</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> content<span style="color:#0550ae">.</span>startswith<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;```json&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            content <span style="color:#0550ae">=</span> content<span style="color:#1f2328">[</span><span style="color:#0550ae">7</span><span style="color:#1f2328">:]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> content<span style="color:#0550ae">.</span>startswith<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;```&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            content <span style="color:#0550ae">=</span> content<span style="color:#1f2328">[</span><span style="color:#0550ae">3</span><span style="color:#1f2328">:]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> content<span style="color:#0550ae">.</span>endswith<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;```&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            content <span style="color:#0550ae">=</span> content<span style="color:#1f2328">[:</span><span style="color:#0550ae">-</span><span style="color:#0550ae">3</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>        content <span style="color:#0550ae">=</span> content<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        intent <span style="color:#0550ae">=</span> json<span style="color:#0550ae">.</span>loads<span style="color:#1f2328">(</span>content<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;[INTENT] JSON parse error: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">, raw: </span><span style="color:#0a3069">{</span>content<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        intent <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;[INTENT] Parsed intent →&#34;</span><span style="color:#1f2328">,</span> intent<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> PipelineState<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        messages<span style="color:#0550ae">=</span>state<span style="color:#0550ae">.</span>messages<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        flats<span style="color:#0550ae">=</span>state<span style="color:#0550ae">.</span>flats<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        enriched_flats<span style="color:#0550ae">=</span>state<span style="color:#0550ae">.</span>enriched_flats<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        town<span style="color:#0550ae">=</span>intent<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;town&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        flat_type<span style="color:#0550ae">=</span>intent<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;flat_type&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        max_price<span style="color:#0550ae">=</span>intent<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;max_price&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        mrt_radius<span style="color:#0550ae">=</span>intent<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;mrt_radius&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        mrt_station<span style="color:#0550ae">=</span>intent<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;mrt_station&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="5-town-code-to-full-name-mapping">5. Town Code to Full Name Mapping</h4>
<p>Provides a uniform internal representation regardless of user phrasing or MRT inference.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>TOWN_CODE_MAP <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;AMK&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;ANG MO KIO&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;BB&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;BUKIT BATOK&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;BD&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;BEDOK&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;BH&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;BISHAN&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;BM&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;BUKIT MERAH&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;BP&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;BUKIT PANJANG&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;BT&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;BUKIT TIMAH&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;CCK&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;CHOA CHU KANG&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;CL&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;CLEMENTI&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;CT&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;CENTRAL AREA&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;GL&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;GEYLANG&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;HG&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;HOUGANG&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;JE&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;JURONG EAST&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;JW&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;JURONG WEST&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;KWN&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;KALLANG/WHAMPOA&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;MP&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;MARINE PARADE&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;PG&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;PUNGGOL&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;PRC&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;PASIR RIS&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;QT&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;QUEENSTOWN&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;SB&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;SEMBAWANG&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;SGN&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;SERANGOON&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;SK&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;SENGKANG&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;TAP&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;TAMPINES&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;TG&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;TENGAH&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;TP&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;TOA PAYOH&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;WL&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;WOODLANDS&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;YS&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;YISHUN&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="6-mrt-resolver-node">6. Mrt Resolver Node</h4>
<p>Maps MRT stations → towns using real geospatial distance from MRT exits.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">mrt_resolve_node</span><span style="color:#1f2328">(</span>state<span style="color:#1f2328">:</span> PipelineState<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> state<span style="color:#0550ae">.</span>mrt_station<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;[MRT-RESOLVE] No MRT station detected → skip&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> state
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    tools <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> load_tools<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    tool <span style="color:#0550ae">=</span> tools<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;get-mrt-towns&#34;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;[MRT-RESOLVE] Resolving MRT station: </span><span style="color:#0a3069">{</span>state<span style="color:#0550ae">.</span>mrt_station<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    res <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> tool<span style="color:#0550ae">.</span>ainvoke<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;mrt_station&#34;</span><span style="color:#1f2328">:</span> state<span style="color:#0550ae">.</span>mrt_station<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#6639ba">isinstance</span><span style="color:#1f2328">(</span>res<span style="color:#1f2328">,</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span> 
</span></span><span style="display:flex;"><span>            res <span style="color:#0550ae">=</span> json<span style="color:#0550ae">.</span>loads<span style="color:#1f2328">(</span>res<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span><span style="color:#1f2328">:</span> 
</span></span><span style="display:flex;"><span>            res <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> <span style="color:#1f2328">(</span><span style="color:#6639ba">isinstance</span><span style="color:#1f2328">(</span>res<span style="color:#1f2328">,</span> <span style="color:#6639ba">list</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">and</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>res<span style="color:#1f2328">)</span> <span style="color:#0550ae">&gt;</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;[MRT-RESOLVE] No rows returned → skipping town override&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> state
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Get the nearest/best town mapping</span>
</span></span><span style="display:flex;"><span>    best <span style="color:#0550ae">=</span> res<span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    town_code <span style="color:#0550ae">=</span> best<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;town&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> town_code<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;[MRT-RESOLVE] No town code found in result&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> state
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Map town code to full town name</span>
</span></span><span style="display:flex;"><span>    resolved_town <span style="color:#0550ae">=</span> TOWN_CODE_MAP<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span>town_code<span style="color:#0550ae">.</span>upper<span style="color:#1f2328">())</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> resolved_town<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;[MRT-RESOLVE] MRT → </span><span style="color:#0a3069">{</span>town_code<span style="color:#0a3069">}</span><span style="color:#0a3069"> → </span><span style="color:#0a3069">{</span>resolved_town<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;[MRT-RESOLVE] Warning: No mapping for town code &#39;</span><span style="color:#0a3069">{</span>town_code<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Try to use distance to determine best town from all results</span>
</span></span><span style="display:flex;"><span>        resolved_town <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> row <span style="color:#0550ae">in</span> res<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            tc <span style="color:#0550ae">=</span> row<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;town&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>upper<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> tc <span style="color:#0550ae">in</span> TOWN_CODE_MAP<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                resolved_town <span style="color:#0550ae">=</span> TOWN_CODE_MAP<span style="color:#1f2328">[</span>tc<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;[MRT-RESOLVE] Using alternative: </span><span style="color:#0a3069">{</span>tc<span style="color:#0a3069">}</span><span style="color:#0a3069"> → </span><span style="color:#0a3069">{</span>resolved_town<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> PipelineState<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        messages<span style="color:#0550ae">=</span>state<span style="color:#0550ae">.</span>messages<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        flats<span style="color:#0550ae">=</span>state<span style="color:#0550ae">.</span>flats<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        enriched_flats<span style="color:#0550ae">=</span>state<span style="color:#0550ae">.</span>enriched_flats<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        town<span style="color:#0550ae">=</span>resolved_town <span style="color:#0550ae">or</span> state<span style="color:#0550ae">.</span>town<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        flat_type<span style="color:#0550ae">=</span>state<span style="color:#0550ae">.</span>flat_type<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        max_price<span style="color:#0550ae">=</span>state<span style="color:#0550ae">.</span>max_price<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        mrt_radius<span style="color:#0550ae">=</span>state<span style="color:#0550ae">.</span>mrt_radius<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        mrt_station<span style="color:#0550ae">=</span>state<span style="color:#0550ae">.</span>mrt_station
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="7-resale-node">7. Resale Node</h4>
<p>Fetches raw resale candidate flats using SQL tools.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">resale_node</span><span style="color:#1f2328">(</span>state<span style="color:#1f2328">:</span> PipelineState<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    town <span style="color:#0550ae">=</span> state<span style="color:#0550ae">.</span>town <span style="color:#0550ae">or</span> <span style="color:#0a3069">&#34;TOA PAYOH&#34;</span>
</span></span><span style="display:flex;"><span>    flat_type <span style="color:#0550ae">=</span> state<span style="color:#0550ae">.</span>flat_type <span style="color:#0550ae">or</span> <span style="color:#0a3069">&#34;4 ROOM&#34;</span>
</span></span><span style="display:flex;"><span>    max_price <span style="color:#0550ae">=</span> state<span style="color:#0550ae">.</span>max_price <span style="color:#0550ae">or</span> <span style="color:#0550ae">600000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    tools <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> load_tools<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    sql <span style="color:#0550ae">=</span> tools<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;list-hdb-flats&#34;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;[RESALE] Fetching </span><span style="color:#0a3069">{</span>flat_type<span style="color:#0a3069">}</span><span style="color:#0a3069"> in </span><span style="color:#0a3069">{</span>town<span style="color:#0a3069">}</span><span style="color:#0a3069"> &lt;= </span><span style="color:#0a3069">{</span>max_price<span style="color:#0a3069">}</span><span style="color:#0a3069">...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    flats <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> sql<span style="color:#0550ae">.</span>ainvoke<span style="color:#1f2328">({</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;town&#34;</span><span style="color:#1f2328">:</span> town<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;max_price&#34;</span><span style="color:#1f2328">:</span> max_price<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;flat_type&#34;</span><span style="color:#1f2328">:</span> flat_type
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#6639ba">isinstance</span><span style="color:#1f2328">(</span>flats<span style="color:#1f2328">,</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span> flats <span style="color:#0550ae">=</span> json<span style="color:#0550ae">.</span>loads<span style="color:#1f2328">(</span>flats<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span><span style="color:#1f2328">:</span> flats <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> <span style="color:#6639ba">isinstance</span><span style="color:#1f2328">(</span>flats<span style="color:#1f2328">,</span> <span style="color:#6639ba">list</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        flats <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;[RESALE] Retrieved </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>flats<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> flats&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> PipelineState<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        messages<span style="color:#0550ae">=</span>state<span style="color:#0550ae">.</span>messages<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        flats<span style="color:#0550ae">=</span>flats<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        enriched_flats<span style="color:#0550ae">=</span><span style="color:#1f2328">[],</span>
</span></span><span style="display:flex;"><span>        town<span style="color:#0550ae">=</span>town<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        flat_type<span style="color:#0550ae">=</span>flat_type<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        max_price<span style="color:#0550ae">=</span>max_price<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        mrt_radius<span style="color:#0550ae">=</span>state<span style="color:#0550ae">.</span>mrt_radius<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        mrt_station<span style="color:#0550ae">=</span>state<span style="color:#0550ae">.</span>mrt_station
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="8-mrt-enrichment-node">8. MRT Enrichment Node</h4>
<p>Enhances each flat with nearest MRT station + distance (unit-normalized).</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">mrt_node</span><span style="color:#1f2328">(</span>state<span style="color:#1f2328">:</span> PipelineState<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    flats <span style="color:#0550ae">=</span> state<span style="color:#0550ae">.</span>flats <span style="color:#0550ae">or</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>    radius <span style="color:#0550ae">=</span> state<span style="color:#0550ae">.</span>mrt_radius <span style="color:#0550ae">or</span> <span style="color:#0550ae">800</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;[MRT] Enriching </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>flats<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> flats (radius=</span><span style="color:#0a3069">{</span>radius<span style="color:#0a3069">}</span><span style="color:#0a3069">)&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    tools <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> load_tools<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    geo <span style="color:#0550ae">=</span> tools<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;geospatial-query&#34;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Deduplicate coords</span>
</span></span><span style="display:flex;"><span>    uniq <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> f <span style="color:#0550ae">in</span> flats<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        lat <span style="color:#0550ae">=</span> f<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;lat&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        lon <span style="color:#0550ae">=</span> f<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;lon&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> lat <span style="color:#0550ae">and</span> lon<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            uniq<span style="color:#0550ae">.</span>setdefault<span style="color:#1f2328">((</span>lat<span style="color:#1f2328">,</span> lon<span style="color:#1f2328">),</span> <span style="color:#1f2328">[])</span><span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>f<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    coord_results <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">(</span>lat<span style="color:#1f2328">,</span> lon<span style="color:#1f2328">),</span> group <span style="color:#0550ae">in</span> uniq<span style="color:#0550ae">.</span>items<span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>        res <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> geo<span style="color:#0550ae">.</span>ainvoke<span style="color:#1f2328">({</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;mode&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;nearest_mrt&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;lat&#34;</span><span style="color:#1f2328">:</span> lat<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;lon&#34;</span><span style="color:#1f2328">:</span> lon<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;radius&#34;</span><span style="color:#1f2328">:</span> radius
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#6639ba">isinstance</span><span style="color:#1f2328">(</span>res<span style="color:#1f2328">,</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span> 
</span></span><span style="display:flex;"><span>                res <span style="color:#0550ae">=</span> json<span style="color:#0550ae">.</span>loads<span style="color:#1f2328">(</span>res<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">except</span><span style="color:#1f2328">:</span> 
</span></span><span style="display:flex;"><span>                res <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#6639ba">isinstance</span><span style="color:#1f2328">(</span>res<span style="color:#1f2328">,</span> <span style="color:#6639ba">list</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">and</span> res<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            best <span style="color:#0550ae">=</span> res<span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>            raw_dist <span style="color:#0550ae">=</span> best<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;dist_m&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># Determine unit and format</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> raw_dist <span style="color:#0550ae">is</span> <span style="color:#0550ae">not</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># Check if it&#39;s likely degrees (small values &lt; 0.1)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> raw_dist <span style="color:#0550ae">&lt;</span> <span style="color:#0550ae">0.1</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># Assume degrees, convert to meters</span>
</span></span><span style="display:flex;"><span>                    meters <span style="color:#0550ae">=</span> raw_dist <span style="color:#0550ae">*</span> <span style="color:#0550ae">111000</span>  <span style="color:#57606a"># 1 degree ≈ 111km</span>
</span></span><span style="display:flex;"><span>                    formatted <span style="color:#0550ae">=</span> format_meters<span style="color:#1f2328">(</span>meters<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                    unit <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;degrees&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">elif</span> raw_dist <span style="color:#0550ae">&lt;</span> <span style="color:#0550ae">1000</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># Assume kilometers (0.1 to 1000)</span>
</span></span><span style="display:flex;"><span>                    meters <span style="color:#0550ae">=</span> raw_dist <span style="color:#0550ae">*</span> <span style="color:#0550ae">1000</span>
</span></span><span style="display:flex;"><span>                    formatted <span style="color:#0550ae">=</span> format_meters<span style="color:#1f2328">(</span>meters<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                    unit <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;km&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># Assume meters</span>
</span></span><span style="display:flex;"><span>                    formatted <span style="color:#0550ae">=</span> format_meters<span style="color:#1f2328">(</span>raw_dist<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                    unit <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;m&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                formatted <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;N/A&#34;</span>
</span></span><span style="display:flex;"><span>                unit <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            coord_results<span style="color:#1f2328">[(</span>lat<span style="color:#1f2328">,</span> lon<span style="color:#1f2328">)]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;nearest_mrt&#34;</span><span style="color:#1f2328">:</span> best<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;label&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;dist_raw&#34;</span><span style="color:#1f2328">:</span> raw_dist<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;dist_formatted&#34;</span><span style="color:#1f2328">:</span> formatted<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;dist_unit&#34;</span><span style="color:#1f2328">:</span> unit
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            coord_results<span style="color:#1f2328">[(</span>lat<span style="color:#1f2328">,</span> lon<span style="color:#1f2328">)]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;nearest_mrt&#34;</span><span style="color:#1f2328">:</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;dist_raw&#34;</span><span style="color:#1f2328">:</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;dist_formatted&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;N/A&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;dist_unit&#34;</span><span style="color:#1f2328">:</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    enriched <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> f <span style="color:#0550ae">in</span> flats<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        lat <span style="color:#0550ae">=</span> f<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;lat&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        lon <span style="color:#0550ae">=</span> f<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;lon&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        extra <span style="color:#0550ae">=</span> coord_results<span style="color:#0550ae">.</span>get<span style="color:#1f2328">((</span>lat<span style="color:#1f2328">,</span> lon<span style="color:#1f2328">),</span> <span style="color:#1f2328">{})</span>
</span></span><span style="display:flex;"><span>        f<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;nearest_mrt&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> extra<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;nearest_mrt&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        f<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;dist_raw&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> extra<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;dist_raw&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        f<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;dist_formatted&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> extra<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;dist_formatted&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        f<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;dist_unit&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> extra<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;dist_unit&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        enriched<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>f<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> enriched<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        example <span style="color:#0550ae">=</span> enriched<span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;[MRT] Enrichment complete — example: </span><span style="color:#0a3069">{</span>example<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;street_name&#39;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> → </span><span style="color:#0a3069">{</span>example<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;nearest_mrt&#39;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> (</span><span style="color:#0a3069">{</span>example<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;dist_formatted&#39;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">)&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;[MRT] Enrichment complete — no flats&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> PipelineState<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        messages<span style="color:#0550ae">=</span>state<span style="color:#0550ae">.</span>messages<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        flats<span style="color:#0550ae">=</span>state<span style="color:#0550ae">.</span>flats<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        enriched_flats<span style="color:#0550ae">=</span>enriched<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        town<span style="color:#0550ae">=</span>state<span style="color:#0550ae">.</span>town<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        flat_type<span style="color:#0550ae">=</span>state<span style="color:#0550ae">.</span>flat_type<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        max_price<span style="color:#0550ae">=</span>state<span style="color:#0550ae">.</span>max_price<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        mrt_radius<span style="color:#0550ae">=</span>radius<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        mrt_station<span style="color:#0550ae">=</span>state<span style="color:#0550ae">.</span>mrt_station
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">format_meters</span><span style="color:#1f2328">(</span>meters<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;Format distance in meters to human-readable string.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> meters <span style="color:#0550ae">is</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#0a3069">&#34;N/A&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> meters <span style="color:#0550ae">&lt;</span> <span style="color:#0550ae">1000</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">{</span><span style="color:#6639ba">int</span><span style="color:#1f2328">(</span><span style="color:#6639ba">round</span><span style="color:#1f2328">(</span>meters<span style="color:#1f2328">))</span><span style="color:#0a3069">}</span><span style="color:#0a3069">m&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        km <span style="color:#0550ae">=</span> meters <span style="color:#0550ae">/</span> <span style="color:#0550ae">1000</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> km <span style="color:#0550ae">&lt;</span> <span style="color:#0550ae">10</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># Show 1 decimal for &lt; 10km</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">{</span>km<span style="color:#0a3069">:</span><span style="color:#0a3069">.1f</span><span style="color:#0a3069">}</span><span style="color:#0a3069">km&#34;</span><span style="color:#0550ae">.</span>rstrip<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;0&#39;</span><span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>rstrip<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;.&#39;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">+</span> <span style="color:#0a3069">&#34;km&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># Round to nearest km for &gt;= 10km</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">{</span><span style="color:#6639ba">int</span><span style="color:#1f2328">(</span><span style="color:#6639ba">round</span><span style="color:#1f2328">(</span>km<span style="color:#1f2328">))</span><span style="color:#0a3069">}</span><span style="color:#0a3069">km&#34;</span>    </span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="9-summary-node">9. Summary Node</h4>
<p>Produces a concise, human-friendly explanation with price ranges and best-value highlights.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">summary_node</span><span style="color:#1f2328">(</span>state<span style="color:#1f2328">:</span> PipelineState<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    flats <span style="color:#0550ae">=</span> state<span style="color:#0550ae">.</span>enriched_flats <span style="color:#0550ae">or</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;[SUMMARY] Summarizing&#34;</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>flats<span style="color:#1f2328">),</span> <span style="color:#0a3069">&#34;flats&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> flats<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        summary <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;No flats found matching your criteria.&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Create a preview with formatted distances</span>
</span></span><span style="display:flex;"><span>        preview <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> flat <span style="color:#0550ae">in</span> flats<span style="color:#1f2328">[:</span><span style="color:#0550ae">5</span><span style="color:#1f2328">]:</span>  <span style="color:#57606a"># Show first 5 as preview</span>
</span></span><span style="display:flex;"><span>            preview<span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;block&#34;</span><span style="color:#1f2328">:</span> flat<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;block&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;street&#34;</span><span style="color:#1f2328">:</span> flat<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;street_name&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;price&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;$</span><span style="color:#0a3069">{</span>flat<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;resale_price&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">)</span><span style="color:#0a3069">:</span><span style="color:#0a3069">,</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;nearest_mrt&#34;</span><span style="color:#1f2328">:</span> flat<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;nearest_mrt&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;Unknown&#34;</span><span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>replace<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34; MRT STATION&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;distance&#34;</span><span style="color:#1f2328">:</span> flat<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;dist_formatted&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;N/A&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        prompt <span style="color:#0550ae">=</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Summarize the following HDB flats near </span><span style="color:#0a3069">{</span>state<span style="color:#0550ae">.</span>mrt_station <span style="color:#0550ae">or</span> state<span style="color:#0550ae">.</span>town <span style="color:#0550ae">or</span> <span style="color:#0a3069">&#39;the area&#39;</span><span style="color:#0a3069">}</span><span style="color:#0a3069">:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Flats data (first </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>preview<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> of </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>flats<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">):
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069"></span><span style="color:#0a3069">{</span>json<span style="color:#0550ae">.</span>dumps<span style="color:#1f2328">(</span>preview<span style="color:#1f2328">,</span> indent<span style="color:#0550ae">=</span><span style="color:#0550ae">2</span><span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Total flats found: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>flats<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Please provide a concise summary that includes:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">1. Price range
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">2. Closest flats to MRT stations (use the actual distances like &#34;350m&#34;, &#34;1.2km&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">3. Best value picks
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">4. Any notable patterns
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Format distances in a human-readable way (e.g., &#34;350m&#34; not &#34;0.35km&#34;).
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        resp <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> llm<span style="color:#0550ae">.</span>ainvoke<span style="color:#1f2328">(</span>prompt<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        summary <span style="color:#0550ae">=</span> resp<span style="color:#0550ae">.</span>content
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> PipelineState<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        messages<span style="color:#0550ae">=</span>state<span style="color:#0550ae">.</span>messages <span style="color:#0550ae">+</span> <span style="color:#1f2328">[</span>AIMessage<span style="color:#1f2328">(</span>content<span style="color:#0550ae">=</span>summary<span style="color:#1f2328">)],</span>
</span></span><span style="display:flex;"><span>        flats<span style="color:#0550ae">=</span>state<span style="color:#0550ae">.</span>flats<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        enriched_flats<span style="color:#0550ae">=</span>state<span style="color:#0550ae">.</span>enriched_flats<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        town<span style="color:#0550ae">=</span>state<span style="color:#0550ae">.</span>town<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        flat_type<span style="color:#0550ae">=</span>state<span style="color:#0550ae">.</span>flat_type<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        max_price<span style="color:#0550ae">=</span>state<span style="color:#0550ae">.</span>max_price<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        mrt_radius<span style="color:#0550ae">=</span>state<span style="color:#0550ae">.</span>mrt_radius<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        mrt_station<span style="color:#0550ae">=</span>state<span style="color:#0550ae">.</span>mrt_station
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="10-pipeline-graph">10. Pipeline Graph</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>graph <span style="color:#0550ae">=</span> StateGraph<span style="color:#1f2328">(</span>PipelineState<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>graph<span style="color:#0550ae">.</span>add_node<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;intent&#34;</span><span style="color:#1f2328">,</span> intent_node<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>graph<span style="color:#0550ae">.</span>add_node<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;mrt_resolve&#34;</span><span style="color:#1f2328">,</span> mrt_resolve_node<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>graph<span style="color:#0550ae">.</span>add_node<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;resale&#34;</span><span style="color:#1f2328">,</span> resale_node<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>graph<span style="color:#0550ae">.</span>add_node<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;mrt&#34;</span><span style="color:#1f2328">,</span> mrt_node<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>graph<span style="color:#0550ae">.</span>add_node<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;summary&#34;</span><span style="color:#1f2328">,</span> summary_node<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>graph<span style="color:#0550ae">.</span>set_entry_point<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;intent&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>graph<span style="color:#0550ae">.</span>add_edge<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;intent&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;mrt_resolve&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>graph<span style="color:#0550ae">.</span>add_edge<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;mrt_resolve&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;resale&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>graph<span style="color:#0550ae">.</span>add_edge<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;resale&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;mrt&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>graph<span style="color:#0550ae">.</span>add_edge<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;mrt&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;summary&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>graph<span style="color:#0550ae">.</span>add_edge<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;summary&#34;</span><span style="color:#1f2328">,</span> END<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>compiled_orchestrator <span style="color:#0550ae">=</span> graph<span style="color:#0550ae">.</span>compile<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>orchestrator_subagent <span style="color:#0550ae">=</span> CompiledSubAgent<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    name<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;orchestrator&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    description<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;Orchestrates intent → MRT resolve → resale → MRT-enrichment → summary.&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    runnable<span style="color:#0550ae">=</span>compiled_orchestrator
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="11-deep-agent">11. Deep Agent</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>system_prompt <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">You are an HDB property finder. Always forward user queries to the orchestrator.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>deep_agent <span style="color:#0550ae">=</span> create_deep_agent<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    model<span style="color:#0550ae">=</span>llm<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    system_prompt<span style="color:#0550ae">=</span>system_prompt<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    subagents<span style="color:#0550ae">=</span><span style="color:#1f2328">[</span>orchestrator_subagent<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="12-cli-entry-point">12. CLI Entry Point</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">extract_final_message</span><span style="color:#1f2328">(</span>result<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    msgs <span style="color:#0550ae">=</span> result<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#6639ba">isinstance</span><span style="color:#1f2328">(</span>msgs<span style="color:#1f2328">,</span> <span style="color:#6639ba">list</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> m <span style="color:#0550ae">in</span> <span style="color:#6639ba">reversed</span><span style="color:#1f2328">(</span>msgs<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#6639ba">isinstance</span><span style="color:#1f2328">(</span>m<span style="color:#1f2328">,</span> AIMessage<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> m<span style="color:#0550ae">.</span>content
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">run_cli</span><span style="color:#1f2328">(</span>query<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    result <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> deep_agent<span style="color:#0550ae">.</span>ainvoke<span style="color:#1f2328">({</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">[</span>HumanMessage<span style="color:#1f2328">(</span>content<span style="color:#0550ae">=</span>query<span style="color:#1f2328">)]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    final <span style="color:#0550ae">=</span> extract_final_message<span style="color:#1f2328">(</span>result<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> final <span style="color:#0550ae">or</span> <span style="color:#0a3069">&#34;No output extracted.&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">if</span> <span style="color:#953800">__name__</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;__main__&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">sys</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>sys<span style="color:#0550ae">.</span>argv<span style="color:#1f2328">)</span> <span style="color:#0550ae">&lt;</span> <span style="color:#0550ae">2</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Usage: uv run agent.py </span><span style="color:#0a3069">\&#34;</span><span style="color:#0a3069">your query</span><span style="color:#0a3069">\&#34;</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        sys<span style="color:#0550ae">.</span>exit<span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    query <span style="color:#0550ae">=</span> sys<span style="color:#0550ae">.</span>argv<span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">main</span><span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>        out <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> run_cli<span style="color:#1f2328">(</span>query<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">=== FINAL RESPONSE ===</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span>out<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    asyncio<span style="color:#0550ae">.</span>run<span style="color:#1f2328">(</span>main<span style="color:#1f2328">())</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="deep-agent-in-action">Deep Agent In Action</h3>
<p>Example query:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>uv run agent<span style="color:#1f2328">.</span>py <span style="color:#0a3069">&#34;Show me 5-room flats near MRT in Bishan under 900k&#34;</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>

































 
  
  





  <img src="/images/deepagent/deepagent-show-me-5-room-flats-near-MRT-in-Bishan-under-900k.png"   alt="deepagent-show-me-5-room-flats-near-MRT-in-Bishan-under-900k" class="sc-image sc-image-default"
       >


<blockquote>
<p><strong>Note:</strong> When running the agent locally (via <code>uv run agent.py</code>), ensure that both <strong>PostgreSQL</strong> and the <strong>MCP Toolbox server</strong> are already running.</p>
<p>If these services are not started, the agent will not be able to resolve MRT mappings or fetch resale data.</p>
<p>Alternatively, you may skip local setup and use the <strong>Docker Compose</strong> environment described in the next section, which launches the backend, toolbox, and Postgres automatically.</p></blockquote>
<h2 id="optional--running-in-docker-containers">Optional — Running in Docker Containers</h2>
<p>If you prefer to run the HDB DeepAgents pipeline in a fully containerized environment, you can use the provided <code>Dockerfile</code> and <code>docker-compose.yml</code> configuration. This setup allows you to launch:</p>
<ul>
<li>The <strong>Python DeepAgent service</strong></li>
<li>The <strong>MCP Toolbox server</strong></li>
<li>A <strong>PostgreSQL + PostGIS database</strong></li>
</ul>
<p>…all within isolated containers for reproducible development.</p>
<h3 id="1-build-the-image">1. Build the Image</h3>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker build -t hdb-deepagents .</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="2-start-the-full-stack">2. Start the Full Stack</h3>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker compose up</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><p>This starts:</p>
<ul>
<li><strong>deepagents</strong> — the LangGraph/DeepAgents orchestrator</li>
<li><strong>toolbox</strong> — MCP Tool server exposing SQL/geospatial tools</li>
<li><strong>postgres</strong> — PostgreSQL 15 + PostGIS extension</li>
</ul>


































 
  
  





  <img src="/images/deepagent/deepagent-docker-compose-up-1.png"   alt="deepagent-docker-compose-up-1" class="sc-image sc-image-default"
       >




































 
  
  





  <img src="/images/deepagent/deepagent-docker-compose-up-2.png"   alt="deepagent-docker-compose-up-2" class="sc-image sc-image-default"
       >


<h3 id="3-run-the-graio-app">3. Run the Graio App</h3>
<p>Navigate to <code>http://localhost:7860/</code> and test the sample queries!</p>


































 
  
  





  <img src="/images/deepagent/deepagent-gradio-app-1.png"   alt="deepagent-gradio-app-1" class="sc-image sc-image-default"
       >




































 
  
  





  <img src="/images/deepagent/deepagent-gradio-app-2.png"   alt="deepagent-gradio-app-2" class="sc-image sc-image-default"
       >


<h2 id="conclusion">Conclusion</h2>
<p>This project brings together geospatial data, natural-language understanding, and a structured DeepAgents workflow to create a practical, autonomous HDB insights assistant. By combining LangGraph’s deterministic execution model with PostGIS, the MCP Toolbox, and a modern LLM, the system is able to interpret user intent, resolve MRT proximity, retrieve relevant flats, enrich them with spatial context, and present concise summaries—all from a single user query.</p>
<p>Whether you run the agent locally or through Docker Compose, the architecture is modular, transparent, and designed for experimentation. It serves as a foundation for building more capable real-estate intelligence tools, and demonstrates how modern agent frameworks can be integrated into real-world, domain-specific applications.</p>
<p>If you’d like to explore the source code, test the pipeline, or contribute improvements, the project is openly available here:</p>
<p>👉 GitHub Repository: 






  <a href="https://github.com/seehiong/autonomous-hdb-deepagents" target="_blank" rel="noopener noreferrer" >https://github.com/seehiong/autonomous-hdb-deepagents</a>
</p>
<h2 id="whats-next">What’s Next?</h2>
<p>Potential future enhancements include:</p>
<ul>
<li>Integrating schools, parks, and amenities</li>
<li>Adding more agent autonomy and memory</li>
<li>Improving MRT/amenity scoring and visualization</li>
</ul>
<p>Contributions and suggestions are welcome.</p>

    </section>

    <nav class="post-navigation">
      <div class="nav-links">
        
          <div class="nav-previous">
            <a href="/posts/2025/11/building-a-langgraph-multi-agent-system/" rel="prev">
              <span class="meta-nav">← Previous</span>
              <span class="post-title">Building a LangGraph Multi-Agent System</span>
            </a>
          </div>
        
        
          <div class="nav-next">
            <a href="/posts/2025/12/voice-native-document-intelligence/" rel="next">
              <span class="meta-nav">Next →</span>
              <span class="post-title">Voice-Native Document Intelligence</span>
            </a>
          </div>
        
      </div>
    </nav>

    
<div class="giscus-comments-container">
</div>

<script>
  (function() {
    'use strict';

    const getGiscusTheme = () => {
      const storedTheme = localStorage.getItem('theme'); 
      if (storedTheme) {
        return storedTheme === 'dark-mode' ? 'dark' : 'light';
      }
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };

    const setGiscusFrameTheme = (theme) => {
      const iframe = document.querySelector('iframe.giscus-frame');
      if (iframe && iframe.contentWindow) {
        iframe.contentWindow.postMessage({ giscus: { setConfig: { theme: theme } } }, 'https://giscus.app');
      }
    };

    const loadGiscus = () => {
      const giscusContainer = document.querySelector('.giscus-comments-container');
      if (!giscusContainer) {
        console.warn('Giscus container not found.');
        return;
      }

      while (giscusContainer.firstChild) {
        giscusContainer.removeChild(giscusContainer.firstChild);
      }

      const giscusScript = document.createElement('script');
      const giscusAttributes = {
        "src": "https://giscus.app/client.js",
        "data-repo":             "seehiong\/seehiong.github.io",
        "data-repo-id":          "R_kgDOJg7Puw",
        "data-category":         "General",
        "data-category-id":      "DIC_kwDOJg7Pu84Cbyhc",
        "data-mapping":          "url", 
        "data-strict":           "0",
        "data-reactions-enabled":"1",
        "data-emit-metadata":    "0",
        "data-input-position":   "top", 
        "data-theme":            getGiscusTheme(), 
        "data-lang":             "en",
        "data-loading":          "lazy",
        "crossorigin":           "anonymous",
        "async":                 "true", 
      };

      if (!giscusAttributes["data-repo"] || !giscusAttributes["data-repo-id"] || !giscusAttributes["data-category-id"]) {
          console.error("Giscus parameters (giscusRepo, giscusRepoId, giscusCategoryId) are not configured in hugo.toml.");
          giscusContainer.innerHTML = "<p style='color: var(--text-secondary);'>Giscus comments are not configured correctly. Please check site parameters.</p>";
          return;
      }

      Object.entries(giscusAttributes).forEach(
        ([key, value]) => giscusScript.setAttribute(key, value)
      );
      giscusContainer.appendChild(giscusScript);
    };

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadGiscus);
    } else {
        loadGiscus();
    }

    const htmlElement = document.documentElement;
    const observer = new MutationObserver((mutationsList) => {
      for (const mutation of mutationsList) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          setGiscusFrameTheme(getGiscusTheme());
        }
      }
    });
    observer.observe(htmlElement, { attributes: true });

  })();
</script>


  </article>
</div>
</main>
    </div>

    
    <div id="search-modal-overlay" class="search-modal-overlay" style="display: none;">
      <div id="search-modal-content" class="search-modal-content">
        <button id="search-modal-close" class="search-modal-close" aria-label="Close search" title="Close search">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </button>
        <input type="search" id="modal-search-input" class="modal-search-input" placeholder="Search content..." aria-label="Search input">
        <div id="modal-search-results" class="modal-search-results">
        </div>
      </div>
    </div>
    

  <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js" defer></script>
  <script>
    (function() {
      'use strict';

      window.addEventListener('DOMContentLoaded', () => {
        const searchModalOverlay = document.getElementById('search-modal-overlay');
        const searchModalContent = document.getElementById('search-modal-content');
        const searchModalCloseButton = document.getElementById('search-modal-close');
        const searchToggleButton = document.getElementById('nav-search-toggle');
        const searchInputTarget = document.getElementById('modal-search-input');
        const searchResultsTarget = document.getElementById('modal-search-results');

        let fuseInstance = null;
        let searchData = [];

        const loadSearchData = async () => {
          if (searchData.length === 0 && !fuseInstance) {
            try {
              const response = await fetch('\/index.json');
              if (!response.ok) {
                throw new Error(`HTTP error loading index.json! status: ${response.status}`);
              }
              searchData = await response.json();
              initializeFuse();
            } catch (e) {
              console.error("[SearchSetup] Error loading search data:", e);
              if (searchResultsTarget) searchResultsTarget.innerHTML = "<p>Error loading search index.</p>";
            }
          } else if (searchData.length > 0 && !fuseInstance){
            initializeFuse();
          }
        };

        const initializeFuse = () => {
          if (searchData.length > 0 && !fuseInstance) {
            const options = {
              keys: [
                { name: 'title', weight: 0.7 }, { name: 'summary', weight: 0.5 },
                { name: 'content', weight: 0.3 }, { name: 'tags', weight: 0.4 }
              ],
              includeScore: true, threshold: 0.4, minMatchCharLength: 2,
            };
            fuseInstance = new Fuse(searchData, options);
          }
        };

        const performSearch = () => {
          if (!fuseInstance || !searchInputTarget || !searchResultsTarget) return;
          const query = searchInputTarget.value.trim();
          searchResultsTarget.innerHTML = '';
          if (query.length < 2) return;

          const results = fuseInstance.search(query);
          if (results.length > 0) {
            const ul = document.createElement('ul');
            ul.className = 'search-results-list';
            results.slice(0, 10).forEach(result => {
              const item = result.item;
              const li = document.createElement('li');
              li.className = 'search-result-item';
              const a = document.createElement('a');
              a.href = item.permalink;
              a.textContent = item.title;
              li.appendChild(a);
              ul.appendChild(li);
            });
            searchResultsTarget.appendChild(ul);
          } else {
            searchResultsTarget.innerHTML = '<p>No results found.</p>';
          }
        };

        const openSearchModal = async () => {
          await loadSearchData();
          if (searchInputTarget) searchInputTarget.value = '';
          if (searchResultsTarget) searchResultsTarget.innerHTML = '';

          if (searchModalOverlay) {
            searchModalOverlay.style.display = 'flex';
            setTimeout(() => searchModalOverlay.classList.add('active'), 10);
          } else { return; }

          if (searchInputTarget) setTimeout(() => searchInputTarget.focus(), 50);
          if (searchToggleButton) searchToggleButton.classList.add('active');
        };

        const closeSearchModal = () => {
          if (searchModalOverlay) {
            searchModalOverlay.classList.remove('active');
            setTimeout(() => searchModalOverlay.style.display = 'none', 300);
          }
          if (searchToggleButton) searchToggleButton.classList.remove('active');
        };

        if (searchToggleButton) {
          searchToggleButton.addEventListener('click', (e) => {
            e.stopPropagation();
            if (searchModalOverlay && searchModalOverlay.classList.contains('active')) {
              closeSearchModal();
            } else {
              openSearchModal();
            }
          });
        } else { console.error("[SearchSetup] #nav-search-toggle button not found."); }

        if (searchModalCloseButton) { searchModalCloseButton.addEventListener('click', closeSearchModal); }
        if (searchModalOverlay && searchModalContent) {
          searchModalOverlay.addEventListener('click', (event) => {
            if (event.target === searchModalOverlay) closeSearchModal();
          });
        }
        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && searchModalOverlay && searchModalOverlay.classList.contains('active')) {
            closeSearchModal();
          }
        });
        if (searchInputTarget) {
          let debounceTimer;
          searchInputTarget.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(performSearch, 300);
          });
        }
      });
    })();
  </script>

    

    

  <script>
    MathJax = {
      tex: {
        displayMath: [['\\[', '\\]'], ['$$', '$$']], 
        inlineMath: [['\\(', '\\)']], 
        processEscapes: true,
        processEnvironments: true,
        tags: 'ams' 
      },
      svg: {
        fontCache: 'global' 
      },
      chtml: {
        fontURL: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2'
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'], 
        ignoreHtmlClass: 'tex2jax_ignore', 
        processHtmlClass: 'tex2jax_process'
      }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<footer class="footer-main simplified-footer">
  <div class="content-body footer-wraper">
    <div class="footer-box">
      <div class="footer-content">
        <div class="copyright-line">
          Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> © 2026 See Hiong. All rights reserved.
        </div>
        <div class="social-links">
          
            <a href="https://github.com/seehiong" target="_blank" title="GitHub" class="social-link" aria-label="GitHub">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
            </a>
          
          
            <a href="https://www.linkedin.com/in/seehiong/" target="_blank" title="LinkedIn" class="social-link" aria-label="LinkedIn">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
            </a>
          
          
            <a href="/index.xml" target="_blank" title="RSS" class="social-link" aria-label="RSS Feed">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg>
            </a>
          
        </div>
      </div>
    </div>
  </div>
</footer>
        <script src="/js/animation.js" defer></script>
    
        <script src="/js/code-copy.js" defer></script>
    
        <script src="/js/scroll-header.js" defer></script>
       
  </body>
</html>