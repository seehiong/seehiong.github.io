<!DOCTYPE html>
<html lang="en">
  <head><head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <link rel="icon" href="/img/favicon.ico">
    

    <meta property="og:url" content="https://seehiong.github.io/posts/2025/05/building-a-recommender-system/">
  <meta property="og:site_name" content="See Hiong&#39;s Blog">
  <meta property="og:title" content="Building a Recommender System">
  <meta property="og:description" content="In this post, we walk through the process of building a movie recommender system using deep learning embeddings and PostgreSQL with pgvector. You’ll learn how to extract and normalize item features, generate vector embeddings with TensorFlow, store them in a Postgres database, and perform similarity searches to recommend relevant content. The system leverages cosine distance for finding similar items and user preferences, enabling efficient, scalable recommendations.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-05-02T10:00:00+08:00">
    <meta property="article:modified_time" content="2025-05-02T10:00:00+08:00">
    <meta property="article:tag" content="Recommenders">
    <meta property="article:tag" content="MovieLens">
    <meta property="article:tag" content="Applied Machine Learning">
    <meta property="article:tag" content="Artificial Neural Networks">
    <meta property="article:tag" content="PostgreSQL">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Building a Recommender System">
  <meta name="twitter:description" content="In this post, we walk through the process of building a movie recommender system using deep learning embeddings and PostgreSQL with pgvector. You’ll learn how to extract and normalize item features, generate vector embeddings with TensorFlow, store them in a Postgres database, and perform similarity searches to recommend relevant content. The system leverages cosine distance for finding similar items and user preferences, enabling efficient, scalable recommendations.">

  <meta itemprop="name" content="Building a Recommender System">
  <meta itemprop="description" content="In this post, we walk through the process of building a movie recommender system using deep learning embeddings and PostgreSQL with pgvector. You’ll learn how to extract and normalize item features, generate vector embeddings with TensorFlow, store them in a Postgres database, and perform similarity searches to recommend relevant content. The system leverages cosine distance for finding similar items and user preferences, enabling efficient, scalable recommendations.">
  <meta itemprop="datePublished" content="2025-05-02T10:00:00+08:00">
  <meta itemprop="dateModified" content="2025-05-02T10:00:00+08:00">
  <meta itemprop="wordCount" content="2859">
  <meta itemprop="keywords" content="Recommenders,MovieLens,Applied Machine Learning,Artificial Neural Networks,PostgreSQL"><title>Building a Recommender System | See Hiong&#39;s Blog</title>

    <link rel="canonical" href="https://seehiong.github.io/posts/2025/05/building-a-recommender-system/">

    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    
    
    <link rel="stylesheet" href="/css/variables.css">
    
    <link rel="stylesheet" href="/css/base.css">
    
    <link rel="stylesheet" href="/css/layout.css">
    
    <link rel="stylesheet" href="/css/header.css">
    
    <link rel="stylesheet" href="/css/header.css">
    
    <link rel="stylesheet" href="/css/cards.css">
    
    <link rel="stylesheet" href="/css/content_elements.css">
    
    <link rel="stylesheet" href="/css/codeblocks.css">
    
    <link rel="stylesheet" href="/css/page_specific.css">
    
    <link rel="stylesheet" href="/css/shortcodes.css">
    
    <link rel="stylesheet" href="/css/components.css">
    
    <link rel="stylesheet" href="/css/animations.css">
    
    <link rel="stylesheet" href="/css/media_queries.css">
    
    <link rel="stylesheet" href="/css/quantum-theme.css">
    

    
    <script>
      (function() {
        var theme = localStorage.getItem('theme');
        var H = document.documentElement;
        if (theme === 'dark-mode') {
          H.classList.add('dark-mode');
        } else if (theme === 'light-mode') {
          H.classList.remove('dark-mode');
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
          H.classList.add('dark-mode');
        }
      })();
    </script>
</head></head>
  <body class="page-article"><nav class="nav">
  <div class="nav-wrapper">
    <div class="nav-content-wrapper">
      <div class="nav-content">
        <a href="/" class="nav-logo-link" title="See Hiong&#39;s Blog - Home">
          
          
          <img src="/images/blog_logo.png" alt="See Hiong&#39;s Blog Logo" class="nav-logo-image">
        </a>
        <div class="nav-menu">
          <div class="nav-item-wrapper">
            
            
            <a href="/posts/" class="nav-item-content active">Archives</a>
            
          </div>
          
          
          <div class="nav-item-wrapper">
            <a href="/tags/" class="nav-item-content ">Tags</a>
          </div>
          <div class="nav-item-wrapper">
            <a href="/about/" class="nav-item-content ">About</a>
          </div>
          <div class="nav-item-wrapper nav-search-toggle-wrapper">
            <button id="nav-search-toggle" class="nav-item-button" aria-label="Toggle search" title="Search">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor" class="nav-item-icon">
                <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5A6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
              </svg>
            </button>
          </div>
          
          
          <button id="theme-toggle" class="nav-item-button" aria-label="Toggle theme"></button> 
        </div>
      </div>
    </div>
  </div>
</nav>


<script>
  document.addEventListener('DOMContentLoaded', function () {
    const themeToggle = document.getElementById('theme-toggle');
    const H = document.documentElement; 

    if (H.classList.contains('dark-mode')) {
      themeToggle.textContent = 'Light Mode';
    } else {
      themeToggle.textContent = 'Dark Mode';
    }

    themeToggle.addEventListener('click', function() {
      H.classList.toggle('dark-mode');
      if (H.classList.contains('dark-mode')) {
        localStorage.setItem('theme', 'dark-mode');
        themeToggle.textContent = 'Light Mode';
      } else {
        localStorage.setItem('theme', 'light-mode');
        themeToggle.textContent = 'Dark Mode';
      }
    });
  });
</script><div id="content-wrapper">
        <main class="container" id="main-content">
<div class="main-content-area">
  <article class="post-layout container">

    <header class="post-header">
      <h1 class="post-title">Building a Recommender System</h1>

      <div class="post-meta">
        <span class="post-meta__date">
          <time datetime="2025-05-02T10:00:00&#43;08:00">May 2, 2025</time>
        </span>

        
          <span class="post-meta__author">Written by See Hiong</span>
        

        
          <span class="post-meta__tags">
            In:
            
              <a href="/tags/recommenders">Recommenders</a>
            
              , <a href="/tags/movielens">MovieLens</a>
            
              , <a href="/tags/applied-machine-learning">Applied Machine Learning</a>
            
              , <a href="/tags/artificial-neural-networks">Artificial Neural Networks</a>
            
              , <a href="/tags/postgresql">PostgreSQL</a>
            
          </span>
        

        
      </div>
    </header>

    
      
      
      <div class="post-cover-container post-cover--artistic-blur-wrapper">
        
          <div class="post-cover-blur-background" style="--bg-image: url('/images/movies/building-a-recommender-system.png');"></div>
          <img src="/images/movies/building-a-recommender-system.png" alt="Building a Recommender System cover image" class="post-cover-image post-cover-image--artistic-blur">
        
      </div>
    

    <section class="post-content">
      <p>As I continue the 






  <a href="https://www.coursera.org/learn/unsupervised-learning-recommenders-reinforcement-learning" target="_blank" rel="noopener noreferrer" >Unsupervised Learning, Recommenders, and Reinforcement Learning course</a>
 — which combines theory with hands-on labs — I’m applying what I learn to solidify my understanding. This post walks through building a movie recommender system using the MovieLens dataset. From data loading and feature engineering to generating embeddings and performing similarity search with pgvector in PostgreSQL, the goal is to bring the course material to life through a practical, end-to-end example. The dataset is based on 






  <a href="https://dl.acm.org/doi/10.1145/2827872" target="_blank" rel="noopener noreferrer" >The MovieLens Datasets: History and Context</a>
.</p>
<h2 id="environment-setup">Environment Setup</h2>
<h3 id="postgresql-installation">PostgreSQL Installation</h3>
<p>I installed the Bitnami PostgreSQL Helm chart in my homelab environment:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm install my-release oci://registry-1.docker.io/bitnamicharts/postgresql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># To get password</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">export</span> <span style="color:#953800">POSTGRES_PASSWORD</span><span style="color:#0550ae">=</span><span style="color:#cf222e">$(</span>kubectl get secret --namespace postgres postgres-postgresql -o <span style="color:#953800">jsonpath</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;{.data.postgres-password}&#34;</span> <span style="color:#1f2328">|</span> base64 -d<span style="color:#cf222e">)</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">echo</span> <span style="color:#953800">$POSTGRES_PASSWORD</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="database-schema-preparation">Database Schema Preparation</h3>
<p>Here’s the schema I created for storing movie-related data and embeddings. I also enabled the <code>vector</code> extension for future use in vector-based operations.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#57606a">-- Create schema and enable vector extension
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span><span style="color:#cf222e">SCHEMA</span><span style="color:#fff"> </span><span style="color:#cf222e">IF</span><span style="color:#fff"> </span><span style="color:#cf222e">NOT</span><span style="color:#fff"> </span><span style="color:#cf222e">EXISTS</span><span style="color:#fff"> </span>movie_recommender<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span>EXTENSION<span style="color:#fff"> </span><span style="color:#cf222e">IF</span><span style="color:#fff"> </span><span style="color:#cf222e">NOT</span><span style="color:#fff"> </span><span style="color:#cf222e">EXISTS</span><span style="color:#fff"> </span>vector<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#57606a">-- Drop tables if they exist (clean start)
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#cf222e">DROP</span><span style="color:#fff"> </span><span style="color:#cf222e">TABLE</span><span style="color:#fff"> </span><span style="color:#cf222e">IF</span><span style="color:#fff"> </span><span style="color:#cf222e">EXISTS</span><span style="color:#fff"> </span>movie_recommender<span style="color:#1f2328">.</span>movie_embeddings<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">DROP</span><span style="color:#fff"> </span><span style="color:#cf222e">TABLE</span><span style="color:#fff"> </span><span style="color:#cf222e">IF</span><span style="color:#fff"> </span><span style="color:#cf222e">EXISTS</span><span style="color:#fff"> </span>movie_recommender<span style="color:#1f2328">.</span>ratings<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">DROP</span><span style="color:#fff"> </span><span style="color:#cf222e">TABLE</span><span style="color:#fff"> </span><span style="color:#cf222e">IF</span><span style="color:#fff"> </span><span style="color:#cf222e">EXISTS</span><span style="color:#fff"> </span>movie_recommender<span style="color:#1f2328">.</span>links<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">DROP</span><span style="color:#fff"> </span><span style="color:#cf222e">TABLE</span><span style="color:#fff"> </span><span style="color:#cf222e">IF</span><span style="color:#fff"> </span><span style="color:#cf222e">EXISTS</span><span style="color:#fff"> </span>movie_recommender<span style="color:#1f2328">.</span>tags<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">DROP</span><span style="color:#fff"> </span><span style="color:#cf222e">TABLE</span><span style="color:#fff"> </span><span style="color:#cf222e">IF</span><span style="color:#fff"> </span><span style="color:#cf222e">EXISTS</span><span style="color:#fff"> </span>movie_recommender<span style="color:#1f2328">.</span>movies<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#57606a">-- Define core tables
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span><span style="color:#cf222e">TABLE</span><span style="color:#fff"> </span>movie_recommender<span style="color:#1f2328">.</span>movies<span style="color:#fff"> </span><span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>movieId<span style="color:#fff"> </span><span style="color:#6639ba">INT</span><span style="color:#fff"> </span><span style="color:#cf222e">PRIMARY</span><span style="color:#fff"> </span><span style="color:#cf222e">KEY</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>title<span style="color:#fff"> </span><span style="color:#6639ba">VARCHAR</span><span style="color:#1f2328">(</span><span style="color:#0550ae">255</span><span style="color:#1f2328">),</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>genres<span style="color:#fff"> </span><span style="color:#6639ba">VARCHAR</span><span style="color:#1f2328">(</span><span style="color:#0550ae">255</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span><span style="color:#cf222e">TABLE</span><span style="color:#fff"> </span>movie_recommender<span style="color:#1f2328">.</span>ratings<span style="color:#fff"> </span><span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>userId<span style="color:#fff"> </span><span style="color:#6639ba">INT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>movieId<span style="color:#fff"> </span><span style="color:#6639ba">INT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>rating<span style="color:#fff"> </span><span style="color:#6639ba">FLOAT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">timestamp</span><span style="color:#fff"> </span><span style="color:#6639ba">BIGINT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">PRIMARY</span><span style="color:#fff"> </span><span style="color:#cf222e">KEY</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>userId<span style="color:#1f2328">,</span><span style="color:#fff"> </span>movieId<span style="color:#1f2328">),</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">FOREIGN</span><span style="color:#fff"> </span><span style="color:#cf222e">KEY</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>movieId<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">REFERENCES</span><span style="color:#fff"> </span>movie_recommender<span style="color:#1f2328">.</span>movies<span style="color:#1f2328">(</span>movieId<span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span><span style="color:#cf222e">TABLE</span><span style="color:#fff"> </span>movie_recommender<span style="color:#1f2328">.</span>links<span style="color:#fff"> </span><span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>movieId<span style="color:#fff"> </span><span style="color:#6639ba">INT</span><span style="color:#fff"> </span><span style="color:#cf222e">PRIMARY</span><span style="color:#fff"> </span><span style="color:#cf222e">KEY</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>imdbId<span style="color:#fff"> </span><span style="color:#6639ba">VARCHAR</span><span style="color:#1f2328">(</span><span style="color:#0550ae">20</span><span style="color:#1f2328">),</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>tmdbId<span style="color:#fff"> </span><span style="color:#6639ba">INT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">FOREIGN</span><span style="color:#fff"> </span><span style="color:#cf222e">KEY</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>movieId<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">REFERENCES</span><span style="color:#fff"> </span>movie_recommender<span style="color:#1f2328">.</span>movies<span style="color:#1f2328">(</span>movieId<span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span><span style="color:#cf222e">TABLE</span><span style="color:#fff"> </span>movie_recommender<span style="color:#1f2328">.</span>tags<span style="color:#fff"> </span><span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>userId<span style="color:#fff"> </span><span style="color:#6639ba">INT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>movieId<span style="color:#fff"> </span><span style="color:#6639ba">INT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>tag<span style="color:#fff"> </span><span style="color:#6639ba">VARCHAR</span><span style="color:#1f2328">(</span><span style="color:#0550ae">255</span><span style="color:#1f2328">),</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">timestamp</span><span style="color:#fff"> </span><span style="color:#6639ba">BIGINT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">FOREIGN</span><span style="color:#fff"> </span><span style="color:#cf222e">KEY</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>movieId<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">REFERENCES</span><span style="color:#fff"> </span>movie_recommender<span style="color:#1f2328">.</span>movies<span style="color:#1f2328">(</span>movieId<span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#57606a">-- Embeddings table
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span><span style="color:#cf222e">TABLE</span><span style="color:#fff"> </span>movie_recommender<span style="color:#1f2328">.</span>movie_embeddings<span style="color:#fff"> </span><span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>movieid<span style="color:#fff"> </span><span style="color:#6639ba">INT</span><span style="color:#fff"> </span><span style="color:#cf222e">NOT</span><span style="color:#fff"> </span><span style="color:#cf222e">NULL</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>embedding<span style="color:#fff"> </span><span style="color:#cf222e">public</span><span style="color:#1f2328">.</span>vector<span style="color:#fff"> </span><span style="color:#cf222e">NULL</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">CONSTRAINT</span><span style="color:#fff"> </span>movie_embeddings_pkey<span style="color:#fff"> </span><span style="color:#cf222e">PRIMARY</span><span style="color:#fff"> </span><span style="color:#cf222e">KEY</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>movieid<span style="color:#1f2328">),</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">FOREIGN</span><span style="color:#fff"> </span><span style="color:#cf222e">KEY</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>movieid<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">REFERENCES</span><span style="color:#fff"> </span>movie_recommender<span style="color:#1f2328">.</span>movies<span style="color:#1f2328">(</span>movieId<span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">);</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h2 id="load-data-from-csv">Load Data from CSV</h2>
<h3 id="1-database-configuration-in-jupyter">1. Database Configuration in Jupyter</h3>
<p><strong>Note</strong>: For production, consider using environment variables or a secrets manager for credentials.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#57606a"># File paths</span>
</span></span><span style="display:flex;"><span>ratings_file <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#39;ratings.csv&#39;</span>
</span></span><span style="display:flex;"><span>movies_file <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#39;movies.csv&#39;</span>
</span></span><span style="display:flex;"><span>links_file <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#39;links.csv&#39;</span>
</span></span><span style="display:flex;"><span>tags_file <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#39;tags.csv&#39;</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Database credentials</span>
</span></span><span style="display:flex;"><span>db_params <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#39;database&#39;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#39;postgres&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#39;user&#39;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#39;postgres&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#39;password&#39;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#39;W8oMlEyhq9&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#39;host&#39;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#39;postgres-postgresql.postgres&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#39;port&#39;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#39;5432&#39;</span>  
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>target_schema <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;movie_recommender&#34;</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="2-writing-csv-to-postgresql">2. Writing CSV to PostgreSQL</h3>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">psycopg2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Function to bulk copy data</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">copy_data_to_postgres</span><span style="color:#1f2328">(</span>csv_path<span style="color:#1f2328">,</span> schema_name<span style="color:#1f2328">,</span> table_name<span style="color:#1f2328">,</span> columns<span style="color:#1f2328">,</span> connection<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    qualified_table_name <span style="color:#0550ae">=</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">{</span>schema_name<span style="color:#0a3069">}</span><span style="color:#0a3069">.</span><span style="color:#0a3069">{</span>table_name<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">with</span> <span style="color:#6639ba">open</span><span style="color:#1f2328">(</span>csv_path<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;r&#39;</span><span style="color:#1f2328">,</span> encoding<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;utf-8&#39;</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">as</span> f<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">next</span><span style="color:#1f2328">(</span>f<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            cursor <span style="color:#0550ae">=</span> connection<span style="color:#0550ae">.</span>cursor<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            copy_sql <span style="color:#0550ae">=</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;COPY </span><span style="color:#0a3069">{</span>qualified_table_name<span style="color:#0a3069">}</span><span style="color:#0a3069"> (</span><span style="color:#0a3069">{</span><span style="color:#0a3069">&#39;,&#39;</span><span style="color:#0550ae">.</span>join<span style="color:#1f2328">(</span>columns<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">) FROM STDIN WITH (FORMAT CSV, DELIMITER &#39;,&#39;, HEADER FALSE)&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Attempting to copy data to </span><span style="color:#0a3069">{</span>qualified_table_name<span style="color:#0a3069">}</span><span style="color:#0a3069">...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            cursor<span style="color:#0550ae">.</span>copy_expert<span style="color:#1f2328">(</span>sql<span style="color:#0550ae">=</span>copy_sql<span style="color:#1f2328">,</span> file<span style="color:#0550ae">=</span>f<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            connection<span style="color:#0550ae">.</span>commit<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Successfully copied data from </span><span style="color:#0a3069">{</span>csv_path<span style="color:#0a3069">}</span><span style="color:#0a3069"> to </span><span style="color:#0a3069">{</span>qualified_table_name<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">except</span> <span style="color:#1f2328">(</span>Exception<span style="color:#1f2328">,</span> psycopg2<span style="color:#0550ae">.</span>DatabaseError<span style="color:#1f2328">)</span> <span style="color:#cf222e">as</span> error<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Error copying data to </span><span style="color:#0a3069">{</span>qualified_table_name<span style="color:#0a3069">}</span><span style="color:#0a3069">: </span><span style="color:#0a3069">{</span>error<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        connection<span style="color:#0550ae">.</span>rollback<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">finally</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> cursor<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            cursor<span style="color:#0550ae">.</span>close<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Establish DB connection</span>
</span></span><span style="display:flex;"><span>conn <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Attempting to connect to PostgreSQL database &#39;</span><span style="color:#0a3069">{</span>db_params<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;database&#39;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#39; on </span><span style="color:#0a3069">{</span>db_params<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;host&#39;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    conn <span style="color:#0550ae">=</span> psycopg2<span style="color:#0550ae">.</span>connect<span style="color:#1f2328">(</span><span style="color:#0550ae">**</span>db_params<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;PostgreSQL connection successful.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Copy datasets</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">-- Copying data into tables in schema &#39;</span><span style="color:#0a3069">{</span>target_schema<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39; --&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    movies_cols <span style="color:#0550ae">=</span> <span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;movieId&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;title&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;genres&#39;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    links_cols <span style="color:#0550ae">=</span> <span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;movieId&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;imdbId&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;tmdbId&#39;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    ratings_cols <span style="color:#0550ae">=</span> <span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;userId&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;movieId&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;rating&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;timestamp&#39;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    tags_cols <span style="color:#0550ae">=</span> <span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;userId&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;movieId&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;tag&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;timestamp&#39;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    copy_data_to_postgres<span style="color:#1f2328">(</span>movies_file<span style="color:#1f2328">,</span> target_schema<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;movies&#39;</span><span style="color:#1f2328">,</span> movies_cols<span style="color:#1f2328">,</span> conn<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    copy_data_to_postgres<span style="color:#1f2328">(</span>links_file<span style="color:#1f2328">,</span> target_schema<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;links&#39;</span><span style="color:#1f2328">,</span> links_cols<span style="color:#1f2328">,</span> conn<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    copy_data_to_postgres<span style="color:#1f2328">(</span>ratings_file<span style="color:#1f2328">,</span> target_schema<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;ratings&#39;</span><span style="color:#1f2328">,</span> ratings_cols<span style="color:#1f2328">,</span> conn<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    copy_data_to_postgres<span style="color:#1f2328">(</span>tags_file<span style="color:#1f2328">,</span> target_schema<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;tags&#39;</span><span style="color:#1f2328">,</span> tags_cols<span style="color:#1f2328">,</span> conn<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Unexpected DB error: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> conn<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        conn<span style="color:#0550ae">.</span>rollback<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">finally</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> conn<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        conn<span style="color:#0550ae">.</span>close<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;DB connection closed.&#34;</span><span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>

































 
  
  





  <img src="/images/movies/movies-dataset-saved-to-postgres.png"   alt="movies-dataset-saved-to-postgres" class="sc-image sc-image-default"
       >


<h2 id="load-data-from-postgresql">Load Data from PostgreSQL</h2>
<p>Now let’s read the ingested data back into Pandas for inspection and processing.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">pandas</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">pd</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">sqlalchemy</span> <span style="color:#cf222e">import</span> create_engine<span style="color:#1f2328">,</span> text
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Setup SQLAlchemy engine</span>
</span></span><span style="display:flex;"><span>db_url <span style="color:#0550ae">=</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;postgresql+psycopg2://</span><span style="color:#0a3069">{</span>db_params<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;user&#39;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">:</span><span style="color:#0a3069">{</span>db_params<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;password&#39;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">@</span><span style="color:#0a3069">{</span>db_params<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;host&#39;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">:</span><span style="color:#0a3069">{</span>db_params<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;port&#39;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">/</span><span style="color:#0a3069">{</span>db_params<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;database&#39;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>engine <span style="color:#0550ae">=</span> create_engine<span style="color:#1f2328">(</span>db_url<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Load data</span>
</span></span><span style="display:flex;"><span>query_ratings <span style="color:#0550ae">=</span> text<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#39;SELECT userid, movieid, rating FROM </span><span style="color:#0a3069">{</span>target_schema<span style="color:#0a3069">}</span><span style="color:#0a3069">.ratings&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>ratings_df <span style="color:#0550ae">=</span> pd<span style="color:#0550ae">.</span>read_sql<span style="color:#1f2328">(</span>query_ratings<span style="color:#1f2328">,</span> engine<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>query_movies <span style="color:#0550ae">=</span> text<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#39;SELECT movieid, title, genres FROM </span><span style="color:#0a3069">{</span>target_schema<span style="color:#0a3069">}</span><span style="color:#0a3069">.movies&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>movies_df <span style="color:#0550ae">=</span> pd<span style="color:#0550ae">.</span>read_sql<span style="color:#1f2328">(</span>query_movies<span style="color:#1f2328">,</span> engine<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pd<span style="color:#0550ae">.</span>set_option<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;display.width&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">200</span><span style="color:#1f2328">)</span>   
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Loaded </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>ratings_df<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> ratings and </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>movies_df<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> movies.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span>ratings_df<span style="color:#0550ae">.</span>head<span style="color:#1f2328">())</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span>movies_df<span style="color:#0550ae">.</span>head<span style="color:#1f2328">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>engine<span style="color:#0550ae">.</span>dispose<span style="color:#1f2328">()</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>

































 
  
  





  <img src="/images/movies/movies-load-from-postgres.png"   alt="movies-load-from-postgres" class="sc-image sc-image-default"
       >


<h2 id="feature-engineering">Feature Engineering</h2>
<h3 id="movie-features">Movie Features</h3>
<p>We&rsquo;ll perform the following preprocessing steps:</p>
<ul>
<li>Extract year from the movie title</li>
<li>One-hot encode genres</li>
<li>Calculate the average rating per movie</li>
</ul>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">sklearn.preprocessing</span> <span style="color:#cf222e">import</span> MultiLabelBinarizer
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">re</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Extract Year</span>
</span></span><span style="display:flex;"><span>movies_df<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;year&#39;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> movies_df<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;title&#39;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>str<span style="color:#0550ae">.</span>extract<span style="color:#1f2328">(</span><span style="color:#0a3069">r</span><span style="color:#0a3069">&#39;\((\d</span><span style="color:#0a3069">{4}</span><span style="color:#0a3069">)\)&#39;</span><span style="color:#1f2328">,</span> expand<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>movies_df<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;year&#39;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> pd<span style="color:#0550ae">.</span>to_numeric<span style="color:#1f2328">(</span>movies_df<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;year&#39;</span><span style="color:#1f2328">],</span> errors<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;coerce&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>median_year <span style="color:#0550ae">=</span> movies_df<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;year&#39;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>median<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>movies_df<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;year&#39;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> movies_df<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;year&#39;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>fillna<span style="color:#1f2328">(</span>median_year<span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>astype<span style="color:#1f2328">(</span><span style="color:#6639ba">int</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Drop entries with no genres</span>
</span></span><span style="display:flex;"><span>movies_df <span style="color:#0550ae">=</span> movies_df<span style="color:#1f2328">[</span>movies_df<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;genres&#39;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">!=</span> <span style="color:#0a3069">&#39;(no genres listed)&#39;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>copy<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># One-hot encode genres</span>
</span></span><span style="display:flex;"><span>movies_df<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;genres_list&#39;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> movies_df<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;genres&#39;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>str<span style="color:#0550ae">.</span>split<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;|&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>mlb <span style="color:#0550ae">=</span> MultiLabelBinarizer<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>genre_df <span style="color:#0550ae">=</span> pd<span style="color:#0550ae">.</span>DataFrame<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    mlb<span style="color:#0550ae">.</span>fit_transform<span style="color:#1f2328">(</span>movies_df<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;genres_list&#39;</span><span style="color:#1f2328">]),</span>
</span></span><span style="display:flex;"><span>    columns<span style="color:#0550ae">=</span>mlb<span style="color:#0550ae">.</span>classes_<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    index<span style="color:#0550ae">=</span>movies_df<span style="color:#0550ae">.</span>index
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Compute average rating</span>
</span></span><span style="display:flex;"><span>movie_avg_ratings <span style="color:#0550ae">=</span> ratings_df<span style="color:#0550ae">.</span>groupby<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;movieid&#39;</span><span style="color:#1f2328">)[</span><span style="color:#0a3069">&#39;rating&#39;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>mean<span style="color:#1f2328">()</span><span style="color:#0550ae">.</span>reset_index<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>movie_avg_ratings<span style="color:#0550ae">.</span>rename<span style="color:#1f2328">(</span>columns<span style="color:#0550ae">=</span><span style="color:#1f2328">{</span><span style="color:#0a3069">&#39;rating&#39;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#39;movie_avg_rating&#39;</span><span style="color:#1f2328">},</span> inplace<span style="color:#0550ae">=</span><span style="color:#cf222e">True</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Final item feature dataframe</span>
</span></span><span style="display:flex;"><span>item_features_df <span style="color:#0550ae">=</span> movies_df<span style="color:#1f2328">[[</span><span style="color:#0a3069">&#39;movieid&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;year&#39;</span><span style="color:#1f2328">]]</span><span style="color:#0550ae">.</span>join<span style="color:#1f2328">(</span>genre_df<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>item_features_df <span style="color:#0550ae">=</span> pd<span style="color:#0550ae">.</span>merge<span style="color:#1f2328">(</span>item_features_df<span style="color:#1f2328">,</span> movie_avg_ratings<span style="color:#1f2328">,</span> on<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;movieid&#39;</span><span style="color:#1f2328">,</span> how<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;left&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>item_features_df<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;movie_avg_rating&#39;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> item_features_df<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;movie_avg_rating&#39;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>fillna<span style="color:#1f2328">(</span>ratings_df<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;rating&#39;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>mean<span style="color:#1f2328">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span>item_features_df<span style="color:#0550ae">.</span>head<span style="color:#1f2328">(</span><span style="color:#0550ae">2</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">#    movieid  year  Action  Adventure  Animation  Children  Comedy  Crime  Documentary  Drama  ...  Horror  IMAX  Musical  Mystery  Romance  Sci-Fi  Thriller  War  Western  movie_avg_rating</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># 0        1  1995       0          1          1         1       1      0            0      0  ...       0     0        0        0        0       0         0    0        0          3.920930</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># 1        2  1995       0          1          0         1       0      0            0      0  ...       0     0        0        0        0       0         0    0        0          3.431818</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># [2 rows x 22 columns]</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="user-features">User Features</h3>
<p>Now that we’ve engineered item-level features, let’s shift our focus to the users. A personalized recommendation system must understand user preferences—and what better way to do that than by analyzing how users rate movies across different genres?</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#57606a"># Mapping Users to Genres</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Merging ratings with genres...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>genre_cols <span style="color:#0550ae">=</span> <span style="color:#6639ba">list</span><span style="color:#1f2328">(</span>mlb<span style="color:#0550ae">.</span>classes_<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>item_genres_for_merge <span style="color:#0550ae">=</span> item_features_df<span style="color:#1f2328">[[</span><span style="color:#0a3069">&#39;movieid&#39;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">+</span> genre_cols<span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>copy<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>ratings_with_genres <span style="color:#0550ae">=</span> pd<span style="color:#0550ae">.</span>merge<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    ratings_df<span style="color:#1f2328">[[</span><span style="color:#0a3069">&#39;userid&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;movieid&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;rating&#39;</span><span style="color:#1f2328">]],</span>
</span></span><span style="display:flex;"><span>    item_genres_for_merge<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    on<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;movieid&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    how<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;inner&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Shape after merging ratings with genres: </span><span style="color:#0a3069">{</span>ratings_with_genres<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Reshaping Data for Aggregation</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Melting genre data...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>melted_genres <span style="color:#0550ae">=</span> ratings_with_genres<span style="color:#0550ae">.</span>melt<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    id_vars<span style="color:#0550ae">=</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;userid&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;rating&#39;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>    value_vars<span style="color:#0550ae">=</span>genre_cols<span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>    var_name<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;genre&#39;</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>    value_name<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;has_genre&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Shape after melting: </span><span style="color:#0a3069">{</span>melted_genres<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Filtering Valid Genre Associations</span>
</span></span><span style="display:flex;"><span>user_genre_ratings <span style="color:#0550ae">=</span> melted_genres<span style="color:#1f2328">[</span>melted_genres<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;has_genre&#39;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">==</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>copy<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Shape after filtering for has_genre=1: </span><span style="color:#0a3069">{</span>user_genre_ratings<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Computing Genre-Based Averages Per User</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Calculating average rating per user per genre...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>user_genre_avg_ratings <span style="color:#0550ae">=</span> user_genre_ratings<span style="color:#0550ae">.</span>groupby<span style="color:#1f2328">([</span><span style="color:#0a3069">&#39;userid&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;genre&#39;</span><span style="color:#1f2328">])[</span><span style="color:#0a3069">&#39;rating&#39;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>mean<span style="color:#1f2328">()</span><span style="color:#0550ae">.</span>reset_index<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Shape after grouping user/genre: </span><span style="color:#0a3069">{</span>user_genre_avg_ratings<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Pivoting to a Feature Matrix</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Pivoting table...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>user_genre_features_df <span style="color:#0550ae">=</span> user_genre_avg_ratings<span style="color:#0550ae">.</span>pivot<span style="color:#1f2328">(</span>index<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;userid&#39;</span><span style="color:#1f2328">,</span> columns<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;genre&#39;</span><span style="color:#1f2328">,</span> values<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;rating&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span>user_genre_features_df<span style="color:#0550ae">.</span>head<span style="color:#1f2328">(</span><span style="color:#0550ae">2</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Rename columns for clarity</span>
</span></span><span style="display:flex;"><span>user_genre_feature_cols <span style="color:#0550ae">=</span> <span style="color:#1f2328">[</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#39;genre_avg_</span><span style="color:#0a3069">{</span>col<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;</span> <span style="color:#cf222e">for</span> col <span style="color:#0550ae">in</span> user_genre_features_df<span style="color:#0550ae">.</span>columns<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>user_genre_features_df<span style="color:#0550ae">.</span>columns <span style="color:#0550ae">=</span> user_genre_feature_cols
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Created </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>user_genre_feature_cols<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> user-genre average features.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Merging ratings with genres...</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Shape after merging ratings with genres: (100789, 22)</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Melting genre data...</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Shape after melting: (1914991, 4)</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Shape after filtering for has_genre=1: (274433, 4)</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Calculating average rating per user per genre...</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Shape after grouping user/genre: (10001, 3)</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Pivoting table...</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># genre     Action  Adventure  Animation  Children    Comedy     Crime  Documentary     Drama   Fantasy  Film-Noir    Horror  IMAX   Musical   Mystery   Romance  Sci-Fi  Thriller  War   Western</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># userid                                                                                                                                                                                         </span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># 1       4.322222   4.388235   4.689655  4.547619  4.277108  4.355556          NaN  4.529412  4.297872        5.0  3.470588   NaN  4.681818  4.166667  4.307692   4.225  4.145455  4.5  4.285714</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># 2       3.954545   4.166667        NaN       NaN  4.000000  3.800000     4.333333  3.882353       NaN        NaN  3.000000  3.75       NaN  4.000000  4.500000   3.875  3.700000  4.5  3.500000</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Created 19 user-genre average features.</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="final-feature-assembly">Final Feature Assembly</h3>
<p>With both item-level and user-level features constructed, we now assemble the final dataset that will feed into our model.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">sklearn.preprocessing</span> <span style="color:#cf222e">import</span> StandardScaler<span style="color:#1f2328">,</span> MinMaxScaler
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">sklearn.model_selection</span> <span style="color:#cf222e">import</span> train_test_split
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Start with the original ratings data (userid, movieid, rating)</span>
</span></span><span style="display:flex;"><span>ratings_with_features <span style="color:#0550ae">=</span> ratings_df<span style="color:#1f2328">[[</span><span style="color:#0a3069">&#39;userid&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;movieid&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;rating&#39;</span><span style="color:#1f2328">]]</span><span style="color:#0550ae">.</span>copy<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Merge item features</span>
</span></span><span style="display:flex;"><span>cols_to_merge_item <span style="color:#0550ae">=</span> <span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;movieid&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;year&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;movie_avg_rating&#39;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">+</span> genre_cols
</span></span><span style="display:flex;"><span>ratings_with_features <span style="color:#0550ae">=</span> pd<span style="color:#0550ae">.</span>merge<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    ratings_with_features<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    item_features_df<span style="color:#1f2328">[</span>cols_to_merge_item<span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>    on<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;movieid&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    how<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;inner&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Shape after merging item features: </span><span style="color:#0a3069">{</span>ratings_with_features<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Merge user features</span>
</span></span><span style="display:flex;"><span>ratings_with_features <span style="color:#0550ae">=</span> pd<span style="color:#0550ae">.</span>merge<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    ratings_with_features<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    user_genre_features_df<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    on<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;userid&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    how<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;inner&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>ratings_with_features<span style="color:#0550ae">.</span>dropna<span style="color:#1f2328">(</span>inplace<span style="color:#0550ae">=</span><span style="color:#cf222e">True</span><span style="color:#1f2328">)</span> 
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Shape after merging user features: </span><span style="color:#0a3069">{</span>ratings_with_features<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Feature splitting</span>
</span></span><span style="display:flex;"><span>item_feature_cols <span style="color:#0550ae">=</span> <span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;year&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;movie_avg_rating&#39;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">+</span> genre_cols 
</span></span><span style="display:flex;"><span>X_user_features <span style="color:#0550ae">=</span> ratings_with_features<span style="color:#1f2328">[</span>user_genre_feature_cols<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>X_item_features <span style="color:#0550ae">=</span> ratings_with_features<span style="color:#1f2328">[</span>item_feature_cols<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>y_target <span style="color:#0550ae">=</span> ratings_with_features<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;rating&#39;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">User feature matrix shape (before split): </span><span style="color:#0a3069">{</span>X_user_features<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Item feature matrix shape (before split): </span><span style="color:#0a3069">{</span>X_item_features<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Target vector shape (before split): </span><span style="color:#0a3069">{</span>y_target<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Train-Test split</span>
</span></span><span style="display:flex;"><span>X_user_train_unscaled<span style="color:#1f2328">,</span> X_user_test_unscaled<span style="color:#1f2328">,</span> X_item_train_unscaled<span style="color:#1f2328">,</span> X_item_test_unscaled<span style="color:#1f2328">,</span> y_train_unscaled<span style="color:#1f2328">,</span> y_test_unscaled <span style="color:#0550ae">=</span> train_test_split<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    X_user_features<span style="color:#1f2328">,</span> X_item_features<span style="color:#1f2328">,</span> y_target<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    test_size<span style="color:#0550ae">=</span><span style="color:#0550ae">0.2</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    random_state<span style="color:#0550ae">=</span><span style="color:#0550ae">42</span> 
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">Training shapes (before scaling): User=</span><span style="color:#0a3069">{</span>X_user_train_unscaled<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">, Item=</span><span style="color:#0a3069">{</span>X_item_train_unscaled<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">, Target=</span><span style="color:#0a3069">{</span>y_train_unscaled<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Testing shapes (before scaling):  User=</span><span style="color:#0a3069">{</span>X_user_test_unscaled<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">, Item=</span><span style="color:#0a3069">{</span>X_item_test_unscaled<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">, Target=</span><span style="color:#0a3069">{</span>y_test_unscaled<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Feature scaling</span>
</span></span><span style="display:flex;"><span>scalerUser <span style="color:#0550ae">=</span> StandardScaler<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>user_train <span style="color:#0550ae">=</span> scalerUser<span style="color:#0550ae">.</span>fit_transform<span style="color:#1f2328">(</span>X_user_train_unscaled<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>user_test <span style="color:#0550ae">=</span> scalerUser<span style="color:#0550ae">.</span>transform<span style="color:#1f2328">(</span>X_user_test_unscaled<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">Scaled user features matrix. Train shape: </span><span style="color:#0a3069">{</span>user_train<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">, Test shape: </span><span style="color:#0a3069">{</span>user_test<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>scalerItem <span style="color:#0550ae">=</span> StandardScaler<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>item_train <span style="color:#0550ae">=</span> scalerItem<span style="color:#0550ae">.</span>fit_transform<span style="color:#1f2328">(</span>X_item_train_unscaled<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>item_test <span style="color:#0550ae">=</span> scalerItem<span style="color:#0550ae">.</span>transform<span style="color:#1f2328">(</span>X_item_test_unscaled<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Scaled item features matrix. Train shape: </span><span style="color:#0a3069">{</span>item_train<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">, Test shape: </span><span style="color:#0a3069">{</span>item_test<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>scalerTarget <span style="color:#0550ae">=</span> MinMaxScaler<span style="color:#1f2328">((</span><span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>y_train <span style="color:#0550ae">=</span> scalerTarget<span style="color:#0550ae">.</span>fit_transform<span style="color:#1f2328">(</span>y_train_unscaled<span style="color:#0550ae">.</span>values<span style="color:#0550ae">.</span>reshape<span style="color:#1f2328">(</span><span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>y_test <span style="color:#0550ae">=</span> scalerTarget<span style="color:#0550ae">.</span>transform<span style="color:#1f2328">(</span>y_test_unscaled<span style="color:#0550ae">.</span>values<span style="color:#0550ae">.</span>reshape<span style="color:#1f2328">(</span><span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Scaled target variable (y). Train shape: </span><span style="color:#0a3069">{</span>y_train<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">, Test shape: </span><span style="color:#0a3069">{</span>y_test<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>num_user_features <span style="color:#0550ae">=</span> user_train<span style="color:#0550ae">.</span>shape<span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>num_item_features <span style="color:#0550ae">=</span> item_train<span style="color:#0550ae">.</span>shape<span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Final dataset shapes</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">user_train: </span><span style="color:#0a3069">{</span>user_train<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;item_train: </span><span style="color:#0a3069">{</span>item_train<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;y_train:    </span><span style="color:#0a3069">{</span>y_train<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Shape after merging item features: (100789, 24)</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Shape after merging user features: (53434, 43)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># User feature matrix shape (before split): (53434, 19)</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Item feature matrix shape (before split): (53434, 21)</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Target vector shape (before split): (53434,)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Training shapes (before scaling): User=(42747, 19), Item=(42747, 21), Target=(42747,)</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Testing shapes (before scaling):  User=(10687, 19), Item=(10687, 21), Target=(10687,)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Scaled user features matrix. Train shape: (42747, 19), Test shape: (10687, 19)</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Scaled item features matrix. Train shape: (42747, 21), Test shape: (10687, 21)</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Scaled target variable (y). Train shape: (42747, 1), Test shape: (10687, 1)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># user_train: (42747, 19)</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># item_train: (42747, 21)</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># y_train:    (42747, 1)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h2 id="define-the-model">Define the Model</h2>
<p>Following the course lab, we design a content-based filtering neural network using the Keras Functional API. The model learns user and item embeddings from their respective features and uses the dot product to compute similarity between them.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">tensorflow</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">tf</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">tensorflow</span> <span style="color:#cf222e">import</span> keras
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Set a fixed seed for reproducibility</span>
</span></span><span style="display:flex;"><span>tf<span style="color:#0550ae">.</span>random<span style="color:#0550ae">.</span>set_seed<span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Define the size of the final embedding space</span>
</span></span><span style="display:flex;"><span>num_outputs <span style="color:#0550ae">=</span> <span style="color:#0550ae">32</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Define the user sub-network</span>
</span></span><span style="display:flex;"><span>user_NN <span style="color:#0550ae">=</span> tf<span style="color:#0550ae">.</span>keras<span style="color:#0550ae">.</span>models<span style="color:#0550ae">.</span>Sequential<span style="color:#1f2328">([</span>
</span></span><span style="display:flex;"><span>    tf<span style="color:#0550ae">.</span>keras<span style="color:#0550ae">.</span>layers<span style="color:#0550ae">.</span>Dense<span style="color:#1f2328">(</span><span style="color:#0550ae">256</span><span style="color:#1f2328">,</span> activation<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;relu&#39;</span><span style="color:#1f2328">,</span> name<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;user_dense_1&#39;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    tf<span style="color:#0550ae">.</span>keras<span style="color:#0550ae">.</span>layers<span style="color:#0550ae">.</span>Dense<span style="color:#1f2328">(</span><span style="color:#0550ae">128</span><span style="color:#1f2328">,</span> activation<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;relu&#39;</span><span style="color:#1f2328">,</span> name<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;user_dense_2&#39;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    tf<span style="color:#0550ae">.</span>keras<span style="color:#0550ae">.</span>layers<span style="color:#0550ae">.</span>Dense<span style="color:#1f2328">(</span>num_outputs<span style="color:#1f2328">,</span> name<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;user_embedding_output&#39;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">],</span> name<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;user_sequential_network&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Define the item sub-network</span>
</span></span><span style="display:flex;"><span>item_NN <span style="color:#0550ae">=</span> tf<span style="color:#0550ae">.</span>keras<span style="color:#0550ae">.</span>models<span style="color:#0550ae">.</span>Sequential<span style="color:#1f2328">([</span>
</span></span><span style="display:flex;"><span>    tf<span style="color:#0550ae">.</span>keras<span style="color:#0550ae">.</span>layers<span style="color:#0550ae">.</span>Dense<span style="color:#1f2328">(</span><span style="color:#0550ae">256</span><span style="color:#1f2328">,</span> activation<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;relu&#39;</span><span style="color:#1f2328">,</span> name<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;item_dense_1&#39;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    tf<span style="color:#0550ae">.</span>keras<span style="color:#0550ae">.</span>layers<span style="color:#0550ae">.</span>Dense<span style="color:#1f2328">(</span><span style="color:#0550ae">128</span><span style="color:#1f2328">,</span> activation<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;relu&#39;</span><span style="color:#1f2328">,</span> name<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;item_dense_2&#39;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    tf<span style="color:#0550ae">.</span>keras<span style="color:#0550ae">.</span>layers<span style="color:#0550ae">.</span>Dense<span style="color:#1f2328">(</span>num_outputs<span style="color:#1f2328">,</span> name<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;item_embedding_output&#39;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">],</span> name<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;item_sequential_network&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># User input and embedding pipeline</span>
</span></span><span style="display:flex;"><span>input_user <span style="color:#0550ae">=</span> tf<span style="color:#0550ae">.</span>keras<span style="color:#0550ae">.</span>layers<span style="color:#0550ae">.</span>Input<span style="color:#1f2328">(</span>shape<span style="color:#0550ae">=</span><span style="color:#1f2328">(</span>num_user_features<span style="color:#1f2328">,),</span> name<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;user_input&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>vu <span style="color:#0550ae">=</span> user_NN<span style="color:#1f2328">(</span>input_user<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>vu_normalized <span style="color:#0550ae">=</span> tf<span style="color:#0550ae">.</span>keras<span style="color:#0550ae">.</span>layers<span style="color:#0550ae">.</span>Lambda<span style="color:#1f2328">(</span><span style="color:#cf222e">lambda</span> x<span style="color:#1f2328">:</span> tf<span style="color:#0550ae">.</span>linalg<span style="color:#0550ae">.</span>l2_normalize<span style="color:#1f2328">(</span>x<span style="color:#1f2328">,</span> axis<span style="color:#0550ae">=</span><span style="color:#0550ae">1</span><span style="color:#1f2328">),</span> name<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;user_embedding_normalized&#39;</span><span style="color:#1f2328">)(</span>vu<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Item input and embedding pipeline</span>
</span></span><span style="display:flex;"><span>input_item <span style="color:#0550ae">=</span> tf<span style="color:#0550ae">.</span>keras<span style="color:#0550ae">.</span>layers<span style="color:#0550ae">.</span>Input<span style="color:#1f2328">(</span>shape<span style="color:#0550ae">=</span><span style="color:#1f2328">(</span>num_item_features<span style="color:#1f2328">,),</span> name<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;item_input&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>vm <span style="color:#0550ae">=</span> item_NN<span style="color:#1f2328">(</span>input_item<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>vm_normalized <span style="color:#0550ae">=</span> tf<span style="color:#0550ae">.</span>keras<span style="color:#0550ae">.</span>layers<span style="color:#0550ae">.</span>Lambda<span style="color:#1f2328">(</span><span style="color:#cf222e">lambda</span> x<span style="color:#1f2328">:</span> tf<span style="color:#0550ae">.</span>linalg<span style="color:#0550ae">.</span>l2_normalize<span style="color:#1f2328">(</span>x<span style="color:#1f2328">,</span> axis<span style="color:#0550ae">=</span><span style="color:#0550ae">1</span><span style="color:#1f2328">),</span> name<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;item_embedding_normalized&#39;</span><span style="color:#1f2328">)(</span>vm<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Compute similarity using dot product</span>
</span></span><span style="display:flex;"><span>dot_product <span style="color:#0550ae">=</span> tf<span style="color:#0550ae">.</span>keras<span style="color:#0550ae">.</span>layers<span style="color:#0550ae">.</span>Dot<span style="color:#1f2328">(</span>axes<span style="color:#0550ae">=</span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span> name<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;dot_product&#39;</span><span style="color:#1f2328">)([</span>vu_normalized<span style="color:#1f2328">,</span> vm_normalized<span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Define the full model</span>
</span></span><span style="display:flex;"><span>model <span style="color:#0550ae">=</span> tf<span style="color:#0550ae">.</span>keras<span style="color:#0550ae">.</span>Model<span style="color:#1f2328">(</span>inputs<span style="color:#0550ae">=</span><span style="color:#1f2328">[</span>input_user<span style="color:#1f2328">,</span> input_item<span style="color:#1f2328">],</span> outputs<span style="color:#0550ae">=</span>dot_product<span style="color:#1f2328">,</span> name<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;ContentBasedFilteringNN_DotProduct&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Model Created using Functional API.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>model<span style="color:#0550ae">.</span>summary<span style="color:#1f2328">()</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>

































 
  
  





  <img src="/images/movies/movies-content-based-filtering-model.png"   alt="movies-content-based-filtering-model" class="sc-image sc-image-default"
       >


<h2 id="compile-the-model">Compile the Model</h2>
<p>We compile the model using the Mean Squared Error (MSE) loss function and the Adam optimizer, suitable for learning continuous similarity scores.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">Compiling Model...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tf<span style="color:#0550ae">.</span>random<span style="color:#0550ae">.</span>set_seed<span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>cost_fn <span style="color:#0550ae">=</span> tf<span style="color:#0550ae">.</span>keras<span style="color:#0550ae">.</span>losses<span style="color:#0550ae">.</span>MeanSquaredError<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>opt <span style="color:#0550ae">=</span> keras<span style="color:#0550ae">.</span>optimizers<span style="color:#0550ae">.</span>Adam<span style="color:#1f2328">(</span>learning_rate<span style="color:#0550ae">=</span><span style="color:#0550ae">0.01</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>model<span style="color:#0550ae">.</span>compile<span style="color:#1f2328">(</span>optimizer<span style="color:#0550ae">=</span>opt<span style="color:#1f2328">,</span> loss<span style="color:#0550ae">=</span>cost_fn<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Model Compiled.&#34;</span><span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h2 id="train-the-model">Train the Model</h2>
<p>We now train the model using <code>model.fit()</code>, passing in both user and item features as inputs and the target similarity scores (<code>y_train</code>) as labels.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Starting Model Training...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Define training parameters</span>
</span></span><span style="display:flex;"><span>EPOCHS <span style="color:#0550ae">=</span> <span style="color:#0550ae">30</span>
</span></span><span style="display:flex;"><span>tf<span style="color:#0550ae">.</span>random<span style="color:#0550ae">.</span>set_seed<span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>history <span style="color:#0550ae">=</span> model<span style="color:#0550ae">.</span>fit<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    x<span style="color:#0550ae">=</span><span style="color:#1f2328">[</span>user_train<span style="color:#1f2328">,</span> item_train<span style="color:#1f2328">],</span>  <span style="color:#57606a"># Inputs: user and item features</span>
</span></span><span style="display:flex;"><span>    y<span style="color:#0550ae">=</span>y_train<span style="color:#1f2328">,</span>                   <span style="color:#57606a"># Target: similarity score (e.g., scaled rating)</span>
</span></span><span style="display:flex;"><span>    epochs<span style="color:#0550ae">=</span>EPOCHS<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    verbose<span style="color:#0550ae">=</span><span style="color:#0550ae">1</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Model Training Complete.&#34;</span><span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>

































 
  
  





  <img src="/images/movies/movies-content-based-filtering-model-training.png"   alt="movies-content-based-filtering-model-training" class="sc-image sc-image-default"
       >


<h2 id="evaluate-the-model">Evaluate the Model</h2>
<p>Finally, we evaluate the model on a separate test dataset and compute both the MSE and RMSE for interpretability.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">numpy</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">np</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">-- Evaluating the Model on SCALED Test Data --&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>test_loss <span style="color:#0550ae">=</span> model<span style="color:#0550ae">.</span>evaluate<span style="color:#1f2328">([</span>user_test<span style="color:#1f2328">,</span> item_test<span style="color:#1f2328">],</span> y_test<span style="color:#1f2328">,</span> verbose<span style="color:#0550ae">=</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Compute RMSE for easier interpretation</span>
</span></span><span style="display:flex;"><span>test_rmse <span style="color:#0550ae">=</span> np<span style="color:#0550ae">.</span>sqrt<span style="color:#1f2328">(</span>test_loss<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">Test Loss (MSE on scaled data): </span><span style="color:#0a3069">{</span>test_loss<span style="color:#0a3069">:</span><span style="color:#0a3069">.4f</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Test RMSE (calculated from MSE): </span><span style="color:#0a3069">{</span>test_rmse<span style="color:#0a3069">:</span><span style="color:#0a3069">.4f</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># -- Evaluating the Model on SCALED Test Data --</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># 334/334 ━━━━━━━━━━━━━━━━━━━━ 0s 728us/step - loss: 0.1056</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Test Loss (MSE on scaled data): 0.1052</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Test RMSE (calculated from MSE): 0.3244</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h2 id="predicting-ratings-for-an-existing-user">Predicting Ratings for an Existing User</h2>
<p>This section walks through how we generate personalized movie recommendations for a specific user using our trained neural network model.</p>
<p>We apply the following process:</p>
<ul>
<li>Find unrated movies for the selected user.</li>
<li>Prepare the feature vectors for both the user and unrated items.</li>
<li>Make predictions using the scaled input features.</li>
<li>Rescale the predictions to match the original rating scale.</li>
<li>Display recommendations sorted by predicted rating and popularity.</li>
<li>Evaluate prediction performance for items the user has already rated.</li>
</ul>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">numpy</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">np</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">pandas</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">pd</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">sklearn.preprocessing</span> <span style="color:#cf222e">import</span> StandardScaler
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">predict_and_display_for_user</span><span style="color:#1f2328">(</span>uid<span style="color:#1f2328">,</span> model<span style="color:#1f2328">,</span> user_features_df<span style="color:#1f2328">,</span> item_features_df<span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>                                ratings_df<span style="color:#1f2328">,</span> movies_df<span style="color:#1f2328">,</span> scalerUser<span style="color:#1f2328">,</span> scalerItem<span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>                                scalerTarget<span style="color:#1f2328">,</span> maxcount<span style="color:#0550ae">=</span><span style="color:#0550ae">15</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Fetch all ratings made by this user</span>
</span></span><span style="display:flex;"><span>    user_actuals <span style="color:#0550ae">=</span> ratings_df<span style="color:#1f2328">[</span>ratings_df<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;userid&#39;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">==</span> uid<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Identify movies not yet rated by the user</span>
</span></span><span style="display:flex;"><span>    unrated_movies <span style="color:#0550ae">=</span> item_features_df<span style="color:#1f2328">[</span><span style="color:#0550ae">~</span>item_features_df<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;movieid&#39;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>isin<span style="color:#1f2328">(</span>user_actuals<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;movieid&#39;</span><span style="color:#1f2328">])]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>unrated_movies<span style="color:#1f2328">)</span> <span style="color:#0550ae">==</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;User </span><span style="color:#0a3069">{</span>uid<span style="color:#0a3069">}</span><span style="color:#0a3069"> has rated all available movies.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Repeat the user&#39;s feature vector to match the unrated movie count</span>
</span></span><span style="display:flex;"><span>    user_vec <span style="color:#0550ae">=</span> user_features_df<span style="color:#1f2328">[</span>user_features_df<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;userid&#39;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">==</span> uid<span style="color:#1f2328">][</span>scalerUser<span style="color:#0550ae">.</span>feature_names_in_<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    user_vecs <span style="color:#0550ae">=</span> pd<span style="color:#0550ae">.</span>concat<span style="color:#1f2328">([</span>user_vec<span style="color:#1f2328">]</span> <span style="color:#0550ae">*</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>unrated_movies<span style="color:#1f2328">),</span> ignore_index<span style="color:#0550ae">=</span><span style="color:#cf222e">True</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Scale both user and item feature vectors</span>
</span></span><span style="display:flex;"><span>    suser_vecs <span style="color:#0550ae">=</span> scalerUser<span style="color:#0550ae">.</span>transform<span style="color:#1f2328">(</span>user_vecs<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    sitem_vecs <span style="color:#0550ae">=</span> scalerItem<span style="color:#0550ae">.</span>transform<span style="color:#1f2328">(</span>unrated_movies<span style="color:#1f2328">[</span>scalerItem<span style="color:#0550ae">.</span>feature_names_in_<span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Predict scaled ratings, then inverse transform to original scale</span>
</span></span><span style="display:flex;"><span>    scaled_preds <span style="color:#0550ae">=</span> model<span style="color:#0550ae">.</span>predict<span style="color:#1f2328">([</span>suser_vecs<span style="color:#1f2328">,</span> sitem_vecs<span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>    predictions <span style="color:#0550ae">=</span> scalerTarget<span style="color:#0550ae">.</span>inverse_transform<span style="color:#1f2328">(</span>scaled_preds<span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>flatten<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Build result DataFrame</span>
</span></span><span style="display:flex;"><span>    results <span style="color:#0550ae">=</span> pd<span style="color:#0550ae">.</span>DataFrame<span style="color:#1f2328">({</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;movieid&#39;</span><span style="color:#1f2328">:</span> unrated_movies<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;movieid&#39;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;predicted_raw&#39;</span><span style="color:#1f2328">:</span> predictions<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;title&#39;</span><span style="color:#1f2328">:</span> unrated_movies<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;movieid&#39;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>map<span style="color:#1f2328">(</span><span style="color:#6639ba">dict</span><span style="color:#1f2328">(</span><span style="color:#6639ba">zip</span><span style="color:#1f2328">(</span>movies_df<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;movieid&#39;</span><span style="color:#1f2328">],</span> movies_df<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;title&#39;</span><span style="color:#1f2328">])))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Join with movie rating stats</span>
</span></span><span style="display:flex;"><span>    movie_stats <span style="color:#0550ae">=</span> ratings_df<span style="color:#0550ae">.</span>groupby<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;movieid&#39;</span><span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>agg<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        avg_rating<span style="color:#0550ae">=</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;rating&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;mean&#39;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        rating_count<span style="color:#0550ae">=</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;rating&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;count&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    results <span style="color:#0550ae">=</span> results<span style="color:#0550ae">.</span>merge<span style="color:#1f2328">(</span>movie_stats<span style="color:#1f2328">,</span> on<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;movieid&#39;</span><span style="color:#1f2328">,</span> how<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;left&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Clip predictions to valid rating range</span>
</span></span><span style="display:flex;"><span>    results<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;predicted&#39;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> np<span style="color:#0550ae">.</span>clip<span style="color:#1f2328">(</span>results<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;predicted&#39;</span><span style="color:#1f2328">],</span> <span style="color:#0550ae">0.5</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">5.0</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Filter by movies with enough votes and sort</span>
</span></span><span style="display:flex;"><span>    results <span style="color:#0550ae">=</span> results<span style="color:#1f2328">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">(</span>results<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;rating_count&#39;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">&gt;=</span> <span style="color:#0550ae">10</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>sort_values<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        by<span style="color:#0550ae">=</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;predicted&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;rating_count&#39;</span><span style="color:#1f2328">],</span> 
</span></span><span style="display:flex;"><span>        ascending<span style="color:#0550ae">=</span><span style="color:#1f2328">[</span><span style="color:#cf222e">False</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">False</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>head<span style="color:#1f2328">(</span>maxcount<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Print the final top-N recommendations</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">Top </span><span style="color:#0a3069">{</span>maxcount<span style="color:#0a3069">}</span><span style="color:#0a3069"> Recommendations for User </span><span style="color:#0a3069">{</span>uid<span style="color:#0a3069">}</span><span style="color:#0a3069">:&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">{:&lt;50}</span><span style="color:#0a3069"> </span><span style="color:#0a3069">{:&lt;8}</span><span style="color:#0a3069"> </span><span style="color:#0a3069">{:&lt;8}</span><span style="color:#0a3069"> </span><span style="color:#0a3069">{:&lt;8}</span><span style="color:#0a3069"> </span><span style="color:#0a3069">{:&lt;10}</span><span style="color:#0a3069">&#34;</span><span style="color:#0550ae">.</span>format<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;Title&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;Pred&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;Avg&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;Votes&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;Δ&#34;</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;-&#34;</span><span style="color:#0550ae">*</span><span style="color:#0550ae">85</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> _<span style="color:#1f2328">,</span> row <span style="color:#0550ae">in</span> results<span style="color:#0550ae">.</span>iterrows<span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>        delta <span style="color:#0550ae">=</span> row<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;predicted&#39;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">-</span> row<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;avg_rating&#39;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>        reliability <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> row<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;rating_count&#39;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">&gt;</span> <span style="color:#0550ae">100</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            reliability <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;✓✓✓&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">elif</span> row<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;rating_count&#39;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">&gt;</span> <span style="color:#0550ae">50</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            reliability <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;✓✓&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">elif</span> row<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;rating_count&#39;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">&gt;</span> <span style="color:#0550ae">20</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            reliability <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;✓&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">{:&lt;50}</span><span style="color:#0a3069"> </span><span style="color:#0a3069">{:&lt;8.2f}</span><span style="color:#0a3069"> </span><span style="color:#0a3069">{:&lt;8.2f}</span><span style="color:#0a3069"> </span><span style="color:#0a3069">{:&lt;8}</span><span style="color:#0a3069"> </span><span style="color:#0a3069">{:&lt;+8.2f}</span><span style="color:#0a3069"> </span><span style="color:#0a3069">{}</span><span style="color:#0a3069">&#34;</span><span style="color:#0550ae">.</span>format<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>            row<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;title&#39;</span><span style="color:#1f2328">][:</span><span style="color:#0550ae">48</span><span style="color:#1f2328">],</span> 
</span></span><span style="display:flex;"><span>            row<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;predicted&#39;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>            row<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;avg_rating&#39;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">int</span><span style="color:#1f2328">(</span>row<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;rating_count&#39;</span><span style="color:#1f2328">]),</span>
</span></span><span style="display:flex;"><span>            delta<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            reliability<span style="color:#1f2328">))</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="evaluating-predictions-on-previously-rated-movies">Evaluating Predictions on Previously Rated Movies</h3>
<p>We also assess how well the model performs by comparing predictions against the user’s actual ratings:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    rated_predictions <span style="color:#0550ae">=</span> get_rated_predictions<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        uid<span style="color:#1f2328">,</span> model<span style="color:#1f2328">,</span> user_features_df<span style="color:#1f2328">,</span> item_features_df<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        ratings_df<span style="color:#1f2328">,</span> scalerUser<span style="color:#1f2328">,</span> scalerItem<span style="color:#1f2328">,</span> scalerTarget
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> rated_predictions<span style="color:#0550ae">.</span>empty<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        mse <span style="color:#0550ae">=</span> <span style="color:#1f2328">((</span>rated_predictions<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;predicted&#39;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">-</span> rated_predictions<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;actual&#39;</span><span style="color:#1f2328">])</span><span style="color:#0550ae">**</span><span style="color:#0550ae">2</span><span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>mean<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">Model Performance on Rated Movies:&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;- RMSE: </span><span style="color:#0a3069">{</span>np<span style="color:#0550ae">.</span>sqrt<span style="color:#1f2328">(</span>mse<span style="color:#1f2328">)</span><span style="color:#0a3069">:</span><span style="color:#0a3069">.4f</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;- Correlation: </span><span style="color:#0a3069">{</span>rated_predictions<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;predicted&#39;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>corr<span style="color:#1f2328">(</span>rated_predictions<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;actual&#39;</span><span style="color:#1f2328">])</span><span style="color:#0a3069">:</span><span style="color:#0a3069">.4f</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">Rating Scale Guide:&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;4.5+     : Very likely to enjoy&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;4.0–4.5  : Probably will enjoy&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;3.5–4.0  : Might enjoy&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;&lt;3.5     : Less likely to enjoy&#34;</span><span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="supporting-function---get_rated_predictions">Supporting Function - get_rated_predictions()</h3>
<p>This helper function returns model predictions for items the user has already rated, so we can compare against ground truth.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">get_rated_predictions</span><span style="color:#1f2328">(</span>uid<span style="color:#1f2328">,</span> model<span style="color:#1f2328">,</span> user_features_df<span style="color:#1f2328">,</span> item_features_df<span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>                         ratings_df<span style="color:#1f2328">,</span> scalerUser<span style="color:#1f2328">,</span> scalerItem<span style="color:#1f2328">,</span> scalerTarget<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    user_ratings <span style="color:#0550ae">=</span> ratings_df<span style="color:#1f2328">[</span>ratings_df<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;userid&#39;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">==</span> uid<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    rated_items <span style="color:#0550ae">=</span> item_features_df<span style="color:#1f2328">[</span>item_features_df<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;movieid&#39;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>isin<span style="color:#1f2328">(</span>user_ratings<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;movieid&#39;</span><span style="color:#1f2328">])]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>rated_items<span style="color:#1f2328">)</span> <span style="color:#0550ae">==</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> pd<span style="color:#0550ae">.</span>DataFrame<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    user_vec <span style="color:#0550ae">=</span> user_features_df<span style="color:#1f2328">[</span>user_features_df<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;userid&#39;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">==</span> uid<span style="color:#1f2328">][</span>scalerUser<span style="color:#0550ae">.</span>feature_names_in_<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    user_vecs <span style="color:#0550ae">=</span> pd<span style="color:#0550ae">.</span>concat<span style="color:#1f2328">([</span>user_vec<span style="color:#1f2328">]</span> <span style="color:#0550ae">*</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>rated_items<span style="color:#1f2328">),</span> ignore_index<span style="color:#0550ae">=</span><span style="color:#cf222e">True</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    suser_vecs <span style="color:#0550ae">=</span> scalerUser<span style="color:#0550ae">.</span>transform<span style="color:#1f2328">(</span>user_vecs<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    sitem_vecs <span style="color:#0550ae">=</span> scalerItem<span style="color:#0550ae">.</span>transform<span style="color:#1f2328">(</span>rated_items<span style="color:#1f2328">[</span>scalerItem<span style="color:#0550ae">.</span>feature_names_in_<span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    scaled_preds <span style="color:#0550ae">=</span> model<span style="color:#0550ae">.</span>predict<span style="color:#1f2328">([</span>suser_vecs<span style="color:#1f2328">,</span> sitem_vecs<span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>    predictions <span style="color:#0550ae">=</span> scalerTarget<span style="color:#0550ae">.</span>inverse_transform<span style="color:#1f2328">(</span>scaled_preds<span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>flatten<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> pd<span style="color:#0550ae">.</span>DataFrame<span style="color:#1f2328">({</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;movieid&#39;</span><span style="color:#1f2328">:</span> rated_items<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;movieid&#39;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>values<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;actual&#39;</span><span style="color:#1f2328">:</span> user_ratings<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;rating&#39;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>values<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;predicted&#39;</span><span style="color:#1f2328">:</span> predictions
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">})</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="example--output">Example  Output</h3>
<p>Let’s test this by generating recommendations for User 2:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>user_genre_features_df <span style="color:#0550ae">=</span> user_genre_features_df<span style="color:#0550ae">.</span>reset_index<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">assert</span> <span style="color:#0a3069">&#39;userid&#39;</span> <span style="color:#0550ae">in</span> user_genre_features_df<span style="color:#0550ae">.</span>columns
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>predict_and_display_for_user<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    uid<span style="color:#0550ae">=</span><span style="color:#0550ae">2</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    model<span style="color:#0550ae">=</span>model<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    user_features_df<span style="color:#0550ae">=</span>user_genre_features_df<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    item_features_df<span style="color:#0550ae">=</span>item_features_df<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    ratings_df<span style="color:#0550ae">=</span>ratings_df<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    movies_df<span style="color:#0550ae">=</span>movies_df<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    scalerUser<span style="color:#0550ae">=</span>scalerUser<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    scalerItem<span style="color:#0550ae">=</span>scalerItem<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    scalerTarget<span style="color:#0550ae">=</span>scalerTarget<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    maxcount<span style="color:#0550ae">=</span><span style="color:#0550ae">15</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>

































 
  
  





  <img src="/images/movies/movies-content-based-filtering-model-prediction.png"   alt="movies-content-based-filtering-model-prediction" class="sc-image sc-image-default"
       >


<h2 id="pgvector-embedding-based-movie-recommendations">PgVector: Embedding-Based Movie Recommendations</h2>
<h3 id="1-insert-embedding">1. Insert Embedding</h3>
<p>To enable similarity search with <code>pgvector</code>, we first generate embeddings using a previously trained model. These embeddings are then stored in a PostgreSQL table with the vector extension enabled.</p>
<p>The following <code>VectorRecommender</code> class handles embedding generation, storage, and querying for similar items and personalized recommendations:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">numpy</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">np</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">pandas</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">pd</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">psycopg2</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">psycopg2.extras</span> <span style="color:#cf222e">import</span> execute_values
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">sklearn.preprocessing</span> <span style="color:#cf222e">import</span> StandardScaler<span style="color:#1f2328">,</span> MinMaxScaler
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">sqlalchemy</span> <span style="color:#cf222e">import</span> create_engine<span style="color:#1f2328">,</span> text
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">tensorflow</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">tf</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">tqdm</span> <span style="color:#cf222e">import</span> tqdm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">class</span> <span style="color:#1f2328">VectorRecommender</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">__init__</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> db_config<span style="color:#1f2328">,</span> target_schema<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;movie_recommender&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>db_config <span style="color:#0550ae">=</span> db_config
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>target_schema <span style="color:#0550ae">=</span> target_schema
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>embedding_table <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;movie_embeddings&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>engine <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>embedding_dim <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_initialize_connection<span style="color:#1f2328">()</span> 
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_initialize_connection</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>engine <span style="color:#0550ae">=</span> create_engine<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;postgresql+psycopg2://</span><span style="color:#0a3069">{</span><span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>db_config<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;user&#39;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">:</span><span style="color:#0a3069">{</span><span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>db_config<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;password&#39;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">@&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">{</span><span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>db_config<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;host&#39;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">:</span><span style="color:#0a3069">{</span><span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>db_config<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;port&#39;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">/</span><span style="color:#0a3069">{</span><span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>db_config<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;database&#39;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">with</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>engine<span style="color:#0550ae">.</span>connect<span style="color:#1f2328">()</span> <span style="color:#cf222e">as</span> conn<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                conn<span style="color:#0550ae">.</span>execute<span style="color:#1f2328">(</span>text<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;SELECT 1&#34;</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Database connection established&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">True</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Connection failed: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>engine <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">False</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">setup_embeddings</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> model<span style="color:#1f2328">,</span> item_features_df<span style="color:#1f2328">,</span> scalerItem<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            item_nn <span style="color:#0550ae">=</span> model<span style="color:#0550ae">.</span>get_layer<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;item_sequential_network&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            input_item <span style="color:#0550ae">=</span> tf<span style="color:#0550ae">.</span>keras<span style="color:#0550ae">.</span>layers<span style="color:#0550ae">.</span>Input<span style="color:#1f2328">(</span>shape<span style="color:#0550ae">=</span><span style="color:#1f2328">(</span>item_features_df<span style="color:#0550ae">.</span>shape<span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]</span><span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">,))</span>
</span></span><span style="display:flex;"><span>            vm <span style="color:#0550ae">=</span> item_nn<span style="color:#1f2328">(</span>input_item<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            vm <span style="color:#0550ae">=</span> tf<span style="color:#0550ae">.</span>keras<span style="color:#0550ae">.</span>layers<span style="color:#0550ae">.</span>Lambda<span style="color:#1f2328">(</span><span style="color:#cf222e">lambda</span> x<span style="color:#1f2328">:</span> tf<span style="color:#0550ae">.</span>linalg<span style="color:#0550ae">.</span>l2_normalize<span style="color:#1f2328">(</span>x<span style="color:#1f2328">,</span> axis<span style="color:#0550ae">=</span><span style="color:#0550ae">1</span><span style="color:#1f2328">))(</span>vm<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            embedding_model <span style="color:#0550ae">=</span> tf<span style="color:#0550ae">.</span>keras<span style="color:#0550ae">.</span>Model<span style="color:#1f2328">(</span>inputs<span style="color:#0550ae">=</span>input_item<span style="color:#1f2328">,</span> outputs<span style="color:#0550ae">=</span>vm<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            item_features <span style="color:#0550ae">=</span> item_features_df<span style="color:#0550ae">.</span>iloc<span style="color:#1f2328">[:,</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">:]</span><span style="color:#0550ae">.</span>values 
</span></span><span style="display:flex;"><span>            scaled_features <span style="color:#0550ae">=</span> scalerItem<span style="color:#0550ae">.</span>transform<span style="color:#1f2328">(</span>item_features<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            embeddings <span style="color:#0550ae">=</span> embedding_model<span style="color:#0550ae">.</span>predict<span style="color:#1f2328">(</span>scaled_features<span style="color:#1f2328">,</span> batch_size<span style="color:#0550ae">=</span><span style="color:#0550ae">512</span><span style="color:#1f2328">,</span> verbose<span style="color:#0550ae">=</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>embedding_dim <span style="color:#0550ae">=</span> embeddings<span style="color:#0550ae">.</span>shape<span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            movie_ids <span style="color:#0550ae">=</span> item_features_df<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;movieid&#39;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>values
</span></span><span style="display:flex;"><span>            <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_store_embeddings<span style="color:#1f2328">(</span>movie_ids<span style="color:#1f2328">,</span> embeddings<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">True</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Embedding setup failed: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">False</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_store_embeddings</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> movie_ids<span style="color:#1f2328">,</span> embeddings<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        data <span style="color:#0550ae">=</span> <span style="color:#1f2328">[(</span><span style="color:#6639ba">int</span><span style="color:#1f2328">(</span>mid<span style="color:#1f2328">),</span> <span style="color:#1f2328">[</span><span style="color:#6639ba">float</span><span style="color:#1f2328">(</span>x<span style="color:#1f2328">)</span> <span style="color:#cf222e">for</span> x <span style="color:#0550ae">in</span> emb<span style="color:#1f2328">])</span> 
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">for</span> mid<span style="color:#1f2328">,</span> emb <span style="color:#0550ae">in</span> <span style="color:#6639ba">zip</span><span style="color:#1f2328">(</span>movie_ids<span style="color:#1f2328">,</span> embeddings<span style="color:#1f2328">)]</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">with</span> psycopg2<span style="color:#0550ae">.</span>connect<span style="color:#1f2328">(</span><span style="color:#0550ae">**</span><span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>db_config<span style="color:#1f2328">)</span> <span style="color:#cf222e">as</span> conn<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">with</span> conn<span style="color:#0550ae">.</span>cursor<span style="color:#1f2328">()</span> <span style="color:#cf222e">as</span> cursor<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Storing </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>data<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> embeddings...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                execute_values<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                    cursor<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                    INSERT INTO </span><span style="color:#0a3069">{</span><span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>target_schema<span style="color:#0a3069">}</span><span style="color:#0a3069">.</span><span style="color:#0a3069">{</span><span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>embedding_table<span style="color:#0a3069">}</span><span style="color:#0a3069"> (movieid, embedding)
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                    VALUES %s
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                    ON CONFLICT (movieid) DO UPDATE 
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                    SET embedding = EXCLUDED.embedding;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                    &#34;&#34;&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    data<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    page_size<span style="color:#0550ae">=</span><span style="color:#0550ae">500</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                conn<span style="color:#0550ae">.</span>commit<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Embeddings stored successfully&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">get_similar_movies</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> movie_id<span style="color:#1f2328">,</span> top_n<span style="color:#0550ae">=</span><span style="color:#0550ae">5</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">with</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>engine<span style="color:#0550ae">.</span>connect<span style="color:#1f2328">()</span> <span style="color:#cf222e">as</span> conn<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            result <span style="color:#0550ae">=</span> conn<span style="color:#0550ae">.</span>execute<span style="color:#1f2328">(</span>text<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                SELECT m.movieid, m.title, m.genres, 
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                       e.embedding &lt;-&gt; (SELECT embedding FROM </span><span style="color:#0a3069">{</span><span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>target_schema<span style="color:#0a3069">}</span><span style="color:#0a3069">.</span><span style="color:#0a3069">{</span><span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>embedding_table<span style="color:#0a3069">}</span><span style="color:#0a3069"> 
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                                       WHERE movieid = :movie_id) AS distance
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                FROM </span><span style="color:#0a3069">{</span><span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>target_schema<span style="color:#0a3069">}</span><span style="color:#0a3069">.</span><span style="color:#0a3069">{</span><span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>embedding_table<span style="color:#0a3069">}</span><span style="color:#0a3069"> e
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                JOIN </span><span style="color:#0a3069">{</span><span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>target_schema<span style="color:#0a3069">}</span><span style="color:#0a3069">.movies m ON e.movieid = m.movieid
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                WHERE e.movieid != :movie_id
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                ORDER BY distance ASC
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                LIMIT :top_n;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            &#34;&#34;&#34;</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#39;movie_id&#39;</span><span style="color:#1f2328">:</span> movie_id<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;top_n&#39;</span><span style="color:#1f2328">:</span> top_n<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> result<span style="color:#0550ae">.</span>fetchall<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">get_user_recommendations</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> user_id<span style="color:#1f2328">,</span> top_n<span style="color:#0550ae">=</span><span style="color:#0550ae">10</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">with</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>engine<span style="color:#0550ae">.</span>connect<span style="color:#1f2328">()</span> <span style="color:#cf222e">as</span> conn<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            top_rated <span style="color:#0550ae">=</span> conn<span style="color:#0550ae">.</span>execute<span style="color:#1f2328">(</span>text<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                SELECT movieid FROM </span><span style="color:#0a3069">{</span><span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>target_schema<span style="color:#0a3069">}</span><span style="color:#0a3069">.ratings
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                WHERE userid = :user_id
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                ORDER BY rating DESC
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                LIMIT 3;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            &#34;&#34;&#34;</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#39;user_id&#39;</span><span style="color:#1f2328">:</span> user_id<span style="color:#1f2328">})</span><span style="color:#0550ae">.</span>fetchall<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> top_rated<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>            recommendations <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">for</span> <span style="color:#1f2328">(</span>movie_id<span style="color:#1f2328">,)</span> <span style="color:#0550ae">in</span> top_rated<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                similar <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>get_similar_movies<span style="color:#1f2328">(</span>movie_id<span style="color:#1f2328">,</span> top_n<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                recommendations<span style="color:#0550ae">.</span>extend<span style="color:#1f2328">(</span>similar<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            recs_formatted <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">for</span> rec <span style="color:#0550ae">in</span> recommendations<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                recs_formatted<span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#39;movieid&#39;</span><span style="color:#1f2328">:</span> rec<span style="color:#0550ae">.</span>movieid<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#39;title&#39;</span><span style="color:#1f2328">:</span> rec<span style="color:#0550ae">.</span>title<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#39;genres&#39;</span><span style="color:#1f2328">:</span> rec<span style="color:#0550ae">.</span>genres<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#39;distance&#39;</span><span style="color:#1f2328">:</span> rec<span style="color:#0550ae">.</span>distance
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># Deduplicate by closest distance</span>
</span></span><span style="display:flex;"><span>            unique_recs <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">for</span> rec <span style="color:#0550ae">in</span> recs_formatted<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> rec<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;movieid&#39;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">not</span> <span style="color:#0550ae">in</span> unique_recs <span style="color:#0550ae">or</span> rec<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;distance&#39;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">&lt;</span> unique_recs<span style="color:#1f2328">[</span>rec<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;movieid&#39;</span><span style="color:#1f2328">]][</span><span style="color:#0a3069">&#39;distance&#39;</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>                    unique_recs<span style="color:#1f2328">[</span>rec<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;movieid&#39;</span><span style="color:#1f2328">]]</span> <span style="color:#0550ae">=</span> rec
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#6639ba">sorted</span><span style="color:#1f2328">(</span>unique_recs<span style="color:#0550ae">.</span>values<span style="color:#1f2328">(),</span> key<span style="color:#0550ae">=</span><span style="color:#cf222e">lambda</span> x<span style="color:#1f2328">:</span> x<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;distance&#39;</span><span style="color:#1f2328">])[:</span>top_n<span style="color:#1f2328">]</span>   </span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><p><strong>Example Usage</strong>:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#57606a"># Database configuration</span>
</span></span><span style="display:flex;"><span>db_config <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#39;database&#39;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#39;postgres&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#39;user&#39;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#39;postgres&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#39;password&#39;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#39;W8oMlEyhq9&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#39;host&#39;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#39;postgres-postgresql.postgres&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#39;port&#39;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#39;5432&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Initialize recommender</span>
</span></span><span style="display:flex;"><span>recommender <span style="color:#0550ae">=</span> VectorRecommender<span style="color:#1f2328">(</span>db_config<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Run only once to populate the embeddings</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">if</span> <span style="color:#cf222e">False</span><span style="color:#1f2328">:</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> recommender<span style="color:#0550ae">.</span>setup_embeddings<span style="color:#1f2328">(</span>model<span style="color:#1f2328">,</span> item_features_df<span style="color:#1f2328">,</span> scalerItem<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Failed to setup embeddings&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Get personalized recommendations</span>
</span></span><span style="display:flex;"><span>user_id <span style="color:#0550ae">=</span> <span style="color:#0550ae">2</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">Recommendations for user </span><span style="color:#0a3069">{</span>user_id<span style="color:#0a3069">}</span><span style="color:#0a3069">:&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>recs <span style="color:#0550ae">=</span> recommender<span style="color:#0550ae">.</span>get_user_recommendations<span style="color:#1f2328">(</span>user_id<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">if</span> recs<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> rec <span style="color:#0550ae">in</span> recs<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;- </span><span style="color:#0a3069">{</span>rec<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;title&#39;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> (</span><span style="color:#0a3069">{</span>rec<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;genres&#39;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">) [similarity: </span><span style="color:#0a3069">{</span>rec<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;distance&#39;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">:</span><span style="color:#0a3069">.3f</span><span style="color:#0a3069">}</span><span style="color:#0a3069">]&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;No recommendations found&#34;</span><span style="color:#1f2328">)</span>    </span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>

































 
  
  





  <img src="/images/movies/movies-recommendation-for-existing-user.png"   alt="movies-recommendation-for-existing-user" class="sc-image sc-image-default"
       >


<h3 id="2-finding-similar-items">2. Finding Similar Items</h3>
<p>Once embeddings are stored in PostgreSQL with <code>pgvector</code>, you can quickly find similar items using the &lt;-&gt; operator for cosine distance:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#57606a"># Find similar movies</span>
</span></span><span style="display:flex;"><span>movie_id <span style="color:#0550ae">=</span> <span style="color:#0550ae">1</span>  <span style="color:#57606a"># Toy Story</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">Movies similar to ID </span><span style="color:#0a3069">{</span>movie_id<span style="color:#0a3069">}</span><span style="color:#0a3069">:&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>similar <span style="color:#0550ae">=</span> recommender<span style="color:#0550ae">.</span>get_similar_movies<span style="color:#1f2328">(</span>movie_id<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">if</span> similar<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> movie <span style="color:#0550ae">in</span> similar<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;- </span><span style="color:#0a3069">{</span>movie<span style="color:#0550ae">.</span>title<span style="color:#0a3069">}</span><span style="color:#0a3069"> (</span><span style="color:#0a3069">{</span>movie<span style="color:#0550ae">.</span>genres<span style="color:#0a3069">}</span><span style="color:#0a3069">) [distance: </span><span style="color:#0a3069">{</span>movie<span style="color:#0550ae">.</span>distance<span style="color:#0a3069">:</span><span style="color:#0a3069">.3f</span><span style="color:#0a3069">}</span><span style="color:#0a3069">]&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;No similar movies found&#34;</span><span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>

































 
  
  





  <img src="/images/movies/finding-similar-movies-from-pgvector.png"   alt="finding-similar-movies-from-pgvector" class="sc-image sc-image-default"
       >



    </section>

    <nav class="post-navigation">
      <div class="nav-links">
        
          <div class="nav-previous">
            <a href="/posts/2025/04/from-model-to-hdb-app/" rel="prev">
              <span class="meta-nav">← Previous</span>
              <span class="post-title">From Model to HDB App</span>
            </a>
          </div>
        
        
          <div class="nav-next">
            <a href="/posts/2025/05/deploying-kserve-on-oke/" rel="next">
              <span class="meta-nav">Next →</span>
              <span class="post-title">Deploying KServe on OKE</span>
            </a>
          </div>
        
      </div>
    </nav>

    
<div class="giscus-comments-container">
</div>

<script>
  (function() {
    'use strict';

    const getGiscusTheme = () => {
      const storedTheme = localStorage.getItem('theme'); 
      if (storedTheme) {
        return storedTheme === 'dark-mode' ? 'dark' : 'light';
      }
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };

    const setGiscusFrameTheme = (theme) => {
      const iframe = document.querySelector('iframe.giscus-frame');
      if (iframe && iframe.contentWindow) {
        iframe.contentWindow.postMessage({ giscus: { setConfig: { theme: theme } } }, 'https://giscus.app');
      }
    };

    const loadGiscus = () => {
      const giscusContainer = document.querySelector('.giscus-comments-container');
      if (!giscusContainer) {
        console.warn('Giscus container not found.');
        return;
      }

      while (giscusContainer.firstChild) {
        giscusContainer.removeChild(giscusContainer.firstChild);
      }

      const giscusScript = document.createElement('script');
      const giscusAttributes = {
        "src": "https://giscus.app/client.js",
        "data-repo":             "seehiong\/seehiong.github.io",
        "data-repo-id":          "R_kgDOJg7Puw",
        "data-category":         "General",
        "data-category-id":      "DIC_kwDOJg7Pu84Cbyhc",
        "data-mapping":          "url", 
        "data-strict":           "0",
        "data-reactions-enabled":"1",
        "data-emit-metadata":    "0",
        "data-input-position":   "top", 
        "data-theme":            getGiscusTheme(), 
        "data-lang":             "en",
        "data-loading":          "lazy",
        "crossorigin":           "anonymous",
        "async":                 "true", 
      };

      if (!giscusAttributes["data-repo"] || !giscusAttributes["data-repo-id"] || !giscusAttributes["data-category-id"]) {
          console.error("Giscus parameters (giscusRepo, giscusRepoId, giscusCategoryId) are not configured in hugo.toml.");
          giscusContainer.innerHTML = "<p style='color: var(--text-secondary);'>Giscus comments are not configured correctly. Please check site parameters.</p>";
          return;
      }

      Object.entries(giscusAttributes).forEach(
        ([key, value]) => giscusScript.setAttribute(key, value)
      );
      giscusContainer.appendChild(giscusScript);
    };

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadGiscus);
    } else {
        loadGiscus();
    }

    const htmlElement = document.documentElement;
    const observer = new MutationObserver((mutationsList) => {
      for (const mutation of mutationsList) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          setGiscusFrameTheme(getGiscusTheme());
        }
      }
    });
    observer.observe(htmlElement, { attributes: true });

  })();
</script>


  </article>
</div>
</main>
    </div>

    
    <div id="search-modal-overlay" class="search-modal-overlay" style="display: none;">
      <div id="search-modal-content" class="search-modal-content">
        <button id="search-modal-close" class="search-modal-close" aria-label="Close search" title="Close search">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </button>
        <input type="search" id="modal-search-input" class="modal-search-input" placeholder="Search content..." aria-label="Search input">
        <div id="modal-search-results" class="modal-search-results">
        </div>
      </div>
    </div>
    

  <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js" defer></script>
  <script>
    (function() {
      'use strict';

      window.addEventListener('DOMContentLoaded', () => {
        const searchModalOverlay = document.getElementById('search-modal-overlay');
        const searchModalContent = document.getElementById('search-modal-content');
        const searchModalCloseButton = document.getElementById('search-modal-close');
        const searchToggleButton = document.getElementById('nav-search-toggle');
        const searchInputTarget = document.getElementById('modal-search-input');
        const searchResultsTarget = document.getElementById('modal-search-results');

        let fuseInstance = null;
        let searchData = [];

        const loadSearchData = async () => {
          if (searchData.length === 0 && !fuseInstance) {
            try {
              const response = await fetch('\/index.json');
              if (!response.ok) {
                throw new Error(`HTTP error loading index.json! status: ${response.status}`);
              }
              searchData = await response.json();
              initializeFuse();
            } catch (e) {
              console.error("[SearchSetup] Error loading search data:", e);
              if (searchResultsTarget) searchResultsTarget.innerHTML = "<p>Error loading search index.</p>";
            }
          } else if (searchData.length > 0 && !fuseInstance){
            initializeFuse();
          }
        };

        const initializeFuse = () => {
          if (searchData.length > 0 && !fuseInstance) {
            const options = {
              keys: [
                { name: 'title', weight: 0.7 }, { name: 'summary', weight: 0.5 },
                { name: 'content', weight: 0.3 }, { name: 'tags', weight: 0.4 }
              ],
              includeScore: true, threshold: 0.4, minMatchCharLength: 2,
            };
            fuseInstance = new Fuse(searchData, options);
          }
        };

        const performSearch = () => {
          if (!fuseInstance || !searchInputTarget || !searchResultsTarget) return;
          const query = searchInputTarget.value.trim();
          searchResultsTarget.innerHTML = '';
          if (query.length < 2) return;

          const results = fuseInstance.search(query);
          if (results.length > 0) {
            const ul = document.createElement('ul');
            ul.className = 'search-results-list';
            results.slice(0, 10).forEach(result => {
              const item = result.item;
              const li = document.createElement('li');
              li.className = 'search-result-item';
              const a = document.createElement('a');
              a.href = item.permalink;
              a.textContent = item.title;
              li.appendChild(a);
              ul.appendChild(li);
            });
            searchResultsTarget.appendChild(ul);
          } else {
            searchResultsTarget.innerHTML = '<p>No results found.</p>';
          }
        };

        const openSearchModal = async () => {
          await loadSearchData();
          if (searchInputTarget) searchInputTarget.value = '';
          if (searchResultsTarget) searchResultsTarget.innerHTML = '';

          if (searchModalOverlay) {
            searchModalOverlay.style.display = 'flex';
            setTimeout(() => searchModalOverlay.classList.add('active'), 10);
          } else { return; }

          if (searchInputTarget) setTimeout(() => searchInputTarget.focus(), 50);
          if (searchToggleButton) searchToggleButton.classList.add('active');
        };

        const closeSearchModal = () => {
          if (searchModalOverlay) {
            searchModalOverlay.classList.remove('active');
            setTimeout(() => searchModalOverlay.style.display = 'none', 300);
          }
          if (searchToggleButton) searchToggleButton.classList.remove('active');
        };

        if (searchToggleButton) {
          searchToggleButton.addEventListener('click', (e) => {
            e.stopPropagation();
            if (searchModalOverlay && searchModalOverlay.classList.contains('active')) {
              closeSearchModal();
            } else {
              openSearchModal();
            }
          });
        } else { console.error("[SearchSetup] #nav-search-toggle button not found."); }

        if (searchModalCloseButton) { searchModalCloseButton.addEventListener('click', closeSearchModal); }
        if (searchModalOverlay && searchModalContent) {
          searchModalOverlay.addEventListener('click', (event) => {
            if (event.target === searchModalOverlay) closeSearchModal();
          });
        }
        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && searchModalOverlay && searchModalOverlay.classList.contains('active')) {
            closeSearchModal();
          }
        });
        if (searchInputTarget) {
          let debounceTimer;
          searchInputTarget.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(performSearch, 300);
          });
        }
      });
    })();
  </script>

    

    

  <script>
    MathJax = {
      tex: {
        displayMath: [['\\[', '\\]'], ['$$', '$$']], 
        inlineMath: [['\\(', '\\)']], 
        processEscapes: true,
        processEnvironments: true,
        tags: 'ams' 
      },
      svg: {
        fontCache: 'global' 
      },
      chtml: {
        fontURL: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2'
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'], 
        ignoreHtmlClass: 'tex2jax_ignore', 
        processHtmlClass: 'tex2jax_process'
      }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<footer class="footer-main simplified-footer">
  <div class="content-body footer-wraper">
    <div class="footer-box">
      <div class="footer-content">
        <div class="copyright-line">
          Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> © 2025 See Hiong. All rights reserved.
        </div>
        <div class="social-links">
          
            <a href="https://github.com/seehiong" target="_blank" title="GitHub" class="social-link" aria-label="GitHub">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
            </a>
          
          
            <a href="https://www.linkedin.com/in/seehiong/" target="_blank" title="LinkedIn" class="social-link" aria-label="LinkedIn">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
            </a>
          
          
            <a href="/index.xml" target="_blank" title="RSS" class="social-link" aria-label="RSS Feed">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg>
            </a>
          
        </div>
      </div>
    </div>
  </div>
</footer>
        <script src="/js/animation.js" defer></script>
    
        <script src="/js/code-copy.js" defer></script>
    
        <script src="/js/scroll-header.js" defer></script>
       
  </body>
</html>