<!DOCTYPE html>
<html lang="en">
  <head><head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <link rel="icon" href="/images/favicon.ico">
    

    <meta property="og:url" content="https://seehiong.github.io/posts/2025/09/ai-driven-3d-workflows-with-n8n/">
  <meta property="og:site_name" content="See Hiong&#39;s Blog">
  <meta property="og:title" content="AI-Driven 3D Workflows with n8n">
  <meta property="og:description" content="This post explores how to integrate n8n, OpenRouter, and Blender MCP to create AI-driven 3D modeling workflows. Starting with an AI agent chat in n8n, I bridge prompts to Blender using a custom server, generating a condominium prototype complete with materials, landscaping, and cinematic lighting. Along the way, I highlight practical challenges—like material tuning and lighting setup—and show how automation and AI make complex 3D tasks conversational and modular. The result is a workflow that moves closer to a no-code, AI-powered approach to 3D design.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-09-21T20:00:00+08:00">
    <meta property="article:modified_time" content="2025-09-21T20:00:00+08:00">
    <meta property="article:tag" content="N8n">
    <meta property="article:tag" content="MCP">
    <meta property="article:tag" content="Blender">
    <meta property="article:tag" content="AI">
    <meta property="article:tag" content="3D">
    <meta property="article:tag" content="OpenRouter">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="AI-Driven 3D Workflows with n8n">
  <meta name="twitter:description" content="This post explores how to integrate n8n, OpenRouter, and Blender MCP to create AI-driven 3D modeling workflows. Starting with an AI agent chat in n8n, I bridge prompts to Blender using a custom server, generating a condominium prototype complete with materials, landscaping, and cinematic lighting. Along the way, I highlight practical challenges—like material tuning and lighting setup—and show how automation and AI make complex 3D tasks conversational and modular. The result is a workflow that moves closer to a no-code, AI-powered approach to 3D design.">

  <meta itemprop="name" content="AI-Driven 3D Workflows with n8n">
  <meta itemprop="description" content="This post explores how to integrate n8n, OpenRouter, and Blender MCP to create AI-driven 3D modeling workflows. Starting with an AI agent chat in n8n, I bridge prompts to Blender using a custom server, generating a condominium prototype complete with materials, landscaping, and cinematic lighting. Along the way, I highlight practical challenges—like material tuning and lighting setup—and show how automation and AI make complex 3D tasks conversational and modular. The result is a workflow that moves closer to a no-code, AI-powered approach to 3D design.">
  <meta itemprop="datePublished" content="2025-09-21T20:00:00+08:00">
  <meta itemprop="dateModified" content="2025-09-21T20:00:00+08:00">
  <meta itemprop="wordCount" content="3147">
  <meta itemprop="keywords" content="N8n,MCP,Blender,AI,3D,OpenRouter,Automation"><title>AI-Driven 3D Workflows with n8n | See Hiong&#39;s Blog</title>

    <link rel="canonical" href="https://seehiong.github.io/posts/2025/09/ai-driven-3d-workflows-with-n8n/">

    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    
      
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-5PNPM4HWQ0"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-5PNPM4HWQ0');
        }
      </script>
    
    <link rel="stylesheet" href="/css/variables.css">
    
    <link rel="stylesheet" href="/css/base.css">
    
    <link rel="stylesheet" href="/css/layout.css">
    
    <link rel="stylesheet" href="/css/header.css">
    
    <link rel="stylesheet" href="/css/header.css">
    
    <link rel="stylesheet" href="/css/cards.css">
    
    <link rel="stylesheet" href="/css/content_elements.css">
    
    <link rel="stylesheet" href="/css/codeblocks.css">
    
    <link rel="stylesheet" href="/css/page_specific.css">
    
    <link rel="stylesheet" href="/css/shortcodes.css">
    
    <link rel="stylesheet" href="/css/components.css">
    
    <link rel="stylesheet" href="/css/animations.css">
    
    <link rel="stylesheet" href="/css/media_queries.css">
    
    <link rel="stylesheet" href="/css/quantum-theme.css">
    

    
    <script>
      (function() {
        var theme = localStorage.getItem('theme');
        var H = document.documentElement;
        if (theme === 'dark-mode') {
          H.classList.add('dark-mode');
        } else if (theme === 'light-mode') {
          H.classList.remove('dark-mode');
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
          H.classList.add('dark-mode');
        }
      })();
    </script>
</head></head>
  <body class="page-article"><nav class="nav">
  <div class="nav-wrapper">
    <div class="nav-content-wrapper">
      <div class="nav-content">
        <a href="/" class="nav-logo-link" title="See Hiong&#39;s Blog - Home">
          <span class="nav-site-title">
            <span class="nav-site-title__main">SEE HIONG’S</span>
            <span class="nav-site-title__sub">BLOG</span>
          </span>
        </a>
        <div class="nav-menu">
          <div class="nav-item-wrapper">
            
            
            <a href="/posts/" class="nav-item-content active">Archives</a>
            
          </div>
          
          
          <div class="nav-item-wrapper">
            <a href="/tags/" class="nav-item-content ">Tags</a>
          </div>
          <div class="nav-item-wrapper">
            <a href="/about/" class="nav-item-content ">About</a>
          </div>
          <div class="nav-item-wrapper nav-search-toggle-wrapper">
            <button id="nav-search-toggle" class="nav-item-button" aria-label="Toggle search" title="Search">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor" class="nav-item-icon">
                <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5A6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
              </svg>
            </button>
          </div>
          
          
          <button id="theme-toggle" class="nav-item-button" aria-label="Toggle theme"></button> 
        </div>
      </div>
    </div>
  </div>
</nav>


<script>
  document.addEventListener('DOMContentLoaded', function () {
    const themeToggle = document.getElementById('theme-toggle');
    const H = document.documentElement; 

    if (H.classList.contains('dark-mode')) {
      themeToggle.textContent = 'Light Mode';
    } else {
      themeToggle.textContent = 'Dark Mode';
    }

    themeToggle.addEventListener('click', function() {
      H.classList.toggle('dark-mode');
      if (H.classList.contains('dark-mode')) {
        localStorage.setItem('theme', 'dark-mode');
        themeToggle.textContent = 'Light Mode';
      } else {
        localStorage.setItem('theme', 'light-mode');
        themeToggle.textContent = 'Dark Mode';
      }
    });
  });
</script><div id="content-wrapper">
        <main class="container" id="main-content">
<div class="main-content-area">
  <article class="post-layout container">

    <header class="post-header">
      <h1 class="post-title">AI-Driven 3D Workflows with n8n</h1>

      <div class="post-meta">
        <span class="post-meta__date">
          <time datetime="2025-09-21T20:00:00&#43;08:00">September 21, 2025</time>
        </span>

        
          <span class="post-meta__author">Written by See Hiong</span>
        

        
          <span class="post-meta__tags">
            In:
            
              <a href="/tags/n8n">n8n</a>
            
              , <a href="/tags/mcp">MCP</a>
            
              , <a href="/tags/blender">Blender</a>
            
              , <a href="/tags/ai">AI</a>
            
              , <a href="/tags/3d">3D</a>
            
              , <a href="/tags/openrouter">OpenRouter</a>
            
              , <a href="/tags/automation">Automation</a>
            
          </span>
        

        
      </div>
    </header>

    
      
      
      <div class="post-cover-container post-cover--artistic-blur-wrapper">
        
          <div class="post-cover-blur-background" style="--bg-image: url('/images/blender-n8n/ai-driven-3d-workflows-with-n8n.png');"></div>
          <img src="/images/blender-n8n/ai-driven-3d-workflows-with-n8n.png" alt="AI-Driven 3D Workflows with n8n cover image" class="post-cover-image post-cover-image--artistic-blur">
        
      </div>
    

    <section class="post-content">
      <hr>
<p>Building upon my 






  <a href="/posts/2025/09/blender-meets-mcp/" >previous post</a>
, this time I’ll demonstrate how to connect <strong>n8n</strong> with Blender via <strong>MCP</strong>. By combining n8n’s automation capabilities with Blender’s modeling power, we can drive 3D creation workflows with natural language and AI agents.</p>
<h2 id="updating-to-the-latest-n8n-image">Updating to the Latest n8n Image</h2>
<p>As mentioned in 






  <a href="/posts/2025/07/automating-workflows-with-n8n/" >Automating Workflows with n8n</a>
, I’m updating to the latest n8n image and configuring a runner as a sidecar. 






  <a href="https://docs.n8n.io/hosting/configuration/task-runners/" target="_blank" rel="noopener noreferrer" >Task runners</a>
 provide a secure and performant mechanism to execute tasks.</p>
<p>Here’s my deployment configuration:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#57606a"># n8n-deployment.yaml</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">apiVersion</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>apps/v1<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">kind</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Deployment<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">metadata</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">labels</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">io.kompose.service</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>n8n<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>n8n<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">namespace</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>n8n<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">spec</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">replicas</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">selector</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">matchLabels</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">io.kompose.service</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>n8n<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">strategy</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">type</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Recreate<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">template</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">metadata</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">labels</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">io.kompose.service</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>n8n <span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">spec</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">containers</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#57606a"># Main n8n container</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>- <span style="color:#0550ae">env</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>DB_POSTGRESDB_HOST<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">              </span><span style="color:#0550ae">value</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>postgres<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>DB_POSTGRESDB_PASSWORD<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">              </span><span style="color:#0550ae">value</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>postgres<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>DB_POSTGRESDB_USER<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">              </span><span style="color:#0550ae">value</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>postgres<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>DB_TYPE<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">              </span><span style="color:#0550ae">value</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>postgresdb<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>N8N_DIAGNOSTICS_ENABLED<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">              </span><span style="color:#0550ae">value</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;false&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>N8N_PERSONALIZATION_ENABLED<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">              </span><span style="color:#0550ae">value</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;false&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>OLLAMA_HOST<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">              </span><span style="color:#0550ae">value</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>ollama:11434<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#57606a"># Task runner configuration</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>N8N_RUNNERS_ENABLED<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">              </span><span style="color:#0550ae">value</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;true&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>N8N_RUNNERS_MODE<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">              </span><span style="color:#0550ae">value</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>external<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>N8N_RUNNERS_BROKER_LISTEN_ADDRESS<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">              </span><span style="color:#0550ae">value</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0550ae">0.0.0.0</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>N8N_RUNNERS_AUTH_TOKEN<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">              </span><span style="color:#0550ae">value</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>my-n8n-runners-secure-token<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>N8N_NATIVE_PYTHON_RUNNER<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">              </span><span style="color:#0550ae">value</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;true&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">          </span><span style="color:#0550ae">envFrom</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>- <span style="color:#0550ae">configMapRef</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>env<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">          </span><span style="color:#0550ae">image</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>n8nio/n8n:1.111.0<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">          </span><span style="color:#0550ae">imagePullPolicy</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Always<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">          </span><span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>n8n<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">          </span><span style="color:#0550ae">ports</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>- <span style="color:#0550ae">containerPort</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0550ae">5678</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">              </span><span style="color:#0550ae">protocol</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>TCP<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>- <span style="color:#0550ae">containerPort</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0550ae">5679</span><span style="color:#fff">  </span><span style="color:#57606a"># Task runner broker port</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">              </span><span style="color:#0550ae">protocol</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>TCP<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">          </span><span style="color:#0550ae">volumeMounts</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>- <span style="color:#0550ae">mountPath</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>/home/node/.n8n<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">              </span><span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>n8n-storage<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>- <span style="color:#0550ae">mountPath</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>/data/shared<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">              </span><span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>n8n-claim2<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>- <span style="color:#0550ae">mountPath</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>/demo-data<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">              </span><span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>demo-data<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">              
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#57606a"># Task runners container</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>- <span style="color:#0550ae">env</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>N8N_RUNNERS_TASK_BROKER_URI<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">              </span><span style="color:#0550ae">value</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>http://localhost:5679<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>N8N_RUNNERS_AUTH_TOKEN<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">              </span><span style="color:#0550ae">value</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>my-n8n-runners-secure-token<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>N8N_RUNNERS_AUTO_SHUTDOWN_TIMEOUT<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">              </span><span style="color:#0550ae">value</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;15&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">          </span><span style="color:#0550ae">image</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>n8nio/runners:1.111.0<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">          </span><span style="color:#0550ae">imagePullPolicy</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Always<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">          </span><span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>n8n-runners<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">          </span><span style="color:#0550ae">volumeMounts</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>- <span style="color:#0550ae">mountPath</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>/data/shared<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">              </span><span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>n8n-claim2<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">hostname</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>n8n<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">restartPolicy</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Always<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">volumes</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>n8n-storage<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">          </span><span style="color:#0550ae">persistentVolumeClaim</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#0550ae">claimName</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>n8n-storage<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>n8n-claim2<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">          </span><span style="color:#0550ae">persistentVolumeClaim</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#0550ae">claimName</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>n8n-claim2<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>demo-data<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">          </span><span style="color:#0550ae">persistentVolumeClaim</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#0550ae">claimName</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>demo-data-pvc</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><p>Deploy with:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f n8n-deployment.yaml
</span></span><span style="display:flex;"><span>kubectl rollout restart deployment n8n</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h2 id="ai-agent-chat-workflow">AI Agent Chat Workflow</h2>
<p>To start, let’s build a simple chat workflow following the 






  <a href="https://n8n.io/workflows/1954-ai-agent-chat" target="_blank" rel="noopener noreferrer" >AI Agent Chat template</a>
. I added the following nodes:</p>
<ul>
<li>






  <a href="https://docs.n8n.io/integrations/builtin/core-nodes/n8n-nodes-langchain.chattrigger/" target="_blank" rel="noopener noreferrer" >Chat Trigger</a>
</li>
<li>






  <a href="https://docs.n8n.io/integrations/builtin/cluster-nodes/root-nodes/n8n-nodes-langchain.agent/" target="_blank" rel="noopener noreferrer" >AI Agent</a>
</li>
<li>






  <a href="https://docs.n8n.io/integrations/builtin/cluster-nodes/sub-nodes/n8n-nodes-langchain.lmchatopenrouter" target="_blank" rel="noopener noreferrer" >OpenRouter Chat Model</a>
</li>
<li>






  <a href="https://docs.n8n.io/integrations/builtin/cluster-nodes/sub-nodes/n8n-nodes-langchain.toolwikipedia" target="_blank" rel="noopener noreferrer" >Wikipedia</a>
</li>
</ul>
<p>When I tested with:</p>
<ol>
<li>My name is seehiong</li>
<li>Where is Singapore</li>
<li>Whats my name</li>
</ol>
<p>…the chat model responded, but it didn’t retain my name.</p>
<p>Adding a 






  <a href="https://docs.n8n.io/integrations/builtin/cluster-nodes/sub-nodes/n8n-nodes-langchain.memorybufferwindow" target="_blank" rel="noopener noreferrer" >Simple Memory node</a>
, fixed this—allowing the agent to recall previous messages.</p>


































 
  
  





  <img src="/images/blender-n8n/blender-n8n-ai-agent-chat.png"   alt="blender-n8n-ai-agent-chat" class="sc-image sc-image-default"
       >


<h2 id="preparing-the-blender-bridge-server">Preparing the Blender Bridge Server</h2>
<p>The next step was bridging the AI agent to Blender’s MCP tool. While ideally we’d run <code>uvx blender-mcp</code> directly inside n8n, that would require a custom node. For now, I created a lightweight wrapper service: <code>blender-bridge-server.py</code>.</p>
<p>This service acts as a Fast HTTP-to-MCP bridge, using:</p>
<ul>
<li>Persistent connection pooling for low latency</li>
<li>Structured chat processing with OpenRouter models</li>
<li>Tool invocation (scene info, object info, code execution)</li>
</ul>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#57606a"># blender-bridge-server.py</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Fast HTTP-to-MCP Bridge Service for Blender
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Uses persistent connections for speed matching original raw TCP client
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">flask</span> <span style="color:#cf222e">import</span> Flask<span style="color:#1f2328">,</span> request<span style="color:#1f2328">,</span> jsonify
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">asyncio</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">os</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">json</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">threading</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">time</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">uuid</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">datetime</span> <span style="color:#cf222e">import</span> datetime<span style="color:#1f2328">,</span> timedelta
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">typing</span> <span style="color:#cf222e">import</span> Dict<span style="color:#1f2328">,</span> List<span style="color:#1f2328">,</span> Optional<span style="color:#1f2328">,</span> Any
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">dataclasses</span> <span style="color:#cf222e">import</span> dataclass
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">logging</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">openai</span> <span style="color:#cf222e">import</span> OpenAI
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">dotenv</span> <span style="color:#cf222e">import</span> load_dotenv
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">queue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>load_dotenv<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#0550ae">@dataclass</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">class</span> <span style="color:#1f2328">Config</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    model<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span> <span style="color:#0550ae">=</span> os<span style="color:#0550ae">.</span>getenv<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;MODEL&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;openrouter/anthropic/claude-3-sonnet&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    blender_host<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span> <span style="color:#0550ae">=</span> os<span style="color:#0550ae">.</span>getenv<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;BLENDER_HOST&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;127.0.0.1&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    blender_port<span style="color:#1f2328">:</span> <span style="color:#6639ba">int</span> <span style="color:#0550ae">=</span> <span style="color:#6639ba">int</span><span style="color:#1f2328">(</span>os<span style="color:#0550ae">.</span>getenv<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;BLENDER_PORT&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">9876</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>    openrouter_api_key<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span> <span style="color:#0550ae">=</span> os<span style="color:#0550ae">.</span>getenv<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;OPENROUTER_API_KEY&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    max_messages<span style="color:#1f2328">:</span> <span style="color:#6639ba">int</span> <span style="color:#0550ae">=</span> <span style="color:#0550ae">30</span>
</span></span><span style="display:flex;"><span>    session_timeout<span style="color:#1f2328">:</span> <span style="color:#6639ba">int</span> <span style="color:#0550ae">=</span> <span style="color:#0550ae">1800</span>
</span></span><span style="display:flex;"><span>    temperature<span style="color:#1f2328">:</span> <span style="color:#6639ba">float</span> <span style="color:#0550ae">=</span> <span style="color:#0550ae">0.0</span>
</span></span><span style="display:flex;"><span>    seed<span style="color:#1f2328">:</span> <span style="color:#6639ba">int</span> <span style="color:#0550ae">=</span> <span style="color:#0550ae">42</span>
</span></span><span style="display:flex;"><span>    max_connections<span style="color:#1f2328">:</span> <span style="color:#6639ba">int</span> <span style="color:#0550ae">=</span> <span style="color:#0550ae">20</span>  <span style="color:#57606a"># Connection pool size</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>config <span style="color:#0550ae">=</span> Config<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Logging setup</span>
</span></span><span style="display:flex;"><span>logging<span style="color:#0550ae">.</span>basicConfig<span style="color:#1f2328">(</span>level<span style="color:#0550ae">=</span>logging<span style="color:#0550ae">.</span>INFO<span style="color:#1f2328">,</span> <span style="color:#6639ba">format</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;</span><span style="color:#0a3069">%(asctime)s</span><span style="color:#0a3069"> - </span><span style="color:#0a3069">%(levelname)s</span><span style="color:#0a3069"> - </span><span style="color:#0a3069">%(message)s</span><span style="color:#0a3069">&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>logger <span style="color:#0550ae">=</span> logging<span style="color:#0550ae">.</span>getLogger<span style="color:#1f2328">(</span><span style="color:#953800">__name__</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">class</span> <span style="color:#1f2328">PersistentMCPConnection</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;Single persistent connection to Blender MCP&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">__init__</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> connection_id<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>id <span style="color:#0550ae">=</span> connection_id
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>reader<span style="color:#1f2328">:</span> Optional<span style="color:#1f2328">[</span>asyncio<span style="color:#0550ae">.</span>StreamReader<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>writer<span style="color:#1f2328">:</span> Optional<span style="color:#1f2328">[</span>asyncio<span style="color:#0550ae">.</span>StreamWriter<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>connected <span style="color:#0550ae">=</span> <span style="color:#cf222e">False</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>last_used <span style="color:#0550ae">=</span> time<span style="color:#0550ae">.</span>time<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>use_count <span style="color:#0550ae">=</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_lock <span style="color:#0550ae">=</span> asyncio<span style="color:#0550ae">.</span>Lock<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">connect</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;Connect to Blender MCP server&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>reader<span style="color:#1f2328">,</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>writer <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> asyncio<span style="color:#0550ae">.</span>wait_for<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                asyncio<span style="color:#0550ae">.</span>open_connection<span style="color:#1f2328">(</span>config<span style="color:#0550ae">.</span>blender_host<span style="color:#1f2328">,</span> config<span style="color:#0550ae">.</span>blender_port<span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>                timeout<span style="color:#0550ae">=</span><span style="color:#0550ae">5</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>connected <span style="color:#0550ae">=</span> <span style="color:#cf222e">True</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>last_used <span style="color:#0550ae">=</span> time<span style="color:#0550ae">.</span>time<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Connection </span><span style="color:#0a3069">{</span><span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>id<span style="color:#0a3069">}</span><span style="color:#0a3069"> established to Blender MCP&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>connected <span style="color:#0550ae">=</span> <span style="color:#cf222e">False</span>
</span></span><span style="display:flex;"><span>            logger<span style="color:#0550ae">.</span>error<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Connection </span><span style="color:#0a3069">{</span><span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>id<span style="color:#0a3069">}</span><span style="color:#0a3069"> failed: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">raise</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">send_command</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> command<span style="color:#1f2328">:</span> <span style="color:#6639ba">dict</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#6639ba">dict</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;Send command using persistent connection&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">async</span> <span style="color:#cf222e">with</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_lock<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>connected<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">await</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>connect<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># Send command</span>
</span></span><span style="display:flex;"><span>                command_json <span style="color:#0550ae">=</span> json<span style="color:#0550ae">.</span>dumps<span style="color:#1f2328">(</span>command<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>writer<span style="color:#0550ae">.</span>write<span style="color:#1f2328">(</span>command_json<span style="color:#0550ae">.</span>encode<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;utf-8&#39;</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">await</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>writer<span style="color:#0550ae">.</span>drain<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># Read response</span>
</span></span><span style="display:flex;"><span>                response_data <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> asyncio<span style="color:#0550ae">.</span>wait_for<span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>reader<span style="color:#0550ae">.</span>read<span style="color:#1f2328">(</span><span style="color:#0550ae">8192</span><span style="color:#1f2328">),</span> timeout<span style="color:#0550ae">=</span><span style="color:#0550ae">10</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> response_data<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">raise</span> ConnectionError<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Empty response&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                response <span style="color:#0550ae">=</span> json<span style="color:#0550ae">.</span>loads<span style="color:#1f2328">(</span>response_data<span style="color:#0550ae">.</span>decode<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;utf-8&#39;</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>last_used <span style="color:#0550ae">=</span> time<span style="color:#0550ae">.</span>time<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>use_count <span style="color:#0550ae">+=</span> <span style="color:#0550ae">1</span>
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># Handle error responses</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> response<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;status&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;error&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">raise</span> RuntimeError<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Blender error: </span><span style="color:#0a3069">{</span>response<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;message&#39;</span><span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> response<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;result&#34;</span><span style="color:#1f2328">,</span> response<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>connected <span style="color:#0550ae">=</span> <span style="color:#cf222e">False</span>
</span></span><span style="display:flex;"><span>                logger<span style="color:#0550ae">.</span>error<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Connection </span><span style="color:#0a3069">{</span><span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>id<span style="color:#0a3069">}</span><span style="color:#0a3069"> command failed: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">raise</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">close</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;Close connection&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>writer <span style="color:#0550ae">and</span> <span style="color:#0550ae">not</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>writer<span style="color:#0550ae">.</span>is_closing<span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>writer<span style="color:#0550ae">.</span>close<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">await</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>writer<span style="color:#0550ae">.</span>wait_closed<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>connected <span style="color:#0550ae">=</span> <span style="color:#cf222e">False</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">is_healthy</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#6639ba">bool</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;Check if connection is healthy&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>connected <span style="color:#0550ae">and</span> time<span style="color:#0550ae">.</span>time<span style="color:#1f2328">()</span> <span style="color:#0550ae">-</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>last_used <span style="color:#0550ae">&lt;</span> <span style="color:#0550ae">300</span>  <span style="color:#57606a"># 5 min timeout</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">class</span> <span style="color:#1f2328">FastConnectionPool</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;Fast connection pool for Blender MCP connections&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">__init__</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>connections<span style="color:#1f2328">:</span> List<span style="color:#1f2328">[</span>PersistentMCPConnection<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>available <span style="color:#0550ae">=</span> queue<span style="color:#0550ae">.</span>Queue<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>lock <span style="color:#0550ae">=</span> threading<span style="color:#0550ae">.</span>Lock<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_initialize_pool<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_initialize_pool</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;Pre-create connections for speed&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> i <span style="color:#0550ae">in</span> <span style="color:#6639ba">range</span><span style="color:#1f2328">(</span>config<span style="color:#0550ae">.</span>max_connections<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            conn <span style="color:#0550ae">=</span> PersistentMCPConnection<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;conn_</span><span style="color:#0a3069">{</span>i<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>connections<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>conn<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>available<span style="color:#0550ae">.</span>put<span style="color:#1f2328">(</span>conn<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">get_connection</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> PersistentMCPConnection<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;Get a connection from pool&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># Try to get an available connection quickly</span>
</span></span><span style="display:flex;"><span>            conn <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>available<span style="color:#0550ae">.</span>get_nowait<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> conn<span style="color:#0550ae">.</span>is_healthy<span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> conn
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># Reconnect if needed</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">await</span> conn<span style="color:#0550ae">.</span>connect<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">return</span> conn
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">except</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">pass</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span> queue<span style="color:#0550ae">.</span>Empty<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">pass</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># If no connections available, wait briefly</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            conn <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>available<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span>timeout<span style="color:#0550ae">=</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> conn<span style="color:#0550ae">.</span>is_healthy<span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">await</span> conn<span style="color:#0550ae">.</span>connect<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> conn
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span> queue<span style="color:#0550ae">.</span>Empty<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">raise</span> RuntimeError<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;No connections available&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">return_connection</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> conn<span style="color:#1f2328">:</span> PersistentMCPConnection<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;Return connection to pool&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> conn<span style="color:#0550ae">.</span>is_healthy<span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>available<span style="color:#0550ae">.</span>put_nowait<span style="color:#1f2328">(</span>conn<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">except</span> queue<span style="color:#0550ae">.</span>Full<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">pass</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">close_all</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;Close all connections&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> conn <span style="color:#0550ae">in</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>connections<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">await</span> conn<span style="color:#0550ae">.</span>close<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">class</span> <span style="color:#1f2328">FastAsyncManager</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;Simplified async manager&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">__init__</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>loop <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>thread <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">start</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>loop <span style="color:#0550ae">is</span> <span style="color:#0550ae">not</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">def</span> <span style="color:#6639ba">run_loop</span><span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>loop <span style="color:#0550ae">=</span> asyncio<span style="color:#0550ae">.</span>new_event_loop<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            asyncio<span style="color:#0550ae">.</span>set_event_loop<span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>loop<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>loop<span style="color:#0550ae">.</span>run_forever<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>thread <span style="color:#0550ae">=</span> threading<span style="color:#0550ae">.</span>Thread<span style="color:#1f2328">(</span>target<span style="color:#0550ae">=</span>run_loop<span style="color:#1f2328">,</span> daemon<span style="color:#0550ae">=</span><span style="color:#cf222e">True</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>thread<span style="color:#0550ae">.</span>start<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">while</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>loop <span style="color:#0550ae">is</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            time<span style="color:#0550ae">.</span>sleep<span style="color:#1f2328">(</span><span style="color:#0550ae">0.01</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">run_coro</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> coro<span style="color:#1f2328">,</span> timeout<span style="color:#0550ae">=</span><span style="color:#0550ae">30</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        future <span style="color:#0550ae">=</span> asyncio<span style="color:#0550ae">.</span>run_coroutine_threadsafe<span style="color:#1f2328">(</span>coro<span style="color:#1f2328">,</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>loop<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> future<span style="color:#0550ae">.</span>result<span style="color:#1f2328">(</span>timeout<span style="color:#0550ae">=</span>timeout<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">class</span> <span style="color:#1f2328">FastBlenderService</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;Fast service using connection pool&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">__init__</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>connection_pool <span style="color:#0550ae">=</span> FastConnectionPool<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>sessions<span style="color:#1f2328">:</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> List<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>  <span style="color:#57606a"># Simple message storage</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>session_lock <span style="color:#0550ae">=</span> threading<span style="color:#0550ae">.</span>Lock<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># OpenAI client</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>openai <span style="color:#0550ae">=</span> OpenAI<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>            base_url<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;https://openrouter.ai/api/v1&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            api_key<span style="color:#0550ae">=</span>config<span style="color:#0550ae">.</span>openrouter_api_key
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Cache tools</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>tools_cache <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>tools_cache_time <span style="color:#0550ae">=</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">call_mcp_tool</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> tool_name<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> tool_args<span style="color:#1f2328">:</span> <span style="color:#6639ba">dict</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> Any<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;Fast MCP tool call using connection pool&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        conn <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>connection_pool<span style="color:#0550ae">.</span>get_connection<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            command <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> tool_name<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;params&#34;</span><span style="color:#1f2328">:</span> tool_args<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            result <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> conn<span style="color:#0550ae">.</span>send_command<span style="color:#1f2328">(</span>command<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>connection_pool<span style="color:#0550ae">.</span>return_connection<span style="color:#1f2328">(</span>conn<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> result
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            logger<span style="color:#0550ae">.</span>error<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;MCP tool </span><span style="color:#0a3069">{</span>tool_name<span style="color:#0a3069">}</span><span style="color:#0a3069"> failed: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">raise</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">get_tools</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> List<span style="color:#1f2328">[</span><span style="color:#6639ba">dict</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;Get tools with caching&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>tools_cache <span style="color:#0550ae">and</span> time<span style="color:#0550ae">.</span>time<span style="color:#1f2328">()</span> <span style="color:#0550ae">-</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>tools_cache_time <span style="color:#0550ae">&lt;</span> <span style="color:#0550ae">300</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>tools_cache
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>tools_cache <span style="color:#0550ae">=</span> <span style="color:#1f2328">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;function&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;function&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;name&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;get_scene_info&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;description&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;Get high-level information about the current Blender scene&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;parameters&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;object&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;properties&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{}}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;function&#34;</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;function&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;name&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;get_object_info&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;description&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;Get detailed information about a specific object&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;parameters&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;object&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#0a3069">&#34;properties&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#0a3069">&#34;name&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;string&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;description&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;Object name&#34;</span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#0a3069">&#34;required&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;name&#34;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;function&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;function&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;name&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;execute_code&#34;</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;description&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;Execute Python code in Blender context. Use bpy.ops for operations.&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;parameters&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;object&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#0a3069">&#34;properties&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#0a3069">&#34;code&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;string&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;description&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;Python code to execute&#34;</span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#0a3069">&#34;required&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;code&#34;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>tools_cache_time <span style="color:#0550ae">=</span> time<span style="color:#0550ae">.</span>time<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>tools_cache
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">get_session_messages</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> session_id<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> List<span style="color:#1f2328">[</span><span style="color:#6639ba">dict</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;Get session messages&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">with</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>session_lock<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>sessions<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span>session_id<span style="color:#1f2328">,</span> <span style="color:#1f2328">[])</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">add_message</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> session_id<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> message<span style="color:#1f2328">:</span> <span style="color:#6639ba">dict</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;Add message to session&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">with</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>session_lock<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> session_id <span style="color:#0550ae">not</span> <span style="color:#0550ae">in</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>sessions<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>sessions<span style="color:#1f2328">[</span>session_id<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>sessions<span style="color:#1f2328">[</span>session_id<span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>message<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># Trim if too long</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>sessions<span style="color:#1f2328">[</span>session_id<span style="color:#1f2328">])</span> <span style="color:#0550ae">&gt;</span> config<span style="color:#0550ae">.</span>max_messages<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>sessions<span style="color:#1f2328">[</span>session_id<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>sessions<span style="color:#1f2328">[</span>session_id<span style="color:#1f2328">][</span><span style="color:#0550ae">-</span>config<span style="color:#0550ae">.</span>max_messages<span style="color:#1f2328">:]</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">process_chat</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> message<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> session_id<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#6639ba">dict</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;Fast chat processing that returns the full turn context.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Get conversation history for this turn</span>
</span></span><span style="display:flex;"><span>        messages_for_this_turn <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Get the session history to send to the LLM</span>
</span></span><span style="display:flex;"><span>        session_history <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>get_session_messages<span style="color:#1f2328">(</span>session_id<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        user_message <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;role&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;user&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;content&#34;</span><span style="color:#1f2328">:</span> message<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        session_history<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>user_message<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        messages_for_this_turn<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>user_message<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            tools <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>get_tools<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            openai_params <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;model&#34;</span><span style="color:#1f2328">:</span> config<span style="color:#0550ae">.</span>model<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">:</span> session_history<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;tools&#34;</span><span style="color:#1f2328">:</span> tools<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;tool_choice&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;auto&#34;</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;temperature&#34;</span><span style="color:#1f2328">:</span> config<span style="color:#0550ae">.</span>temperature<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#0a3069">&#34;anthropic&#34;</span> <span style="color:#0550ae">not</span> <span style="color:#0550ae">in</span> config<span style="color:#0550ae">.</span>model<span style="color:#0550ae">.</span>lower<span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>                openai_params<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;seed&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> config<span style="color:#0550ae">.</span>seed
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 1. First LLM Call (decides if a tool is needed)</span>
</span></span><span style="display:flex;"><span>            response <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>openai<span style="color:#0550ae">.</span>chat<span style="color:#0550ae">.</span>completions<span style="color:#0550ae">.</span>create<span style="color:#1f2328">(</span><span style="color:#0550ae">**</span>openai_params<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            assistant_message <span style="color:#0550ae">=</span> response<span style="color:#0550ae">.</span>choices<span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>message<span style="color:#0550ae">.</span>model_dump<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            messages_for_this_turn<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>assistant_message<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># Add messages to the persistent session history</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>add_message<span style="color:#1f2328">(</span>session_id<span style="color:#1f2328">,</span> user_message<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>add_message<span style="color:#1f2328">(</span>session_id<span style="color:#1f2328">,</span> assistant_message<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 2. Handle Tool Calls (if any)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> assistant_message<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;tool_calls&#39;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">for</span> tool_call <span style="color:#0550ae">in</span> assistant_message<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;tool_calls&#39;</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>                    tool_name <span style="color:#0550ae">=</span> tool_call<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;function&#39;</span><span style="color:#1f2328">][</span><span style="color:#0a3069">&#39;name&#39;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>                    tool_args <span style="color:#0550ae">=</span> json<span style="color:#0550ae">.</span>loads<span style="color:#1f2328">(</span>tool_call<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;function&#39;</span><span style="color:#1f2328">][</span><span style="color:#0a3069">&#39;arguments&#39;</span><span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>                    tool_result_content <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;Success&#34;</span> <span style="color:#57606a"># Default to success</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># Execute the tool</span>
</span></span><span style="display:flex;"><span>                        tool_result <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>call_mcp_tool<span style="color:#1f2328">(</span>tool_name<span style="color:#1f2328">,</span> tool_args<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">if</span> tool_result<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            tool_result_content <span style="color:#0550ae">=</span> json<span style="color:#0550ae">.</span>dumps<span style="color:#1f2328">(</span>tool_result<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># On error, the content is the error message</span>
</span></span><span style="display:flex;"><span>                        tool_result_content <span style="color:#0550ae">=</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Tool error: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>e<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># Create the tool result message</span>
</span></span><span style="display:flex;"><span>                    tool_result_message <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#0a3069">&#34;role&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;tool&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#0a3069">&#34;tool_call_id&#34;</span><span style="color:#1f2328">:</span> tool_call<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;id&#39;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#0a3069">&#34;name&#34;</span><span style="color:#1f2328">:</span> tool_name<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#0a3069">&#34;content&#34;</span><span style="color:#1f2328">:</span> tool_result_content
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>                    messages_for_this_turn<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>tool_result_message<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>add_message<span style="color:#1f2328">(</span>session_id<span style="color:#1f2328">,</span> tool_result_message<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 3. Return the entire conversation turn as a dictionary</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;turn_messages&#34;</span><span style="color:#1f2328">:</span> messages_for_this_turn<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            error_msg <span style="color:#0550ae">=</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Chat processing error: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>e<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>            logger<span style="color:#0550ae">.</span>error<span style="color:#1f2328">(</span>error_msg<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;error&#34;</span><span style="color:#1f2328">:</span> error_msg<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">get_stats</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#6639ba">dict</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;Get service stats&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">with</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>session_lock<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;total_sessions&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>sessions<span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;active_connections&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">([</span>c <span style="color:#cf222e">for</span> c <span style="color:#0550ae">in</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>connection_pool<span style="color:#0550ae">.</span>connections <span style="color:#cf222e">if</span> c<span style="color:#0550ae">.</span>is_healthy<span style="color:#1f2328">()])</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Global service instance</span>
</span></span><span style="display:flex;"><span>service <span style="color:#0550ae">=</span> FastBlenderService<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>async_manager <span style="color:#0550ae">=</span> FastAsyncManager<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>app <span style="color:#0550ae">=</span> Flask<span style="color:#1f2328">(</span><span style="color:#953800">__name__</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0550ae">@app.route</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;/health&#39;</span><span style="color:#1f2328">,</span> methods<span style="color:#0550ae">=</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;GET&#39;</span><span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">health</span><span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;Fast health check&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        async_manager<span style="color:#0550ae">.</span>start<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Quick MCP test</span>
</span></span><span style="display:flex;"><span>        start_time <span style="color:#0550ae">=</span> time<span style="color:#0550ae">.</span>time<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            result <span style="color:#0550ae">=</span> async_manager<span style="color:#0550ae">.</span>run_coro<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                service<span style="color:#0550ae">.</span>call_mcp_tool<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;get_scene_info&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">{}),</span>
</span></span><span style="display:flex;"><span>                timeout<span style="color:#0550ae">=</span><span style="color:#0550ae">5</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            mcp_status <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;connected&#34;</span>
</span></span><span style="display:flex;"><span>            response_time <span style="color:#0550ae">=</span> time<span style="color:#0550ae">.</span>time<span style="color:#1f2328">()</span> <span style="color:#0550ae">-</span> start_time
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            mcp_status <span style="color:#0550ae">=</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;error: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>e<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>            response_time <span style="color:#0550ae">=</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> jsonify<span style="color:#1f2328">({</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;status&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;healthy&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;mcp_connection&#34;</span><span style="color:#1f2328">:</span> mcp_status<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;mcp_response_time&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">round</span><span style="color:#1f2328">(</span>response_time<span style="color:#1f2328">,</span> <span style="color:#0550ae">3</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;available_tools&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>service<span style="color:#0550ae">.</span>get_tools<span style="color:#1f2328">()),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;stats&#34;</span><span style="color:#1f2328">:</span> service<span style="color:#0550ae">.</span>get_stats<span style="color:#1f2328">(),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;config&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;model&#34;</span><span style="color:#1f2328">:</span> config<span style="color:#0550ae">.</span>model<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;temperature&#34;</span><span style="color:#1f2328">:</span> config<span style="color:#0550ae">.</span>temperature<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;seed&#34;</span><span style="color:#1f2328">:</span> config<span style="color:#0550ae">.</span>seed
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> jsonify<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;status&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;error&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;error&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>e<span style="color:#1f2328">)}),</span> <span style="color:#0550ae">500</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0550ae">@app.route</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;/mcp/call&#39;</span><span style="color:#1f2328">,</span> methods<span style="color:#0550ae">=</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;POST&#39;</span><span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">call_mcp</span><span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;Fast direct MCP call&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        data <span style="color:#0550ae">=</span> request<span style="color:#0550ae">.</span>get_json<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        tool_name <span style="color:#0550ae">=</span> data<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;tool_name&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        tool_args <span style="color:#0550ae">=</span> data<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;tool_args&#39;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">{})</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> tool_name<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> jsonify<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;error&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;Missing tool_name&#34;</span><span style="color:#1f2328">}),</span> <span style="color:#0550ae">400</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        async_manager<span style="color:#0550ae">.</span>start<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        start_time <span style="color:#0550ae">=</span> time<span style="color:#0550ae">.</span>time<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        result <span style="color:#0550ae">=</span> async_manager<span style="color:#0550ae">.</span>run_coro<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>            service<span style="color:#0550ae">.</span>call_mcp_tool<span style="color:#1f2328">(</span>tool_name<span style="color:#1f2328">,</span> tool_args<span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>            timeout<span style="color:#0550ae">=</span><span style="color:#0550ae">30</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        response_time <span style="color:#0550ae">=</span> time<span style="color:#0550ae">.</span>time<span style="color:#1f2328">()</span> <span style="color:#0550ae">-</span> start_time
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> jsonify<span style="color:#1f2328">({</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;success&#34;</span><span style="color:#1f2328">:</span> <span style="color:#cf222e">True</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;result&#34;</span><span style="color:#1f2328">:</span> result<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;response_time&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">round</span><span style="color:#1f2328">(</span>response_time<span style="color:#1f2328">,</span> <span style="color:#0550ae">3</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;tool_name&#34;</span><span style="color:#1f2328">:</span> tool_name
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> jsonify<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;success&#34;</span><span style="color:#1f2328">:</span> <span style="color:#cf222e">False</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;error&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>e<span style="color:#1f2328">)}),</span> <span style="color:#0550ae">500</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0550ae">@app.route</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;/chat&#39;</span><span style="color:#1f2328">,</span> methods<span style="color:#0550ae">=</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;POST&#39;</span><span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">chat</span><span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;Fast chat endpoint that returns structured JSON.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        data <span style="color:#0550ae">=</span> request<span style="color:#0550ae">.</span>get_json<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        message <span style="color:#0550ae">=</span> data<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;message&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;&#39;</span><span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        session_id <span style="color:#0550ae">=</span> data<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;session_id&#39;</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>uuid<span style="color:#0550ae">.</span>uuid4<span style="color:#1f2328">()))</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> message<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> jsonify<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;error&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;Empty message&#34;</span><span style="color:#1f2328">}),</span> <span style="color:#0550ae">400</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        async_manager<span style="color:#0550ae">.</span>start<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        start_time <span style="color:#0550ae">=</span> time<span style="color:#0550ae">.</span>time<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Sending message: </span><span style="color:#0a3069">{</span>message<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># process_chat now returns a dictionary</span>
</span></span><span style="display:flex;"><span>        response_data <span style="color:#0550ae">=</span> async_manager<span style="color:#0550ae">.</span>run_coro<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>            service<span style="color:#0550ae">.</span>process_chat<span style="color:#1f2328">(</span>message<span style="color:#1f2328">,</span> session_id<span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>            timeout<span style="color:#0550ae">=</span><span style="color:#0550ae">60</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Response data: </span><span style="color:#0a3069">{</span>response_data<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        response_time <span style="color:#0550ae">=</span> time<span style="color:#0550ae">.</span>time<span style="color:#1f2328">()</span> <span style="color:#0550ae">-</span> start_time
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># The main response body is now the structured data itself</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> jsonify<span style="color:#1f2328">({</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;success&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;error&#34;</span> <span style="color:#0550ae">not</span> <span style="color:#0550ae">in</span> response_data<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> response_data<span style="color:#1f2328">,</span> <span style="color:#57606a"># &lt;-- Returns the structured dictionary</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;session_id&#34;</span><span style="color:#1f2328">:</span> session_id<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;response_time&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">round</span><span style="color:#1f2328">(</span>response_time<span style="color:#1f2328">,</span> <span style="color:#0550ae">3</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;message_count&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>service<span style="color:#0550ae">.</span>get_session_messages<span style="color:#1f2328">(</span>session_id<span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> jsonify<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;success&#34;</span><span style="color:#1f2328">:</span> <span style="color:#cf222e">False</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;error&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>e<span style="color:#1f2328">)}),</span> <span style="color:#0550ae">500</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0550ae">@app.route</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;/mcp/tools&#39;</span><span style="color:#1f2328">,</span> methods<span style="color:#0550ae">=</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;GET&#39;</span><span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">get_tools</span><span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;Get available tools&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> jsonify<span style="color:#1f2328">({</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;success&#34;</span><span style="color:#1f2328">:</span> <span style="color:#cf222e">True</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;tools&#34;</span><span style="color:#1f2328">:</span> service<span style="color:#0550ae">.</span>get_tools<span style="color:#1f2328">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;count&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>service<span style="color:#0550ae">.</span>get_tools<span style="color:#1f2328">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0550ae">@app.route</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;/sessions/&lt;session_id&gt;/reset&#39;</span><span style="color:#1f2328">,</span> methods<span style="color:#0550ae">=</span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;POST&#39;</span><span style="color:#1f2328">])</span> 
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">reset_session</span><span style="color:#1f2328">(</span>session_id<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;Reset session&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">with</span> service<span style="color:#0550ae">.</span>session_lock<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> session_id <span style="color:#0550ae">in</span> service<span style="color:#0550ae">.</span>sessions<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">del</span> service<span style="color:#0550ae">.</span>sessions<span style="color:#1f2328">[</span>session_id<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> jsonify<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;success&#34;</span><span style="color:#1f2328">:</span> <span style="color:#cf222e">True</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;message&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Session </span><span style="color:#0a3069">{</span>session_id<span style="color:#0a3069">}</span><span style="color:#0a3069"> reset&#34;</span><span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> jsonify<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;error&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;Session not found&#34;</span><span style="color:#1f2328">}),</span> <span style="color:#0550ae">404</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">if</span> <span style="color:#953800">__name__</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#39;__main__&#39;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> config<span style="color:#0550ae">.</span>openrouter_api_key<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        logger<span style="color:#0550ae">.</span>error<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;OPENROUTER_API_KEY required!&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        exit<span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;🚀 Starting Fast HTTP-to-MCP Bridge&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;📡 Blender MCP: </span><span style="color:#0a3069">{</span>config<span style="color:#0550ae">.</span>blender_host<span style="color:#0a3069">}</span><span style="color:#0a3069">:</span><span style="color:#0a3069">{</span>config<span style="color:#0550ae">.</span>blender_port<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;🤖 Model: </span><span style="color:#0a3069">{</span>config<span style="color:#0550ae">.</span>model<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;🔌 Connection Pool: </span><span style="color:#0a3069">{</span>config<span style="color:#0550ae">.</span>max_connections<span style="color:#0a3069">}</span><span style="color:#0a3069"> connections&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Pre-warm connections</span>
</span></span><span style="display:flex;"><span>    logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;🔥 Pre-warming connection pool...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    async_manager<span style="color:#0550ae">.</span>start<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Test one connection</span>
</span></span><span style="display:flex;"><span>        async_manager<span style="color:#0550ae">.</span>run_coro<span style="color:#1f2328">(</span>service<span style="color:#0550ae">.</span>call_mcp_tool<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;get_scene_info&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">{}),</span> timeout<span style="color:#0550ae">=</span><span style="color:#0550ae">5</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;✅ Connection pool ready&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;⚠️  Connection pre-warm failed: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    app<span style="color:#0550ae">.</span>run<span style="color:#1f2328">(</span>host<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;0.0.0.0&#39;</span><span style="color:#1f2328">,</span> port<span style="color:#0550ae">=</span><span style="color:#0550ae">5000</span><span style="color:#1f2328">,</span> debug<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">,</span> threaded<span style="color:#0550ae">=</span><span style="color:#cf222e">True</span><span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><p>Run it with:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>.venv<span style="color:#0a3069">\S</span>cripts<span style="color:#0a3069">\a</span>ctivate
</span></span><span style="display:flex;"><span>python blender-bridge-server.py</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><p><code>.env</code> file configuration:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>OPENROUTER_API_KEY=sk-xxxx
</span></span><span style="display:flex;"><span>MODEL=x-ai/grok-4-fast:free
</span></span><span style="display:flex;"><span>BLENDER_HOST=127.0.0.1
</span></span><span style="display:flex;"><span>BLENDER_PORT=9876</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><p>Remember to launch Blender with MCP enabled.</p>
<h2 id="blender-mcp-workflow-in-n8n">Blender MCP Workflow in n8n</h2>
<p>Inside n8n, I built a workflow with:</p>
<ul>
<li>






  <a href="https://docs.n8n.io/integrations/builtin/core-nodes/n8n-nodes-langchain.chattrigger/" target="_blank" rel="noopener noreferrer" >Chat Trigger</a>
</li>
<li>






  <a href="https://docs.n8n.io/integrations/builtin/core-nodes/n8n-nodes-base.httprequest/" target="_blank" rel="noopener noreferrer" >HTTP Request</a>
</li>
</ul>
<p>The first HTTP node, <strong>Blender Chat</strong>, sends user prompts to the bridge:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Method: POST
</span></span><span style="display:flex;"><span>URL: http://192.168.68.118:5000/chat
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Header Parameters
</span></span><span style="display:flex;"><span>  Name: Content-Type
</span></span><span style="display:flex;"><span>  Value: application/json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>JSON
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  &#34;message&#34;: &#34;{{ $json.chatInput }}&#34;,
</span></span><span style="display:flex;"><span>  &#34;session_id&#34;: &#34;my-blender-session&#34;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Settings
</span></span><span style="display:flex;"><span>Always Output Data: True
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>On Error
</span></span><span style="display:flex;"><span>Continue</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><p>The second, <strong>Blender Scene</strong>, triggers direct MCP calls (e.g., <code>get_scene_info</code>).</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Method: POST
</span></span><span style="display:flex;"><span>URL: http://192.168.68.118:5000/mcp/call
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Body Parameters
</span></span><span style="display:flex;"><span>  Name: tool_name
</span></span><span style="display:flex;"><span>  Value: get_scene_info</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="generating-a-condominium-model">Generating a Condominium Model</h3>
<p>With everything wired, I began prompting Blender to generate a condominium scene:</p>
<p>Prompt 1:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Let&#39;s begin by preparing the scene. Create two new top-level collections. Name the first one &#39;Condominium_Tower&#39; and the second one &#39;Site&#39;</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>

































 
  
  





  <img src="/images/blender-n8n/blender-n8n-first-prompt.png"   alt="blender-n8n-first-prompt" class="sc-image sc-image-default"
       >


<p>Prompt 2:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Now, create the ground plane. Make the &#39;Site&#39; collection the active one for adding new objects. Add a cube, scale it to 200 units in X and Y, and 1 unit in Z for thickness. Position it at Z=-0.5 so its top surface is at ground level (Z=0). Name this new object &#39;Ground_Plane&#39;</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>

































 
  
  





  <img src="/images/blender-n8n/blender-n8n-second-prompt.png"   alt="blender-n8n-second-prompt" class="sc-image sc-image-default"
       >


<p>Subsequent prompts gradually added slabs, glass facades, balcony railings, and eventually stacked 20 floors with a penthouse. The iterative AI-driven design process made building a complex structure conversational and modular.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>The ground is in place. Now for the tower&#39;s foundation slab. Make the &#39;Condominium_Tower&#39; collection the active one. Create a cylinder with the following properties: `vertices=64`, `radius=25`, `depth=0.5`, and `location=(0, 0, 0.25)`. Name it &#39;Base_Slab&#39;. This positions the slab so its bottom sits at ground level (Z=0)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Now, let&#39;s duplicate it vertically to create all 20 floors. Ensure the &#39;Base_Slab&#39; object is the selected and active object. Add an ARRAY modifier to it. Set the modifier&#39;s properties as follows: Count: 20, Turn OFF Relative Offset, Turn ON Constant Offset and set the offset values to X=0, Y=0, Z=4.0. This will stack the slabs vertically with the base slab at Z=0.25, second floor at Z=4.25m, third at Z=8.25m, and so on
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The structural slabs are complete. Now let&#39;s create the glass facade for the ground floor. Make the &#39;Condominium_Tower&#39; collection active. Create a new cylinder. Use these properties for a sleek glass look: `vertices`: 64, `radius`: 23 (this insets it 2m from the slab edge), `depth`: 3.5 (this makes it fit perfectly between the floor slabs), `location`: (0, 0, 2.25). Name the new cylinder &#39;Facade_Glass&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The glass wall is in place. Now add the balcony railing for the ground floor. Ensure &#39;Condominium_Tower&#39; is the active collection. The best way to create a simple railing is with a Torus object. Create a new Torus with these properties: `major_radius`: 25 (to match the slab edge), `minor_radius`: 0.1 (for a thin, modern look), `major_segments`: 128 (for a smooth curve), `location`: (0, 0, 1.25). Name the new torus &#39;Facade_Railing&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The first facade section is complete. Let&#39;s duplicate it for all 20 floors. Select both the &#39;Facade_Glass&#39; cylinder and the &#39;Facade_Railing&#39; torus. Make one of them the active object. Add an `ARRAY` modifier. Set its properties exactly like the floor slab&#39;s modifier: `Count`: 20, Turn OFF `Relative Offset`, Turn ON `Constant Offset` and set its Z value to 4.0. With both objects still selected, copy the modifier from the active object to the other selected object
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The main tower is complete. Now, let&#39;s add a separate, taller penthouse level on top. Select the original &#39;Base_Slab&#39; object. Duplicate this object. On the new duplicate, remove its Array modifier so it becomes a single slab again. Move this new slab to a `location` of Z=80.0. This places it exactly on top of the 20th floor. Name the object &#39;Penthouse_Slab&#39; and move it into the &#39;Condominium_Tower&#39; collection
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The penthouse floor is in place. Now, let&#39;s add its unique, taller facade. We&#39;ll make this floor 6 meters high instead of 4. Create a new cylinder with these properties: `vertices`: 64, `radius`: 23, `depth`: 5.5 (to fit a 6m floor height), `location`: (0, 0, 83.0), Name it &#39;Penthouse_Glass&#39;. Create a new Torus with these properties: `major_radius`: 25, `minor_radius`: 0.1, `major_segments`: 128, `location`: (0, 0, 81.25). Name it &#39;Penthouse_Railing&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The penthouse is now enclosed. Let&#39;s add the final architectural elements to complete the model. Duplicate the &#39;Penthouse_Slab&#39;. Move the duplicate to a `location` of Z=86.0. Name this object &#39;Roof_Slab&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Add vertical fins around the tower facade. Create a thin cube with dimensions of X=0.2, Y=1.0, Z=84. Name it &#39;Facade_Fin&#39;. Duplicate this fin 11 times to create 12 fins total positioned around a circle with radius 24.5m at Z=42. Use the formula: X = 24.5 × cos(angle), Y = 24.5 × sin(angle), Z = 42, where angles are 0°, 30°, 60°, 90°, 120°, 150°, 180°, 210°, 240°, 270°, 300°, 330°</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>

































 
  
  





  <img src="/images/blender-n8n/blender-n8n-completed-model.png"   alt="blender-n8n-completed-model" class="sc-image sc-image-default"
       >


<h3 id="assigning-materials-to-the-model">Assigning Materials to the Model</h3>
<p>With the structural elements in place, the next step is to bring the model to life using materials.</p>
<p>First, let’s set up the glass materials:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Create a new material. Name it &#39;M_Glass_Modern&#39;. Select the &#39;Facade_Glass&#39; object and assign the &#39;M_Glass_Modern&#39; material to it. Select the &#39;Penthouse_Glass&#39; object and assign the &#39;M_Glass_Modern&#39; material to it</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><p>While the prompt created the material, I had to fine-tune it manually — setting <strong>Roughness = 0.1</strong>, <strong>IOR = 1.45</strong>, and <strong>Transmission &gt; Weight = 1.0</strong> for a realistic glass effect.</p>
<p>Next, I created the slab and metal materials:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Let&#39;s create the remaining materials for the building. Create a new material named &#39;M_Concrete_Slab&#39;. Assign this material to the &#39;Base_Slab&#39;, &#39;Penthouse_Slab&#39;, and &#39;Roof_Slab&#39; objects. Create another new material named &#39;M_Metal_Dark&#39;. Assign this material to the &#39;Facade_Railing&#39;, &#39;Penthouse_Railing&#39;, and &#39;Facade_Fin&#39; objects</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><p>Manually tweaking gave the best results:</p>
<ul>
<li><strong>M_Concrete_Slab:</strong> Roughness = 0.8, Base Color = orange</li>
<li><strong>M_Metal_Dark:</strong> Base Color = darker orange, Metallic = 1.0, Roughness = 0.4</li>
</ul>


































 
  
  





  <img src="/images/blender-n8n/blender-n8n-glass-material.png"   alt="blender-n8n-glass-material" class="sc-image sc-image-default"
       >


<h3 id="landscaping">Landscaping</h3>
<p>With the building complete, I moved on to landscaping, starting with a tree prototype:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Let&#39;s build the tree in the workshop area (X=40, Y=0). Make the &#39;Site&#39; collection active. Create a cylinder for the trunk with dimensions (0.3, 0.3, 4) at location (40, 0, 2). Name it &#39;Tree_Trunk&#39;. Create an icosphere for the leaves with a radius of 2.5 at location (40, 0, 5.25). Name it &#39;Tree_Leaves&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Now, let&#39;s create and assign their materials. Create a new material named &#39;M_Tree_Trunk&#39;. Set its &#39;Base Color&#39; to a dark brown (#5C3A1E) and &#39;Roughness&#39; to 0.9. Assign the &#39;M_Tree_Trunk&#39; material to the &#39;Tree_Trunk&#39; object. Create a new material named &#39;M_Tree_Leaves&#39;. Set its &#39;Base Color&#39; to a forest green (#2A522A) and &#39;Roughness&#39; to 0.8. Assign the &#39;M_Tree_Leaves&#39; material to the &#39;Tree_Leaves&#39; object
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The parts are now correctly textured. Let&#39;s combine them into the final prototype. Select both the &#39;Tree_Trunk&#39; and &#39;Tree_Leaves&#39; objects. Make the &#39;Tree_Trunk&#39; the active object. Join the two objects into one. Name the final, combined object &#39;Tree_Prototype&#39;</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>

































 
  
  





  <img src="/images/blender-n8n/blender-n8n-tree-prototype.png"   alt="blender-n8n-tree-prototype" class="sc-image sc-image-default"
       >


<p>Once the prototype was ready, I duplicated it to create a grove of trees around the site:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Duplicates Tree_Prototype 29 times Uses random.uniform() to generate X,Y coordinates Ensures distance from origin &lt; 50m using math.sqrt(x²+y²) &gt; 40m. Places each tree at the calculated random position</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>

































 
  
  





  <img src="/images/blender-n8n/blender-mcp-condominium-model.png"   alt="blender-mcp-condominium-model" class="sc-image sc-image-default"
       >


<h3 id="camera-and-lighting">Camera and Lighting</h3>
<p>To showcase the scene, I added cinematic camera and lighting:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Create cinematic lighting and camera setup. Add a Sun light with warm color and strength 3.0, rotated to (30°, 0°, 120°) for golden hour lighting. Position the camera at (100, -120, 35) with rotation (75°, 0°, 35°) for a dramatic low-angle hero shot of the tower</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>

































 
  
  





  <img src="/images/blender-n8n/blender-n8n-model-with-cinematic-lighting-and-camera.png"   alt="blender-n8n-model-with-cinematic-lighting-and-camera" class="sc-image sc-image-default"
       >


<p>For a softer, more stylized render, I adjusted the lighting setup:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Soften the lighting for a more stylized render. Increase the Sun light&#39;s angle/size to 5-10 degrees to create softer shadow edges. Add a second Area light as ambient fill lighting with strength 2.0 positioned opposite the sun. Reduce the sun strength to 2.5 to balance the overall lighting contrast.</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>

































 
  
  





  <img src="/images/blender-n8n/blender-n8n-model-soften-shadow.png"   alt="blender-n8n-model-soften-shadow" class="sc-image sc-image-default"
       >


<h2 id="closing-thoughts">Closing Thoughts</h2>
<p>This setup bridges <strong>n8n</strong>, <strong>OpenRouter</strong>, and <strong>Blender MCP</strong>, enabling AI-driven workflows to shape and control 3D environments. By combining automation with natural language prompts, even complex modeling tasks become conversational and modular.</p>
<p>While I relied on a bridge service in this iteration, future versions could integrate directly into n8n as a custom node—bringing Blender automation one step closer to a fully no-code, AI-powered workflow.</p>

    </section>

    <nav class="post-navigation">
      <div class="nav-links">
        
          <div class="nav-previous">
            <a href="/posts/2025/09/blender-meets-mcp/" rel="prev">
              <span class="meta-nav">← Previous</span>
              <span class="post-title">Blender Meets MCP</span>
            </a>
          </div>
        
        
          <div class="nav-next">
            <a href="/posts/2025/10/ats-buddy-privacy-first-resume-ai/" rel="next">
              <span class="meta-nav">Next →</span>
              <span class="post-title">ATS Buddy: Privacy-First Resume AI</span>
            </a>
          </div>
        
      </div>
    </nav>

    
<div class="giscus-comments-container">
</div>

<script>
  (function() {
    'use strict';

    const getGiscusTheme = () => {
      const storedTheme = localStorage.getItem('theme'); 
      if (storedTheme) {
        return storedTheme === 'dark-mode' ? 'dark' : 'light';
      }
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };

    const setGiscusFrameTheme = (theme) => {
      const iframe = document.querySelector('iframe.giscus-frame');
      if (iframe && iframe.contentWindow) {
        iframe.contentWindow.postMessage({ giscus: { setConfig: { theme: theme } } }, 'https://giscus.app');
      }
    };

    const loadGiscus = () => {
      const giscusContainer = document.querySelector('.giscus-comments-container');
      if (!giscusContainer) {
        console.warn('Giscus container not found.');
        return;
      }

      while (giscusContainer.firstChild) {
        giscusContainer.removeChild(giscusContainer.firstChild);
      }

      const giscusScript = document.createElement('script');
      const giscusAttributes = {
        "src": "https://giscus.app/client.js",
        "data-repo":             "seehiong\/seehiong.github.io",
        "data-repo-id":          "R_kgDOJg7Puw",
        "data-category":         "General",
        "data-category-id":      "DIC_kwDOJg7Pu84Cbyhc",
        "data-mapping":          "url", 
        "data-strict":           "0",
        "data-reactions-enabled":"1",
        "data-emit-metadata":    "0",
        "data-input-position":   "top", 
        "data-theme":            getGiscusTheme(), 
        "data-lang":             "en",
        "data-loading":          "lazy",
        "crossorigin":           "anonymous",
        "async":                 "true", 
      };

      if (!giscusAttributes["data-repo"] || !giscusAttributes["data-repo-id"] || !giscusAttributes["data-category-id"]) {
          console.error("Giscus parameters (giscusRepo, giscusRepoId, giscusCategoryId) are not configured in hugo.toml.");
          giscusContainer.innerHTML = "<p style='color: var(--text-secondary);'>Giscus comments are not configured correctly. Please check site parameters.</p>";
          return;
      }

      Object.entries(giscusAttributes).forEach(
        ([key, value]) => giscusScript.setAttribute(key, value)
      );
      giscusContainer.appendChild(giscusScript);
    };

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadGiscus);
    } else {
        loadGiscus();
    }

    const htmlElement = document.documentElement;
    const observer = new MutationObserver((mutationsList) => {
      for (const mutation of mutationsList) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          setGiscusFrameTheme(getGiscusTheme());
        }
      }
    });
    observer.observe(htmlElement, { attributes: true });

  })();
</script>


  </article>
</div>
</main>
    </div>

    
    <div id="search-modal-overlay" class="search-modal-overlay" style="display: none;">
      <div id="search-modal-content" class="search-modal-content">
        <button id="search-modal-close" class="search-modal-close" aria-label="Close search" title="Close search">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </button>
        <input type="search" id="modal-search-input" class="modal-search-input" placeholder="Search content..." aria-label="Search input">
        <div id="modal-search-results" class="modal-search-results">
        </div>
      </div>
    </div>
    

  <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js" defer></script>
  <script>
    (function() {
      'use strict';

      window.addEventListener('DOMContentLoaded', () => {
        const searchModalOverlay = document.getElementById('search-modal-overlay');
        const searchModalContent = document.getElementById('search-modal-content');
        const searchModalCloseButton = document.getElementById('search-modal-close');
        const searchToggleButton = document.getElementById('nav-search-toggle');
        const searchInputTarget = document.getElementById('modal-search-input');
        const searchResultsTarget = document.getElementById('modal-search-results');

        let fuseInstance = null;
        let searchData = [];

        const loadSearchData = async () => {
          if (searchData.length === 0 && !fuseInstance) {
            try {
              const response = await fetch('\/index.json');
              if (!response.ok) {
                throw new Error(`HTTP error loading index.json! status: ${response.status}`);
              }
              searchData = await response.json();
              initializeFuse();
            } catch (e) {
              console.error("[SearchSetup] Error loading search data:", e);
              if (searchResultsTarget) searchResultsTarget.innerHTML = "<p>Error loading search index.</p>";
            }
          } else if (searchData.length > 0 && !fuseInstance){
            initializeFuse();
          }
        };

        const initializeFuse = () => {
          if (searchData.length > 0 && !fuseInstance) {
            const options = {
              keys: [
                { name: 'title', weight: 0.7 }, { name: 'summary', weight: 0.5 },
                { name: 'content', weight: 0.3 }, { name: 'tags', weight: 0.4 }
              ],
              includeScore: true, threshold: 0.4, minMatchCharLength: 2,
            };
            fuseInstance = new Fuse(searchData, options);
          }
        };

        const performSearch = () => {
          if (!fuseInstance || !searchInputTarget || !searchResultsTarget) return;
          const query = searchInputTarget.value.trim();
          searchResultsTarget.innerHTML = '';
          if (query.length < 2) return;

          const results = fuseInstance.search(query);
          if (results.length > 0) {
            const ul = document.createElement('ul');
            ul.className = 'search-results-list';
            results.slice(0, 10).forEach(result => {
              const item = result.item;
              const li = document.createElement('li');
              li.className = 'search-result-item';
              const a = document.createElement('a');
              a.href = item.permalink;
              a.textContent = item.title;
              li.appendChild(a);
              ul.appendChild(li);
            });
            searchResultsTarget.appendChild(ul);
          } else {
            searchResultsTarget.innerHTML = '<p>No results found.</p>';
          }
        };

        const openSearchModal = async () => {
          await loadSearchData();
          if (searchInputTarget) searchInputTarget.value = '';
          if (searchResultsTarget) searchResultsTarget.innerHTML = '';

          if (searchModalOverlay) {
            searchModalOverlay.style.display = 'flex';
            setTimeout(() => searchModalOverlay.classList.add('active'), 10);
          } else { return; }

          if (searchInputTarget) setTimeout(() => searchInputTarget.focus(), 50);
          if (searchToggleButton) searchToggleButton.classList.add('active');
        };

        const closeSearchModal = () => {
          if (searchModalOverlay) {
            searchModalOverlay.classList.remove('active');
            setTimeout(() => searchModalOverlay.style.display = 'none', 300);
          }
          if (searchToggleButton) searchToggleButton.classList.remove('active');
        };

        if (searchToggleButton) {
          searchToggleButton.addEventListener('click', (e) => {
            e.stopPropagation();
            if (searchModalOverlay && searchModalOverlay.classList.contains('active')) {
              closeSearchModal();
            } else {
              openSearchModal();
            }
          });
        } else { console.error("[SearchSetup] #nav-search-toggle button not found."); }

        if (searchModalCloseButton) { searchModalCloseButton.addEventListener('click', closeSearchModal); }
        if (searchModalOverlay && searchModalContent) {
          searchModalOverlay.addEventListener('click', (event) => {
            if (event.target === searchModalOverlay) closeSearchModal();
          });
        }
        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && searchModalOverlay && searchModalOverlay.classList.contains('active')) {
            closeSearchModal();
          }
        });
        if (searchInputTarget) {
          let debounceTimer;
          searchInputTarget.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(performSearch, 300);
          });
        }
      });
    })();
  </script>

    

    

  <script>
    MathJax = {
      tex: {
        displayMath: [['\\[', '\\]'], ['$$', '$$']], 
        inlineMath: [['\\(', '\\)']], 
        processEscapes: true,
        processEnvironments: true,
        tags: 'ams' 
      },
      svg: {
        fontCache: 'global' 
      },
      chtml: {
        fontURL: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2'
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'], 
        ignoreHtmlClass: 'tex2jax_ignore', 
        processHtmlClass: 'tex2jax_process'
      }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<footer class="footer-main simplified-footer">
  <div class="content-body footer-wraper">
    <div class="footer-box">
      <div class="footer-content">
        <div class="copyright-line">
          Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> © 2026 See Hiong. All rights reserved.
        </div>
        <div class="social-links">
          
            <a href="https://github.com/seehiong" target="_blank" title="GitHub" class="social-link" aria-label="GitHub">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
            </a>
          
          
            <a href="https://www.linkedin.com/in/seehiong/" target="_blank" title="LinkedIn" class="social-link" aria-label="LinkedIn">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
            </a>
          
          
            <a href="/index.xml" target="_blank" title="RSS" class="social-link" aria-label="RSS Feed">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg>
            </a>
          
        </div>
      </div>
    </div>
  </div>
</footer>
        <script src="/js/animation.js" defer></script>
    
        <script src="/js/code-copy.js" defer></script>
    
        <script src="/js/scroll-header.js" defer></script>
       
  </body>
</html>