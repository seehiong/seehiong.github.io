<!DOCTYPE html>
<html lang="en">
  <head><head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <link rel="icon" href="/images/favicon.ico">
    

    <meta property="og:url" content="https://seehiong.github.io/posts/2025/11/building-a-langgraph-multi-agent-system/">
  <meta property="og:site_name" content="See Hiong&#39;s Blog">
  <meta property="og:title" content="Building a LangGraph Multi-Agent System">
  <meta property="og:description" content="This post walks through building a complete multi-agent system using LangGraphâ€”from a simple deterministic chain to a fully orchestrated ReAct agent and a modular supervisor-led MAS. It integrates Postgres (via MCP Toolbox), Tavily web search, and custom Python tools to analyze Singapore HDB resale data and nearby amenities. Complete with diagrams, code walkthroughs, and LangSmith Studio deployment, this guide demonstrates how to design practical, production-ready agent workflows using LangChain and LangGraph.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-11-23T18:00:00+08:00">
    <meta property="article:modified_time" content="2025-11-23T18:00:00+08:00">
    <meta property="article:tag" content="LangGraph">
    <meta property="article:tag" content="LangChain">
    <meta property="article:tag" content="LangSmith Studio">
    <meta property="article:tag" content="OpenRouter">
    <meta property="article:tag" content="Travily">
    <meta property="article:tag" content="Postgres">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Building a LangGraph Multi-Agent System">
  <meta name="twitter:description" content="This post walks through building a complete multi-agent system using LangGraphâ€”from a simple deterministic chain to a fully orchestrated ReAct agent and a modular supervisor-led MAS. It integrates Postgres (via MCP Toolbox), Tavily web search, and custom Python tools to analyze Singapore HDB resale data and nearby amenities. Complete with diagrams, code walkthroughs, and LangSmith Studio deployment, this guide demonstrates how to design practical, production-ready agent workflows using LangChain and LangGraph.">

  <meta itemprop="name" content="Building a LangGraph Multi-Agent System">
  <meta itemprop="description" content="This post walks through building a complete multi-agent system using LangGraphâ€”from a simple deterministic chain to a fully orchestrated ReAct agent and a modular supervisor-led MAS. It integrates Postgres (via MCP Toolbox), Tavily web search, and custom Python tools to analyze Singapore HDB resale data and nearby amenities. Complete with diagrams, code walkthroughs, and LangSmith Studio deployment, this guide demonstrates how to design practical, production-ready agent workflows using LangChain and LangGraph.">
  <meta itemprop="datePublished" content="2025-11-23T18:00:00+08:00">
  <meta itemprop="dateModified" content="2025-11-23T18:00:00+08:00">
  <meta itemprop="wordCount" content="3437">
  <meta itemprop="keywords" content="LangGraph,LangChain,LangSmith Studio,OpenRouter,Travily,Postgres,MCP Toolbox,Multi-Agent System"><title>Building a LangGraph Multi-Agent System | See Hiong&#39;s Blog</title>

    <link rel="canonical" href="https://seehiong.github.io/posts/2025/11/building-a-langgraph-multi-agent-system/">

    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    
      
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-5PNPM4HWQ0"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-5PNPM4HWQ0');
        }
      </script>
    
    <link rel="stylesheet" href="/css/variables.css">
    
    <link rel="stylesheet" href="/css/base.css">
    
    <link rel="stylesheet" href="/css/layout.css">
    
    <link rel="stylesheet" href="/css/header.css">
    
    <link rel="stylesheet" href="/css/header.css">
    
    <link rel="stylesheet" href="/css/cards.css">
    
    <link rel="stylesheet" href="/css/content_elements.css">
    
    <link rel="stylesheet" href="/css/codeblocks.css">
    
    <link rel="stylesheet" href="/css/page_specific.css">
    
    <link rel="stylesheet" href="/css/shortcodes.css">
    
    <link rel="stylesheet" href="/css/components.css">
    
    <link rel="stylesheet" href="/css/animations.css">
    
    <link rel="stylesheet" href="/css/media_queries.css">
    
    <link rel="stylesheet" href="/css/quantum-theme.css">
    

    
    <script>
      (function() {
        var theme = localStorage.getItem('theme');
        var H = document.documentElement;
        if (theme === 'dark-mode') {
          H.classList.add('dark-mode');
        } else if (theme === 'light-mode') {
          H.classList.remove('dark-mode');
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
          H.classList.add('dark-mode');
        }
      })();
    </script>
</head></head>
  <body class="page-article"><nav class="nav">
  <div class="nav-wrapper">
    <div class="nav-content-wrapper">
      <div class="nav-content">
        <a href="/" class="nav-logo-link" title="See Hiong&#39;s Blog - Home">
          <span class="nav-site-title">
            <span class="nav-site-title__main">SEE HIONGâ€™S</span>
            <span class="nav-site-title__sub">BLOG</span>
          </span>
        </a>
        <div class="nav-menu">
          <div class="nav-item-wrapper">
            
            
            <a href="/posts/" class="nav-item-content active">Archives</a>
            
          </div>
          
          
          <div class="nav-item-wrapper">
            <a href="/tags/" class="nav-item-content ">Tags</a>
          </div>
          <div class="nav-item-wrapper">
            <a href="/about/" class="nav-item-content ">About</a>
          </div>
          <div class="nav-item-wrapper nav-search-toggle-wrapper">
            <button id="nav-search-toggle" class="nav-item-button" aria-label="Toggle search" title="Search">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor" class="nav-item-icon">
                <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5A6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
              </svg>
            </button>
          </div>
          
          
          <button id="theme-toggle" class="nav-item-button" aria-label="Toggle theme"></button> 
        </div>
      </div>
    </div>
  </div>
</nav>


<script>
  document.addEventListener('DOMContentLoaded', function () {
    const themeToggle = document.getElementById('theme-toggle');
    const H = document.documentElement; 

    if (H.classList.contains('dark-mode')) {
      themeToggle.textContent = 'Light Mode';
    } else {
      themeToggle.textContent = 'Dark Mode';
    }

    themeToggle.addEventListener('click', function() {
      H.classList.toggle('dark-mode');
      if (H.classList.contains('dark-mode')) {
        localStorage.setItem('theme', 'dark-mode');
        themeToggle.textContent = 'Light Mode';
      } else {
        localStorage.setItem('theme', 'light-mode');
        themeToggle.textContent = 'Dark Mode';
      }
    });
  });
</script><div id="content-wrapper">
        <main class="container" id="main-content">
<div class="main-content-area">
  <article class="post-layout container">

    <header class="post-header">
      <h1 class="post-title">Building a LangGraph Multi-Agent System</h1>

      <div class="post-meta">
        <span class="post-meta__date">
          <time datetime="2025-11-23T18:00:00&#43;08:00">November 23, 2025</time>
        </span>

        
          <span class="post-meta__author">Written by See Hiong</span>
        

        
          <span class="post-meta__tags">
            In:
            
              <a href="/tags/langgraph">LangGraph</a>
            
              , <a href="/tags/langchain">LangChain</a>
            
              , <a href="/tags/langsmith-studio">LangSmith Studio</a>
            
              , <a href="/tags/openrouter">OpenRouter</a>
            
              , <a href="/tags/travily">Travily</a>
            
              , <a href="/tags/postgres">Postgres</a>
            
              , <a href="/tags/mcp-toolbox">MCP Toolbox</a>
            
              , <a href="/tags/multi-agent-system">Multi-Agent System</a>
            
          </span>
        

        
      </div>
    </header>

    
      
      
      <div class="post-cover-container post-cover--artistic-blur-wrapper">
        
          <div class="post-cover-blur-background" style="--bg-image: url('/images/mas/building-a-langgraph-multi-agent-system.png');"></div>
          <img src="/images/mas/building-a-langgraph-multi-agent-system.png" alt="Building a LangGraph Multi-Agent System cover image" class="post-cover-image post-cover-image--artistic-blur">
        
      </div>
    

    <section class="post-content">
      <p>Having recently completed Courseraâ€™s 






  <a href="https://www.coursera.org/learn/agentic-ai-with-langchain-and-langgraph" target="_blank" rel="noopener noreferrer" >Agentic AI with LangChain and LangGraph</a>
, I was eager to apply the concepts to a real project.
This post walks through the full journeyâ€”from building a minimal LangGraph chain, to implementing a ReAct agent, and finally orchestrating a fully automated <strong>multi-agent system (MAS)</strong> optimized for Singapore HDB data analysis.</p>
<h2 id="setup">Setup</h2>
<p>As usual, we begin by initializing a clean Python project using 






  <a href="https://github.com/astral-sh/uv" target="_blank" rel="noopener noreferrer" ><code>uv</code></a>
, an ultra-fast Python package manager and environment tool:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>mkdir <span style="color:#6639ba">multi-agent</span>-system-using-langgraph
</span></span><span style="display:flex;"><span><span style="color:#6639ba">cd multi-agent</span>-system-using-langgraph
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Initialize project</span>
</span></span><span style="display:flex;"><span>uv init <span style="color:#1f2328">.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Create and activate virtual environment</span>
</span></span><span style="display:flex;"><span>uv sync
</span></span><span style="display:flex;"><span><span style="color:#1f2328">.</span>venv<span style="color:#1f2328">\</span>Scripts<span style="color:#1f2328">\</span>activate
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Add dependencies</span>
</span></span><span style="display:flex;"><span>uv add langgraph langchain langchain_openai langchain_tavily <span style="color:#6639ba">toolbox-langchain</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h2 id="use-case-1-toto-generator-deterministic-chain">Use Case 1: TOTO Generator (Deterministic Chain)</h2>
<p>To warm up, letâ€™s start with a fun and simple example: a TOTO number generator.</p>
<p>






  <a href="https://en.wikipedia.org/wiki/Toto_%28lottery%29" target="_blank" rel="noopener noreferrer" >TOTO</a>
 is a Singaporean lottery where players choose six numbers from 1 to 49.
This use case is perfect for demonstrating a simple LangGraph loop with conditional stopping.</p>
<p>We implement this in a new notebook: <code>toto_generator.ipynb</code>.</p>
<h3 id="1-define-chainstate">1. Define ChainState</h3>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">random</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">typing</span> <span style="color:#cf222e">import</span> TypedDict
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">langgraph.graph</span> <span style="color:#cf222e">import</span> StateGraph<span style="color:#1f2328">,</span> END
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">class</span> <span style="color:#1f2328">ChainState</span><span style="color:#1f2328">(</span>TypedDict<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    n<span style="color:#1f2328">:</span> <span style="color:#6639ba">int</span>
</span></span><span style="display:flex;"><span>    number<span style="color:#1f2328">:</span> <span style="color:#6639ba">int</span>
</span></span><span style="display:flex;"><span>    used_numbers<span style="color:#1f2328">:</span> <span style="color:#6639ba">set</span><span style="color:#1f2328">[</span><span style="color:#6639ba">int</span><span style="color:#1f2328">]</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="2-add-dump-and-stop-condition-functions">2. Add, dump, and stop-condition functions</h3>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">add</span><span style="color:#1f2328">(</span>state<span style="color:#1f2328">:</span> ChainState<span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> ChainState<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>  used_numbers <span style="color:#0550ae">=</span> state<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;used_numbers&#34;</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">set</span><span style="color:#1f2328">())</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>used_numbers<span style="color:#1f2328">)</span> <span style="color:#0550ae">&gt;=</span> <span style="color:#0550ae">49</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">raise</span> ValueError<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;All numbers from 1-49 have been used&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>  available <span style="color:#0550ae">=</span> <span style="color:#6639ba">set</span><span style="color:#1f2328">(</span><span style="color:#6639ba">range</span><span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">50</span><span style="color:#1f2328">))</span> <span style="color:#0550ae">-</span> used_numbers          
</span></span><span style="display:flex;"><span>  random_number <span style="color:#0550ae">=</span> random<span style="color:#0550ae">.</span>choice<span style="color:#1f2328">(</span><span style="color:#6639ba">list</span><span style="color:#1f2328">(</span>available<span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>          
</span></span><span style="display:flex;"><span>  new_used_numbers <span style="color:#0550ae">=</span> used_numbers<span style="color:#0550ae">.</span>copy<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>  new_used_numbers<span style="color:#0550ae">.</span>add<span style="color:#1f2328">(</span>random_number<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">return</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0550ae">**</span>state<span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;n&#34;</span><span style="color:#1f2328">:</span> state<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;n&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;number&#34;</span><span style="color:#1f2328">:</span> random_number<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;used_numbers&#34;</span><span style="color:#1f2328">:</span> new_used_numbers
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">dump</span><span style="color:#1f2328">(</span>state<span style="color:#1f2328">:</span> ChainState<span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> ChainState<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Current n:&#34;</span><span style="color:#1f2328">,</span> state<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;n&#34;</span><span style="color:#1f2328">],</span> <span style="color:#0a3069">&#34;number:&#34;</span><span style="color:#1f2328">,</span> state<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;number&#34;</span><span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Winning numbers:&#34;</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">sorted</span><span style="color:#1f2328">(</span>state<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;used_numbers&#34;</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">set</span><span style="color:#1f2328">())))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> state
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">stop_condition</span><span style="color:#1f2328">(</span>state<span style="color:#1f2328">:</span> ChainState<span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#6639ba">bool</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> state<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;n&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">&gt;=</span> <span style="color:#0550ae">6</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="3-build-the-graph">3. Build the graph</h3>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>graph <span style="color:#0550ae">=</span> StateGraph<span style="color:#1f2328">(</span>ChainState<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>graph<span style="color:#0550ae">.</span>add_node<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;add&#34;</span><span style="color:#1f2328">,</span> add<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>graph<span style="color:#0550ae">.</span>add_node<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;dump&#34;</span><span style="color:#1f2328">,</span> dump<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>graph<span style="color:#0550ae">.</span>add_edge<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;add&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;dump&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>graph<span style="color:#0550ae">.</span>add_conditional_edges<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;dump&#34;</span><span style="color:#1f2328">,</span> stop_condition<span style="color:#1f2328">,</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">True</span><span style="color:#1f2328">:</span> END<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">False</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;add&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>graph<span style="color:#0550ae">.</span>set_entry_point<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;add&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>app <span style="color:#0550ae">=</span> graph<span style="color:#0550ae">.</span>compile<span style="color:#1f2328">()</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="4-run-the-graph">4. Run the graph</h3>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>result <span style="color:#0550ae">=</span> app<span style="color:#0550ae">.</span>invoke<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;n&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;number&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Sample result</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Current n: 1 number: 43</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Winning numbers: [43]</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Current n: 2 number: 19</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Winning numbers: [19, 43]</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Current n: 3 number: 9</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Winning numbers: [9, 19, 43]</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Current n: 4 number: 36</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Winning numbers: [9, 19, 36, 43]</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Current n: 5 number: 38</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Winning numbers: [9, 19, 36, 38, 43]</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Current n: 6 number: 37</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Winning numbers: [9, 19, 36, 37, 38, 43]</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><p>Congratulations â€” youâ€™ve just built your first <strong>LangGraph-based deterministic generator</strong>!</p>
<h3 id="5-visualize-the-chain">5. Visualize the chain</h3>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">IPython.display</span> <span style="color:#cf222e">import</span> Image<span style="color:#1f2328">,</span> display
</span></span><span style="display:flex;"><span>display<span style="color:#1f2328">(</span>Image<span style="color:#1f2328">(</span>app<span style="color:#0550ae">.</span>get_graph<span style="color:#1f2328">()</span><span style="color:#0550ae">.</span>draw_mermaid_png<span style="color:#1f2328">()))</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>

































 
  
  





  <img src="/images/mas/mas-toto-generator.png"   alt="mas-toto-generator" class="sc-image sc-image-default"
       >


<p>This diagram clearly illustrates the <code>add â†’ dump â†’ add</code> loop until six numbers are generated.</p>
<h2 id="use-case-2-full-react-agent-with-mcp-tavily--sql">Use Case 2: Full ReAct Agent with MCP, Tavily &amp; SQL</h2>
<p>In this section, we significantly expand the system:
A ReAct-style agent equipped with:</p>
<ul>
<li>MCP Toolbox for Postgres (HDB resale data)</li>
<li>Tavily for real-world web search</li>
<li>Custom Python amenities search tool</li>
<li>LangGraph for orchestration</li>
</ul>
<p>This uses the same HDB dataset from my previous article:
ðŸ‘‰ 






  <a href="/posts/2025/11/adk-web-multi-agent-system/" >ADK Web Multi-Agent System</a>
</p>
<p>This use case will showcase the full power of your MCP Toolbox SQL suite combined with Tavily + Python tools, inside a ReAct agent powered by LangGraph.</p>
<h3 id="mcp-toolbox--postgres-configuration">MCP Toolbox â€“ Postgres Configuration</h3>
<p>To unify the various HDB resale datasets, I first combine them:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span><span style="color:#cf222e">TABLE</span><span style="color:#fff"> </span>hdb_combined_resale_flat_prices<span style="color:#fff"> </span><span style="color:#cf222e">AS</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">SELECT</span><span style="color:#fff"> </span><span style="color:#cf222e">month</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>town<span style="color:#1f2328">,</span><span style="color:#fff"> </span>flat_type<span style="color:#1f2328">,</span><span style="color:#fff"> </span>block<span style="color:#1f2328">,</span><span style="color:#fff"> </span>street_name<span style="color:#1f2328">,</span><span style="color:#fff"> </span>storey_range<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">       </span>floor_area_sqm<span style="color:#1f2328">,</span><span style="color:#fff"> </span>flat_model<span style="color:#1f2328">,</span><span style="color:#fff"> </span>lease_commence_date<span style="color:#1f2328">,</span><span style="color:#fff"> </span>resale_price<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">FROM</span><span style="color:#fff"> </span>raw_resale_flat_prices_from_jan_2017_onwards<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">UNION</span><span style="color:#fff"> </span><span style="color:#cf222e">ALL</span><span style="color:#fff"> </span><span style="color:#cf222e">SELECT</span><span style="color:#fff"> </span><span style="color:#0550ae">*</span><span style="color:#fff"> </span><span style="color:#cf222e">FROM</span><span style="color:#fff"> </span>raw_resale_flat_prices_from_jan_2015_to_dec_2016<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">UNION</span><span style="color:#fff"> </span><span style="color:#cf222e">ALL</span><span style="color:#fff"> </span><span style="color:#cf222e">SELECT</span><span style="color:#fff"> </span><span style="color:#0550ae">*</span><span style="color:#fff"> </span><span style="color:#cf222e">FROM</span><span style="color:#fff"> </span>raw_resale_flat_prices_from_mar_2012_to_dec_2014<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">UNION</span><span style="color:#fff"> </span><span style="color:#cf222e">ALL</span><span style="color:#fff"> </span><span style="color:#cf222e">SELECT</span><span style="color:#fff"> </span><span style="color:#0550ae">*</span><span style="color:#fff"> </span><span style="color:#cf222e">FROM</span><span style="color:#fff"> </span>raw_resale_flat_prices_2000_to_feb_2012<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">UNION</span><span style="color:#fff"> </span><span style="color:#cf222e">ALL</span><span style="color:#fff"> </span><span style="color:#cf222e">SELECT</span><span style="color:#fff"> </span><span style="color:#0550ae">*</span><span style="color:#fff"> </span><span style="color:#cf222e">FROM</span><span style="color:#fff"> </span>raw_resale_flat_prices_1990_1999<span style="color:#1f2328">;</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><p>Then I define <code>tools.yaml</code> pointing to my homelab Postgres instance.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#0550ae">sources</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">my-pg-source</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">kind</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>postgres<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">host</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>postgres.local<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">port</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0550ae">5432</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">database</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>postgres<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">user</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>postgres<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">password</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>postgres<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">tools</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">postgres-list-tables</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">kind</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>postgres-list-tables<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">source</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>my-pg-source<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">description</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Retrieves schema information for all or specified tables.<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">execute-sql-tool</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">kind</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>postgres-execute-sql<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">source</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>my-pg-source<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">description</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Executes an arbitrary SQL statement.<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">list-hdb-flats-by-town</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">kind</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>postgres-sql<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">source</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>my-pg-source<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">description</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Returns the latest 5 resale transaction records for flats in a given town.<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">parameters</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>town<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">type</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>string<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">description</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>The town to search for.<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">statement</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#1f2328">&gt;</span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">      SELECT * 
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">      FROM public.hdb_combined_resale_flat_prices t
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">      WHERE t.town ILIKE &#39;%&#39; || $1 || &#39;%&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">      ORDER BY t.month DESC
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">      LIMIT 5;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">count-hdb-flats-by-town</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">kind</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>postgres-sql<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">source</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>my-pg-source<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">description</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Counts the total number of resale transactions in the given town.<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">parameters</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>town<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">type</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>string<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">description</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>The town to count transactions in.<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">statement</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#1f2328">&gt;</span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">      SELECT COUNT(*) AS count
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">      FROM public.hdb_combined_resale_flat_prices t
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">      WHERE t.town ILIKE &#39;%&#39; || $1 || &#39;%&#39;;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">percentile-price-by-town</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">kind</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>postgres-sql<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">source</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>my-pg-source<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">description</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Returns a resale price percentile (median, p90, etc.) for a town.<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">parameters</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>town<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">type</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>string<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">description</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>The town to compute the percentile for.<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>percentile<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">type</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>float<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">description</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>The percentile to compute (0.5 = median).<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">default</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0550ae">0.5</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">statement</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#1f2328">&gt;</span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">      SELECT
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        PERCENTILE_CONT($2) WITHIN GROUP (ORDER BY t.resale_price)
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        AS percentile_price
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">      FROM public.hdb_combined_resale_flat_prices t
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">      WHERE t.town ILIKE &#39;%&#39; || $1 || &#39;%&#39;;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">average-price-by-flat-type</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">kind</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>postgres-sql<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">source</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>my-pg-source<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">description</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Returns the average resale price for a specific flat type, optionally filtered by town.<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">parameters</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>flat_type<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">type</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>string<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">description</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>The flat type (e.g., &#39;3 ROOM&#39;, &#39;4 ROOM&#39;).<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>town<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">type</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>string<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">description</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Optional town filter (default = all towns).<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">default</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;%&#39;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">statement</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#1f2328">&gt;</span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">      SELECT AVG(t.resale_price) AS avg_price
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">      FROM public.hdb_combined_resale_flat_prices t
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">      WHERE t.flat_type = $1
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">      AND t.town ILIKE &#39;%&#39; || $2 || &#39;%&#39;;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">toolsets</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">my-toolset</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>- postgres-list-tables<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>- execute-sql-tool<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>- list-hdb-flats-by-town<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>- count-hdb-flats-by-town<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>- percentile-price-by-town<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>- average-price-by-flat-type</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><p>Running the Toolbox:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#953800">$VERSION</span> <span style="color:#1f2328">=</span> <span style="color:#0a3069">&#34;0.18.0&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">Invoke-WebRequest</span> -Uri <span style="color:#0a3069">&#34;https://storage.googleapis.com/genai-toolbox/v</span><span style="color:#953800">$VERSION</span><span style="color:#0a3069">/windows/amd64/toolbox.exe&#34;</span> -OutFile <span style="color:#0a3069">&#34;toolbox.exe&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">.\</span>toolbox</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="building-the-react-agent-langgraph">Building the ReAct Agent (LangGraph)</h3>
<p>We now construct a full ReAct agent in <code>langgraph_react_agent.ipynb</code>. The flow:</p>
<ul>
<li>Load MCP SQL tools</li>
<li>Load Tavily</li>
<li>Register all tools</li>
<li>Create ReAct prompt</li>
<li>Bind model</li>
<li>Build LangGraph agent</li>
<li>Test with streaming</li>
</ul>
<h4 id="1-imports">1. Imports</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">os</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">json</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">typing</span> <span style="color:#cf222e">import</span> Annotated<span style="color:#1f2328">,</span> Sequence<span style="color:#1f2328">,</span> TypedDict
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">langchain_core.messages</span> <span style="color:#cf222e">import</span> <span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    HumanMessage<span style="color:#1f2328">,</span> AIMessage<span style="color:#1f2328">,</span> BaseMessage<span style="color:#1f2328">,</span> ToolMessage
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">langchain_core.prompts</span> <span style="color:#cf222e">import</span> ChatPromptTemplate<span style="color:#1f2328">,</span> MessagesPlaceholder
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">langchain_openai</span> <span style="color:#cf222e">import</span> ChatOpenAI
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">langchain_tavily</span> <span style="color:#cf222e">import</span> TavilySearch
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">langchain.tools</span> <span style="color:#cf222e">import</span> tool
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">toolbox_langchain</span> <span style="color:#cf222e">import</span> ToolboxClient
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">langgraph.graph</span> <span style="color:#cf222e">import</span> StateGraph<span style="color:#1f2328">,</span> END
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">langgraph.graph.message</span> <span style="color:#cf222e">import</span> add_messages</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="2-async-load-mcp-tools">2. Async Load MCP Tools</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>mcp_client <span style="color:#0550ae">=</span> ToolboxClient<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;http://127.0.0.1:5000&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">load_mcp</span><span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">await</span> mcp_client<span style="color:#0550ae">.</span>aload_toolset<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mcp_tools <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> load_mcp<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Loaded MCP tools:&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">[</span>t<span style="color:#0550ae">.</span>name <span style="color:#cf222e">for</span> t <span style="color:#0550ae">in</span> mcp_tools<span style="color:#1f2328">])</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="3-tavily--amenities-tool">3. Tavily + Amenities Tool</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>tavily <span style="color:#0550ae">=</span> TavilySearch<span style="color:#1f2328">(</span>max_results<span style="color:#0550ae">=</span><span style="color:#0550ae">5</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0550ae">@tool</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">search_hdb_amenities</span><span style="color:#1f2328">(</span>query<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    Search for amenities near an HDB block or town using Tavily.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    Example queries:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    - &#34;amenities near Block 123 Ang Mo Kio&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    - &#34;schools near Bukit Panjang&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    - &#34;supermarkets near Tampines&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    - &#34;parks near Woodlands&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    The tool returns summarized search results.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    formatted_query <span style="color:#0550ae">=</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;amenities around </span><span style="color:#0a3069">{</span>query<span style="color:#0a3069">}</span><span style="color:#0a3069">, Singapore HDB, nearby facilities, schools, supermarkets, malls, transport&#34;</span>
</span></span><span style="display:flex;"><span>    results <span style="color:#0550ae">=</span> tavily<span style="color:#0550ae">.</span>invoke<span style="color:#1f2328">(</span>formatted_query<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> results</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="4-collect-all-tools">4. Collect all tools</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>tools <span style="color:#0550ae">=</span> <span style="color:#1f2328">[</span>tavily<span style="color:#1f2328">,</span> search_hdb_amenities<span style="color:#1f2328">]</span> <span style="color:#0550ae">+</span> mcp_tools
</span></span><span style="display:flex;"><span>tools_by_name <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>t<span style="color:#0550ae">.</span>name<span style="color:#1f2328">:</span> t <span style="color:#cf222e">for</span> t <span style="color:#0550ae">in</span> tools<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;All tools loaded:&#34;</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">list</span><span style="color:#1f2328">(</span>tools_by_name<span style="color:#0550ae">.</span>keys<span style="color:#1f2328">()))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Sample output</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># All tools loaded: [&#39;tavily_search&#39;, &#39;search_hdb_amenities&#39;, &#39;average-price-by-flat-type&#39;, &#39;count-hdb-flats-by-town&#39;, &#39;execute-sql-tool&#39;, &#39;list-hdb-flats-by-town&#39;, &#39;percentile-price-by-town&#39;, &#39;postgres-list-tables&#39;]</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="5-agent-prompt-react">5. Agent Prompt (ReAct)</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>chat_prompt <span style="color:#0550ae">=</span> ChatPromptTemplate<span style="color:#0550ae">.</span>from_messages<span style="color:#1f2328">([</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;system&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">You are an intelligent ReAct-style assistant with access to Postgres SQL (via MCP Toolbox)
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">and real-world web search tools (Tavily + amenities search).
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Use SQL tools for:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">- HDB transactions
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">- resale prices
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">- median / percentile
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">- flat type analysis
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">- town or block queries
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Use search_hdb_amenities for:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">- schools
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">- malls
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">- supermarkets
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">- parks
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">- hospitals
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">- amenities around blocks/towns
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Use Tavily for general external knowledge.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Always:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">1. Think step-by-step
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">2. Choose the correct tool
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">3. Call tools with correct arguments
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">4. Integrate tool output into your answer
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">&#34;&#34;&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    MessagesPlaceholder<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;scratch_pad&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">])</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="6-bind-model-and-tools">6. Bind model and tools</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>MODEL <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;moonshotai/kimi-k2-thinking&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model <span style="color:#0550ae">=</span> ChatOpenAI<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    api_key<span style="color:#0550ae">=</span>os<span style="color:#0550ae">.</span>getenv<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;OPENROUTER_API_KEY&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    base_url<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;https://openrouter.ai/api/v1&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    model<span style="color:#0550ae">=</span>MODEL<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Bind tools for ReAct</span>
</span></span><span style="display:flex;"><span>model_react <span style="color:#0550ae">=</span> chat_prompt <span style="color:#0550ae">|</span> model<span style="color:#0550ae">.</span>bind_tools<span style="color:#1f2328">(</span>tools<span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="7-agent-state-definition">7. Agent State Definition</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">class</span> <span style="color:#1f2328">AgentState</span><span style="color:#1f2328">(</span>TypedDict<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    messages<span style="color:#1f2328">:</span> Annotated<span style="color:#1f2328">[</span>Sequence<span style="color:#1f2328">[</span>BaseMessage<span style="color:#1f2328">],</span> add_messages<span style="color:#1f2328">]</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="8-define-async-model-and-tool-nodes">8. Define Async Model and Tool nodes</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">call_model</span><span style="color:#1f2328">(</span>state<span style="color:#1f2328">:</span> AgentState<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    response <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> model_react<span style="color:#0550ae">.</span>ainvoke<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;scratch_pad&#34;</span><span style="color:#1f2328">:</span> state<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">]})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">[</span>response<span style="color:#1f2328">]}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">tool_node</span><span style="color:#1f2328">(</span>state<span style="color:#1f2328">:</span> AgentState<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    outputs <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>    last <span style="color:#0550ae">=</span> state<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">][</span><span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> tc <span style="color:#0550ae">in</span> last<span style="color:#0550ae">.</span>tool_calls<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        tool <span style="color:#0550ae">=</span> tools_by_name<span style="color:#1f2328">[</span>tc<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;name&#34;</span><span style="color:#1f2328">]]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># All toolbox_langchain tools support .ainvoke()</span>
</span></span><span style="display:flex;"><span>        result <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> tool<span style="color:#0550ae">.</span>ainvoke<span style="color:#1f2328">(</span>tc<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;args&#34;</span><span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        outputs<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>            ToolMessage<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                content<span style="color:#0550ae">=</span>json<span style="color:#0550ae">.</span>dumps<span style="color:#1f2328">(</span>result<span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>                name<span style="color:#0550ae">=</span>tc<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;name&#34;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>                tool_call_id<span style="color:#0550ae">=</span>tc<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;id&#34;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">:</span> outputs<span style="color:#1f2328">}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="9-continue--end-decision-node">9. Continue / End Decision Node</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">should_continue</span><span style="color:#1f2328">(</span>state<span style="color:#1f2328">:</span> AgentState<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    last <span style="color:#0550ae">=</span> state<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">][</span><span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> last<span style="color:#0550ae">.</span>tool_calls<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#0a3069">&#34;continue&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0a3069">&#34;end&#34;</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="10-build-langgraph-async-model">10. Build LangGraph (Async Model)</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>workflow <span style="color:#0550ae">=</span> StateGraph<span style="color:#1f2328">(</span>AgentState<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>workflow<span style="color:#0550ae">.</span>add_node<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;agent&#34;</span><span style="color:#1f2328">,</span> call_model<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>workflow<span style="color:#0550ae">.</span>add_node<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;tools&#34;</span><span style="color:#1f2328">,</span> tool_node<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>workflow<span style="color:#0550ae">.</span>add_edge<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;tools&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;agent&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>workflow<span style="color:#0550ae">.</span>add_conditional_edges<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;agent&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    should_continue<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;continue&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;tools&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;end&#34;</span><span style="color:#1f2328">:</span> END<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>workflow<span style="color:#0550ae">.</span>set_entry_point<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;agent&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>graph <span style="color:#0550ae">=</span> workflow<span style="color:#0550ae">.</span>compile<span style="color:#1f2328">()</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="11-run-the-agent-async-streaming">11. Run the agent (Async Streaming)</h4>
<p><em>Test 1 â€” Resale Transactions</em></p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>inputs <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">[</span>
</span></span><span style="display:flex;"><span>        HumanMessage<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Get me the past resale transactions for block 100 in Toa Payoh.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">for</span> step <span style="color:#0550ae">in</span> graph<span style="color:#0550ae">.</span>astream<span style="color:#1f2328">(</span>inputs<span style="color:#1f2328">,</span> stream_mode<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;values&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    step<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">][</span><span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>pretty_print<span style="color:#1f2328">()</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>

































 
  
  





  <img src="/images/mas/mas-react-agent-test-resale-prices.png"   alt="mas-react-agent-test-resale-prices" class="sc-image sc-image-default"
       >


<p><em>Test 2 â€” Amenities Around an HDB Block</em></p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>inputs <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">[</span>
</span></span><span style="display:flex;"><span>        HumanMessage<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;What amenities are near Block 110 in Toa Payoh?&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">for</span> step <span style="color:#0550ae">in</span> graph<span style="color:#0550ae">.</span>astream<span style="color:#1f2328">(</span>inputs<span style="color:#1f2328">,</span> stream_mode<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;values&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    step<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">][</span><span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>pretty_print<span style="color:#1f2328">()</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>

































 
  
  





  <img src="/images/mas/mas-react-agent-test-amenities.png"   alt="mas-react-agent-test-amenities" class="sc-image sc-image-default"
       >


<h4 id="12-display-mermaid-diagram">12. Display Mermaid Diagram</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">IPython.display</span> <span style="color:#cf222e">import</span> Image<span style="color:#1f2328">,</span> display
</span></span><span style="display:flex;"><span>display<span style="color:#1f2328">(</span>Image<span style="color:#1f2328">(</span>graph<span style="color:#0550ae">.</span>get_graph<span style="color:#1f2328">()</span><span style="color:#0550ae">.</span>draw_mermaid_png<span style="color:#1f2328">()))</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>

































 
  
  





  <img src="/images/mas/mas-react-agent-mermaid.png"   alt="mas-react-agent-mermaid" class="sc-image sc-image-default"
       >


<h2 id="use-case-3-multi-agent-system-supervisor--specialist-agents">Use Case 3: Multi-Agent System (Supervisor + Specialist Agents)</h2>
<p>The final and most sophisticated part of this post, a fully modular <strong>multi-agent system</strong> (MAS) built purely with LangGraph.</p>
<h3 id="architecture-overview">Architecture Overview</h3>
<ul>
<li><strong>Supervisor Agent</strong>: Routes queries to one of the specialist agents.</li>
<li><strong>SQL Agent</strong>: Uses MCP Toolbox Postgres tools for HDB analysis.</li>
<li><strong>Amenities Agent</strong>: Uses Tavily + custom amenities search.</li>
<li><strong>Web Agent</strong>: Handles all general knowledge queries.</li>
</ul>
<p>This division keeps each agent <strong>focused</strong>, <strong>predictable</strong>, and <strong>auditable</strong>.<br>
I implement this in a new notebook <code>langgraph_mas.ipynb</code>.</p>
<h4 id="1-imports-1">1. Imports</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">os</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">json</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">typing</span> <span style="color:#cf222e">import</span> Annotated<span style="color:#1f2328">,</span> Sequence<span style="color:#1f2328">,</span> TypedDict
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">langchain_core.messages</span> <span style="color:#cf222e">import</span> <span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    HumanMessage<span style="color:#1f2328">,</span> AIMessage<span style="color:#1f2328">,</span> BaseMessage<span style="color:#1f2328">,</span> ToolMessage
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">langchain_core.prompts</span> <span style="color:#cf222e">import</span> ChatPromptTemplate<span style="color:#1f2328">,</span> MessagesPlaceholder
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">langchain.tools</span> <span style="color:#cf222e">import</span> tool
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">langchain_tavily</span> <span style="color:#cf222e">import</span> TavilySearch
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">langchain_openai</span> <span style="color:#cf222e">import</span> ChatOpenAI
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">toolbox_langchain</span> <span style="color:#cf222e">import</span> ToolboxClient
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">langgraph.graph</span> <span style="color:#cf222e">import</span> StateGraph<span style="color:#1f2328">,</span> END
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">langgraph.graph.message</span> <span style="color:#cf222e">import</span> add_messages</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="2-async-load-mcp-tools-1">2. Async Load MCP Tools</h3>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>mcp_client <span style="color:#0550ae">=</span> ToolboxClient<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;http://127.0.0.1:5000&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">load_mcp_tools</span><span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">await</span> mcp_client<span style="color:#0550ae">.</span>aload_toolset<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mcp_tools <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> load_mcp_tools<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Loaded MCP tools:&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">[</span>t<span style="color:#0550ae">.</span>name <span style="color:#cf222e">for</span> t <span style="color:#0550ae">in</span> mcp_tools<span style="color:#1f2328">])</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="3-shared-tools-tavily--amenities">3. Shared Tools (Tavily &amp; Amenities)</h3>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>tavily <span style="color:#0550ae">=</span> TavilySearch<span style="color:#1f2328">(</span>max_results<span style="color:#0550ae">=</span><span style="color:#0550ae">5</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0550ae">@tool</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">search_hdb_amenities</span><span style="color:#1f2328">(</span>query<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    Search for amenities near an HDB block or town using Tavily.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    Example queries:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    - &#34;amenities near Block 123 Ang Mo Kio&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    - &#34;schools near Bukit Panjang&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    - &#34;supermarkets near Tampines&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    - &#34;parks near Woodlands&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    The tool returns summarized search results.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    formatted_query <span style="color:#0550ae">=</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;amenities around </span><span style="color:#0a3069">{</span>query<span style="color:#0a3069">}</span><span style="color:#0a3069">, Singapore HDB, nearby facilities, schools, supermarkets, malls, transport&#34;</span>
</span></span><span style="display:flex;"><span>    results <span style="color:#0550ae">=</span> tavily<span style="color:#0550ae">.</span>invoke<span style="color:#1f2328">(</span>formatted_query<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> results</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="4-tool-registry">4. Tool Registry</h3>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>all_tools <span style="color:#0550ae">=</span> mcp_tools <span style="color:#0550ae">+</span> <span style="color:#1f2328">[</span>tavily<span style="color:#1f2328">,</span> search_hdb_amenities<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>tools_by_name <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>t<span style="color:#0550ae">.</span>name<span style="color:#1f2328">:</span> t <span style="color:#cf222e">for</span> t <span style="color:#0550ae">in</span> all_tools<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;All tools:&#34;</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">list</span><span style="color:#1f2328">(</span>tools_by_name<span style="color:#0550ae">.</span>keys<span style="color:#1f2328">()))</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="5-agent-state">5. Agent State</h3>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">class</span> <span style="color:#1f2328">AgentState</span><span style="color:#1f2328">(</span>TypedDict<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    messages<span style="color:#1f2328">:</span> Annotated<span style="color:#1f2328">[</span>Sequence<span style="color:#1f2328">[</span>BaseMessage<span style="color:#1f2328">],</span> add_messages<span style="color:#1f2328">]</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="6-define-3-specialist-agents-sql-amenities-web-search">6. Define 3 Specialist Agents (SQL, Amenities, Web Search)</h3>
<h4 id="61-sql-agent-prompt">6.1 SQL Agent Prompt</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sql_prompt <span style="color:#0550ae">=</span> ChatPromptTemplate<span style="color:#0550ae">.</span>from_messages<span style="color:#1f2328">([</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;system&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">SQL Agent.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">You answer only questions requiring HDB resale data or stats.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Use MCP SQL tools ONLY.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Always return structured, correct SQL tool calls.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">&#34;&#34;&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    MessagesPlaceholder<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;scratch_pad&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">])</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="62-amenities-agent-prompt">6.2 Amenities Agent Prompt</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>amenities_prompt <span style="color:#0550ae">=</span> ChatPromptTemplate<span style="color:#0550ae">.</span>from_messages<span style="color:#1f2328">([</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;system&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Amenities Agent.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Use `search_hdb_amenities` first.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Use Tavily for deeper context.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">You answer:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">- amenities
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">- schools
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">- malls
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">- MRT
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">- supermarkets
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">near a block or town.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">&#34;&#34;&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    MessagesPlaceholder<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;scratch_pad&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">])</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="63-web-research-agent-prompt">6.3 Web Research Agent Prompt</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>web_prompt <span style="color:#0550ae">=</span> ChatPromptTemplate<span style="color:#0550ae">.</span>from_messages<span style="color:#1f2328">([</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;system&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Web Research Agent.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Use Tavily search for general knowledge or non-HDB topics.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">&#34;&#34;&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    MessagesPlaceholder<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;scratch_pad&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">])</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="7-bind-each-model-to-its-specialist-prompt">7. Bind each model to its specialist prompt</h3>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>MODEL <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;moonshotai/kimi-k2-thinking&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">build_model</span><span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> ChatOpenAI<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        api_key<span style="color:#0550ae">=</span>os<span style="color:#0550ae">.</span>getenv<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;OPENROUTER_API_KEY&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        base_url<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;https://openrouter.ai/api/v1&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        model<span style="color:#0550ae">=</span>MODEL<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sql_agent <span style="color:#0550ae">=</span> sql_prompt <span style="color:#0550ae">|</span> build_model<span style="color:#1f2328">()</span><span style="color:#0550ae">.</span>bind_tools<span style="color:#1f2328">(</span>mcp_tools<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>amenities_agent <span style="color:#0550ae">=</span> amenities_prompt <span style="color:#0550ae">|</span> build_model<span style="color:#1f2328">()</span><span style="color:#0550ae">.</span>bind_tools<span style="color:#1f2328">([</span>search_hdb_amenities<span style="color:#1f2328">,</span> tavily<span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>web_agent <span style="color:#0550ae">=</span> web_prompt <span style="color:#0550ae">|</span> build_model<span style="color:#1f2328">()</span><span style="color:#0550ae">.</span>bind_tools<span style="color:#1f2328">([</span>tavily<span style="color:#1f2328">])</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="8-supervisor-router">8. Supervisor Router</h3>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>supervisor_prompt <span style="color:#0550ae">=</span> ChatPromptTemplate<span style="color:#0550ae">.</span>from_messages<span style="color:#1f2328">([</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;system&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">You are the Supervisor.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">ROUTE the user query to one agent:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">- SQL_AGENT for resale/transaction/statistics queries
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">- AMENITIES_AGENT for amenities/schools/MRT/malls
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">- WEB_AGENT for general queries
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Respond with ONLY one of:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">SQL_AGENT
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">AMENITIES_AGENT
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">WEB_AGENT
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">&#34;&#34;&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    MessagesPlaceholder<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>router_model <span style="color:#0550ae">=</span> build_model<span style="color:#1f2328">()</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="9-supervisor-node">9. Supervisor Node</h3>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">router_node</span><span style="color:#1f2328">(</span>state<span style="color:#1f2328">:</span> AgentState<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    decision <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> router_model<span style="color:#0550ae">.</span>ainvoke<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        supervisor_prompt<span style="color:#0550ae">.</span>format<span style="color:#1f2328">(</span>messages<span style="color:#0550ae">=</span>state<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    route <span style="color:#0550ae">=</span> decision<span style="color:#0550ae">.</span>content<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()</span><span style="color:#0550ae">.</span>upper<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> route <span style="color:#0550ae">not</span> <span style="color:#0550ae">in</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;SQL_AGENT&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;AMENITIES_AGENT&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;WEB_AGENT&#34;</span><span style="color:#1f2328">}:</span>
</span></span><span style="display:flex;"><span>        route <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;WEB_AGENT&#34;</span>     <span style="color:#57606a"># fallback so KeyError never happens</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;next_agent&#34;</span><span style="color:#1f2328">:</span> route<span style="color:#1f2328">}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="10-shared-tool-node-async">10. Shared Tool Node (Async)</h3>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">tool_node</span><span style="color:#1f2328">(</span>state<span style="color:#1f2328">:</span> AgentState<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    last <span style="color:#0550ae">=</span> state<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">][</span><span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    outputs <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> tc <span style="color:#0550ae">in</span> last<span style="color:#0550ae">.</span>tool_calls<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        tool <span style="color:#0550ae">=</span> tools_by_name<span style="color:#1f2328">[</span>tc<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;name&#34;</span><span style="color:#1f2328">]]</span>
</span></span><span style="display:flex;"><span>        result <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> tool<span style="color:#0550ae">.</span>ainvoke<span style="color:#1f2328">(</span>tc<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;args&#34;</span><span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        outputs<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>ToolMessage<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>            content<span style="color:#0550ae">=</span>json<span style="color:#0550ae">.</span>dumps<span style="color:#1f2328">(</span>result<span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>            name<span style="color:#0550ae">=</span>tc<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;name&#34;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>            tool_call_id<span style="color:#0550ae">=</span>tc<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;id&#34;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">:</span> outputs<span style="color:#1f2328">}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="11-generic-model-execution-wrapper">11. Generic model execution wrapper</h3>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">run_agent</span><span style="color:#1f2328">(</span>agent<span style="color:#1f2328">,</span> state<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    response <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> agent<span style="color:#0550ae">.</span>ainvoke<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;scratch_pad&#34;</span><span style="color:#1f2328">:</span> state<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">]})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">[</span>response<span style="color:#1f2328">]}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="12-full-multi-agent-graph">12. Full Multi-Agent Graph</h3>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#57606a"># Specialist agent wrappers</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">sql_agent_node</span><span style="color:#1f2328">(</span>state<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">await</span> run_agent<span style="color:#1f2328">(</span>sql_agent<span style="color:#1f2328">,</span> state<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">amenities_agent_node</span><span style="color:#1f2328">(</span>state<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">await</span> run_agent<span style="color:#1f2328">(</span>amenities_agent<span style="color:#1f2328">,</span> state<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">web_agent_node</span><span style="color:#1f2328">(</span>state<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">await</span> run_agent<span style="color:#1f2328">(</span>web_agent<span style="color:#1f2328">,</span> state<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>workflow <span style="color:#0550ae">=</span> StateGraph<span style="color:#1f2328">(</span>AgentState<span style="color:#1f2328">,</span> async_mode<span style="color:#0550ae">=</span><span style="color:#cf222e">True</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Register nodes</span>
</span></span><span style="display:flex;"><span>workflow<span style="color:#0550ae">.</span>add_node<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;ROUTER&#34;</span><span style="color:#1f2328">,</span> router_node<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>workflow<span style="color:#0550ae">.</span>add_node<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;SQL_AGENT&#34;</span><span style="color:#1f2328">,</span> sql_agent_node<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>workflow<span style="color:#0550ae">.</span>add_node<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;AMENITIES_AGENT&#34;</span><span style="color:#1f2328">,</span> amenities_agent_node<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>workflow<span style="color:#0550ae">.</span>add_node<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;WEB_AGENT&#34;</span><span style="color:#1f2328">,</span> web_agent_node<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>workflow<span style="color:#0550ae">.</span>add_node<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;TOOLS&#34;</span><span style="color:#1f2328">,</span> tool_node<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Each agent â†’ decide continue or end</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">next_step</span><span style="color:#1f2328">(</span>state<span style="color:#1f2328">:</span> AgentState<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    last <span style="color:#0550ae">=</span> state<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">][</span><span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0a3069">&#34;TOOLS&#34;</span> <span style="color:#cf222e">if</span> last<span style="color:#0550ae">.</span>tool_calls <span style="color:#cf222e">else</span> END
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>workflow<span style="color:#0550ae">.</span>add_conditional_edges<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;SQL_AGENT&#34;</span><span style="color:#1f2328">,</span> next_step<span style="color:#1f2328">,</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;TOOLS&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;TOOLS&#34;</span><span style="color:#1f2328">,</span> END<span style="color:#1f2328">:</span> END<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>workflow<span style="color:#0550ae">.</span>add_conditional_edges<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;AMENITIES_AGENT&#34;</span><span style="color:#1f2328">,</span> next_step<span style="color:#1f2328">,</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;TOOLS&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;TOOLS&#34;</span><span style="color:#1f2328">,</span> END<span style="color:#1f2328">:</span> END<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>workflow<span style="color:#0550ae">.</span>add_conditional_edges<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;WEB_AGENT&#34;</span><span style="color:#1f2328">,</span> next_step<span style="color:#1f2328">,</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;TOOLS&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;TOOLS&#34;</span><span style="color:#1f2328">,</span> END<span style="color:#1f2328">:</span> END<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Supervisor decides next hop</span>
</span></span><span style="display:flex;"><span>workflow<span style="color:#0550ae">.</span>add_conditional_edges<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;ROUTER&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">lambda</span> out<span style="color:#1f2328">:</span> out<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;next_agent&#34;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;SQL_AGENT&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;SQL_AGENT&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;AMENITIES_AGENT&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;AMENITIES_AGENT&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;WEB_AGENT&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;WEB_AGENT&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>workflow<span style="color:#0550ae">.</span>add_edge<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;TOOLS&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;ROUTER&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>workflow<span style="color:#0550ae">.</span>set_entry_point<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;ROUTER&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>graph <span style="color:#0550ae">=</span> workflow<span style="color:#0550ae">.</span>compile<span style="color:#1f2328">()</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><p>This is the full multi-agent system!</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">IPython.display</span> <span style="color:#cf222e">import</span> Image<span style="color:#1f2328">,</span> display
</span></span><span style="display:flex;"><span>display<span style="color:#1f2328">(</span>Image<span style="color:#1f2328">(</span>graph<span style="color:#0550ae">.</span>get_graph<span style="color:#1f2328">()</span><span style="color:#0550ae">.</span>draw_mermaid_png<span style="color:#1f2328">()))</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>

































 
  
  





  <img src="/images/mas/mas-multi-agent-system-mermaid.png"   alt="mas-multi-agent-system-mermaid" class="sc-image sc-image-default"
       >


<h3 id="13-examples--mas-in-action">13. Examples â€” MAS in Action</h3>
<h4 id="amenities-example">Amenities Example</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>inputs <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">[</span>
</span></span><span style="display:flex;"><span>        HumanMessage<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;What amenities are near Block 110 in Toa Payoh?&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">for</span> step <span style="color:#0550ae">in</span> graph<span style="color:#0550ae">.</span>astream<span style="color:#1f2328">(</span>inputs<span style="color:#1f2328">,</span> stream_mode<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;values&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    step<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">][</span><span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>pretty_print<span style="color:#1f2328">()</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>

































 
  
  





  <img src="/images/mas/mas-multi-agent-system-test-amenities1.png"   alt="mas-multi-agent-system-test-amenities1" class="sc-image sc-image-default"
       >




































 
  
  





  <img src="/images/mas/mas-multi-agent-system-test-amenities2.png"   alt="mas-multi-agent-system-test-amenities2" class="sc-image sc-image-default"
       >




































 
  
  





  <img src="/images/mas/mas-multi-agent-system-test-amenities3.png"   alt="mas-multi-agent-system-test-amenities3" class="sc-image sc-image-default"
       >




































 
  
  





  <img src="/images/mas/mas-multi-agent-system-test-amenities4.png"   alt="mas-multi-agent-system-test-amenities4" class="sc-image sc-image-default"
       >


<h4 id="resale-price-median-example">Resale Price (Median) Example</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">for</span> step <span style="color:#0550ae">in</span> graph<span style="color:#0550ae">.</span>astream<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">[</span>HumanMessage<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Show me the median resale price of 4-room flats in Bishan.&#34;</span><span style="color:#1f2328">)]},</span>
</span></span><span style="display:flex;"><span>    stream_mode<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;values&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    step<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">][</span><span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>pretty_print<span style="color:#1f2328">()</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>

































 
  
  





  <img src="/images/mas/mas-multi-agent-system-test-resale-prices.png"   alt="mas-multi-agent-system-test-resale-prices" class="sc-image sc-image-default"
       >



<div class="admonition note">
  <div class="admonition-heading">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="currentColor" class="admonition-icon">
      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 15c-.55 0-1-.45-1-1v-4c0-.55.45-1 1-1s1 .45 1 1v4c0 .55-.45 1-1 1zm1-8h-2V7h2v2z"/>
    </svg>
    <span class="admonition-title">Note</span>
  </div>
  <div class="admonition-content">
    <p>Security Considerations (SQL Tool): <strong>execute-sql-tool</strong></p>
<p><strong>Level 1:</strong> Prompt-based guardrail (not bulletproof though)</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sql_prompt <span style="color:#0550ae">=</span> ChatPromptTemplate<span style="color:#0550ae">.</span>from_messages<span style="color:#1f2328">([</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;system&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">SQL Agent.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">SAFETY RULES:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">- You may ONLY generate SELECT queries.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">- You MUST NOT use DROP, DELETE, UPDATE, INSERT, ALTER, CREATE, TRUNCATE,
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">  GRANT, REVOKE, or any DDL/DML statements.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">- You MUST NOT modify the database in any way.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">- You MUST ONLY query the hdb_combined_resale_flat_prices table.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">- If the user asks for anything involving modification, deny politely.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">&#34;&#34;&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    MessagesPlaceholder<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;scratch_pad&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">])</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><p><strong>Level 2:</strong> Filter SQL before execution</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>FORBIDDEN <span style="color:#0550ae">=</span> <span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;drop&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;delete&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;truncate&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;alter&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;insert&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;update&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;grant&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;revoke&#34;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">is_safe_sql</span><span style="color:#1f2328">(</span>sql<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#6639ba">bool</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    s <span style="color:#0550ae">=</span> sql<span style="color:#0550ae">.</span>lower<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">not</span> <span style="color:#6639ba">any</span><span style="color:#1f2328">(</span>word <span style="color:#0550ae">in</span> s <span style="color:#cf222e">for</span> word <span style="color:#0550ae">in</span> FORBIDDEN<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Stops malicious execution</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">if</span> tc<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;name&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;execute-sql-tool&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    sql <span style="color:#0550ae">=</span> tc<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;args&#34;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;sql&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> is_safe_sql<span style="color:#1f2328">(</span>sql<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">raise</span> ValueError<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Unsafe SQL detected: </span><span style="color:#0a3069">{</span>sql<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><p><strong>Level 3:</strong> Remove execute-sql-tool entirely (for production system)</p>

  </div>
</div>
<h2 id="optional-deploying-to-langgraph-platform-langsmith-studio">Optional: Deploying to LangGraph Platform (LangSmith Studio)</h2>
<p>






  <a href="https://docs.langchain.com/langsmith/quick-start-studio" target="_blank" rel="noopener noreferrer" >LangSmith Studio</a>
 is a specialized agent ID that enables visualization, interaction, and debugging of agentic systems that implement the Agent Server API protocol.</p>
<ol>
<li>Install LangGraph CLI:</li>
</ol>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>uv add <span style="color:#6639ba">langgraph-cli</span><span style="color:#1f2328">[</span><span style="color:#0550ae">inmem</span><span style="color:#1f2328">]</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><ol start="2">
<li>Create a new LangGraph app</li>
</ol>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>langgraph new app</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>

































 
  
  





  <img src="/images/mas/mas-multi-agent-system-create-app.png"   alt="mas-multi-agent-system-create-app" class="sc-image sc-image-default"
       >


<ol start="3">
<li>Install dependencies</li>
</ol>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#6639ba">cd </span>app
</span></span><span style="display:flex;"><span>python -m venv venv
</span></span><span style="display:flex;"><span><span style="color:#1f2328">.\</span>venv<span style="color:#1f2328">\</span>Scripts<span style="color:#1f2328">\</span>Activate
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pip install -e <span style="color:#1f2328">.</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><ol start="4">
<li>Creates the MAS Agent</li>
</ol>
<p>Paste these into <code>src/agent/graph.py</code> and add the <em>LANGSSMITH_API_KEY</em> env var:</p>

<details class="details-shortcode " >
  <summary class="details-shortcode__summary">
    src/agent/graph.py
  </summary>
  <div class="details-shortcode__content">
    
    
    





<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">os</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">json</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">asyncio</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">sys</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">typing</span> <span style="color:#cf222e">import</span> Annotated<span style="color:#1f2328">,</span> Sequence<span style="color:#1f2328">,</span> TypedDict
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">langchain_core.messages</span> <span style="color:#cf222e">import</span> <span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    HumanMessage<span style="color:#1f2328">,</span> AIMessage<span style="color:#1f2328">,</span> BaseMessage<span style="color:#1f2328">,</span> ToolMessage
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Fix Windows event loop issue</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">if</span> sys<span style="color:#0550ae">.</span>platform <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;win32&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    asyncio<span style="color:#0550ae">.</span>set_event_loop_policy<span style="color:#1f2328">(</span>asyncio<span style="color:#0550ae">.</span>WindowsSelectorEventLoopPolicy<span style="color:#1f2328">())</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">langchain_core.prompts</span> <span style="color:#cf222e">import</span> ChatPromptTemplate<span style="color:#1f2328">,</span> MessagesPlaceholder
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">langchain.tools</span> <span style="color:#cf222e">import</span> tool
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">langchain_tavily</span> <span style="color:#cf222e">import</span> TavilySearch
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">langchain_openai</span> <span style="color:#cf222e">import</span> ChatOpenAI
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">toolbox_langchain</span> <span style="color:#cf222e">import</span> ToolboxClient
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">langgraph.graph</span> <span style="color:#cf222e">import</span> StateGraph<span style="color:#1f2328">,</span> END
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">langgraph.graph.message</span> <span style="color:#cf222e">import</span> add_messages
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ----------------------------- </span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Global state for MCP tools</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ----------------------------- </span>
</span></span><span style="display:flex;"><span>_mcp_tools <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>_toolbox_client <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>_client_lock <span style="color:#0550ae">=</span> asyncio<span style="color:#0550ae">.</span>Lock<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">get_mcp_tools</span><span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;Lazy load MCP tools on first use with connection pooling&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">global</span> _mcp_tools<span style="color:#1f2328">,</span> _toolbox_client
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">async</span> <span style="color:#cf222e">with</span> _client_lock<span style="color:#1f2328">:</span>  <span style="color:#57606a"># Prevent concurrent initialization</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> _mcp_tools <span style="color:#0550ae">is</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># Move blocking ToolboxClient to separate thread</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">def</span> <span style="color:#6639ba">_create_client</span><span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">return</span> ToolboxClient<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;http://127.0.0.1:5000&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                _toolbox_client <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> asyncio<span style="color:#0550ae">.</span>to_thread<span style="color:#1f2328">(</span>_create_client<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># Try aload_toolset first, fall back to load_toolset</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> <span style="color:#6639ba">hasattr</span><span style="color:#1f2328">(</span>_toolbox_client<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;aload_toolset&#39;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                    _mcp_tools <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> asyncio<span style="color:#0550ae">.</span>wait_for<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                        _toolbox_client<span style="color:#0550ae">.</span>aload_toolset<span style="color:#1f2328">(),</span>
</span></span><span style="display:flex;"><span>                        timeout<span style="color:#0550ae">=</span><span style="color:#0550ae">30</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    _mcp_tools <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> asyncio<span style="color:#0550ae">.</span>wait_for<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                        _toolbox_client<span style="color:#0550ae">.</span>load_toolset<span style="color:#1f2328">(),</span>
</span></span><span style="display:flex;"><span>                        timeout<span style="color:#0550ae">=</span><span style="color:#0550ae">30</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Loaded </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>_mcp_tools<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> MCP tools&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">except</span> asyncio<span style="color:#0550ae">.</span>TimeoutError<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;MCP tools loading timed out&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                _mcp_tools <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Failed to load MCP tools: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                _mcp_tools <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> _mcp_tools
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ----------------------------- </span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Tavily</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ----------------------------- </span>
</span></span><span style="display:flex;"><span>tavily <span style="color:#0550ae">=</span> TavilySearch<span style="color:#1f2328">(</span>max_results<span style="color:#0550ae">=</span><span style="color:#0550ae">5</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ----------------------------- </span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Custom amenity search tool</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ----------------------------- </span>
</span></span><span style="display:flex;"><span><span style="color:#0550ae">@tool</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">search_hdb_amenities</span><span style="color:#1f2328">(</span>query<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;Search for amenities near an HDB block or town using Tavily.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    Example queries:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    - &#34;amenities near Block 123 Ang Mo Kio&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    - &#34;schools near Bukit Panjang&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    - &#34;supermarkets near Tampines&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    - &#34;parks near Woodlands&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    formatted_query <span style="color:#0550ae">=</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;amenities around </span><span style="color:#0a3069">{</span>query<span style="color:#0a3069">}</span><span style="color:#0a3069">, Singapore HDB, nearby facilities, schools, supermarkets, malls, transport&#34;</span>
</span></span><span style="display:flex;"><span>    results <span style="color:#0550ae">=</span> tavily<span style="color:#0550ae">.</span>invoke<span style="color:#1f2328">(</span>formatted_query<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> results
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ----------------------------- </span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># STATE</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ----------------------------- </span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">class</span> <span style="color:#1f2328">AgentState</span><span style="color:#1f2328">(</span>TypedDict<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    messages<span style="color:#1f2328">:</span> Annotated<span style="color:#1f2328">[</span>Sequence<span style="color:#1f2328">[</span>BaseMessage<span style="color:#1f2328">],</span> add_messages<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ----------------------------- </span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># PROMPTS</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ----------------------------- </span>
</span></span><span style="display:flex;"><span>sql_prompt <span style="color:#0550ae">=</span> ChatPromptTemplate<span style="color:#0550ae">.</span>from_messages<span style="color:#1f2328">([</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;system&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;&#34;SQL Agent. You answer only questions requiring HDB resale data or stats.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Use MCP SQL tools ONLY. Always return structured, correct SQL tool calls.&#34;&#34;&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    MessagesPlaceholder<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;scratch_pad&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>amenities_prompt <span style="color:#0550ae">=</span> ChatPromptTemplate<span style="color:#0550ae">.</span>from_messages<span style="color:#1f2328">([</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;system&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;&#34;Amenities Agent. Use search_hdb_amenities first. Use Tavily for deeper context.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">You answer: amenities, schools, malls, MRT, supermarkets near a block or town.&#34;&#34;&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    MessagesPlaceholder<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;scratch_pad&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>web_prompt <span style="color:#0550ae">=</span> ChatPromptTemplate<span style="color:#0550ae">.</span>from_messages<span style="color:#1f2328">([</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;system&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;&#34;Web Research Agent. Use Tavily search for general knowledge or non-HDB topics.&#34;&#34;&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    MessagesPlaceholder<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;scratch_pad&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ----------------------------- </span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># MODEL FACTORY</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ----------------------------- </span>
</span></span><span style="display:flex;"><span>MODEL <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;moonshotai/kimi-k2-thinking&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">build_model</span><span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> ChatOpenAI<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        api_key<span style="color:#0550ae">=</span>os<span style="color:#0550ae">.</span>getenv<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;OPENROUTER_API_KEY&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        base_url<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;https://openrouter.ai/api/v1&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        model<span style="color:#0550ae">=</span>MODEL<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ----------------------------- </span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># AGENTS (built dynamically with tools)</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ----------------------------- </span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">build_agents</span><span style="color:#1f2328">(</span>mcp_tools<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;Build agents with available tools&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    sql_agent <span style="color:#0550ae">=</span> sql_prompt <span style="color:#0550ae">|</span> build_model<span style="color:#1f2328">()</span><span style="color:#0550ae">.</span>bind_tools<span style="color:#1f2328">(</span>mcp_tools<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    amenities_agent <span style="color:#0550ae">=</span> amenities_prompt <span style="color:#0550ae">|</span> build_model<span style="color:#1f2328">()</span><span style="color:#0550ae">.</span>bind_tools<span style="color:#1f2328">([</span>search_hdb_amenities<span style="color:#1f2328">,</span> tavily<span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>    web_agent <span style="color:#0550ae">=</span> web_prompt <span style="color:#0550ae">|</span> build_model<span style="color:#1f2328">()</span><span style="color:#0550ae">.</span>bind_tools<span style="color:#1f2328">([</span>tavily<span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> sql_agent<span style="color:#1f2328">,</span> amenities_agent<span style="color:#1f2328">,</span> web_agent
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ----------------------------- </span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ROUTER NODE</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ----------------------------- </span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">router_node</span><span style="color:#1f2328">(</span>state<span style="color:#1f2328">:</span> AgentState<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;Route to appropriate agent&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    router_model <span style="color:#0550ae">=</span> build_model<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    supervisor_prompt <span style="color:#0550ae">=</span> ChatPromptTemplate<span style="color:#0550ae">.</span>from_messages<span style="color:#1f2328">([</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;system&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;&#34;You are the Supervisor. ROUTE the user query to one agent:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">- SQL_AGENT for resale/transaction/statistics queries
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">- AMENITIES_AGENT for amenities/schools/MRT/malls
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">- WEB_AGENT for general queries
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">Respond with ONLY one of: SQL_AGENT AMENITIES_AGENT WEB_AGENT&#34;&#34;&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>        MessagesPlaceholder<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    chain <span style="color:#0550ae">=</span> supervisor_prompt <span style="color:#0550ae">|</span> router_model
</span></span><span style="display:flex;"><span>    decision <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> chain<span style="color:#0550ae">.</span>ainvoke<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">:</span> state<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">]})</span>
</span></span><span style="display:flex;"><span>    route <span style="color:#0550ae">=</span> decision<span style="color:#0550ae">.</span>content<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()</span><span style="color:#0550ae">.</span>upper<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> route <span style="color:#0550ae">not</span> <span style="color:#0550ae">in</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;SQL_AGENT&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;AMENITIES_AGENT&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;WEB_AGENT&#34;</span><span style="color:#1f2328">}:</span>
</span></span><span style="display:flex;"><span>        route <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;WEB_AGENT&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;next_agent&#34;</span><span style="color:#1f2328">:</span> route<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ----------------------------- </span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># TOOL EXECUTION NODE</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ----------------------------- </span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">execute_tool_with_retry</span><span style="color:#1f2328">(</span>tool<span style="color:#1f2328">,</span> tool_name<span style="color:#1f2328">,</span> args<span style="color:#1f2328">,</span> max_retries<span style="color:#0550ae">=</span><span style="color:#0550ae">2</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;Execute tool with exponential backoff retry&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> attempt <span style="color:#0550ae">in</span> <span style="color:#6639ba">range</span><span style="color:#1f2328">(</span>max_retries <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;    Attempt </span><span style="color:#0a3069">{</span>attempt <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span><span style="color:#0a3069">}</span><span style="color:#0a3069">/</span><span style="color:#0a3069">{</span>max_retries <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span><span style="color:#0a3069">}</span><span style="color:#0a3069">...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#6639ba">hasattr</span><span style="color:#1f2328">(</span>tool<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;ainvoke&#39;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                result <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> asyncio<span style="color:#0550ae">.</span>wait_for<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                    tool<span style="color:#0550ae">.</span>ainvoke<span style="color:#1f2328">(</span>args<span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>                    timeout<span style="color:#0550ae">=</span><span style="color:#0550ae">20</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                result <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> asyncio<span style="color:#0550ae">.</span>wait_for<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                    asyncio<span style="color:#0550ae">.</span>to_thread<span style="color:#1f2328">(</span>tool<span style="color:#0550ae">.</span>invoke<span style="color:#1f2328">,</span> args<span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>                    timeout<span style="color:#0550ae">=</span><span style="color:#0550ae">20</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> result
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span> asyncio<span style="color:#0550ae">.</span>TimeoutError<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;    Timeout on attempt </span><span style="color:#0a3069">{</span>attempt <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> attempt <span style="color:#0550ae">&lt;</span> max_retries<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                wait_time <span style="color:#0550ae">=</span> <span style="color:#0550ae">2</span> <span style="color:#0550ae">**</span> attempt
</span></span><span style="display:flex;"><span>                <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;    Retrying in </span><span style="color:#0a3069">{</span>wait_time<span style="color:#0a3069">}</span><span style="color:#0a3069">s...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">await</span> asyncio<span style="color:#0550ae">.</span>sleep<span style="color:#1f2328">(</span>wait_time<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">raise</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;    Error: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>e<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> attempt <span style="color:#0550ae">&lt;</span> max_retries <span style="color:#0550ae">and</span> <span style="color:#0a3069">&#34;Network&#34;</span> <span style="color:#0550ae">in</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>e<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                wait_time <span style="color:#0550ae">=</span> <span style="color:#0550ae">2</span> <span style="color:#0550ae">**</span> attempt
</span></span><span style="display:flex;"><span>                <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;    Retrying in </span><span style="color:#0a3069">{</span>wait_time<span style="color:#0a3069">}</span><span style="color:#0a3069">s...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">await</span> asyncio<span style="color:#0550ae">.</span>sleep<span style="color:#1f2328">(</span>wait_time<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">raise</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">tool_node</span><span style="color:#1f2328">(</span>state<span style="color:#1f2328">:</span> AgentState<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;Execute tool calls from agent&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    last <span style="color:#0550ae">=</span> state<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">][</span><span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    outputs <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    mcp_tools <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> get_mcp_tools<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    all_tools <span style="color:#0550ae">=</span> mcp_tools <span style="color:#0550ae">+</span> <span style="color:#1f2328">[</span>tavily<span style="color:#1f2328">,</span> search_hdb_amenities<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    tools_by_name <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>t<span style="color:#0550ae">.</span>name<span style="color:#1f2328">:</span> t <span style="color:#cf222e">for</span> t <span style="color:#0550ae">in</span> all_tools<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">TOOL_NODE: Found </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>last<span style="color:#0550ae">.</span>tool_calls<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> tool call(s)&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Available tools: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">list</span><span style="color:#1f2328">(</span>tools_by_name<span style="color:#0550ae">.</span>keys<span style="color:#1f2328">())</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> tc <span style="color:#0550ae">in</span> last<span style="color:#0550ae">.</span>tool_calls<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        tool_name <span style="color:#0550ae">=</span> tc<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;name&#34;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">  Executing: </span><span style="color:#0a3069">{</span>tool_name<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;    Args: </span><span style="color:#0a3069">{</span>tc<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;args&#39;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            tool <span style="color:#0550ae">=</span> tools_by_name<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span>tool_name<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> tool<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                result <span style="color:#0550ae">=</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Tool &#39;</span><span style="color:#0a3069">{</span>tool_name<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39; not found. Available: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">list</span><span style="color:#1f2328">(</span>tools_by_name<span style="color:#0550ae">.</span>keys<span style="color:#1f2328">())</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;    </span><span style="color:#0a3069">{</span>result<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;    Tool type: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">type</span><span style="color:#1f2328">(</span>tool<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                result <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> execute_tool_with_retry<span style="color:#1f2328">(</span>tool<span style="color:#1f2328">,</span> tool_name<span style="color:#1f2328">,</span> tc<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;args&#34;</span><span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;    Success.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#6639ba">isinstance</span><span style="color:#1f2328">(</span>result<span style="color:#1f2328">,</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                content <span style="color:#0550ae">=</span> result
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">elif</span> <span style="color:#6639ba">isinstance</span><span style="color:#1f2328">(</span>result<span style="color:#1f2328">,</span> <span style="color:#6639ba">dict</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                content <span style="color:#0550ae">=</span> json<span style="color:#0550ae">.</span>dumps<span style="color:#1f2328">(</span>result<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">elif</span> <span style="color:#6639ba">isinstance</span><span style="color:#1f2328">(</span>result<span style="color:#1f2328">,</span> <span style="color:#6639ba">list</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                content <span style="color:#0550ae">=</span> json<span style="color:#0550ae">.</span>dumps<span style="color:#1f2328">(</span>result<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                content <span style="color:#0550ae">=</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>result<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            outputs<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>ToolMessage<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                content<span style="color:#0550ae">=</span>content<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                name<span style="color:#0550ae">=</span>tool_name<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                tool_call_id<span style="color:#0550ae">=</span>tc<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;id&#34;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;    ToolMessage created (</span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>content<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> chars)&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            error_msg <span style="color:#0550ae">=</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Error executing </span><span style="color:#0a3069">{</span>tool_name<span style="color:#0a3069">}</span><span style="color:#0a3069">: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>e<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;    </span><span style="color:#0a3069">{</span>error_msg<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">import</span> <span style="color:#24292e">traceback</span>
</span></span><span style="display:flex;"><span>            traceback<span style="color:#0550ae">.</span>print_exc<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            outputs<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>ToolMessage<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                content<span style="color:#0550ae">=</span>error_msg<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                name<span style="color:#0550ae">=</span>tool_name<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                tool_call_id<span style="color:#0550ae">=</span>tc<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;id&#34;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">  Returning </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>outputs<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> ToolMessage(s)&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">:</span> outputs<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ----------------------------- </span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># SPECIALIST NODES</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ----------------------------- </span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">run_agent</span><span style="color:#1f2328">(</span>agent<span style="color:#1f2328">,</span> state<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    response <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> agent<span style="color:#0550ae">.</span>ainvoke<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;scratch_pad&#34;</span><span style="color:#1f2328">:</span> state<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">]})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">[</span>response<span style="color:#1f2328">]}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">sql_agent_node</span><span style="color:#1f2328">(</span>state<span style="color:#1f2328">:</span> AgentState<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    mcp_tools <span style="color:#0550ae">=</span> <span style="color:#cf222e">await</span> get_mcp_tools<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    agent <span style="color:#0550ae">=</span> sql_prompt <span style="color:#0550ae">|</span> build_model<span style="color:#1f2328">()</span><span style="color:#0550ae">.</span>bind_tools<span style="color:#1f2328">(</span>mcp_tools<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">await</span> run_agent<span style="color:#1f2328">(</span>agent<span style="color:#1f2328">,</span> state<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">amenities_agent_node</span><span style="color:#1f2328">(</span>state<span style="color:#1f2328">:</span> AgentState<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    agent <span style="color:#0550ae">=</span> amenities_prompt <span style="color:#0550ae">|</span> build_model<span style="color:#1f2328">()</span><span style="color:#0550ae">.</span>bind_tools<span style="color:#1f2328">([</span>search_hdb_amenities<span style="color:#1f2328">,</span> tavily<span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">await</span> run_agent<span style="color:#1f2328">(</span>agent<span style="color:#1f2328">,</span> state<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">web_agent_node</span><span style="color:#1f2328">(</span>state<span style="color:#1f2328">:</span> AgentState<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    agent <span style="color:#0550ae">=</span> web_prompt <span style="color:#0550ae">|</span> build_model<span style="color:#1f2328">()</span><span style="color:#0550ae">.</span>bind_tools<span style="color:#1f2328">([</span>tavily<span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">await</span> run_agent<span style="color:#1f2328">(</span>agent<span style="color:#1f2328">,</span> state<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ----------------------------- </span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># GRAPH BUILD</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ----------------------------- </span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">build_graph</span><span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>    workflow <span style="color:#0550ae">=</span> StateGraph<span style="color:#1f2328">(</span>AgentState<span style="color:#1f2328">,</span> async_mode<span style="color:#0550ae">=</span><span style="color:#cf222e">True</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    workflow<span style="color:#0550ae">.</span>add_node<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;ROUTER&#34;</span><span style="color:#1f2328">,</span> router_node<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    workflow<span style="color:#0550ae">.</span>add_node<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;SQL_AGENT&#34;</span><span style="color:#1f2328">,</span> sql_agent_node<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    workflow<span style="color:#0550ae">.</span>add_node<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;AMENITIES_AGENT&#34;</span><span style="color:#1f2328">,</span> amenities_agent_node<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    workflow<span style="color:#0550ae">.</span>add_node<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;WEB_AGENT&#34;</span><span style="color:#1f2328">,</span> web_agent_node<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    workflow<span style="color:#0550ae">.</span>add_node<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;TOOLS&#34;</span><span style="color:#1f2328">,</span> tool_node<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">next_step</span><span style="color:#1f2328">(</span>state<span style="color:#1f2328">:</span> AgentState<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        last <span style="color:#0550ae">=</span> state<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">][</span><span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>        has_calls <span style="color:#0550ae">=</span> <span style="color:#6639ba">hasattr</span><span style="color:#1f2328">(</span>last<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;tool_calls&#39;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">and</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>last<span style="color:#0550ae">.</span>tool_calls<span style="color:#1f2328">)</span> <span style="color:#0550ae">&gt;</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">next_step: Last message type=</span><span style="color:#0a3069">{</span><span style="color:#6639ba">type</span><span style="color:#1f2328">(</span>last<span style="color:#1f2328">)</span><span style="color:#0550ae">.</span><span style="color:#953800">__name__</span><span style="color:#0a3069">}</span><span style="color:#0a3069">, has_tool_calls=</span><span style="color:#0a3069">{</span>has_calls<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#0a3069">&#34;TOOLS&#34;</span> <span style="color:#cf222e">if</span> has_calls <span style="color:#cf222e">else</span> END
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    workflow<span style="color:#0550ae">.</span>add_conditional_edges<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;SQL_AGENT&#34;</span><span style="color:#1f2328">,</span> next_step<span style="color:#1f2328">,</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;TOOLS&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;TOOLS&#34;</span><span style="color:#1f2328">,</span> END<span style="color:#1f2328">:</span> END<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>    workflow<span style="color:#0550ae">.</span>add_conditional_edges<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;AMENITIES_AGENT&#34;</span><span style="color:#1f2328">,</span> next_step<span style="color:#1f2328">,</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;TOOLS&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;TOOLS&#34;</span><span style="color:#1f2328">,</span> END<span style="color:#1f2328">:</span> END<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>    workflow<span style="color:#0550ae">.</span>add_conditional_edges<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;WEB_AGENT&#34;</span><span style="color:#1f2328">,</span> next_step<span style="color:#1f2328">,</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;TOOLS&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;TOOLS&#34;</span><span style="color:#1f2328">,</span> END<span style="color:#1f2328">:</span> END<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    workflow<span style="color:#0550ae">.</span>add_conditional_edges<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;ROUTER&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">lambda</span> out<span style="color:#1f2328">:</span> out<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;next_agent&#34;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;SQL_AGENT&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;SQL_AGENT&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;AMENITIES_AGENT&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;AMENITIES_AGENT&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;WEB_AGENT&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;WEB_AGENT&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    workflow<span style="color:#0550ae">.</span>add_edge<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;TOOLS&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;ROUTER&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    workflow<span style="color:#0550ae">.</span>set_entry_point<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;ROUTER&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> workflow<span style="color:#0550ae">.</span>compile<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>graph <span style="color:#0550ae">=</span> build_graph<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ----------------------------- </span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># MAIN</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ----------------------------- </span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">async</span> <span style="color:#cf222e">def</span> <span style="color:#6639ba">main</span><span style="color:#1f2328">(</span>user_query<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;Run the graph with a user query&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">Query: </span><span style="color:#0a3069">{</span>user_query<span style="color:#0a3069">}</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    initial_state <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">[</span>HumanMessage<span style="color:#1f2328">(</span>content<span style="color:#0550ae">=</span>user_query<span style="color:#1f2328">)]}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">async</span> <span style="color:#cf222e">for</span> output <span style="color:#0550ae">in</span> graph<span style="color:#0550ae">.</span>astream<span style="color:#1f2328">(</span>initial_state<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;State:&#34;</span><span style="color:#1f2328">,</span> output<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> graph<span style="color:#0550ae">.</span>get_state<span style="color:#1f2328">(</span>initial_state<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">if</span> <span style="color:#953800">__name__</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;__main__&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    query <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;What amenities are near Bukit Panjang?&#34;</span>
</span></span><span style="display:flex;"><span>    asyncio<span style="color:#0550ae">.</span>run<span style="color:#1f2328">(</span>main<span style="color:#1f2328">(</span>query<span style="color:#1f2328">))</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>
  </div>
</details>
<ol start="5">
<li>Launch Agent Server</li>
</ol>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>langgraph dev</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>

































 
  
  





  <img src="/images/mas/mas-multi-agent-system-langgraph-dev.png"   alt="mas-multi-agent-system-langgraph-dev" class="sc-image sc-image-default"
       >


<ol start="6">
<li>Navigate to LangSmith Studio</li>
</ol>
<p>Navigate to <code>https://smith.langchain.com/studio/?baseUrl=http://127.0.0.1:2024</code>:</p>


































 
  
  





  <img src="/images/mas/mas-multi-agent-system-langsmith-studio.png"   alt="mas-multi-agent-system-langsmith-studio" class="sc-image sc-image-default"
       >


<ol start="7">
<li>Test our MAS Agent</li>
</ol>
<p>Let&rsquo;s switch over to the <em>Chat</em> tab and test it out with:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>What amenities are near Block 110 in Toa Payoh?</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>

































 
  
  





  <img src="/images/mas/mas-multi-agent-system-langsmith-studio-chat-mode.png"   alt="mas-multi-agent-system-langsmith-studio-chat-mode" class="sc-image sc-image-default"
       >


<p>Test case for MCP Tools:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Show me the median resale price of 4-room flats in Bishan.</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>

































 
  
  





  <img src="/images/mas/mas-multi-agent-system-langsmith-studio-chat-mode2.png"   alt="mas-multi-agent-system-langsmith-studio-chat-mode2" class="sc-image sc-image-default"
       >


<hr>
<h2 id="source-code-on-github">Source Code on GitHub</h2>
<p>You can find the full project, including notebooks, MAS graph, and tools configuration, here:</p>
<p>ðŸ‘‰ <strong>GitHub Repository:</strong> 






  <a href="https://github.com/seehiong/multi-agent-system-using-langgraph" target="_blank" rel="noopener noreferrer" >https://github.com/seehiong/multi-agent-system-using-langgraph</a>
</p>
<p>The repo includes:</p>
<ul>
<li>All Jupyter notebooks (<code>toto_generator</code>, <code>ReAct agent</code>, <code>MAS supervisor</code>)</li>
<li><code>graph.py</code> for LangGraph CLI</li>
<li><code>tools.yaml</code> for MCP Toolbox</li>
<li>Environment setup (<code>pyproject.toml</code>, <code>uv.lock</code>)</li>
<li>Clean project structure and <code>.gitignore</code></li>
</ul>
<p>Feel free to star â­ the repo if you found it helpful!</p>

    </section>

    <nav class="post-navigation">
      <div class="nav-links">
        
          <div class="nav-previous">
            <a href="/posts/2025/11/adk-web-multi-agent-system/" rel="prev">
              <span class="meta-nav">â† Previous</span>
              <span class="post-title">ADK Web Multi-Agent System</span>
            </a>
          </div>
        
        
          <div class="nav-next">
            <a href="/posts/2025/12/autonomous-deepagents-for-hdb-insights/" rel="next">
              <span class="meta-nav">Next â†’</span>
              <span class="post-title">Autonomous DeepAgents for HDB Insights</span>
            </a>
          </div>
        
      </div>
    </nav>

    
<div class="giscus-comments-container">
</div>

<script>
  (function() {
    'use strict';

    const getGiscusTheme = () => {
      const storedTheme = localStorage.getItem('theme'); 
      if (storedTheme) {
        return storedTheme === 'dark-mode' ? 'dark' : 'light';
      }
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };

    const setGiscusFrameTheme = (theme) => {
      const iframe = document.querySelector('iframe.giscus-frame');
      if (iframe && iframe.contentWindow) {
        iframe.contentWindow.postMessage({ giscus: { setConfig: { theme: theme } } }, 'https://giscus.app');
      }
    };

    const loadGiscus = () => {
      const giscusContainer = document.querySelector('.giscus-comments-container');
      if (!giscusContainer) {
        console.warn('Giscus container not found.');
        return;
      }

      while (giscusContainer.firstChild) {
        giscusContainer.removeChild(giscusContainer.firstChild);
      }

      const giscusScript = document.createElement('script');
      const giscusAttributes = {
        "src": "https://giscus.app/client.js",
        "data-repo":             "seehiong\/seehiong.github.io",
        "data-repo-id":          "R_kgDOJg7Puw",
        "data-category":         "General",
        "data-category-id":      "DIC_kwDOJg7Pu84Cbyhc",
        "data-mapping":          "url", 
        "data-strict":           "0",
        "data-reactions-enabled":"1",
        "data-emit-metadata":    "0",
        "data-input-position":   "top", 
        "data-theme":            getGiscusTheme(), 
        "data-lang":             "en",
        "data-loading":          "lazy",
        "crossorigin":           "anonymous",
        "async":                 "true", 
      };

      if (!giscusAttributes["data-repo"] || !giscusAttributes["data-repo-id"] || !giscusAttributes["data-category-id"]) {
          console.error("Giscus parameters (giscusRepo, giscusRepoId, giscusCategoryId) are not configured in hugo.toml.");
          giscusContainer.innerHTML = "<p style='color: var(--text-secondary);'>Giscus comments are not configured correctly. Please check site parameters.</p>";
          return;
      }

      Object.entries(giscusAttributes).forEach(
        ([key, value]) => giscusScript.setAttribute(key, value)
      );
      giscusContainer.appendChild(giscusScript);
    };

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadGiscus);
    } else {
        loadGiscus();
    }

    const htmlElement = document.documentElement;
    const observer = new MutationObserver((mutationsList) => {
      for (const mutation of mutationsList) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          setGiscusFrameTheme(getGiscusTheme());
        }
      }
    });
    observer.observe(htmlElement, { attributes: true });

  })();
</script>


  </article>
</div>
</main>
    </div>

    
    <div id="search-modal-overlay" class="search-modal-overlay" style="display: none;">
      <div id="search-modal-content" class="search-modal-content">
        <button id="search-modal-close" class="search-modal-close" aria-label="Close search" title="Close search">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </button>
        <input type="search" id="modal-search-input" class="modal-search-input" placeholder="Search content..." aria-label="Search input">
        <div id="modal-search-results" class="modal-search-results">
        </div>
      </div>
    </div>
    

  <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js" defer></script>
  <script>
    (function() {
      'use strict';

      window.addEventListener('DOMContentLoaded', () => {
        const searchModalOverlay = document.getElementById('search-modal-overlay');
        const searchModalContent = document.getElementById('search-modal-content');
        const searchModalCloseButton = document.getElementById('search-modal-close');
        const searchToggleButton = document.getElementById('nav-search-toggle');
        const searchInputTarget = document.getElementById('modal-search-input');
        const searchResultsTarget = document.getElementById('modal-search-results');

        let fuseInstance = null;
        let searchData = [];

        const loadSearchData = async () => {
          if (searchData.length === 0 && !fuseInstance) {
            try {
              const response = await fetch('\/index.json');
              if (!response.ok) {
                throw new Error(`HTTP error loading index.json! status: ${response.status}`);
              }
              searchData = await response.json();
              initializeFuse();
            } catch (e) {
              console.error("[SearchSetup] Error loading search data:", e);
              if (searchResultsTarget) searchResultsTarget.innerHTML = "<p>Error loading search index.</p>";
            }
          } else if (searchData.length > 0 && !fuseInstance){
            initializeFuse();
          }
        };

        const initializeFuse = () => {
          if (searchData.length > 0 && !fuseInstance) {
            const options = {
              keys: [
                { name: 'title', weight: 0.7 }, { name: 'summary', weight: 0.5 },
                { name: 'content', weight: 0.3 }, { name: 'tags', weight: 0.4 }
              ],
              includeScore: true, threshold: 0.4, minMatchCharLength: 2,
            };
            fuseInstance = new Fuse(searchData, options);
          }
        };

        const performSearch = () => {
          if (!fuseInstance || !searchInputTarget || !searchResultsTarget) return;
          const query = searchInputTarget.value.trim();
          searchResultsTarget.innerHTML = '';
          if (query.length < 2) return;

          const results = fuseInstance.search(query);
          if (results.length > 0) {
            const ul = document.createElement('ul');
            ul.className = 'search-results-list';
            results.slice(0, 10).forEach(result => {
              const item = result.item;
              const li = document.createElement('li');
              li.className = 'search-result-item';
              const a = document.createElement('a');
              a.href = item.permalink;
              a.textContent = item.title;
              li.appendChild(a);
              ul.appendChild(li);
            });
            searchResultsTarget.appendChild(ul);
          } else {
            searchResultsTarget.innerHTML = '<p>No results found.</p>';
          }
        };

        const openSearchModal = async () => {
          await loadSearchData();
          if (searchInputTarget) searchInputTarget.value = '';
          if (searchResultsTarget) searchResultsTarget.innerHTML = '';

          if (searchModalOverlay) {
            searchModalOverlay.style.display = 'flex';
            setTimeout(() => searchModalOverlay.classList.add('active'), 10);
          } else { return; }

          if (searchInputTarget) setTimeout(() => searchInputTarget.focus(), 50);
          if (searchToggleButton) searchToggleButton.classList.add('active');
        };

        const closeSearchModal = () => {
          if (searchModalOverlay) {
            searchModalOverlay.classList.remove('active');
            setTimeout(() => searchModalOverlay.style.display = 'none', 300);
          }
          if (searchToggleButton) searchToggleButton.classList.remove('active');
        };

        if (searchToggleButton) {
          searchToggleButton.addEventListener('click', (e) => {
            e.stopPropagation();
            if (searchModalOverlay && searchModalOverlay.classList.contains('active')) {
              closeSearchModal();
            } else {
              openSearchModal();
            }
          });
        } else { console.error("[SearchSetup] #nav-search-toggle button not found."); }

        if (searchModalCloseButton) { searchModalCloseButton.addEventListener('click', closeSearchModal); }
        if (searchModalOverlay && searchModalContent) {
          searchModalOverlay.addEventListener('click', (event) => {
            if (event.target === searchModalOverlay) closeSearchModal();
          });
        }
        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && searchModalOverlay && searchModalOverlay.classList.contains('active')) {
            closeSearchModal();
          }
        });
        if (searchInputTarget) {
          let debounceTimer;
          searchInputTarget.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(performSearch, 300);
          });
        }
      });
    })();
  </script>

    

    

  <script>
    MathJax = {
      tex: {
        displayMath: [['\\[', '\\]'], ['$$', '$$']], 
        inlineMath: [['\\(', '\\)']], 
        processEscapes: true,
        processEnvironments: true,
        tags: 'ams' 
      },
      svg: {
        fontCache: 'global' 
      },
      chtml: {
        fontURL: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2'
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'], 
        ignoreHtmlClass: 'tex2jax_ignore', 
        processHtmlClass: 'tex2jax_process'
      }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<footer class="footer-main simplified-footer">
  <div class="content-body footer-wraper">
    <div class="footer-box">
      <div class="footer-content">
        <div class="copyright-line">
          Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> Â© 2026 See Hiong. All rights reserved.
        </div>
        <div class="social-links">
          
            <a href="https://github.com/seehiong" target="_blank" title="GitHub" class="social-link" aria-label="GitHub">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
            </a>
          
          
            <a href="https://www.linkedin.com/in/seehiong/" target="_blank" title="LinkedIn" class="social-link" aria-label="LinkedIn">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
            </a>
          
          
            <a href="/index.xml" target="_blank" title="RSS" class="social-link" aria-label="RSS Feed">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg>
            </a>
          
        </div>
      </div>
    </div>
  </div>
</footer>
        <script src="/js/animation.js" defer></script>
    
        <script src="/js/code-copy.js" defer></script>
    
        <script src="/js/scroll-header.js" defer></script>
       
  </body>
</html>