<!DOCTYPE html>
<html lang="en">
  <head><head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <link rel="icon" href="/images/favicon.ico">
    

    <meta property="og:url" content="https://seehiong.github.io/posts/2025/04/from-model-to-hdb-app/">
  <meta property="og:site_name" content="See Hiong&#39;s Blog">
  <meta property="og:title" content="From Model to HDB App">
  <meta property="og:description" content="In this post, I demonstrated how to deploy a Jupyter notebook using the jupyter-tensorflow-full image in Kubeflow, develop an HDB resale price predictor app with Streamlit, and access it via port forwarding. The setup runs locally and showcases how to bring together machine learning, visualization, and interactivity in a seamless development workflow within Kubeflow.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-04-21T20:00:00+08:00">
    <meta property="article:modified_time" content="2025-04-21T20:00:00+08:00">
    <meta property="article:tag" content="Streamlit">
    <meta property="article:tag" content="XGBoost">
    <meta property="article:tag" content="MLflow">
    <meta property="article:tag" content="Kubeflow">
    <meta property="article:tag" content="MinIO">
    <meta property="article:tag" content="KFP">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="From Model to HDB App">
  <meta name="twitter:description" content="In this post, I demonstrated how to deploy a Jupyter notebook using the jupyter-tensorflow-full image in Kubeflow, develop an HDB resale price predictor app with Streamlit, and access it via port forwarding. The setup runs locally and showcases how to bring together machine learning, visualization, and interactivity in a seamless development workflow within Kubeflow.">

  <meta itemprop="name" content="From Model to HDB App">
  <meta itemprop="description" content="In this post, I demonstrated how to deploy a Jupyter notebook using the jupyter-tensorflow-full image in Kubeflow, develop an HDB resale price predictor app with Streamlit, and access it via port forwarding. The setup runs locally and showcases how to bring together machine learning, visualization, and interactivity in a seamless development workflow within Kubeflow.">
  <meta itemprop="datePublished" content="2025-04-21T20:00:00+08:00">
  <meta itemprop="dateModified" content="2025-04-21T20:00:00+08:00">
  <meta itemprop="wordCount" content="4861">
  <meta itemprop="keywords" content="Streamlit,XGBoost,MLflow,Kubeflow,MinIO,KFP,KServe"><title>From Model to HDB App | See Hiong&#39;s Blog</title>

    <link rel="canonical" href="https://seehiong.github.io/posts/2025/04/from-model-to-hdb-app/">

    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    
      
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-5PNPM4HWQ0"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-5PNPM4HWQ0');
        }
      </script>
    
    <link rel="stylesheet" href="/css/variables.css">
    
    <link rel="stylesheet" href="/css/base.css">
    
    <link rel="stylesheet" href="/css/layout.css">
    
    <link rel="stylesheet" href="/css/header.css">
    
    <link rel="stylesheet" href="/css/header.css">
    
    <link rel="stylesheet" href="/css/cards.css">
    
    <link rel="stylesheet" href="/css/content_elements.css">
    
    <link rel="stylesheet" href="/css/codeblocks.css">
    
    <link rel="stylesheet" href="/css/page_specific.css">
    
    <link rel="stylesheet" href="/css/shortcodes.css">
    
    <link rel="stylesheet" href="/css/components.css">
    
    <link rel="stylesheet" href="/css/animations.css">
    
    <link rel="stylesheet" href="/css/media_queries.css">
    
    <link rel="stylesheet" href="/css/quantum-theme.css">
    

    
    <script>
      (function() {
        var theme = localStorage.getItem('theme');
        var H = document.documentElement;
        if (theme === 'dark-mode') {
          H.classList.add('dark-mode');
        } else if (theme === 'light-mode') {
          H.classList.remove('dark-mode');
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
          H.classList.add('dark-mode');
        }
      })();
    </script>
</head></head>
  <body class="page-article"><nav class="nav">
  <div class="nav-wrapper">
    <div class="nav-content-wrapper">
      <div class="nav-content">
        <a href="/" class="nav-logo-link" title="See Hiong&#39;s Blog - Home">
          <span class="nav-site-title">
            <span class="nav-site-title__main">SEE HIONG’S</span>
            <span class="nav-site-title__sub">BLOG</span>
          </span>
        </a>
        <div class="nav-menu">
          <div class="nav-item-wrapper">
            
            
            <a href="/posts/" class="nav-item-content active">Archives</a>
            
          </div>
          
          
          <div class="nav-item-wrapper">
            <a href="/tags/" class="nav-item-content ">Tags</a>
          </div>
          <div class="nav-item-wrapper">
            <a href="/about/" class="nav-item-content ">About</a>
          </div>
          <div class="nav-item-wrapper nav-search-toggle-wrapper">
            <button id="nav-search-toggle" class="nav-item-button" aria-label="Toggle search" title="Search">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor" class="nav-item-icon">
                <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5A6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
              </svg>
            </button>
          </div>
          
          
          <button id="theme-toggle" class="nav-item-button" aria-label="Toggle theme"></button> 
        </div>
      </div>
    </div>
  </div>
</nav>


<script>
  document.addEventListener('DOMContentLoaded', function () {
    const themeToggle = document.getElementById('theme-toggle');
    const H = document.documentElement; 

    if (H.classList.contains('dark-mode')) {
      themeToggle.textContent = 'Light Mode';
    } else {
      themeToggle.textContent = 'Dark Mode';
    }

    themeToggle.addEventListener('click', function() {
      H.classList.toggle('dark-mode');
      if (H.classList.contains('dark-mode')) {
        localStorage.setItem('theme', 'dark-mode');
        themeToggle.textContent = 'Light Mode';
      } else {
        localStorage.setItem('theme', 'light-mode');
        themeToggle.textContent = 'Dark Mode';
      }
    });
  });
</script><div id="content-wrapper">
        <main class="container" id="main-content">
<div class="main-content-area">
  <article class="post-layout container">

    <header class="post-header">
      <h1 class="post-title">From Model to HDB App</h1>

      <div class="post-meta">
        <span class="post-meta__date">
          <time datetime="2025-04-21T20:00:00&#43;08:00">April 21, 2025</time>
        </span>

        
          <span class="post-meta__author">Written by See Hiong</span>
        

        
          <span class="post-meta__tags">
            In:
            
              <a href="/tags/streamlit">Streamlit</a>
            
              , <a href="/tags/xgboost">XGBoost</a>
            
              , <a href="/tags/mlflow">MLflow</a>
            
              , <a href="/tags/kubeflow">Kubeflow</a>
            
              , <a href="/tags/minio">MinIO</a>
            
              , <a href="/tags/kfp">KFP</a>
            
              , <a href="/tags/kserve">KServe</a>
            
          </span>
        

        
      </div>
    </header>

    
      
      
      <div class="post-cover-container post-cover--artistic-blur-wrapper">
        
          <div class="post-cover-blur-background" style="--bg-image: url('/images/hdb-app/from-model-to-hdb-app.svg');"></div>
          <img src="/images/hdb-app/from-model-to-hdb-app.svg" alt="From Model to HDB App cover image" class="post-cover-image post-cover-image--artistic-blur">
        
      </div>
    

    <section class="post-content">
      <p>Building on my 






  <a href="/posts/2025/04/feature-impact-on-hdb-predictions/" >previous post</a>
, this article outlines how to move the selected features into a Kubeflow Pipeline (KFP) for a full model training and deployment workflow. The pipeline fetches input data from S3-compatible MinIO, trains a model using XGBoost with optimized feature selection, and deploys it via KServe. At the end of this journey, a Streamlit app enables users to make resale price predictions by entering flat attributes.</p>
<h2 id="deploying-the-inferenceservice">Deploying the InferenceService</h2>
<p>Following the 






  <a href="https://kserve.github.io/website/master/modelserving/storage/s3/s3/" target="_blank" rel="noopener noreferrer" >official KServe documentation</a>
, let’s begin by setting up the necessary components to enable model inference from an S3 backend.</p>
<h3 id="1-create-service-account">1. Create Service Account</h3>
<p>Define a service account that references the secret used to access MinIO.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f s3-secret.yaml</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>





<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#57606a"># s3-secret.yaml</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">apiVersion</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>v1<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">kind</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>ServiceAccount<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">metadata</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>sa<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">namespace</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>kubeflow-user-example-com<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">secrets</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span>- <span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>minio-creds</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="2-create-s3-secret">2. Create S3 Secret</h3>
<p>Configure your secret to include the MinIO credentials and required annotations for KServe to read from the S3 bucket.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f secret-minio.yaml</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>





<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#57606a"># secret-minio.yaml</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">apiVersion</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>v1<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">kind</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Secret<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">metadata</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>minio-creds<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">namespace</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>kubeflow-user-example-com<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">annotations</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">     </span><span style="color:#0550ae">serving.kserve.io/s3-endpoint</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;minio-service.kubeflow:9000&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">     </span><span style="color:#0550ae">serving.kserve.io/s3-usehttps</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;0&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">     </span><span style="color:#0550ae">serving.kserve.io/s3-useanoncredential</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;false&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">type</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>Opaque<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">stringData</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">AWS_ACCESS_KEY_ID</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;minio&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">AWS_SECRET_ACCESS_KEY</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;minio123&#34;</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="3-deploy-the-inferenceservice">3. Deploy the InferenceService</h3>
<p>Using the 






  <a href="https://kserve.github.io/website/0.11/modelserving/v1beta1/xgboost" target="_blank" rel="noopener noreferrer" >XGBoost serving guide</a>
, deploy the model. This step will also be handled automatically within the pipeline’s Step 6.</p>
<p><strong>Note</strong>: Ensure the <code>storageUri</code> points to the correct S3 path that contains the XGBoost <code>.bst</code> model file.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f kserve-inference.yaml --server-side<span style="color:#0550ae">=</span><span style="color:#6639ba">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Sample S3 minio url</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># storageUri: &#34;s3://mlpipeline/v2/artifacts/hdb-xgboost-retraining-pipeline-multi-step/053453f4-8e52-4e4a-b2b1-1f8658b92b54/train-model/15ee1507-42e0-4a05-b06f-bd0fa12a7a42/output_model&#34;</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>





<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#57606a"># kserve-inference.yaml</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">apiVersion</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;serving.kserve.io/v1beta1&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">kind</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;InferenceService&#34;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">metadata</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>hdb-resale-xgb<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">namespace</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>kubeflow-user-example-com<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">annotations</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">autoscaling.knative.dev/maxScale</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;1&#39;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">autoscaling.knative.dev/minScale</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;0&#39;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">spec</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">predictor</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">serviceAccountName</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>sa<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">model</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">modelFormat</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>xgboost<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">protocolVersion</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>v2<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">runtime</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>kserve-xgbserver<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">storageUri</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;s3://mlpipeline/hdb-resale-data/xgb-model-test/model.bst&#34;</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="4-grant-istio-access">4. Grant Istio Access</h3>
<p>To allow prediction requests, create an Istio AuthorizationPolicy that explicitly allows POST and GET operations on the deployed model endpoint.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f allow-hdb-xgb-policy.yaml</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>





<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#57606a"># allow-hdb-xgb-policy.yaml</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">apiVersion</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>security.istio.io/v1<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">kind</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>AuthorizationPolicy<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">metadata</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">name</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>allow-hdb-resale-xgb-access<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">namespace</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>kubeflow-user-example-com<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">spec</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">selector</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">matchLabels</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#0550ae">serving.kserve.io/inferenceservice</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>hdb-resale-xgb<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">action</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span>ALLOW<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#0550ae">rules</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span>- <span style="color:#0550ae">to</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>- <span style="color:#0550ae">operation</span><span style="color:#1f2328">:</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">methods</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;POST&#34;</span><span style="color:#1f2328">,</span><span style="color:#0a3069">&#34;GET&#34;</span><span style="color:#1f2328">]</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="5-run-a-prediction">5. Run a Prediction</h3>
<p>Once the pipeline completes successfully, prepare an inference input JSON file and use <code>curl</code> to invoke the model endpoint. The output will contain the predicted resale prices.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">json</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;inputs&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">[{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;name&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;input-0&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;shape&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">[</span><span style="color:#0550ae">5</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;datatype&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;FP32&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0550ae">0.4311926605504587</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0550ae">0.2844036697247706</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0550ae">0.27522935779816515</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0550ae">0.15137614678899083</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0550ae">0.4357798165137615</span>
</span></span><span style="display:flex;"><span>          <span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}]</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">with</span> <span style="color:#6639ba">open</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;inference_input.json&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;w&#34;</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">as</span> f<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    json<span style="color:#0550ae">.</span>dump<span style="color:#1f2328">(</span>payload<span style="color:#1f2328">,</span> f<span style="color:#1f2328">,</span> indent<span style="color:#0550ae">=</span><span style="color:#0550ae">2</span><span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>





<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#953800">SERVICE_URL</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;http://hdb-resale-xgb.kubeflow-user-example-com.svc.cluster.local&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#953800">MODEL_NAME</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;hdb-resale-xgb&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Construct the V2 inference endpoint path</span>
</span></span><span style="display:flex;"><span><span style="color:#953800">INFERENCE_ENDPOINT</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">${</span><span style="color:#953800">SERVICE_URL</span><span style="color:#0a3069">}</span><span style="color:#0a3069">/v2/models/</span><span style="color:#0a3069">${</span><span style="color:#953800">MODEL_NAME</span><span style="color:#0a3069">}</span><span style="color:#0a3069">/infer&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">echo</span> <span style="color:#0a3069">&#34;Sending request to: </span><span style="color:#0a3069">${</span><span style="color:#953800">INFERENCE_ENDPOINT</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>curl -v -H <span style="color:#0a3069">&#34;Content-Type: application/json&#34;</span> <span style="color:#0a3069">&#34;</span><span style="color:#0a3069">${</span><span style="color:#953800">INFERENCE_ENDPOINT</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span> -d @inference_input.json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># *   Trying 10.98.223.247:80...</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># * Connected to hdb-resale-xgb.kubeflow-user-example-com.svc.cluster.local (10.98.223.247) port 80 (#0)</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># &gt; POST /v2/models/hdb-resale-xgb/infer HTTP/1.1</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># &gt; Host: hdb-resale-xgb.kubeflow-user-example-com.svc.cluster.local</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ...</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># &lt; </span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># * Connection #0 to host hdb-resale-xgb.kubeflow-user-example-com.svc.cluster.local left intact</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># {&#34;model_name&#34;:&#34;hdb-resale-xgb&#34;,&#34;model_version&#34;:null,&#34;id&#34;:&#34;6d902b7b-a172-4d14-84dd-cc8a004f1200&#34;,&#34;parameters&#34;:null,&#34;outputs&#34;:[{ &#34;name&#34;:&#34;output-0&#34;,&#34;shape&#34;:[5],&#34;datatype&#34;:&#34;FP32&#34;,&#34;parameters&#34;:null,&#34;data&#34;:[600095.875,579441.5625,479052.34375,336679.75,586596</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>

































 
  
  





  <img src="/images/hdb-app/hdb-kserve-hdb-resale-xgb.png"   alt="hdb-kserve-hdb-resale-xgb" class="sc-image sc-image-default"
       >


<h3 id="6-download-scaler-file">6. Download Scaler File</h3>
<p>For accurate predictions, use the same scaler from the training process. Port-forward your MinIO service and download the scaler from the designated path after the pipeline run.</p>


































 
  
  





  <img src="/images/hdb-app/hdb-download-scaler-path.png"   alt="hdb-download-scaler-path" class="sc-image sc-image-default"
       >


<h2 id="multistep-pipeline">Multistep pipeline</h2>
<p>This section outlines the custom Kubeflow pipeline built using KFP DSL. The pipeline handles everything from data ingestion to model deployment. While 






  <a href="https://www.kubeflow.org/docs/components/pipelines/user-guides/data-handling/artifacts/" target="_blank" rel="noopener noreferrer" >Kubeflow’s artifact passing</a>
 is recommended, I encountered limitations and resorted to using <code>OutputPath()</code> and native types for smooth data transfer between steps.</p>
<h3 id="step-1---load--prepare">Step 1 - Load &amp; Prepare</h3>
<p>This component loads the dataset from MinIO, parses the JSON containing selected features, and splits the data into <code>X</code> (features) and <code>y</code> (target resale price).</p>

<details class="details-shortcode " >
  <summary class="details-shortcode__summary">
    Component 1 - python code
  </summary>
  <div class="details-shortcode__content">
    
    
    





<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">kfp</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">kfp</span> <span style="color:#cf222e">import</span> dsl
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">kfp.compiler</span> <span style="color:#cf222e">import</span> Compiler
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">kfp.dsl</span> <span style="color:#cf222e">import</span> Input<span style="color:#1f2328">,</span> Output<span style="color:#1f2328">,</span> InputPath<span style="color:#1f2328">,</span> OutputPath<span style="color:#1f2328">,</span> Dataset<span style="color:#1f2328">,</span> Metrics<span style="color:#1f2328">,</span> Model<span style="color:#1f2328">,</span> Artifact
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">json</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">typing</span> <span style="color:#cf222e">import</span> NamedTuple
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Component 1: Load and Prepare Data</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#0550ae">@dsl.component</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    base_image<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;python:3.10&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    packages_to_install<span style="color:#0550ae">=</span><span style="color:#1f2328">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;pandas==2.1.4&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;numpy==1.24.4&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;s3fs==2025.3.2&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;pyarrow==19.0.1&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;kfp==2.12.1&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">load_and_prep_data</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    s3_data_uri<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    target_column<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    features_json<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    x_data_path<span style="color:#1f2328">:</span> OutputPath<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;Dataset&#39;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    y_data_path<span style="color:#1f2328">:</span> OutputPath<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;Dataset&#39;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> NamedTuple<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;LoadDataOutput&#39;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;feature_names_json_out&#39;</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">)</span> 
</span></span><span style="display:flex;"><span><span style="color:#1f2328">]):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Define the NamedTuple</span>
</span></span><span style="display:flex;"><span>    LoadDataOutput <span style="color:#0550ae">=</span> NamedTuple<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;LoadDataOutput&#39;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;feature_names_json_out&#39;</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">pandas</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">pd</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">numpy</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">np</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">os</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">json</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">s3fs</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;--- Step 1: Load and Prep Data ---&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Input S3 URI: </span><span style="color:#0a3069">{</span>s3_data_uri<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Target Column: </span><span style="color:#0a3069">{</span>target_column<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Load Data</span>
</span></span><span style="display:flex;"><span>    minio_endpoint_url <span style="color:#0550ae">=</span> os<span style="color:#0550ae">.</span>environ<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;AWS_ENDPOINT_URL&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;http://minio-service.kubeflow:9000&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    minio_access_key <span style="color:#0550ae">=</span> os<span style="color:#0550ae">.</span>environ<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;AWS_ACCESS_KEY_ID&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;minio&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    minio_secret_key <span style="color:#0550ae">=</span> os<span style="color:#0550ae">.</span>environ<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;AWS_SECRET_ACCESS_KEY&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;minio123&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    s3_storage_options <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;key&#39;</span><span style="color:#1f2328">:</span> minio_access_key<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;secret&#39;</span><span style="color:#1f2328">:</span> minio_secret_key<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;client_kwargs&#39;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#39;endpoint_url&#39;</span><span style="color:#1f2328">:</span> minio_endpoint_url
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Reading parquet from S3...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    df_processed <span style="color:#0550ae">=</span> pd<span style="color:#0550ae">.</span>read_parquet<span style="color:#1f2328">(</span>s3_data_uri<span style="color:#1f2328">,</span> storage_options<span style="color:#0550ae">=</span>s3_storage_options<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Loaded data shape: </span><span style="color:#0a3069">{</span>df_processed<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Parse Features &amp; Split X/y</span>
</span></span><span style="display:flex;"><span>    feature_names <span style="color:#0550ae">=</span> json<span style="color:#0550ae">.</span>loads<span style="color:#1f2328">(</span>features_json<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Using pre-defined fixed feature set (</span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>feature_names<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> features).&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    missing_features <span style="color:#0550ae">=</span> <span style="color:#1f2328">[</span>f <span style="color:#cf222e">for</span> f <span style="color:#0550ae">in</span> feature_names <span style="color:#cf222e">if</span> f <span style="color:#0550ae">not</span> <span style="color:#0550ae">in</span> df_processed<span style="color:#0550ae">.</span>columns<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> missing_features<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>         <span style="color:#cf222e">raise</span> ValueError<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Fixed features not found in dataset: </span><span style="color:#0a3069">{</span>missing_features<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    X_data <span style="color:#0550ae">=</span> df_processed<span style="color:#1f2328">[</span>feature_names<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    y_data <span style="color:#0550ae">=</span> df_processed<span style="color:#1f2328">[[</span>target_column<span style="color:#1f2328">]]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;X_data shape: </span><span style="color:#0a3069">{</span>X_data<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;y_data shape: </span><span style="color:#0a3069">{</span>y_data<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Save Outputs</span>
</span></span><span style="display:flex;"><span>    X_data<span style="color:#0550ae">.</span>to_parquet<span style="color:#1f2328">(</span>x_data_path<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    y_data<span style="color:#0550ae">.</span>to_parquet<span style="color:#1f2328">(</span>y_data_path<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;--- Step 1 Complete ---&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> LoadDataOutput<span style="color:#1f2328">(</span>feature_names_json_out<span style="color:#0550ae">=</span>features_json<span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>
  </div>
</details>
<h3 id="step-2---split--scale">Step 2 - Split &amp; Scale</h3>
<p>Performs train/test splitting and applies scaling. The fitted scaler is saved for later use in inference.</p>

<details class="details-shortcode " >
  <summary class="details-shortcode__summary">
    Component 2 - python code
  </summary>
  <div class="details-shortcode__content">
    
    
    





<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#57606a"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Component 2: Split and Scale Data</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#0550ae">@dsl.component</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    base_image<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;python:3.10&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    packages_to_install<span style="color:#0550ae">=</span><span style="color:#1f2328">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;pandas==2.1.4&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;numpy==1.24.4&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;scikit-learn==1.6.1&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;joblib==1.4.2&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;pyarrow==19.0.1&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;kfp==2.12.1&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">split_and_scale_data</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    x_data_path<span style="color:#1f2328">:</span> InputPath<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;Dataset&#39;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    y_data_path<span style="color:#1f2328">:</span> InputPath<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;Dataset&#39;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    feature_names_json<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    use_scaling<span style="color:#1f2328">:</span> <span style="color:#6639ba">bool</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Outputs</span>
</span></span><span style="display:flex;"><span>    x_train_path<span style="color:#1f2328">:</span> OutputPath<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;Dataset&#39;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    x_test_path<span style="color:#1f2328">:</span> OutputPath<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;Dataset&#39;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    y_train_path<span style="color:#1f2328">:</span> OutputPath<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;Dataset&#39;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    y_test_path<span style="color:#1f2328">:</span> OutputPath<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;Dataset&#39;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    scaler_path<span style="color:#1f2328">:</span> OutputPath<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;Artifact&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">pandas</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">pd</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">numpy</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">np</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">joblib</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">json</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">from</span> <span style="color:#24292e">sklearn.model_selection</span> <span style="color:#cf222e">import</span> train_test_split
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">from</span> <span style="color:#24292e">sklearn.preprocessing</span> <span style="color:#cf222e">import</span> MinMaxScaler
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">os</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;--- Step 2: Split and Scale Data ---&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Use Scaling: </span><span style="color:#0a3069">{</span>use_scaling<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Load Inputs</span>
</span></span><span style="display:flex;"><span>    X_data <span style="color:#0550ae">=</span> pd<span style="color:#0550ae">.</span>read_parquet<span style="color:#1f2328">(</span>x_data_path<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    y_data <span style="color:#0550ae">=</span> pd<span style="color:#0550ae">.</span>read_parquet<span style="color:#1f2328">(</span>y_data_path<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    y_data <span style="color:#0550ae">=</span> y_data<span style="color:#0550ae">.</span>iloc<span style="color:#1f2328">[:,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Loaded X shape: </span><span style="color:#0a3069">{</span>X_data<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">, y shape: </span><span style="color:#0a3069">{</span>y_data<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    feature_names <span style="color:#0550ae">=</span> json<span style="color:#0550ae">.</span>loads<span style="color:#1f2328">(</span>feature_names_json<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Loaded feature names list (</span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>feature_names<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> features).&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Split</span>
</span></span><span style="display:flex;"><span>    X_train<span style="color:#1f2328">,</span> X_test<span style="color:#1f2328">,</span> y_train<span style="color:#1f2328">,</span> y_test <span style="color:#0550ae">=</span> train_test_split<span style="color:#1f2328">(</span>X_data<span style="color:#1f2328">,</span> y_data<span style="color:#1f2328">,</span> test_size<span style="color:#0550ae">=</span><span style="color:#0550ae">0.2</span><span style="color:#1f2328">,</span> random_state<span style="color:#0550ae">=</span><span style="color:#0550ae">42</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;X_train: </span><span style="color:#0a3069">{</span>X_train<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">, X_test: </span><span style="color:#0a3069">{</span>X_test<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">, y_train: </span><span style="color:#0a3069">{</span>y_train<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">, y_test: </span><span style="color:#0a3069">{</span>y_test<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Scale</span>
</span></span><span style="display:flex;"><span>    X_scaler <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>    scaler_saved <span style="color:#0550ae">=</span> <span style="color:#cf222e">False</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> use_scaling<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Applying MinMaxScaler.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        X_scaler <span style="color:#0550ae">=</span> MinMaxScaler<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Fit on Training, Transform Train and Test</span>
</span></span><span style="display:flex;"><span>        X_train_scaled_np <span style="color:#0550ae">=</span> X_scaler<span style="color:#0550ae">.</span>fit_transform<span style="color:#1f2328">(</span>X_train<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        X_test_scaled_np <span style="color:#0550ae">=</span> X_scaler<span style="color:#0550ae">.</span>transform<span style="color:#1f2328">(</span>X_test<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Convert back to DataFrame with original index and columns</span>
</span></span><span style="display:flex;"><span>        X_train <span style="color:#0550ae">=</span> pd<span style="color:#0550ae">.</span>DataFrame<span style="color:#1f2328">(</span>X_train_scaled_np<span style="color:#1f2328">,</span> columns<span style="color:#0550ae">=</span>feature_names<span style="color:#1f2328">,</span> index<span style="color:#0550ae">=</span>X_train<span style="color:#0550ae">.</span>index<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        X_test <span style="color:#0550ae">=</span> pd<span style="color:#0550ae">.</span>DataFrame<span style="color:#1f2328">(</span>X_test_scaled_np<span style="color:#1f2328">,</span> columns<span style="color:#0550ae">=</span>feature_names<span style="color:#1f2328">,</span> index<span style="color:#0550ae">=</span>X_test<span style="color:#0550ae">.</span>index<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;X_train range (scaled): </span><span style="color:#0a3069">{</span>X_train<span style="color:#0550ae">.</span>values<span style="color:#0550ae">.</span>min<span style="color:#1f2328">()</span><span style="color:#0a3069">:</span><span style="color:#0a3069">.4f</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> to </span><span style="color:#0a3069">{</span>X_train<span style="color:#0550ae">.</span>values<span style="color:#0550ae">.</span>max<span style="color:#1f2328">()</span><span style="color:#0a3069">:</span><span style="color:#0a3069">.4f</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Save the scaler</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Saving scaler to: </span><span style="color:#0a3069">{</span>scaler_path<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        joblib<span style="color:#0550ae">.</span>dump<span style="color:#1f2328">(</span>X_scaler<span style="color:#1f2328">,</span> scaler_path<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        scaler_saved <span style="color:#0550ae">=</span> <span style="color:#cf222e">True</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Using Original Features (No Scaling).&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;No scaler used, creating empty placeholder artifact at: </span><span style="color:#0a3069">{</span>scaler_path<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">with</span> <span style="color:#6639ba">open</span><span style="color:#1f2328">(</span>scaler_path<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;w&#39;</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">as</span> f<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            f<span style="color:#0550ae">.</span>write<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Save Outputs</span>
</span></span><span style="display:flex;"><span>    X_train<span style="color:#0550ae">.</span>to_parquet<span style="color:#1f2328">(</span>x_train_path<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    X_test<span style="color:#0550ae">.</span>to_parquet<span style="color:#1f2328">(</span>x_test_path<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    pd<span style="color:#0550ae">.</span>DataFrame<span style="color:#1f2328">(</span>y_train<span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>to_parquet<span style="color:#1f2328">(</span>y_train_path<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    pd<span style="color:#0550ae">.</span>DataFrame<span style="color:#1f2328">(</span>y_test<span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>to_parquet<span style="color:#1f2328">(</span>y_test_path<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;--- Step 2 Complete (Scaler Saved: </span><span style="color:#0a3069">{</span>scaler_saved<span style="color:#0a3069">}</span><span style="color:#0a3069">) ---&#34;</span><span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>
  </div>
</details>
<h3 id="step-3---train-model">Step 3 - Train Model</h3>
<p>An XGBoost model is trained using the core API, with the run tracked via MLflow. The model is saved in .bst format as required by KServe.</p>

<details class="details-shortcode " >
  <summary class="details-shortcode__summary">
    Component 3 - python code
  </summary>
  <div class="details-shortcode__content">
    
    
    





<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#57606a"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Component 3: Train Model</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#0550ae">@dsl.component</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    base_image<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;python:3.10&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    packages_to_install<span style="color:#0550ae">=</span><span style="color:#1f2328">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;pandas==2.1.4&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;numpy==1.24.4&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;xgboost==2.1.1&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;mlflow==2.21.3&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;pyarrow==19.0.1&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;joblib==1.4.2&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;kfp==2.12.1&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;scikit-learn==1.6.1&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">train_model</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Data inputs</span>
</span></span><span style="display:flex;"><span>    x_train_path<span style="color:#1f2328">:</span> InputPath<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;Dataset&#39;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    x_test_path<span style="color:#1f2328">:</span> InputPath<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;Dataset&#39;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    y_train_path<span style="color:#1f2328">:</span> InputPath<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;Dataset&#39;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    y_test_path<span style="color:#1f2328">:</span> InputPath<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;Dataset&#39;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    scaler_path<span style="color:#1f2328">:</span> InputPath<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;Artifact&#39;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    use_scaling<span style="color:#1f2328">:</span> <span style="color:#6639ba">bool</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>    feature_names_json<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Hyperparameters</span>
</span></span><span style="display:flex;"><span>    n_estimators<span style="color:#1f2328">:</span> <span style="color:#6639ba">int</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    learning_rate<span style="color:#1f2328">:</span> <span style="color:#6639ba">float</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    max_depth<span style="color:#1f2328">:</span> <span style="color:#6639ba">int</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    early_stopping_rounds<span style="color:#1f2328">:</span> <span style="color:#6639ba">int</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    colsample_bytree<span style="color:#1f2328">:</span> <span style="color:#6639ba">float</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    min_child_weight<span style="color:#1f2328">:</span> <span style="color:#6639ba">int</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    subsample<span style="color:#1f2328">:</span> <span style="color:#6639ba">float</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    random_state<span style="color:#1f2328">:</span> <span style="color:#6639ba">int</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># MLflow info</span>
</span></span><span style="display:flex;"><span>    run_name<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    mlflow_tracking_uri<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    mlflow_experiment_name<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Outputs</span>
</span></span><span style="display:flex;"><span>    output_model<span style="color:#1f2328">:</span> Output<span style="color:#1f2328">[</span>Model<span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> NamedTuple<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;TrainOutput&#39;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;mlflow_run_id_out&#39;</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">]):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Define NamedTuple</span>
</span></span><span style="display:flex;"><span>    TrainOutput <span style="color:#0550ae">=</span> NamedTuple<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;TrainOutput&#39;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">[(</span><span style="color:#0a3069">&#39;mlflow_run_id_out&#39;</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">)])</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">pandas</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">pd</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">numpy</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">np</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">xgboost</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">xgb</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">mlflow</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">mlflow.xgboost</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">os</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">joblib</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">json</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">from</span> <span style="color:#24292e">pathlib</span> <span style="color:#cf222e">import</span> Path
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">warnings</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Ignore the UBJSON format warning during saving</span>
</span></span><span style="display:flex;"><span>    warnings<span style="color:#0550ae">.</span>filterwarnings<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;ignore&#39;</span><span style="color:#1f2328">,</span> category<span style="color:#0550ae">=</span>UserWarning<span style="color:#1f2328">,</span> module<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;xgboost.core&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;--- Step 3: Train Model ---&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;MLflow Tracking URI: </span><span style="color:#0a3069">{</span>mlflow_tracking_uri<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;MLflow Experiment Name: </span><span style="color:#0a3069">{</span>mlflow_experiment_name<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Using XGBoost version: </span><span style="color:#0a3069">{</span>xgb<span style="color:#0550ae">.</span>__version__<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Hyperparameters: n_est=</span><span style="color:#0a3069">{</span>n_estimators<span style="color:#0a3069">}</span><span style="color:#0a3069">, lr=</span><span style="color:#0a3069">{</span>learning_rate<span style="color:#0a3069">}</span><span style="color:#0a3069">, depth=</span><span style="color:#0a3069">{</span>max_depth<span style="color:#0a3069">}</span><span style="color:#0a3069">, early_stop=</span><span style="color:#0a3069">{</span>early_stopping_rounds<span style="color:#0a3069">}</span><span style="color:#0a3069">, colsample=</span><span style="color:#0a3069">{</span>colsample_bytree<span style="color:#0a3069">}</span><span style="color:#0a3069">, min_child=</span><span style="color:#0a3069">{</span>min_child_weight<span style="color:#0a3069">}</span><span style="color:#0a3069">, subsample=</span><span style="color:#0a3069">{</span>subsample<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Load Data</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Loading training/testing data&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    X_train_df <span style="color:#0550ae">=</span> pd<span style="color:#0550ae">.</span>read_parquet<span style="color:#1f2328">(</span>x_train_path<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    X_test_df <span style="color:#0550ae">=</span> pd<span style="color:#0550ae">.</span>read_parquet<span style="color:#1f2328">(</span>x_test_path<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    y_train_df <span style="color:#0550ae">=</span> pd<span style="color:#0550ae">.</span>read_parquet<span style="color:#1f2328">(</span>y_train_path<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    y_test_df <span style="color:#0550ae">=</span> pd<span style="color:#0550ae">.</span>read_parquet<span style="color:#1f2328">(</span>y_test_path<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Ensure y is a 1D array</span>
</span></span><span style="display:flex;"><span>    y_train <span style="color:#0550ae">=</span> y_train_df<span style="color:#0550ae">.</span>iloc<span style="color:#1f2328">[:,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>values
</span></span><span style="display:flex;"><span>    y_test <span style="color:#0550ae">=</span> y_test_df<span style="color:#0550ae">.</span>iloc<span style="color:#1f2328">[:,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>values
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Get feature names and enforce order in DataFrame</span>
</span></span><span style="display:flex;"><span>    feature_names <span style="color:#0550ae">=</span> json<span style="color:#0550ae">.</span>loads<span style="color:#1f2328">(</span>feature_names_json<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Loaded feature names list (</span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>feature_names<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> features).&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Ensure feature order matches the expected order</span>
</span></span><span style="display:flex;"><span>    X_train <span style="color:#0550ae">=</span> X_train_df<span style="color:#1f2328">[</span>feature_names<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    X_test <span style="color:#0550ae">=</span> X_test_df<span style="color:#1f2328">[</span>feature_names<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Verified feature order in datasets. X_train: </span><span style="color:#0a3069">{</span>X_train<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">, X_test: </span><span style="color:#0a3069">{</span>X_test<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Convert to NumPy FOR TRAINING - crucial step</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Converting data to NumPy arrays for DMatrix creation...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    X_train_np <span style="color:#0550ae">=</span> X_train_df<span style="color:#0550ae">.</span>values
</span></span><span style="display:flex;"><span>    X_test_np <span style="color:#0550ae">=</span> X_test_df<span style="color:#0550ae">.</span>values
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># MLflow Setup and Start Run</span>
</span></span><span style="display:flex;"><span>    mlflow<span style="color:#0550ae">.</span>set_tracking_uri<span style="color:#1f2328">(</span>mlflow_tracking_uri<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    mlflow<span style="color:#0550ae">.</span>set_experiment<span style="color:#1f2328">(</span>mlflow_experiment_name<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Configure MLflow autologging - DISABLE model logging</span>
</span></span><span style="display:flex;"><span>    mlflow<span style="color:#0550ae">.</span>xgboost<span style="color:#0550ae">.</span>autolog<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        log_input_examples<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        log_model_signatures<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        log_models<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        log_datasets<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        disable<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        registered_model_name<span style="color:#0550ae">=</span><span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Start MLflow Run</span>
</span></span><span style="display:flex;"><span>    kfp_run_id <span style="color:#0550ae">=</span> os<span style="color:#0550ae">.</span>environ<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;KFP_RUN_ID&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;local&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    final_run_name <span style="color:#0550ae">=</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">{</span>run_name<span style="color:#0a3069">}</span><span style="color:#0a3069">_</span><span style="color:#0a3069">{</span>kfp_run_id<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Starting MLflow run with name: </span><span style="color:#0a3069">{</span>final_run_name<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">with</span> mlflow<span style="color:#0550ae">.</span>start_run<span style="color:#1f2328">(</span>run_name<span style="color:#0550ae">=</span>final_run_name<span style="color:#1f2328">)</span> <span style="color:#cf222e">as</span> run<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        current_run_id <span style="color:#0550ae">=</span> run<span style="color:#0550ae">.</span>info<span style="color:#0550ae">.</span>run_id
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Started MLflow Run ID: </span><span style="color:#0a3069">{</span>current_run_id<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Log parameters</span>
</span></span><span style="display:flex;"><span>        mlflow<span style="color:#0550ae">.</span>log_params<span style="color:#1f2328">({</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;feature_set_name&#34;</span><span style="color:#1f2328">:</span> final_run_name<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;num_features&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>feature_names<span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;use_scaling&#34;</span><span style="color:#1f2328">:</span> use_scaling<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;n_estimators&#34;</span><span style="color:#1f2328">:</span> n_estimators<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;learning_rate&#34;</span><span style="color:#1f2328">:</span> learning_rate<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;max_depth&#34;</span><span style="color:#1f2328">:</span> max_depth<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;early_stopping_rounds&#34;</span><span style="color:#1f2328">:</span> early_stopping_rounds<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;colsample_bytree&#34;</span><span style="color:#1f2328">:</span> colsample_bytree<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;min_child_weight&#34;</span><span style="color:#1f2328">:</span> min_child_weight<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;subsample&#34;</span><span style="color:#1f2328">:</span> subsample<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;random_state&#34;</span><span style="color:#1f2328">:</span> random_state<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;model_type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;XGBoost&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;training_api&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;xgb.train&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;framework&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;xgboost==</span><span style="color:#0a3069">{</span>xgb<span style="color:#0550ae">.</span>__version__<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Log feature names as artifact</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            temp_feat_path <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;feature_names.json&#34;</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">with</span> <span style="color:#6639ba">open</span><span style="color:#1f2328">(</span>temp_feat_path<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;w&#34;</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">as</span> f<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                json<span style="color:#0550ae">.</span>dump<span style="color:#1f2328">(</span>feature_names<span style="color:#1f2328">,</span> f<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            mlflow<span style="color:#0550ae">.</span>log_artifact<span style="color:#1f2328">(</span>temp_feat_path<span style="color:#1f2328">,</span> artifact_path<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;features&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Feature names list logged as artifact.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Warning: Could not log feature names artifact: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Log scaler artifact if used</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> use_scaling <span style="color:#0550ae">and</span> os<span style="color:#0550ae">.</span>path<span style="color:#0550ae">.</span>exists<span style="color:#1f2328">(</span>scaler_path<span style="color:#1f2328">)</span> <span style="color:#0550ae">and</span> os<span style="color:#0550ae">.</span>path<span style="color:#0550ae">.</span>getsize<span style="color:#1f2328">(</span>scaler_path<span style="color:#1f2328">)</span> <span style="color:#0550ae">&gt;</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                mlflow<span style="color:#0550ae">.</span>log_artifact<span style="color:#1f2328">(</span>scaler_path<span style="color:#1f2328">,</span> artifact_path<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;scaler&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Scaler logged as artifact to MLflow.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Warning: Could not log scaler artifact: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Model Training using Core API</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Creating DMatrix WITHOUT feature names...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        dtrain <span style="color:#0550ae">=</span> xgb<span style="color:#0550ae">.</span>DMatrix<span style="color:#1f2328">(</span>X_train_np<span style="color:#1f2328">,</span> label<span style="color:#0550ae">=</span>y_train<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        dtest <span style="color:#0550ae">=</span> xgb<span style="color:#0550ae">.</span>DMatrix<span style="color:#1f2328">(</span>X_test_np<span style="color:#1f2328">,</span> label<span style="color:#0550ae">=</span>y_test<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;DMatrix created.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Training XGBoost model using xgb.train...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        params <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#39;objective&#39;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#39;reg:squarederror&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#39;learning_rate&#39;</span><span style="color:#1f2328">:</span> learning_rate<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#39;max_depth&#39;</span><span style="color:#1f2328">:</span> max_depth<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#39;subsample&#39;</span><span style="color:#1f2328">:</span> subsample<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#39;colsample_bytree&#39;</span><span style="color:#1f2328">:</span> colsample_bytree<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#39;min_child_weight&#39;</span><span style="color:#1f2328">:</span> min_child_weight<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#39;random_state&#39;</span><span style="color:#1f2328">:</span> random_state<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#39;eval_metric&#39;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#39;rmse&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        evals <span style="color:#0550ae">=</span> <span style="color:#1f2328">[(</span>dtrain<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;train&#39;</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">(</span>dtest<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;eval&#39;</span><span style="color:#1f2328">)]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Train the model - returns the booster object</span>
</span></span><span style="display:flex;"><span>        bst_model <span style="color:#0550ae">=</span> xgb<span style="color:#0550ae">.</span>train<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>            params<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            dtrain<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            num_boost_round<span style="color:#0550ae">=</span>n_estimators<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            evals<span style="color:#0550ae">=</span>evals<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            early_stopping_rounds<span style="color:#0550ae">=</span>early_stopping_rounds<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            verbose_eval<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Training complete. Best iteration: </span><span style="color:#0a3069">{</span>bst_model<span style="color:#0550ae">.</span>best_iteration<span style="color:#0a3069">}</span><span style="color:#0a3069">, Best score (RMSE): </span><span style="color:#0a3069">{</span>bst_model<span style="color:#0550ae">.</span>best_score<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Save Model Manually (Binary Format)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            model_dir <span style="color:#0550ae">=</span> Path<span style="color:#1f2328">(</span>output_model<span style="color:#0550ae">.</span>path<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            model_dir<span style="color:#0550ae">.</span>mkdir<span style="color:#1f2328">(</span>parents<span style="color:#0550ae">=</span><span style="color:#cf222e">True</span><span style="color:#1f2328">,</span> exist_ok<span style="color:#0550ae">=</span><span style="color:#cf222e">True</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            model_file_path <span style="color:#0550ae">=</span> model_dir <span style="color:#0550ae">/</span> <span style="color:#0a3069">&#34;model.bst&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Saving model in binary format to: </span><span style="color:#0a3069">{</span>model_file_path<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            bst_model<span style="color:#0550ae">.</span>save_model<span style="color:#1f2328">(</span>model_file_path<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># Verify the model was saved</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> model_file_path<span style="color:#0550ae">.</span>exists<span style="color:#1f2328">()</span> <span style="color:#0550ae">or</span> model_file_path<span style="color:#0550ae">.</span>stat<span style="color:#1f2328">()</span><span style="color:#0550ae">.</span>st_size <span style="color:#0550ae">==</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">raise</span> RuntimeError<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Failed to save model or model file is empty at </span><span style="color:#0a3069">{</span>model_file_path<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Model successfully saved locally to </span><span style="color:#0a3069">{</span>model_file_path<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># Log Model Manually to MLflow</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Logging model artifact to MLflow...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            mlflow<span style="color:#0550ae">.</span>log_artifact<span style="color:#1f2328">(</span>model_file_path<span style="color:#1f2328">,</span> artifact_path<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;model&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#0a3069">&#39;temp_feat_path&#39;</span> <span style="color:#0550ae">in</span> <span style="color:#6639ba">locals</span><span style="color:#1f2328">()</span> <span style="color:#0550ae">and</span> Path<span style="color:#1f2328">(</span>temp_feat_path<span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>exists<span style="color:#1f2328">():</span> 
</span></span><span style="display:flex;"><span>                mlflow<span style="color:#0550ae">.</span>log_artifact<span style="color:#1f2328">(</span>temp_feat_path<span style="color:#1f2328">,</span> artifact_path<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;model&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                os<span style="color:#0550ae">.</span>remove<span style="color:#1f2328">(</span>temp_feat_path<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Model artifacts logged to MLflow run.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># Set KFP output model metadata </span>
</span></span><span style="display:flex;"><span>            output_model<span style="color:#0550ae">.</span>metadata<span style="color:#0550ae">.</span>update<span style="color:#1f2328">({</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;framework&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;xgboost&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;format&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;bst&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;feature_order&#34;</span><span style="color:#1f2328">:</span> json<span style="color:#0550ae">.</span>dumps<span style="color:#1f2328">(</span>feature_names<span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;feature_count&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">(</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>feature_names<span style="color:#1f2328">)),</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;best_iteration&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>bst_model<span style="color:#0550ae">.</span>best_iteration<span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;best_score&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>bst_model<span style="color:#0550ae">.</span>best_score<span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;training_samples&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">(</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>X_train_np<span style="color:#1f2328">)),</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;validation_samples&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">(</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>X_test_np<span style="color:#1f2328">)),</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;mlflow_run_id&#34;</span><span style="color:#1f2328">:</span> current_run_id
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Error saving/logging model artifacts: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>e<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">raise</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;--- Step 3 Complete (MLflow Run ID: </span><span style="color:#0a3069">{</span>current_run_id<span style="color:#0a3069">}</span><span style="color:#0a3069">) ---&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> TrainOutput<span style="color:#1f2328">(</span>mlflow_run_id_out<span style="color:#0550ae">=</span>current_run_id<span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>
  </div>
</details>
<h3 id="step-4---predict--evaluate">Step 4 - Predict &amp; Evaluate</h3>
<p>The trained model is used to predict on test data, and performance metrics are logged to MLflow.</p>

<details class="details-shortcode " >
  <summary class="details-shortcode__summary">
    Component 4 - python code
  </summary>
  <div class="details-shortcode__content">
    
    
    





<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#57606a"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Component 4: Predict and Evaluate</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#0550ae">@dsl.component</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    base_image<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;python:3.10&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    packages_to_install<span style="color:#0550ae">=</span><span style="color:#1f2328">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;pandas==2.1.4&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;numpy==1.24.4&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;xgboost==2.1.1&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;scikit-learn==1.6.1&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;mlflow==2.21.3&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;pyarrow==19.0.1&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;joblib==1.4.2&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;kfp==2.12.1&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">predict_and_evaluate</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    input_model<span style="color:#1f2328">:</span> Input<span style="color:#1f2328">[</span>Model<span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>    x_test_path<span style="color:#1f2328">:</span> InputPath<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;Dataset&#39;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    y_test_path<span style="color:#1f2328">:</span> InputPath<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;Dataset&#39;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    mlflow_run_id<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    mlflow_tracking_uri<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    feature_names_json<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Outputs</span>
</span></span><span style="display:flex;"><span>    y_pred_path<span style="color:#1f2328">:</span> OutputPath<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;Dataset&#39;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    test_rmse_output<span style="color:#1f2328">:</span> OutputPath<span style="color:#1f2328">(</span><span style="color:#6639ba">float</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    test_mae_output<span style="color:#1f2328">:</span> OutputPath<span style="color:#1f2328">(</span><span style="color:#6639ba">float</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    test_r2_output<span style="color:#1f2328">:</span> OutputPath<span style="color:#1f2328">(</span><span style="color:#6639ba">float</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">pandas</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">pd</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">numpy</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">np</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">xgboost</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">xgb</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">mlflow</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">joblib</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">os</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">from</span> <span style="color:#24292e">sklearn.metrics</span> <span style="color:#cf222e">import</span> mean_squared_error<span style="color:#1f2328">,</span> mean_absolute_error<span style="color:#1f2328">,</span> r2_score
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">json</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">from</span> <span style="color:#24292e">pathlib</span> <span style="color:#cf222e">import</span> Path
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;--- Step 4: Predict and Evaluate ---&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Using XGBoost version: </span><span style="color:#0a3069">{</span>xgb<span style="color:#0550ae">.</span>__version__<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Load Inputs</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Loading model...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    model_dir <span style="color:#0550ae">=</span> Path<span style="color:#1f2328">(</span>input_model<span style="color:#0550ae">.</span>path<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Look for model.bst</span>
</span></span><span style="display:flex;"><span>    model_file_bst <span style="color:#0550ae">=</span> model_dir <span style="color:#0550ae">/</span> <span style="color:#0a3069">&#34;model.bst&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> model_file_bst<span style="color:#0550ae">.</span>exists<span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">raise</span> FileNotFoundError<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Model file &#39;model.bst&#39; not found at </span><span style="color:#0a3069">{</span>model_dir<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Loading XGBoost model from </span><span style="color:#0a3069">{</span>model_file_bst<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Load model using Booster interface</span>
</span></span><span style="display:flex;"><span>    booster <span style="color:#0550ae">=</span> xgb<span style="color:#0550ae">.</span>Booster<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    booster<span style="color:#0550ae">.</span>load_model<span style="color:#1f2328">(</span>model_file_bst<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Model loaded successfully.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Loading test data...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    X_test_df <span style="color:#0550ae">=</span> pd<span style="color:#0550ae">.</span>read_parquet<span style="color:#1f2328">(</span>x_test_path<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    y_test_df <span style="color:#0550ae">=</span> pd<span style="color:#0550ae">.</span>read_parquet<span style="color:#1f2328">(</span>y_test_path<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    y_test <span style="color:#0550ae">=</span> y_test_df<span style="color:#0550ae">.</span>iloc<span style="color:#1f2328">[:,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>values
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Load feature names to ensure correct column order in X_test_df</span>
</span></span><span style="display:flex;"><span>    feature_names <span style="color:#0550ae">=</span> json<span style="color:#0550ae">.</span>loads<span style="color:#1f2328">(</span>feature_names_json<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Ensuring test data feature order using: </span><span style="color:#0a3069">{</span>feature_names<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        X_test_df <span style="color:#0550ae">=</span> X_test_df<span style="color:#1f2328">[</span>feature_names<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">except</span> KeyError <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Error: Feature mismatch when ordering X_test columns: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        missing <span style="color:#0550ae">=</span> <span style="color:#6639ba">set</span><span style="color:#1f2328">(</span>feature_names<span style="color:#1f2328">)</span> <span style="color:#0550ae">-</span> <span style="color:#6639ba">set</span><span style="color:#1f2328">(</span>X_test_df<span style="color:#0550ae">.</span>columns<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> missing<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Features expected but missing in X_test data: </span><span style="color:#0a3069">{</span>missing<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">raise</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Configure MLflow Client</span>
</span></span><span style="display:flex;"><span>    mlflow<span style="color:#0550ae">.</span>set_tracking_uri<span style="color:#1f2328">(</span>mlflow_tracking_uri<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Using MLflow Run ID: </span><span style="color:#0a3069">{</span>mlflow_run_id<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Attempting to log metrics to existing MLflow run...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">with</span> mlflow<span style="color:#0550ae">.</span>start_run<span style="color:#1f2328">(</span>run_id<span style="color:#0550ae">=</span>mlflow_run_id<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Prediction</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Generating predictions...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Creating DMatrix from X_test data with shape: </span><span style="color:#0a3069">{</span>X_test_df<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        dtest <span style="color:#0550ae">=</span> xgb<span style="color:#0550ae">.</span>DMatrix<span style="color:#1f2328">(</span>X_test_df<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        y_pred <span style="color:#0550ae">=</span> booster<span style="color:#0550ae">.</span>predict<span style="color:#1f2328">(</span>dtest<span style="color:#1f2328">)</span>        
</span></span><span style="display:flex;"><span>        y_pred <span style="color:#0550ae">=</span> np<span style="color:#0550ae">.</span>array<span style="color:#1f2328">(</span>y_pred<span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>ravel<span style="color:#1f2328">()</span> <span style="color:#57606a"># Ensure y_pred is a flat NumPy array</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Predictions generated with shape: </span><span style="color:#0a3069">{</span>y_pred<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Evaluation</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Calculating evaluation metrics...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Handle potential NaN/inf</span>
</span></span><span style="display:flex;"><span>        valid_indices <span style="color:#0550ae">=</span> <span style="color:#0550ae">~</span>np<span style="color:#0550ae">.</span>isnan<span style="color:#1f2328">(</span>y_test<span style="color:#1f2328">)</span> <span style="color:#0550ae">&amp;</span> <span style="color:#0550ae">~</span>np<span style="color:#0550ae">.</span>isinf<span style="color:#1f2328">(</span>y_test<span style="color:#1f2328">)</span> <span style="color:#0550ae">&amp;</span> <span style="color:#0550ae">~</span>np<span style="color:#0550ae">.</span>isnan<span style="color:#1f2328">(</span>y_pred<span style="color:#1f2328">)</span> <span style="color:#0550ae">&amp;</span> <span style="color:#0550ae">~</span>np<span style="color:#0550ae">.</span>isinf<span style="color:#1f2328">(</span>y_pred<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> np<span style="color:#0550ae">.</span>all<span style="color:#1f2328">(</span>valid_indices<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Warning: NaN or Inf detected... &#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            y_test_valid <span style="color:#0550ae">=</span> y_test<span style="color:#1f2328">[</span>valid_indices<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>            y_pred_valid <span style="color:#0550ae">=</span> y_pred<span style="color:#1f2328">[</span>valid_indices<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            y_test_valid <span style="color:#0550ae">=</span> y_test
</span></span><span style="display:flex;"><span>            y_pred_valid <span style="color:#0550ae">=</span> y_pred
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Check if any valid data remains after filtering</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>y_test_valid<span style="color:#1f2328">)</span> <span style="color:#0550ae">==</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>             <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Error: No valid data points remain after filtering NaN/Inf. Cannot calculate metrics.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>             rmse<span style="color:#1f2328">,</span> mae<span style="color:#1f2328">,</span> r2 <span style="color:#0550ae">=</span> np<span style="color:#0550ae">.</span>nan<span style="color:#1f2328">,</span> np<span style="color:#0550ae">.</span>nan<span style="color:#1f2328">,</span> np<span style="color:#0550ae">.</span>nan
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            mse <span style="color:#0550ae">=</span> mean_squared_error<span style="color:#1f2328">(</span>y_test_valid<span style="color:#1f2328">,</span> y_pred_valid<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            rmse <span style="color:#0550ae">=</span> np<span style="color:#0550ae">.</span>sqrt<span style="color:#1f2328">(</span>mse<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            mae <span style="color:#0550ae">=</span> mean_absolute_error<span style="color:#1f2328">(</span>y_test_valid<span style="color:#1f2328">,</span> y_pred_valid<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            r2 <span style="color:#0550ae">=</span> r2_score<span style="color:#1f2328">(</span>y_test_valid<span style="color:#1f2328">,</span> y_pred_valid<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Get best iteration from metadata if available</span>
</span></span><span style="display:flex;"><span>        best_iteration <span style="color:#0550ae">=</span> <span style="color:#6639ba">int</span><span style="color:#1f2328">(</span>input_model<span style="color:#0550ae">.</span>metadata<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;best_iteration&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">))</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Log Metrics to MLflow</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Logging metrics to MLflow...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        mlflow<span style="color:#0550ae">.</span>log_metrics<span style="color:#1f2328">({</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;eval_mse&#34;</span><span style="color:#1f2328">:</span> mse <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> np<span style="color:#0550ae">.</span>isnan<span style="color:#1f2328">(</span>mse<span style="color:#1f2328">)</span> <span style="color:#cf222e">else</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;eval_rmse&#34;</span><span style="color:#1f2328">:</span> rmse <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> np<span style="color:#0550ae">.</span>isnan<span style="color:#1f2328">(</span>rmse<span style="color:#1f2328">)</span> <span style="color:#cf222e">else</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;eval_mae&#34;</span><span style="color:#1f2328">:</span> mae <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> np<span style="color:#0550ae">.</span>isnan<span style="color:#1f2328">(</span>mae<span style="color:#1f2328">)</span> <span style="color:#cf222e">else</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;eval_r2&#34;</span><span style="color:#1f2328">:</span> r2 <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> np<span style="color:#0550ae">.</span>isnan<span style="color:#1f2328">(</span>r2<span style="color:#1f2328">)</span> <span style="color:#cf222e">else</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># Log best_iteration if valid</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0550ae">**</span><span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;best_iteration_eval&#34;</span><span style="color:#1f2328">:</span> best_iteration<span style="color:#1f2328">}</span> <span style="color:#cf222e">if</span> best_iteration <span style="color:#0550ae">!=</span> <span style="color:#0550ae">-</span><span style="color:#0550ae">1</span> <span style="color:#cf222e">else</span> <span style="color:#1f2328">{})</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">--- Evaluation Results ---&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Test Set MSE: </span><span style="color:#0a3069">{</span>mse<span style="color:#0a3069">:</span><span style="color:#0a3069">,.4f</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Test Set RMSE: </span><span style="color:#0a3069">{</span>rmse<span style="color:#0a3069">:</span><span style="color:#0a3069">,.4f</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Test Set MAE: </span><span style="color:#0a3069">{</span>mae<span style="color:#0a3069">:</span><span style="color:#0a3069">,.4f</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Test Set R²: </span><span style="color:#0a3069">{</span>r2<span style="color:#0a3069">:</span><span style="color:#0a3069">.4f</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> best_iteration <span style="color:#0550ae">!=</span> <span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Best Iteration (from training): </span><span style="color:#0a3069">{</span>best_iteration<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Save predictions as DataFrame/Parquet</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Saving predictions DataFrame (</span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>y_pred<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> rows) to: </span><span style="color:#0a3069">{</span>y_pred_path<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        pred_df <span style="color:#0550ae">=</span> pd<span style="color:#0550ae">.</span>DataFrame<span style="color:#1f2328">({</span><span style="color:#0a3069">&#39;predictions&#39;</span><span style="color:#1f2328">:</span> y_pred<span style="color:#1f2328">},</span> index<span style="color:#0550ae">=</span>X_test_df<span style="color:#0550ae">.</span>index<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        pred_df<span style="color:#0550ae">.</span>to_parquet<span style="color:#1f2328">(</span>y_pred_path<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>         <span style="color:#57606a"># Save metrics to KFP output paths</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">with</span> <span style="color:#6639ba">open</span><span style="color:#1f2328">(</span>test_rmse_output<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;w&#39;</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">as</span> f<span style="color:#1f2328">:</span> f<span style="color:#0550ae">.</span>write<span style="color:#1f2328">(</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>rmse <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> np<span style="color:#0550ae">.</span>isnan<span style="color:#1f2328">(</span>rmse<span style="color:#1f2328">)</span> <span style="color:#cf222e">else</span> <span style="color:#0550ae">0.0</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">with</span> <span style="color:#6639ba">open</span><span style="color:#1f2328">(</span>test_mae_output<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;w&#39;</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">as</span> f<span style="color:#1f2328">:</span> f<span style="color:#0550ae">.</span>write<span style="color:#1f2328">(</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>mae <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> np<span style="color:#0550ae">.</span>isnan<span style="color:#1f2328">(</span>mae<span style="color:#1f2328">)</span> <span style="color:#cf222e">else</span> <span style="color:#0550ae">0.0</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">with</span> <span style="color:#6639ba">open</span><span style="color:#1f2328">(</span>test_r2_output<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;w&#39;</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">as</span> f<span style="color:#1f2328">:</span> f<span style="color:#0550ae">.</span>write<span style="color:#1f2328">(</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>r2 <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> np<span style="color:#0550ae">.</span>isnan<span style="color:#1f2328">(</span>r2<span style="color:#1f2328">)</span> <span style="color:#cf222e">else</span> <span style="color:#0550ae">0.0</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;--- Step 4 Complete ---&#34;</span><span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>
  </div>
</details>
<h3 id="step-5---generate--log-plot">Step 5 - Generate &amp; Log Plot</h3>
<p>This component visualizes key performance metrics and logs the resulting plots to the MLflow run.</p>

<details class="details-shortcode " >
  <summary class="details-shortcode__summary">
    Component 5 - python code
  </summary>
  <div class="details-shortcode__content">
    
    
    





<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#57606a"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Component 5: Generate and Log Plots</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#0550ae">@dsl.component</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    base_image<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;python:3.10&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    packages_to_install<span style="color:#0550ae">=</span><span style="color:#1f2328">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;pandas==2.1.4&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;numpy==1.24.4&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;xgboost==2.1.1&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;matplotlib==3.10.0&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;mlflow==2.21.3&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;joblib==1.4.2&#39;</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;pyarrow==19.0.1&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;kfp==2.12.1&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">generate_and_log_plots</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    input_model<span style="color:#1f2328">:</span> Input<span style="color:#1f2328">[</span>Model<span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>    y_test_path<span style="color:#1f2328">:</span> InputPath<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;Dataset&#39;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    y_pred_path<span style="color:#1f2328">:</span> InputPath<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;Dataset&#39;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    feature_names_json<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    mlflow_run_id<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    mlflow_tracking_uri<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    run_name<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">pandas</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">pd</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">numpy</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">np</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">xgboost</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">xgb</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">from</span> <span style="color:#24292e">xgboost</span> <span style="color:#cf222e">import</span> plot_importance
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">matplotlib.pyplot</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">plt</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">mlflow</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">os</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">json</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">traceback</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">from</span> <span style="color:#24292e">pathlib</span> <span style="color:#cf222e">import</span> Path
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;--- Step 5: Generate and Log Plots ---&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Using XGBoost version: </span><span style="color:#0a3069">{</span>xgb<span style="color:#0550ae">.</span>__version__<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Load Inputs</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Loading model...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    model_dir <span style="color:#0550ae">=</span> Path<span style="color:#1f2328">(</span>input_model<span style="color:#0550ae">.</span>path<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Check for model file</span>
</span></span><span style="display:flex;"><span>    model_file_bst <span style="color:#0550ae">=</span> model_dir <span style="color:#0550ae">/</span> <span style="color:#0a3069">&#34;model.bst&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> model_file_bst<span style="color:#0550ae">.</span>exists<span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">raise</span> FileNotFoundError<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Model file &#39;model.bst&#39; not found at </span><span style="color:#0a3069">{</span>model_dir<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Loading XGBoost model from </span><span style="color:#0a3069">{</span>model_file_bst<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    booster <span style="color:#0550ae">=</span> xgb<span style="color:#0550ae">.</span>Booster<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    booster<span style="color:#0550ae">.</span>load_model<span style="color:#1f2328">(</span>model_file_bst<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Model loaded successfully.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Loading y_test data...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    y_test <span style="color:#0550ae">=</span> pd<span style="color:#0550ae">.</span>read_parquet<span style="color:#1f2328">(</span>y_test_path<span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>iloc<span style="color:#1f2328">[:,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>values <span style="color:#57606a"># Load as numpy array</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Loading feature names...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    feature_names <span style="color:#0550ae">=</span> json<span style="color:#0550ae">.</span>loads<span style="color:#1f2328">(</span>feature_names_json<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Loaded </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>feature_names<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> feature names.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> feature_names<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Setting feature names on loaded booster for plotting...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        booster<span style="color:#0550ae">.</span>feature_names <span style="color:#0550ae">=</span> feature_names
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Warning: Empty feature names list received. Importance plots might use default &#39;fN&#39; names.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Using MLflow Run ID: </span><span style="color:#0a3069">{</span>mlflow_run_id<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Load predictions</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Loading predictions from: </span><span style="color:#0a3069">{</span>y_pred_path<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        y_pred_df <span style="color:#0550ae">=</span> pd<span style="color:#0550ae">.</span>read_parquet<span style="color:#1f2328">(</span>y_pred_path<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        y_pred <span style="color:#0550ae">=</span> y_pred_df<span style="color:#0550ae">.</span>iloc<span style="color:#1f2328">[:,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>values <span style="color:#57606a"># Load as numpy array</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Loaded predictions, shape: </span><span style="color:#0a3069">{</span>y_pred<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Error loading predictions: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">raise</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Configure MLflow Client</span>
</span></span><span style="display:flex;"><span>    mlflow<span style="color:#0550ae">.</span>set_tracking_uri<span style="color:#1f2328">(</span>mlflow_tracking_uri<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Log plots to the existing MLflow run</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">with</span> mlflow<span style="color:#0550ae">.</span>start_run<span style="color:#1f2328">(</span>run_id<span style="color:#0550ae">=</span>mlflow_run_id<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Helper Functions</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">def</span> <span style="color:#6639ba">get_dynamic_figsize</span><span style="color:#1f2328">(</span>feature_count<span style="color:#1f2328">,</span> max_features<span style="color:#0550ae">=</span><span style="color:#0550ae">20</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            display_count <span style="color:#0550ae">=</span> <span style="color:#6639ba">min</span><span style="color:#1f2328">(</span>feature_count<span style="color:#1f2328">,</span> max_features<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            height <span style="color:#0550ae">=</span> <span style="color:#6639ba">max</span><span style="color:#1f2328">(</span><span style="color:#0550ae">6</span><span style="color:#1f2328">,</span> display_count <span style="color:#0550ae">*</span> <span style="color:#0550ae">0.4</span> <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            width <span style="color:#0550ae">=</span> <span style="color:#0550ae">10</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">(</span>width<span style="color:#1f2328">,</span> height<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Generate and Log Plots</span>
</span></span><span style="display:flex;"><span>        kfp_run_id <span style="color:#0550ae">=</span> os<span style="color:#0550ae">.</span>environ<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;KFP_RUN_ID&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;local&#39;</span><span style="color:#1f2328">)</span> 
</span></span><span style="display:flex;"><span>        final_run_name <span style="color:#0550ae">=</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">{</span>run_name<span style="color:#0a3069">}</span><span style="color:#0a3069">_</span><span style="color:#0a3069">{</span>kfp_run_id<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Generating and logging plots to MLflow...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Actual vs Predicted Plot</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            fig_pred<span style="color:#1f2328">,</span> ax_pred <span style="color:#0550ae">=</span> plt<span style="color:#0550ae">.</span>subplots<span style="color:#1f2328">(</span>figsize<span style="color:#0550ae">=</span><span style="color:#1f2328">(</span><span style="color:#0550ae">10</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">6</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>            valid_indices <span style="color:#0550ae">=</span> <span style="color:#0550ae">~</span>np<span style="color:#0550ae">.</span>isnan<span style="color:#1f2328">(</span>y_test_np<span style="color:#1f2328">)</span> <span style="color:#0550ae">&amp;</span> <span style="color:#0550ae">~</span>np<span style="color:#0550ae">.</span>isinf<span style="color:#1f2328">(</span>y_test_np<span style="color:#1f2328">)</span> <span style="color:#0550ae">&amp;</span> <span style="color:#0550ae">~</span>np<span style="color:#0550ae">.</span>isnan<span style="color:#1f2328">(</span>y_pred<span style="color:#1f2328">)</span> <span style="color:#0550ae">&amp;</span> <span style="color:#0550ae">~</span>np<span style="color:#0550ae">.</span>isinf<span style="color:#1f2328">(</span>y_pred<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            y_test_plt <span style="color:#0550ae">=</span> y_test_np<span style="color:#1f2328">[</span>valid_indices<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>            y_pred_plt <span style="color:#0550ae">=</span> y_pred<span style="color:#1f2328">[</span>valid_indices<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            ax_pred<span style="color:#0550ae">.</span>scatter<span style="color:#1f2328">(</span>y_test_plt<span style="color:#1f2328">,</span> y_pred_plt<span style="color:#1f2328">,</span> alpha<span style="color:#0550ae">=</span><span style="color:#0550ae">0.5</span><span style="color:#1f2328">,</span> label<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;Predictions&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            min_val <span style="color:#0550ae">=</span> <span style="color:#6639ba">min</span><span style="color:#1f2328">(</span>y_test_plt<span style="color:#0550ae">.</span>min<span style="color:#1f2328">(),</span> y_pred_plt<span style="color:#0550ae">.</span>min<span style="color:#1f2328">())</span> <span style="color:#0550ae">*</span> <span style="color:#0550ae">0.98</span>
</span></span><span style="display:flex;"><span>            max_val <span style="color:#0550ae">=</span> <span style="color:#6639ba">max</span><span style="color:#1f2328">(</span>y_test_plt<span style="color:#0550ae">.</span>max<span style="color:#1f2328">(),</span> y_pred_plt<span style="color:#0550ae">.</span>max<span style="color:#1f2328">())</span> <span style="color:#0550ae">*</span> <span style="color:#0550ae">1.02</span>
</span></span><span style="display:flex;"><span>            ax_pred<span style="color:#0550ae">.</span>plot<span style="color:#1f2328">([</span>min_val<span style="color:#1f2328">,</span> max_val<span style="color:#1f2328">],</span> <span style="color:#1f2328">[</span>min_val<span style="color:#1f2328">,</span> max_val<span style="color:#1f2328">],</span> <span style="color:#0a3069">&#39;--&#39;</span><span style="color:#1f2328">,</span> color<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;red&#39;</span><span style="color:#1f2328">,</span> linewidth<span style="color:#0550ae">=</span><span style="color:#0550ae">2</span><span style="color:#1f2328">,</span> label<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;Ideal Fit&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            ax_pred<span style="color:#0550ae">.</span>set_xlabel<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;Actual Target&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            ax_pred<span style="color:#0550ae">.</span>set_ylabel<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;Predicted Target&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            ax_pred<span style="color:#0550ae">.</span>set_title<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#39;Actual vs. Predicted (</span><span style="color:#0a3069">{</span>final_run_name<span style="color:#0a3069">}</span><span style="color:#0a3069">)&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            ax_pred<span style="color:#0550ae">.</span>legend<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            ax_pred<span style="color:#0550ae">.</span>grid<span style="color:#1f2328">(</span><span style="color:#cf222e">True</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            plt<span style="color:#0550ae">.</span>tight_layout<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            mlflow<span style="color:#0550ae">.</span>log_figure<span style="color:#1f2328">(</span>fig_pred<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;plots/actual_vs_predicted.png&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            plt<span style="color:#0550ae">.</span>close<span style="color:#1f2328">(</span>fig_pred<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Logged actual_vs_predicted.png&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Warning: Could not plot Actual vs Predicted: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">{</span>traceback<span style="color:#0550ae">.</span>format_exc<span style="color:#1f2328">()</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Feature Importance Plots</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            num_features <span style="color:#0550ae">=</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>booster<span style="color:#0550ae">.</span>feature_names<span style="color:#1f2328">)</span> <span style="color:#cf222e">if</span> booster<span style="color:#0550ae">.</span>feature_names <span style="color:#cf222e">else</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> num_features <span style="color:#0550ae">==</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Skipping importance plots: No feature names set on booster.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                max_plot_features <span style="color:#0550ae">=</span> <span style="color:#0550ae">20</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># Weight</span>
</span></span><span style="display:flex;"><span>                fig_imp_w<span style="color:#1f2328">,</span> ax_imp_w <span style="color:#0550ae">=</span> plt<span style="color:#0550ae">.</span>subplots<span style="color:#1f2328">(</span>figsize<span style="color:#0550ae">=</span>get_dynamic_figsize<span style="color:#1f2328">(</span>num_features<span style="color:#1f2328">,</span> max_plot_features<span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>                plot_importance<span style="color:#1f2328">(</span>booster<span style="color:#1f2328">,</span> ax<span style="color:#0550ae">=</span>ax_imp_w<span style="color:#1f2328">,</span> max_num_features<span style="color:#0550ae">=</span>max_plot_features<span style="color:#1f2328">,</span> importance_type<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;weight&#39;</span><span style="color:#1f2328">,</span> show_values<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">,</span> title<span style="color:#0550ae">=</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#39;Importance (Weight) - </span><span style="color:#0a3069">{</span>final_run_name<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                plt<span style="color:#0550ae">.</span>tight_layout<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>                mlflow<span style="color:#0550ae">.</span>log_figure<span style="color:#1f2328">(</span>fig_imp_w<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;plots/feature_importance_weight.png&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                plt<span style="color:#0550ae">.</span>close<span style="color:#1f2328">(</span>fig_imp_w<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Logged feature_importance_weight.png&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># Gain</span>
</span></span><span style="display:flex;"><span>                fig_imp_g<span style="color:#1f2328">,</span> ax_imp_g <span style="color:#0550ae">=</span> plt<span style="color:#0550ae">.</span>subplots<span style="color:#1f2328">(</span>figsize<span style="color:#0550ae">=</span>get_dynamic_figsize<span style="color:#1f2328">(</span>num_features<span style="color:#1f2328">,</span> max_plot_features<span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>                plot_importance<span style="color:#1f2328">(</span>booster<span style="color:#1f2328">,</span> ax<span style="color:#0550ae">=</span>ax_imp_g<span style="color:#1f2328">,</span> max_num_features<span style="color:#0550ae">=</span>max_plot_features<span style="color:#1f2328">,</span> importance_type<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;gain&#39;</span><span style="color:#1f2328">,</span> show_values<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">,</span> title<span style="color:#0550ae">=</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#39;Importance (Gain) - </span><span style="color:#0a3069">{</span>final_run_name<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                plt<span style="color:#0550ae">.</span>tight_layout<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>                mlflow<span style="color:#0550ae">.</span>log_figure<span style="color:#1f2328">(</span>fig_imp_g<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;plots/feature_importance_gain.png&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                plt<span style="color:#0550ae">.</span>close<span style="color:#1f2328">(</span>fig_imp_g<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Logged feature_importance_gain.png&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># Cover</span>
</span></span><span style="display:flex;"><span>                fig_imp_c<span style="color:#1f2328">,</span> ax_imp_c <span style="color:#0550ae">=</span> plt<span style="color:#0550ae">.</span>subplots<span style="color:#1f2328">(</span>figsize<span style="color:#0550ae">=</span>get_dynamic_figsize<span style="color:#1f2328">(</span>num_features<span style="color:#1f2328">,</span> max_plot_features<span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>                plot_importance<span style="color:#1f2328">(</span>booster<span style="color:#1f2328">,</span> ax<span style="color:#0550ae">=</span>ax_imp_c<span style="color:#1f2328">,</span> max_num_features<span style="color:#0550ae">=</span>max_plot_features<span style="color:#1f2328">,</span> importance_type<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;cover&#39;</span><span style="color:#1f2328">,</span> show_values<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">,</span> title<span style="color:#0550ae">=</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#39;Importance (Cover) - </span><span style="color:#0a3069">{</span>final_run_name<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                plt<span style="color:#0550ae">.</span>tight_layout<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>                mlflow<span style="color:#0550ae">.</span>log_figure<span style="color:#1f2328">(</span>fig_imp_c<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;plots/feature_importance_cover.png&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                plt<span style="color:#0550ae">.</span>close<span style="color:#1f2328">(</span>fig_imp_c<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Logged feature_importance_cover.png&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#6639ba">isinstance</span><span style="color:#1f2328">(</span>e<span style="color:#1f2328">,</span> xgb<span style="color:#0550ae">.</span>core<span style="color:#0550ae">.</span>XGBoostError<span style="color:#1f2328">)</span> <span style="color:#0550ae">and</span> <span style="color:#0a3069">&#39;feature_names&#39;</span> <span style="color:#0550ae">in</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>e<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Error plotting importance (likely missing feature names internally): </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Warning: Could not plot importance plots: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">{</span>traceback<span style="color:#0550ae">.</span>format_exc<span style="color:#1f2328">()</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;--- Step 5 Complete ---&#34;</span><span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>
  </div>
</details>
<h3 id="step-6---deploy-to-kserve">Step 6 - Deploy to KServe</h3>
<p>Deploys the final model using KServe with configuration compatible with XGBoost serving. Uses the same storage path and service account setup detailed earlier.</p>

<details class="details-shortcode " >
  <summary class="details-shortcode__summary">
    Component 6 - python code
  </summary>
  <div class="details-shortcode__content">
    
    
    





<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#57606a"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Component 6: Deploy to KServe</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#0550ae">@dsl.component</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    base_image<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;python:3.10&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    packages_to_install<span style="color:#0550ae">=</span><span style="color:#1f2328">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;kfp==2.12.1&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;kubernetes==29.0.0&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#39;PyYAML==6.0.1&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">deploy_to_kserve</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Inputs</span>
</span></span><span style="display:flex;"><span>    model_name<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    model_uri<span style="color:#1f2328">:</span> Input<span style="color:#1f2328">[</span>Model<span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>    serving_namespace<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Outputs</span>
</span></span><span style="display:flex;"><span>    endpoint_url_output<span style="color:#1f2328">:</span> OutputPath<span style="color:#1f2328">(</span><span style="color:#6639ba">str</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Optional Args</span>
</span></span><span style="display:flex;"><span>    model_format<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span> <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#39;xgboost&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    kserve_api_group<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span> <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#39;serving.kserve.io&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    kserve_api_version<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span> <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#39;v1beta1&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    service_account_name<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    min_replicas<span style="color:#1f2328">:</span> <span style="color:#6639ba">int</span> <span style="color:#0550ae">=</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    max_replicas<span style="color:#1f2328">:</span> <span style="color:#6639ba">int</span> <span style="color:#0550ae">=</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    cpu_request<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span> <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;100m&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    cpu_limit<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span> <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;1&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    memory_request<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span> <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;256Mi&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    memory_limit<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span> <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;2Gi&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">from</span> <span style="color:#24292e">kubernetes</span> <span style="color:#cf222e">import</span> client<span style="color:#1f2328">,</span> config
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">from</span> <span style="color:#24292e">kubernetes.client.rest</span> <span style="color:#cf222e">import</span> ApiException
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">time</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">yaml</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">os</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">import</span> <span style="color:#24292e">json</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">from</span> <span style="color:#24292e">urllib.parse</span> <span style="color:#cf222e">import</span> urlparse<span style="color:#1f2328">,</span> urlunparse
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;--- Step 6: Deploy Model to KServe ---&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;InferenceService Name: </span><span style="color:#0a3069">{</span>model_name<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Deployment Namespace: </span><span style="color:#0a3069">{</span>serving_namespace<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Input Model Artifact URI (directory): </span><span style="color:#0a3069">{</span>model_uri<span style="color:#0550ae">.</span>uri<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Input Model metadata: </span><span style="color:#0a3069">{</span>json<span style="color:#0550ae">.</span>dumps<span style="color:#1f2328">(</span>model_uri<span style="color:#0550ae">.</span>metadata<span style="color:#1f2328">,</span> indent<span style="color:#0550ae">=</span><span style="color:#0550ae">2</span><span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    expected_metadata_format <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;bst&#34;</span>
</span></span><span style="display:flex;"><span>    actual_metadata_format <span style="color:#0550ae">=</span> model_uri<span style="color:#0550ae">.</span>metadata<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;format&#39;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> actual_metadata_format<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>         <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Warning: Model metadata does not contain &#39;format&#39; key.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">elif</span> actual_metadata_format <span style="color:#0550ae">!=</span> expected_metadata_format<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Warning: Model metadata format (&#39;</span><span style="color:#0a3069">{</span>actual_metadata_format<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;) does not match expected format (&#39;</span><span style="color:#0a3069">{</span>expected_metadata_format<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;).&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Model format verified from metadata: &#39;</span><span style="color:#0a3069">{</span>actual_metadata_format<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Adjust storageUri scheme AND append filename</span>
</span></span><span style="display:flex;"><span>    storage_uri <span style="color:#0550ae">=</span> model_uri<span style="color:#0550ae">.</span>uri
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Ensure the scheme is s3:// for MinIO/S3 compatibility</span>
</span></span><span style="display:flex;"><span>    parsed_uri <span style="color:#0550ae">=</span> urlparse<span style="color:#1f2328">(</span>storage_uri<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> parsed_uri<span style="color:#0550ae">.</span>scheme <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#39;minio&#39;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        storage_uri <span style="color:#0550ae">=</span> urlunparse<span style="color:#1f2328">(</span>parsed_uri<span style="color:#0550ae">.</span>_replace<span style="color:#1f2328">(</span>scheme<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;s3&#39;</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Converted storage URI scheme to s3://: </span><span style="color:#0a3069">{</span>storage_uri<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">elif</span> parsed_uri<span style="color:#0550ae">.</span>scheme <span style="color:#0550ae">!=</span> <span style="color:#0a3069">&#39;s3&#39;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>         <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Warning: Unexpected storage URI scheme &#39;</span><span style="color:#0a3069">{</span>parsed_uri<span style="color:#0550ae">.</span>scheme<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;. KServe might require &#39;s3://&#39;.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Using final storageUri (directory): </span><span style="color:#0a3069">{</span>storage_uri<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Construct InferenceService Object</span>
</span></span><span style="display:flex;"><span>    isvc_manifest <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;apiVersion&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">{</span>kserve_api_group<span style="color:#0a3069">}</span><span style="color:#0a3069">/</span><span style="color:#0a3069">{</span>kserve_api_version<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;kind&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;InferenceService&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;metadata&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;name&#34;</span><span style="color:#1f2328">:</span> model_name<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;namespace&#34;</span><span style="color:#1f2328">:</span> serving_namespace<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;annotations&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;autoscaling.knative.dev/minScale&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>min_replicas<span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;autoscaling.knative.dev/maxScale&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>max_replicas<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;spec&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;predictor&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;model&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;modelFormat&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#0a3069">&#34;name&#34;</span><span style="color:#1f2328">:</span> model_format
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;runtime&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;kserve-xgbserver&#34;</span><span style="color:#1f2328">,</span> <span style="color:#57606a"># Use the standard XGBoost runtime</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;protocolVersion&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;v2&#34;</span><span style="color:#1f2328">,</span>                    
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;storageUri&#34;</span><span style="color:#1f2328">:</span> storage_uri<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;resources&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#0a3069">&#34;requests&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#0a3069">&#34;cpu&#34;</span><span style="color:#1f2328">:</span> cpu_request<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#0a3069">&#34;memory&#34;</span><span style="color:#1f2328">:</span> memory_request
</span></span><span style="display:flex;"><span>                        <span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#0a3069">&#34;limits&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#0a3069">&#34;cpu&#34;</span><span style="color:#1f2328">:</span> cpu_limit<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#0a3069">&#34;memory&#34;</span><span style="color:#1f2328">:</span> memory_limit
</span></span><span style="display:flex;"><span>                        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Add service account if specified</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> service_account_name<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        isvc_manifest<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;spec&#34;</span><span style="color:#1f2328">][</span><span style="color:#0a3069">&#34;predictor&#34;</span><span style="color:#1f2328">][</span><span style="color:#0a3069">&#34;serviceAccountName&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> service_account_name        
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">Constructed InferenceService Manifest:&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span>yaml<span style="color:#0550ae">.</span>dump<span style="color:#1f2328">(</span>isvc_manifest<span style="color:#1f2328">,</span> indent<span style="color:#0550ae">=</span><span style="color:#0550ae">2</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Authenticate Kubernetes Client</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        config<span style="color:#0550ae">.</span>load_incluster_config<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Loaded in-cluster Kubernetes config.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">except</span> config<span style="color:#0550ae">.</span>ConfigException<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            config<span style="color:#0550ae">.</span>load_kube_config<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Loaded local Kubernetes config.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span> config<span style="color:#0550ae">.</span>ConfigException <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>             <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Error: Could not load any Kubernetes config: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>             <span style="color:#cf222e">raise</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>    api_client <span style="color:#0550ae">=</span> client<span style="color:#0550ae">.</span>ApiClient<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    custom_api <span style="color:#0550ae">=</span> client<span style="color:#0550ae">.</span>CustomObjectsApi<span style="color:#1f2328">(</span>api_client<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Create or Update InferenceService</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Checking if InferenceService &#39;</span><span style="color:#0a3069">{</span>model_name<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39; exists in namespace &#39;</span><span style="color:#0a3069">{</span>serving_namespace<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        existing_isvc <span style="color:#0550ae">=</span> custom_api<span style="color:#0550ae">.</span>get_namespaced_custom_object<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>            group<span style="color:#0550ae">=</span>kserve_api_group<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            version<span style="color:#0550ae">=</span>kserve_api_version<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            namespace<span style="color:#0550ae">=</span>serving_namespace<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            plural<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;inferenceservices&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            name<span style="color:#0550ae">=</span>model_name
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;InferenceService exists. Patching...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Update only the relevant parts if needed, or replace the whole spec</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># For simplicity, patching the whole body ensures config drift is fixed</span>
</span></span><span style="display:flex;"><span>        resp <span style="color:#0550ae">=</span> custom_api<span style="color:#0550ae">.</span>patch_namespaced_custom_object<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>            group<span style="color:#0550ae">=</span>kserve_api_group<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            version<span style="color:#0550ae">=</span>kserve_api_version<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            namespace<span style="color:#0550ae">=</span>serving_namespace<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            plural<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;inferenceservices&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            name<span style="color:#0550ae">=</span>model_name<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            body<span style="color:#0550ae">=</span>isvc_manifest <span style="color:#57606a"># Apply the desired state</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Patch successful.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">except</span> ApiException <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> e<span style="color:#0550ae">.</span>status <span style="color:#0550ae">==</span> <span style="color:#0550ae">404</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Creating new InferenceService...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            resp <span style="color:#0550ae">=</span> custom_api<span style="color:#0550ae">.</span>create_namespaced_custom_object<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                group<span style="color:#0550ae">=</span>kserve_api_group<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                version<span style="color:#0550ae">=</span>kserve_api_version<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                namespace<span style="color:#0550ae">=</span>serving_namespace<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                plural<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;inferenceservices&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                body<span style="color:#0550ae">=</span>isvc_manifest
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Create successful.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># Log the error details properly</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Error interacting with Kubernetes API: Status=</span><span style="color:#0a3069">{</span>e<span style="color:#0550ae">.</span>status<span style="color:#0a3069">}</span><span style="color:#0a3069">, Reason=</span><span style="color:#0a3069">{</span>e<span style="color:#0550ae">.</span>reason<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Body: </span><span style="color:#0a3069">{</span>e<span style="color:#0550ae">.</span>body<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">raise</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Wait for InferenceService to be Ready</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Waiting for InferenceService to become Ready...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    timeout_seconds <span style="color:#0550ae">=</span> <span style="color:#0550ae">300</span>
</span></span><span style="display:flex;"><span>    start_time <span style="color:#0550ae">=</span> time<span style="color:#0550ae">.</span>time<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    isvc_url <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>    last_message <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">while</span> time<span style="color:#0550ae">.</span>time<span style="color:#1f2328">()</span> <span style="color:#0550ae">-</span> start_time <span style="color:#0550ae">&lt;</span> timeout_seconds<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            isvc <span style="color:#0550ae">=</span> custom_api<span style="color:#0550ae">.</span>get_namespaced_custom_object<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                group<span style="color:#0550ae">=</span>kserve_api_group<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                version<span style="color:#0550ae">=</span>kserve_api_version<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                namespace<span style="color:#0550ae">=</span>serving_namespace<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                plural<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;inferenceservices&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                name<span style="color:#0550ae">=</span>model_name
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            status <span style="color:#0550ae">=</span> isvc<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;status&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">{})</span>
</span></span><span style="display:flex;"><span>            url <span style="color:#0550ae">=</span> status<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;url&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            conditions <span style="color:#0550ae">=</span> status<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;conditions&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">[])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            ready_condition <span style="color:#0550ae">=</span> <span style="color:#6639ba">next</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">(</span>c <span style="color:#cf222e">for</span> c <span style="color:#0550ae">in</span> conditions <span style="color:#cf222e">if</span> c<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;Ready&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            current_message <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;No Ready condition found&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> ready_condition<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                current_message <span style="color:#0550ae">=</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Ready=</span><span style="color:#0a3069">{</span>ready_condition<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;status&#39;</span><span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">, Reason=</span><span style="color:#0a3069">{</span>ready_condition<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;reason&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;N/A&#39;</span><span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">, Msg=</span><span style="color:#0a3069">{</span>ready_condition<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;message&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;N/A&#39;</span><span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> ready_condition<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;status&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;True&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">if</span> url<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        isvc_url <span style="color:#0550ae">=</span> url
</span></span><span style="display:flex;"><span>                        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">InferenceService is Ready at: </span><span style="color:#0a3069">{</span>isvc_url<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">break</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        current_message <span style="color:#0550ae">+=</span> <span style="color:#0a3069">&#34; (URL not available yet)&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># Only print status if it changes</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> current_message <span style="color:#0550ae">!=</span> last_message<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Current status: </span><span style="color:#0a3069">{</span>current_message<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                last_message <span style="color:#0550ae">=</span> current_message
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span> ApiException <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            error_message <span style="color:#0550ae">=</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Status check error: </span><span style="color:#0a3069">{</span>e<span style="color:#0550ae">.</span>status<span style="color:#0a3069">}</span><span style="color:#0a3069"> - </span><span style="color:#0a3069">{</span>e<span style="color:#0550ae">.</span>reason<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> error_message <span style="color:#0550ae">!=</span> last_message<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span>error_message<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                last_message <span style="color:#0550ae">=</span> error_message
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># Catch other potential errors during status check</span>
</span></span><span style="display:flex;"><span>            error_message <span style="color:#0550ae">=</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Unexpected error during status check: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>e<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> error_message <span style="color:#0550ae">!=</span> last_message<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span>error_message<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                 last_message <span style="color:#0550ae">=</span> error_message
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        time<span style="color:#0550ae">.</span>sleep<span style="color:#1f2328">(</span><span style="color:#0550ae">15</span><span style="color:#1f2328">)</span> <span style="color:#57606a"># Increase sleep interval slightly</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> isvc_url<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Warning: Timeout after </span><span style="color:#0a3069">{</span>timeout_seconds<span style="color:#0a3069">}</span><span style="color:#0a3069"> seconds waiting for InferenceService &#39;</span><span style="color:#0a3069">{</span>model_name<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39; to become ready.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Try to get last known status for debugging</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>             isvc <span style="color:#0550ae">=</span> custom_api<span style="color:#0550ae">.</span>get_namespaced_custom_object<span style="color:#1f2328">(</span>group<span style="color:#0550ae">=</span>kserve_api_group<span style="color:#1f2328">,</span> version<span style="color:#0550ae">=</span>kserve_api_version<span style="color:#1f2328">,</span> namespace<span style="color:#0550ae">=</span>serving_namespace<span style="color:#1f2328">,</span> plural<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;inferenceservices&#34;</span><span style="color:#1f2328">,</span> name<span style="color:#0550ae">=</span>model_name<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>             <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Final status check: </span><span style="color:#0a3069">{</span>json<span style="color:#0550ae">.</span>dumps<span style="color:#1f2328">(</span>isvc<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;status&#39;</span><span style="color:#1f2328">),</span> indent<span style="color:#0550ae">=</span><span style="color:#0550ae">2</span><span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> final_e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>             <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Could not get final status: </span><span style="color:#0a3069">{</span>final_e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        isvc_url <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;ERROR: Deployment timeout or failure&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Save Endpoint URL Output</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">with</span> <span style="color:#6639ba">open</span><span style="color:#1f2328">(</span>endpoint_url_output<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;w&#39;</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">as</span> f<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        f<span style="color:#0550ae">.</span>write<span style="color:#1f2328">(</span>isvc_url<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;--- Step 6 Complete ---&#34;</span><span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>
  </div>
</details>
<h3 id="step-7---pipeline-definition">Step 7 - Pipeline Definition</h3>
<p>Defines task ordering and parameter passing. <strong>Note:</strong> I noticed set_display_name() sometimes causes unexpected errors and have commented it out.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>load_task<span style="color:#0550ae">.</span>set_display_name<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Load &amp; Prep Data&#34;</span><span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>
<details class="details-shortcode " >
  <summary class="details-shortcode__summary">
    Component 7 - python code
  </summary>
  <div class="details-shortcode__content">
    
    
    





<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#57606a"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Pipeline Definition</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#0550ae">@dsl.pipeline</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    name<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;HDB XGBoost Retraining Pipeline (Multi-Step BST)&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    description<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;Retrains XGBoost model (BST format) and deploys to KServe.&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">hdb_xgboost_multistep_pipeline</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Pipeline Parameters</span>
</span></span><span style="display:flex;"><span>    fixed_processed_data_s3_uri<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span> <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#39;s3://mlpipeline/hdb-resale-data/resale-data-etl-final.parquet&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    target_column<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span> <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#39;resale_price&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    mlflow_tracking_uri<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span> <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#39;http://mlflow-tracking.mlflow&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    mlflow_experiment_name<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span> <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#39;XGBoostMultistepBST&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Features/HPs</span>
</span></span><span style="display:flex;"><span>    best_features_json<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span> <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#39;[]&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    best_use_scaling<span style="color:#1f2328">:</span> <span style="color:#6639ba">bool</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">True</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    best_n_estimators<span style="color:#1f2328">:</span> <span style="color:#6639ba">int</span> <span style="color:#0550ae">=</span> <span style="color:#0550ae">500</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    best_learning_rate<span style="color:#1f2328">:</span> <span style="color:#6639ba">float</span> <span style="color:#0550ae">=</span> <span style="color:#0550ae">0.04</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    best_max_depth<span style="color:#1f2328">:</span> <span style="color:#6639ba">int</span> <span style="color:#0550ae">=</span> <span style="color:#0550ae">7</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    best_early_stopping_rounds<span style="color:#1f2328">:</span> <span style="color:#6639ba">int</span> <span style="color:#0550ae">=</span> <span style="color:#0550ae">15</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    best_colsample_bytree<span style="color:#1f2328">:</span> <span style="color:#6639ba">float</span> <span style="color:#0550ae">=</span> <span style="color:#0550ae">0.7</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    best_min_child_weight<span style="color:#1f2328">:</span> <span style="color:#6639ba">int</span> <span style="color:#0550ae">=</span> <span style="color:#0550ae">3</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    best_subsample<span style="color:#1f2328">:</span> <span style="color:#6639ba">float</span> <span style="color:#0550ae">=</span> <span style="color:#0550ae">0.8</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    best_random_state<span style="color:#1f2328">:</span> <span style="color:#6639ba">int</span> <span style="color:#0550ae">=</span> <span style="color:#0550ae">42</span><span style="color:#1f2328">,</span>  
</span></span><span style="display:flex;"><span>    base_run_name<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span> <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;XGBoostMultiStepBST&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># KServe Deployment Params</span>
</span></span><span style="display:flex;"><span>    kserve_model_name<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span> <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#39;hdb-resale-xgb&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    kserve_namespace<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span> <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#39;kubeflow-user-example-com&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    kserve_model_format<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span> <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#39;xgboost&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    kserve_predictor_service_account<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span> <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#39;sa&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">):</span>   
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Define Helper Function for Adding Env Vars</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">add_env_vars</span><span style="color:#1f2328">(</span>task<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        task<span style="color:#0550ae">.</span>set_env_variable<span style="color:#1f2328">(</span>name<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;MLFLOW_TRACKING_USERNAME&#34;</span><span style="color:#1f2328">,</span> value<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;user&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        task<span style="color:#0550ae">.</span>set_env_variable<span style="color:#1f2328">(</span>name<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;MLFLOW_TRACKING_PASSWORD&#34;</span><span style="color:#1f2328">,</span> value<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;qYlTnUDQMe&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Pipeline Steps</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Step 1: Load Data</span>
</span></span><span style="display:flex;"><span>    load_task <span style="color:#0550ae">=</span> load_and_prep_data<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        s3_data_uri<span style="color:#0550ae">=</span>fixed_processed_data_s3_uri<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        target_column<span style="color:#0550ae">=</span>target_column<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        features_json<span style="color:#0550ae">=</span>best_features_json
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    load_task<span style="color:#0550ae">.</span>set_caching_options<span style="color:#1f2328">(</span>enable_caching<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Step 2: Split &amp; Scale</span>
</span></span><span style="display:flex;"><span>    scale_task <span style="color:#0550ae">=</span> split_and_scale_data<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        x_data_path<span style="color:#0550ae">=</span>load_task<span style="color:#0550ae">.</span>outputs<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;x_data_path&#39;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>        y_data_path<span style="color:#0550ae">=</span>load_task<span style="color:#0550ae">.</span>outputs<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;y_data_path&#39;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>        feature_names_json<span style="color:#0550ae">=</span>load_task<span style="color:#0550ae">.</span>outputs<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;feature_names_json_out&#39;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>        use_scaling<span style="color:#0550ae">=</span>best_use_scaling
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    scale_task<span style="color:#0550ae">.</span>set_caching_options<span style="color:#1f2328">(</span>enable_caching<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Step 3: Train Model</span>
</span></span><span style="display:flex;"><span>    train_task <span style="color:#0550ae">=</span> train_model<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        x_train_path<span style="color:#0550ae">=</span>scale_task<span style="color:#0550ae">.</span>outputs<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;x_train_path&#39;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>        x_test_path<span style="color:#0550ae">=</span>scale_task<span style="color:#0550ae">.</span>outputs<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;x_test_path&#39;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>        y_train_path<span style="color:#0550ae">=</span>scale_task<span style="color:#0550ae">.</span>outputs<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;y_train_path&#39;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>        y_test_path<span style="color:#0550ae">=</span>scale_task<span style="color:#0550ae">.</span>outputs<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;y_test_path&#39;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>        scaler_path<span style="color:#0550ae">=</span>scale_task<span style="color:#0550ae">.</span>outputs<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;scaler_path&#39;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>        use_scaling<span style="color:#0550ae">=</span>best_use_scaling<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        feature_names_json<span style="color:#0550ae">=</span>load_task<span style="color:#0550ae">.</span>outputs<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;feature_names_json_out&#39;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># HPs</span>
</span></span><span style="display:flex;"><span>        n_estimators<span style="color:#0550ae">=</span>best_n_estimators<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        learning_rate<span style="color:#0550ae">=</span>best_learning_rate<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        max_depth<span style="color:#0550ae">=</span>best_max_depth<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        early_stopping_rounds<span style="color:#0550ae">=</span>best_early_stopping_rounds<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        colsample_bytree<span style="color:#0550ae">=</span>best_colsample_bytree<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        min_child_weight<span style="color:#0550ae">=</span>best_min_child_weight<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        subsample<span style="color:#0550ae">=</span>best_subsample<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        random_state<span style="color:#0550ae">=</span>best_random_state<span style="color:#1f2328">,</span>    
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># MLflow</span>
</span></span><span style="display:flex;"><span>        run_name<span style="color:#0550ae">=</span>base_run_name<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        mlflow_tracking_uri<span style="color:#0550ae">=</span>mlflow_tracking_uri<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        mlflow_experiment_name<span style="color:#0550ae">=</span>mlflow_experiment_name
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    train_task<span style="color:#0550ae">.</span>set_caching_options<span style="color:#1f2328">(</span>enable_caching<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    add_env_vars<span style="color:#1f2328">(</span>train_task<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Step 4: Predict &amp; Evaluate</span>
</span></span><span style="display:flex;"><span>    eval_task <span style="color:#0550ae">=</span> predict_and_evaluate<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        input_model<span style="color:#0550ae">=</span>train_task<span style="color:#0550ae">.</span>outputs<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;output_model&#39;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>        x_test_path<span style="color:#0550ae">=</span>scale_task<span style="color:#0550ae">.</span>outputs<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;x_test_path&#39;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>        y_test_path<span style="color:#0550ae">=</span>scale_task<span style="color:#0550ae">.</span>outputs<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;y_test_path&#39;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>        mlflow_run_id<span style="color:#0550ae">=</span>train_task<span style="color:#0550ae">.</span>outputs<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;mlflow_run_id_out&#39;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>        mlflow_tracking_uri<span style="color:#0550ae">=</span>mlflow_tracking_uri<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        feature_names_json<span style="color:#0550ae">=</span>load_task<span style="color:#0550ae">.</span>outputs<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;feature_names_json_out&#39;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    eval_task<span style="color:#0550ae">.</span>set_caching_options<span style="color:#1f2328">(</span>enable_caching<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    add_env_vars<span style="color:#1f2328">(</span>eval_task<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Step 5: Generate &amp; Log Plots</span>
</span></span><span style="display:flex;"><span>    plot_task <span style="color:#0550ae">=</span> generate_and_log_plots<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        input_model<span style="color:#0550ae">=</span>train_task<span style="color:#0550ae">.</span>outputs<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;output_model&#39;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>        y_test_path<span style="color:#0550ae">=</span>scale_task<span style="color:#0550ae">.</span>outputs<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;y_test_path&#39;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>        y_pred_path<span style="color:#0550ae">=</span>eval_task<span style="color:#0550ae">.</span>outputs<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;y_pred_path&#39;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>        feature_names_json<span style="color:#0550ae">=</span>load_task<span style="color:#0550ae">.</span>outputs<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;feature_names_json_out&#39;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>        mlflow_run_id<span style="color:#0550ae">=</span>train_task<span style="color:#0550ae">.</span>outputs<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;mlflow_run_id_out&#39;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>        mlflow_tracking_uri<span style="color:#0550ae">=</span>mlflow_tracking_uri<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        run_name<span style="color:#0550ae">=</span>base_run_name
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    plot_task<span style="color:#0550ae">.</span>set_caching_options<span style="color:#1f2328">(</span>enable_caching<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    add_env_vars<span style="color:#1f2328">(</span>plot_task<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Step 6: Deploy Model</span>
</span></span><span style="display:flex;"><span>    deploy_task <span style="color:#0550ae">=</span> deploy_to_kserve<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        model_name<span style="color:#0550ae">=</span>kserve_model_name<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        model_uri<span style="color:#0550ae">=</span>train_task<span style="color:#0550ae">.</span>outputs<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;output_model&#39;</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>        serving_namespace<span style="color:#0550ae">=</span>kserve_namespace<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        model_format<span style="color:#0550ae">=</span>kserve_model_format<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        service_account_name<span style="color:#0550ae">=</span>kserve_predictor_service_account
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>after<span style="color:#1f2328">(</span>train_task<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    deploy_task<span style="color:#0550ae">.</span>set_caching_options<span style="color:#1f2328">(</span>enable_caching<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>
  </div>
</details>
<h3 id="step-8---compilation">Step 8 - Compilation</h3>
<p>Compiles and uploads the pipeline as a <code>.yaml</code> file to Kubeflow Pipelines for execution.</p>

<details class="details-shortcode " >
  <summary class="details-shortcode__summary">
    Component 8 - python code
  </summary>
  <div class="details-shortcode__content">
    
    
    





<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#57606a"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Pipeline Compilation</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># ==============================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">if</span> <span style="color:#953800">__name__</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#39;__main__&#39;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Define best feature set found during exploration</span>
</span></span><span style="display:flex;"><span>    BEST_FEATURE_SET <span style="color:#0550ae">=</span> <span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;floor_area_sqm&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;remaining_lease_years&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;storey_avg&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;sale_year&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;sale_month&#39;</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>                        <span style="color:#0a3069">&#39;flat_type_1 ROOM&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_type_2 ROOM&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_type_3 ROOM&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_type_4 ROOM&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_type_5 ROOM&#39;</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>                        <span style="color:#0a3069">&#39;flat_type_EXECUTIVE&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_type_MULTI-GENERATION&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_2-room&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_3Gen&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_Adjoined flat&#39;</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>                        <span style="color:#0a3069">&#39;flat_model_Apartment&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_DBSS&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_Improved&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_Improved-Maisonette&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_Maisonette&#39;</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>                        <span style="color:#0a3069">&#39;flat_model_Model A&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_Model A-Maisonette&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_Model A2&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_Multi Generation&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_New Generation&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#0a3069">&#39;flat_model_Premium Apartment&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_Premium Apartment Loft&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_Premium Maisonette&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_Simplified&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_Standard&#39;</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>                        <span style="color:#0a3069">&#39;flat_model_Terrace&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_Type S1&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_Type S2&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_ANG MO KIO&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_BEDOK&#39;</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>                        <span style="color:#0a3069">&#39;town_BISHAN&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_BUKIT BATOK&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_BUKIT MERAH&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_BUKIT PANJANG&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_BUKIT TIMAH&#39;</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>                        <span style="color:#0a3069">&#39;town_CENTRAL AREA&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_CHOA CHU KANG&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_CLEMENTI&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_GEYLANG&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_HOUGANG&#39;</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>                        <span style="color:#0a3069">&#39;town_JURONG EAST&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_JURONG WEST&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_KALLANG/WHAMPOA&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_MARINE PARADE&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_PASIR RIS&#39;</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>                        <span style="color:#0a3069">&#39;town_PUNGGOL&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_QUEENSTOWN&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_SEMBAWANG&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_SENGKANG&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_SERANGOON&#39;</span><span style="color:#1f2328">,</span> 
</span></span><span style="display:flex;"><span>                        <span style="color:#0a3069">&#39;town_TAMPINES&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_TOA PAYOH&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_WOODLANDS&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_YISHUN&#39;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    BEST_FEATURE_SET_JSON <span style="color:#0550ae">=</span> json<span style="color:#0550ae">.</span>dumps<span style="color:#1f2328">(</span>BEST_FEATURE_SET<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Define other best parameters if needed for compile-time defaults</span>
</span></span><span style="display:flex;"><span>    BEST_USE_SCALING <span style="color:#0550ae">=</span> <span style="color:#cf222e">True</span>
</span></span><span style="display:flex;"><span>    BEST_N_ESTIMATORS <span style="color:#0550ae">=</span> <span style="color:#0550ae">500</span>
</span></span><span style="display:flex;"><span>    BEST_LEARNING_RATE <span style="color:#0550ae">=</span> <span style="color:#0550ae">0.04</span>
</span></span><span style="display:flex;"><span>    BEST_MAX_DEPTH <span style="color:#0550ae">=</span> <span style="color:#0550ae">7</span>
</span></span><span style="display:flex;"><span>    BEST_EARLY_STOPPING_ROUNDS <span style="color:#0550ae">=</span> <span style="color:#0550ae">15</span>
</span></span><span style="display:flex;"><span>    BEST_COLSAMPLE_BYTREE <span style="color:#0550ae">=</span> <span style="color:#0550ae">0.7</span>
</span></span><span style="display:flex;"><span>    BEST_MIN_CHILD_WEIGHT <span style="color:#0550ae">=</span> <span style="color:#0550ae">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Set pipeline parameters for compilation</span>
</span></span><span style="display:flex;"><span>    pipeline_parameters <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>         <span style="color:#0a3069">&#39;best_features_json&#39;</span><span style="color:#1f2328">:</span> BEST_FEATURE_SET_JSON<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>         <span style="color:#0a3069">&#39;best_use_scaling&#39;</span><span style="color:#1f2328">:</span> BEST_USE_SCALING<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>         <span style="color:#0a3069">&#39;best_n_estimators&#39;</span><span style="color:#1f2328">:</span> BEST_N_ESTIMATORS<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>         <span style="color:#0a3069">&#39;best_learning_rate&#39;</span><span style="color:#1f2328">:</span> BEST_LEARNING_RATE<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>         <span style="color:#0a3069">&#39;best_max_depth&#39;</span><span style="color:#1f2328">:</span> BEST_MAX_DEPTH<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>         <span style="color:#0a3069">&#39;best_early_stopping_rounds&#39;</span><span style="color:#1f2328">:</span> BEST_EARLY_STOPPING_ROUNDS<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>         <span style="color:#0a3069">&#39;best_colsample_bytree&#39;</span><span style="color:#1f2328">:</span> BEST_COLSAMPLE_BYTREE<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>         <span style="color:#0a3069">&#39;best_min_child_weight&#39;</span><span style="color:#1f2328">:</span> BEST_MIN_CHILD_WEIGHT<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Compiler<span style="color:#1f2328">()</span><span style="color:#0550ae">.</span>compile<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        pipeline_func<span style="color:#0550ae">=</span>hdb_xgboost_multistep_pipeline<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        package_path<span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;hdb_xgboost_multistep_pipeline.yaml&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        pipeline_parameters<span style="color:#0550ae">=</span>pipeline_parameters
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Pipeline compiled to hdb_xgboost_multistep_pipeline.yaml&#34;</span><span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>
  </div>
</details>


































 
  
  





  <img src="/images/hdb-app/hdb-xgboost-multistep-pipeline.png"   alt="hdb-xgboost-multistep-pipeline" class="sc-image sc-image-default"
       >


<h2 id="hdb-predictor-app">HDB Predictor App</h2>
<p>Finally, a simple and intuitive Streamlit app lets users interact with the model by entering flat details (e.g., floor area, location, lease year). The app sends the inputs to the KServe endpoint and displays the predicted resale price.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>streamlit run app.py</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>
<details class="details-shortcode " >
  <summary class="details-shortcode__summary">
    app.py - python code
  </summary>
  <div class="details-shortcode__content">
    
    
    





<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#57606a"># app.py</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">streamlit</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">st</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">requests</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">numpy</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">np</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">pandas</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">pd</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">joblib</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">os</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">json</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">datetime</span> <span style="color:#cf222e">import</span> datetime
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># --- SET PAGE CONFIG FIRST ---</span>
</span></span><span style="display:flex;"><span>st<span style="color:#0550ae">.</span>set_page_config<span style="color:#1f2328">(</span>layout<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;centered&#34;</span><span style="color:#1f2328">,</span> page_title<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;HDB Price Predictor&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># --- Configuration ---</span>
</span></span><span style="display:flex;"><span>KSERVE_URL <span style="color:#0550ae">=</span> os<span style="color:#0550ae">.</span>environ<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;KSERVE_URL&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;http://hdb-resale-xgb.kubeflow-user-example-com.svc.cluster.local/v2/models/hdb-resale-xgb/infer&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>SCALER_PATH <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;scaler.joblib&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Feature names in the EXACT order the model expects</span>
</span></span><span style="display:flex;"><span>FEATURE_NAMES <span style="color:#0550ae">=</span> <span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;floor_area_sqm&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;remaining_lease_years&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;storey_avg&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;sale_year&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;sale_month&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#0a3069">&#39;flat_type_1 ROOM&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_type_2 ROOM&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_type_3 ROOM&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_type_4 ROOM&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_type_5 ROOM&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#0a3069">&#39;flat_type_EXECUTIVE&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_type_MULTI-GENERATION&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_2-room&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_3Gen&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_Adjoined flat&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#0a3069">&#39;flat_model_Apartment&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_DBSS&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_Improved&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_Improved-Maisonette&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_Maisonette&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#0a3069">&#39;flat_model_Model A&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_Model A-Maisonette&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_Model A2&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_Multi Generation&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_New Generation&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#0a3069">&#39;flat_model_Premium Apartment&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_Premium Apartment Loft&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_Premium Maisonette&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_Simplified&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_Standard&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#0a3069">&#39;flat_model_Terrace&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_Type S1&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;flat_model_Type S2&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_ANG MO KIO&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_BEDOK&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#0a3069">&#39;town_BISHAN&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_BUKIT BATOK&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_BUKIT MERAH&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_BUKIT PANJANG&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_BUKIT TIMAH&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#0a3069">&#39;town_CENTRAL AREA&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_CHOA CHU KANG&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_CLEMENTI&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_GEYLANG&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_HOUGANG&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#0a3069">&#39;town_JURONG EAST&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_JURONG WEST&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_KALLANG/WHAMPOA&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_MARINE PARADE&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_PASIR RIS&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#0a3069">&#39;town_PUNGGOL&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_QUEENSTOWN&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_SEMBAWANG&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_SENGKANG&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_SERANGOON&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#0a3069">&#39;town_TAMPINES&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_TOA PAYOH&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_WOODLANDS&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;town_YISHUN&#39;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NUM_FEATURES <span style="color:#0550ae">=</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>FEATURE_NAMES<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># --- Extract Categories for Dropdowns ---</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">extract_categories</span><span style="color:#1f2328">(</span>prefix<span style="color:#1f2328">,</span> feature_list<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    categories <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>    prefix_len <span style="color:#0550ae">=</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>prefix<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> feature <span style="color:#0550ae">in</span> feature_list<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> feature<span style="color:#0550ae">.</span>startswith<span style="color:#1f2328">(</span>prefix<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            categories<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>feature<span style="color:#1f2328">[</span>prefix_len<span style="color:#1f2328">:])</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#6639ba">sorted</span><span style="color:#1f2328">(</span>categories<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FLAT_TYPES <span style="color:#0550ae">=</span> extract_categories<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;flat_type_&#34;</span><span style="color:#1f2328">,</span> FEATURE_NAMES<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>FLAT_MODELS <span style="color:#0550ae">=</span> extract_categories<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;flat_model_&#34;</span><span style="color:#1f2328">,</span> FEATURE_NAMES<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>TOWNS <span style="color:#0550ae">=</span> extract_categories<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;town_&#34;</span><span style="color:#1f2328">,</span> FEATURE_NAMES<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># --- Load Scaler ---</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    scaler <span style="color:#0550ae">=</span> joblib<span style="color:#0550ae">.</span>load<span style="color:#1f2328">(</span>SCALER_PATH<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Scaler loaded successfully.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">except</span> FileNotFoundError<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    st<span style="color:#0550ae">.</span>error<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Error: Scaler file not found at </span><span style="color:#0a3069">{</span>SCALER_PATH<span style="color:#0a3069">}</span><span style="color:#0a3069">. Cannot proceed.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    st<span style="color:#0550ae">.</span>stop<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    st<span style="color:#0550ae">.</span>error<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Error loading scaler: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    st<span style="color:#0550ae">.</span>stop<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># --- Streamlit UI ---</span>
</span></span><span style="display:flex;"><span>st<span style="color:#0550ae">.</span>title<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;HDB Resale Price Predictor&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>st<span style="color:#0550ae">.</span>markdown<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Enter the details below to get a price prediction.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># --- Input Fields ---</span>
</span></span><span style="display:flex;"><span>col1<span style="color:#1f2328">,</span> col2 <span style="color:#0550ae">=</span> st<span style="color:#0550ae">.</span>columns<span style="color:#1f2328">(</span><span style="color:#0550ae">2</span><span style="color:#1f2328">)</span> <span style="color:#57606a"># Arrange inputs in columns</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">with</span> col1<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    st<span style="color:#0550ae">.</span>header<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Key Features&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    floor_area <span style="color:#0550ae">=</span> st<span style="color:#0550ae">.</span>number_input<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Floor Area (sqm)&#34;</span><span style="color:#1f2328">,</span> min_value<span style="color:#0550ae">=</span><span style="color:#0550ae">20.0</span><span style="color:#1f2328">,</span> max_value<span style="color:#0550ae">=</span><span style="color:#0550ae">300.0</span><span style="color:#1f2328">,</span> value<span style="color:#0550ae">=</span><span style="color:#0550ae">90.0</span><span style="color:#1f2328">,</span> step<span style="color:#0550ae">=</span><span style="color:#0550ae">1.0</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    lease_years <span style="color:#0550ae">=</span> st<span style="color:#0550ae">.</span>number_input<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Remaining Lease (Years)&#34;</span><span style="color:#1f2328">,</span> min_value<span style="color:#0550ae">=</span><span style="color:#0550ae">10.0</span><span style="color:#1f2328">,</span> max_value<span style="color:#0550ae">=</span><span style="color:#0550ae">99.0</span><span style="color:#1f2328">,</span> value<span style="color:#0550ae">=</span><span style="color:#0550ae">70.0</span><span style="color:#1f2328">,</span> step<span style="color:#0550ae">=</span><span style="color:#0550ae">0.5</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    storey <span style="color:#0550ae">=</span> st<span style="color:#0550ae">.</span>number_input<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Storey (Average)&#34;</span><span style="color:#1f2328">,</span> min_value<span style="color:#0550ae">=</span><span style="color:#0550ae">1.0</span><span style="color:#1f2328">,</span> max_value<span style="color:#0550ae">=</span><span style="color:#0550ae">50.0</span><span style="color:#1f2328">,</span> value<span style="color:#0550ae">=</span><span style="color:#0550ae">10.0</span><span style="color:#1f2328">,</span> step<span style="color:#0550ae">=</span><span style="color:#0550ae">1.0</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">with</span> col2<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    st<span style="color:#0550ae">.</span>header<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Location &amp; Type&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Set default indices based on common values or simple index 0</span>
</span></span><span style="display:flex;"><span>    default_town_index <span style="color:#0550ae">=</span> TOWNS<span style="color:#0550ae">.</span>index<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;TAMPINES&#34;</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">if</span> <span style="color:#0a3069">&#34;TAMPINES&#34;</span> <span style="color:#0550ae">in</span> TOWNS <span style="color:#cf222e">else</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>    default_flat_type_index <span style="color:#0550ae">=</span> FLAT_TYPES<span style="color:#0550ae">.</span>index<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;4 ROOM&#34;</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">if</span> <span style="color:#0a3069">&#34;4 ROOM&#34;</span> <span style="color:#0550ae">in</span> FLAT_TYPES <span style="color:#cf222e">else</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>    default_flat_model_index <span style="color:#0550ae">=</span> FLAT_MODELS<span style="color:#0550ae">.</span>index<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Improved&#34;</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">if</span> <span style="color:#0a3069">&#34;Improved&#34;</span> <span style="color:#0550ae">in</span> FLAT_MODELS <span style="color:#cf222e">else</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    selected_town <span style="color:#0550ae">=</span> st<span style="color:#0550ae">.</span>selectbox<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Town&#34;</span><span style="color:#1f2328">,</span> TOWNS<span style="color:#1f2328">,</span> index<span style="color:#0550ae">=</span>default_town_index<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    selected_flat_type <span style="color:#0550ae">=</span> st<span style="color:#0550ae">.</span>selectbox<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Flat Type&#34;</span><span style="color:#1f2328">,</span> FLAT_TYPES<span style="color:#1f2328">,</span> index<span style="color:#0550ae">=</span>default_flat_type_index<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    selected_flat_model <span style="color:#0550ae">=</span> st<span style="color:#0550ae">.</span>selectbox<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Flat Model&#34;</span><span style="color:#1f2328">,</span> FLAT_MODELS<span style="color:#1f2328">,</span> index<span style="color:#0550ae">=</span>default_flat_model_index<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># --- Prediction Button ---</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">if</span> st<span style="color:#0550ae">.</span>button<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Predict Resale Price&#34;</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">type</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;primary&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    st<span style="color:#0550ae">.</span>markdown<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;---&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    st<span style="color:#0550ae">.</span>subheader<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Processing...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># --- Prepare Input Data ---</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Start with all features as 0.0</span>
</span></span><span style="display:flex;"><span>    input_dict <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>feat<span style="color:#1f2328">:</span> <span style="color:#0550ae">0.0</span> <span style="color:#cf222e">for</span> feat <span style="color:#0550ae">in</span> FEATURE_NAMES<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Update with numerical user inputs</span>
</span></span><span style="display:flex;"><span>    input_dict<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;floor_area_sqm&#39;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#6639ba">float</span><span style="color:#1f2328">(</span>floor_area<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    input_dict<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;remaining_lease_years&#39;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#6639ba">float</span><span style="color:#1f2328">(</span>lease_years<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    input_dict<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;storey_avg&#39;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#6639ba">float</span><span style="color:#1f2328">(</span>storey<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Update with default sale year/month</span>
</span></span><span style="display:flex;"><span>    now <span style="color:#0550ae">=</span> datetime<span style="color:#0550ae">.</span>now<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    input_dict<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;sale_year&#39;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#6639ba">float</span><span style="color:#1f2328">(</span>now<span style="color:#0550ae">.</span>year<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    input_dict<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;sale_month&#39;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#6639ba">float</span><span style="color:#1f2328">(</span>now<span style="color:#0550ae">.</span>month<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># *** Update one-hot encoded features based on dropdown selections ***</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Town</span>
</span></span><span style="display:flex;"><span>    town_feature_name <span style="color:#0550ae">=</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;town_</span><span style="color:#0a3069">{</span>selected_town<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> town_feature_name <span style="color:#0550ae">in</span> input_dict<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        input_dict<span style="color:#1f2328">[</span>town_feature_name<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#0550ae">1.0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        st<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Selected town feature &#39;</span><span style="color:#0a3069">{</span>town_feature_name<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39; not found in model features. Check FEATURE_NAMES.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Flat Type</span>
</span></span><span style="display:flex;"><span>    flat_type_feature_name <span style="color:#0550ae">=</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;flat_type_</span><span style="color:#0a3069">{</span>selected_flat_type<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> flat_type_feature_name <span style="color:#0550ae">in</span> input_dict<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        input_dict<span style="color:#1f2328">[</span>flat_type_feature_name<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#0550ae">1.0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        st<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Selected flat type feature &#39;</span><span style="color:#0a3069">{</span>flat_type_feature_name<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39; not found in model features.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Flat Model</span>
</span></span><span style="display:flex;"><span>    flat_model_feature_name <span style="color:#0550ae">=</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;flat_model_</span><span style="color:#0a3069">{</span>selected_flat_model<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> flat_model_feature_name <span style="color:#0550ae">in</span> input_dict<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        input_dict<span style="color:#1f2328">[</span>flat_model_feature_name<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#0550ae">1.0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        st<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Selected flat model feature &#39;</span><span style="color:#0a3069">{</span>flat_model_feature_name<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39; not found in model features.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Convert dictionary to ordered list</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        input_list <span style="color:#0550ae">=</span> <span style="color:#1f2328">[</span>input_dict<span style="color:#1f2328">[</span>feature<span style="color:#1f2328">]</span> <span style="color:#cf222e">for</span> feature <span style="color:#0550ae">in</span> FEATURE_NAMES<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>        input_array <span style="color:#0550ae">=</span> np<span style="color:#0550ae">.</span>array<span style="color:#1f2328">(</span>input_list<span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>astype<span style="color:#1f2328">(</span>np<span style="color:#0550ae">.</span>float32<span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>reshape<span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span> <span style="color:#57606a"># Reshape for scaler</span>
</span></span><span style="display:flex;"><span>        st<span style="color:#0550ae">.</span>write<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Input shape before scaling: </span><span style="color:#0a3069">{</span>input_array<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Optional: Display which one-hot features are set</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># set_features = {k:v for k,v in input_dict.items() if v==1.0 and (&#39;town_&#39; in k or &#39;flat_type_&#39; in k or &#39;flat_model_&#39; in k)}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># st.write(f&#34;One-hot features set: {set_features}&#34;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># --- Scale the Input Data ---</span>
</span></span><span style="display:flex;"><span>        input_scaled <span style="color:#0550ae">=</span> scaler<span style="color:#0550ae">.</span>transform<span style="color:#1f2328">(</span>input_array<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        st<span style="color:#0550ae">.</span>write<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Input shape after scaling: </span><span style="color:#0a3069">{</span>input_scaled<span style="color:#0550ae">.</span>shape<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        payload_data <span style="color:#0550ae">=</span> input_scaled<span style="color:#0550ae">.</span>flatten<span style="color:#1f2328">()</span><span style="color:#0550ae">.</span>tolist<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># --- Construct KServe Payload ---</span>
</span></span><span style="display:flex;"><span>        payload <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;inputs&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">[{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;name&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;input-0&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;shape&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span> NUM_FEATURES<span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;datatype&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;FP32&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> payload_data
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        st<span style="color:#0550ae">.</span>write<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Sending request to KServe...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># --- Send Request ---</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            response <span style="color:#0550ae">=</span> requests<span style="color:#0550ae">.</span>post<span style="color:#1f2328">(</span>KSERVE_URL<span style="color:#1f2328">,</span> json<span style="color:#0550ae">=</span>payload<span style="color:#1f2328">,</span> timeout<span style="color:#0550ae">=</span><span style="color:#0550ae">30</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            response<span style="color:#0550ae">.</span>raise_for_status<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            result <span style="color:#0550ae">=</span> response<span style="color:#0550ae">.</span>json<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            st<span style="color:#0550ae">.</span>write<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Response received:&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            prediction <span style="color:#0550ae">=</span> result<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;outputs&#39;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">[{}])[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;data&#39;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">[</span><span style="color:#cf222e">None</span><span style="color:#1f2328">])[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> prediction <span style="color:#0550ae">is</span> <span style="color:#0550ae">not</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                st<span style="color:#0550ae">.</span>success<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;**Predicted Resale Price:** S$ </span><span style="color:#0a3069">{</span>prediction<span style="color:#0a3069">:</span><span style="color:#0a3069">,.2f</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                st<span style="color:#0550ae">.</span>error<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Prediction data not found in the response.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                st<span style="color:#0550ae">.</span>json<span style="color:#1f2328">(</span>result<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># ... (Error handling remains the same) ...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span> requests<span style="color:#0550ae">.</span>exceptions<span style="color:#0550ae">.</span>Timeout<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            st<span style="color:#0550ae">.</span>error<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Error: Request timed out connecting to </span><span style="color:#0a3069">{</span>KSERVE_URL<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span> requests<span style="color:#0550ae">.</span>exceptions<span style="color:#0550ae">.</span>ConnectionError<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            st<span style="color:#0550ae">.</span>error<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Error: Could not connect to the prediction service at </span><span style="color:#0a3069">{</span>KSERVE_URL<span style="color:#0a3069">}</span><span style="color:#0a3069">. Is it running and accessible?&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span> requests<span style="color:#0550ae">.</span>exceptions<span style="color:#0550ae">.</span>HTTPError <span style="color:#cf222e">as</span> err<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            st<span style="color:#0550ae">.</span>error<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Error: Prediction service returned status code </span><span style="color:#0a3069">{</span>err<span style="color:#0550ae">.</span>response<span style="color:#0550ae">.</span>status_code<span style="color:#0a3069">}</span><span style="color:#0a3069">.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                error_detail <span style="color:#0550ae">=</span> err<span style="color:#0550ae">.</span>response<span style="color:#0550ae">.</span>json<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>                st<span style="color:#0550ae">.</span>json<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;error_details&#34;</span><span style="color:#1f2328">:</span> error_detail<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">except</span> json<span style="color:#0550ae">.</span>JSONDecodeError<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                 st<span style="color:#0550ae">.</span>text<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Response content:</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">{</span>err<span style="color:#0550ae">.</span>response<span style="color:#0550ae">.</span>text<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            st<span style="color:#0550ae">.</span>error<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;An unexpected error occurred: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        st<span style="color:#0550ae">.</span>error<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Error preparing data for prediction: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div>
  </div>
</details>
<p>Since this app is running from within a Jupyter Notebook environment, we need to port-forward the <code>jupyter-tff</code> service to Streamlit’s default port <code>8501</code>:</p>


































 
  
  





  <img src="/images/hdb-app/hdb-port-forward-jupyter-tff.png"   alt="hdb-port-forward-jupyter-tff" class="sc-image sc-image-default"
       >


<p>Once port-forwarding is active, open your browser and navigate to <em>http://localhost:8501</em> to access the app interface:</p>


































 
  
  





  <img src="/images/hdb-app/hdb-resale-price-predictor.png"   alt="hdb-resale-price-predictor" class="sc-image sc-image-default"
       >


<h2 id="bonus-tracking-model-performance-with-mlflow">Bonus: Tracking Model Performance with MLflow</h2>
<p>To better monitor model performance and track different training experiments, I used MLflow for experiment tracking. Below is a snapshot of the interface showing various model runs and their corresponding metrics:</p>


































 
  
  





  <img src="/images/hdb-app/hdb-xgboost-multistep-bst-local-artifacts.png"   alt="hdb-xgboost-multistep-bst-local-artifacts" class="sc-image sc-image-default"
       >


<p>This setup helps keep experimentation organized and reproducible, especially when tuning hyperparameters or trying different data splits.</p>


































 
  
  





  <img src="/images/hdb-app/hdb-xgboost-multistep-bst-local.png"   alt="hdb-xgboost-multistep-bst-local" class="sc-image sc-image-default"
       >


<h2 id="conclusion">Conclusion</h2>
<p>This walkthrough showcased how easy it is to get started with a full-featured Jupyter environment in Kubeflow using the <code>jupyter-tensorflow-full</code> image. By combining this with Streamlit, I was able to build and test an HDB resale price predictor app directly within my notebook server. With minimal setup and simple port forwarding, Kubeflow proves to be a solid platform not just for machine learning pipelines but also for interactive app development and experimentation.</p>

    </section>

    <nav class="post-navigation">
      <div class="nav-links">
        
          <div class="nav-previous">
            <a href="/posts/2025/04/feature-impact-on-hdb-predictions/" rel="prev">
              <span class="meta-nav">← Previous</span>
              <span class="post-title">Feature Impact on HDB predictions</span>
            </a>
          </div>
        
        
          <div class="nav-next">
            <a href="/posts/2025/05/building-a-recommender-system/" rel="next">
              <span class="meta-nav">Next →</span>
              <span class="post-title">Building a Recommender System</span>
            </a>
          </div>
        
      </div>
    </nav>

    
<div class="giscus-comments-container">
</div>

<script>
  (function() {
    'use strict';

    const getGiscusTheme = () => {
      const storedTheme = localStorage.getItem('theme'); 
      if (storedTheme) {
        return storedTheme === 'dark-mode' ? 'dark' : 'light';
      }
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };

    const setGiscusFrameTheme = (theme) => {
      const iframe = document.querySelector('iframe.giscus-frame');
      if (iframe && iframe.contentWindow) {
        iframe.contentWindow.postMessage({ giscus: { setConfig: { theme: theme } } }, 'https://giscus.app');
      }
    };

    const loadGiscus = () => {
      const giscusContainer = document.querySelector('.giscus-comments-container');
      if (!giscusContainer) {
        console.warn('Giscus container not found.');
        return;
      }

      while (giscusContainer.firstChild) {
        giscusContainer.removeChild(giscusContainer.firstChild);
      }

      const giscusScript = document.createElement('script');
      const giscusAttributes = {
        "src": "https://giscus.app/client.js",
        "data-repo":             "seehiong\/seehiong.github.io",
        "data-repo-id":          "R_kgDOJg7Puw",
        "data-category":         "General",
        "data-category-id":      "DIC_kwDOJg7Pu84Cbyhc",
        "data-mapping":          "url", 
        "data-strict":           "0",
        "data-reactions-enabled":"1",
        "data-emit-metadata":    "0",
        "data-input-position":   "top", 
        "data-theme":            getGiscusTheme(), 
        "data-lang":             "en",
        "data-loading":          "lazy",
        "crossorigin":           "anonymous",
        "async":                 "true", 
      };

      if (!giscusAttributes["data-repo"] || !giscusAttributes["data-repo-id"] || !giscusAttributes["data-category-id"]) {
          console.error("Giscus parameters (giscusRepo, giscusRepoId, giscusCategoryId) are not configured in hugo.toml.");
          giscusContainer.innerHTML = "<p style='color: var(--text-secondary);'>Giscus comments are not configured correctly. Please check site parameters.</p>";
          return;
      }

      Object.entries(giscusAttributes).forEach(
        ([key, value]) => giscusScript.setAttribute(key, value)
      );
      giscusContainer.appendChild(giscusScript);
    };

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadGiscus);
    } else {
        loadGiscus();
    }

    const htmlElement = document.documentElement;
    const observer = new MutationObserver((mutationsList) => {
      for (const mutation of mutationsList) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          setGiscusFrameTheme(getGiscusTheme());
        }
      }
    });
    observer.observe(htmlElement, { attributes: true });

  })();
</script>


  </article>
</div>
</main>
    </div>

    
    <div id="search-modal-overlay" class="search-modal-overlay" style="display: none;">
      <div id="search-modal-content" class="search-modal-content">
        <button id="search-modal-close" class="search-modal-close" aria-label="Close search" title="Close search">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </button>
        <input type="search" id="modal-search-input" class="modal-search-input" placeholder="Search content..." aria-label="Search input">
        <div id="modal-search-results" class="modal-search-results">
        </div>
      </div>
    </div>
    

  <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js" defer></script>
  <script>
    (function() {
      'use strict';

      window.addEventListener('DOMContentLoaded', () => {
        const searchModalOverlay = document.getElementById('search-modal-overlay');
        const searchModalContent = document.getElementById('search-modal-content');
        const searchModalCloseButton = document.getElementById('search-modal-close');
        const searchToggleButton = document.getElementById('nav-search-toggle');
        const searchInputTarget = document.getElementById('modal-search-input');
        const searchResultsTarget = document.getElementById('modal-search-results');

        let fuseInstance = null;
        let searchData = [];

        const loadSearchData = async () => {
          if (searchData.length === 0 && !fuseInstance) {
            try {
              const response = await fetch('\/index.json');
              if (!response.ok) {
                throw new Error(`HTTP error loading index.json! status: ${response.status}`);
              }
              searchData = await response.json();
              initializeFuse();
            } catch (e) {
              console.error("[SearchSetup] Error loading search data:", e);
              if (searchResultsTarget) searchResultsTarget.innerHTML = "<p>Error loading search index.</p>";
            }
          } else if (searchData.length > 0 && !fuseInstance){
            initializeFuse();
          }
        };

        const initializeFuse = () => {
          if (searchData.length > 0 && !fuseInstance) {
            const options = {
              keys: [
                { name: 'title', weight: 0.7 }, { name: 'summary', weight: 0.5 },
                { name: 'content', weight: 0.3 }, { name: 'tags', weight: 0.4 }
              ],
              includeScore: true, threshold: 0.4, minMatchCharLength: 2,
            };
            fuseInstance = new Fuse(searchData, options);
          }
        };

        const performSearch = () => {
          if (!fuseInstance || !searchInputTarget || !searchResultsTarget) return;
          const query = searchInputTarget.value.trim();
          searchResultsTarget.innerHTML = '';
          if (query.length < 2) return;

          const results = fuseInstance.search(query);
          if (results.length > 0) {
            const ul = document.createElement('ul');
            ul.className = 'search-results-list';
            results.slice(0, 10).forEach(result => {
              const item = result.item;
              const li = document.createElement('li');
              li.className = 'search-result-item';
              const a = document.createElement('a');
              a.href = item.permalink;
              a.textContent = item.title;
              li.appendChild(a);
              ul.appendChild(li);
            });
            searchResultsTarget.appendChild(ul);
          } else {
            searchResultsTarget.innerHTML = '<p>No results found.</p>';
          }
        };

        const openSearchModal = async () => {
          await loadSearchData();
          if (searchInputTarget) searchInputTarget.value = '';
          if (searchResultsTarget) searchResultsTarget.innerHTML = '';

          if (searchModalOverlay) {
            searchModalOverlay.style.display = 'flex';
            setTimeout(() => searchModalOverlay.classList.add('active'), 10);
          } else { return; }

          if (searchInputTarget) setTimeout(() => searchInputTarget.focus(), 50);
          if (searchToggleButton) searchToggleButton.classList.add('active');
        };

        const closeSearchModal = () => {
          if (searchModalOverlay) {
            searchModalOverlay.classList.remove('active');
            setTimeout(() => searchModalOverlay.style.display = 'none', 300);
          }
          if (searchToggleButton) searchToggleButton.classList.remove('active');
        };

        if (searchToggleButton) {
          searchToggleButton.addEventListener('click', (e) => {
            e.stopPropagation();
            if (searchModalOverlay && searchModalOverlay.classList.contains('active')) {
              closeSearchModal();
            } else {
              openSearchModal();
            }
          });
        } else { console.error("[SearchSetup] #nav-search-toggle button not found."); }

        if (searchModalCloseButton) { searchModalCloseButton.addEventListener('click', closeSearchModal); }
        if (searchModalOverlay && searchModalContent) {
          searchModalOverlay.addEventListener('click', (event) => {
            if (event.target === searchModalOverlay) closeSearchModal();
          });
        }
        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && searchModalOverlay && searchModalOverlay.classList.contains('active')) {
            closeSearchModal();
          }
        });
        if (searchInputTarget) {
          let debounceTimer;
          searchInputTarget.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(performSearch, 300);
          });
        }
      });
    })();
  </script>

    

    

  <script>
    MathJax = {
      tex: {
        displayMath: [['\\[', '\\]'], ['$$', '$$']], 
        inlineMath: [['\\(', '\\)']], 
        processEscapes: true,
        processEnvironments: true,
        tags: 'ams' 
      },
      svg: {
        fontCache: 'global' 
      },
      chtml: {
        fontURL: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2'
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'], 
        ignoreHtmlClass: 'tex2jax_ignore', 
        processHtmlClass: 'tex2jax_process'
      }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<footer class="footer-main simplified-footer">
  <div class="content-body footer-wraper">
    <div class="footer-box">
      <div class="footer-content">
        <div class="copyright-line">
          Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> © 2025 See Hiong. All rights reserved.
        </div>
        <div class="social-links">
          
            <a href="https://github.com/seehiong" target="_blank" title="GitHub" class="social-link" aria-label="GitHub">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
            </a>
          
          
            <a href="https://www.linkedin.com/in/seehiong/" target="_blank" title="LinkedIn" class="social-link" aria-label="LinkedIn">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
            </a>
          
          
            <a href="/index.xml" target="_blank" title="RSS" class="social-link" aria-label="RSS Feed">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg>
            </a>
          
        </div>
      </div>
    </div>
  </div>
</footer>
        <script src="/js/animation.js" defer></script>
    
        <script src="/js/code-copy.js" defer></script>
    
        <script src="/js/scroll-header.js" defer></script>
       
  </body>
</html>