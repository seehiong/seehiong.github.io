<!DOCTYPE html>
<html lang="en">
  <head><head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <link rel="icon" href="/images/favicon.ico">
    

    <meta property="og:url" content="https://seehiong.github.io/posts/2023/11/building-an-ai-application-with-langchain4j/">
  <meta property="og:site_name" content="See Hiong&#39;s Blog">
  <meta property="og:title" content="Building an AI Application with Langchain4j">
  <meta property="og:description" content="I embarked on a journey to harness the capabilities of Langchain4j, crafting a powerful AI application in Java using the local language model. Utilizing Spring Boot, Postman, and various Langchain4j components, I explored setting up, implementing a chat service, integrating custom tools, embedding functionality with Chroma, translation, persistence, retrieval, and streaming services. The blog post serves as a comprehensive guide for building personalized AI applications, showcasing the versatility and potential of Langchain4j in Java development.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-11-07T20:00:00+08:00">
    <meta property="article:modified_time" content="2023-12-22T00:00:00+00:00">
    <meta property="article:tag" content="Langchain4j">
    <meta property="article:tag" content="LocalAI">
    <meta property="article:tag" content="Spring Boot">
    <meta property="article:tag" content="Java">
    <meta property="article:tag" content="Backend">
    <meta property="article:tag" content="BE">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Building an AI Application with Langchain4j">
  <meta name="twitter:description" content="I embarked on a journey to harness the capabilities of Langchain4j, crafting a powerful AI application in Java using the local language model. Utilizing Spring Boot, Postman, and various Langchain4j components, I explored setting up, implementing a chat service, integrating custom tools, embedding functionality with Chroma, translation, persistence, retrieval, and streaming services. The blog post serves as a comprehensive guide for building personalized AI applications, showcasing the versatility and potential of Langchain4j in Java development.">

  <meta itemprop="name" content="Building an AI Application with Langchain4j">
  <meta itemprop="description" content="I embarked on a journey to harness the capabilities of Langchain4j, crafting a powerful AI application in Java using the local language model. Utilizing Spring Boot, Postman, and various Langchain4j components, I explored setting up, implementing a chat service, integrating custom tools, embedding functionality with Chroma, translation, persistence, retrieval, and streaming services. The blog post serves as a comprehensive guide for building personalized AI applications, showcasing the versatility and potential of Langchain4j in Java development.">
  <meta itemprop="datePublished" content="2023-11-07T20:00:00+08:00">
  <meta itemprop="dateModified" content="2023-12-22T00:00:00+00:00">
  <meta itemprop="wordCount" content="2168">
  <meta itemprop="keywords" content="Langchain4j,LocalAI,Spring Boot,Java,Backend,BE,Chroma,GPT4All,AI,LLM"><title>Building an AI Application with Langchain4j | See Hiong&#39;s Blog</title>

    <link rel="canonical" href="https://seehiong.github.io/posts/2023/11/building-an-ai-application-with-langchain4j/">

    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    
      
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-5PNPM4HWQ0"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-5PNPM4HWQ0');
        }
      </script>
    
    <link rel="stylesheet" href="/css/variables.css">
    
    <link rel="stylesheet" href="/css/base.css">
    
    <link rel="stylesheet" href="/css/layout.css">
    
    <link rel="stylesheet" href="/css/header.css">
    
    <link rel="stylesheet" href="/css/header.css">
    
    <link rel="stylesheet" href="/css/cards.css">
    
    <link rel="stylesheet" href="/css/content_elements.css">
    
    <link rel="stylesheet" href="/css/codeblocks.css">
    
    <link rel="stylesheet" href="/css/page_specific.css">
    
    <link rel="stylesheet" href="/css/shortcodes.css">
    
    <link rel="stylesheet" href="/css/components.css">
    
    <link rel="stylesheet" href="/css/animations.css">
    
    <link rel="stylesheet" href="/css/media_queries.css">
    
    <link rel="stylesheet" href="/css/quantum-theme.css">
    

    
    <script>
      (function() {
        var theme = localStorage.getItem('theme');
        var H = document.documentElement;
        if (theme === 'dark-mode') {
          H.classList.add('dark-mode');
        } else if (theme === 'light-mode') {
          H.classList.remove('dark-mode');
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
          H.classList.add('dark-mode');
        }
      })();
    </script>
</head></head>
  <body class="page-article"><nav class="nav">
  <div class="nav-wrapper">
    <div class="nav-content-wrapper">
      <div class="nav-content">
        <a href="/" class="nav-logo-link" title="See Hiong&#39;s Blog - Home">
          <span class="nav-site-title">
            <span class="nav-site-title__main">SEE HIONG’S</span>
            <span class="nav-site-title__sub">BLOG</span>
          </span>
        </a>
        <div class="nav-menu">
          <div class="nav-item-wrapper">
            
            
            <a href="/posts/" class="nav-item-content active">Archives</a>
            
          </div>
          
          
          <div class="nav-item-wrapper">
            <a href="/tags/" class="nav-item-content ">Tags</a>
          </div>
          <div class="nav-item-wrapper">
            <a href="/about/" class="nav-item-content ">About</a>
          </div>
          <div class="nav-item-wrapper nav-search-toggle-wrapper">
            <button id="nav-search-toggle" class="nav-item-button" aria-label="Toggle search" title="Search">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor" class="nav-item-icon">
                <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5A6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
              </svg>
            </button>
          </div>
          
          
          <button id="theme-toggle" class="nav-item-button" aria-label="Toggle theme"></button> 
        </div>
      </div>
    </div>
  </div>
</nav>


<script>
  document.addEventListener('DOMContentLoaded', function () {
    const themeToggle = document.getElementById('theme-toggle');
    const H = document.documentElement; 

    if (H.classList.contains('dark-mode')) {
      themeToggle.textContent = 'Light Mode';
    } else {
      themeToggle.textContent = 'Dark Mode';
    }

    themeToggle.addEventListener('click', function() {
      H.classList.toggle('dark-mode');
      if (H.classList.contains('dark-mode')) {
        localStorage.setItem('theme', 'dark-mode');
        themeToggle.textContent = 'Light Mode';
      } else {
        localStorage.setItem('theme', 'light-mode');
        themeToggle.textContent = 'Dark Mode';
      }
    });
  });
</script><div id="content-wrapper">
        <main class="container" id="main-content">
<div class="main-content-area">
  <article class="post-layout container">

    <header class="post-header">
      <h1 class="post-title">Building an AI Application with Langchain4j</h1>

      <div class="post-meta">
        <span class="post-meta__date">
          <time datetime="2023-11-07T20:00:00&#43;08:00">November 7, 2023</time>
        </span>

        
          <span class="post-meta__author">Written by See Hiong</span>
        

        
          <span class="post-meta__tags">
            In:
            
              <a href="/tags/langchain4j">langchain4j</a>
            
              , <a href="/tags/localai">LocalAI</a>
            
              , <a href="/tags/spring-boot">Spring Boot</a>
            
              , <a href="/tags/java">Java</a>
            
              , <a href="/tags/backend">Backend</a>
            
              , <a href="/tags/be">BE</a>
            
              , <a href="/tags/chroma">Chroma</a>
            
              , <a href="/tags/gpt4all">GPT4All</a>
            
              , <a href="/tags/ai">AI</a>
            
              , <a href="/tags/llm">LLM</a>
            
          </span>
        

        
      </div>
    </header>

    
      
      
      <div class="post-cover-container post-cover--artistic-blur-wrapper">
        
          <div class="post-cover-blur-background" style="--bg-image: url('/images/langchain4j/building-an-ai-application-with-langchain4j.svg');"></div>
          <img src="/images/langchain4j/building-an-ai-application-with-langchain4j.svg" alt="Building an AI Application with Langchain4j cover image" class="post-cover-image post-cover-image--artistic-blur">
        
      </div>
    

    <section class="post-content">
      <p>In this blog post, I&rsquo;ll walk you through my journey of harnessing the capabilities of 






  <a href="https://github.com/langchain4j/langchain4j/" target="_blank" rel="noopener noreferrer" >langchain4j</a>
 to craft a powerful AI application using Java, specifically with a local language model. Unlike my previous exploration with Python, this post focuses on the Java implementation with Langchain4j.</p>
<h2 id="getting-started">Getting Started</h2>
<p>To kick things off, I&rsquo;ve chosen 






  <a href="https://spring.io/tools" target="_blank" rel="noopener noreferrer" >STS4</a>
 as my Integrated Development Environment (IDE) and opted for 






  <a href="https://adoptium.net/temurin/archive/?version=17" target="_blank" rel="noopener noreferrer" >Java 17</a>
 as my programming language. Leveraging 






  <a href="https://www.postman.com/" target="_blank" rel="noopener noreferrer" >Postman</a>
 as my API platform and 






  <a href="https://spring.io/projects/spring-boot" target="_blank" rel="noopener noreferrer" >Spring Boot</a>
 as the framework of choice, let&rsquo;s delve into the process.</p>
<h3 id="setting-up-a-spring-boot-application">Setting up a Spring Boot Application</h3>
<p>To initiate the project, I began by creating a Spring Starter Project and selecting the Spring Web option. Here&rsquo;s a snippet of the setup:</p>


































 
  
  





  <img src="/images/langchain4j/spring-starter-project.png"   alt="spring-starter-project" class="sc-image sc-image-default"
       >


<h3 id="spring-boot-application">Spring Boot Application</h3>
<p>Here&rsquo;s my sprint boot application:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#cf222e">package</span><span style="color:#fff"> </span><span style="color:#24292e">com.seehiong.ai</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">org.springframework.boot.SpringApplication</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">org.springframework.boot.autoconfigure.SpringBootApplication</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">@SpringBootApplication</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">public</span><span style="color:#fff"> </span><span style="color:#cf222e">class</span> <span style="color:#1f2328">AiApplication</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">public</span><span style="color:#fff"> </span><span style="color:#cf222e">static</span><span style="color:#fff"> </span><span style="color:#cf222e">void</span><span style="color:#fff"> </span><span style="color:#6639ba">main</span><span style="color:#1f2328">(</span>String<span style="color:#0550ae">[]</span><span style="color:#fff"> </span>args<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>SpringApplication<span style="color:#1f2328">.</span><span style="color:#1f2328">run</span><span style="color:#1f2328">(</span>AiApplication<span style="color:#1f2328">.</span><span style="color:#1f2328">class</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>args<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="gradle-build-configuration">Gradle Build Configuration</h3>
<p>My <strong>build.gradle</strong> file outlines the dependencies, including Langchain4j components:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>plugins <span style="color:#0550ae">{</span>
</span></span><span style="display:flex;"><span>	id <span style="color:#0a3069">&#39;java&#39;</span>
</span></span><span style="display:flex;"><span>	id <span style="color:#0a3069">&#39;org.springframework.boot&#39;</span> version <span style="color:#0a3069">&#39;3.1.5&#39;</span>
</span></span><span style="display:flex;"><span>	id <span style="color:#0a3069">&#39;io.spring.dependency-management&#39;</span> version <span style="color:#0a3069">&#39;1.1.3&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#0550ae">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>group <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#39;com.seehiong&#39;</span>
</span></span><span style="display:flex;"><span>version <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#39;0.0.1-SNAPSHOT&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>java <span style="color:#0550ae">{</span>
</span></span><span style="display:flex;"><span>	sourceCompatibility <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#39;17&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#0550ae">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>repositories <span style="color:#0550ae">{</span>
</span></span><span style="display:flex;"><span>	mavenCentral<span style="color:#0550ae">()</span>
</span></span><span style="display:flex;"><span><span style="color:#0550ae">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dependencies <span style="color:#0550ae">{</span>
</span></span><span style="display:flex;"><span>	implementation <span style="color:#0a3069">&#39;org.springframework.boot:spring-boot-starter-web&#39;</span>
</span></span><span style="display:flex;"><span>	testImplementation <span style="color:#0a3069">&#39;org.springframework.boot:spring-boot-starter-test&#39;</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	implementation <span style="color:#0550ae">(</span><span style="color:#0a3069">&#39;dev.langchain4j:langchain4j:0.23.0&#39;</span><span style="color:#0550ae">)</span> <span style="color:#0550ae">{</span>
</span></span><span style="display:flex;"><span>		exclude <span style="color:#900;font-weight:bold">group:</span> <span style="color:#0a3069">&#34;commons-logging&#34;</span><span style="color:#0550ae">,</span> <span style="color:#900;font-weight:bold">module:</span> <span style="color:#0a3069">&#34;commons-logging&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#0550ae">}</span>
</span></span><span style="display:flex;"><span>	implementation <span style="color:#0a3069">&#39;dev.langchain4j:langchain4j-core:0.23.0&#39;</span>
</span></span><span style="display:flex;"><span>	implementation <span style="color:#0a3069">&#39;dev.langchain4j:langchain4j-chroma:0.23.0&#39;</span>
</span></span><span style="display:flex;"><span>	implementation <span style="color:#0a3069">&#39;dev.langchain4j:langchain4j-open-ai:0.23.0&#39;</span>
</span></span><span style="display:flex;"><span>	implementation <span style="color:#0a3069">&#39;dev.langchain4j:langchain4j-local-ai:0.23.0&#39;</span>
</span></span><span style="display:flex;"><span>	implementation <span style="color:#0a3069">&#39;dev.langchain4j:langchain4j-embeddings-all-minilm-l6-v2:0.23.0&#39;</span>	
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	implementation <span style="color:#0a3069">&#39;org.mapdb:mapdb:3.0.10&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#0550ae">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tasks<span style="color:#0550ae">.</span><span style="color:#1f2328">named</span><span style="color:#0550ae">(</span><span style="color:#0a3069">&#39;test&#39;</span><span style="color:#0550ae">)</span> <span style="color:#0550ae">{</span>
</span></span><span style="display:flex;"><span>	useJUnitPlatform<span style="color:#0550ae">()</span>
</span></span><span style="display:flex;"><span><span style="color:#0550ae">}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="application-configuration">Application Configuration</h3>
<p>As a standard practice, I&rsquo;ve created an application.properties file in the src/main/resources directory to specify server configurations:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#1f2328">server.port</span><span style="color:#0550ae">:</span> <span style="color:#0a3069">8888</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h2 id="setting-up-the-controller-and-service">Setting Up the Controller and Service</h2>
<p>Let&rsquo;s continue our journey by establishing the controller and service components of our Java application, seamlessly integrating the power of Langchain4j.</p>
<h3 id="controller-setup">Controller Setup</h3>
<p>Begin by setting up your controller. Below is the skeleton of an empty controller ready to be infused with the capabilities of Langchain4j.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#cf222e">package</span><span style="color:#fff"> </span><span style="color:#24292e">com.seehiong.ai.controller</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">org.springframework.web.bind.annotation.RequestMapping</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">org.springframework.web.bind.annotation.RestController</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">@RestController</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">@RequestMapping</span><span style="color:#1f2328">(</span>value<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;/ai&#34;</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">public</span><span style="color:#fff"> </span><span style="color:#cf222e">class</span> <span style="color:#1f2328">AiController</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#57606a">// We will add the services along the way</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="service-setup">Service Setup</h3>
<p>In the service layer, let&rsquo;s explore the heart of our application. As highlight in the official langchain4j, we can now try out OpenAI&rsquo;s gpt-3.5-turbo and text-embedding-ada-002 models with LangChain4j for free by simply using the API key &ldquo;demo&rdquo;. Here&rsquo;s the sample model service for providing the demo model.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#cf222e">package</span><span style="color:#fff"> </span><span style="color:#24292e">com.seehiong.ai.service</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">org.springframework.stereotype.Service</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.model.chat.ChatLanguageModel</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.model.openai.OpenAiChatModel</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">@Service</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">public</span><span style="color:#fff"> </span><span style="color:#cf222e">class</span> <span style="color:#1f2328">ModelService</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">private</span><span style="color:#fff"> </span>ChatLanguageModel<span style="color:#fff"> </span>demoModel<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">public</span><span style="color:#fff"> </span>ChatLanguageModel<span style="color:#fff"> </span><span style="color:#6639ba">getDemoModel</span><span style="color:#1f2328">()</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">if</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>demoModel<span style="color:#fff"> </span><span style="color:#0550ae">==</span><span style="color:#fff"> </span><span style="color:#cf222e">null</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span>demoModel<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>OpenAiChatModel<span style="color:#1f2328">.</span><span style="color:#1f2328">withApiKey</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;demo&#34;</span><span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">return</span><span style="color:#fff"> </span>demoModel<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#57606a">// We will be adding more models here in the subsequent sections</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h3 id="1-implementing-chat-functionality">1. Implementing Chat Functionality</h3>
<p>Building on the previous implementation, we&rsquo;ve now introduced a dedicated ChatService to handle the generation of chat responses. Here is the updated code:</p>
<h4 id="chatservice-implementation">ChatService implementation:</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#cf222e">package</span><span style="color:#fff"> </span><span style="color:#24292e">com.seehiong.ai.service</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">org.springframework.stereotype.Service</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.model.chat.ChatLanguageModel</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">@Service</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">public</span><span style="color:#fff"> </span><span style="color:#cf222e">class</span> <span style="color:#1f2328">ChatService</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">public</span><span style="color:#fff"> </span>String<span style="color:#fff"> </span><span style="color:#6639ba">generate</span><span style="color:#1f2328">(</span>ChatLanguageModel<span style="color:#fff"> </span>model<span style="color:#1f2328">,</span><span style="color:#fff"> </span>String<span style="color:#fff"> </span>text<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">return</span><span style="color:#fff"> </span>model<span style="color:#1f2328">.</span><span style="color:#1f2328">generate</span><span style="color:#1f2328">(</span>text<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="updated-aicontroller">Updated AiController:</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#cf222e">public</span><span style="color:#fff"> </span><span style="color:#cf222e">class</span> <span style="color:#1f2328">AiController</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#0550ae">@Autowired</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">private</span><span style="color:#fff"> </span>ModelService<span style="color:#fff"> </span>modelSvc<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#0550ae">@Autowired</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">private</span><span style="color:#fff"> </span>ChatService<span style="color:#fff"> </span>chatSvc<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#0550ae">@GetMapping</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;/chat&#34;</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">public</span><span style="color:#fff"> </span>ResponseEntity<span style="color:#0550ae">&lt;</span>String<span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#6639ba">chat</span><span style="color:#1f2328">(</span><span style="color:#0550ae">@RequestParam</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;text&#34;</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span>String<span style="color:#fff"> </span>text<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>String<span style="color:#fff"> </span>response<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>chatSvc<span style="color:#1f2328">.</span><span style="color:#1f2328">generate</span><span style="color:#1f2328">(</span>modelSvc<span style="color:#1f2328">.</span><span style="color:#1f2328">getDemoModel</span><span style="color:#1f2328">(),</span><span style="color:#fff"> </span>text<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">return</span><span style="color:#fff"> </span><span style="color:#cf222e">new</span><span style="color:#fff"> </span>ResponseEntity<span style="color:#0550ae">&lt;&gt;</span><span style="color:#1f2328">(</span>response<span style="color:#1f2328">,</span><span style="color:#fff"> </span>HttpStatus<span style="color:#1f2328">.</span><span style="color:#1f2328">OK</span><span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><p>The <em>ChatService</em> is responsible for the generation of chat responses using the provided model. We&rsquo;ve introduced the <em>/chat</em> endpoint that accepts a query parameter <em>text</em> which represents the input for chat. For simplicity, 






  <a href="https://cheatsheetseries.owasp.org/cheatsheets/Input_Validation_Cheat_Sheet.html" target="_blank" rel="noopener noreferrer" >input validation</a>
 has been omitted in the example.</p>
<h4 id="postman-result">Postman Result:</h4>


































 
  
  





  <img src="/images/langchain4j/langchain4j-chat.png"   alt="langchain4j-chat" class="sc-image sc-image-default"
       >


<h4 id="spring-boot-output">Spring Boot Output:</h4>


































 
  
  





  <img src="/images/langchain4j/langchain4j-spring-boot.png"   alt="langchain4j-spring-boot" class="sc-image sc-image-default"
       >


<h3 id="2-introducing-custom-tools-in-the-controller">2. Introducing Custom Tools in the Controller</h3>
<p>In this section, we&rsquo;re taking our AI application a step further by incorporating a custom tool through the CalculatorService. Here&rsquo;s the detailed code:</p>
<h4 id="calculatorservice-implementation">CalculatorService implementation:</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#cf222e">package</span><span style="color:#fff"> </span><span style="color:#24292e">com.seehiong.ai.service</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">org.springframework.stereotype.Service</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.agent.tool.Tool</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.memory.chat.MessageWindowChatMemory</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.model.chat.ChatLanguageModel</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.service.AiServices</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">@Service</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">public</span><span style="color:#fff"> </span><span style="color:#cf222e">class</span> <span style="color:#1f2328">CalculatorService</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">static</span><span style="color:#fff"> </span><span style="color:#cf222e">class</span> <span style="color:#1f2328">Calculator</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#0550ae">@Tool</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Calculates the length of a string&#34;</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">int</span><span style="color:#fff"> </span><span style="color:#6639ba">stringLength</span><span style="color:#1f2328">(</span>String<span style="color:#fff"> </span>s<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span><span style="color:#cf222e">return</span><span style="color:#fff"> </span>s<span style="color:#1f2328">.</span><span style="color:#1f2328">length</span><span style="color:#1f2328">();</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#0550ae">@Tool</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Calculates the sum of two numbers&#34;</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">int</span><span style="color:#fff"> </span><span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#cf222e">int</span><span style="color:#fff"> </span>a<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#cf222e">int</span><span style="color:#fff"> </span>b<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span><span style="color:#cf222e">return</span><span style="color:#fff"> </span>a<span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span>b<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#0550ae">@Tool</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Calculates the square root of a number&#34;</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">double</span><span style="color:#fff"> </span><span style="color:#6639ba">sqrt</span><span style="color:#1f2328">(</span><span style="color:#cf222e">int</span><span style="color:#fff"> </span>x<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span><span style="color:#cf222e">return</span><span style="color:#fff"> </span>Math<span style="color:#1f2328">.</span><span style="color:#1f2328">sqrt</span><span style="color:#1f2328">(</span>x<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">interface</span> <span style="color:#1f2328">Assistant</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>String<span style="color:#fff"> </span><span style="color:#6639ba">chat</span><span style="color:#1f2328">(</span>String<span style="color:#fff"> </span>userMessage<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">public</span><span style="color:#fff"> </span>String<span style="color:#fff"> </span><span style="color:#6639ba">calculate</span><span style="color:#1f2328">(</span>ChatLanguageModel<span style="color:#fff"> </span>model<span style="color:#1f2328">,</span><span style="color:#fff"> </span>String<span style="color:#fff"> </span>text<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>Assistant<span style="color:#fff"> </span>assistant<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>AiServices<span style="color:#1f2328">.</span><span style="color:#1f2328">builder</span><span style="color:#1f2328">(</span>Assistant<span style="color:#1f2328">.</span><span style="color:#1f2328">class</span><span style="color:#1f2328">).</span><span style="color:#1f2328">chatLanguageModel</span><span style="color:#1f2328">(</span>model<span style="color:#1f2328">).</span><span style="color:#1f2328">tools</span><span style="color:#1f2328">(</span><span style="color:#cf222e">new</span><span style="color:#fff"> </span>Calculator<span style="color:#1f2328">())</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">				</span><span style="color:#1f2328">.</span><span style="color:#1f2328">chatMemory</span><span style="color:#1f2328">(</span>MessageWindowChatMemory<span style="color:#1f2328">.</span><span style="color:#1f2328">withMaxMessages</span><span style="color:#1f2328">(</span>10<span style="color:#1f2328">)).</span><span style="color:#1f2328">build</span><span style="color:#1f2328">();</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">return</span><span style="color:#fff"> </span>assistant<span style="color:#1f2328">.</span><span style="color:#1f2328">chat</span><span style="color:#1f2328">(</span>text<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="updated-aicontroller-1">Updated AiController:</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#cf222e">public</span><span style="color:#fff"> </span><span style="color:#cf222e">class</span> <span style="color:#1f2328">AiController</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">...</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#0550ae">@Autowired</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">private</span><span style="color:#fff"> </span>CalculatorService<span style="color:#fff"> </span>calculatorSvc<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#0550ae">@GetMapping</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;/calculate&#34;</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">public</span><span style="color:#fff"> </span>ResponseEntity<span style="color:#0550ae">&lt;</span>String<span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#6639ba">calculate</span><span style="color:#1f2328">(</span><span style="color:#0550ae">@RequestParam</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;text&#34;</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span>String<span style="color:#fff"> </span>text<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>String<span style="color:#fff"> </span>response<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>calculatorSvc<span style="color:#1f2328">.</span><span style="color:#1f2328">calculate</span><span style="color:#1f2328">(</span>modelSvc<span style="color:#1f2328">.</span><span style="color:#1f2328">getDemoModel</span><span style="color:#1f2328">(),</span><span style="color:#fff"> </span>text<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">return</span><span style="color:#fff"> </span><span style="color:#cf222e">new</span><span style="color:#fff"> </span>ResponseEntity<span style="color:#0550ae">&lt;&gt;</span><span style="color:#1f2328">(</span>response<span style="color:#1f2328">,</span><span style="color:#fff"> </span>HttpStatus<span style="color:#1f2328">.</span><span style="color:#1f2328">OK</span><span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><p>The <em>CalculatorService</em> introduces the <em>Calculator</em> class with custom Tool annotation to calculate the length of a string, sum of two numbers, and the square root of a number. The <em>Assistant</em> interface facilitates the chat interation.</p>
<h4 id="postman-result-1">Postman Result:</h4>


































 
  
  





  <img src="/images/langchain4j/langchain4j-calculator.png"   alt="langchain4j-calculator" class="sc-image sc-image-default"
       >


<h3 id="3-integrating-embedding-functionality-with-chroma">3. Integrating Embedding Functionality with Chroma</h3>
<p>To enhance our AI application, we&rsquo;ve introduced embedding functionality using Chroma, following the 






  <a href="https://github.com/langchain4j/langchain4j-examples/blob/main/chroma-example/src/main/java/ChromaEmbeddingStoreExample.java" target="_blank" rel="noopener noreferrer" >Chroma embedding store example</a>
. Prior to running spring boot, make sure to pull the Chroma image and run it with 






  <a href="https://docs.docker.com/desktop/install/windows-install/" target="_blank" rel="noopener noreferrer" >Docker Desktop</a>
:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker pull ghcr.io/chroma-core/chroma:0.4.6
</span></span><span style="display:flex;"><span>docker run -d -p 8000:8000 ghcr.io/chroma-core/chroma:0.4.6</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="embeddingservice-implementation">EmbeddingService Implementation:</h4>
<p>This service demonstrates the embedding functionality:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#cf222e">package</span><span style="color:#fff"> </span><span style="color:#24292e">com.seehiong.ai.service</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import static</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.internal.Utils.randomUUID</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">java.util.List</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">org.springframework.stereotype.Service</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.data.embedding.Embedding</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.data.segment.TextSegment</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.model.embedding.EmbeddingModel</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.store.embedding.EmbeddingMatch</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.store.embedding.EmbeddingStore</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.store.embedding.chroma.ChromaEmbeddingStore</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">@Service</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">public</span><span style="color:#fff"> </span><span style="color:#cf222e">class</span> <span style="color:#1f2328">EmbeddingService</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">private</span><span style="color:#fff"> </span>EmbeddingStore<span style="color:#0550ae">&lt;</span>TextSegment<span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span>embeddingStore<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">public</span><span style="color:#fff"> </span>String<span style="color:#fff"> </span><span style="color:#6639ba">embed</span><span style="color:#1f2328">(</span>EmbeddingModel<span style="color:#fff"> </span>embeddingModel<span style="color:#1f2328">,</span><span style="color:#fff"> </span>String<span style="color:#fff"> </span>text<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>StringBuilder<span style="color:#fff"> </span>sb<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">new</span><span style="color:#fff"> </span>StringBuilder<span style="color:#1f2328">();</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>Embedding<span style="color:#fff"> </span>inProcessEmbedding<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>embeddingModel<span style="color:#1f2328">.</span><span style="color:#1f2328">embed</span><span style="color:#1f2328">(</span>text<span style="color:#1f2328">).</span><span style="color:#1f2328">content</span><span style="color:#1f2328">();</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>sb<span style="color:#1f2328">.</span><span style="color:#1f2328">append</span><span style="color:#1f2328">(</span>String<span style="color:#1f2328">.</span><span style="color:#1f2328">valueOf</span><span style="color:#1f2328">(</span>inProcessEmbedding<span style="color:#1f2328">)).</span><span style="color:#1f2328">append</span><span style="color:#1f2328">(</span>System<span style="color:#1f2328">.</span><span style="color:#1f2328">lineSeparator</span><span style="color:#1f2328">());</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>TextSegment<span style="color:#fff"> </span>segment1<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>TextSegment<span style="color:#1f2328">.</span><span style="color:#1f2328">from</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;I like football.&#34;</span><span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>Embedding<span style="color:#fff"> </span>embedding1<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>embeddingModel<span style="color:#1f2328">.</span><span style="color:#1f2328">embed</span><span style="color:#1f2328">(</span>segment1<span style="color:#1f2328">).</span><span style="color:#1f2328">content</span><span style="color:#1f2328">();</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>getEmbeddingStore<span style="color:#1f2328">().</span><span style="color:#1f2328">add</span><span style="color:#1f2328">(</span>embedding1<span style="color:#1f2328">,</span><span style="color:#fff"> </span>segment1<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>TextSegment<span style="color:#fff"> </span>segment2<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>TextSegment<span style="color:#1f2328">.</span><span style="color:#1f2328">from</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;The weather is good today.&#34;</span><span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>Embedding<span style="color:#fff"> </span>embedding2<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>embeddingModel<span style="color:#1f2328">.</span><span style="color:#1f2328">embed</span><span style="color:#1f2328">(</span>segment2<span style="color:#1f2328">).</span><span style="color:#1f2328">content</span><span style="color:#1f2328">();</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>getEmbeddingStore<span style="color:#1f2328">().</span><span style="color:#1f2328">add</span><span style="color:#1f2328">(</span>embedding2<span style="color:#1f2328">,</span><span style="color:#fff"> </span>segment2<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>Embedding<span style="color:#fff"> </span>queryEmbedding<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>embeddingModel<span style="color:#1f2328">.</span><span style="color:#1f2328">embed</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;What is your favourite sport?&#34;</span><span style="color:#1f2328">).</span><span style="color:#1f2328">content</span><span style="color:#1f2328">();</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>List<span style="color:#0550ae">&lt;</span>EmbeddingMatch<span style="color:#0550ae">&lt;</span>TextSegment<span style="color:#0550ae">&gt;&gt;</span><span style="color:#fff"> </span>relevant<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>getEmbeddingStore<span style="color:#1f2328">().</span><span style="color:#1f2328">findRelevant</span><span style="color:#1f2328">(</span>queryEmbedding<span style="color:#1f2328">,</span><span style="color:#fff"> </span>1<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>EmbeddingMatch<span style="color:#0550ae">&lt;</span>TextSegment<span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span>embeddingMatch<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>relevant<span style="color:#1f2328">.</span><span style="color:#1f2328">get</span><span style="color:#1f2328">(</span>0<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>sb<span style="color:#1f2328">.</span><span style="color:#1f2328">append</span><span style="color:#1f2328">(</span>String<span style="color:#1f2328">.</span><span style="color:#1f2328">valueOf</span><span style="color:#1f2328">(</span>embeddingMatch<span style="color:#1f2328">.</span><span style="color:#1f2328">score</span><span style="color:#1f2328">())).</span><span style="color:#1f2328">append</span><span style="color:#1f2328">(</span>System<span style="color:#1f2328">.</span><span style="color:#1f2328">lineSeparator</span><span style="color:#1f2328">());</span><span style="color:#fff"> </span><span style="color:#57606a">// 0.8144288493114709</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>sb<span style="color:#1f2328">.</span><span style="color:#1f2328">append</span><span style="color:#1f2328">(</span>embeddingMatch<span style="color:#1f2328">.</span><span style="color:#1f2328">embedded</span><span style="color:#1f2328">().</span><span style="color:#1f2328">text</span><span style="color:#1f2328">());</span><span style="color:#fff"> </span><span style="color:#57606a">// I like football.</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">return</span><span style="color:#fff"> </span>sb<span style="color:#1f2328">.</span><span style="color:#1f2328">toString</span><span style="color:#1f2328">();</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">private</span><span style="color:#fff"> </span>EmbeddingStore<span style="color:#0550ae">&lt;</span>TextSegment<span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#6639ba">getEmbeddingStore</span><span style="color:#1f2328">()</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">if</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>embeddingStore<span style="color:#fff"> </span><span style="color:#0550ae">==</span><span style="color:#fff"> </span><span style="color:#cf222e">null</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span>embeddingStore<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>ChromaEmbeddingStore<span style="color:#1f2328">.</span><span style="color:#1f2328">builder</span><span style="color:#1f2328">().</span><span style="color:#1f2328">baseUrl</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;http://127.0.0.1:8000&#34;</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">					</span><span style="color:#1f2328">.</span><span style="color:#1f2328">collectionName</span><span style="color:#1f2328">(</span>randomUUID<span style="color:#1f2328">()).</span><span style="color:#1f2328">build</span><span style="color:#1f2328">();</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">return</span><span style="color:#fff"> </span>embeddingStore<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="updated-aicontroller-2">Updated AiController:</h4>
<p>The AiController now includes the <em>/embed</em> endpoint to showcase the embedding functionality:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#cf222e">public</span><span style="color:#fff"> </span><span style="color:#cf222e">class</span> <span style="color:#1f2328">AiController</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">...</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#0550ae">@Autowired</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">private</span><span style="color:#fff"> </span>EmbeddingService<span style="color:#fff"> </span>embeddingSvc<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#0550ae">@GetMapping</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;/embed&#34;</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">public</span><span style="color:#fff"> </span>ResponseEntity<span style="color:#0550ae">&lt;</span>String<span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#6639ba">embed</span><span style="color:#1f2328">(</span><span style="color:#0550ae">@RequestParam</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;text&#34;</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span>String<span style="color:#fff"> </span>text<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>String<span style="color:#fff"> </span>response<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>embeddingSvc<span style="color:#1f2328">.</span><span style="color:#1f2328">embed</span><span style="color:#1f2328">(</span>modelSvc<span style="color:#1f2328">.</span><span style="color:#1f2328">getEmbeddingModel</span><span style="color:#1f2328">(),</span><span style="color:#fff"> </span>text<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">return</span><span style="color:#fff"> </span><span style="color:#cf222e">new</span><span style="color:#fff"> </span>ResponseEntity<span style="color:#0550ae">&lt;&gt;</span><span style="color:#1f2328">(</span>response<span style="color:#1f2328">,</span><span style="color:#fff"> </span>HttpStatus<span style="color:#1f2328">.</span><span style="color:#1f2328">OK</span><span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="postman-result-2">Postman Result:</h4>


































 
  
  





  <img src="/images/langchain4j/langchain4j-embedding.png"   alt="langchain4j-embedding" class="sc-image sc-image-default"
       >


<h3 id="4-integrating-translate-service">4. Integrating Translate Service</h3>
<p>In this section, we&rsquo;ve integrated the Translate Service into our AI application. Below are the relevant implementations:</p>
<h4 id="translateservice-implementation">TranslateService Implementation:</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#cf222e">package</span><span style="color:#fff"> </span><span style="color:#24292e">com.seehiong.ai.service</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">org.springframework.stereotype.Service</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.model.chat.ChatLanguageModel</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.service.AiServices</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.service.SystemMessage</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.service.UserMessage</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.service.V</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">@Service</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">public</span><span style="color:#fff"> </span><span style="color:#cf222e">class</span> <span style="color:#1f2328">TranslatorService</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">interface</span> <span style="color:#1f2328">Translator</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#0550ae">@SystemMessage</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;You are a professional translator into {{language}}&#34;</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#0550ae">@UserMessage</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Translate the following text: {{text}}&#34;</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>String<span style="color:#fff"> </span><span style="color:#6639ba">translate</span><span style="color:#1f2328">(</span><span style="color:#0550ae">@V</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;text&#34;</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span>String<span style="color:#fff"> </span>text<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">@V</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;language&#34;</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span>String<span style="color:#fff"> </span>language<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">public</span><span style="color:#fff"> </span>String<span style="color:#fff"> </span><span style="color:#6639ba">translate</span><span style="color:#1f2328">(</span>ChatLanguageModel<span style="color:#fff"> </span>model<span style="color:#1f2328">,</span><span style="color:#fff"> </span>String<span style="color:#fff"> </span>text<span style="color:#1f2328">,</span><span style="color:#fff"> </span>String<span style="color:#fff"> </span>language<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>Translator<span style="color:#fff"> </span>translator<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>AiServices<span style="color:#1f2328">.</span><span style="color:#1f2328">create</span><span style="color:#1f2328">(</span>Translator<span style="color:#1f2328">.</span><span style="color:#1f2328">class</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>model<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">return</span><span style="color:#fff"> </span>translator<span style="color:#1f2328">.</span><span style="color:#1f2328">translate</span><span style="color:#1f2328">(</span>text<span style="color:#1f2328">,</span><span style="color:#fff"> </span>language<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="updated-aicontroller-3">Updated AiController:</h4>
<p>In the updated AiController, we have set the default language to Chinese, but users can override it and set it to any other language:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#cf222e">public</span><span style="color:#fff"> </span><span style="color:#cf222e">class</span> <span style="color:#1f2328">AiController</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">...</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#0550ae">@Autowired</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">private</span><span style="color:#fff"> </span>TranslatorService<span style="color:#fff"> </span>translatorSvc<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#0550ae">@GetMapping</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;/translate&#34;</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">public</span><span style="color:#fff"> </span>ResponseEntity<span style="color:#0550ae">&lt;</span>String<span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#6639ba">translate</span><span style="color:#1f2328">(</span><span style="color:#0550ae">@RequestParam</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;text&#34;</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span>String<span style="color:#fff"> </span>text<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span><span style="color:#0550ae">@RequestParam</span><span style="color:#1f2328">(</span>defaultValue<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;chinese&#34;</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span>String<span style="color:#fff"> </span>language<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>String<span style="color:#fff"> </span>response<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>translatorSvc<span style="color:#1f2328">.</span><span style="color:#1f2328">translate</span><span style="color:#1f2328">(</span>modelSvc<span style="color:#1f2328">.</span><span style="color:#1f2328">getDemoModel</span><span style="color:#1f2328">(),</span><span style="color:#fff"> </span>text<span style="color:#1f2328">,</span><span style="color:#fff"> </span>language<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">return</span><span style="color:#fff"> </span><span style="color:#cf222e">new</span><span style="color:#fff"> </span>ResponseEntity<span style="color:#0550ae">&lt;&gt;</span><span style="color:#1f2328">(</span>response<span style="color:#1f2328">,</span><span style="color:#fff"> </span>HttpStatus<span style="color:#1f2328">.</span><span style="color:#1f2328">OK</span><span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="postman-result-3">Postman Result:</h4>


































 
  
  





  <img src="/images/langchain4j/langchain4j-translate-to-chinese.png"   alt="langchain4j-translate-to-chinese" class="sc-image sc-image-default"
       >


<h3 id="5-introducing-persistence-service">5. Introducing Persistence Service</h3>
<p>In this section, we&rsquo;ve introduced a Persistence Service to add a persistence layer to our AI application. Below are the relevant implementations:</p>
<h4 id="persistenceservice-implementation">PersistenceService Implementation:</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#cf222e">package</span><span style="color:#fff"> </span><span style="color:#24292e">com.seehiong.ai.service</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import static</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.data.message.ChatMessageDeserializer.messagesFromJson</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import static</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.data.message.ChatMessageSerializer.messagesToJson</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import static</span><span style="color:#fff"> </span><span style="color:#24292e">org.mapdb.Serializer.INTEGER</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import static</span><span style="color:#fff"> </span><span style="color:#24292e">org.mapdb.Serializer.STRING</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">java.util.List</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">java.util.Map</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">org.mapdb.DB</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">org.mapdb.DBMaker</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">org.springframework.stereotype.Service</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.data.message.ChatMessage</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.memory.chat.ChatMemoryProvider</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.memory.chat.MessageWindowChatMemory</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.model.chat.ChatLanguageModel</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.service.AiServices</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.service.MemoryId</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.service.UserMessage</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.store.memory.chat.ChatMemoryStore</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">@Service</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">public</span><span style="color:#fff"> </span><span style="color:#cf222e">class</span> <span style="color:#1f2328">PersistenceService</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">private</span><span style="color:#fff"> </span>PersistentChatMemoryStore<span style="color:#fff"> </span>store<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">new</span><span style="color:#fff"> </span>PersistentChatMemoryStore<span style="color:#1f2328">();</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">interface</span> <span style="color:#1f2328">Assistant</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>String<span style="color:#fff"> </span><span style="color:#6639ba">chat</span><span style="color:#1f2328">(</span><span style="color:#0550ae">@MemoryId</span><span style="color:#fff"> </span><span style="color:#cf222e">int</span><span style="color:#fff"> </span>memoryId<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">@UserMessage</span><span style="color:#fff"> </span>String<span style="color:#fff"> </span>userMessage<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">static</span><span style="color:#fff"> </span><span style="color:#cf222e">class</span> <span style="color:#1f2328">PersistentChatMemoryStore</span><span style="color:#fff"> </span><span style="color:#cf222e">implements</span><span style="color:#fff"> </span>ChatMemoryStore<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">private</span><span style="color:#fff"> </span><span style="color:#cf222e">final</span><span style="color:#fff"> </span>DB<span style="color:#fff"> </span>db<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>DBMaker<span style="color:#1f2328">.</span><span style="color:#1f2328">fileDB</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;multi-user-chat-memory.db&#34;</span><span style="color:#1f2328">).</span><span style="color:#1f2328">closeOnJvmShutdown</span><span style="color:#1f2328">().</span><span style="color:#1f2328">transactionEnable</span><span style="color:#1f2328">()</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">				</span><span style="color:#1f2328">.</span><span style="color:#1f2328">make</span><span style="color:#1f2328">();</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">private</span><span style="color:#fff"> </span><span style="color:#cf222e">final</span><span style="color:#fff"> </span>Map<span style="color:#0550ae">&lt;</span>Integer<span style="color:#1f2328">,</span><span style="color:#fff"> </span>String<span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span>map<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>db<span style="color:#1f2328">.</span><span style="color:#1f2328">hashMap</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;messages&#34;</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>INTEGER<span style="color:#1f2328">,</span><span style="color:#fff"> </span>STRING<span style="color:#1f2328">).</span><span style="color:#1f2328">createOrOpen</span><span style="color:#1f2328">();</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#0550ae">@Override</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">public</span><span style="color:#fff"> </span>List<span style="color:#0550ae">&lt;</span>ChatMessage<span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#6639ba">getMessages</span><span style="color:#1f2328">(</span>Object<span style="color:#fff"> </span>memoryId<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span>String<span style="color:#fff"> </span>json<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>map<span style="color:#1f2328">.</span><span style="color:#1f2328">get</span><span style="color:#1f2328">((</span><span style="color:#cf222e">int</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span>memoryId<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span><span style="color:#cf222e">return</span><span style="color:#fff"> </span>messagesFromJson<span style="color:#1f2328">(</span>json<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#0550ae">@Override</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">public</span><span style="color:#fff"> </span><span style="color:#cf222e">void</span><span style="color:#fff"> </span><span style="color:#6639ba">updateMessages</span><span style="color:#1f2328">(</span>Object<span style="color:#fff"> </span>memoryId<span style="color:#1f2328">,</span><span style="color:#fff"> </span>List<span style="color:#0550ae">&lt;</span>ChatMessage<span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span>messages<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span>String<span style="color:#fff"> </span>json<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>messagesToJson<span style="color:#1f2328">(</span>messages<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span>map<span style="color:#1f2328">.</span><span style="color:#1f2328">put</span><span style="color:#1f2328">((</span><span style="color:#cf222e">int</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span>memoryId<span style="color:#1f2328">,</span><span style="color:#fff"> </span>json<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span>db<span style="color:#1f2328">.</span><span style="color:#1f2328">commit</span><span style="color:#1f2328">();</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#0550ae">@Override</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">public</span><span style="color:#fff"> </span><span style="color:#cf222e">void</span><span style="color:#fff"> </span><span style="color:#6639ba">deleteMessages</span><span style="color:#1f2328">(</span>Object<span style="color:#fff"> </span>memoryId<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span>map<span style="color:#1f2328">.</span><span style="color:#1f2328">remove</span><span style="color:#1f2328">((</span><span style="color:#cf222e">int</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span>memoryId<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span>db<span style="color:#1f2328">.</span><span style="color:#1f2328">commit</span><span style="color:#1f2328">();</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">public</span><span style="color:#fff"> </span>String<span style="color:#fff"> </span><span style="color:#6639ba">demo</span><span style="color:#1f2328">(</span>ChatLanguageModel<span style="color:#fff"> </span>model<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#cf222e">boolean</span><span style="color:#fff"> </span>showName<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>StringBuilder<span style="color:#fff"> </span>sb<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">new</span><span style="color:#fff"> </span>StringBuilder<span style="color:#1f2328">();</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>ChatMemoryProvider<span style="color:#fff"> </span>chatMemoryProvider<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>memoryId<span style="color:#fff"> </span><span style="color:#0550ae">-&gt;</span><span style="color:#fff"> </span>MessageWindowChatMemory<span style="color:#1f2328">.</span><span style="color:#1f2328">builder</span><span style="color:#1f2328">().</span><span style="color:#1f2328">id</span><span style="color:#1f2328">(</span>memoryId<span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">				</span><span style="color:#1f2328">.</span><span style="color:#1f2328">maxMessages</span><span style="color:#1f2328">(</span>10<span style="color:#1f2328">).</span><span style="color:#1f2328">chatMemoryStore</span><span style="color:#1f2328">(</span>store<span style="color:#1f2328">).</span><span style="color:#1f2328">build</span><span style="color:#1f2328">();</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>Assistant<span style="color:#fff"> </span>assistant<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>AiServices<span style="color:#1f2328">.</span><span style="color:#1f2328">builder</span><span style="color:#1f2328">(</span>Assistant<span style="color:#1f2328">.</span><span style="color:#1f2328">class</span><span style="color:#1f2328">).</span><span style="color:#1f2328">chatLanguageModel</span><span style="color:#1f2328">(</span>model<span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">				</span><span style="color:#1f2328">.</span><span style="color:#1f2328">chatMemoryProvider</span><span style="color:#1f2328">(</span>chatMemoryProvider<span style="color:#1f2328">).</span><span style="color:#1f2328">build</span><span style="color:#1f2328">();</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">if</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>showName<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span>sb<span style="color:#1f2328">.</span><span style="color:#1f2328">append</span><span style="color:#1f2328">(</span>assistant<span style="color:#1f2328">.</span><span style="color:#1f2328">chat</span><span style="color:#1f2328">(</span>1<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;Hello, my name is Klaus&#34;</span><span style="color:#1f2328">)).</span><span style="color:#1f2328">append</span><span style="color:#1f2328">(</span>System<span style="color:#1f2328">.</span><span style="color:#1f2328">lineSeparator</span><span style="color:#1f2328">());</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span>sb<span style="color:#1f2328">.</span><span style="color:#1f2328">append</span><span style="color:#1f2328">(</span>assistant<span style="color:#1f2328">.</span><span style="color:#1f2328">chat</span><span style="color:#1f2328">(</span>2<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;Hi, my name is Francine&#34;</span><span style="color:#1f2328">));</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#1f2328">}</span><span style="color:#fff"> </span><span style="color:#cf222e">else</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span>sb<span style="color:#1f2328">.</span><span style="color:#1f2328">append</span><span style="color:#1f2328">(</span>assistant<span style="color:#1f2328">.</span><span style="color:#1f2328">chat</span><span style="color:#1f2328">(</span>1<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;What is my name?&#34;</span><span style="color:#1f2328">)).</span><span style="color:#1f2328">append</span><span style="color:#1f2328">(</span>System<span style="color:#1f2328">.</span><span style="color:#1f2328">lineSeparator</span><span style="color:#1f2328">());</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span>sb<span style="color:#1f2328">.</span><span style="color:#1f2328">append</span><span style="color:#1f2328">(</span>assistant<span style="color:#1f2328">.</span><span style="color:#1f2328">chat</span><span style="color:#1f2328">(</span>2<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;What is my name?&#34;</span><span style="color:#1f2328">));</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">return</span><span style="color:#fff"> </span>sb<span style="color:#1f2328">.</span><span style="color:#1f2328">toString</span><span style="color:#1f2328">();</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="updated-aicontroller-4">Updated AiController:</h4>
<p>Here, we adapted from 






  <a href="https://github.com/langchain4j/langchain4j-examples/blob/main/other-examples/src/main/java/ServiceWithPersistentMemoryForEachUserExample.java" target="_blank" rel="noopener noreferrer" >persistent ChatMemory</a>
. The AiController now includes an endpoint <em>/persistDemo</em> to showcase the Persistence Service. Users can set the showName parameter to true on the first run and false on the second run:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#cf222e">public</span><span style="color:#fff"> </span><span style="color:#cf222e">class</span> <span style="color:#1f2328">AiController</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">...</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#0550ae">@Autowired</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">private</span><span style="color:#fff"> </span>PersistenceService<span style="color:#fff"> </span>persistenceSvc<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#0550ae">@GetMapping</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;/persistDemo&#34;</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">public</span><span style="color:#fff"> </span>ResponseEntity<span style="color:#0550ae">&lt;</span>String<span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#6639ba">persistDemo</span><span style="color:#1f2328">(</span><span style="color:#0550ae">@RequestParam</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;showName&#34;</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span>String<span style="color:#fff"> </span>showName<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>String<span style="color:#fff"> </span>response<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>persistenceSvc<span style="color:#1f2328">.</span><span style="color:#1f2328">demo</span><span style="color:#1f2328">(</span>modelSvc<span style="color:#1f2328">.</span><span style="color:#1f2328">getDemoModel</span><span style="color:#1f2328">(),</span><span style="color:#fff"> </span>Boolean<span style="color:#1f2328">.</span><span style="color:#1f2328">valueOf</span><span style="color:#1f2328">(</span>showName<span style="color:#1f2328">));</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">return</span><span style="color:#fff"> </span><span style="color:#cf222e">new</span><span style="color:#fff"> </span>ResponseEntity<span style="color:#0550ae">&lt;&gt;</span><span style="color:#1f2328">(</span>response<span style="color:#1f2328">,</span><span style="color:#fff"> </span>HttpStatus<span style="color:#1f2328">.</span><span style="color:#1f2328">OK</span><span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="postman-result-1-shownametrue">Postman Result 1 (showName=true):</h4>


































 
  
  





  <img src="/images/langchain4j/langchain4j-persistence-show-name.png"   alt="langchain4j-persistence-show-name" class="sc-image sc-image-default"
       >


<h4 id="postman-result-2-shownamefalse">Postman Result 2 (showName=false):</h4>


































 
  
  





  <img src="/images/langchain4j/langchain4j-persistence-hide-name.png"   alt="langchain4j-persistence-hide-name" class="sc-image sc-image-default"
       >


<h3 id="6-introducing-retrieval-service-via-local-llm">6. Introducing Retrieval Service via Local LLM</h3>
<p>In this section, we&rsquo;ve introduced a Retrieval Service utilizing a local Language Model (LLM) through 






  <a href="https://localai.io/" target="_blank" rel="noopener noreferrer" >LocalAI</a>
. Here are the key components and implementations:</p>
<h4 id="setting-up-local-ai">Setting up Local AI</h4>
<p>Before running the Spring Boot application, set up Local AI using the following commands within 






  <a href="https://learn.microsoft.com/en-us/windows/wsl/install" target="_blank" rel="noopener noreferrer" >WSL</a>
. Please <em>note</em> that for below example, the docker container will download or use the models under the models folder:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker pull quay.io/go-skynet/local-ai:v2.0.0
</span></span><span style="display:flex;"><span>docker run -p 8080:8080 -v <span style="color:#953800">$PWD</span>/models:/models -ti --rm quay.io/go-skynet/local-ai:v2.0.0 --models-path /models --context-size <span style="color:#0550ae">2000</span> --threads <span style="color:#0550ae">8</span> --debug<span style="color:#0550ae">=</span>true</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><p>By setting to debug on, you should be seeing something like this:


































 
  
  





  <img src="/images/langchain4j/langchain4j-local-ai.png"   alt="langchain4j-local-ai" class="sc-image sc-image-default"
       >

</p>
<p>Next, try to download a model with the command:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>curl http://127.0.0.1:8080/models/apply -H <span style="color:#0a3069">&#34;Content-Type: application/json&#34;</span> -d <span style="color:#0a3069">&#39;{&#34;url&#34;: &#34;github:go-skynet/model-gallery/gpt4all-j.yaml&#34;}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># Using the similar curl command, replacing the actual job ID to check if the model has been downloaded successfully</span>
</span></span><span style="display:flex;"><span>curl http://127.0.0.1:8080/models/jobs/b5141f97-7bb8-11ee-aa82-0242ac110003</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><p>You may verify the list of downloaded models with:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>curl http://127.0.0.1:8080/models/ <span style="color:#1f2328">|</span> jq</span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><p>Make sure Local AI is running successfully, and models are downloaded.


































 
  
  





  <img src="/images/langchain4j/langchain4j-local-ai-models.png"   alt="langchain4j-local-ai-models" class="sc-image sc-image-default"
       >

</p>
<h4 id="modelservice-modification">ModelService Modification</h4>
<p>In the <em>ModelService</em> class, we added the configuration for the local model and an embedding model for retrieval augmented generation. Additionally, the timeout was extended to 5 minutes to account for the expected longer referencing time.</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#cf222e">public</span><span style="color:#fff"> </span><span style="color:#cf222e">class</span> <span style="color:#1f2328">ModelService</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">...</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">private</span><span style="color:#fff"> </span><span style="color:#cf222e">static</span><span style="color:#fff"> </span><span style="color:#cf222e">final</span><span style="color:#fff"> </span>String<span style="color:#fff"> </span>MODEL_NAME<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;gpt4all-j&#34;</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">private</span><span style="color:#fff"> </span><span style="color:#cf222e">static</span><span style="color:#fff"> </span><span style="color:#cf222e">final</span><span style="color:#fff"> </span>String<span style="color:#fff"> </span>LOCAL_AI_URL<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;http://127.0.0.1:8080&#34;</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">private</span><span style="color:#fff"> </span>ChatLanguageModel<span style="color:#fff"> </span>localModel<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">private</span><span style="color:#fff"> </span>AllMiniLmL6V2EmbeddingModel<span style="color:#fff"> </span>embeddingModel<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">public</span><span style="color:#fff"> </span>ChatLanguageModel<span style="color:#fff"> </span><span style="color:#6639ba">getLocalModel</span><span style="color:#1f2328">()</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">if</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>localModel<span style="color:#fff"> </span><span style="color:#0550ae">==</span><span style="color:#fff"> </span><span style="color:#cf222e">null</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span>localModel<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>LocalAiChatModel<span style="color:#1f2328">.</span><span style="color:#1f2328">builder</span><span style="color:#1f2328">().</span><span style="color:#1f2328">baseUrl</span><span style="color:#1f2328">(</span>LOCAL_AI_URL<span style="color:#1f2328">).</span><span style="color:#1f2328">timeout</span><span style="color:#1f2328">(</span>Duration<span style="color:#1f2328">.</span><span style="color:#1f2328">ofMinutes</span><span style="color:#1f2328">(</span>5<span style="color:#1f2328">))</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">					</span><span style="color:#1f2328">.</span><span style="color:#1f2328">modelName</span><span style="color:#1f2328">(</span>MODEL_NAME<span style="color:#1f2328">).</span><span style="color:#1f2328">build</span><span style="color:#1f2328">();</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">return</span><span style="color:#fff"> </span>localModel<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">public</span><span style="color:#fff"> </span>EmbeddingModel<span style="color:#fff"> </span><span style="color:#6639ba">getEmbeddingModel</span><span style="color:#1f2328">()</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">if</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>embeddingModel<span style="color:#fff"> </span><span style="color:#0550ae">==</span><span style="color:#fff"> </span><span style="color:#cf222e">null</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span>embeddingModel<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">new</span><span style="color:#fff"> </span>AllMiniLmL6V2EmbeddingModel<span style="color:#1f2328">();</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">return</span><span style="color:#fff"> </span>embeddingModel<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">}</span><span style="color:#fff">	</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="retrievalservice-implementation">RetrievalService Implementation:</h4>
<p>Following 






  <a href="https://github.com/langchain4j/langchain4j-examples/blob/main/other-examples/src/main/java/ChatWithDocumentsExamples.java" target="_blank" rel="noopener noreferrer" >Chat with Documents</a>
, the <em>RetrievalService</em> now includes functionality for retrieving information based on a given question and a document:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#cf222e">package</span><span style="color:#fff"> </span><span style="color:#24292e">com.seehiong.ai.service</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import static</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.data.document.FileSystemDocumentLoader.loadDocument</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">java.net.URISyntaxException</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">java.net.URL</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">java.nio.file.Path</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">java.nio.file.Paths</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">org.springframework.stereotype.Service</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">com.seehiong.ai.AiApplication</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.chain.ConversationalRetrievalChain</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.data.document.Document</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.data.document.splitter.DocumentSplitters</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.data.segment.TextSegment</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.model.chat.ChatLanguageModel</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.model.embedding.EmbeddingModel</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.retriever.EmbeddingStoreRetriever</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.store.embedding.EmbeddingStore</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.store.embedding.EmbeddingStoreIngestor</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.store.embedding.inmemory.InMemoryEmbeddingStore</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">@Service</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">public</span><span style="color:#fff"> </span><span style="color:#cf222e">class</span> <span style="color:#1f2328">RetrievalService</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">private</span><span style="color:#fff"> </span>EmbeddingStore<span style="color:#0550ae">&lt;</span>TextSegment<span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span>embeddingStore<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">new</span><span style="color:#fff"> </span>InMemoryEmbeddingStore<span style="color:#0550ae">&lt;&gt;</span><span style="color:#1f2328">();</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">private</span><span style="color:#fff"> </span><span style="color:#cf222e">static</span><span style="color:#fff"> </span>Path<span style="color:#fff"> </span><span style="color:#6639ba">toPath</span><span style="color:#1f2328">(</span>String<span style="color:#fff"> </span>fileName<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">try</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span>URL<span style="color:#fff"> </span>fileUrl<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>AiApplication<span style="color:#1f2328">.</span><span style="color:#1f2328">class</span><span style="color:#1f2328">.</span><span style="color:#1f2328">getResource</span><span style="color:#1f2328">(</span>fileName<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span><span style="color:#cf222e">return</span><span style="color:#fff"> </span>Paths<span style="color:#1f2328">.</span><span style="color:#1f2328">get</span><span style="color:#1f2328">(</span>fileUrl<span style="color:#1f2328">.</span><span style="color:#1f2328">toURI</span><span style="color:#1f2328">());</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#1f2328">}</span><span style="color:#fff"> </span><span style="color:#cf222e">catch</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>URISyntaxException<span style="color:#fff"> </span>e<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span><span style="color:#cf222e">throw</span><span style="color:#fff"> </span><span style="color:#cf222e">new</span><span style="color:#fff"> </span>RuntimeException<span style="color:#1f2328">(</span>e<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">public</span><span style="color:#fff"> </span>String<span style="color:#fff"> </span><span style="color:#6639ba">retrieve</span><span style="color:#1f2328">(</span>ChatLanguageModel<span style="color:#fff"> </span>model<span style="color:#1f2328">,</span><span style="color:#fff"> </span>EmbeddingModel<span style="color:#fff"> </span>embeddingModel<span style="color:#1f2328">,</span><span style="color:#fff"> </span>String<span style="color:#fff"> </span>fileName<span style="color:#1f2328">,</span><span style="color:#fff"> </span>String<span style="color:#fff"> </span>question<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>EmbeddingStoreIngestor<span style="color:#fff"> </span>ingestor<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>EmbeddingStoreIngestor<span style="color:#1f2328">.</span><span style="color:#1f2328">builder</span><span style="color:#1f2328">()</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">				</span><span style="color:#1f2328">.</span><span style="color:#1f2328">documentSplitter</span><span style="color:#1f2328">(</span>DocumentSplitters<span style="color:#1f2328">.</span><span style="color:#1f2328">recursive</span><span style="color:#1f2328">(</span>500<span style="color:#1f2328">,</span><span style="color:#fff"> </span>0<span style="color:#1f2328">)).</span><span style="color:#1f2328">embeddingModel</span><span style="color:#1f2328">(</span>embeddingModel<span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">				</span><span style="color:#1f2328">.</span><span style="color:#1f2328">embeddingStore</span><span style="color:#1f2328">(</span>embeddingStore<span style="color:#1f2328">).</span><span style="color:#1f2328">build</span><span style="color:#1f2328">();</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>Document<span style="color:#fff"> </span>document<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>loadDocument<span style="color:#1f2328">(</span>toPath<span style="color:#1f2328">(</span>fileName<span style="color:#1f2328">));</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>ingestor<span style="color:#1f2328">.</span><span style="color:#1f2328">ingest</span><span style="color:#1f2328">(</span>document<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>ConversationalRetrievalChain<span style="color:#fff"> </span>chain<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>ConversationalRetrievalChain<span style="color:#1f2328">.</span><span style="color:#1f2328">builder</span><span style="color:#1f2328">().</span><span style="color:#1f2328">chatLanguageModel</span><span style="color:#1f2328">(</span>model<span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">				</span><span style="color:#1f2328">.</span><span style="color:#1f2328">retriever</span><span style="color:#1f2328">(</span>EmbeddingStoreRetriever<span style="color:#1f2328">.</span><span style="color:#1f2328">from</span><span style="color:#1f2328">(</span>embeddingStore<span style="color:#1f2328">,</span><span style="color:#fff"> </span>embeddingModel<span style="color:#1f2328">)).</span><span style="color:#1f2328">build</span><span style="color:#1f2328">();</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">return</span><span style="color:#fff"> </span>chain<span style="color:#1f2328">.</span><span style="color:#1f2328">execute</span><span style="color:#1f2328">(</span>question<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="updated-aicontroller-5">Updated AiController:</h4>
<p>In the AiController class, the components are brought together to create the <em>/retrieve</em> endpoint. Users can utilize this endpoint to interact with the Retrieval Service, providing a file (document) and a text (question) to retrieve relevant information:</p>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#cf222e">public</span><span style="color:#fff"> </span><span style="color:#cf222e">class</span> <span style="color:#1f2328">AiController</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">...</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#0550ae">@Autowired</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">private</span><span style="color:#fff"> </span>RetrievalService<span style="color:#fff"> </span>retrievalSvc<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#0550ae">@GetMapping</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;/retrieve&#34;</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">public</span><span style="color:#fff"> </span>ResponseEntity<span style="color:#0550ae">&lt;</span>String<span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#6639ba">retrieve</span><span style="color:#1f2328">(</span><span style="color:#0550ae">@RequestParam</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;file&#34;</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span>String<span style="color:#fff"> </span>file<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">@RequestParam</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;text&#34;</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span>String<span style="color:#fff"> </span>text<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>String<span style="color:#fff"> </span>response<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>retrievalSvc<span style="color:#1f2328">.</span><span style="color:#1f2328">retrieve</span><span style="color:#1f2328">(</span>modelSvc<span style="color:#1f2328">.</span><span style="color:#1f2328">getLocalModel</span><span style="color:#1f2328">(),</span><span style="color:#fff"> </span>modelSvc<span style="color:#1f2328">.</span><span style="color:#1f2328">getEmbeddingModel</span><span style="color:#1f2328">(),</span><span style="color:#fff"> </span>file<span style="color:#1f2328">,</span><span style="color:#fff"> </span>text<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">return</span><span style="color:#fff"> </span><span style="color:#cf222e">new</span><span style="color:#fff"> </span>ResponseEntity<span style="color:#0550ae">&lt;&gt;</span><span style="color:#1f2328">(</span>response<span style="color:#1f2328">,</span><span style="color:#fff"> </span>HttpStatus<span style="color:#1f2328">.</span><span style="color:#1f2328">OK</span><span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><p>To ensure the code and sample work seamlessly, the document (story-about-happy-carrot.txt) is placed in the same package as AiApplication.txt.</p>


































 
  
  





  <img src="/images/langchain4j/langchain4j-directory-structure.png"   alt="langchain4j-directory-structure" class="sc-image sc-image-default"
       >


<p>This is the sample result (notice that it takes about 1 min):</p>


































 
  
  





  <img src="/images/langchain4j/langchain4j-retrieval.png"   alt="langchain4j-retrieval" class="sc-image sc-image-default"
       >


<h3 id="7-integrating-streaming-service-through-local-llm">7. Integrating Streaming Service through local LLM</h3>
<p>In this final section, we explored the integration of a streaming service via a local Language Model (LLM). The Streaming Service implementation allows for the generation of responses in a streaming fashion, providing flexibility for handling large responses or real-time interactions.</p>
<h4 id="streamingservice-implementation">StreamingService Implementation:</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#cf222e">package</span><span style="color:#fff"> </span><span style="color:#24292e">com.seehiong.ai.service</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import static</span><span style="color:#fff"> </span><span style="color:#24292e">java.util.concurrent.TimeUnit.SECONDS</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">java.util.concurrent.CompletableFuture</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">java.util.concurrent.ExecutionException</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">java.util.concurrent.TimeoutException</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">org.springframework.stereotype.Service</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.model.StreamingResponseHandler</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.model.language.StreamingLanguageModel</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">import</span><span style="color:#fff"> </span><span style="color:#24292e">dev.langchain4j.model.output.Response</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#0550ae">@Service</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">public</span><span style="color:#fff"> </span><span style="color:#cf222e">class</span> <span style="color:#1f2328">StreamingService</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">public</span><span style="color:#fff"> </span>String<span style="color:#fff"> </span><span style="color:#6639ba">generate</span><span style="color:#1f2328">(</span>StreamingLanguageModel<span style="color:#fff"> </span>model<span style="color:#1f2328">,</span><span style="color:#fff"> </span>String<span style="color:#fff"> </span>message<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>StringBuilder<span style="color:#fff"> </span>answerBuilder<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">new</span><span style="color:#fff"> </span>StringBuilder<span style="color:#1f2328">();</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>CompletableFuture<span style="color:#0550ae">&lt;</span>String<span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span>futureAnswer<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">new</span><span style="color:#fff"> </span>CompletableFuture<span style="color:#0550ae">&lt;&gt;</span><span style="color:#1f2328">();</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>model<span style="color:#1f2328">.</span><span style="color:#1f2328">generate</span><span style="color:#1f2328">(</span>message<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#cf222e">new</span><span style="color:#fff"> </span>StreamingResponseHandler<span style="color:#0550ae">&lt;</span>String<span style="color:#0550ae">&gt;</span><span style="color:#1f2328">()</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span><span style="color:#0550ae">@Override</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span><span style="color:#cf222e">public</span><span style="color:#fff"> </span><span style="color:#cf222e">void</span><span style="color:#fff"> </span><span style="color:#6639ba">onNext</span><span style="color:#1f2328">(</span>String<span style="color:#fff"> </span>token<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">				</span>answerBuilder<span style="color:#1f2328">.</span><span style="color:#1f2328">append</span><span style="color:#1f2328">(</span>token<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span><span style="color:#0550ae">@Override</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span><span style="color:#cf222e">public</span><span style="color:#fff"> </span><span style="color:#cf222e">void</span><span style="color:#fff"> </span><span style="color:#6639ba">onComplete</span><span style="color:#1f2328">(</span>Response<span style="color:#0550ae">&lt;</span>String<span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span>response<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">				</span>futureAnswer<span style="color:#1f2328">.</span><span style="color:#1f2328">complete</span><span style="color:#1f2328">(</span>answerBuilder<span style="color:#1f2328">.</span><span style="color:#1f2328">toString</span><span style="color:#1f2328">());</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span><span style="color:#0550ae">@Override</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span><span style="color:#cf222e">public</span><span style="color:#fff"> </span><span style="color:#cf222e">void</span><span style="color:#fff"> </span><span style="color:#6639ba">onError</span><span style="color:#1f2328">(</span>Throwable<span style="color:#fff"> </span>error<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">				</span>futureAnswer<span style="color:#1f2328">.</span><span style="color:#1f2328">completeExceptionally</span><span style="color:#1f2328">(</span>error<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#1f2328">});</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">try</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span><span style="color:#cf222e">return</span><span style="color:#fff"> </span>futureAnswer<span style="color:#1f2328">.</span><span style="color:#1f2328">get</span><span style="color:#1f2328">(</span>30<span style="color:#1f2328">,</span><span style="color:#fff"> </span>SECONDS<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#1f2328">}</span><span style="color:#fff"> </span><span style="color:#cf222e">catch</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>InterruptedException<span style="color:#fff"> </span><span style="color:#0550ae">|</span><span style="color:#fff"> </span>ExecutionException<span style="color:#fff"> </span><span style="color:#0550ae">|</span><span style="color:#fff"> </span>TimeoutException<span style="color:#fff"> </span>e<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span><span style="color:#cf222e">return</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;Unable to generate response: &#34;</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span>message<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="modelservice-modification-1">ModelService Modification</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#cf222e">public</span><span style="color:#fff"> </span><span style="color:#cf222e">class</span> <span style="color:#1f2328">ModelService</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">...</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">private</span><span style="color:#fff"> </span>StreamingLanguageModel<span style="color:#fff"> </span>streamingModel<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">public</span><span style="color:#fff"> </span>StreamingLanguageModel<span style="color:#fff"> </span><span style="color:#6639ba">getStreamingModel</span><span style="color:#1f2328">()</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">if</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>streamingModel<span style="color:#fff"> </span><span style="color:#0550ae">==</span><span style="color:#fff"> </span><span style="color:#cf222e">null</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">			</span>streamingModel<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>LocalAiStreamingLanguageModel<span style="color:#1f2328">.</span><span style="color:#1f2328">builder</span><span style="color:#1f2328">().</span><span style="color:#1f2328">baseUrl</span><span style="color:#1f2328">(</span>LOCAL_AI_URL<span style="color:#1f2328">).</span><span style="color:#1f2328">modelName</span><span style="color:#1f2328">(</span>MODEL_NAME<span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">					</span><span style="color:#1f2328">.</span><span style="color:#1f2328">build</span><span style="color:#1f2328">();</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">return</span><span style="color:#fff"> </span>streamingModel<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">}</span><span style="color:#fff">	</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="updated-aicontroller-6">Updated AiController:</h4>






<div class="code-block-wrapper">
  <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#cf222e">public</span><span style="color:#fff"> </span><span style="color:#cf222e">class</span> <span style="color:#1f2328">AiController</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">...</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#0550ae">@Autowired</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">private</span><span style="color:#fff"> </span>StreamingService<span style="color:#fff"> </span>streamingSvc<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#0550ae">@GetMapping</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;/streaming&#34;</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">public</span><span style="color:#fff"> </span>ResponseEntity<span style="color:#0550ae">&lt;</span>String<span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#6639ba">streaming</span><span style="color:#1f2328">(</span><span style="color:#0550ae">@RequestParam</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;text&#34;</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span>String<span style="color:#fff"> </span>text<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span>String<span style="color:#fff"> </span>response<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>streamingSvc<span style="color:#1f2328">.</span><span style="color:#1f2328">generate</span><span style="color:#1f2328">(</span>modelSvc<span style="color:#1f2328">.</span><span style="color:#1f2328">getStreamingModel</span><span style="color:#1f2328">(),</span><span style="color:#fff"> </span>text<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">		</span><span style="color:#cf222e">return</span><span style="color:#fff"> </span><span style="color:#cf222e">new</span><span style="color:#fff"> </span>ResponseEntity<span style="color:#0550ae">&lt;&gt;</span><span style="color:#1f2328">(</span>response<span style="color:#1f2328">,</span><span style="color:#fff"> </span>HttpStatus<span style="color:#1f2328">.</span><span style="color:#1f2328">OK</span><span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">}</span></span></span></code></pre></div>
  <button class="copy-code-button" aria-label="Copy code to clipboard" title="Copy code">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="copy-icon">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="check-icon" style="display:none;">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
</div><h4 id="postman-result-4">Postman Result:</h4>


































 
  
  





  <img src="/images/langchain4j/langchain4j-streaming.png"   alt="langchain4j-streaming" class="sc-image sc-image-default"
       >


<p>With the addition of the streaming service, this comprehensive blog post has covered various aspects of integrating LangChain4j into a Java-based AI application. It serves as a starting point for creating personalized AI applications, and I hope it has been a helpful guide for your exploration in this field.</p>
<p>Feel free to experiment further and build upon these foundations to create even more sophisticated AI applications!</p>

    </section>

    <nav class="post-navigation">
      <div class="nav-links">
        
          <div class="nav-previous">
            <a href="/posts/2023/09/unlocking-the-power-of-machine-learning-with-mlc-llm/" rel="prev">
              <span class="meta-nav">← Previous</span>
              <span class="post-title">Unlocking the Power of Machine Learning with MLC LLM</span>
            </a>
          </div>
        
        
          <div class="nav-next">
            <a href="/posts/2023/11/rag-over-java-code-with-langchain4j/" rel="next">
              <span class="meta-nav">Next →</span>
              <span class="post-title">RAG over Java code with Langchain4j</span>
            </a>
          </div>
        
      </div>
    </nav>

    
<div class="giscus-comments-container">
</div>

<script>
  (function() {
    'use strict';

    const getGiscusTheme = () => {
      const storedTheme = localStorage.getItem('theme'); 
      if (storedTheme) {
        return storedTheme === 'dark-mode' ? 'dark' : 'light';
      }
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };

    const setGiscusFrameTheme = (theme) => {
      const iframe = document.querySelector('iframe.giscus-frame');
      if (iframe && iframe.contentWindow) {
        iframe.contentWindow.postMessage({ giscus: { setConfig: { theme: theme } } }, 'https://giscus.app');
      }
    };

    const loadGiscus = () => {
      const giscusContainer = document.querySelector('.giscus-comments-container');
      if (!giscusContainer) {
        console.warn('Giscus container not found.');
        return;
      }

      while (giscusContainer.firstChild) {
        giscusContainer.removeChild(giscusContainer.firstChild);
      }

      const giscusScript = document.createElement('script');
      const giscusAttributes = {
        "src": "https://giscus.app/client.js",
        "data-repo":             "seehiong\/seehiong.github.io",
        "data-repo-id":          "R_kgDOJg7Puw",
        "data-category":         "General",
        "data-category-id":      "DIC_kwDOJg7Pu84Cbyhc",
        "data-mapping":          "url", 
        "data-strict":           "0",
        "data-reactions-enabled":"1",
        "data-emit-metadata":    "0",
        "data-input-position":   "top", 
        "data-theme":            getGiscusTheme(), 
        "data-lang":             "en",
        "data-loading":          "lazy",
        "crossorigin":           "anonymous",
        "async":                 "true", 
      };

      if (!giscusAttributes["data-repo"] || !giscusAttributes["data-repo-id"] || !giscusAttributes["data-category-id"]) {
          console.error("Giscus parameters (giscusRepo, giscusRepoId, giscusCategoryId) are not configured in hugo.toml.");
          giscusContainer.innerHTML = "<p style='color: var(--text-secondary);'>Giscus comments are not configured correctly. Please check site parameters.</p>";
          return;
      }

      Object.entries(giscusAttributes).forEach(
        ([key, value]) => giscusScript.setAttribute(key, value)
      );
      giscusContainer.appendChild(giscusScript);
    };

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadGiscus);
    } else {
        loadGiscus();
    }

    const htmlElement = document.documentElement;
    const observer = new MutationObserver((mutationsList) => {
      for (const mutation of mutationsList) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          setGiscusFrameTheme(getGiscusTheme());
        }
      }
    });
    observer.observe(htmlElement, { attributes: true });

  })();
</script>


  </article>
</div>
</main>
    </div>

    
    <div id="search-modal-overlay" class="search-modal-overlay" style="display: none;">
      <div id="search-modal-content" class="search-modal-content">
        <button id="search-modal-close" class="search-modal-close" aria-label="Close search" title="Close search">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </button>
        <input type="search" id="modal-search-input" class="modal-search-input" placeholder="Search content..." aria-label="Search input">
        <div id="modal-search-results" class="modal-search-results">
        </div>
      </div>
    </div>
    

  <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js" defer></script>
  <script>
    (function() {
      'use strict';

      window.addEventListener('DOMContentLoaded', () => {
        const searchModalOverlay = document.getElementById('search-modal-overlay');
        const searchModalContent = document.getElementById('search-modal-content');
        const searchModalCloseButton = document.getElementById('search-modal-close');
        const searchToggleButton = document.getElementById('nav-search-toggle');
        const searchInputTarget = document.getElementById('modal-search-input');
        const searchResultsTarget = document.getElementById('modal-search-results');

        let fuseInstance = null;
        let searchData = [];

        const loadSearchData = async () => {
          if (searchData.length === 0 && !fuseInstance) {
            try {
              const response = await fetch('\/index.json');
              if (!response.ok) {
                throw new Error(`HTTP error loading index.json! status: ${response.status}`);
              }
              searchData = await response.json();
              initializeFuse();
            } catch (e) {
              console.error("[SearchSetup] Error loading search data:", e);
              if (searchResultsTarget) searchResultsTarget.innerHTML = "<p>Error loading search index.</p>";
            }
          } else if (searchData.length > 0 && !fuseInstance){
            initializeFuse();
          }
        };

        const initializeFuse = () => {
          if (searchData.length > 0 && !fuseInstance) {
            const options = {
              keys: [
                { name: 'title', weight: 0.7 }, { name: 'summary', weight: 0.5 },
                { name: 'content', weight: 0.3 }, { name: 'tags', weight: 0.4 }
              ],
              includeScore: true, threshold: 0.4, minMatchCharLength: 2,
            };
            fuseInstance = new Fuse(searchData, options);
          }
        };

        const performSearch = () => {
          if (!fuseInstance || !searchInputTarget || !searchResultsTarget) return;
          const query = searchInputTarget.value.trim();
          searchResultsTarget.innerHTML = '';
          if (query.length < 2) return;

          const results = fuseInstance.search(query);
          if (results.length > 0) {
            const ul = document.createElement('ul');
            ul.className = 'search-results-list';
            results.slice(0, 10).forEach(result => {
              const item = result.item;
              const li = document.createElement('li');
              li.className = 'search-result-item';
              const a = document.createElement('a');
              a.href = item.permalink;
              a.textContent = item.title;
              li.appendChild(a);
              ul.appendChild(li);
            });
            searchResultsTarget.appendChild(ul);
          } else {
            searchResultsTarget.innerHTML = '<p>No results found.</p>';
          }
        };

        const openSearchModal = async () => {
          await loadSearchData();
          if (searchInputTarget) searchInputTarget.value = '';
          if (searchResultsTarget) searchResultsTarget.innerHTML = '';

          if (searchModalOverlay) {
            searchModalOverlay.style.display = 'flex';
            setTimeout(() => searchModalOverlay.classList.add('active'), 10);
          } else { return; }

          if (searchInputTarget) setTimeout(() => searchInputTarget.focus(), 50);
          if (searchToggleButton) searchToggleButton.classList.add('active');
        };

        const closeSearchModal = () => {
          if (searchModalOverlay) {
            searchModalOverlay.classList.remove('active');
            setTimeout(() => searchModalOverlay.style.display = 'none', 300);
          }
          if (searchToggleButton) searchToggleButton.classList.remove('active');
        };

        if (searchToggleButton) {
          searchToggleButton.addEventListener('click', (e) => {
            e.stopPropagation();
            if (searchModalOverlay && searchModalOverlay.classList.contains('active')) {
              closeSearchModal();
            } else {
              openSearchModal();
            }
          });
        } else { console.error("[SearchSetup] #nav-search-toggle button not found."); }

        if (searchModalCloseButton) { searchModalCloseButton.addEventListener('click', closeSearchModal); }
        if (searchModalOverlay && searchModalContent) {
          searchModalOverlay.addEventListener('click', (event) => {
            if (event.target === searchModalOverlay) closeSearchModal();
          });
        }
        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && searchModalOverlay && searchModalOverlay.classList.contains('active')) {
            closeSearchModal();
          }
        });
        if (searchInputTarget) {
          let debounceTimer;
          searchInputTarget.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(performSearch, 300);
          });
        }
      });
    })();
  </script>

    

    

  <script>
    MathJax = {
      tex: {
        displayMath: [['\\[', '\\]'], ['$$', '$$']], 
        inlineMath: [['\\(', '\\)']], 
        processEscapes: true,
        processEnvironments: true,
        tags: 'ams' 
      },
      svg: {
        fontCache: 'global' 
      },
      chtml: {
        fontURL: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2'
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'], 
        ignoreHtmlClass: 'tex2jax_ignore', 
        processHtmlClass: 'tex2jax_process'
      }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<footer class="footer-main simplified-footer">
  <div class="content-body footer-wraper">
    <div class="footer-box">
      <div class="footer-content">
        <div class="copyright-line">
          Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> © 2025 See Hiong. All rights reserved.
        </div>
        <div class="social-links">
          
            <a href="https://github.com/seehiong" target="_blank" title="GitHub" class="social-link" aria-label="GitHub">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
            </a>
          
          
            <a href="https://www.linkedin.com/in/seehiong/" target="_blank" title="LinkedIn" class="social-link" aria-label="LinkedIn">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
            </a>
          
          
            <a href="/index.xml" target="_blank" title="RSS" class="social-link" aria-label="RSS Feed">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg>
            </a>
          
        </div>
      </div>
    </div>
  </div>
</footer>
        <script src="/js/animation.js" defer></script>
    
        <script src="/js/code-copy.js" defer></script>
    
        <script src="/js/scroll-header.js" defer></script>
       
  </body>
</html>